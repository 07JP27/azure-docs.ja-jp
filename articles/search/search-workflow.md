<properties
	pageTitle="Azure Search 開発の一般的ワークフロー | Microsoft Azure"
	description="Azure Search と統合されるプロトタイプと運用アプリケーションを構築するためのワークフローまたはロードマップ"
	services="search"
	documentationCenter=""
	authors="HeidiSteen"
	manager="mblythe"
	editor=""/>

<tags
	ms.service="search"
	ms.devlang="rest-api"
	ms.workload="search"
	ms.topic="get-started-article"
	ms.tgt_pltfrm="na"
	ms.date="07/08/2015"
	ms.author="heidist"/>

# Azure Search 開発の一般的ワークフロー

この記事はカスタム アプリケーションに検索機能を与えるコンポーネントとして Azure Search を追加するためのロードマップです。予備調査するのか、すぐに始めるのかにもよりますが、Azure Search をカスタム開発プロジェクトに統合する方法に関する準備的ガイダンスが必要になります。

次のセクションでは、Azure Search がアプリケーションの検索要件を満たすかどうかを評価する際に役立つ、最初のプロトタイプの一般的なワークフローを紹介します。この記事の後半では、より重大なアプリケーション開発作業を考慮する、設計上の重要な決定について取り上げます。

プロトタイプの作成を開始する前に、準備として入門チュートリアルの 1 つか、この [1 時間の詳細なプレゼンテーション動画](http://azure.microsoft.com/documentation/videos/tech-ed-europe-2014-azure-search-deep-dive/)をご利用されることをお勧めします。入門チュートリアルは [.NET](search-get-started-dotnet.md)、[Java](search-get-started-java.md)、[Node.JS](search-get-started-nodejs.md) 言語のものが用意されています。

## プロトタイプの開発

プロトタイプの開発を成功させるには、このセクションの手順が一般的に利用されます。サービスをプロビジョニングし、インデックスのスキーマを定義し、ドキュメントと共にインデックスを読み込み、インデックスのクエリを実行します。

揮発性データを含むアプリケーションの場合 (たとえば、通常、インベントリまたはコンテンツが急に変わる場合)、ドキュメントを更新するためのコンポーネントもプロトタイプに含める必要があります。

   ![][1]

### 手順 1: サービスをプロビジョニングする

Azure Search は Azure サブスクリプションで利用できる完全管理オンライン サービスです。[Azure にサインアップすると](http://azure.microsoft.com/pricing/free-trial/)、Search サービスを迅速に追加できます。Search サービスをサブスクリプションに追加する方法については、「[ポータルで Search サービスを作成する](search-create-service-portal.md)」を参照してください。

2 つの価格レベルから選択できます。プロトタイプの作成には共有 (無料) サービスをお勧めします。注意点として、扱うデータの量が限られます。既存の会員様 (試用版または通常の会員) は共有サービスを無料で利用し、短時間で設定できます。ただし、使用できるインデックスとドキュメントの数に制約があり、3 つのインデックス、インデックスごとに最大 10,000 ドキュメント、50 MB のストレージ合計のいずれかに到達した時点で上限となります。

### 手順 2: インデックスを作成する

サービスを作成したら、インデックスの作成を開始できます。スキーマの定義から始めます。

インデックスを作成する最も迅速かつ簡単な方法は Azure ポータルを利用することです。少なくとも、各ドキュメントに一意のキーを含め、検索可能データが含まれるフィールドを 1 つ以上含める必要があります。最初に、「[ポータルでインデックスを作成する](search-create-index-portal.md)」を参照してください。

> [AZURE.NOTE]Azure Search インデックス内
>
> *インデックス*とは整理された固定データであり、後続のすべての検索操作の*検索コーパス*として機能します。検索コーパスは Search サービス サブスクリプションの一部としてクラウドに保存されます。それにより、一貫性のある検索操作をすばやく実行できます。検索用語では、検索コーパスの項目は「*ドキュメント*」と呼ばれています。すべてのドキュメントの合計は*ドキュメント コレクション*です。
>
>*インデックス スキーマ*は、ドキュメント内のすべてのフィールドを名前別、データ型別、検索可能性、フィルタリング可能性、ファセット可能性を示す属性別に定義するものです。
>
> ドキュメントの構造に加え、インデックス スキーマはスコアリング プロファイルも指定します。これは検索スコアを押し上げる基準と、オートコンプリート クエリ (サジェスター) とドメイン間クエリ要求の CORS を可能にする構成設定を提供します。*プロトタイプに関しては、最初にドキュメントのフィールドだけを指定することをお勧めします。*その後、他の機能を徐々に追加します (後で追加できる機能の一覧については手順 5 を参照してください)。
>
> 実世界の例に当てはめ、電子商取引での利用を考えます。検索インデックスにはアプリケーションで検索可能なすべての製品またはサービス (検索結果で返されるあらゆるもの) を含めます。ドキュメントは SKU ごとに 1 つとなります。各ドキュメントには製品名、ブランド、サイズ、価格、色、さらには検索結果内で返す画像やその他のリソースの参照を含めます。

### 手順 3: ドキュメントを読み込む

Azure Search にインデックスを保存したら、次の手順として、インデックスにドキュメントを入力します。この手順では、データがアップロードされ、分析され、トークン化され、検索ワークロードのために設計されたデータ構造 (逆インデックスなど) に保存されます。

インデックスにアップロードするデータは前の手順で定義したスキーマに準拠する必要があります。ドキュメント データはフィールドごとにキー/値のペアとして JSON 形式で表されます。スキーマで ID (キー) フィールド、名前フィールド、番号フィールド、URL フィールド (外部イメージが検索結果に含まれる場合) が指定される場合、インデックスに入力するすべてのドキュメントにフィールド別の値 (null) を与える必要があります。

ドキュメントはいくつかの方法で読み込めますが、現在のところ、そのすべてにおいて API が必要となります。ほとんどのプロトタイプの場合、コーディング要件に起因し、この手順が最も時間がかかります。オプションは、この記事の後半で説明します。

> [AZURE.NOTE]共有サービスの場合、インデックスごとに 10,000 ドキュメントに制限されることにご注意ください。制限以内に収まるようにデータセットを減らしてください。詳細については、「[制限と制約](search-limits-quotas-capacity.md)」を参照してください。

#### インデックスにデータを読み込む方法

1 つの方法としてインデクサーの使用があります。Azure の Azure DocumentDB または SQL Server のリレーショナル データ ソースの場合 (特に、Azure SQL Database または Azure VM の SQL Server)、[インデクサー](https://msdn.microsoft.com/library/dn946891.aspx)を使用し、サポートされているデータ ソースからドキュメントを取得します。ドキュメントを読み込むためにインデクサーを使用するコード サンプルは [.NET](search-get-started-dotnet.md)、[Java](search-get-started-java.md)、[Node.JS](search-get-started-nodejs.md) の入門チュートリアルにあります。

2 つ目の選択肢は、REST API または .NET ライブラリを利用し、ドキュメントを読み込む簡単なプログラムを記述することです。

- [ドキュメントの追加、更新、削除 (REST API)](https://msdn.microsoft.com/library/dn798930.aspx)
- [DocumentOperationsExtensions クラス](https://msdn.microsoft.com/library/microsoft.azure.search.documentoperationsextensions.aspx)

非常に少ないデータセットで機能する 3 つ目の選択肢は [Fiddler](search-fiddler.md) または [Chrome Postman](search-chrome-postman.md) を使用してドキュメントをアップロードすることです。

4 つ目の選択肢は、おそらく最も簡単な方法ですが、ソリューションの組み込みデータベース (.mdf) からドキュメントを読み込む [Adventure Works C# REST API のサンプル](https://azuresearchadventureworksdemo.codeplex.com/)とソリューションに含まれる JSON データ ファイルからデータを読み込む[スコアリング プロファイル C# REST API のサンプル](https://azuresearchscoringprofiles.codeplex.com/)からコードを借りることです。

> [AZURE.TIP][スコアリング プロファイルのサンプル](https://azuresearchscoringprofiles.codeplex.com/)を変更し、実行できます。データ JSON ファイルと schema.json ファイルをアプリケーションで有効なデータで置換します。

### 手順 4: ドキュメントにクエリを実行する

ドキュメントがインデックスに読み込まれたら、最初のクエリを記述できます。

Search サービスから最初の検索結果を取得する最も速い方法は、[Fiddler](search-fiddler.md) または [Chrome Postman](search-chrome-postman.md) を使用して応答を表示することです。ただし、現実的には、読みやすい形式で結果を表示する簡単な UI コードを記述することになります。

検索操作のための API には次があります。

- [ドキュメント検索操作](https://msdn.microsoft.com/library/dn798927.aspx)
- [SearchIndexClient クラス](https://msdn.microsoft.com/library/microsoft.azure.search.searchindexclient.aspx)

Azure Search のクエリは非常に簡単です。URI に `search=*` を含めると検索コーパスの最初の 50 項目が返されます。`search=<some phrase>` を指定すると、フレーズで全文検索が実行され、入力された用語に一致するドキュメントが 50 件以上あれば、最大 50 件のドキュメントが返されます。

50 ドキュメントは既定値です。`$Count` クエリ パラメーターを使用し、返される項目の数を変更できます。このパラメーターの詳細は「[ドキュメントの検索](https://msdn.microsoft.com/library/dn798927.aspx)」にあります。

> [AZURE.TIP]クエリ サンプルの最も包括的な一覧は「[ドキュメントの検索](https://msdn.microsoft.com/library/dn798927.aspx)」にありますが、サポートされている演算子の一覧を[構文参照](https://msdn.microsoft.com/library/dn798920.aspx)で確認することもできます。

### 手順 5: 他の機能を試す

サービスとインデックスが与えられたので、検索をさらに充実させるような各種機能を試すことができます。試すべき機能の簡単な一覧を次に示します。

**検索ページ**では、多くの場合、結果セットにドキュメント カウントが表示されます。あるいは、改ページを使用し、結果をもっと管理しやすい数に分割します。詳細については、「[改ページ調整](search-pagination-page-layout.md)」を参照してください。

**searchMode=all** は Azure Search による NOT 演算子の評価方法を変更するクエリ パラメーターです。既定では、NOT (-) を含むクエリは結果を絞り込まず、拡大します。このパラメーターを設定し、NOT 演算子の評価方法を変更できます。この詳細は「[ドキュメントの検索](https://msdn.microsoft.com/library/dn798927.aspx)」または「[SearchMode 列挙](https://msdn.microsoft.com/library/microsoft.azure.search.models.searchmode.aspx)」にあります。

**スコアリング プロファイル**は検索スコアの押し上げに使用されます。事前定義基準に一致する項目が検索結果の上位に表示されます。この機能の詳細については、「[スコアリング プロファイルの概要](search-get-started-scoring-profiles.md)」を参照してください。

**フィルター**は選択に基準を追加し、検索結果を絞り込むために使用されます。フィルターの式はクエリ内に配置されます。詳細については、「[ドキュメントの検索](https://msdn.microsoft.com/library/dn798927.aspx)」を参照してください。

**ファセット ナビゲーション**は自律フィルター処理のために使用されます。Azure Search が構造を構築して返し、コードがファセット ナビゲーション構造を検索結果ページに表示します。詳細については、「[ファセット ナビゲーション](search-faceted-navigation.md)」を参照してください。

**サジェスター**は先行入力またはオートコンプリートのクエリであり、検索語句の最初の文字が入力されると、検索語句の候補を返します。詳細については、「[提案操作](https://msdn.microsoft.com/library/dn798936.aspx)」または「[Suggesters クラス](https://msdn.microsoft.com/library/microsoft.azure.search.models.suggester.aspx)」を参照してください。

**言語アナライザー**は、テキストの解析中に、使用される言語の規則を提供します。Azure Search の既定の言語アナライザーは Lucene English です。ただし、インデックスに指定すれば、別のアナライザーまたは複数のアナライザーを使用できます。Lucene アナライザーはすべての API で使用できます。Microsoft の自然言語のプロセッサは [2015-02-28-Preview REST API](search-api-2015-02-28-preview.md) でのみ利用できます。詳細については、「[言語サポート](https://msdn.microsoft.com/library/dn879793.aspx)」を参照してください。

### 手順 6: インデックスとドキュメントの更新

評価する一部の機能でインデックスの更新が必要になる場合があります。そのとき、多くの場合、ドキュメントの更新も必要となります。

インデックスまたはドキュメントの更新が必要な場合、たとえば、サジェスターを追加したり、その目的で追加したフィールドで言語アナライザーを指定したりするには、指示を次のリンクで確認してください。

- [インデックス操作の更新 (REST API)](https://msdn.microsoft.com/library/dn800964.aspx)
- [インデクサー操作の更新 (REST API)](https://msdn.microsoft.com/library/dn946892.aspx)
- [ドキュメントの追加、更新、削除操作 (REST API)](https://msdn.microsoft.com/library/dn798930.aspx)
- [Index クラス (.NET ライブラリ)](https://msdn.microsoft.com/library/microsoft.azure.search.models.index.aspx)
- [Documents クラス (.NET ライブラリ)](https://msdn.microsoft.com/library/microsoft.azure.search.models.document.aspx)

概念実証を確立するプロトタイプを作成したら、学習した内容を次のレベルに移すことができます。つまり、運用環境の作業負荷をサポートできる開発プロジェクトを設計します。

## アプリケーション開発

次の段階に進むとき、使用する API、ドキュメントの管理方法と更新頻度、検索結果に外部リソースを含めるかどうかを決める必要があります。

ソリューションの設計にはプロトタイプで説明したすべての手順を含める必要があります。ただし、最も目的に適った方針を優先する代わりに、全体的なソリューションに最も適合する手法を検討するべき場合もあります。

### API を選択する

Azure Search は 2 つのプログラミング モデルを提供します。.NET ライブラリはマネージ コードに、REST API は Java、JavaScript、あるいは Microsoft .NET Framework を対象としない別の言語などのプログラミング言語に使用されます。

現在のところ、.NET ライブラリには機能の少量のサブセットがありません。そのため、マネージ コードの記述を希望しても、場合によっては、必要な機能を得るためには REST API を使用しなければなりません。REST API でのみ利用できる機能は次のとおりです。

- [Microsoft 自然言語プロセッサ - プレビューのみ](../search-api-2015-02-28-preview/)
- [moreLikeThis 機能 - プレビューのみ](../search-api-2015-02-28-preview/)
- [管理 API](https://msdn.microsoft.com/library/dn832684.aspx)

[更新情報](search-latest-updates.md)記事を定期的に確認してください。機能ステータスの変更がわかります。

### データの同期方法としてプッシュまたはプルを選択する

プッシュ モデルとプル モデルの違いはインデックスのドキュメントの更新方法にあります。多くの場合、シナリオによって適切なモデルが決まります。

オンライン小売りビジネスの場合、おそらく、プッシュ モデルが必要となります。OLTP データベースと Azure Search インデックスの両方に在庫の変化をプッシュまたは二重書き込みできます。特定の SKU が売り切れたとき、あるいはサイズまたは色がなくなったとき、インデックスを可能な限り早急に更新し、顧客の不満を回避します。プッシュ モデルだけが検索インデックスをほぼリアルタイムで更新できます。

Azure Search にはプッシュ モデルを実装するためのメカニズムはありません。データ層のアプリケーション コードでドキュメントの更新操作を処理する必要があります。[REST API](https://msdn.microsoft.com/library/dn798935.aspx) または [.NET ライブラリ](https://msdn.microsoft.com/library/dn951165.aspx)のいずれかを使用してコレクションのドキュメントを更新します。実装の詳細として、ドキュメント キーに製品 SKU を使用するとこの作業が楽になります。

プル モデルは外部データ ソースからデータを取得する操作であり、通常は、スケジュールされル操作です。Azure Search では、プル モデルは[インデクサー](https://msdn.microsoft.com/library/azure/dn946891.aspx)を介して利用できます。インデクサーはデータ ソースの Azure DocumentDB または Azure SQL Database (あるいは、Azure VM の SQL Server) に利用できます。

### ドキュメントの一括読み込み

スループットを向上させるために、ドキュメントをバッチで追加することをお勧めします。ドキュメントの平均サイズが 1 ～ 2 KB として、最大 1,000 件のドキュメントをバッチで追加できます。

POST 要求に対する全体的なステータス コードがあります。ステータス コードは、HTTP 200 (Success) または HTTP 207 (Multi-Status) (成功したドキュメントと失敗したドキュメントの組み合わせがある場合) です。POST 要求に対するステータス コードに加えて、Azure Search では各ドキュメントのステータス フィールドが維持されます。バッチ アップロードの場合、各ドキュメントの挿入が成功したか失敗したかを示す、ドキュメントごとのステータスを取得する方法が必要です。その情報は、ステータス フィールドで提供されます。ドキュメントの読み込みが失敗すると、このフィールドは false に設定されます。

負荷が大きい場合、一部のアップロードが失敗することがよくあります。このような失敗が発生したときは、全体的なステータス コードが 207 となり、部分的な成功が示されます。インデックス作成に失敗したドキュメントでは、"status" プロパティが false に設定されます。

> [AZURE.NOTE]サービスがドキュメントを受け取ると、ドキュメントはインデックス作成のためにキューに配置され、即座に検索結果に含まれない場合があります。負荷が大きくない場合は、通常、ドキュメントのインデックスは数秒間で作成されます。

インデックスを更新するときに、複数のアクション (挿入、マージ、削除) を同一のバッチに組み合わせることで、複数のラウンド トリップの必要がなくなります。現在、Azure Search では部分的な更新 (HTTP PATCH) がサポートされていないため、インデックスを更新する必要がある場合はインデックスの定義を再送信する必要があります。

### 外部データを検索結果に統合する

Azure Search は、検索操作で使用するインデックスおよびドキュメントの内部ストレージを使用します。テキスト分析およびインデックス解析は、すべての検索可能なフィールドおよび関連付けられた属性が既に利用可能であることを前提としています。

ただし、ドキュメント内のすべてのフィールドを検索できるわけではありません。たとえば、アプリケーションが音楽やビデオのオンライン カタログである場合は、Azure BLOB サービスやその他のストレージ形式にバイナリ ファイルを格納することをお勧めします。バイナリ ファイル自体は検索可能ではないため、Azure Search ストレージにそれらを保存する必要はありません。その他のサービスや場所にイメージ、ビデオ、およびオーディオ ファイルを格納する必要がありますが、ファイルの場所への URL を参照するフィールドを含める必要があります。この方法で、検索結果の一部として、外部データを返すことができます。

外部データを使用するには、外部データ ファイルの URL ポインターを格納するインデックスでフィールドを定義する必要があります。[Lookup Documents](https://msdn.microsoft.com/library/dn798929.aspx) 要求を発行した場合、あるいは検索結果にフィールドを含める場合、バイナリ ファイルがドキュメントのコンテキストに表示されます。

### 容量計画

Azure Search の優れた機能の 1 つは、要求に応じてリソースを簡単にスケールアップ、またはスケールダウンできることです。この機能で容量計画の必要性がなくなるわけではありませんが、ほとんどのリスクを最小限に抑えます。検索の作業負荷を実行するために、追加のハードウェアや不適切なハードウェアで行き詰まることがありません。

最後の手順として、レプリカとパーティションの両方の既存のリソース レベルを確認し、調整が必要かどうかを決定します。容量を調整する最も簡単な方法は [Azure ポータル](https://ms.portal.azure.com/)を利用することです。

Standard 価格レベルのみをスケールアップまたはスケールダウンできることに注意してください。また、調整の程度によっては、サービスの追加クラスターをデプロイするために数分から数時間かかることがあります。

> [AZURE.NOTE]容量は管理 REST API を使用してプログラミングで調整できます。詳細については、「[管理 REST API](https://msdn.microsoft.com/library/azure/dn832684.aspx)」を参照してください。


<!--Image references-->
[1]: ./media/search-workflow/AzSearch-Workflow.png

<!---HONumber=Oct15_HO3-->