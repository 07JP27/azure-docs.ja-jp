<properties
	pageTitle="Azure Site Recovery で SAN を使用して VMM クラウドの Hyper-V VM をセカンダリ サイトにレプリケートする | Microsoft Azure"
	description="Azure Site Recovery は、SAN レプリケーションを使用して、オンプレミスのサイト間での Hyper-V 仮想マシンのレプリケーション、フェールオーバー、および回復を調整します。"
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="01/12/2016"
	ms.author="raynew"/>

# Azure Site Recovery で SAN を使用して (VMM クラウド内の) Hyper-V VM をセカンダリ サイトにレプリケートする

Azure Site Recovery サービスは、仮想マシンと物理サーバーのレプリケーション、フェールオーバー、復旧を調整してビジネス継続性と障害復旧 (BCDR) 戦略に貢献します。コンピューターを Azure に、またはオンプレミスのセカンダリ データ センターにレプリケートできます。簡単な概要については、「[Azure Site Recovery とは](site-recovery-overview.md)」を参照してください。

## 概要

この記事では、System Center Virtual Machine Manager (VMM) プライベート クラウドに配置される Hyper-V 仮想マシンを保護するための調整と自動化を行うように Site Recovery をデプロイする方法について説明します。このシナリオでは、仮想マシンはプライマリ VMM サイトからセカンダリ VMM サイトに Site Recovery と SAN レプリケーションを使用してレプリケートされます。

この記事では、概要とデプロイの前提条件について説明します。また、VMM と Site Recovery 資格情報コンテナーでレプリケーションを構成し、有効にする手順を示します。VMM で SAN 記憶域を検出および分類し、LUN をプロビジョニングして、記憶域を Hyper-V クラスターに割り当てます。すべてが正しく動作していることを確認するために、最後にフェールオーバーをテストします。

質問がある場合は、[Azure Recovery Services フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)に投稿してください。

このシナリオには、次に示すビジネス上のメリットがあります。

- Site Recovery によって自動化されたスケーラブルなエンタープライズ レプリケーション ソリューションを提供します。
- ファイバー チャネル記憶域と iSCSI 記憶域の両方で、エンタープライズ記憶域パートナーが提供する SAN レプリケーション機能を利用します。[SAN 記憶域パートナー](http://go.microsoft.com/fwlink/?LinkId=518669)に関するページをご覧ください。
- 既存の SAN インフラストラクチャを活用して、Hyper-V クラスターにデプロイされているミッション クリティカルなアプリケーションを保護します。
- ゲスト クラスターをサポートします。
- 記憶域配列の機能に応じて、RTO と RPO の短縮を実現する同期レプリケーションと、優れた柔軟性を実現する非同期レプリケーションを使用して、アプリケーションのさまざまな階層でレプリケーションの一貫性を確保します。  
- VMM との統合により、VMM コンソール内で SAN を管理できます。また、VMM 内の SMI-S により、既存の記憶域が検出されます。  



## アーキテクチャ

このシナリオでは、SAN レプリケーションを使用して、オンプレミスの VMM サイトの Hyper-V 仮想マシンを別のオンプレミス VMM サイトにバックアップすることで、ワークロードを保護します。

![SAN アーキテクチャ](./media/site-recovery-vmm-san/architecture.png)

このシナリオには次のコンポーネントが含まれます。

- **オンプレミスの仮想マシン** - VMM プライベート クラウドで管理されているオンプレミス Hyper-V サーバーに、保護する仮想マシンが含まれています。
- **オンプレミスの VMM サーバー** - プライマリ サイトとセカンダリ サイトで、保護する 1 つ以上の VMM サーバーを実行できます。
- **SAN 記憶域** - プライマリ サイトとセカンダリ サイトの SAN 配列。
-  **Azure Site Recovery 資格情報コンテナー** - 資格情報コンテナーは、オンプレミスのサイト間でのデータ レプリカ、フェールオーバー、復旧を調整し、オーケストレーションします。
- **Azure Site Recovery Provider** - プロバイダーは、各 VMM サーバーにインストールされています。

## 開始する前に

次の前提条件を満たしていることを確認してください。

**前提条件** | **詳細** 
--- | ---
**Azure**| [Microsoft Azure](http://azure.microsoft.com/) のアカウントが必要です。アカウントがなくても、[無料試用版](https://azure.microsoft.com/pricing/free-trial/)を使用できます。Site Recovery の料金については、[こちら](https://azure.microsoft.com/pricing/details/site-recovery/)を参照してください。 
**VMM** | 少なくとも 1 台の VMM サーバーを、物理または仮想スタンドアロン サーバーとして、または仮想クラスターとしてデプロイする必要があります。<br/><br/>VMM サーバーは、最新の累積更新プログラムが適用された System Center 2012 R2 を実行する必要があります。<br/><br/>保護するプライマリ VMM サーバー上に少なくとも 1 つのクラウドを構成し、保護と回復を行うために使用するセカンダリ VMM サーバー上に 1 つのクラウドを構成する必要があります。<br/><br/>保護するソース クラウドには、1 つ以上のVMM ホスト グループを含める必要があります。<br/><br/>すべての VMM クラウドに Hyper-V キャパシティ プロファイルを設定する必要があります。<br/><br/>VMM クラウドの設定の詳細については、[VMM クラウドのファブリックの構成](https://msdn.microsoft.com/library/azure/dn469075.aspx#BKMK_Fabric)に関するページと、[チュートリアル: System Center 2012 SP1 VMM を使用したプライベート クラウドの作成](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx)に関するページを参照してください。
**Hyper-V** | プライマリ サイトとセカンダリ サイトに 1 つ上の Hyper-V クラスターが必要であり、ソース Hyper-V クラスターに 1 台以上の VM が必要です。プライマリとセカンダリの場所にある VMM ホスト グループは、各グループが 1 つ以上の Hyper-V クラスタを持っている必要があります。<br/><br/>ホストとターゲットの Hyper-V サーバーは、少なくとも Hｙｐｅｒ-V ロールが割り当てられ、最新の更新プログラムがインストールされた Windows Server 2012 を実行中である必要があります。<br/><br/>保護する VM を含む Hyper-V サーバーは VMM クラウドに配置されている必要があります。<br/><br/>Hyper-V をクラスターで実行する場合、静的 IP アドレス ベースのクラスターがあると、クラスター ブローカーは自動的に作成されないことに注意してください。クラスター ブローカーを手動で構成する必要があります。詳細については、[こちら](http://social.technet.microsoft.com/wiki/contents/articles/18792.configure-replica-broker-role-cluster-to-cluster-replication.aspx)を参照してください。
**SAN 記憶域** | SAN レプリケーションを使用して、iSCSI またはファイバー チャネル ストレージがあるか、共有仮想ハード ディスク (vhdx) を使用するゲスト クラスター化仮想マシンをレプリケートできます。<br/><br/>2 つの SAN アレイを設定する必要があります (プライマリ サイト内とセカンダリ サイト内にそれぞれ１ つ)。<br/><br/>これらのアレイの間にネットワーク インフラストラクチャを設定する必要がありますピアリングとレプリケーションが構成されていること。ストレージ アレイの要件に従ってレプリケーション ライセンスが設定されている必要があります。<br/><br/>Hyper-V ホスト サーバーとストレージ アレイの間にネットワークを設定して、ホストが ISCSI またはファイバーチャネルを使用して LUN と通信できるようにする必要があります。<br/><br/> [サポートされるストレージ アレイ](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx)の一覧を確認します。<br/><br/>ストレージ アレイ メーカーによって提供された SMI-Sプロバイダーをインストールする必要があり、SAN アレイはそのプロバイダーによって管理される必要があります。プロバイダーをそれぞれのドキュメントに従って設定します。<br/><br/> VMM サーバーが IP アドレスまたはFQDN によってネットワーク経由でアクセスできるサーバー上にアレイ用の SMI-S プロバイダーがあることを確認します。<br/><br/>各 SAN アレイには、このデプロイで 1 つ以上のストレージ プールを使用できる必要があります。プライマリ サイトの VMM サーバーがプライマリ アレイを管理し、セカンダリ VMM サーバーがセカンダリ アレイを管理します。<br/><br/>プライマリ サイトの VMM サーバーがプライマリ アレイを管理し、セカンダリ VMM サーバーがセカンダリ アレイを管理する必要があります。
**ネットワーク マッピング** | フェールオーバー後に、レプリケートされた仮想マシンがセカンダリ Hyper-V ホスト サーバーに最適に配置され、適切な VM ネットワークに接続できるように、ネットワーク マッピングを構成できます。ネットワーク マッピングを構成しない場合、フェールオーバー後にレプリカ VM はどのネットワークにも接続されません。<br/><br/>デプロイ中にネットワーク マッピングを設定するには、ソース Hyper-V ホスト サーバー上の仮想マシンが VMM VM ネットワークに接続されることを確認します。そのネットワークは、クラウドに関連付けられた論理ネットワークにリンクされている必要があります。<br/<br/>回復に使用するセカンダリ VMM サーバーのターゲット クラウドには対応する VM ネットワークが構成されており、そのネットワークが、ターゲット クラウドに関連付けられている対応する論理ネットワークにリンクされている必要があります。<br/><br/>ネットワーク マッピングについては[こちら](site-recovery-network-mapping.md)を参照してください。


## 手順 1: VMM インフラストラクチャの準備

VMM インフラストラクチャを準備するには、以下を行う必要があります。

1. VMM クラウドが設定されていることを確認する
2. VMM で、SAN 記憶域の統合と分類を行う
3. LUN の作成とストレージの割り当て
4. レプリケーション グループの作成
5. VM ネットワークを設定する

### VMM クラウドが設定されていることを確認する

Site Recovery で、VMM クラウド内の Hyper-V ホスト サーバーに配置された仮想マシンの保護をオーケストレーションします。Site Recovery のデプロイを開始する前に、VMM クラウドが適切に設定されていることを確認する必要があります。次の情報も参考にしてください。

- [VMM クラウド ファブリックの構成](https://msdn.microsoft.com/library/azure/dn883636.aspx#BKMK_Fabric)
- [Creating private clouds (チュートリアル: プライベート クラウドの作成)](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx) (Keith Mayer のブログ)

### VMM で、SAN 記憶域の統合と分類を行う

VMM コンソールで SAN を追加し、分類します。

1. **[ファブリック]** ワークスペースで、**[ストレージ]** をクリックします。**[ホーム]**、**[リソースの追加]**、**[記憶装置]** の順にクリックして、記憶装置の追加ウィザードを起動します。
2. **[記憶域プロバイダーの種類を選択します]** ページで、**[SMI-S プロバイダーにより検出され管理される SAN および NAS デバイス]** を選択します。

	![プロバイダーの種類](./media/site-recovery-vmm-san/provider-type.png)

3. **[記憶域 SMI-S プロバイダーのプロトコルとアドレスを指定します]** ページで、**[SMI-S CIMXML]** を選択し、プロバイダーに接続するための設定を指定します。
4. **[プロバイダーの IP アドレスまたは FQDN]** と **[TCP/IP ポート]** で、プロバイダーに接続するための設定を指定します。SSL 接続は、SMI-S CIMXML にのみ使用できます。

	![プロバイダーの接続](./media/site-recovery-vmm-san/connect-settings.png)

5. **[実行アカウント]** で、プロバイダーにアクセスできる VMM 実行アカウントを指定するか、新しいアカウントを作成します。
6. **[情報の収集]** ページでは、VMM が記憶装置の情報を自動的に検出してインポートします。検出を再試行するには、**[プロバイダーのスキャン]** をクリックします。検出プロセスが成功した場合は、検出された記憶域配列、記憶域プール、製造元、モデル、容量が、ページに一覧表示されます。

	![ストレージの検出](./media/site-recovery-vmm-san/discover.png)

7. **[管理下に置く記憶域プールの選択と分類の指定]** で、VMM が管理し、分類を割り当てる記憶域プールを選択します。LUN 情報が、記憶域プールからインポートされます。保護する必要があるアプリケーション、容量の要件、一緒にレプリケートする必要があるものの要件に基づいて、LUN を作成します。

	![ストレージの分類](./media/site-recovery-vmm-san/classify.png)

### LUN の作成とストレージの割り当て

1. SAN 記憶域が VMM に統合されたら、論理ユニット (LUN) を作成 (プロビジョニング) します。

	- [VMM で論理ユニットの作成方法を選択します。](https://technet.microsoft.com/library/gg610624.aspx)
	- [VMM で記憶域論理ユニットをプロビジョニングします。](https://technet.microsoft.com/library/gg696973.aspx)

2. 次に、VMM がプロビジョニングされたストレージに仮想マシンのデータをデプロイできるように、Hyper-V ホスト クラスターにストレージ容量を割り当てます。

	- 記憶域をクラスターに割り当てる前に、クラスターが存在する VMM ホスト グループに割り当てる必要があります。[記憶域論理ユニットをホスト グループに割り当てる方法](https://technet.microsoft.com/library/gg610686.aspx)に関するページ、および[記憶域プールをホスト グループに割り当てる方法](https://technet.microsoft.com/library/gg610635.aspx)に関するページをご覧ください。</a>
	- 「[VMM で Hyper-V ホスト クラスターの記憶域を構成する方法](https://technet.microsoft.com/library/gg610692.aspx)」の説明に従って、クラスターに記憶域容量を割り当てます。</a>

### レプリケーション グループの作成

一緒にレプリケートする必要があるすべての LUN を含むレプリケーション グループを作成します。

1. VMM コンソールで、記憶域配列プロパティの **[レプリケーション グループ]** タブを開き、**[新規]** をクリックします。
2. 次に、レプリケーション グループを作成します。

	![SAN レプリケーション グループ](./media/site-recovery-vmm-san/rep-group.png)

### ネットワークの設定

ネットワーク マッピングを構成する場合は、次の手順に従います。

1. [ネットワーク マッピング](site-recovery-network-mapping.md)に関するドキュメントを読みます。
2. VMM で VM ネットワークを準備します。

	- [論理ネットワークを設定します](https://technet.microsoft.com/library/jj721568.aspx)。
	- [VM ネットワークを設定](https://technet.microsoft.com/library/jj721575.aspx)します。

## 手順 2: 資格情報コンテナーの作成


1. 登録する VMM サーバーから[管理ポータル](https://portal.azure.com)にサインインします。

2. **[Data Services]**、**[Recovery Services]** の順に展開し、**[Site Recovery コンテナー]** をクリックします。

3. **[新規作成]**、**[簡易作成]** の順にクリックします。

4. **[名前]** ボックスに、コンテナーを識別する表示名を入力します。

5. **[リージョン]** ボックスで、資格情報コンテナーのリージョンを選択します。サポートされているリージョンを確認するには、「[Azure Site Recovery Pricing Details (Azure Site Recovery の価格の詳細)](http://go.microsoft.com/fwlink/?LinkId=389880)」で利用可能地域を参照してください。

6. **[コンテナーの作成]** をクリックします。

	![新しいコンテナー](./media/site-recovery-vmm-san/create-vault.png)

ステータス バーを確認して、コンテナーが正常に作成されたことを確かめます。**Recovery Services** のメイン ページでは、資格情報コンテナーは **[アクティブ]** と表示されます。


### VMM サーバーの登録

1. **[Recovery Services]** ページから [クイック スタート] ページを開きます。[クイック スタート] は、アイコンを使っていつでも開くことができます。

	![[クイック スタート] アイコン](./media/site-recovery-vmm-san/quick-start-icon.png)

2. ドロップダウン リストで、**[Hyper-V オンプレミス サイト間でアレイ レプリケーションを使用]** を選択します。

	![登録キー](./media/site-recovery-vmm-san/select-san.png)


3. **[VMM サーバーの準備]** で、Azure Site Recovery Provider インストール ファイルの最新バージョンをダウンロードします。
4. ソース VMM サーバーでこのファイルを実行します。プロバイダーを初めてインストールするときに、VMM がクラスターにデプロイされている場合は、プロバイダーをアクティブなノードにインストールします。インストールが終了したら、VMM サーバーをコンテナーに登録します。次に、プロバイダーを他のノードにインストールします。プロバイダーをアップグレードする場合は、すべてのノードでアップグレードする必要があります。これは、すべてのノードで同じバージョンのプロバイダーを実行する必要があるためです。
5. インストーラーによっていくつかの**前提条件チェック**が実行され、プロバイダーのセットアップを開始するために VMM サービスを停止するアクセス許可が要求されます。セットアップが完了すると、VMM サービスは自動的に再起動されます。VMM クラスターにインストールしている場合は、クラスター ロールを停止するよう求められます。
6. **[Microsoft Update]** で、アップデートの内容を設定できます。この設定を行うことで、設定した Microsoft Update のポリシーに従って、プロバイダーの有効な更新がインストールされます。

	![Microsoft 更新プログラム](./media/site-recovery-vmm-san/ms-update.png)

7. インストール場所は、**<SystemDrive>\\Program Files\\Microsoft System Center 2012 R2\\Virtual Machine Manager\\bin** に設定されています。[インストール] ボタンをクリックすると、プロバイダーのインストールが開始されます。

	![InstallLocation](./media/site-recovery-vmm-san/install-location.png)

8. プロバイダーがインストールされたら、[登録] ボタンをクリックしてサーバーをコンテナーに登録します。

	![InstallComplete](./media/site-recovery-vmm-san/install-complete.png)

9. **[インターネット接続]** で、VMM サーバーで実行中のプロバイダーがインターネットに接続する方法を指定します。**[既定のシステム プロキシ設定を使用]** を選択して、サーバー上に構成されている既定のインターネット接続設定を使用します。

	![インターネット設定](./media/site-recovery-vmm-san/proxy-details.png)

	- カスタム プロキシを使用する場合は、プロバイダーをインストールする前に設定する必要があります。カスタム プロキシ設定を構成すると、プロキシの接続を確認するためのテストが実施されます。
	- カスタム プロキシを使用する場合、または既定のプロキシで認証が必要な場合、プロキシのアドレスやポートなどの詳細を入力する必要があります。
	- VMM サーバーと Hyper-V ホストから次の URL にアクセスできる必要があります。
		- *.hypervrecoverymanager.windowsazure.com
		- *.accesscontrol.windows.net
		- *.backup.windowsazure.com
		- *.blob.core.windows.net
		- *.store.core.windows.net
	- 「[Azure Datacenter の IP 範囲](https://www.microsoft.com/download/confirmation.aspx?id=41653)」に記載されている IP アドレスと HTTPS (443) プロトコルを許可します。使用を計画している Azure リージョンの IP の範囲と米国西部の IP の範囲をホワイトリストに登録する必要があります。
	- カスタム プロキシを使用する場合、指定されたプロキシの資格情報を使用して VMM RunAs アカウント (DRAProxyAccount) が自動的に作成されます。このアカウントが正しく認証されるようにプロキシ サーバーを構成します。VMM RunAs アカウントの設定は VMM コンソールで変更できます。変更するには、[設定] ワークスペースを開いて [セキュリティ] を展開し、[実行アカウント] をクリックします。その後、DRAProxyAccount のパスワードを変更します。新しい設定を有効にするには、VMM サービスを再起動する必要があります。

10. **[登録キー]** で、Azure Site Recovery からダウンロードして VMM サーバーにコピーした登録キーを選択します。
11. **[コンテナー名]** で、サーバーが登録されるコンテナーの名前を確認します。 

	![サーバー登録](./media/site-recovery-vmm-san/vault-creds.png)

12. この暗号化設定は VMM から Azure へのシナリオにのみ使用されます。VMM から VMM へのみのユーザーの場合は、この画面を無視できます。

	![サーバー登録](./media/site-recovery-vmm-san/encrypt.png)

13. **[サーバー名]** に、コンテナーで VMM サーバーを識別する表示名を入力します。クラスター構成で、VMM クラスターのロール名を指定します。
14. **[初期クラウド メタデータ同期]** で、コンテナーに表示されるサーバーの名前を指定し、VMM サーバー上のすべてのクラウドのメタデータをコンテナーと同期するかどうかを選択します。この操作は、各サーバーで 1 回のみ実行する必要があります。すべてのクラウドを同期したくない場合は、この設定をオフのままにして、VMM コンソールのクラウドのプロパティで各クラウドを個別に同期できます。

	![サーバー登録](./media/site-recovery-vmm-san/friendly-name.png)

15. **[次へ]** をクリックしてプロセスを完了します。登録後に、VMM サーバーからのメタデータが、Azure Site Recovery によって取得されます。サーバーは、コンテナーの **[サーバー]** ページの [VMM サーバー] タブに表示されます。

### コマンド ラインを使用したインストール

Azure Site Recovery プロバイダーは、次のコマンド ラインを使用してインストールすることもできます。この方法を使用すると、Windows Server 2012 R2 の Server CORE にプロバイダーをインストールできます。

1. プロバイダーのインストール ファイルと登録キーを C:\\ASR などのフォルダーにダウンロードします。
2. System Center Virtual Machine Manager サービスを停止します。
3. **管理者**特権でコマンド プロンプトから次のコマンドを実行して、プロバイダーのインストーラーを抽出します。

    	C:\Windows\System32> CD C:\ASR
    	C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q

4. 以下を実行して、プロバイダーをインストールします。

		C:\ASR> setupdr.exe /i

5. 以下を実行して、プロバイダーを登録します。

    	CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
    	C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>         

パラメーターは、次のとおりです。

 - **/Credentials**: 登録キー ファイルが配置されている場所を指定する必須パラメーターです。  
 - **/Friendlyname**: Azure Site Recovery ポータルに表示される、Hyper-V ホスト サーバーの名前を表す必須パラメーターです。
 - **/EncryptionEnabled**: 省略可能。VMM から Azure へのシナリオで、Azure にある仮想マシンの暗号化が必要な場合にのみ使用する必要があります。拡張子が **.pfx** のファイル名を指定してください。
 - **/proxyAddress**: 省略可能。プロキシ サーバーのアドレスを指定します。
 - **/proxyport**: 省略可能。プロキシ サーバーのポートを指定します。
 - **/proxyUsername**: 省略可能。プロキシのユーザー名を指定します (認証が必要なプロキシの場合)。
 - **/proxyPassword**: 省略可能。プロキシ サーバーの認証に使用するパスワードを指定します (認証が必要なプロキシの場合)。


## 手順 3: 記憶域アレイとプールのマッピング

配列をマップして、プライマリ プールからレプリケーション データを受け取るセカンダリ記憶域プールを指定します。レプリケーション グループの保護を有効にすると、マッピング情報が使用されるため、クラウドの保護を構成する前に記憶域をマップする必要があります。

開始する前に、コンテナーにクラウドが表示されることを確認します。クラウドを検出するには、プロバイダーをインストールする際に、すべてのクラウドを同期することを選択するか、VMM コンソールのクラウド プロパティの **[全般]** タブで、特定のクラウドを同期することを選択します。次の手順に従って、記憶域配列をマッピングします。

1. **[リソース]**、**[サーバー記憶域]**、**[ソース アレイとターゲット アレイのマッピング]** の順にクリックします。![サーバー登録](./media/site-recovery-vmm-san/storage-map.png)
2. プライマリ サイトで記憶域配列を選択し、それらをセカンダリ サイトの記憶域配列にマッピングします。
3.  配列内で、ソースとターゲットの記憶域プールをマッピングします。そのためには、**[記憶域プール]** で、マッピングするソースとターゲットの記憶域プールを選択します。

	![サーバー登録](./media/site-recovery-vmm-san/storage-map-pool.png)

## ステップ 4: クラウドの保護設定の構成

VMM サーバーを登録した後、クラウドの保護設定を構成することができます。プロバイダーのインストール時に **[コンテナーとのクラウド データの同期]** を有効にしたので、VMM サーバー上のすべてのクラウドが、資格情報コンテナーの <b>[保護された項目]</b> タブに表示されます。

![発行済みのクラウド](./media/site-recovery-vmm-san/clouds-list.png)

1. [クイック スタート] ページで、**[VMM クラウドの保護の設定]** をクリックします。
2. **[保護された項目]** タブで、構成するクラウドを選択し、**[構成]** タブに移動します。以下の点に注意してください。
3. <b>[ターゲット]</b> で <b>[VMM]</b> を選択します。
4. <b>[ターゲットの場所]</b> で、回復時に使用するクラウドを管理するオンサイト VMM サーバーを選択します。
5. <b>[ターゲット クラウド]</b> で、ソース クラウド内の仮想マシンのフェールオーバー時に使用するターゲット クラウドを選択します。以下の点に注意してください。
	- 保護する仮想マシンの復旧要件を満たしたターゲット クラウドを選択することをお勧めします。
	- クラウドは、プライマリ クラウドまたはターゲット クラウドとして、1 つのクラウド ペアに属することしかできません。
6. Azure Site Recovery は、クラウドが SAN レプリケーション対応のストレージにアクセスできること、および記憶域配列がピアリングされていることを検証します。参加しているピア状態のアレイが表示されます。
7. 検証が成功した場合、**[レプリケーションの種類]** で **[SAN]** を選択します。

<p>この設定を保存すると、ジョブが作成され、これを <b>[ジョブ]</b> タブで監視できます。クラウド設定は <b>[構成]</b> タブで変更できます。ターゲットの場所やターゲット クラウドを変更する場合は、クラウド構成を削除して、クラウドを再構成する必要があります。</p>

## 手順 5: ネットワーク マッピングの有効化

1. [クイック スタート] ページで、**[ネットワークのマップ]** をクリックします。
2. ネットワークをマップするソース VMM サーバーを選択し、次に、ネットワークがマップされるターゲット VMM サーバーを選択します。ソース ネットワークとそれに関連付けられたターゲット ネットワークの一覧が表示されます。現在マッピングされていないネットワークには空白の値が表示されます。ソース ネットワーク名とターゲット ネットワーク名の横にある情報アイコンをクリックして各ネットワークのサブネットを表示します。
3. **[ソースのネットワーク]** でネットワークを選択し、**[マップ]** をクリックします。サービスによってターゲット サーバー上の VM ネットワークが検出され、表示されます。

	![SAN アーキテクチャ](./media/site-recovery-vmm-san/network-map1.png)

4. 表示されるダイアログ ボックスで、ターゲットVMM サーバーから VM ネットワークを 1 つ選択します。

	![SAN アーキテクチャ](./media/site-recovery-vmm-san/network-map2.png)

5. ターゲット ネットワークを選択すると、ソース ネットワークを使用する保護されたクラウドが表示されます。保護に使用するクラウドに関連付けられている使用可能なターゲット ネットワークも表示されます。保護に使用しているすべてのクラウドで使用可能なターゲット ネットワークを選択することをお勧めします。
6.  チェック マークをクリックして、マッピング処理を完了します。ジョブが開始され、マッピングの進行状況を追跡します。進行状況は **[ジョブ]** タブで確認できます。


## 手順 6: レプリケーション グループのレプリケーションの有効化</h3>

仮想マシンの保護を有効にする前に、ストレージ レプリケーション グループのレプリケーションを有効にする必要があります。

1. Azure Site Recovery ポータルのプライマリ クラウドの [プロパティ] ページで、**[Virtual Machines]** タブを開きます。**[レプリケーション グループの追加]** をクリックします。
2. クラウドに関連付けられている 1 つ以上の VMM レプリケーション グループを選択し、ソースとターゲットのアレイを確認して、レプリケーションの頻度を指定します。

この操作が完了したら、Azure Site Recovery は、VMM および SMI-S プロバイダーと連携して、ターゲット サイトのストレージ LUN をプロビジョニングし、ストレージのレプリケーションを有効にします。レプリケーション グループが既にレプリケートされている場合、Azure Site Recovery は既存のレプリケーション関係を再利用し、Azure Site Recovery の情報を更新します。

## ステップ 7: 仮想マシンの保護を有効化する

ストレージ グループがレプリケートされた後、VMM コンソールで次のいずれかの方法を使用し、仮想マシンの保護を有効にします。

- **[新しい仮想マシン]** - VMM コンソールで新しい仮想マシンを作成するときに、Azure Site Recovery 保護を有効にし、仮想マシンをレプリケーション グループに関連付けます。このオプションでは、VMM はインテリジェントな配置機能を使用し、仮想マシンのストレージをレプリケーション グループの LUN に適切に配置します。Azure Site Recovery は、セカンダリ サイトでのシャドウ仮想マシンの作成を調整し、レプリカ仮想マシンがフェールオーバー後に起動できるように、容量を割り当てます。
- **[既存の仮想マシン]** - 仮想マシンが VMM に既にデプロイされている場合は、Azure Site Recovery 保護を有効にし、レプリケーション グループへの記憶域の移行を実行できます。完了した後、VMM と Azure Site Recovery は、新しい仮想マシンを検出し、Azure Site Recovery 保護による管理を開始します。シャドウ仮想マシンは、セカンダリ サイトに作成され、フェールオーバー後にレプリカ仮想マシンが起動できるように、容量が割り当てられます。

	![保護を有効にする](./media/site-recovery-vmm-san/enable-protect.png)

仮想マシンの保護を有効にすると、Azure Site Recovery コンソールに仮想マシンが表示されます。仮想マシンのプロパティの表示、状態の追跡、複数の仮想マシンを含むレプリケーション グループのフェールオーバーを実行できます。SAN レプリケーションでは、レプリケーション グループに関連付けられているすべての仮想マシンは、一緒にフェールオーバーする必要があることに注意してください。これは、フェールオーバーが最初にストレージ層で行われるためです。レプリケーション グループを適切にグループ化し、関連する仮想マシンのみを一緒に配置することが重要です。

**[ジョブ]** タブで、保護の有効化のアクション (初期レプリケーションなど) の進捗状況を確認できます。保護の最終処理のジョブが実行されると、仮想マシンは、フェールオーバーを実行できる状態になります。

![仮想マシン保護ジョブ](./media/site-recovery-vmm-san/job-props.png)

## ステップ 8: デプロイのテスト

デプロイをテストして、仮想マシンとデータが想定どおりにフェールオーバーされるかどうかを確認します。そのためには、レプリケーション グループを選択して、復旧計画を作成します。次に、その計画に従ってテスト フェールオーバーを実行します。

1. **[復旧計画]** タブで、**[復旧計画の作成]** をクリックします。
2. 復旧計画の名前、ソースおよびターゲット VMM サーバーを指定します。ソース サーバーには、フェールオーバーと復旧が有効になった仮想マシンが必要になります。**[SAN]** を選択して、SAN レプリケーションが構成されたクラウドだけを表示します。
3.
	![復旧計画の作成](./media/site-recovery-vmm-san/r-plan.png)

4. **[仮想マシンの選択]** で、レプリケーション グループを選択します。レプリケーション グループに関連付けられているすべての仮想マシンを選択し、復旧計画に追加します。これらの仮想マシンは、復旧計画の既定のグループ「グループ 1」に追加されます。必要に応じて、他のグループを追加することもできます。レプリケーションの後、仮想マシンは復旧計画のグループの順序に従って起動することに注意してください。

	![仮想マシンを追加](./media/site-recovery-vmm-san/r-plan-vm.png)
5. 復旧計画が作成されると、**[復旧計画]** タブに一覧が表示されます。
6. **[復旧計画]** タブで、計画を選択し、**[テスト フェールオーバー]** をクリックします。
7. **[テスト フェールオーバーの確認]** ページで、**[なし]** を選択します。このオプションが有効な場合、フェールオーバーしたレプリカ仮想マシンはネットワークに接続されないことに注意してください。このテストでは、仮想マシンが想定どおりにフェールオーバーすることをテストしますが、レプリケーションのネットワーク環境はテストしません。各種ネットワーク オプションの使用方法について詳しくは、[テスト フェールオーバーの実行](site-recovery-failover.md#run-a-test-failover)方法を参照してください。


	![テスト ネットワークの選択](./media/site-recovery-vmm-san/test-fail1.png)


8. レプリカ仮想マシンが存在するホストと同じホスト上に、テスト仮想マシンが作成されます。これは、レプリカ仮想マシンが配置されているクラウドには追加されません。
9. レプリケーション後に、レプリカ仮想マシンは、プライマリ仮想マシンの IP アドレスとは異なる IP アドレスを保有します。DHCP からアドレスを発行している場合は、自動的に更新されます。DHCP を使用していない場合に、アドレスが同じかどうかを確認するには、複数のスクリプトを実行する必要があります。
10. 次のサンプル スクリプトを実行して、IP アドレスを取得します。

    	$vm = Get-SCVirtualMachine -Name <VM_NAME>
		$na = $vm[0].VirtualNetworkAdapters>
		$ip = Get-SCIPAddress -GrantToObjectID $na[0].id
		$ip.address  

11. 前のサンプル スクリプトを使用して取得した IP アドレスを指定して、次のサンプル スクリプトを実行し、DNS を更新します。

		[string]$Zone,
		[string]$name,
		[string]$IP
		)
		$Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
		$newrecord = $record.clone()
		$newrecord.RecordData[0].IPv4Address  =  $IP
		Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord

## 次のステップ

テスト フェールオーバーを実行して、環境が期待どおりに動作することを確認したら、[こちらで](site-recovery-failover.md)異なる種類のフェールオーバーについて参照します。

<!---HONumber=AcomDC_0121_2016-->
