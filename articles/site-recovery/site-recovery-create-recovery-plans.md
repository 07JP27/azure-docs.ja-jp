---
title: "Azure Site Recovery でフェールオーバーと復旧用の復旧計画を作成してカスタマイズする | Microsoft Docs"
description: "Azure Site Recovery で復旧計画を作成してカスタマイズする方法を説明します。 この記事では、VM と物理サーバーをフェールオーバーして復旧する方法について説明します。"
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: 72408c62-fcb6-4ee2-8ff5-cab1218773f2
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 01/26/2018
ms.author: raynew
ms.openlocfilehash: 6ad82a8a2f8e16ab794ba90c109904bd45cb6b89
ms.sourcegitcommit: d87b039e13a5f8df1ee9d82a727e6bc04715c341
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/21/2018
---
# <a name="create-a-recovery-plan-by-using-site-recovery"></a>Site Recovery を使用して復旧計画を作成する

この記事では、[Azure Site Recovery](site-recovery-overview.md) で復旧計画を作成してカスタマイズする方法について説明します。

以下の手順を実行して復旧計画を作成します。

* 一緒にフェールオーバーし、一緒に起動するマシンのグループを定義します。
* マシンを復旧計画グループにまとめることにより、マシン間の依存関係をモデル化します。 たとえば、特定のアプリケーションをフェールオーバーおよび起動するには、そのアプリケーションのすべての VM を同じ復旧計画グループに含めます。
* フェールオーバーを実行します。 復旧計画で、テスト フェールオーバー、計画されたフェールオーバー、または計画されていないフェールオーバーを実行できます。

## <a name="why-use-a-recovery-plan"></a>復旧計画を使用する理由

復旧計画は、管理可能な小規模の独立ユニットを作成して体系的な復旧プロセスを準備するために役立ちます。 こうしたユニットは、通常、環境内のアプリケーションを表します。 復旧計画は、VM の起動順序を定義するために役立ちます。 また、復旧計画を使用して、復旧時の一般的なタスクを自動化することもできます。

> [!TIP]
> クラウドの移行または災害復旧の準備ができていることを確認する 1 つの方法は、各アプリケーションが復旧計画に含まれるようにすることです。 また、Azure への復旧に関して各復旧計画をテストしてください。 このように準備することで、データセンター全体を、Azure に自信をもって移行またはフェールオーバーできます。
 
復旧計画には、次の 3 つの重要な価値提案があります。

* 依存関係をキャプチャするようにアプリケーションをモデル化します。
* 大部分の復旧タスクを自動化して RTO を短縮します。
* テスト フェールオーバーで災害に備えます。

### <a name="model-an-application-to-capture-dependencies"></a>依存関係をキャプチャするようにアプリケーションをモデル化する

復旧計画とは、通常 1 つのアプリケーションを構成し、まとめてフェールオーバーされる仮想マシンのグループを指します。 復旧計画コンストラクトを使用すると、復旧計画グループを強化して、アプリケーション固有のプロパティをキャプチャできます。 

この記事では、SQL バック エンド、ミドルウェア、Web フロント エンドを含む、典型的な 3 層のアプリケーションを取り上げます。 復旧計画をカスタマイズして、フェールオーバー後に仮想マシンが正しい順序で起動するようにできます。 最初に SQL バック エンド、次にミドルウェア、最後に Web フロント エンドが起動する必要があります。 この順序であれば、最後の仮想マシンが起動するまでには、アプリケーションが確実に動作しています。 

たとえば、ミドルウェアは起動すると、SQL 層に接続しようとします。 復旧計画によって SQL 層が既に実行していることが保証されます。 また、フロントエンド サーバーを最後に起動することで、すべてのコンポーネントが稼働し、アプリケーションで要求を受け入れる準備ができるまで、エンド ユーザーがアプリケーション URL に接続することがなくなります。 こうした依存関係を構築するために、復旧計画をカスタマイズして、グループの追加や仮想マシンの選択を行うことができます。 グループ間で仮想マシンを移動するには、仮想マシンのグループを変更します。

![Site Recovery でのサンプル復旧計画のスクリーンショット](./media/site-recovery-create-recovery-plans/rp.png)

カスタマイズが完了すると、正確な復旧手順を視覚化できます。 復旧計画のフェールオーバーで実行される手順を次に示します。

1. シャットダウンの手順によって、オンプレミスの仮想マシンの停止が試行されます。 (プライマリ サイトが実行し続ける必要があるテスト フェールオーバーを除きます。)
2. 次に、シャットダウンによって、復旧計画に含まれる仮想マシンすべてのフェールオーバーが同時にトリガーされます。 フェールオーバーの手順では、レプリケートされたデータを使用して仮想マシンのディスクが準備されます。
3. 起動グループは、順序どおりに実行され、各グループの仮想マシンが起動されます。 最初にグループ 1、次にグループ 2、最後にグループ 3 が実行します。 グループに複数の仮想マシンが含まれる場合 (負荷分散された Web フロントエンドなど)、すべての仮想マシンが同時に起動されます。

> [!TIP]
> グループの順序によって、各アプリケーション層の依存関係が保証されます。 並列処理を適切に使用することで、アプリケーション復旧の RTO が向上します。

   > [!NOTE]
   > 1 つのグループに含まれるマシンは同時にフェールオーバーされます。 異なるグループに含まれるマシンは、グループの順番に従ってフェールオーバーされます。 グループ 1 のすべてのマシンのフェールオーバーと起動が完了しないと、グループ 2 のマシンのフェールオーバーは開始されません。

### <a name="automate-most-recovery-tasks-to-reduce-rto"></a>大部分の復旧タスクを自動化して RTO を短縮する

大規模なアプリケーションの復旧は複雑になる可能性があります。 混乱した状況で多数の手動手順を思い出すのは難しく、その過程で間違いが発生しやすくなります。 また、フェールオーバーを実際にトリガーするのは、アプリケーションの複雑さを認識していないユーザーである可能性があります。 

復旧計画を使用すると、各手順を進めるために必要となるアクションを自動化できます。 Azure Automation Runbook を使用して必要なアクションを設定できます。 Runbook を使用すると、次の例のような一般的な復旧タスクを自動化できます。 自動化できないタスクについては、復旧計画に手動アクションを挿入できます。

* **フェールオーバー後の Azure 仮想マシンでのタスク**: 仮想マシンに接続するために通常必要なタスクです。 次に例を示します。
    * フェールオーバー後に仮想マシンのパブリック IP アドレスを作成します。
    * フェールオーバーした仮想マシンの NIC にネットワーク セキュリティ グループを割り当てます。
    * 可用性セットにロード バランサーを追加します。
* **フェールオーバー後の仮想マシン内のタスク**: アプリケーションを再構成して、新しい環境で適切に動作し続けるようにします。 次に例を示します。
    * 仮想マシン内のデータベース接続文字列を変更します。
    * Web サーバーの構成またはルールを変更します。

> [!TIP]
> ワンクリック フェールオーバーを実現し、RTO を最適化するには、Automation Runbook を使用して復旧後のタスクを自動化する完全な復旧計画を作成します。

### <a name="test-failover-to-be-ready-for-a-disaster"></a>テスト フェールオーバーで災害に備える

復旧計画を使用して、フェールオーバーまたはテスト フェールオーバーのいずれかをトリガーできます。 フェールオーバーを実行する前に、必ずアプリケーションでテスト フェールオーバーを完了する必要があります。 テスト フェールオーバーは、アプリケーションが復旧サイトで利用可能になるかどうかを確認するうえで役立ちます。 セットアップに何かが足りなかった場合は、簡単にクリーンアップをトリガーして、テスト フェールオーバーを再実行できます。 テスト フェールオーバーは、アプリケーションがスムーズに復旧することを確信できるまで複数回実行します。

![Site Recovery でのサンプルのテスト復旧計画のスクリーンショット](./media/site-recovery-create-recovery-plans/rptest.png)

> [!TIP]
> アプリケーションはそれぞれが固有であるため、各アプリケーションに合わせてカスタマイズされた復旧計画を作成する必要があります。 
>
> また、現在のデータセンターに重点を置いた動的な環境では、アプリケーションと依存関係は頻繁に変化します。 復旧計画が最新であることを確認するため、四半期に 1 回はアプリケーションのテスト フェールオーバーを行ってください。

## <a name="create-a-recovery-plan"></a>復旧計画の作成

1. **[復旧計画]** > **[復旧計画の作成]** の順に選択します。
   復旧計画の名前、およびソースとターゲットを指定します。 ソースの場所には、フェールオーバーと復旧が有効になった仮想マシンが必要になります。 復旧計画に含める仮想マシンに基づいてソースとターゲットを選択します。 

   |シナリオ                   |ソース               |ターゲット           |
   |---------------------------|---------------------|-----------------|
   |Azure から Azure             |Azure リージョン         |Azure リージョン     |
   |VMware から Azure            |構成サーバー |Azure            |
   |Virtual Machine Manager (VMM) から Azure               |VMM 表示名    |Azure            |
   |Hyper-V サイトから Azure      |Hyper-V サイト名    |Azure            |
   |物理マシンから Azure |構成サーバー |Azure            |
   |VMM から VMM                 |VMM フレンドリ名    |VMM 表示名|

   > [!NOTE]
   > 復旧計画には、ソースとターゲットが同一の仮想マシンを含めることができます。 VMware と System Center Virtual Machine Manager (VMM) の仮想マシンを同じ復旧計画に含めることはできません。 ただし、VMware の仮想マシンと物理マシンを同じ復旧計画に加えることはできます。 このケースでは、両方のマシンのソースは構成サーバーです。

2. **[仮想マシンの選択]** で、復旧計画の既定のグループ (グループ 1) に追加する必要のある仮想マシン (またはレプリケーション グループ) を選択します。 選択できるのは、ソースで保護されていた仮想マシン (復旧計画で選択されているもの) と、ターゲットで保護されるもの (復旧計画で選択されているもの) だけです。

## <a name="customize-and-extend-recovery-plans"></a>復旧計画のカスタマイズと拡張

復旧計画をカスタマイズして拡張するには、Site Recovery の [recovery plan resource]\(復旧計画リソース\) ウィンドウに移動します。 **[カスタマイズ]** タブを選択します。次のオプションを使用して、復旧計画をカスタマイズおよび拡張できます。

- **[Add new groups]\(新しいグループの追加\)**: 既定のグループに 7 個まで復旧計画グループを追加できます。 また、それらの復旧計画グループに、さらに多くのマシンまたはレプリケーション グループを追加できます。 グループには、追加順を示す番号が割り当てられます。 仮想マシンまたはレプリケーション グループは、1 つの復旧計画グループのみに含めることができます。
- **[Add a manual action]\(手動アクションの追加\)**: 復旧計画グループの前後に実行する手動アクションを追加できます。 復旧計画を実行すると、手動アクションを挿入した位置で停止します。 ダイアログ ボックスで、手動アクションが完了したことを指定するように求められます。
- **[スクリプトの追加]**: 復旧計画グループの前後に実行されるスクリプトを追加できます。 スクリプトを追加すると、グループに対して新しい一連のアクションが追加されます。 たとえば、グループ 1 の前処理ステップ セットが "*グループ 1: 前処理ステップ*" という名前で作成されます。 すべての前処理ステップが、このセット内に一覧表示されます。 プライマリ サイトにスクリプトを追加できるのは、VMM サーバーがデプロイされている場合のみです。 詳しくは、「[Add a VMM script to a recovery plan](site-recovery-how-to-add-vmmscript.md)」(復旧計画に VMM スクリプトを追加する) をご覧ください。
- **[Add Azure runbooks]\(Azure Runbook の追加\)** — Azure Runbook を使用して復旧計画を拡張することができます。 たとえば、Runbook を使用してタスクを自動化したり、シングル ステップ復旧を作成したりします。 詳しくは、「[復旧計画に Azure Automation Runbook を追加する ](site-recovery-runbook-automation.md)」をご覧ください。


## <a name="add-a-script-runbook-or-manual-action-to-a-plan"></a>スクリプト、Runbook、または手動アクションを計画に追加する

仮想マシンまたはレプリケーション グループを既定の復旧計画グループに追加した後、スクリプトまたは手動アクションをその復旧計画グループに追加できます。

1. 復旧計画を開きます。
2. **[ステップ]** リストで項目を選択します。 次に、 **[スクリプト]** または **[手動アクション]** を選択します。
3. 選択した項目の前または後のどちらにスクリプトまたはアクションを追加するかを指定します。 スクリプト内で上下に移動するには、**[上へ移動]** ボタンまたは **[下へ移動]** ボタンを使用します。
4. VMM スクリプトを追加する場合は、**[Failover to VMM script (VMM へのフェールオーバー スクリプト)]** を選択します。 **[スクリプト パス]** に、共有への相対パスを入力します。 たとえば、**\RPScripts\RPScript.PS1** です。
5. Automation Runbook を追加する場合は、Runbook がある Automation アカウントを指定します。 次に、Azure Runbook スクリプトを選択します。
6. 復旧計画のフェールオーバーを実行して、スクリプトが期待どおりに動作することを確認します。

スクリプトまたは Runbook のオプションは、次のシナリオにおいてフェールオーバーまたはフェールバックの際のみ使用できます。 手動アクションは、フェールオーバーとフェールバックの両方で使用できます。


|シナリオ               |フェールオーバー |フェールバック |
|-----------------------|---------|---------|
|Azure から Azure         |Runbook |Runbook  |
|VMware から Azure        |Runbook |該当なし       | 
|VMM から Azure           |Runbook |スクリプト   |
|Hyper-V サイトから Azure  |Runbook |該当なし       |
|VMM から VMM             |スクリプト   |スクリプト   |


## <a name="next-steps"></a>次の手順

* フェールオーバーの実行については、[こちら](site-recovery-failover.md)を参照してください。  
* このビデオで実行中の復旧計画をご確認ください。
    
    > [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/One-click-failover-of-a-2-tier-WordPress-application-using-Azure-Site-Recovery/player]
