---
title: "Site Recovery を使用して Azure にレプリケートされる Hyper-V VM のフェールオーバーとフェールバック | Microsoft Docs"
description: "Azure Site Recovery を使用して Hyper-V VM を Azure にフェールオーバーする方法と、オンプレミスにフェールバックする方法について説明します"
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: article
ms.date: 03/8/2018
ms.author: raynew
ms.openlocfilehash: 7863feb29fbb04f643aa3b7e1984209f44cdbe9a
ms.sourcegitcommit: 8c3267c34fc46c681ea476fee87f5fb0bf858f9e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/09/2018
---
# <a name="fail-over-and-fail-back-hyper-v-vms-replicated-to-azure"></a>Azure にレプリケートされる Hyper-V VM のフェールオーバーとフェールバック

このチュートリアルでは、Hyper-V VM と Azure にフェールオーバーする方法について説明します。 フェールオーバーした後、オンプレミス サイトが使用可能になったときにオンプレミス サイトにフェールバックします。 このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * Hyper-V VM のプロパティで Azure の要件に準拠していることを確認する
> * Azure へのフェールオーバーを実行する
> * Azure VM をオンプレミス サイトで再保護する
> * Azure からオンプレミスにフェールバックする
> * オンプレミス VM を再保護して、Azure へのレプリケートを再開する

これはシリーズで 5 番目のチュートリアルです。 このチュートリアルでは、前のチュートリアルで以下のタスクがすでに完了していることを前提としています。

1. [Azure を準備する](tutorial-prepare-azure.md)
2. [オンプレミスの VMware を準備する](tutorial-prepare-on-premises-hyper-v.md)
3. [Hyper-V VM](tutorial-hyper-v-to-azure.md) または [System Center VMM クラウドで管理される Hyper-V VM](tutorial-hyper-v-vmm-to-azure.md) のディザスター リカバリーをセットアップする
4. [ディザスター リカバリーのテストを実行する](tutorial-dr-drill-azure.md)

## <a name="prepare-for-failover-and-failback"></a>フェールオーバーとフェールバックを準備する

VM にスナップショットがないことと、再保護中にオンプレミスの VM をオフにすることを確認します。 これは、レプリケーション中のデータの整合性を確保するのに役立ちます。 再保護が完了した後は、VM を有効にしないでください。 

フェールオーバーとフェールバックには 4 つの段階があります。

1. **Azure にフェールオーバーする**: オンプレミス サイトのコンピューターを Azure にフェールオーバーします。
2. **Azure VM を再保護する**: Azure VM がオンプレミスの Hyper-V VM へのレプリケートが開始されるように、Azure VM を再保護します。
3. **オンプレミスにフェールオーバーする**: Azure からオンプレミス サイトへのフェールオーバーを実行します (可能な場合)。
4. **オンプレミス VM を再保護する**: データがフェールバックされたら、フェールバック先のオンプレミスの VM を再保護し、Azure へのレプリケートを開始します。

## <a name="verify-vm-properties"></a>VM のプロパティを確認する

VM のプロパティで、VM が [Azure の要件](hyper-v-azure-support-matrix.md#replicated-vms)に準拠していることを確認します。

1. **[保護されているアイテム]** で、**[レプリケートされたアイテム]** > [<VM-name>] をクリックします。

2. **[レプリケートされたアイテム]** ウィンドウで、VM 情報、正常性状態、および最新の使用可能な復旧ポイントを確認します。 **[プロパティ]** をクリックすると、詳細が表示されます。
     - **[コンピューティングとネットワーク]** で、VM 設定や、フェールオーバー後に Azure VM が配置されるネットワーク/サブネットと、 管理ディスクは Azure から Hyper-V へのフェールバックではサポートされません。
   それに対して割り当てられる IP アドレスなどのネットワーク設定を変更できます。
    - **[ディスク]** で、VM のオペレーティング システム ディスクとデータ ディスクに関する情報を確認できます。

## <a name="fail-over-to-azure"></a>Azure にフェールオーバーする

1. **[設定]** > **[レプリケートされたアイテム]** で、[VM] > **[フェールオーバー]** をクリックします。
2. **[フェールオーバー]** で **[最新]** 復旧ポイントを選択します。 
3. **[フェールオーバーを開始する前にマシンをシャットダウンします]** を選択します。 Site Recovery は、フェールオーバーを開始する前にソース VM をシャットダウンしようとします。 仮にシャットダウンが失敗したとしても、フェールオーバーは続行されます。 フェールオーバーの進行状況は **[ジョブ]** ページで確認できます。
4. フェールオーバーを確認したら、**[コミット]** をクリックします。 これにより、利用可能なすべての復旧ポイントが削除されます。

> [!WARNING]
> **進行中のフェールオーバーをキャンセルしないでください**。フェールオーバーが開始される前に VM のレプリケーションが停止します。 進行中にキャンセルすると、フェールオーバーは停止しますが、VM が再びレプリケートされることはありません。

## <a name="reprotect-azure-vms"></a>Azure VM を再保護する

1. **[AzureVMVault]\(AzureVMVault\)** > **[レプリケートされたアイテム]** で、フェールオーバーされた VM を右クリックし、**[再保護]** を選択します。
2. 保護の方向が、**[Azure からオンプレミスへ]** に設定されていることを確認します。
3. 再保護中は、データ一貫性を保証できるようにオンプレミス VM を無効にします。 再保護が完了した後で有効にしないでください。
4. 再保護プロセスの後で、VM は Azure からオンプレミス サイトへのレプリケートを開始します。



## <a name="fail-over-from-azure-and-reprotect-the-on-premises-vm"></a>Azure からフェールオーバーしてオンプレミス VM を再保護する

Azure からオンプレミス サイトにフェールオーバーし、オンプレミス サイトから Azure への VM のレプリケーションを開始します。

1. **[設定]** > **[レプリケートされたアイテム]** で、[VM] > **[計画されたフェールオーバー]** をクリックします。
2. **[計画されたフェールオーバーの確認]** で、フェールオーバーの方向 (Azure から) を確認し、ソースとターゲットの場所を選択します。
3. **[フェールオーバーの前にデータを同期する (差分変更のみを同期する)]** を選択します。 このオプションでは VM をシャットダウンせずに同期するため、VM のダウンタイムが最小限に抑えられます。
4. フェールオーバーを開始します。 フェールオーバーの進行状況は、 **[ジョブ]** タブで確認できます。
5. 初回のデータ同期が完了し、Azure VM をシャットダウンする準備ができた時点で、**[ジョブ]** > 計画されたフェールオーバーのジョブ名 > **[フェールオーバーの完了]** をクリックします。 これにより Azure VM がシャットダウンされ、最新の変更がオンプレミスに転送され、オンプレミスの VM が起動します。
6. オンプレミスの VM にログオンして、それが期待どおりに使用できることを確認します。
7. オンプレミスの VM は、この時点では **[コミット保留中]**の状態です。 **[コミット]** をクリックします。 これにより、Azure VM とそのディスクが削除され、オンプレミスの VM でレプリケーションの反転が準備されます。
オンプレミスの VM の Azure へのレプリケーションを開始するには、**[レプリケーションの反転]** を有効にします。 これにより、Azure VM をシャットダウンした後に発生した差分変更のレプリケーションが開始されます。  
