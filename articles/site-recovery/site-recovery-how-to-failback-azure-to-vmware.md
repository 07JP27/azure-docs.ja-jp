---
title: "Azure から Hyper-v にフェールバックする方法 | Microsoft Docs"
description: "VM を Azure にフェールオーバーした後に、フェールバックを開始して VM をオンプレミスに戻すことができます。 フェールバックする方法の手順について説明します。"
services: site-recovery
documentationcenter: 
author: ruturaj
manager: gauravd
editor: 
ms.assetid: 44813a48-c680-4581-a92e-cecc57cc3b1e
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: 
ms.date: 02/13/2017
ms.author: ruturajd
translationtype: Human Translation
ms.sourcegitcommit: bedb59414ed328fe2fcca2b09f3360a98c98ff60
ms.openlocfilehash: b4bdd27db343bfb4a0e47c432f726ff454f7f55a
ms.lasthandoff: 02/23/2017


---
# <a name="failback-from-azure-to-on-premises"></a>Azure からオンプレミスへのフェールバック
この記事では、Azure からオンプレミス サイトへ Azure Virtual Machines をフェールバックする方法について説明します。 この記事の手順は、[このチュートリアル](site-recovery-vmware-to-azure-classic.md)を使用して、VMware 仮想マシンまたは Windows/Linux 物理サーバーをオンプレミス サイトから Azure にフェールオーバーした後に、それらをフェールバックする準備ができたときに実行します。

## <a name="overview-of-failback"></a>フェールバックの概要
フェールバックの機構について説明します。オンプレミス サイトへのフェールバックは、Azure へのフェールオーバー後、いくつかの段階を経て行われます。

1. オンプレミス サイトで実行されている VMware VM へのレプリケートを開始できるように Azure VM を[再保護](site-recovery-how-to-reprotect.md)します。 このためには、以下も実行する必要があります。 
    1. オンプレミスのマスター ターゲットをセットアップする (Windows VM の場合は Windows MT、Linux VM の場合は [Linux MT](site-recovery-how-to-install-linux-master-target.md))
    2. [プロセス サーバー](site-recovery-vmware-setup-azure-ps-resource-manager.md)をセットアップする
    3. [再保護](site-recovery-how-to-reprotect.md)を開始する
5. Azure VM からオンプレミス サイトへのレプリケーションが開始されたら、Azure からオンプレミスへのフェールオーバーを開始します。
  
データがフェールバックされたら、フェールバック先のオンプレミスの VM を再保護します。これにより、オンプレミスの VM は Azure へのレプリケートを開始できるようになります。

こちらに概要を簡単に説明したビデオが用意してありますのでご覧ください。
> [!VIDEO https://channel9.msdn.com/Series/Azure-Site-Recovery/VMware-to-Azure-with-ASR-Video5-Failback-from-Azure-to-On-premises/player]

### <a name="failback-to-the-original-or-alternate-location"></a>元のまたは別の場所にフェールバックする
    
VMware VM をフェールオーバーした場合、オンプレミスにまだ存在する場合、同じソース VM にフェールバックできます。 このシナリオにおいてのみ、差分変更のみがレプリケートされます。 このシナリオは、元の場所の復旧と呼ばれます。 一方、オンプレミスの VM が存在しないときは "別の場所の復旧" と呼ばれます。

#### <a name="original-location-recovery"></a>元の場所の復旧

元の VM にフェールバックする場合、次の条件が必要です。
* vCenter サーバーで VM を管理する場合は、マスター ターゲットの ESX ホストが VM のデータストアにアクセスできる必要があります。
* VM が ESX ホスト上にあっても、vCenter によって管理されていない場合、VM のハード ディスクは MT のホストがアクセスできるデータストア内に存在する必要があります。
* VM が ESX ホスト上にあり vCenter を使用しない場合、再保護する前に、MT の ESX ホストの検出を完了する必要があります。 これは、物理サーバーにフェールバックする場合も同様です。
* vSAN または RDM ベースのディスクが既に存在していてオンプレミスの VM に接続されている場合は、それらのディスクにフェールバックすることができます。

#### <a name="alternate-location-recovery"></a>別の場所の復旧
VM を再保護する前にオンプレミスの VM が存在しない場合、これは別の場所の復旧と呼ばれます。 子の場合、再保護ワークフローによってオンプレミスの VM が再作成されます。 また、データはすべてダウンロードされます。

* 別の場所にフェールバックすると、VM は、マスター ターゲット サーバーがデプロイされたのと同じ ESX ホストに復元されます。 ディスクを作成するために使用したデータストアは、VM の再保護時に選択したのと同じデータストアになります。
* VMFS データストアにのみフェールバックできます。 vSAN または RDM がある場合、再保護とフェールバックは機能しません。
* 再保護するには、最初の大規模データ転送に続き、差分変更が行われる必要があります。 これは、VM がオンプレミスに存在しないため、完全なデータをレプリケートする必要があるからです。 また、この再保護は元の場所の復旧よりも時間がかかります。
* vSAN ベースのディスクや RDM ベースのディスクにフェールバックすることはできません。 新しい VMDK のみを VMFS データストアに作成することができます。

物理マシンは Azure にフェールオーバーした場合のみ、VMware 仮想マシンとしてフェールバックできます (P2A2V とも呼ばれます)。 このフローは、別の場所の復旧に該当します。

* Windows Server 2008 R2 SP1 マシンが保護されていて、Azure にフェールオーバーした場合、これをフェールバックすることはできません。
* 1 つ以上のマスター ターゲット サーバーと、フェールバック先として必要な ESX/ESXi ホストを必ず検出します。

## <a name="have-you-completed-reprotection"></a>先に再保護を実行しておく
仮想マシンのレプリケート状態を確保したうえでオンプレミスへのフェールバックを開始するために、再保護の操作は事前に行っておく必要があります。
詳しくは、[Azure からオンプレミスへの再保護の方法](site-recovery-how-to-reprotect.md)に関するページをご覧ください。

## <a name="pre-requisites"></a>前提条件
 
* フェールバックを実行するときは、構成サーバーがオンプレミスに存在している必要があります。 フェールバック時に仮想マシンが構成サーバー データベースに存在していないと、フェールバックは失敗します。 サーバーを定期的にバックアップするようスケジュールを設定してください。 万一障害が発生した場合は、フェールバックが正常に機能するように、同じ IP アドレスで復元する必要があります。
* マスター ターゲット サーバーには、フェールバックの開始前にスナップショットが一切存在していないことが必要です。

## <a name="steps-to-failback"></a>フェールバックする手順

フェールバックを開始する前に、**仮想マシンの再保護が完了していることを確認します**。 仮想マシンは、正常性が維持され、保護された状態になければなりません。 仮想マシンの再保護の詳細については、[再保護する方法](site-recovery-how-to-reprotect.md)に関する記事をご覧ください。

1. [レプリケートされたアイテム] ページで仮想マシンを選択し、右クリックして **[計画されていないフェールオーバー]**をクリックします。
2. **[フェールオーバーの確認]** で、フェールオーバーの方向 (Azure から) を確認し、フェールオーバーに使用する最新の復旧ポイント (最新のアプリケーション整合性ポイント) を選択します。 アプリケーション整合性ポイントは最新の時点よりも過去になるため、一部のデータが失われます。
3. フェールオーバー中に、Site Recovery によって Azure VM がシャット ダウンされます。 フェールバックが期待どおりに完了したことを確認したら、Azure VM がシャット ダウンされたこと確認します。

### <a name="to-what-recovery-point-can-i-failback-the-vms-to"></a>どの復旧ポイントまで VM をフェールバックできるか

VM (または復旧計画) をフェールバックする場合、2 つの選択肢があります。

"最後に処理が行われた時点" を選択した場合、すべての仮想マシンが、候補として考えられる最新の時点までフェールオーバーされます。 復旧計画内にレプリケーション グループが存在する場合は、レプリケーション グループの個々の VM が、それぞれの最新の時点までフェールオーバーされます。

復旧ポイントが&1; つは存在しないと VM をフェールバックできません。 復旧計画をフェールバックするためには、復旧計画に含まれるすべての VM に復旧ポイントが少なくとも&1; つ存在する必要があります。

> [!NOTE]
> 最新の復旧ポイントは、クラッシュ整合性の復旧ポイントです。

"アプリケーション整合性" の復旧ポイントを選択した場合は、1 回の VM フェールバックで、候補として考えられる最新のアプリケーション整合性復旧ポイントまで復元されます。 レプリケーション グループを含んだ復旧計画の場合、それぞれのレプリケーション グループが、その共通の復旧ポイントまで復元されます。
アプリケーション整合性の復旧ポイントは時間差を伴うことがあり、データの損失につながる場合があるので注意が必要です。

## <a name="next-steps"></a>次のステップ

フェールバックが完了したら、Azure に復旧された VM が確実に削除されるように、仮想マシンをコミットする必要があります。

### <a name="commit"></a>コミット
フェールオーバーされた仮想マシンを Azure から削除するには、コミットする必要があります。
保護された項目を右クリックし、[コミット] をクリックします。 Azure にフェールオーバーされた仮想マシンを削除するジョブがトリガーされます。

### <a name="reprotect-from-on-premises-to-azure"></a>オンプレミスから Azure への再保護

コミットが完了したら、VM はオンプレミス サイトに戻りますが、保護はされていません。 Azure に再度レプリケートを開始するには、次を実行します。

1. [コンテナー]、[設定]、[レプリケートされたアイテム] の順にクリックして、フェールバックされた VM を選択し、**[再保護]** をクリックします。
2. Azure にデータを送信する際に使用する必要があるプロセス サーバーの値を指定します。
3. [OK] をクリックすると、再保護ジョブが開始されます。

> [!NOTE]
> オンプレミスで VM が起動した後、エージェントが構成サーバーに再度登録されるまでにしばらく時間がかかります (最大 15 分)。 この間は再保護が失敗し、エージェントがインストールされていないというエラー メッセージが表示されます。 数分待ってから再保護操作をやり直してください。

再保護ジョブが完了すると、VM が Azure にレプリケートされるので、フェールオーバーを実行できます。

## <a name="common-issues"></a>一般的な問題
* フェールバックは、vCenter が接続状態になっていることを確認してから行ってください。接続状態になっていないと、ディスクを切断して再度 VM に接続するときにエラーが発生します。


