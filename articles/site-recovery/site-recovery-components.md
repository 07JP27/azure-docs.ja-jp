<properties
	pageTitle="Site Recovery のしくみ | Microsoft Azure"
	description="この記事では、Site Recovery アーキテクチャの概要を説明します"
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="get-started-article"
	ms.date="02/16/2016"
	ms.author="raynew"/>

# Azure Site Recovery のしくみ

この記事では、Site Recovery の基になるアーキテクチャと、それを機能させるためのコンポーネントについて説明します。この記事について質問がある場合は、[Azure Recovery Services フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)に投稿してください。

## 概要

組織には、予定されたダウンタイムおよび予定外のダウンタイム時にアプリケーション、ワークロード、およびデータを実行され利用可能な状態に維持し、できるだけ早く通常の動作状態に復旧させる方法を決定するビジネス継続性および障害復旧 (BCDR) の戦略が必要です。BCDR 戦略センターは、災害発生時にビジネス データを安全かつ回復可能な状態に維持し、ワークロードを継続的に利用可能な状態に保つために中心的な役割を果たすソリューションです。

Site Recovery とは、クラウド (Azure) またはセカンダリ データセンターへのオンプレミスの物理サーバーおよび仮想マシンのレプリケーションを統制することで BCDR 戦略を支援する Azure サービスです。プライマリの場所で障害が発生した場合は、セカンダリ サイトにフェールオーバーしてアプリとワークロードの可用性を維持します。プライマリの場所が通常の動作に戻ると、その場所にフェールバックします。

Site Recovery は、さまざまなシナリオで使用され、数多くのワークロードを保護することができます。

- **VMware 仮想マシンを保護する**: オンプレミス VMware 仮想マシンは、[Azure](site-recovery-vmware-to-azure-classic.md) または[セカンダリ データセンター](site-recovery-vmware-to-vmware.md)にレプリケートすることで保護できます。
- **Hyper-V VM を保護する**: VMM クラウド内のオンプレミス Hyper-V 仮想マシンは、[Azure](site-recovery-vmm-to-azure.md) または[セカンダリ データセンター](site-recovery-vmm-to-vmm.md)にレプリケートすることで保護できます。VMM で管理されていない Hyper-V VM を [Azure](site-recovery-hyper-v-site-to-azure.md) にレプリケートできます。
- **物理サーバーを Azure で保護する**: Windows または Linux を実行している物理マシンは、[Azure](site-recovery-vmware-to-azure-classic.md) または[セカンダリ データセンター](site-recovery-vmware-to-vmware.md)にレプリケートすることで保護することができます。
- **VM を移行する**: Site Recovery を使用すると、[Azure IaaS VM をリージョン間で移行](site-recovery-migrate-azure-to-azure.md)したり、[AWS Windows インスタンスを Azure IaaS VM に移行](site-recovery-migrate-aws-to-azure.md)したりできます。

Site Recovery は、これらの VM と物理サーバーで実行されているほとんどのアプリをレプリケートできます。サポートされるアプリの概要については、「[Azure Site Recovery で保護できるワークロード](site-recovery-workload.md)」を参照してください。


## オンプレミスの VMware 仮想マシンまたは物理サーバーを Azure にレプリケートする

VMware 仮想マシンまたは Windows/Linux 物理マシンのいずれかを Azure にレプリケートすることで保護するには、何が必要かを以下に示します。

このレプリケーション シナリオには、現在、2 つのアーキテクチャを使用できます。

- **レガシ アーキテクチャ**: このアーキテクチャは、新しいデプロイメントには使用しないでください。 
- **拡張アーキテクチャ**: 最新のソリューションです。すべての新しいデプロイメントにはこちらを使用してください。[レガシ アーキテクチャをこの新しいソリューションに移行](site-recovery-vmware-to-azure-classic-legacy.md#migrate-to-the-enhanced-deployment)することもできます。

拡張デプロイメントのアーキテクチャは次のとおりです。

![拡張](./media/site-recovery-components/arch-enhanced.png)

- **オンプレミス**: 拡張アーキテクチャをデプロイする場合、インフラストラクチャ VM を Azure にデプロイする必要はありません。また、すべてのトラフィックは暗号化され、レプリケーション管理の通信は HTTPS 443 経由で送信されます。オンプレミス インフラストラクチャに必要なものを次に示します。

	- **管理サーバー**: 次のようなすべての Site Recovery コンポーネントを実行する 1 つの管理サーバーです。

		- **構成サーバー**: オンプレミス環境と Azure 間の通信を調整し、データのレプリケーションと復旧のプロセスを管理します。
		- **プロセス サーバー**: レプリケーション ゲートウェイとして動作します。プロセス サーバーは保護されたソース マシンからデータを受信し、キャッシュ、圧縮、および暗号化を使用して最適化し、レプリケーション データを Azure Storage に送信します。また、保護されたマシンへのモビリティ サービスのプッシュ インストールを処理し、VMware VM の自動検出を実行します。デプロイメントの拡大に合わせて、プロセス サーバーとして、大量のレプリケーション トラフィックの処理のみを実行する専用サーバーを追加できます。
		- **マスター ターゲット サーバー**: Azure からのフェールバック中にレプリケーション データを処理します。 

	- **VMware ESX/ESXi ホストと vCenter サーバー**: VMware VM がある 1 つ以上の ESX/ESXi ホスト サーバー。これらのホストを管理する vCenter サーバーを用意することをお勧めします。ただし、物理サーバーを保護している場合でも、Azure からオンプレミス サイトにフェールバックするために VMware 環境が必要になります。
	
	- **保護されたマシン**: Azure にレプリケートする各マシンには、モビリティ サービス コンポーネントをインストールする必要があります。マシン上のデータの書き込みをキャプチャし、それをプロセス サーバーに転送します。このコンポーネントは、手動でインストールするか、マシンの保護を有効にするときにプロセスで自動的にプッシュしてインストールすることができます。

- **Azure**: Azure インフラストラクチャに必要なものを次に示します。
	- **Azure アカウント**: Microsoft Azure アカウントが必要です。
	- **Azure Storage**: レプリケートしたデータを格納するには Azure ストレージ アカウントが必要になります。レプリケートされたデータは Azure Storage に格納され、フェールオーバーが発生すると、Azure VM はスピンアップされます。 
	- **Azure ネットワーク**: フェールオーバーが発生した場合に Azure VM が接続する Azure 仮想ネットワークが必要です。また、Azure ネットワークからオンプレミス サイトへの VPN 接続 (または Azure ExpressRoute) も設定する必要があります。

	![拡張](./media/site-recovery-components/arch-enhanced2.png)

デプロイメントの要件の詳細については、[こちら](site-recovery-vmware-to-azure-classic.md#before-you-start-deployment)を参照してください。

### フェールバックのアーキテクチャ

- Azure からのフェールバック先は VMware VM にする必要があります。現在、物理サーバーにフェールバックすることはできません。
- フェールバックするには、Azure ネットワークからオンプレミス ネットワークへの VPN 接続 (または Azure ExpressRoute) が必要です。
- フェールバックするには、Azure にプロセス サーバーが必要です。フェールバックの完了後に削除できます。
- オンプレミスには、マスター ターゲット サーバーが必要です。オンプレミスで設定するときに、マスター ターゲット サーバーは既定で管理サーバーにインストールされます。ただし、トラフィックが大量の場合、フェールバックのためにオンプレミスに別のマスター ターゲット サーバーを設定することをお勧めします。

![拡張フェールバック](./media/site-recovery-components/enhanced-failback.png)

フェールバックの詳細については、[こちら](site-recovery-failback-azure-to-vmware-classic.md)を参照してください。

### レガシ アーキテクチャ

レガシ アーキテクチャの場合、保護対象のマシンにオンプレミスの構成サーバーとプロセス サーバー、VMware ESX/ESXi ホストと vCenter サーバー、モビリティ サービスがインストールされている必要があります。Azure では、構成サーバーとマスター ターゲット サーバー用に Azure VM を設定します。Azure サブスクリプション、ストレージ アカウント、仮想ネットワークも必要です。



## VMM クラウドの Hyper-V VM を Azure にレプリケートする

ご使用の VM が System Center VMM クラウドで管理されている Hyper-V ホストにある場合、そのような VM を Azure にレプリケートする上で必要なものを以下に示します。

- オンプレミス: 
	- **VMM サーバー**: 少なくとも 1 つの VMM プライベート クラウドに少なくとも 1 つの VMM サーバーを設定します。サーバーは、System Center 2012 R2 で実行されている必要があります。VMM サーバーは、インターネットに接続している必要があります。フェールオーバー後に確実に Azure VM をネットワークに接続する場合、ネットワーク マッピングを設定する必要があります。そのために、ソース VM を VMM VM ネットワークに接続する必要があります。そのネットワークは、クラウドに関連付けられた論理ネットワークにリンクされている必要があります。
	- **Hyper-V サーバー**: VMM クラウドに少なくとも 1 つの Hyper-V ホスト サーバーをデプロイします。Hyper-V ホストで Windows Server 2012 R2 が実行されている必要があります。
	- **保護されたマシン**: ソース Hyper-V ホスト サーバーは、保護対象の VM を少なくとも 1 つデプロイする必要があります。
	
- Azure:
	- **Azure アカウント**: Microsoft Azure アカウントが必要です。
	- **Azure Storage**: レプリケートしたデータを格納するには Azure ストレージ アカウントが必要になります。レプリケートされたデータは Azure Storage に格納され、フェールオーバーが発生すると、Azure VM はスピンアップされます。
	- **Azure ネットワーク**: フェールオーバー後に確実に Azure VM をネットワークに接続する場合、ネットワーク マッピングを設定する必要があります。この処理には、Azure ネットワークを設定する必要があります。

	![VMM から Azure](./media/site-recovery-components/arch-onprem-onprem-azure-vmm.png)

このシナリオでは、Site Recovery のデプロイ時に Azure Site Recovery Provider が VMM サーバーにインストールされています。Azure Site Recovery Provider は、インターネット経由で Site Recovery サービスを使用してレプリケーションを調整および統制します。Azure Recovery Services エージェントは、Site Recovery のデプロイ時に Hyper-V ホスト サーバーにインストールされ、データは HTTPS 443 で Azure Storage との間でレプリケートされます。プロバイダーとエージェントの両方からの通信は、セキュリティで保護され、暗号化されます。Azure Storage 内のレプリケートされたデータも暗号化されます。

デプロイメントの要件の詳細については、[こちら](site-recovery-vmm-to-azure.md#before-you-start)を参照してください。

## Hyper-V VM を Azure にレプリケートする (VMM なし)

ご使用の VM が System Center VMM サーバーによって管理されていない場合、それらを Azure にレプリケートするのに必要なものを以下に示します。

- オンプレミス: 
	- **Hyper-V サーバー**: 少なくとも 1 つの Hyper-V ホスト サーバー。Hyper-V ホストで Windows Server 2012 R2 が実行されている必要があります。
	- **保護されたマシン**: ソース Hyper-V ホスト サーバーは、保護対象の VM を少なくとも 1 つデプロイする必要があります。
	
- Azure:
	- **Azure アカウント**: Microsoft Azure アカウントが必要です。
	- **Azure Storage**: レプリケートしたデータを格納するには Azure ストレージ アカウントが必要になります。レプリケートされたデータは Azure Storage に格納され、フェールオーバーが発生すると、Azure VM はスピンアップされます。

	![Hyper-V サイトから Azure](./media/site-recovery-components/arch-onprem-azure-hypervsite.png)

このシナリオでは、Site Recovery デプロイ時に Azure Site Recovery Provider と Azure Recovery Services エージェントがインストールされています。Provider は、インターネット経由で Site Recovery サービスを使用してレプリケーションを調整および統制します。エージェントは、HTTPS 443 でデータ レプリケーション データを処理します。プロバイダーとエージェントの両方からの通信は、セキュリティで保護され、暗号化されます。Azure Storage 内のレプリケートされたデータも暗号化されます。

デプロイメントの要件の詳細については、[こちら](site-recovery-hyper-v-site-to-azure.md#before-you-start)を参照してください

## Hyper-V VM をセカンダリ データセンターにレプリケートする

Hyper-V VM を保護するためにセカンダリ データセンターにレプリケートする場合に必要なものを以下に示します。このレプリケーションを実行できるのは、Hyper-V ホスト サーバーが System Center VMM クラウドで管理されている場合に限られます。

- **オンプレミス**: 
	- **VMM サーバー**: プライマリ サイトとセカンダリ サイトにそれぞれ VMM サーバーをデプロイし、それぞれに少なくとも 1 つの VMM プライベート クラウドを含めることをお勧めします。サーバーは、最新の更新プログラムがインストールされた System Center 2012 SP1 以降を実行し、インターネットに接続している必要があります。クラウドには、Hyper-V 機能プロファイルが設定されている必要があります。
	- **Hyper-V サーバー**: プライマリおよびセカンダリ VMM クラウドにある Hyper-V ホスト サーバー。ホスト サーバーは、最新の更新プログラムがインストールされた Windows Server 2012 以降を実行し、インターネットに接続している必要があります。
	- **保護されたマシン**: ソース Hyper-V ホスト サーバーは、保護対象の VM を少なくとも 1 つデプロイする必要があります。
	
- **Azure**: Azure サブスクリプションが必要です。

	![オンプレミス間](./media/site-recovery-components/arch-onprem-onprem.png)

このシナリオでは、Azure Site Recovery Provider が Site Recovery のデプロイ時に VMM サーバーにインストールされています。Azure Site Recovery Provider は、インターネット経由で Site Recovery サービスを使用してレプリケーションを調整および統制します。オンプレミスの Hyper-V ホスト サーバーとセカンダリ Hyper-V ホスト サーバーとの間で Kerberos または証明書認証を使用して LAN または VPN 経由で、データがレプリケートされます。プロバイダーからの通信と Hyper-V ホスト サーバー間の通信は、セキュリティで保護され、暗号化されます。

デプロイメントの要件の詳細については、[こちら](site-recovery-vmm-to-vmm.md#before-you-start)を参照してください



## SAN を使用して Hyper-V VM をセカンダリ データセンターにレプリケートする

ご使用の VM が System Center VMM クラウドで管理されている Hyper-V ホストにあり、SAN ストレージが使用されている場合、2 つのデータセンター間でレプリケートするのに必要なものを以下に示します。

- **オンプレミス**: 
	- **SAN アレイ**: プライマリ VMM サーバーで管理されている[サポートされた SAN アレイ](http://social.technet.microsoft.com/wiki/contents/articles/28317.deploying-azure-site-recovery-with-vmm-and-san-supported-storage-arrays.aspx)。SAN は、セカンダリ サイトの別の SAN アレイとネットワーク インフラストラクチャを共有します。
	- **VMM サーバー**: プライマリ サイトとセカンダリ サイトにそれぞれ VMM サーバーをデプロイし、それぞれに少なくとも 1 つの VMM プライベート クラウドを含めることをお勧めします。サーバーは、最新の更新プログラムがインストールされた System Center 2012 SP1 以降を実行し、インターネットに接続している必要があります。クラウドには、Hyper-V 機能プロファイルが設定されている必要があります。
	- **Hyper-V サーバー**: プライマリおよびセカンダリ VMM クラウドにある Hyper-V ホスト サーバー。ホスト サーバーは、最新の更新プログラムがインストールされた Windows Server 2012 以降を実行し、インターネットに接続している必要があります。
	- **保護されたマシン**: ソース Hyper-V ホスト サーバーは、保護対象の VM を少なくとも 1 つデプロイする必要があります。
	
- **Azure**: Azure サブスクリプションが必要です。

	![SAN レプリケーション](./media/site-recovery-components/arch-onprem-onprem-san.png)

このシナリオでは、Azure Site Recovery Provider が Site Recovery のデプロイ時に VMM サーバーにインストールされています。Azure Site Recovery Provider は、インターネット経由で Site Recovery サービスを使用してレプリケーションを調整および統制します。プライマリ ストレージ アレイとセカンダリ ストレージ アレイとの間で同期 SAN レプリケーションによって、データがレプリケートされます。

デプロイメントの要件の詳細については、[こちら](site-recovery-vmm-san.md#before-you-start)を参照してください


## VMware 仮想マシンまたは物理サーバーをセカンダリ サイトにレプリケートする

VMware 仮想マシンまたは Windows/Linux 物理マシンのいずれかを、2 つのオンプレミスのデータセンター間でレプリケートして保護するには、何が必要かを以下に示します。

- **オンプレミスのプライマリ**: 
	- **プロセス サーバー**: キャッシュ、圧縮、およびデータの最適化を処理できるように、プライマリ サイトでプロセス サーバーのコンポーネントをセットアップします。プロセス サーバーでは、保護するマシンへの統合エージェントのプッシュ インストールも処理します。
	- **VMware ESX/ESXi および vCenter サーバー**: VMware VM を保護する場合、VMware EXS/ESXi ハイパーバイザーまたは複数のハイパーバイザーを管理する VMware vCenter サーバーが必要です。
	- 保護されたマシン: 保護対象の VMware VM または Windows/Linux 物理サーバーには、Unified Agent がインストールされている必要があります。Unified Agent は、マスター ターゲット サーバーとして動作するマシンにもインストールされます。すべての InMage コンポーネント間の通信プロバイダーとして機能します。
	
- **オンプレミスのセカンダリ**:
	- **構成サーバー**: 構成サーバーは最初にインストールするコンポーネントです。管理 Web サイトまたは vContinuum コンソールのどちらかを使用してデプロイメントを管理、構成、および監視できるようにセカンダリ サイトにインストールします。構成サーバーには、統合エージェントのリモート デプロイメントのためのプッシュ メカニズムも含まれています。デプロイメントに含まれる構成サーバーが 1 つのみなので、Windows Server 2012 R2 を実行するマシンにインストールする必要があります。
	- **vContinuum サーバー**: 構成サーバーと同じ場所 (セカンダリ サイト) にインストールされます。保護対象の環境を管理および監視するためのコンソールを提供します。既定のインストールでは、vContinuum サーバーは最初のマスター ターゲット サーバーであり、統合エージェントがインストールされます。
	- **マスター ターゲット サーバー**: マスター ターゲット サーバーは、レプリケートされたデータを保持します。プロセス サーバーからデータを受信して、セカンダリ サイトにレプリカ マシンを作成し、データの保有期間ポイントを保持します。必要のあるマスター ターゲット サーバーの数は、保護するマシンの数によって異なります。プライマリ サイトにフェールバックする場合は、そこにもマスター ターゲット サーバーが必要です。 

- **Azure**: Azure サブスクリプションが必要です。Site Recovery コンテナーを作成した後でデプロイメントをセットアップする InMage Scout をダウンロードします。また、すべての InMage コンポーネント サーバーに対して最新の更新プログラムをインストールします。


	![VMware から VMware](./media/site-recovery-components/vmware-to-vmware.png)

このシナリオでは、保護対象のマシン上で実行されている統合エージェントからプロセス サーバーに差分レプリケーション変更が送信されます。プロセス サーバーは、このデータを最適化し、セカンダリ サイト上のマスター ターゲット サーバーに転送します。構成サーバーでは、レプリケーション プロセスを管理します。


## Hyper-V 保護のライフ サイクル

次のワークフローでは、Hyper-V 仮想マシンを保護、レプリケート、およびフェールオーバーするプロセスを示します。

1. **保護の有効化**: Site Recovery コンテナーをセットアップし、VMM クラウドまたは Hyper-V サイトのレプリケーション設定を構成し、VM の保護を有効にします。**保護の有効化**と呼ばれるジョブは、開始されると、**[ジョブ]** タブで監視することができます。このジョブはまずマシンが前提条件を満たしていることを確認します。次に、構成された設定を使用して Azure へのレプリケーションをセットアップする [CreateReplicationRelationship](https://msdn.microsoft.com/library/hh850036.aspx) メソッドを呼び出します。**保護の有効化**ジョブはまた、[StartReplication](https://msdn.microsoft.com/library/hh850303.aspx) メソッドを呼び出して、完全な VM レプリケーションを初期化します。
2. **初期レプリケーション**: 仮想マシンのスナップショットが取得され、仮想ハード ディスクが、Azure またはセカンダリ データセンターにすべてコピーされるまで、1 つずつレプリケートされます。この所要時間は、サイズおよびネットワーク帯域幅と、選択した初期レプリケーション方法によって異なります。初期レプリケーションの進行中にディスクの変更が発生した場合、Hyper-V レプリカ レプリケーション トラッカーは、Hyper-V レプリケーション ログ (.hrl) を該当するディスクと同じフォルダーに配置して、それらの変更を追跡します。各ディスクには関連付けられた .hrl ファイルが存在し、これらはセカンダリ ストレージに送信されます。初期レプリケーションの進行中は、スナップショットおよびログ ファイルによってディスク リソースが消費されるので注意してください。初期レプリケーションが終了すると、VM のスナップショットは削除され、ログ内の差分ディスク変更が同期およびマージされます。
3. **保護の最終処理**: 初期レプリケーションが終了すると、**保護の最終処理**ジョブによってネットワークおよびその他のレプリケーション後の設定が構成され、仮想マシンが保護されます。Azure にレプリケートする場合は、仮想マシンの設定を微調整して、いつでもフェールオーバーできるようにしておくことが必要なことがあります。この時点で、テスト フェールオーバーを実行して、すべてが想定通りに動作しているか確認できます。
4. **レプリケーション**: 初期レプリケーション後は、レプリケーションの設定および方法に従って差分の同期が実行されます。 
	- **レプリケーションの失敗**: 差分レプリケーションに失敗した場合、完全なレプリケーションが帯域幅または時間の観点からコスト高になるときは、再同期が実行されます。たとえば、.hrl ファイルがディスク サイズの 50% に達した場合、仮想マシンには再同期のマークが付けられます。再同期では、ソースとターゲットの仮想マシンのチェックサムを計算して差分のみを送信することで、送信されるデータの量が最小限に抑えられます。再同期が完了すると、差分レプリケーションが再開されます。既定では再同期は業務時間外に自動的に実行するようにスケジュールされますが、手動で仮想マシンを再同期することもできます。
	- **レプリケーション エラー**: レプリケーション エラーが発生した場合に備えて、組み込み再試行があります。認証または承認エラーなど回復できないエラーである場合、またはレプリカ マシンが無効な状態にある場合、再試行は行われません。ネットワーク エラーなどの回復可能なエラーの場合、またはディスクの空き領域またはメモリが少ない場合は、再試行が実行されます。回数を重ねるごとに再試行間隔は長くなります (1、2、4、8、10 分と長くなり、その後は 30 分ごとに行われる)。
4. **予定されたフェールオーバーまたは予定外のフェールオーバー**: 必要に応じて、予定されたフェールオーバーまたは予定外のフェールオーバーを実行します。予定されたフェールオーバーを実行する場合、データが決して失われないように、ソース側の VM はシャット ダウンされます。レプリカ VM は、作成後、コミット保留中の状態になります。SAN を使用してレプリケートする場合 (自動的にコミットされる) を除き、レプリカ VM をコミットしてフェールオーバーを完了させる必要があります。プライマリ サイトが起動され稼働状態になると、フェールバックが実行される可能性があります。Azure にレプリケートした場合、レプリケーションの反転は自動的に行われます。それ以外の場合は、レプリケーションの反転を開始してください。
 

![ワークフロー](./media/site-recovery-components/arch-hyperv-azure-workflow.png)

## 次のステップ

[デプロイの準備をする](site-recovery-best-practices.md)。

<!---HONumber=AcomDC_0218_2016-->