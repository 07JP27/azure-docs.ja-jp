<properties
	pageTitle="Site Recovery でのフェールオーバー" 
	description="Azure Site Recovery は、仮想マシンと物理サーバーのレプリケーション、フェールオーバー、回復を調整します。Azure またはセカンダリ データセンターへのフェールオーバーについて説明します。" 
	services="site-recovery" 
	documentationCenter="" 
	authors="rayne-wiselman" 
	manager="jwhit" 
	editor=""/>

<tags 
	ms.service="site-recovery" 
	ms.devlang="na"
	ms.topic="article"
	ms.tgt_pltfrm="na"
	ms.workload="storage-backup-recovery" 
	ms.date="08/05/2015" 
	ms.author="raynew"/>

# Site Recovery でのフェールオーバー

[Azure Site Recovery サービス](site-recovery-overview.md)は、Azure またはオンプレミスのセカンダリ データセンターへのレプリケーションとフェールオーバーを調整および自動化することにより、オンプレミスの物理サーバーおよび仮想マシンを保護する、堅牢なビジネス継続性と災害復旧 (BCDR) ソリューションを構築するのに役立ちます。この記事は、Site Recovery を使用して保護されている仮想マシンと物理サーバーを復旧するプロセス (フェールオーバーおよびフェールバック) に関する情報とその手順を示しています。

この記事の内容について質問がある場合は、[Azure Recovery Services フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)に投稿してください。


## 概要

仮想マシンと物理サーバーに対して保護を設定すると、セカンダリの場所へのレプリケーションが開始されます。レプリケーションが稼働状態になると、必要に応じてフェールオーバーを実行することができます。Site Recovery は、さまざまな種類のフェールオーバーをサポートします。

**フェールオーバー** | **実行する状況** | **詳細** | **プロセス**
---|---|---|---
**テスト フェールオーバー** | レプリケーション戦略を検証するか、または障害復旧の訓練を行うために実行します。 | <p>データの損失やダウンタイムはありません。</p><p>レプリケーションに影響はありません。</p><p>運用環境への影響はありません。</p> | <p>フェールオーバーを開始します。</p><p>フェールオーバー後にテスト マシンをネットワークに接続する方法を指定します。</p><p>**[ジョブ]** タブで進行状況を追跡します。セカンダリの場所でテスト マシンが作成され、起動します。</p><p>Azure - Azure ポータルのマシンに接続します。</p><p>セカンダリ サイト - 同じホスト上の同じクラウド内のマシンにアクセスします。</p><p>テストを完了し、テスト フェールオーバーの設定を自動的にクリーンアップします。</p>
**計画されたフェールオーバー** | <p>コンプライアンス要件を満たすために実行します。</p><p>計画的なメンテナンスに対して実行します。</p><p>既知の障害 (予想される電源障害や悪天候の予報など) に対してワークロードを継続して実行できるように、必要なデータをフェールオーバーするために実行します。</p><p>プライマリからセカンダリへのフェールオーバー後にフェールバックするために実行します。 | <p>データの損失はありません。</p><p>ダウンタイムは、仮想マシンをプライマリの場所でシャットダウンし、セカンダリの場所で起動するまでの間に発生します。</p><p>仮想マシンは、フェールオーバー後にターゲット マシンがソース マシンになるために影響を受けます。</p> | <p>フェールオーバーを開始します。</p><p>**[ジョブ]** タブで進行状況を追跡します。ソース マシンはシャットダウンされます。</p><p>レプリカのマシンがセカンダリの場所で起動します。</p><p>Azure - Azure ポータルのレプリカ マシンに接続します。</p><p>セカンダリ サイト - 同じホスト上の同じクラウド内のマシンにアクセスします。</p><p>フェールオーバーをコミットします。</p>
**計画されていないフェールオーバー** | <p>停電やウイルスの攻撃などの予期しないインシデントが原因で、プライマリ サイトにアクセスできなくなったときに、この事後対応方式のフェールオーバーを実行します。</p><p>プライマリ サイトが利用できない場合でも、計画されていないフェールオーバーは実行できます。<p> | <p>レプリケーション頻度の設定に応じてデータの損失が発生します。</p><p>データは前回の同期時点に合わせて最新状態になります。</p> | <p>フェールオーバーを開始します。</p><p>**[ジョブ]** タブで進行状況を追跡します。必要に応じて、仮想マシンのシャットダウンと、最新データとの同期を試行します。</p><p>レプリカのマシンがセカンダリの場所で起動します。</p><p>Azure - Azure ポータルのレプリカ マシンに接続します。</p><p>セカンダリ サイト - 同じホスト上の同じクラウド内のマシンにアクセスします。</p><p>フェールオーバーをコミットします。</p>


サポートされるフェールオーバーの種類は、デプロイ シナリオに応じて異なります。

**フェールオーバーの方向** | **テスト フェールオーバー** | **計画されたフェールオーバー** | **計画されていないフェールオーバー**
---|---|---|---
プライマリ VMM サイトからセカンダリ VMM サイト | サポートされています | サポートされています | サポートされています 
セカンダリ VMM サイトからプライマリ VMM サイト | サポートされています | サポートされています | サポートされています
クラウド間 (単一の VMM サーバー) | サポートされています | サポートされています | サポートされています
VMM サイトから Azure | サポートされています | サポートされています | サポートされています 
Azure から VMM サイト | サポートされていません | サポートされています | サポートされていません 
Hyper-V サイトから Azure | サポートされています | サポートされています | サポートされています
Azure から Hyper-V サイト | サポートされていません | サポートされています | サポートされていません
VMware サイトから Azure | サポートされていません |このシナリオでは連続レプリケーションを使用するため、計画されたフェールオーバーと計画されていないフェールオーバーの間に違いはありません。**[フェールオーバー]** を選択します。 | 該当なし
物理サーバーから Azure | サポートされていません | このシナリオでは連続レプリケーションを使用するため、計画されたフェールオーバーと計画されていないフェールオーバーの間に違いはありません。**[フェールオーバー]** を選択します。 | 該当なし

## フェールオーバーとフェールバック

デプロイの種類に応じて、仮想マシンをセカンダリ オンプレミス サイトまたは Azure にフェールオーバーします。Azure にフェールオーバーするマシンは、Azure 仮想マシンとして作成されます。フェールオーバーできるのは、単一の仮想マシン、単一の物理サーバー、または復旧計画です。復旧計画は、保護対象の仮想マシンまたは物理サーバーを含む、順序のある 1 つ以上のグループで構成されます。復旧計画は、所属するグループに従ってフェールオーバーする複数のマシンのフェールオーバーを調整するために使用されます。復旧計画については、[こちら](site-recovery-create-recovery-plans.md)を参照してください。

フェールオーバーが完了し、マシンがセカンダリの場所で稼働している場合は、次のことに注意してください。

- Azure にフェールオーバーした場合は、フェールオーバー後に、プライマリまたはセカンダリの場所でマシンは保護されたりレプリケートされたりしません。Azure では、仮想マシンは、回復性は提供してもレプリケートされない、geo レプリケートされたストレージに格納されます。
- セカンダリ サイトへの計画されていないフェールオーバーを実行した場合、フェールオーバー後に、セカンダリの場所のマシンは保護されたりレプリケートされたりしません。
- セカンダリ サイトへの計画されたフェールオーバーを実行した場合、フェールオーバー後に、セカンダリの場所のマシンは保護されます。
 

### セカンダリ サイトからのフェールバック

セカンダリ サイトからプライマリ サイトへのフェールバックは、プライマリからセカンダリへのフェールオーバーと同じプロセスを使用します。プライマリからセカンダリのデータセンターへのフェールオーバーがコミットされて完了した後は、プライマリ サイトが使用可能になったときに、レプリケーションの反転を開始することができます。レプリケーションの反転は、差分データを同期することによって、セカンダリ サイトとプライマリ サイトの間のレプリケーションを開始します。レプリケーションの反転により、仮想マシンは保護された状態になりますが、セカンダリ データセンターは引き続きアクティブな場所です。プライマリ サイトをアクティブな場所にするには、セカンダリからプライマリへの計画されたフェールオーバーを開始し、続いて別のレプリケーションの反転を実行します。

### Azure からのフェールバック

Azure にフェールオーバーした場合、仮想マシンは、仮想マシンのための Azure 回復性機能によって保護されます。元のプライマリ サイトをアクティブな場所にするには、計画されたフェールオーバーを実行します。元の場所にフェールバックすることも、元のサイトが利用できない場合には別の場所にフェールバックすることもできます。プライマリの場所へのフェールバック後にレプリケートを再び開始するには、レプリケーションの反転を開始します。

### フェールオーバーの考慮事項

- **フェールオーバー後の IP アドレス** — 既定では、フェールオーバー先のマシンは、ソース マシンとは異なる IP アドレスを持ちます。同じ IP アドレスを保持する場合は、次の説明を参照してください。 
	- **セカンダリ サイト** — セカンダリ サイトにフェールオーバーし、IP アドレスを保持する場合は、[こちらの記事](http://blogs.technet.com/b/scvmm/archive/2014/04/04/retaining-ip-address-after-failover-using-hyper-v-recovery-manager.aspx)を参照してください。ISP がサポートする場合は、パブリック IP アドレスを保持できることに注意してください。
	- **Azure** — Azure にフェールオーバーする場合は、仮想マシンのプロパティの **[構成]** タブで、割り当てる IP アドレスを指定することができます。Azure へのフェールオーバー後にパブリック IP アドレスを保持することはできません。内部アドレスとして使用されている RFC 1918 非準拠のアドレス空間は保持することができます。
- **部分的なフェールオーバー** — サイトの全体ではなく、サイトの一部をフェールオーバーする場合には、次の点に注意してください。 
	- **セカンダリ サイト** — セカンダリ サイトにプライマリ サイトの一部をフェールオーバーし、プライマリ サイトに再び接続する場合、セカンダリ サイト上のフェールオーバー先のアプリケーションを、サイト間 VPN 接続を使用して、プライマリ サイト上で実行するインフラストラクチャ コンポーネントに接続します。サブネット全体をフェールオーバーする場合は、仮想マシンの IP アドレスを保持できます。部分的なサブネットをフェールオーバーする場合は、サブネットはサイト間で分割できないので、仮想マシンの IP アドレスを保持することはできません。
	- **Azure** — Azure にサイトの一部をフェールオーバーし、プライマリ サイトに再び接続する場合、サイト間 VPN を使用して、Azure 内のフェールオーバー先のアプリケーションを、プライマリ サイト上で実行するインフラストラクチャ コンポーネントに接続することができます。サブネット全体をフェールオーバーする場合は、仮想マシンの IP アドレスを保持できることに注意してください。部分的なサブネットをフェールオーバーする場合は、サブネットはサイト間で分割できないので、仮想マシンの IP アドレスを保持することはできません。
 
- **ドライブ文字** — フェールオーバー後に仮想マシンのドライブ文字を保持する場合は、仮想マシンの SAN のポリシーを **[On]** に設定することができます。仮想マシンのディスクは自動的にオンラインになります。詳細については、[こちら](https://technet.microsoft.com/library/gg252636.aspx)を参照してください。
- **クライアント要求をルーティングする** — Site Recovery は、Azure Traffic Manager と連携して、フェールオーバー後にクライアント要求をアプリケーションにルーティングします。




## テスト フェールオーバーの実行

テスト フェールオーバーの実行時には、テスト レプリカ マシン用のネットワーク設定を選択することが求められます。これには多数のオプションがあります。

**テスト フェールオーバーのオプション** | **説明** | **フェールオーバーの確認** | **詳細**
---|---|---|---
**Azure へのフェールオーバー — ネットワークなし** | ターゲットの Azure ネットワークを選択しません。 | フェールオーバーでは、Azure で想定どおりにテスト仮想マシンが起動していることが確認されます。 | <p>復旧計画内のすべてのテスト仮想マシンは、単一のクラウド サービス内に追加され、相互に接続できます。</p><p>フェールオーバー後には、マシンは Azure ネットワークに接続されません。</p><p>ユーザーはパブリック IP アドレスを使用してテスト マシンに接続できます。</p>
**Azure へのフェールオーバー — ネットワークあり** | ターゲットの Azure ネットワークを選択します。 | フェールオーバーでは、テスト マシンがネットワークに接続されていることが確認されます。 | <p>Azure 運用ネットワークから分離されている Azure ネットワークを作成し、レプリケートされた仮想マシンが想定どおりに動作するようにインフラストラクチャを設定します。</p><p>テスト仮想マシンのサブネットは、計画されたまたは計画されていないフェールオーバーが行われる場合に、フェールオーバー先の仮想マシンの接続先となることが予想されるサブネットをベースとします。</p>
**セカンダリ VMM サイトへのフェールオーバー — ネットワークなし** | VM ネットワークを選択しません。 | フェールオーバーでは、テスト マシンが作成されることが確認されます。<p>レプリカ仮想マシンが存在するホストと同じホスト上に、テスト仮想マシンが作成されます。レプリカ仮想マシンが配置されているクラウドには追加されません。</p></p>| <p>フェールオーバー先のマシンはどのネットワークにも接続されません。</p><p>作成された後、マシンは VM ネットワークに接続することができます。</p>
**セカンダリ VMM サイトへのフェールオーバー — ネットワークあり** | 既存の VM ネットワークを選択します。 | フェールオーバーでは、仮想マシンが作成されることが確認されます。 | <p>レプリカ仮想マシンが存在するホストと同じホスト上に、テスト仮想マシンが作成されます。レプリカ仮想マシンが配置されているクラウドには追加されません。</p><p>運用ネットワークから分離されている VM ネットワークを作成します。</p><p>この目的のために、VLAN ベースのネットワークを使用している場合には、VMM 内に (運用環境では使用されない) 独立した論理ネットワークを作成することをお勧めします。この論理ネットワークは、テスト フェールオーバーを目的として、VM ネットワークの作成に使用します。</p><p>論理ネットワークは、仮想マシンをホストしているすべての Hyper-V サーバーのネットワーク アダプターの少なくとも 1 つと関連付ける必要があります。</p><p>VLAN 論理ネットワークの場合、論理ネットワークに追加するネットワーク サイトは分離されている必要があります。</p><p>Windows ネットワーク仮想化ベースの論理ネットワークを使用している場合、Azure Site Recovery は分離された VM ネットワークを自動的に作成します。</p>
**セカンダリ VMM サイトへのフェールオーバー — ネットワークの作成** | 一時的なテスト ネットワークは、**論理ネットワーク**とそれに関連するネットワーク サイトで指定した設定に基づいて、自動的に作成されます。 | フェールオーバーでは、仮想マシンが作成されることが確認されます。 | <p>このオプションは、復旧計画で複数の VM ネットワークを使用する場合に使用します。Windows ネットワーク仮想化ネットワークを使用する場合には、このオプションにより、レプリカ仮想マシンのネットワーク内に同じ設定 (サブネットおよび IP アドレス プール) を持つ VM ネットワークを自動的に作成できます。テスト フェールオーバーが完了すると、これらの VM ネットワークは自動的にクリーンアップされます。</p><p>レプリカ仮想マシンが存在するホストと同じホスト上に、テスト仮想マシンが作成されます。レプリカ仮想マシンが配置されているクラウドには追加されません。</p>

以下の点に注意してください。

- セカンダリ サイトにレプリケートする場合、レプリカ マシンにより使用されるネットワークの種類は、テスト フェールオーバーに使用される論理ネットワークの種類と必ずしも一致している必要はありません。ただし、組み合わせによっては動作しない可能性があります。レプリカが DHCP と VLAN ベースの分離を使用する場合、レプリカの VM ネットワークには、静的 IP アドレス プールは必要ありません。このため、Windows ネットワーク仮想化を使用してテスト フェールオーバーを実行しようとすると、使用できるアドレス プールがないため失敗します。さらに、レプリカ ネットワークが分離なしであり、テスト ネットワークが Windows ネットワーク仮想化の場合、テスト フェールオーバーは失敗します。これは、分離なしのネットワークには、Windows ネットワーク仮想化ネットワークの作成に必要なサブネットがないためです。
- フェールオーバー後にマップされた VM ネットワークにレプリカ仮想マシンが接続される方法は、VMM コンソールでの VM ネットワークの構成方法によって異なります。
	- **分離なしまたは VLAN 分離で構成された VM ネットワーク** — VM ネットワークに DHCP が定義されている場合、レプリカ仮想マシンは、関連する論理ネットワーク内のネットワーク サイトに指定されている設定を使用して、VLAN ID に接続されます。仮想マシンは、使用可能は DHCP サーバーから IP アドレスを受け取ります。ターゲットの VM ネットワークに対して静的 IP アドレス プールを定義する必要はありません。VM ネットワークに静的 IP アドレス プールが使用されている場合、レプリカ仮想マシンは、関連する論理ネットワーク内のネットワーク サイトに指定されている設定を使用して、VLAN ID に接続されます。仮想マシンは、VM ネットワークに定義されているプールから IP アドレスを受け取ります。静的 IP アドレス プールがターゲット VM ネットワーク上で定義されていない場合、IP アドレスの割り当ては失敗します。IP アドレス プールは、保護と復旧に使用するソースとターゲットの両方の VMM サーバー上で作成する必要があります。
	- **Windows ネットワーク仮想化を使用する VM ネットワーク** — VM ネットワークがこの設定で構成されている場合、ソース VM ネットワークが DHCP または静的 IP アドレス プールを使用するように構成されているかどうかにかかわりなく、ターゲット VM ネットワークに対して静的プールを定義する必要があります。DHCP を定義する場合、ターゲット VMM サーバーは、DHCP サーバーとして機能し、ターゲット VM ネットワークに対して定義されているプールから IP アドレスを提供します。ソース サーバーに静的 IP アドレス プールの使用が定義されている場合、ターゲット VMM サーバーは、プールから IP アドレスを割り当てます。どちらの場合も、静的 IP アドレス プールが定義されていないと、IP アドレスの割り当ては失敗します。




### オンプレミスから Azure へのテスト フェールオーバーの実行

この手順では、復旧計画のテスト フェールオーバーを実行する方法について説明します。別の方法として、**[仮想マシン]** タブで、単一マシンに対するフェールオーバーを実行することもできます。

1. **[復旧計画]** > *[recoveryplan\_name]* を選択します。**[フェールオーバー]** > **[テスト フェールオーバー]** をクリックします。
2. **[テスト フェールオーバーの確認]** ページで、フェールオーバー後にレプリカ マシンを Azure ネットワークに接続する方法を指定します。
3. Azure にフェールオーバーし、クラウドのデータ暗号化が有効になっている場合には、**[暗号化キー]** で、プロバイダーのインストール中にデータ暗号化を有効にしたときに発行された証明書を選択します。 
4. **[ジョブ]** タブで、フェールオーバーの進行状況を追跡します。テスト レプリカ マシンも Azure ポータルで確認できます。
5. Azure のレプリカ マシンには、オンプレミス サイトから仮想マシンへの RDP 接続を開始することでアクセスできます。仮想マシンのエンドポイントで、ポート 3389 を開いておく必要があります。
5. 手順を実行し、フェールオーバーが**テストの完了**フェーズに達したら、**[テストの完了]** をクリックして終了します。
5. **[メモ]** を使用して、テスト フェールオーバーに関連する観察結果をすべて記録し、保存します。
8. **[テスト フェールオーバーが完了しました]** をクリックすると、テスト環境は自動的にクリーンアップされます。これが完了したら、テスト フェールオーバーは C (完了) 状態と表示されます。

> [AZURE.NOTE]テスト フェールオーバーが 2 週間を超えても続行する場合は、強制的に終了されます。テスト フェールオーバー中に自動的に作成されたすべての要素または仮想マシンは削除されます。
  
#### 例

次の手順に従って、サンプルのテスト フェールオーバーを実行します。

1. オンプレミスの仮想マシンのテスト フェールオーバーで使用するものと同じネットワークで、Active Directory 仮想マシンと DNS 仮想マシンのテスト フェールオーバーを実行します。
2. これらのフェールオーバーされるマシンに割り当てられている IP アドレスを書き留めます。
3. テスト フェールオーバーで使用する Azure Virtual Network に、DNS サーバーと Active Directory サーバーのアドレスとして、書き留めた IP アドレスを追加します。
4. Azure ネットワークを指定して、仮想マシンのテスト フェールオーバーを実行します。
5. テスト フェールオーバーが想定どおりに機能していることを検証したら、仮想マシンのフェールオーバー、次に Active Directory と DNS 仮想マシンのフェールオーバーを完了します。

### プライマリ オンプレミス サイトからセカンダリ サイトへのテスト フェールオーバーの実行

テスト フェールオーバーを実行するには、Active Directory のコピーの作成や、テスト環境内でのテスト用の DHCP サーバーと DNS サーバーの配置などの、いくつかの項目を実行する必要があります。これは、次のような何とおりかの方法で実行できます。

- 既存のネットワークを使用してテスト フェールオーバーを実行する場合は、そのネットワーク内に Active Directory、DHCP、および DNS を準備します。
- VM ネットワークを自動的に作成するオプションを使用してテスト フェールオーバーを実行する場合は、テスト フェールオーバーを実行する前に、テスト フェールオーバーに使用する復旧計画の Group-1 の前に手動の手順を追加し、自動的に作成されたネットワークにインフラストラクチャ リソースを追加します。

#### Active Directory の準備
アプリケーション テストに対してテスト フェールオーバーを実行するには、テスト環境内に Active Directory 運用環境のコピーが必要です。実行方法を次に示します。

1. **コピーを作成する** — 次のいずれかの方法を使用して Active Directory のコピーを作成します。

	- Hyper-V レプリケーション — 他の仮想マシンの場合と同様、Active Directory レプリケーションは Hyper-V レプリケーションを使用して開始できます。復旧計画のテスト フェールオーバーを実行する場合は、Active Directory 仮想マシンのテスト フェールオーバーを実行することもできます。
	- Active Directory のレプリケーション — Active Directory レプリケーションを使用して、レプリカ サイト内に Active Directory インストールのコピーを作成することができます。復旧計画のテスト フェールオーバーを実行するときに、レプリカ Active Directory インストールのスナップショットを作成して、Active Directory 仮想マシンのコピーを作成することができます。このコピーは、テスト フェールオーバーに使用できます。テスト フェールオーバーが完了すると、Active Directory のコピーを削除することができます。

2. **インポートとエクスポート** — Active Directory 仮想マシンのコピーは、エクスポートしてから、新しい GUID を指定してインポートすることによって作成できます。
3. **ネットワークへの追加** — Active Directory を、テスト フェールオーバーで作成されるネットワークに追加します。以下の点に注意してください。 

	- Active Directory を追加するネットワークが運用ネットワークから完全に分離されていることを確認する必要があります。テスト ネットワークとして Windows ネットワーク タイプのネットワークを使用する場合、外部ゲートウェイをネットワークに追加しない限り、自動的に作成された VM ネットワークの分離はシステムにより保証されます。VLAN ベースの分離を使用する場合は、作成される VM ネットワークが、運用環境から分離されていることを確認する必要があります。
	- Active Directory と DNS が同じ仮想マシン上で実行されているかまたは別の仮想マシン上で実行されているかによって、従うことが求められる可能性がある一連の手順は多少異なります。
		- 同じ仮想マシン — Active Directory と DNS が同じ仮想マシン上にある場合は、同じ仮想マシンをテスト フェールオーバー用の DNS リソースとして使用することができます。DNS 内のすべてのエントリをクリーンアップし、その DNS 内に必要なゾーンを再作成することもできます。 
		- 別の仮想マシン — Active Directory と DNS が別の仮想マシン上にある場合は、テスト フェールオーバー用の DNS リソースを作成する必要があります。新規の DNS サーバーを使用し、必要なすべてのゾーンを作成することができます。たとえば、Active Directory ドメインが contoso.com である場合には、contoso.com という名前でゾーンを作成することができます。 

4. **DNS での Active Directory の更新** — どちらの場合にも、Active Directory に対応するエントリは DNS で更新する必要があります。これを行うには、次の手順を実行します。

	- 復旧計画内の他のすべての仮想マシンが起動する前に、次の設定が有効になっているようにします。
		- ゾーンは、フォレスト ルート名に従って名前を付ける必要があります。
		- ゾーンは、ファイルに格納される必要があります。
		- ゾーンは、セキュリティ保護された更新とセキュリティ保護されていない更新の両方に対して有効である必要があります。
		- Active Directory と DNS が 2 つの別の仮想マシン上にある場合、Active Directory 仮想マシンのリゾルバーは、DNS 仮想マシンの IP アドレスをポイントする必要があります。
	- Active Directory で、コマンド nltest/dsregdns を実行します。

#### DHCP の準備

テスト フェールオーバーに関係している仮想マシンが DHCP を使用する場合、テスト DHCP サーバーは、テスト フェールオーバー用に作成された、分離したネットワーク内で作成する必要があります。

#### DNS の準備

次のように、テスト フェールオーバー用の DNS サーバーを準備します。

- **DHCP** — 仮想マシンが DHCP を使用する場合、テスト DHCP サーバー上でテスト DNS の IP アドレスが更新される必要があります。Windows ネットワーク仮想化のネットワーク タイプを使用している場合、VMM サーバーは DHCP サーバーとして機能します。したがって、DNS の IP アドレスは、テスト フェールオーバーに使用される静的 IP アドレス プールで更新される必要があります。この場合、仮想マシンは関連する DNS サーバーに自身を登録します。
- **静的アドレス** — 仮想マシンが静的 IP アドレスを使用する場合、テスト DNS サーバーの IP アドレスは、テスト フェールオーバーに使用される静的 IP アドレス プールで更新される必要があります。DNS は、テスト仮想マシンの IP アドレスで更新する必要があります。この目的のために、次のサンプル スクリプトを使用することができます。 

	    Param(
	    [string]$Zone,
	    [string]$name,
	    [string]$IP
	    )
	    $Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
	    $newrecord = $record.clone()
	    $newrecord.RecordData[0].IPv4Address  =  $IP
	    Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord

- **ゾーンの追加** — DNS サーバー上にゾーンを追加し、セキュリティで保護されていない更新を許可し、その DNS サーバー用のエントリを DNS に追加するには、次のスクリプトを使用します。

	    dnscmd /zoneadd contoso.com  /Primary 
	    dnscmd /recordadd contoso.com  contoso.com. SOA %computername%.contoso.com. hostmaster. 1 15 10 1 1 
	    dnscmd /recordadd contoso.com %computername%  A <IP_OF_DNS_VM> 
	    dnscmd /config contoso.com /allowupdate 1

#### テストの実行

この手順では、復旧計画の、計画されていないフェールオーバーを実行する方法について説明します。別の方法として、**[仮想マシン]** タブで、単一の仮想マシンまたは物理サーバーに対するフェールオーバーを実行することもできます。

1. **[復旧計画]** > *[recoveryplan\_name]* を選択します。**[フェールオーバー]** > **[テスト フェールオーバー]** をクリックします。
2. **[テスト フェールオーバーの確認]** ページで、テスト フェールオーバー後に仮想マシンをネットワークに接続する方法を指定します。
3. **[ジョブ]** タブで、フェールオーバーの進行状況を追跡します。フェールオーバーがテストの完了フェーズに達したら、**[テストの完了]** をクリックして、テスト フェールオーバーを終了します。
4. **[メモ]** をクリックして、テスト フェールオーバーに関連する監察結果をすべて記録し、保存します。
4. 完了後に、仮想マシンが正常に起動することを確認します。
5. 仮想マシンが正常に起動することを確認したら、テスト フェールオーバーを完了して、孤立した環境をクリーンアップします。VM ネットワークの自動作成を選択した場合は、クリーンアップにより、すべてのテスト仮想マシンとテスト ネットワークが削除されます。

テスト フェールオーバーが 2 週間を超えても続行する場合は、強制的に終了され、テスト フェールオーバー中に自動的に作成されたすべての要素または仮想マシンは削除されることに注意してください。

## 計画されたフェールオーバーの実行 (プライマリからセカンダリ)

 この手順では、復旧計画の、計画されたフェールオーバーを実行する方法について説明します。別の方法として、**[仮想マシン]** タブで、単一の仮想マシンに対するフェールオーバーを実行することもできます。

1. 開始する前に、フェールオーバーするすべての仮想マシンが、初期レプリケーションを完了していることを確認します。
2. **[復旧計画]** > *[recoveryplan\_name]* を選択します。**[フェールオーバー]** > **[計画されたフェールオーバー]** をクリックします。 
3. **[計画されたフェールオーバーの確認]** ページで、ソースとターゲットの場所を選択します。フェールオーバーの方向に注意してください。

	- 以前のフェールオーバーが想定どおりに実行されており、すべての仮想マシン サーバーが、ソースの場所とターゲットの場所のいずれかに配置されている場合、フェールオーバーの方向の詳細は、情報の提供のみを目的としています。 
	- ソースの場所とターゲットの場所の両方で仮想マシンがアクティブである場合は、**[方向の変更]** ボタンが表示されます。このボタンを使って、フェールオーバーが実行される方向を変更し、指定します。

5. Azure にフェールオーバーし、クラウドのデータ暗号化が有効になっている場合には、**[暗号化キー]** で、VMM サーバーへのプロバイダーのインストール中にデータ暗号化を有効にしたときに発行された証明書を選択します。
6. データ損失を確実に防ぐために、計画されたフェールオーバーの開始時の最初のステップとして、仮想マシンをシャットダウンします。フェールオーバーの進行状況は、**[ジョブ]** タブで確認できます。フェールオーバーで (仮想マシン、または復旧計画に含まれているスクリプトのいずれかにおいて) エラーが発生した場合は、復旧計画の計画されたフェールオーバーは停止します。フェールオーバーは、もう一度開始することができます。
8. レプリカ仮想マシンは、作成後にコミット保留中の状態になります。**[コミット]** をクリックして、フェールオーバーをコミットします。 
9. レプリケーションが完了すると、仮想マシンがセカンダリの場所で起動します。 

## 計画されていないフェールオーバーの実行

この手順では、復旧計画の、計画されていないフェールオーバーを実行する方法について説明します。別の方法として、**[仮想マシン]** タブで、単一の仮想マシンまたは物理サーバーに対するフェールオーバーを実行することもできます。

1. **[復旧計画]** > *[recoveryplan\_name]* を選択します。**[フェールオーバー]** > **[計画されていないフェールオーバー]** をクリックします。 
3. **[計画されていないフェールオーバーの確認]** ページで、ソースとターゲットの場所を選択します。フェールオーバーの方向に注意してください。

	- 以前のフェールオーバーが想定どおりに実行されており、すべての仮想マシン サーバーが、ソースの場所とターゲットの場所のいずれかに配置されている場合、フェールオーバーの方向の詳細は、情報の提供のみを目的としています。 
	- ソースの場所とターゲットの場所の両方で仮想マシンがアクティブである場合は、**[方向の変更]** ボタンが表示されます。このボタンを使って、フェールオーバーが実行される方向を変更し、指定します。

4. Azure にフェールオーバーし、クラウドのデータ暗号化が有効になっている場合には、**[暗号化キー]** で、VMM サーバーへのプロバイダーのインストール中にデータ暗号化を有効にしたときに発行された証明書を選択します。
5. **[仮想マシンをシャットダウンして最新のデータを同期 (Shut down virtual machines and synchronize the latest data)]** を選択し、Site Recovery が保護された仮想マシンをシャットダウンしてデータを同期するように指定することで、最新バージョンのデータをフェールオーバーします。このオプションを選択しないか、または試行が成功しない場合、仮想マシンのフェールオーバーは、利用可能な最新の回復ポイントから実行されます。
6. フェールオーバーの進行状況は、**[ジョブ]** タブで確認できます。計画されていないフェールオーバーの実行中にエラーが発生しても、復旧計画は最後まで実行されることに注意してください。
7. フェールオーバーの後、仮想マシンは**コミット保留中**の状態になります。**[コミット]** をクリックして、フェールオーバーをコミットします。
8. レプリケーションで複数の回復ポイントを使用するように設定している場合は、[回復ポイントの変更 (Change Recovery Point)] で、最新のものではない回復ポイントを使用するように選択できます (既定では最新のものが使用されます)。コミット後には、その他の回復ポイントは削除されます。
9. レプリケーションが完了すると、仮想マシンがセカンダリの場所で起動し、稼働状態になります。ただし、それらは保護されたりレプリケートされたりしません。プライマリ サイトが、基になる同じインフラストラクチャで再び使用可能になったら、**[レプリケーションの反転]** をクリックして、レプリケーションの反転を開始します。これによって、すべてのデータがプライマリ サイトに確実にレプリケートされ、仮想マシンがフェールオーバー可能な状態に戻ります。計画されていないフェールオーバー後のレプリケーションの反転では、データ転送のオーバーヘッドが発生します。転送は、クラウドの初期レプリケーション設定で構成されているものと同じ方法で行われます。

## セカンダリからプライマリへのフェールバック

 プライマリからセカンダリの場所へのフェールオーバー後は、レプリケートされた仮想マシンは Site Recovery では保護されず、セカンダリの場所はプライマリとして機能するようになります。元のプライマリ サイトにフェールバックするには、次の手順に従います。この手順では、復旧計画の、計画されたフェールオーバーを実行する方法について説明します。別の方法として、**[仮想マシン]** タブで、単一の仮想マシンに対するフェールオーバーを実行することもできます。

1. **[復旧計画]** > *[recoveryplan\_name]* を選択します。**[フェールオーバー]** > **[計画されたフェールオーバー]** をクリックします。
2. **[計画されたフェールオーバーの確認]** ページで、ソースとターゲットの場所を選択します。フェールオーバーの方向に注意してください。プライマリからのフェールオーバーが想定どおりに機能し、すべての仮想マシンがセカンダリの場所にある場合には、これは情報の提供のみを目的としています。
3. Azure からフェールバックする場合は、**[データの同期 (Data Synchronization)]** で次の設定を選択してください。

	- **[フェールオーバー前のデータを同期 (Synchronize the data before the failover)]** — このオプションを指定すると、仮想マシンをシャットダウンせずに同期するため、ダウンタイムを最小限に抑えることができます。その内容は次のとおりです。
		- フェーズ 1: Azure で仮想マシンのスナップショットを取得し、それをオンプレミスの Hyper-V ホストにコピーします。マシンは Azure での実行を継続します。
		- フェーズ 2: Azure で仮想マシンをシャットダウンします。これでその仮想マシンでは新しい変更は発生しません。変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの仮想マシンが起動します。
	
	> [AZURE.NOTE]Azure で仮想マシンをしばらくの間 (1 か月以上) 実行していた場合は、このオプションを使用することをお勧めします。このオプションは、仮想マシンをシャットダウンすることなく同期を実行します。再同期は実行しませんが、完全フェールバックを実行します。このオプションは、チェックサム計算は実行しません。

	- **[フェールオーバー中のデータのみを同期 (Synchronize the data during failover only)]** — このオプションは、Azure 上での仮想マシンの実行がごく短時間である場合に使用します。このオプションは、完全フェールバックではなく再同期を実行するので、フェールバックにかかる時間は短くなります。高速なチェックサム計算を実行し、変更されたブロックのみをダウンロードします。

5. Azure にフェールオーバーし、クラウドのデータ暗号化が有効になっている場合には、**[暗号化キー]** で、VMM サーバーへのプロバイダーのインストール中にデータ暗号化を有効にしたときに発行された証明書を選択します。
5. 既定では最新の回復ポイントが使用されますが、**[回復ポイントの変更 (Change Recovery Point)]** で、別の回復ポイントを指定することができます。 
6. チェックマークをクリックして、フェールバックを開始します。フェールオーバーの進行状況は、**[ジョブ]** タブで確認できます。 
7. フェールオーバー前のデータを同期するオプションを選択した場合、初期データの同期が完了して、Azure で仮想マシンをシャットダウンする準備ができたら、**[ジョブ]** > <planned failover job name>**[完全フェールオーバー (Complete Failover)]** をクリックします。これにより Azure で仮想マシンがシャットダウンされ、最新の変更がオンプレミスの仮想マシンに転送され、オンプレミスの仮想マシンが起動します。
8. これで仮想マシンにログオンして、それが想定どおりに使用できるかを検証できます。 
9. 仮想マシンは、コミット保留中の状態になります。**[コミット]** をクリックして、フェールオーバーをコミットします。
10. フェールバックを完了するために、**[レプリケーションの反転]** をクリックして、プライマリ サイトの仮想マシンの保護を開始します。



## 別の場所へのフェールバック

[Hyper-V サイトと Azure](site-recovery-hyper-v-site-to-azure.md) の間での保護がデプロイされている場合は、Azure から別のオンプレミスの場所にフェールバックを実行できます。これは、新しいオンプレミス ハードウェアを設定する必要がある場合に便利です。これを行うには、次の手順を実行します。

1. 新しいハードウェアを設定する場合は、Windows Server 2012 R2 および Hyper-V のロールをサーバーにインストールします。
2. 元のサーバーに保存していたものと同じ名前を使用して、仮想ネットワーク スイッチを作成します。
3. フェールバックの対象を **[保護された項目]** -> **[保護グループ]** -> <ProtectionGroupName>-> <VirtualMachineName>で選択して、**[計画されたフェールオーバー]** を選択します。
4. **[計画されたフェールオーバーの確認]** で、**[オンプレミスの仮想マシンが存在しない場合に作成 (Create on-premises virtual machine if it does not exist)]** を選択します。 
5. **[ホスト名]** で、仮想マシンを配置する、新しい Hyper-V ホスト サーバーを選択します。
6. [データの同期 (Data Synchronization)] で、オプション **[フェールオーバー前のデータを同期 (Synchronize the data before the failover)]** を選択することをお勧めします。このオプションを指定すると、仮想マシンをシャットダウンせずに同期するため、ダウンタイムを最小限に抑えることができます。その内容は次のとおりです。

	- フェーズ 1: Azure で仮想マシンのスナップショットを取得し、それをオンプレミスの Hyper-V ホストにコピーします。マシンは Azure での実行を継続します。
	- フェーズ 2: Azure で仮想マシンをシャットダウンします。これでその仮想マシンでは新しい変更は発生しません。変更の最終セットがオンプレミス サーバーに転送され、オンプレミスの仮想マシンが起動します。
	
7. チェックマークをクリックして、フェールオーバー (フェールバック) を開始します。
8. 初期の同期が終了し、Azure で仮想マシンをシャットダウンする準備ができたら、**[ジョブ]** > <planned failover job>**[完全フェールオーバー (Complete Failover)]** をクリックします。これにより Azure で仮想マシンがシャットダウンされ、最新の変更がオンプレミスの仮想マシンに転送され、オンプレミスの仮想マシンが起動します。
9. これでオンプレミスの仮想マシンにログオンして、すべてが想定どおりに動作するかどうかを検証できます。**[コミット]** をクリックして、フェールオーバーを完了します。
10. **[レプリケーションの反転]** をクリックして、オンプレミス仮想マシンの保護を開始します。

 

<!---HONumber=August15_HO7-->