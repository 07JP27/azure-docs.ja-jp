---
title: Azure Site Recovery を使用した Azure Disk Encryption 対応 VM のレプリケーションの構成 | Microsoft Docs
description: この記事では、Site Recovery を使用して Azure Disk Encryption 対応 VM を Azure リージョン間でレプリケートするための構成方法について説明します。
services: site-recovery
author: sujayt
manager: rochakm
ms.service: site-recovery
ms.topic: article
ms.date: 04/08/2019
ms.author: sutalasi
ms.openlocfilehash: 4943b730bb46ee00200d84faf95a7ccb069d3aa8
ms.sourcegitcommit: c3d1aa5a1d922c172654b50a6a5c8b2a6c71aa91
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/17/2019
ms.locfileid: "59678957"
---
# <a name="replicate-azure-disk-encryption-enabled-virtual-machines-to-another-azure-region"></a>Azure Disk Encryption 対応仮想マシンを別の Azure リージョンにレプリケートする

この記事では、Azure Disk Encryption 対応 VM を Azure リージョン間でレプリケートする方法について説明します。

>[!NOTE]
>現在、Azure Site Recovery でサポートされる Azure VM は、Windows OS を稼動しており、なおかつ [Azure Active Directory (Azure AD) を使用した暗号化に対応](https://aka.ms/ade-aad-app)しているものに限られています。

## <a name="required-user-permissions"></a>必要なユーザー アクセス許可
Site Recovery では、ユーザーが、ターゲット リージョン内にキー コンテナーを作成し、そのリージョンにキーをコピーするアクセス許可を持っていることが必要です。

Azure portal から Disk Encryption 対応 VM のレプリケーションを有効にするには、ユーザーに次のアクセス許可が必要です。

- Key Vault のアクセス許可
    - List
    - Create
    - 取得

-   Key Vault シークレットのアクセス許可
    - List
    - Create
    - 取得

- キー コンテナー キーのアクセス許可 (ディスク暗号化キーを暗号化するために VM でキー暗号化キーが使用される場合にのみ必須)
    - List
    - 取得
    - Create
    - 暗号化
    - 復号化

アクセス許可を管理するには、ポータル内でキー コンテナー リソースに移動します。 ユーザーに必要なアクセス許可を追加します。 次の例は、ソース リージョンにあるキー コンテナー *ContosoWeb2Keyvault* へのアクセス許可を有効にする方法を示しています。

1. **[ホーム]** > **[Keyvaults]\(Keyvault\)** > **[ContosoWeb2KeyVault] > [アクセス ポリシー]** に移動します。

   ![キー コンテナーのアクセス許可ウィンドウ](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-1.png)

2. ユーザーのアクセス許可がないことを確認できます。 **[新規追加]** を選択します。 ユーザーとアクセス許可の情報を入力します。

   ![Keyvault のアクセス許可](./media/azure-to-azure-how-to-enable-replication-ade-vms/key-vault-permission-2.png)

ディザスター リカバリー (DR) を有効にしているユーザーに、キーをコピーするためのアクセス許可がない場合は、該当するアクセス許可を持つセキュリティ管理者が、次のスクリプトを使用して、暗号化シークレットと暗号化キーをターゲット リージョンにコピーできます。

アクセス許可をトラブルシューティングするには、[キー コンテナーのアクセス許可の問題](#trusted-root-certificates-error-code-151066)に関するページを参照してください。

>[!NOTE]
>ポータルから Disk Encryption 対応 VM のレプリケーションを有効にするには、少なくともキー コンテナー、シークレット、キーに対する "一覧表示" アクセス許可が必要です。

## <a name="copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script"></a>PowerShell スクリプトを使用して Disk Encryption キーを DR リージョンにコピーする

1. [未加工のスクリプト コード "CopyKeys" を開きます](https://aka.ms/ade-asr-copy-keys-code)。
2. このスクリプトをファイルにコピーして、ファイル名を **Copy-keys.ps1** にします。
3. Windows PowerShell アプリケーションを開き、このファイルを保存したフォルダーに移動します。
4. Copy-keys.ps1 を実行します。
5. Azure の資格情報を入力してサインインします。
6. お客様の VM の **Azure サブスクリプション**を選択します。
7. リソース グループが読み込まれるのを待ってから、VM の**リソース グループ**を選択します。
8. 表示された一覧から VM を選択します。 ディスクの暗号化に対応した VM のみが一覧に表示されます。
9. **[ターゲットの場所]** を選択します。

    - **[ディスクの暗号化のキー コンテナー]**
    - **[キー暗号化キー コンテナー]**

   既定では、Site Recovery によってターゲット リージョンに新しいキー コンテナーが作成されます。 コンテナー名のサフィックスは "asr" です。これは、ソース VM のディスク暗号化キーに基づきます。 Site Recovery によって作成されたキー コンテナーが既に存在する場合は、それが再利用されます。 必要な場合は、一覧から別のキー コンテナーを選択します。

## <a name="enable-replication"></a>レプリケーションを有効にする

この例では、プライマリ Azure リージョンが東アジア、セカンダリ リージョンが東南アジアです。

1. コンテナー内で、**[+Replicate]\(+レプリケート\)** を選択します。
2. 次のフィールドに注意してください。
    - **ソース**:VM の起点。この例では **Azure** です。
    - **ソースの場所**:仮想マシンを保護する Azure リージョン。 この例では、ソースの場所は "東アジア" です。
    - **デプロイ モデル**:ソース マシンの Azure デプロイ モデル。
    - **ソース サブスクリプション**:ソース仮想マシンが属しているサブスクリプション。 これは、Recovery Services コンテナーと同じ Azure Active Directory テナント内のどのサブスクリプションでもかまいません。
    - **リソース グループ**:ソース仮想マシンが属しているリソース グループ。 選択したリソース グループ内のすべての VM が、次の手順で保護対象として表示されます。

3. **[仮想マシン]** > **[仮想マシンの選択]** で、レプリケートする各 VM を選択します。 選択できるのは、レプリケーションを有効にできるマシンのみです。 **[OK]** をクリックします。

4. **[設定]** では、次のターゲット サイトの設定を構成できます。

    - **ターゲットの場所**:ソース仮想マシンのデータがレプリケートされる場所。 Site Recovery では、選択したマシンの場所に基づいて、適切なターゲット リージョンの一覧が表示されます。 Recovery Services コンテナーと同じ場所にすることをお勧めします。
    - **ターゲット サブスクリプション**:ディザスター リカバリーに使用されるターゲット サブスクリプション。 既定では、ターゲット サブスクリプションはソース サブスクリプションと同じです。
    - **ターゲット リソース グループ**:レプリケートされたすべての仮想マシンが属するリソース グループ。 既定では、Site Recovery により、ターゲット リージョン内に新しいリソース グループが作成されます。 名前のサフィックスは "asr" です。 Azure Site Recovery によって作成されたリソース グループが既に存在する場合は、そのグループが再利用されます。 次のセクションで示すように、それをカスタマイズすることもできます。 ターゲット リソース グループの場所は、ソース仮想マシンがホストされているリージョンを除き、どの Azure リージョンでもかまいません。
    - **ターゲット仮想ネットワーク**:既定では、Site Recovery により、ターゲット リージョン内に新しい仮想ネットワークが作成されます。 名前のサフィックスは "asr" です。 これはソース ネットワークにマップされ、今後の保護で使用されます。 ネットワーク マッピングの詳細については、[こちら](site-recovery-network-mapping-azure-to-azure.md)を参照してください。
    - **ターゲット ストレージ アカウント (ソース VM でマネージド ディスクが使用されていない場合)**:既定では、Site Recovery によって、ソース VM ストレージと同じ構成で新しいターゲット ストレージ アカウントが作成されます。 ストレージ アカウントが既に存在する場合は、再利用されます。
    - **レプリカ マネージド ディスク (ソース VM でマネージド ディスクが使用されている場合)**:Site Recovery によってターゲット リージョン内に新しいレプリカ マネージド ディスクが作成され、ソース VM のマネージド ディスクと同じストレージ タイプ (Standard または Premium) のソース VM のマネージド ディスクがミラーリングされます。
    - **ストレージ アカウントのキャッシュ**:Site Recovery では、"*キャッシュ ストレージ*" と呼ばれる追加のストレージ アカウントがソース リージョンに必要です。 ソース VM 上の変更はすべて追跡され、キャッシュ ストレージ アカウントに送信されます。 次に、これらは、ターゲットの場所にレプリケートされます。
    - **可用性セット**:既定では、Site Recovery により、ターゲット リージョン内に新しい可用性セットが作成されます。 名前のサフィックスは "asr" です。 Site Recovery によって作成された可用性セットが既に存在する場合は、それが再利用されます。
    - **[ディスクの暗号化のキー コンテナー]**:既定では、Site Recovery によってターゲット リージョンに新しいキー コンテナーが作成されます。 サフィックスは "asr" です。これは、ソース VM のディスク暗号化キーに基づいています。 Azure Site Recovery によって作成されたキー コンテナーが既に存在する場合は、それが再利用されます。
    - **[キー暗号化キー コンテナー]**:既定では、Site Recovery によってターゲット リージョンに新しいキー コンテナーが作成されます。 名前のサフィックスは "asr" です。これは、ソース VM キー暗号化キーに基づきます。 Azure Site Recovery によって作成されたキー コンテナーが既に存在する場合は、それが再利用されます。
    - **レプリケーション ポリシー**:復旧ポイントのリテンション履歴と、アプリ整合性スナップショットの頻度の設定を定義します。 既定では、新しいレプリケーション ポリシーが、既定の設定で Site Recovery によって作成されます。つまり、このポリシーの復旧ポイントのリテンション期間は "*24 時間*" に、アプリ整合性スナップショットの頻度は "*60 分*" に設定されます。

## <a name="customize-target-resources"></a>ターゲット リソースのカスタマイズ

Site Recovery の既定のターゲット設定を変更するには、次の手順に従います。

1. [ターゲット サブスクリプション] の横にある **[カスタマイズ]** を選択して、既定のターゲット サブスクリプションを変更します。 Azure AD テナント内で使用可能なサブスクリプションの一覧からサブスクリプションを選択します。

2. [リソース グループ、ネットワーク、ストレージ、可用性セット] の横にある **[カスタマイズ]** を選択して、次の既定の設定を変更します。
    - **[ターゲット リソース グループ]** では、サブスクリプションのターゲットの場所にあるリソース グループの一覧から、リソース グループを選択します。
    - **[ターゲット仮想ネットワーク]** では、ターゲットの場所にある仮想ネットワークの一覧から、ネットワークを選択します。
    - **[可用性セット]** では、可用性セットの設定を VM に追加できます (それら可用性セットがソース リージョン内の可用性セットの一部である場合)。
    - **[ターゲット ストレージ アカウント]** では、使用するアカウントを選択します。

2. [暗号化設定] の横にある **[カスタマイズ]** を選択して、次の既定の設定を変更します。
   - **[ターゲットのディスク暗号化キー コンテナー]** では、サブスクリプションのターゲットの場所にあるキー コンテナーの一覧から、ターゲットのディスク暗号化キー コンテナーを選択します。
   - **[ターゲットのキー暗号化キー コンテナー]** では、サブスクリプションのターゲットの場所にあるキー コンテナーの一覧から、ターゲットのキー暗号化キー コンテナーを選択します。

3. **[Create target resource]\(ターゲット リソースを作成する\)** > **[レプリケーションを有効にする]** の順に選択します。
4. VM のレプリケーションが有効になったら、**[レプリケートされたアイテム]** で VM の正常性の状態を確認できます。

>[!NOTE]
>初期レプリケーションの間は、状態の更新に少し時間がかかり、処理が進行していないように見える場合があります。 **[更新]** をクリックすると、最新の状態を確認できます。

## <a name="update-target-vm-encryption-settings"></a>ターゲット VM の暗号化設定を更新する
次のシナリオでは、ターゲット VM の暗号化設定の更新が必要になります。
  - VM 上で Site Recovery のレプリケーションを有効にした。 その後、ソース VM 上でディスク暗号化を有効にした。
  - VM 上で Site Recovery のレプリケーションを有効にした。 その後、ソース VM 上でディスク暗号化キーまたはキー暗号化キーを変更した。

[こちらのスクリプト](#copy-disk-encryption-keys-to-the-dr-region-by-using-the-powershell-script)を使用して暗号化キーをターゲット リージョンにコピーしたうえで、**[Recovery Services コンテナー]** > *[レプリケートされたアイテム]* > **[プロパティ]** > **[コンピューティングとネットワーク]** の順に移動してターゲットの暗号化設定を更新できます。

![ADE 設定の更新ダイアログ ウィンドウ](./media/azure-to-azure-how-to-enable-replication-ade-vms/update-ade-settings.png)

## <a id="trusted-root-certificates-error-code-151066"></a>Azure 間 VM レプリケーションの間のキー コンテナーのアクセス許可の問題のトラブルシューティング

**原因 1:** キー コンテナーを Site Recovery に作成させるのではなく、必要なアクセス許可がない作成済みのキー コンテナーをターゲット リージョンから選択した可能性があります。 後述するように、必要なアクセス許可がキー コンテナーにあることを確認してください。

*例*: ソース リージョン上のキー コンテナー *ContososourceKeyvault* を持つ VM をレプリケートしようとしました。
ソース リージョンのキー コンテナーに対するすべてのアクセス許可は持っています。 しかし、保護中に、アクセス許可を持たない作成済みのキー コンテナーである ContosotargetKeyvault を選択しました。 エラーが発生しました。

**修正方法:** **[ホーム]** > **[Keyvaults]\(Keyvault\)** > **[ContososourceKeyvault]** > **[アクセス ポリシー]** に移動して、適切なアクセス許可を追加します。

**原因 2:** キー コンテナーを Site Recovery に作成させるのではなく、暗号化解除 - 暗号化のアクセス許可がない作成済みのキー コンテナーをターゲット リージョンから選択した可能性があります。 ソース リージョン上でもキーを暗号化している場合は、暗号化解除 - 暗号化のアクセス許可があることを確認してください。</br>

*例*: ソース リージョン上のキー コンテナー *ContososourceKeyvault* を持つ VM をレプリケートしようとしました。 ソース リージョンのキー コンテナーに対して必要なアクセス許可はすべて持っています。 しかし、保護中に、暗号化解除と暗号化のアクセス許可を持たない作成済みのキー コンテナーである ContosotargetKeyvault を選択しました。 エラーが発生しました。</br>

**修正方法:** **[ホーム]** > **[Keyvaults]\(Keyvault\)** > **[ContososourceKeyvault]** > **[アクセス ポリシー]** に移動します。 **[キーのアクセス許可]** > **[暗号化操作]** の下でアクセス許可を追加します。

## <a name="next-steps"></a>次の手順

テスト フェールオーバーの実行に関する[詳細を確認](site-recovery-test-failover-to-azure.md)する。
