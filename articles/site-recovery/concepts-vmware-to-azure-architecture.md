---
title: "Azure Site Recovery での VMware から Azure へのレプリケーション アーキテクチャ | Microsoft Docs"
description: "この記事では、Azure Site Recovery を使ってオンプレミスの VMware VM を Azure にレプリケートするときに使われるコンポーネントとアーキテクチャの概要を説明します"
author: rayne-wiselman
ms.service: site-recovery
ms.topic: article
ms.date: 01/15/2018
ms.author: raynew
ms.openlocfilehash: 4dd9d4f5f26d70f9130f48e2bf40ce71943a6c6d
ms.sourcegitcommit: 088a8788d69a63a8e1333ad272d4a299cb19316e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/27/2018
---
# <a name="vmware-to-azure-replication-architecture"></a>VMware から Azure へのレプリケーション アーキテクチャ

この記事では、[Azure Site Recovery](site-recovery-overview.md) を使ってオンプレミスの VMware サイトと Azure 間で VMware 仮想マシン (VM) をレプリケート、フェールオーバー、および復旧する場合に使われるアーキテクチャとプロセスについて説明します。


## <a name="architectural-components"></a>アーキテクチャ コンポーネント

次の表と図は、Azure への VMware レプリケーションに使用するコンポーネントの概要を示したものです。

**コンポーネント** | **要件** | **詳細**
--- | --- | ---
**Azure** | Azure サブスクリプション、Azure Storage アカウント、および Azure ネットワーク。 | オンプレミスの VM からレプリケートされたデータはストレージ アカウントに格納されます。 オンプレミスから Azure へのフェールオーバーを実行すると、そのレプリケートされたデータで Azure VM が作成されます。 Azure VM は、作成時に Azure 仮想ネットワークに接続します。
**構成サーバー マシン** | 単一のオンプレミス マシン。 ダウンロードした OVF テンプレートから展開できる VMware VM として実行することをお勧めします。<br/><br/> マシンは、構成サーバー、プロセス サーバー、マスター ターゲット サーバーなど、オンプレミスのすべての Site Recovery コンポーネントを実行します。 | **構成サーバー**: オンプレミスと Azure の間の通信を調整し、データのレプリケーションを管理します。<br/><br/> **プロセス サーバー**: 構成サーバーに既定でインストールされます。 レプリケーション データを受信し、そのデータをキャッシュ、圧縮、暗号化によって最適化して、Azure Storage に送信します。 また、プロセス サーバーは、レプリケートする VM への Azure Site Recovery モビリティ サービスのインストールや、オンプレミスのマシンの自動検出も行います。 デプロイの拡大に合わせて、増大するレプリケーション トラフィックの処理を実行する独立したプロセス サーバーを追加できます。<br/><br/> **マスター ターゲット サーバー**: 構成サーバーに既定でインストールされます。 Azure からのフェールバック中にレプリケーション データを処理します。 大規模なデプロイでは、フェールバック用に別のマスター ターゲット サーバーを追加できます。
**VMware サーバー** | VMware VM は、オンプレミス vSphere ESXi サーバーでホストされています。 ホストの管理には vCenter サーバーをお勧めします。 | Site Recovery のデプロイ中には、VMware サーバーを Recovery Services コンテナーに追加します。
**レプリケートされたマシン** | レプリケートする各 VMware VM にモビリティ サービスがインストールされます。 | プロセス サーバーから自動的にインストールできるようにすることをお勧めします。 また、サービスを手動でインストールしたり、System Center Configuration Manager などの自動デプロイ方法を使用できます。

**VMware から Azure へのアーキテクチャ**

![コンポーネント](./media/concepts-vmware-to-azure-architecture/arch-enhanced.png)

## <a name="replication-process"></a>レプリケーション プロセス

1. Azure のリソースおよびオンプレミスのコンポーネントを準備します。
2. Recovery Services コンテナーで、ソース レプリケーションの設定を指定します。 このプロセスの一環として、オンプレミスの構成サーバーを設定します。 このサーバーを VMware VM として展開するには、準備済みの OVF テンプレートをダウンロードし、それを VMware にインポートして VM を作成します。
3. ターゲット レプリケーションの設定を指定し、レプリケーション ポリシーを作成して、VMware VM のレプリケーションを有効にします。
4. レプリケーション ポリシーに従ってマシンがレプリケートされると、VM データの初回コピーが Azure Storage にレプリケートされます。
5. 初回のレプリケーションの終了後、Azure への差分変更のレプリケーションが開始されます。 マシンの追跡された変更は .hrl ファイルに保持されます。

    * マシンは、レプリケーション管理のために、受信ポート HTTPS 443 で構成サーバーと通信します。

    * マシンは、受信ポート HTTPS 9443 でレプリケーション データをプロセス サーバーに送信します (変更可能)。

    * 構成サーバーは、送信ポート HTTPS 443 経由で Azure によるレプリケーション管理を調整します。

    * プロセス サーバーは、ソース マシンからデータを受信し、そのデータを最適化して暗号化し、送信ポート 443 を介して Azure Storage に送信します。

    * マルチ VM 整合性を有効にすると、レプリケーション グループ内のマシンは、ポート 20004 を介して相互に通信します。 フェールオーバー時にクラッシュ整合性復旧ポイントとアプリ整合性復旧ポイントを共有するレプリケーション グループに複数のマシンをグループ化する場合にマルチ VM が使用されます。 この方法は、これらのマシンが同じワークロードを実行していて、一貫性を持たせる必要がある場合に役立ちます。

6. トラフィックは、インターネット経由で Azure Storage のパブリック エンドポイントにレプリケートされます。 また、Azure ExpressRoute の[パブリック ピアリング](../expressroute/expressroute-circuit-peerings.md#azure-public-peering)を使用することもできます。 オンプレミス サイトから Azure へのサイト間仮想プライベート ネットワーク (VPN) を介したトラフィックのレプリケートはサポートされていません。


**VMware から Azure へのレプリケーション プロセス**

![レプリケーション プロセス](./media/concepts-vmware-to-azure-architecture/v2a-architecture-henry.png)

## <a name="failover-and-failback-process"></a>フェールオーバーとフェールバックのプロセス

レプリケーションがセットアップされ、ディザスター リカバリーの訓練 (フェールオーバーのテスト) を実行してすべてが期待どおりに動作を確認したら、必要に応じて、フェールオーバーとフェールバックを実行できます。

1. 単一のマシンをフェールオーバーするか、複数の VM をフェールオーバーするための復旧計画を作成することができます。

2. フェールオーバーを実行すると、Azure Storage のレプリケートされたデータから Azure VM が作成されます。

3. 最初のフェールオーバーをトリガーするには、Azure VM から、ワークロードへのアクセスを開始するようコミットします。

プライマリ オンプレミス サイトが再度使用可能になると、フェールバックできます。
1. 次のものを含むフェールバック インフラストラクチャを設定する必要があります。

    * **Azure 内の一時的なプロセス サーバー**: Azure からフェールバックするために、プロセス サーバーとして機能する Azure VM をセットアップする必要があります。 この VM は、フェールバックの完了後に削除できます。

    * **VPN 接続**: フェールバックするには、Azure ネットワークからオンプレミス サイトへの VPN 接続 (または ExpressRoute) が必要です。

    * **独立したマスター ターゲット サーバー**: 既定では、構成サーバーと共にオンプレミスの VMware VM にインストールされたマスター ターゲット サーバーが、フェールバックを処理します。 大量のトラフィックをフェールバックする必要がある場合は、その目的を果たすための独立したオンプレミスのマスター ターゲット サーバーをセットアップします。

    * **フェールバック ポリシー**: オンプレミスにもう一度レプリケートするには、フェールバック ポリシーが必要です。 このポリシーは、オンプレミスから Azure にレプリケーション ポリシーを作成したときに自動的に作成されます。
2. コンポーネントが配置されたら、フェールバックが 3 段階で発生します。

    a.[サインオン URL] ボックスに、次のパターンを使用して、ユーザーが RightScale アプリケーションへのサインオンに使用する URL を入力します。 第 1 段階: Azure VM が Azure からオンプレミスの VMware VM へのレプリケートを開始するように、Azure VM を再保護します。

    b. 第 2 段階: オンプレミス サイトでフェールオーバーを実行します。

    c. 第 3 段階: ワークロードがフェールバックしたら、オンプレミス VM のレプリケーションを再び有効にします。

**Azure からの VMware フェールバック**

![フェールバック](./media/concepts-vmware-to-azure-architecture/enhanced-failback.png)


## <a name="next-steps"></a>次の手順

VMware から Azure へのレプリケーションを有効にするには、[このチュートリアル](tutorial-vmware-to-azure.md)に従ってください。
