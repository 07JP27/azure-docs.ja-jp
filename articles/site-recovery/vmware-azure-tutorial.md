---
title: "Azure Site Recovery を使用して Azure にオンプレミス VMware VM のディザスター リカバリーを設定する |Microsoft Docs"
description: "Azure Site Recovery を使用して Azure にオンプレミス VMware VM のディザスター リカバリーを設定する方法について説明します。"
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.topic: tutorial
ms.date: 02/27/2018
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 7580db2a2fd41c124443b26257f1b946adcc068c
ms.sourcegitcommit: c765cbd9c379ed00f1e2394374efa8e1915321b9
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/28/2018
---
# <a name="set-up-disaster-recovery-to-azure-for-on-premises-vmware-vms"></a>Azure にオンプレミス VMware VM のディザスター リカバリーを設定する

このチュートリアルでは、Windows を実行するオンプレミス VMware VM のディザスター リカバリーを Azure に設定する方法について説明します。 このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * レプリケーションのソースとターゲットを入力します。
> * ソースのレプリケーション環境 (オンプレミスの Azure Site Recovery コンポーネントなど) と、ターゲットのレプリケーション環境を設定します。
> * レプリケーション ポリシーを作成します。
> * VM のレプリケーションを有効にします。

これは、シリーズの 3 番目のチュートリアルです。 このチュートリアルは、前のチュートリアルで以下のタスクが既に完了していることを前提としています。

* [Azure を準備する](tutorial-prepare-azure.md)
* [オンプレミスの VMware を準備する](vmware-azure-tutorial-prepare-on-premises.md)

開始する前に、ディザスター リカバリー シナリオの[アーキテクチャを確認](vmware-azure-architecture.md)しておくことをお勧めします。


## <a name="select-a-replication-goal"></a>レプリケーションの目標を選ぶ

1. **[Recovery Services コンテナー]** で、コンテナー名 **ContosoVMVault** を選択します。
2. **[作業の開始]** で、[Site Recovery] を選択します。 次に、**[インフラストラクチャの準備]** を選択します。
3. **[保護の目標]** > **[マシンのある場所]** で、**[オンプレミス]** を選びます。
4. **[マシンをどこにレプリケートしますか]** で、**[To Azure]\(Azure\)** を選びます。
5. **[マシンは仮想化されていますか]** で、**[はい (VMware vSphere ハイパーバイザー の場合)]** を選びます。 **[OK]** をクリックします。

## <a name="set-up-the-source-environment"></a>ソース環境をセットアップする

> [!TIP]
> VMware 仮想マシンを保護するための構成サーバーをデプロイすることに関して推奨される方法は、この記事でも推奨している OVF ベースのデプロイメント モデルを使用することです。 社内的な制限から OVF テンプレートをデプロイすることが難しい場合は、[UnifiedSetup.exe を使用して構成サーバーをインストール](physical-manage-configuration-server.md)してください。

ソース環境をセットアップするには、オンプレミスの Site Recovery コンポーネントをホストするためのオンプレミスの高可用性マシンが 1 つ必要です。 コンポーネントには、構成サーバー、プロセス サーバー、マスター ターゲット サーバーが含まれます。

- 構成サーバーは、オンプレミスと Azure の間の通信を調整し、データのレプリケーションを管理します。
- プロセス サーバーはレプリケーション ゲートウェイとして機能します。 レプリケーション データを受信し、そのデータをキャッシュ、圧縮、暗号化によって最適化して、Azure Storage に送信します。 また、プロセス サーバーは、レプリケートする VM へのモビリティ サービスのインストールや、オンプレミスの VMware VM の自動検出も行います。
- マスター ターゲット サーバーは、Azure からのフェールバック中にレプリケーション データを処理します。

構成サーバーを高可用性 VMware VM としてセットアップするには、用意されている Open Virtualization Format (OVF) テンプレートをダウンロードし、そのテンプレートを VMware にインポートして VM を作成します。 構成サーバーをセットアップしたら、それをコンテナーに登録します。 登録すると、Site Recovery によってオンプレミスの VMware VM が検出されます。

### <a name="download-the-vm-template"></a>VM テンプレートをダウンロードする

1. コンテナーで、**[インフラストラクチャの準備]** > **[ソース]** の順に移動します。
2. **[ソースの準備]** で **[+構成サーバー]** を選択します。
3. **[サーバーの追加]** で、**[サーバーの種類]** に **[VMware の構成サーバー]** が表示されていることを確認します。
4. 構成サーバー用の OVF テンプレートをダウンロードします。

  > [!TIP]
  構成サーバー テンプレートの最新バージョンは、[Microsoft ダウンロード センター](https://aka.ms/asrconfigurationserver)から直接ダウンロードできます。

## <a name="import-the-template-in-vmware"></a>VMware にテンプレートをインポートする

1. VMWare vSphere Client を使って、VMware vCenter サーバーまたは vSphere ESXi ホストにサインインします。
2. **[File]\(ファイル\)** メニューの **[Deploy OVF Template]\(OVF テンプレートのデプロイ\)** を選び、Deploy OVF Template (OVF テンプレートのデプロイ) ウィザードを起動します。 

     ![OVF テンプレート](./media/vmware-azure-tutorial/vcenter-wizard.png)

3. **[Select source]\(ソースの選択\)** で、ダウンロードした OVF の場所を入力します。
4. **[Review details]\(詳細の確認\)** で、**[Next]\(次へ\)** を選択します。
5. **[Select name and folder]\(名前とフォルダーの選択\)** および **[Select configuration]\(構成の選択\)** は、既定の設定のままにします。
6. **[Select storage]\(ストレージの選択\)** で、パフォーマンスを最大にするために、**[Select virtual disk format]\(仮想ディスクの形式の選択\)** の **[Thick Provision Eager Zeroed]\(シック プロビジョニング Eager Zeroed\)** を選びます。
7. ウィザードの残りのページでは、既定の設定をそのまま使います。
8. **[Ready to complete]\(完了の準備\)** で、次の操作を行います。

    * 既定の設定で VM をセットアップするには、**[Power on after deployment]\(デプロイ後に電源をオンにする\)** > **[Finish]\(完了\)** の順に選びます。

    * 別のネットワーク インターフェイスを追加する場合は、**[Power on after deployment]\(デプロイ後に電源をオンにする\)** をオフにします。 続けて、**[完了]** を選択します。 既定でデプロイされる構成サーバー テンプレートの NIC は 1 つだけですが、 デプロイ後にさらに NIC を追加することができます。

## <a name="add-an-additional-adapter"></a>さらにアダプターを追加する

構成サーバーにさらに NIC を追加する場合は、サーバーをコンテナーに登録する前に追加します。 登録後のアダプターの追加はサポートされていません。

1. vSphere Client インベントリで VM を右クリックし、**[Edit Settings]\(設定の編集\)** を選びます。
2. **[Hardware]\(ハードウェア\)** で、**[Add]\(追加\)** > **[Ethernet Adapter]\(イーサネット アダプター\)** の順に選択します。 次に、**[次へ]** を選択します。
3. アダプターの種類およびネットワークを選びます。 
4. VM がオンになったときに仮想 NIC を接続するには、**[Connect at power on]\(電源をオンにしたときに接続する\)** をオンにします。 **[次へ]** > **[完了]** の順に選択します。 **[OK]** をクリックします。


## <a name="register-the-configuration-server"></a>構成サーバーを登録する 

1. VMWare vSphere Client のコンソールで、VM をオンにします。
2. VM が Windows Server 2016 のインストール エクスペリエンスで起動します。 使用許諾契約書に同意し、管理者パスワードを入力します。
3. インストールの完了後に、管理者として VM にサインインします。
4. 初めてサインインすると、Azure Site Recovery 構成ツールが起動されます。
5. 構成サーバーを Site Recovery に登録するために使う名前を入力します。 次に、**[次へ]** を選択します。
6. このツールは、VM が Azure に接続できることを確認します。 接続が確立された後、**[サインイン]** を選択して、自分の Azure サブスクリプションにサインインします。 この資格情報は、構成サーバーを登録するコンテナーにアクセスできる必要があります。
7. ツールがいくつかの構成タスクを実行した後、再起動されます。
8. 再度マシンにサインインします。 構成サーバーの管理ウィザードが自動的に起動されます。

### <a name="configure-settings-and-connect-to-vmware"></a>設定を構成し、VMware に接続する

1. 構成サーバーの管理ウィザードで **[接続の設定]** を選び、レプリケーション トラフィックを受信する NIC を選びます。 次に、**[保存]** を選択します。 構成後、この設定を変更することはできません。
2. **[Recovery Services コンテナーを選択する]** で、Azure サブスクリプションと、関連するリソース グループおよびコンテナーを選びます。
3. **[サードパーティ製ソフトウェアのインストール]** でライセンス契約に同意します。 **[ダウンロードしてインストール]** を選択して MySQL サーバーをインストールします。
4. **[VMware PowerCLI のインストール]** を選択します。 この操作を行う前に、すべてのブラウザー ウィンドウを閉じてください。 その後 **[続行]** を選択します。
5. **[アプライアンス構成の検証]** で、続行する前に前提条件が検証されます。
6. **[Configure vCenter Server/vSphere ESXi server]\(vCenter Server/vSphere ESXi サーバーの構成\)** で、レプリケートする VM が存在している vCenter サーバーまたは vSphere ホストの FQDN または IP アドレスを入力します。 サーバーがリッスンするポートを入力します。 コンテナーで VMware サーバーに使うフレンドリ名を入力します。
7. VMware サーバーに接続するために構成サーバーによって使われる資格情報を入力します。 Site Recovery はこれらの資格情報を使って、レプリケーションに利用できる VMware VM を自動的に検出します。 **[追加]**、**[続行]** の順に選択します。
8. **[仮想マシンの資格情報の構成]** で、レプリケーションが有効になったときにモビリティ サービスをマシンに自動的にインストールするために使われるユーザー名とパスワードを入力します。 Windows マシンの場合、このアカウントは、レプリケートするマシンに対するローカル管理者特権を持っている必要があります。 Linux の場合は、ルート アカウントの詳細を指定します。
9. **[構成の確定]** を選択して、登録を完了します。 
10. 登録が完了したら、Azure Portal で、構成サーバーおよび VMware サーバーがコンテナーの **[ソース]** ページの一覧に表示されていることを確認します。 その後、**[OK]** を選択して、ターゲットの設定を構成します。


Site Recovery は指定された設定を使用して VMware サーバーに接続し、VM を検出します。

> [!NOTE]
> アカウント名がポータルに表示されるまでに 15 分以上かかることがあります。 すぐに更新するには、**[構成サーバー]** > ***[<サーバー名>]*** > **[サーバーを最新の情報に更新する]** の順に選択します。

## <a name="set-up-the-target-environment"></a>ターゲット環境をセットアップする

ターゲット リソースを選択して確認します。

1. **[インフラストラクチャの準備]** > **[ターゲット]** の順に選択します。 使用する Azure サブスクリプションを選択します。
2. ターゲット デプロイ モデルを Azure Resource Manager とクラシックのどちらにするかを指定します。
3. Site Recovery によって、互換性のある Azure ストレージ アカウントとネットワークが 1 つ以上あるかどうかが確認されます。

   ![[ターゲット] タブ](./media/vmware-azure-tutorial/storage-network.png)

## <a name="create-a-replication-policy"></a>レプリケーション ポリシーを作成する

1. [Azure Portal](https://portal.azure.com) を開いて **[すべてのリソース]** を選択します。
2. **ContosoVMVault** という名前の Recovery Service コンテナーを選択します。
3. レプリケーション ポリシーを作成するには、**[Site Recovery インフラストラクチャ]** > **[レプリケーション ポリシー]** > **[+ レプリケーション ポリシー]** の順に選択します。
4. **[レプリケーション ポリシーの作成]** で、ポリシー名として「**VMwareRepPolicy**」を入力します。
5. **[RPO しきい値]** では、既定値の 60 分が使用されます。 この値で、復旧ポイントの作成頻度を指定します。 継続的なレプリケーションがこの制限を超えると、アラートが生成されます。
6. **[復旧ポイントのリテンション期間]** では、各復旧ポイントのリテンション期間に既定値の 24 時間が使用されます。 このチュートリアルでは 72 時間を使用します。 レプリケートされた VM は、期間内の任意の時点に復旧できます。
7. **[アプリ整合性スナップショットの頻度]** では、アプリ整合性スナップショットの作成頻度に既定値の 60 分が使用されます。 **[OK]** を選択してポリシーを作成します。

   ![レプリケーション ポリシーの作成](./media/vmware-azure-tutorial/replication-policy.png)

このポリシーは自動的に構成サーバーに関連付けられます。 既定でフェールバックの照合ポリシーが自動的に作成されます。 たとえば、レプリケーション ポリシーが **rep-policy** の場合、フェールバック ポリシーは **rep-policy-failback** になります。 このポリシーは、Azure からフェールバックを開始するまで使用されません。

## <a name="enable-replication"></a>レプリケーションを有効にする

VM のレプリケーションを有効にすると、Site Recovery がモビリティ サービスをインストールします。 変更が反映されてポータルに表示されるまで 15 分以上かかる場合があります。

レプリケーションを有効にするには、次の手順に従います。

1. **[アプリケーションをレプリケートする]** > **[ソース]** を選択します。
2. **[ソース]** で、構成サーバーを選択します。
3. **[マシンの種類]** で、**[仮想マシン]** を選択します。
4. **[vCenter/vSphere Hypervisor] \(vCenter/vSphere ハイパーバイザー)** で、vSphere ホストを管理する vCenter サーバーを選択するか、ホストを選択します。
5. プロセス サーバー (構成サーバー) を選択します。 **[OK]** をクリックします。
6. **[ターゲット]** で、サブスクリプションと、フェールオーバー対象の VM を作成するリソース グループを選択します。 フェールオーバー対象の VM に Azure で使用するデプロイ モデル (クラシックまたは Resource Manager) を選択します。
7. データのレプリケーションに使用する Azure Storage アカウントを選択します。
8. フェールオーバー後に作成された Azure VM が接続する Azure ネットワークとサブネットを選択します。
9. 保護の対象として選択したすべてのマシンにネットワーク設定を適用する場合は、**[選択したマシン用に今すぐ構成します。]** を選択します。 マシンごとに Azure ネットワークを選択する場合は、**[後で構成する]** を選択します。
10. **[Virtual Machines]** > **[仮想マシンの選択]** で、レプリケートする各マシンを選択します。 選択できるのは、レプリケーションを有効にできるマシンのみです。 **[OK]** をクリックします。
11. **[プロパティ]** > **[プロパティの構成]** で、モビリティ サービスをマシンに自動的にインストールするためにプロセス サーバーが使用するアカウントを選択します。
12. **[レプリケーションの設定]** > **[レプリケーション設定の構成]** で、正しいレプリケーション ポリシーが選択されていることを確認します。
13. **[レプリケーションを有効にする]** を選択します。

**[設定]** > **[ジョブ]** > **[Site Recovery ジョブ]** の順にクリックして、**保護の有効化**ジョブの進行状況を追跡できます。 **保護の最終処理**ジョブが実行されると、マシンはフェールオーバーできる状態になります。

追加する VM を監視するには、**[構成サーバー]** > **[最後の使用]** で VM の最終検出時刻を確認します。 定期検出を待たずに VM を追加するには、構成サーバーを強調表示し (選択しないでください)、**[更新]** を選択します。

## <a name="next-steps"></a>次の手順

> [!div class="nextstepaction"]
> [ディザスター リカバリーのテストを実行する](site-recovery-test-failover-to-azure.md)
