---
title: "Azure への VMware VM レプリケーションのためのマルチテナント サポート (CSP プログラム) | Microsoft Docs"
description: "マルチテナント環境に Azure Site Recovery をデプロイし、Azure Portal で CSP プログラムを使用して、オンプレミスの VMware 仮想マシン (VM) の Azure へのレプリケーション、フェールオーバー、復旧を調整する方法について説明します。"
services: site-recovery
documentationcenter: 
author: mayanknayar
manager: rochakm
editor: 
ms.assetid: 
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 02/27/2018
ms.author: manayar
ms.openlocfilehash: 532dd399d2d5fcbab616744dd02f4a95078cbb1b
ms.sourcegitcommit: 0b02e180f02ca3acbfb2f91ca3e36989df0f2d9c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/07/2018
---
# <a name="multi-tenant-support-in-azure-site-recovery-for-replicating-vmware-virtual-machines-to-azure-through-csp"></a>CSP を使用して VMware 仮想マシンを Azure にレプリケートするための Azure Site Recovery でのマルチテナントのサポート

Azure Site Recovery では、テナント サブスクリプションのマルチテナント環境をサポートします。 また、マイクロソフト クラウド ソリューション プロバイダー (CSP) プログラムを使用して作成され、管理されているテナント サブスクリプションのマルチテナントもサポートします。 この記事では、VMware と Azure 間のマルチテナント シナリオの実装と管理に関する詳細なガイダンスを示します。 テナント サブスクリプションの作成と管理の詳細については、[CSP によるマルチテナントの管理](site-recovery-manage-multi-tenancy-with-csp.md)に関するページを参照してください。

このガイダンスでは、Azure への VMware 仮想マシンのレプリケーションに関する既存のドキュメントを活用しています。 詳細については、「[Site Recovery を使用して VMware 仮想マシンを Azure にレプリケートする](site-recovery-vmware-to-azure.md)」を参照してください。

## <a name="multi-tenant-environments"></a>マルチテナント環境
主なマルチテナント モデルとして次の 3 つがあります。

* **共有ホスティング サービス プロバイダー (HSP)**: パートナーが物理インフラストラクチャを所有し、共有リソース (vCenter、データセンター、物理記憶領域など) を使用して同じインフラストラクチャ上の複数のテナントの VM をホストします。 パートナーは管理サービスとしてディザスター リカバリーの管理を提供できます。また、テナントはセルフサービス ソリューションとしてディザスター リカバリーを所有できます。

* **専用ホスティング サービス プロバイダー**: パートナーが物理インフラストラクチャを所有しますが、専用リソース (複数の vCenter、物理データストアなど) を使用して個別のインフラストラクチャ上の各テナントの VM をホストします。 パートナーは管理サービスとしてディザスター リカバリーの管理を提供できます。また、テナントはセルフサービス ソリューションとしてディザスター リカバリーを所有できます。

* **管理サービス プロバイダー (MSP)**: VM をホストする物理インフラストラクチャを顧客が所有し、パートナーがディザスター リカバリーを有効にして管理します。

## <a name="shared-hosting-multi-tenant-guidance"></a>共有ホスティング マルチテナント ガイダンス
このセクションでは、共有ホスティング シナリオについて詳しく説明します。 他の 2 つのシナリオは共有ホスティング シナリオのサブセットであり、同じ原則を使用します。 違いについては、この共有ホスティング ガイダンスの最後に説明します。

マルチテナント シナリオの基本要件は、さまざまなテナントを分離することです。 テナントは別のテナントがホストしている内容を観察できないようにする必要があります。 この要件はセルフサービス環境では非常に重要な場合がありますが、パートナー管理された環境ではセルフサービス環境ほど重要ではありません。 このガイダンスは、テナントの分離が必須であることを前提としています。

アーキテクチャは、次の図のようになります。

![1 つ の vCenter を使用する共有 HSP](./media/site-recovery-multi-tenant-support-vmware-using-csp/shared-hosting-scenario.png)  
**1 つの vCenter を使用する共有ホスティング シナリオ**

上の図に示すように、各顧客は個別の管理サーバーを所有します。 この構成により、テナントによるアクセスをテナント固有の VM に制限し、テナントを分離できます。 VMware 仮想マシンのレプリケーション シナリオでは、構成サーバーを使用して、VM の検出とエージェントのインストールに使用するアカウントを管理します。 vCenter アクセス制御による VM の検出の制限を追加することによって、マルチテナント環境にも同じ原則が適用されます。

データ分離要件では、機密性の高いすべてのインフラストラクチャ情報 (アクセス資格情報など) がテナントに非公開のままであることが必要です。 そのため、管理サーバーのすべてのコンポーネントをパートナーの排他的制御下に置くことをお勧めします。 管理サーバーのコンポーネントは、次のとおりです。
* 構成サーバー (CS)
* プロセス サーバー (PS)
* マスター ターゲット サーバー (MT)

スケールアウト PS もパートナーの制御下にあります。

### <a name="every-cs-in-the-multi-tenant-scenario-uses-two-accounts"></a>マルチテナント シナリオのすべての CS が使用する 2 つのアカウント

- **vCenter アクセス アカウント**: このアカウントはテナントの VM を検出するのに使用されます。 このアカウントには、vCenter のアクセス許可が割り当てられています (次のセクションで説明)。 偶発的なアクセス リークを防ぐために、パートナーはこれらの資格情報を自分で構成ツールに入力することをお勧めします。

- **仮想マシン アクセス アカウント**: このアカウントを使用して、自動プッシュによってテナントの VM にモビリティ エージェントをインストールします。 通常はドメイン アカウントであり、テナントがパートナーに提供することも、パートナーが直接管理することもできます。 テナントが詳細情報をパートナーと直接共有することを望んでいない場合、CS に時間限定でアクセスして資格情報を入力することをテナントに許可することができます。また、パートナーの支援を得て、テナントがモビリティ エージェントを手動でインストールすることもできます。

### <a name="requirements-for-a-vcenter-access-account"></a>vCenter アクセス アカウントの要件

前のセクションで説明したように、CS は特別なロールが割り当てられたアカウントで構成する必要があります。 このロールの割り当ては、各 vCenter オブジェクトの vCenter アクセス アカウントに適用され、子オブジェクトには伝達されないようにする必要があります。 アクセスが伝達されると、他のオブジェクトに誤ってアクセスする可能性があるため、この構成によってテナントの分離を確保できます。

![[Propagate to Child Objects]\(子オブジェクトに伝達\) オプション](./media/site-recovery-multi-tenant-support-vmware-using-csp/assign-permissions-without-propagation.png)

別の方法として、データセンター オブジェクトにユーザー アカウントとロールを割り当て、子オブジェクトに伝達します。 その後、特定のテナントにアクセスできないようにする必要があるすべてのオブジェクト (他のテナントの VM など) について、"*アクセスなし*" ロールをアカウントに付与します。 すべての新しい子オブジェクトにも、親から継承されたアクセス権が自動的に付与されるので、この構成は煩雑であると同時に、予期しないアクセス制御が行われます。 そのため、最初の方法を使用することをお勧めします。

vCenter アカウントのアクセス手順は次のとおりです。

1. 定義済みの "*読み取り専用*" ロールを複製して新しいロールを作成してから、ロールにわかりやすい名前を付けます (この例では Azure_Site_Recovery)。

2. このロールに次のアクセス許可を割り当てます。

    * **データストア**: 領域の割り当て、データストアの参照、低レベルのファイル操作、ファイルの削除、仮想マシン ファイルの更新

    * **ネットワーク**: ネットワークの割り当て

    * **リソース**: リソース プールへの VM の割り当て、電源がオフの VM の移行、電源がオンの VM の移行

    * **タスク**: タスクの作成、タスクの更新

    * **仮想マシン**: 
        * 構成 > すべて
        * 相互作用 > 質問への回答、デバイス接続、CD メディアの構成、フロッピー メディアの構成、電源オフ、電源オン、VMware ツールのインストール
        * インベントリ > 既存のものから作成、新規作成、登録、登録解除
        * プロビジョニング > 仮想マシンのダウンロードの許可、仮想マシン ファイルのアップロードの許可
        * スナップショットの管理 > スナップショットの削除

    ![[ロールの編集] ダイアログ ボックス](./media/site-recovery-multi-tenant-support-vmware-using-csp/edit-role-permissions.png)

3. 次のように、さまざまなオブジェクトの vCenter アカウント (テナントの CS で使用) にアクセス レベルを割り当てます。

>| オブジェクト | 役割 | 解説 |
>| --- | --- | --- |
>| vCenter | 読み取り専用 | さまざまなオブジェクトを管理するために vCenter によるアクセスを許可する場合にのみ必要です。 このアカウントをテナントに提供することも、vCenter での管理操作に使用することもない場合は、このアクセス許可を削除できます。 |
>| データセンター | Azure_Site_Recovery |  |
>| ホストとホスト クラスター | Azure_Site_Recovery | フェールオーバー前とフェールバック後にアクセス可能なホストだけがテナントの VM を保持するように、アクセスがオブジェクト レベルであることを再確認します。 |
>| データストアとデータストア クラスター | Azure_Site_Recovery | 同上 |
>| ネットワーク | Azure_Site_Recovery |  |
>| 管理サーバー | Azure_Site_Recovery | CS マシンの外部にあるすべてのコンポーネント (CS、PS、MT) へのアクセスが含まれます。 |
>| テナント VM | Azure_Site_Recovery | 特定のテナントのすべての新しいテナント VM もこのアクセスを確実に取得します。そうしないと、Azure Portal から検出できなくなります。 |

これで vCenter アカウントのアクセスが完了しました。 この手順は、フェールバック操作を完了するための最小限のアクセス許可要件を満たしています。 これらのアクセス許可を既存のポリシーで使用することもできます。 既存のアクセス許可セットを変更して、手順 2. で説明したロールのアクセス許可を追加するだけです。

フェールオーバー状態 (フェールバック機能なし) になるまでディザスター リカバリー操作を制限するには、上記の手順に従いますが、例外として、vCenter アクセス アカウントに *Azure_Site_Recovery* ロールを割り当てるのではなく、"*読み取り専用*" ロールだけをこのアカウントに割り当てます。 このアクセス許可セットでは、VM のレプリケーションとフェールオーバーは許可されますが、フェールバックは許可されません。 上記のプロセスの他のすべてのものはそのままになります。 テナントの分離を確保し、VM の検出を制限するために、すべてのアクセス許可が引き続きオブジェクト レベルでのみ割り当てられ、子オブジェクトには伝達されません。

## <a name="other-multi-tenant-environments"></a>その他のマルチテナント環境

上記のセクションでは、共有ホスティング ソリューションのマルチテナント環境のセットアップ方法について説明しました。 他の 2 つの主要ソリューションは、専用ホスティングと管理されたサービスです。 これらのソリューションのアーキテクチャは、次のセクションで説明します。

### <a name="dedicated-hosting-solution"></a>専用ホスティング ソリューション

次の図に示すように、専用ホスティング ソリューションのアーキテクチャの違いは、各テナントのインフラストラクチャがそのテナントに対してのみ設定されていることです。 テナントは個別の vCenter によって分離されているため、この場合も、ホスティング プロバイダーは共有ホスティング用の CSP の手順に従う必要がありますが、テナントの分離を気にする必要はありません。 CSP のセットアップに変わりはありません。

![architecture-shared-hsp](./media/site-recovery-multi-tenant-support-vmware-using-csp/dedicated-hosting-scenario.png)  
**複数の vCenter を使用する専用ホスティング シナリオ**

### <a name="managed-service-solution"></a>管理されたサービス ソリューション

次の図に示すように、管理されたサービス ソリューションのアーキテクチャの違いは、各テナントのインフラストラクチャが他のテナントのインフラストラクチャから物理的にも分離されていることです。 通常、このシナリオは、テナントがインフラストラクチャを所有し、ソリューション プロバイダーにディザスター リカバリーを管理してもらう場合に発生します。 この場合も、テナントは異なるインフラストラクチャによって物理的に分離されているため、パートナーは共有ホスティング用の CSP の手順に従う必要がありますが、テナントの分離を気にする必要はありません。 CSP のプロビジョニングに変わりはありません。

![architecture-shared-hsp](./media/site-recovery-multi-tenant-support-vmware-using-csp/managed-service-scenario.png)  
**複数の vCenter を使用する管理されたサービス シナリオ**

## <a name="next-steps"></a>次の手順
Azure Site Recovery デプロイを管理するためのロールベースのアクセス制御に関する[詳細を確認します](site-recovery-role-based-linked-access-control.md)。

[CSP によるマルチテナントの管理](site-recovery-manage-multi-tenancy-with-csp.md)
