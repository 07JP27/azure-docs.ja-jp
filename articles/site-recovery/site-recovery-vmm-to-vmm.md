<properties
	pageTitle="Azure ポータルを使用して VMM クラウド内の Hyper-V 仮想マシンをセカンダリ VMM サイトにレプリケートする | Microsoft Azure"
	description="Azure ポータルを使用して Azure Site Recovery をデプロイし、VMM クラウド内の Hyper-V VM のセカンダリ VMM サイトへのレプリケーション、フェールオーバー、復旧を調整する方法を説明します。"
	services="site-recovery"
	documentationCenter=""
	authors="rayne-wiselman"
	manager="jwhit"
	editor=""/>

<tags
	ms.service="site-recovery"
	ms.workload="backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="08/23/2016"
	ms.author="raynew"/>

# Azure ポータルを使用して VMM クラウド内の Hyper-V 仮想マシンをセカンダリ VMM サイトにレプリケートする

> [AZURE.SELECTOR]
- [Azure ポータル](site-recovery-vmm-to-vmm.md)
- [クラシック ポータル](site-recovery-vmm-to-vmm-classic.md)
- [PowerShell - Resource Manager](site-recovery-vmm-to-vmm-powershell-resource-manager.md)

Azure Site Recovery へようこそ。 この記事では、System Center Virtual Machine Manager (VMM) クラウドで管理されているオンプレミスの Hyper-V 仮想マシンをセカンダリ サイトにレプリケートする方法について説明します。この記事では、Azure ポータルで Azure Site Recovery を使用してレプリケーションを設定する方法について説明します。

> [AZURE.NOTE] Azure には、リソースの作成と操作に関して、Azure Resource Manager とクラシックの 2 種類の[デプロイメント モデル](../resource-manager-deployment-model.md)があります。また、Azure にも 2 つのポータルがあります。クラシック デプロイメント モデルをサポートする Azure クラシック ポータルと、両方のデプロイメント モデルをサポートする Azure ポータルです。


Azure ポータルの Azure Site Recovery には、いくつかの新機能が用意されています。

- Azure ポータルでは、Azure Backup サービスと Azure Site Recovery サービスが 1 つの Recovery Services コンテナーに統合されているため、ビジネス継続性と障害復旧 (BCDR) を 1 つの場所から設定して管理できます。統合されたダッシュボードでは、オンプレミス サイトと Azure パブリック クラウドの両方に対する監視と管理の操作が可能です。
- Azure サブスクリプションがクラウド ソリューション プロバイダー (CSP) プログラムを使用してプロビジョニングされたユーザーは、Azure ポータルで Site Recovery 操作を管理できるようになりました。


この記事に関するコメントがありましたら、下部にある Disqus コメント欄に投稿してください。技術的な質問については、[Azure Recovery Services フォーラム](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr)に投稿してください。


## 概要

組織には、予定されたダウンタイムおよび予定外のダウンタイム時にアプリ、ワークロード、およびデータの実行と利用可能な状態を維持し、できるだけ早く通常の動作状態に復旧させる方法を決定する BCDR の戦略が必要です。BCDR 戦略は、災害発生時にビジネス データを安全かつ回復可能な状態に維持し、ワークロードが継続的に利用可能な状態に保たれるようなものである必要があります。

Site Recovery とは、クラウド (Azure) またはセカンダリ データセンターへのオンプレミスの物理サーバーおよび仮想マシンのレプリケーションを統制することで BCDR 戦略を支援する Azure サービスです。プライマリ ロケーションで障害が発生した場合は、セカンダリ ロケーションにフェールオーバーしてアプリとワークロードの可用性を維持します。プライマリの場所が通常の動作に戻ると、その場所にフェールバックします。詳細については、[Site Recovery](site-recovery-overview.md) に関するページをご覧ください。

この記事には、VMM クラウドにあるオンプレミスの Hyper-V VM をセカンダリ VMM サイトにレプリケートするために必要となる情報がすべて記載されています。この情報には、アーキテクチャの概要、計画の詳細、およびオンプレミス サーバー、レプリケーション設定、キャパシティ プランニングを構成するためのデプロイメント手順が含まれます。インフラストラクチャをセットアップした後で、保護するマシンでレプリケーションを有効にし、フェールオーバーが機能することを確認します。

## ビジネス上の利点

- Site Recovery を使用すると、Hyper-V VM で実行されているビジネスのワークロードやアプリケーションをセカンダリ Hyper-V サーバーにレプリケートすることで、保護を構成できます。
- Recovery Services ポータルでは、1 つの場所でレプリケーション、フェールオーバー、および復旧のセットアップ、管理、および監視を実行できます。
- プライマリ オンプレミス インフラストラクチャからセカンダリ サイトへのフェールオーバーと、セカンダリ サイトからプライマリへのフェールバック (復元) を簡単に実行できます。
- 複数のマシンを使用した復旧計画を構成し、階層化されたアプリケーション ワークロードをまとめてフェールオーバーできます。

## シナリオのアーキテクチャ

シナリオの構成要素を次に示します。

- **プライマリ サイト**: プライマリ サイトには、レプリケートするソース VM を実行する Hyper-V ホスト サーバーが 1 つ以上あります。これらのプライマリ ホスト サーバーは VMM プライベート クラウドにあります。
- **セカンダリ サイト**: セカンダリ サイトには、プライマリ VM のレプリケート先のターゲット VM を実行する Hyper-V ホスト サーバーが 1 つ以上あります。これらのホスト サーバーは VMM プライベート クラウドにあります。このクラウドは、プライマリ サーバー (VMM サーバーが 1 つしかない場合) またはセカンダリ VMM サーバーに配置できます。
- **プロバイダー**: Site Recovery をデプロイするときに、VMM サーバーに Azure Site Recovery Provider をインストールし、Recovery Services コンテナーにこれらのサーバーを登録します。VMM サーバーで実行されるプロバイダーは、HTTPS 443 経由で Site Recovery と通信し、オーケストレーションをレプリケートします。データのレプリケーションは、プライマリとセカンダリの Hyper-V ホスト サーバー間で実行されます。レプリケートされたデータは、オンプレミスのサイトとネットワークにとどまり、Azure には送信されません。詳細については、[プライバシー](#privacy-information-for-site-recovery)に関するセクションをご覧ください。

![E2E トポロジ](./media/site-recovery-vmm-to-vmm/architecture.png)

### データのプライバシーの概要

次の表は、このシナリオでデータを格納する方法をまとめたものです。
****
アクション | **詳細** | **収集されるデータ** | **最初の起動時にドメインに参加しているマシンになるように VM をプロビジョニングするには、** | **必須**
--- | --- | --- | --- | ---
**登録** | Recovery Services コンテナーに VMM サーバーを登録します。後で登録を解除する場合は、Azure ポータルからサーバー情報を削除すれば解除できます。 | VMM サーバーが登録された後、VMM サーバーに関するメタデータと、Site Recovery によって検出された VMM クラウドの名前が、収集、処理、転送されます。 | これらのデータを使用して、適切な VMM サーバーの識別と通信、および適切な VMM クラウドの設定の構成が実行されます。 | この機能は必須です。この情報を Site Recovery に送信することを希望しない場合は、Site Recovery サービスは使用しないでください。
**Enable replication** | Azure Site Recovery プロバイダーが VMM サーバーにインストールされ、Site Recovery サービスと通信するためのパイプの役割を果たします。プロバイダーは、VMM プロセスでホストされているダイナミック リンク ライブラリ (DLL) です。プロバイダーをインストールすると、VMM 管理者コンソールで「Datacenter Recovery」機能が有効になります。新規の VM および既存の VM は、この機能を有効にして、VM の保護を有効にすることができます。 | このプロパティを設定すると、プロバイダーは VM の名前と ID を Site Recovery に送信します。レプリケーションは、Windows Server 2012 または Windows Server 2012 R2 Hyper-V レプリカによって実現されます。仮想マシンのデータは、1 つの Hyper-V ホストから (通常は別の "復旧" データ センターにある) 別の Hyper-V ホストにレプリケートされます。 | Site Recovery では、メタデータを使用して、Azure ポータルに VM の情報を設定します。 | これは、本サービスに必要不可欠であり、無効にすることはできません。この情報を送信することを希望しない場合は、VM に対して Site Recovery 保護を有効にしないでください。プロバイダーによって Site Recovery に送信されるすべてのデータは、HTTPS を介して送信されます。
**復旧計画** | 復旧計画を使用して、復旧データ センターのオーケストレーション計画を作成できます。VM または仮想マシンのグループを復旧サイトで起動する順序を定義できます。さらに、各 VM の復旧時に、実行する任意の自動化スクリプトまたは任意の手動による操作を指定することができます。フェールオーバーは、通常、調整された復旧を行う復旧計画レベルでトリガーされます。 | Site Recovery は、仮想マシンのメタデータ、すべての自動スクリプトおよび手動アクションのメモのメタデータなど、復旧計画のメタデータを収集、処理、および送信します。 | これらのメタデータは、Azure ポータルで復旧計画を作成するために使用されます。 | これは、本サービスに必要不可欠であり、無効にすることはできません。この情報を Site Recovery に送信することを希望しない場合は、復旧計画は作成しないでください。
**ネットワーク マッピング** | プライマリ データ センターから復旧データ センターにネットワークの情報をマップすることができます。ネットワーク マッピングは、VM を復旧サイトで復旧する際にネットワーク接続を確立するのに役立ちます。 | Site Recovery は、各サイト (プライマリ サイトとデータ センター) の論理ネットワークのメタデータを収集、処理、および送信します。 | これらのメタデータは、ネットワーク情報をマップできるようにネットワーク設定を入力するために使用されます。 | これは、本サービスに必要不可欠であり、無効にすることはできません。この情報を Site Recovery に送信することを希望しない場合は、ネットワーク マッピングは使用しないでください。
**フェールオーバー (計画済み/計画外/テスト)** | フェールオーバーは VMM 管理対象データ センター間で実行されます。フェールオーバー アクションは、Azure ポータルで手動でトリガーされます。 | VMM サーバー上のプロバイダーは、Site Recovery からフェールオーバー イベントの通知を受け取ると、VMM インターフェイスを介して Hyper-V ホスト上でフェールオーバー アクションを実行します。VM の実際のフェールオーバーは、Hyper-V ホスト間で実行され、Windows Server 2012 または Windows Server 2012 R2 の Hyper-V レプリカによって処理されます。フェールオーバーが完了した後、復旧データ センターの VMM サーバー上のプロバイダーから処理の成功を示す情報が Site Recovery に送信されます。 | Site Recovery は、受け取った情報を使用して、Azure ポータルのフェールオーバー アクション情報の状態を設定します。 | これは、本サービスに必要不可欠であり、無効にすることはできません。この情報を Site Recovery に送信することを希望しない場合は、フェールオーバーは使用しないでください。


## Azure の前提条件

このシナリオをデプロイするために Azure で必要なものを次に示します。

**前提条件** | **詳細**
--- | ---
**Azure**| [Microsoft Azure](http://azure.microsoft.com/) アカウントが必要です。アカウントがなくても、[無料試用版](https://azure.microsoft.com/pricing/free-trial/)を使用できます。Site Recovery の価格の詳細については、[こちら](https://azure.microsoft.com/pricing/details/site-recovery/)をご覧ください。


## オンプレミスの前提条件

このシナリオをデプロイするためにプライマリとセカンダリのオンプレミス サイトで必要なものを次に示します。

**前提条件** | **詳細**
--- | ---
**VMM** | プライマリ サイトとセカンダリ サイトに VMM サーバーを 1 台ずつデプロイすることをお勧めします。<br/><br/> また、[単一の VMM サーバー上のクラウド間でレプリケートする](site-recovery-single-vmm.md)こともできます。これを行うには、VMM サーバーに少なくとも 2 つのクラウドが構成されている必要があります。<br/><br/> VMM サーバーは、最新の更新プログラムがインストールされている System Center 2012 SP1 以降を実行している必要があります。<br/><br/> 各 VMM サーバーには 1 つ以上のクラウドが構成され、すべてのクラウドには Hyper-V キャパシティ プロファイルが設定されている必要があります。<br/><br/>クラウドには 1 つ以上の VMM ホスト グループが含まれている必要があります。<br/><br/>VMM クラウドの設定の詳細については、[VMM クラウド ファブリックの構成](https://msdn.microsoft.com/library/azure/dn469075.aspx#BKMK_Fabric)に関するページ、および [System Center 2012 SP1 VMM を使用したプライベート クラウド作成のチュートリアル](http://blogs.technet.com/b/keithmayer/archive/2013/04/18/walkthrough-creating-private-clouds-with-system-center-2012-sp1-virtual-machine-manager-build-your-private-cloud-in-a-month.aspx)をご覧ください。<br/><br/> VMM サーバーは、インターネットにアクセスできる必要があります。
**Hyper-V** | Hyper-V サーバーは、Hyper-V ロールがインストールされた Windows Server 2012 以降が実行され、最新の更新プログラムがインストールされている必要があります。<br/><br/> Hyper-V サーバーには 1 台以上の VM が含まれている必要があります。<br/><br/> Hyper-V ホスト サーバーが、プライマリおよびセカンダリの VMM クラウドに配置されている必要があります。<br/><br/> Hyper-V を Windows Server 2012 R2 上のクラスターで実行している場合は、[更新プログラム 2961977](https://support.microsoft.com/kb/2961977) をインストールする必要があります。<br/><br/> Hyper-V を Windows Server 2012 上のクラスターで実行する場合、静的 IP アドレス ベースのクラスターがあると、クラスター ブローカーは自動的には作成されないことに注意してください。クラスター ブローカーを手動で構成する必要があります。詳細については、[こちら](http://social.technet.microsoft.com/wiki/contents/articles/18792.configure-replica-broker-role-cluster-to-cluster-replication.aspx)を参照してください。
**プロバイダー** | Site Recovery をデプロイする際に、Azure Site Recovery Provider を VMM サーバーにインストールします。プロバイダーは、HTTPS 443 経由で Azure Site Recovery と通信して、レプリケーションを調整します。データのレプリケーションは、LAN または VPN 接続を経由してプライマリとセカンダリの Hyper-V サーバー間で実行されます。<br/><br/> VMM サーバー上で実行されるプロバイダーでは、*.hypervrecoverymanager.windowsazure.com、*.accesscontrol.windows.net、*.backup.windowsazure.com、*.blob.core.windows.net、*.store.core.windows.net の各 URL へのアクセスを許可する必要があります。<br/><br/> また、VMM サーバーから [Azure データセンターの IP 範囲](https://www.microsoft.com/download/confirmation.aspx?id=41653)へのファイアウォール通信と、HTTPS (443) プロトコルの使用を許可する必要があります。

## デプロイの準備をする

デプロイを準備するには、次の手順に従います。

1. Site Recovery のデプロイ用に [VMM サーバーを準備する](#prepare-the-vmm-server)。
2. [ネットワーク マッピングを準備する](#prepare-for-network-mapping)。ネットワーク マッピングを構成できるように、ネットワークをセットアップする。

### VMM サーバーを準備する

VMM サーバーが[前提条件](#on-premises-prerequisites)に準拠していることと、一覧の URL にアクセスできることを確認します。


### 計画ガイドの「ネットワーク マッピングを準備」

ネットワーク マッピングは、プライマリ VMM サーバーとセカンダリ VMM サーバーの VMM VM ネットワークをマップすることで、次の項目を実現します。

- フェールオーバー後にセカンダリ Hyper-V ホストにレプリカ VM を最適に配置します。
- レプリカ VM を適切な VM ネットワークに接続します。
- ネットワーク マッピングを構成しない場合、レプリカ VM はフェールオーバー後にどの VM ネットワークにも接続されません。
- Site Recovery のデプロイ時にネットワーク マッピングをセットアップする場合は、次のことを実行する必要があります。

	- ソース Hyper-V ホスト サーバー上の VM が VMM VM ネットワークに接続されていることを確認します。そのネットワークは、クラウドに関連付けられた論理ネットワークにリンクされている必要があります。
	- 回復に使用するセカンダリ クラウドに、対応する VM ネットワークが構成されていることを確認します。この VM ネットワークは、セカンダリ クラウドに関連付けられた論理ネットワークにリンクされている必要があります。

- ネットワーク マッピングのしくみについては、[こちら](site-recovery-network-mapping.md)をご覧ください。

## 単一の VMM サーバーを使用したデプロイを準備する

VMM サーバーが 1 つしかない場合は、VMM クラウド内の Hyper-V ホストにある VM を [Azure](site-recovery-vmm-to-azure.md) またはセカンダリ VMM クラウドにレプリケートできます。クラウド間のレプリケートはシームレスではないため、1 つ目の選択肢をお勧めします。ただし、これを実行するには次のことを行う必要があります。

1. **Hyper-V VM で VMM をセットアップします**。この操作を行うときは、VMM によって使用される SQL Server インスタンスを同じ VM 上に配置することをお勧めします。1 つの VM を作成するだけでよいので時間節約になります。SQL Server のリモート インスタンスを使用したときに障害が発生した場合、VMM を回復するには、そのインスタンスを回復しておく必要があります。
2. **VMM サーバーに少なくとも 2 つのクラウドが構成されていることを確認します**。一方のクラウドにはレプリケートを行う VM が含まれ、もう一方のクラウドはセカンダリのロケーションとして機能します。保護する VM が含まれているクラウドは、[前提条件](#on-premises-prerequisites)を満たしている必要があります。
3. この記事で説明されているとおりに、Site Recovery をセットアップします。VMM サーバーを作成してコンテナーに登録し、レプリケーション ポリシーを設定して、レプリケーションを有効にします。初期レプリケーションがネットワーク経由で行われるように指定する必要があります。
4. ネットワーク マッピングをセットアップするときは、プライマリ クラウドの VM ネットワークをセカンダリ クラウドの VM ネットワークにマップします。
5. Hyper-V マネージャー コンソールで、VMM VM を含む Hyper-V ホスト上での Hyper-V レプリカを有効にし、それから VM 上のレプリケーションを有効にします。Site Recovery で保護されているクラウドに対して VMM 仮想マシンを追加しないようにしてください。これは、Hyper-V レプリカの設定が Site Recovery によってオーバーライドされないようにするためです。
6. フェールオーバー向けに復旧計画を作成する場合は、ソースとターゲットに同じ VMM サーバーを使用します。
7. フェールオーバーと回復は次のように実行します。

	- Hyper-V マネージャーの計画されたフェールオーバーを使用して、手動で VMM VM をセカンダリ サイトにフェールオーバーします。
	- VM をフェールオーバーします。
	- プライマリ VMM VM が回復したら、Azure ポータルにログインして [Recovery Services コンテナー] にアクセスし、セカンダリ サイトからプライマリ サイトへの VM の計画外のフェールオーバーを実行します。
	- 計画外のフェールオーバーが完了すると、プライマリ サイトからすべてのリソースに再びアクセスできるようになります。


### Recovery Services コンテナーを作成する

1. [Azure ポータル](https://portal.azure.com)にサインインします。
2. **[新規]**、**[管理]**、**[Recovery Services]** の順にクリックします。または、**[参照]**、**[Recovery Services コンテナー]**、**[追加]** の順にクリックします。

	![新しいコンテナー](./media/site-recovery-vmm-to-vmm/new-vault3.png)

3. **[名前]** に、コンテナーを識別するフレンドリ名を入力します。複数のサブスクリプションがある場合は、いずれかを選択します。
4. [新しいリソース グループを作成](../resource-group-template-deploy-portal.md)するか、既存のリソース グループを選択し、Azure リージョンを指定します。マシンは、このリージョンにレプリケートされます。サポートされているリージョンを確認するには、「[Azure Site Recovery Pricing Details (Azure Site Recovery の価格の詳細)](https://azure.microsoft.com/pricing/details/site-recovery/)」で利用可能地域を参照してください。
4. ダッシュボードからコンテナーにすばやくアクセスするには、**[ダッシュボードにピン留めする]**、**[コンテナーの作成]** の順にクリックします。

	![新しいコンテナー](./media/site-recovery-vmm-to-vmm/new-vault-settings.png)

新しいコンテナーは、**[ダッシュボード]** の **[すべてのリソース]** と、メインの **[Recovery Services コンテナー]** ブレードに表示されます。




## 使用の開始

Site Recovery に用意されている [使用の開始] エクスペリエンスを利用すると、最小限の時間でデプロイできます。[作業の開始] によって前提条件が確認され、Site Recovery のデプロイ手順が適切な順序で説明されます。

[作業の開始] では、レプリケートするマシンの種類とレプリケート先の場所を選択します。オンプレミス サーバーをセットアップし、レプリケーション ポリシーを作成して、キャパシティ プランニングを実施します。インフラストラクチャのセットアップが完了したら、VM のレプリケーションを有効にします。特定のマシンのフェールオーバーを実行することも、複数のマシンをフェールオーバーする復旧計画を作成することもできます。

[作業の開始] では、まず、Site Recovery をデプロイする方法を選択します。作業の開始フローは、レプリケーションの要件によって多少変化します。

## ステップ 1: 保護の目標を選択する

レプリケートの対象とレプリケート先を選択します。

1. **[Recovery Services コンテナー]** ブレードでコンテナーを選択し、**[設定]** をクリックします。
2. **[設定]** の **[作業の開始]** で、**[Site Recovery]**、**[手順 1: インフラストラクチャを準備する]**、**[保護の目標]** の順にクリックします。
3. **[保護の目標]** で、**[復旧サイトへ]** を選択し、**[Yes, with Hyper-V (はい、Hyper-V を使用します)]** を選択します。
4. Hyper-V ホストの管理に VMM を使用していることを示すために**[はい]** を選択します。また、セカンダリ VMM サーバーがある場合は **[はい]** を選択します。単一の VMM サーバー上にあるクラウド間にレプリケーションをデプロイする場合は、**[いいえ]** をクリックします。次に、 **[OK]** をクリックします

	![Choose goals](./media/site-recovery-vmm-to-vmm/choose-goals.png)


## ステップ 2: ソース環境をセットアップする

Azure Site Recovery プロバイダーを VMM サーバーにインストールし、サーバーをコンテナーに登録します。

1. **[Step 2: Prepare Infrastructure (手順 2: インフラストラクチャを準備する)]**、**[ソース]** の順にクリックします。

	![Set up source](./media/site-recovery-vmm-to-vmm/goals-source.png)

2. **[ソースの準備]** で、**[+ VMM]** をクリックして、VMM サーバーを追加します。

	![Set up source](./media/site-recovery-vmm-to-vmm/set-source1.png)

2. **[サーバーの追加]** ブレードで、**[サーバーの種類]** に **System Center VMM サーバー**が表示され、その VMM サーバーが[前提条件と URL 要件](#on-premises-prerequisites)を満たしていることを確認します。
4. Azure Site Recovery プロバイダーのインストール ファイルをダウンロードします。
5. 登録キーをダウンロードします。セットアップを実行する際に、このキーが必要になります。キーは生成後 5 日間有効です。

	![Set up source](./media/site-recovery-vmm-to-vmm/set-source3.png)

6. VMM サーバーに Azure Site Recovery プロバイダーをインストールします。

> [AZURE.NOTE] Hyper-V ホスト サーバーには何も明示的にインストールする必要はありません。


### Azure Site Recovery プロバイダーのセットアップ

1. 各 VMM サーバーでプロバイダーのセットアップ ファイルを実行します。プロバイダーを初めてインストールするときに、VMM がクラスターにデプロイされている場合は、プロバイダーをアクティブなノードにインストールします。インストールが終了したら、VMM サーバーをコンテナーに登録します。次に、プロバイダーを他のノードにインストールします。すべてのクラスター ノードが同じバージョンのプロバイダーを実行する必要があります。
2. セットアップに伴って、いくつかの前提条件チェックが実行され、VMM サービスを停止するアクセス許可が要求されます。セットアップが完了すると、VMM サービスは自動的に再起動されます。VMM クラスターにインストールしている場合は、クラスター ロールを停止するよう求められます。

2.  **[Microsoft Update]** で更新プログラムを登録すると、Microsoft Update ポリシーに従ってプロバイダーの更新プログラムがインストールされます。
3. **[インストール]** で、プロバイダーの既定のインストール先をそのまま使用するか、インストール先を変更して、**[インストール]** をクリックします。

	![インストール場所](./media/site-recovery-vmm-to-vmm/provider-location.png)

3. インストールが完了したら、**[登録]** をクリックして、サーバーをコンテナーに登録します。

	![インストール場所](./media/site-recovery-vmm-to-vmm/provider-register.png)

9. **[コンテナー名]** で、サーバーが登録されるコンテナーの名前を確認します。*[次へ]* をクリックします。

	![サーバー登録](./media/site-recovery-vmm-to-vmm-classic/vaultcred.PNG)

7. **[インターネット接続]** で、VMM サーバーで実行中のプロバイダーがインターネットに接続する方法を指定します。**[Connect with existing proxy settings (既存のプロキシ設定を使用して接続する)]** を選択して、サーバー上に構成されている既定のインターネット接続設定を使用します。

	![インターネット設定](./media/site-recovery-vmm-to-vmm-classic/proxydetails.PNG)

	- カスタム プロキシを使用する場合は、プロバイダーをインストールする前に設定する必要があります。カスタム プロキシ設定を構成すると、プロキシの接続を確認するためのテストが実施されます。
	- カスタム プロキシを使用する場合、または既定のプロキシで認証が必要な場合は、プロキシのアドレスやポートなどの詳細を入力する必要があります。
	- VMM サーバーと Hyper-V ホストから次の URL にアクセスできる必要があります。
		- *.hypervrecoverymanager.windowsazure.com
		- *.accesscontrol.windows.net
		- *.backup.windowsazure.com
		- *.blob.core.windows.net
		- *.store.core.windows.net
	- 「[Azure Datacenter の IP 範囲](https://www.microsoft.com/download/confirmation.aspx?id=41653)」に記載されている IP アドレスと HTTPS (443) プロトコルを許可します。使用を計画している Azure リージョンの IP の範囲と米国西部の IP の範囲をホワイトリストに登録する必要があります。
	- カスタム プロキシを使用する場合、指定されたプロキシの資格情報を使用して VMM RunAs アカウント (DRAProxyAccount) が自動的に作成されます。このアカウントが正しく認証されるようにプロキシ サーバーを構成します。VMM RunAs アカウントの設定は VMM コンソールで変更できます。変更するには、**[設定]** ワークスペースを開いて **[セキュリティ]** を展開し、**[実行アカウント]** をクリックします。その後、DRAProxyAccount のパスワードを変更します。新しい設定を有効にするには、VMM サービスを再起動する必要があります。


8. **[登録キー]** で、Azure Site Recovery からダウンロードして VMM サーバーにコピーした登録キーを選択します。


10.  暗号化設定は、VMM クラウド内の Hyper-V VM を Azure にレプリケートする場合のみ使用されます。セカンダリ サイトにレプリケートする場合は使用されません。

11.  **[サーバー名]** に、コンテナーで VMM サーバーを識別する表示名を入力します。クラスター構成で、VMM クラスターのロール名を指定します。
12.  **[クラウド メタデータの同期]** で、VMM サーバー上のすべてのクラウドのメタデータをコンテナーと同期するかどうかを選択します。この操作は、各サーバーで 1 回のみ実行する必要があります。すべてのクラウドを同期したくない場合は、この設定をオフのままにして、VMM コンソールのクラウドのプロパティで各クラウドを個別に同期できます。

13.  **[次へ]** をクリックしてプロセスを完了します。登録後に、VMM サーバーからのメタデータが、Azure Site Recovery によって取得されます。サーバーは、コンテナーの **[サーバー]** ページの **[VMM サーバー]** タブに表示されます。

	![サーバー](./media/site-recovery-vmm-to-vmm-classic/provider13.PNG)

11. Site Recovery コンソールでサーバーが利用できるようになったら、**[ソース]** の **[ソースの準備]** で、VMM サーバーを選択し、Hyper-V ホストが配置されているクラウドを選択します。次に、 **[OK]** をクリックします

#### コマンド ラインを使用したインストール

Azure Site Recovery プロバイダーは、コマンド ラインからインストールできます。この方法を使用すると、Windows Server 2012 R2 の Server Core にプロバイダーをインストールできます。

1. プロバイダーのインストール ファイルと登録キーをフォルダーにダウンロードします。たとえば、C:\\ASR です。
2. System Center Virtual Machine Manager サービスを停止します。
3. 管理者特権のコマンド プロンプトで次のコマンドを実行して、プロバイダーのインストーラーを抽出します。

    	C:\Windows\System32> CD C:\ASR
    	C:\ASR> AzureSiteRecoveryProvider.exe /x:. /q

4. 次のコマンドを実行して、プロバイダーをインストールします。

    	C:\ASR> setupdr.exe /i

5. 次のコマンドを実行して、コンテナーにサーバーを登録します。

    	CD C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin
    	C:\Program Files\Microsoft System Center 2012 R2\Virtual Machine Manager\bin> DRConfigurator.exe /r  /Friendlyname <friendly name of the server> /Credentials <path of the credentials file> /EncryptionEnabled <full file name to save the encryption certificate>     

パラメーターは、次のとおりです。

 - **/Credentials**: 登録キー ファイルが配置されている場所を指定する必須パラメーターです。
 - **/Friendlyname**: Azure Site Recovery ポータルに表示される、Hyper-V ホスト サーバーの名前を表す必須パラメーターです。
 - **/EncryptionEnabled**: 省略可能。VMM から Azure にレプリケートする場合にのみ使用します。
 - **/proxyAddress**: 省略可能。プロキシ サーバーのアドレスを指定します。
 - **/proxyport**: 省略可能。プロキシ サーバーのポートを指定します。
 - **/proxyUsername**: 省略可能。プロキシのユーザー名を指定します (認証が必要なプロキシの場合)。
 - **/proxyPassword**: 省略可能。プロキシ サーバーの認証に使用するパスワードを指定します (認証が必要なプロキシの場合)。

## ステップ 3: ターゲット環境をセットアップする

ターゲット VMM サーバーとクラウドを選択します。

1. **[インフラストラクチャの準備]**、**[ターゲット]** の順にクリックし、使用するターゲット VMM サーバーを選択します。
2.	Site Recovery と同期しているサーバー上のクラウドが表示されます。ターゲット クラウドを選択します。

	![ターゲット](./media/site-recovery-vmm-to-vmm/target-vmm.png)

## ステップ 4: レプリケーション設定をセットアップする

1. 新しいレプリケーション ポリシーを作成するには、**[インフラストラクチャの準備]**、**[レプリケーション設定]**、**[+ 作成と関連付け]** の順にクリックします。

	![ネットワーク](./media/site-recovery-vmm-to-vmm/gs-replication.png)

2. **[ポリシーの作成と関連付け]** で、ポリシー名を指定します。ソースとターゲットの種類は **Hyper-V** にする必要があります。
3. **[Hyper-V ホストのバージョン]** で、ホストで実行されているオペレーティング システムを選択します。

	> [AZURE.NOTE] VMM クラウドには、Windows Server の複数の (サポートされている) バージョンを実行している Hyper-V ホストを含めることができますが、レプリケーション ポリシーは、同じオペレーティング システムを実行しているホストに適用されます。複数のバージョンのオペレーティング システムを実行しているホストがある場合は、それぞれにレプリケーション ポリシーを作成します。

4. **[認証の種類]** および **[認証ポート]**で、プライマリおよび復旧用の Hyper-V ホスト サーバー間でトラフィックを認証する方法を指定します。動作している Kerberos 環境が既にある場合を除き、**[証明書]** を選択してください。Azure Site Recovery は、HTTPS 認証に使用する証明書を自動的に構成します手動では何も行う必要はありません。既定では、Hyper-V ホスト サーバーの Windows ファイアウォールで、ポート 8083 と 8084 (認証用) が開きます。**Kerberos** を選択した場合は、ホスト サーバーの相互認証に Kerberos チケットが使用されます。この設定は、Windows Server 2012 R2 で実行されている Hyper-V ホスト サーバーだけに関連することに注意してください。
3. **[コピーの頻度]** で、初期レプリケーションの後、差分データをレプリケートする頻度 (30 秒ごと、5 分ごと、または 15 分ごと) を指定します。
4. **[復旧ポイントのリテンション期間]** で、各復旧ポイントのリテンション期間の長さを時間単位で指定します。保護されたマシンはこの期間内のどのポイントにも復旧できます。
6. **[アプリ整合性スナップショットの頻度]** で、アプリケーション整合性スナップショットを含む復旧ポイントの作成頻度 (1 ～ 12 時間) を指定します。Hyper-V では 2 種類のバックアップを使用します。1 つは標準バックアップで、仮想マシン全体の増分バックアップを実行します。もう 1 つは、アプリケーション整合性スナップショットで、仮想マシン内部のアプリケーション データの特定の時点のスナップショットを作成します。アプリケーション整合性スナップショットでは、ボリューム シャドウ コピー サービス (VSS) を使用して、スナップショットを作成するときにアプリケーションを一貫性のある状態に保ちます。アプリケーション整合性スナップショットを有効にすると、ソースの仮想マシンで実行するアプリケーションのパフォーマンスに影響があります。設定する値は、追加で構成する復旧ポイントの数より少ない数にしてください。
7. **[データ転送の圧縮]** で、転送されるレプリケート済みデータを圧縮するかどうかを指定します。
8. ソース VM の保護を無効にする場合はレプリカ仮想マシンが削除される必要があることを指定するために、**[レプリカ VM の削除]** を選択します。この設定を有効にすると、ソース VM の保護を無効にしたときに、Site Recovery コンソールからのソース VM の削除、VMM コンソールからの VMM の Site Recovery 設定の削除、レプリカの削除が行われます。
3. ネットワーク経由でレプリケートする場合は、**[初期レプリケーションの方法]** で、初期レプリケーションを開始するかスケジュールを設定するかを指定します。ネットワーク帯域幅を節約するために、トラフィックの多い時間帯を避けてスケジュールを設定することをお勧めします。次に、 **[OK]** をクリックします

	![Replication policy](./media/site-recovery-vmm-to-vmm/gs-replication2.png)

6. 新しいポリシーを作成すると、自動的に VMM クラウドに関連付けられます。**[レプリケーション ポリシー]** で **[OK]** をクリックします。追加の VMM クラウド (およびその内部にある VM) を、このレプリケーション ポリシーに関連付けるには、**[設定]**、**[レプリケーション]**、ポリシー名、**[Associate VMM Cloud (VMM クラウドを関連付ける)]** の順に選択します。

	![Replication policy](./media/site-recovery-vmm-to-vmm/policy-associate.png)

### オフラインでの初期レプリケーションの準備

初期データ コピーのオフライン レプリケーションを行うことができます。この準備として、次の手順を実行します。

- ソース サーバーで、データのエクスポートを実施するパスの場所を指定します。そのエクスポート パスに対する NTFS のフル コントロール アクセス許可と共有アクセス許可を VMM サービスに付与します。ターゲット サーバーで、データのインポートを実施するパスの場所を指定します。このインポート パスに対して同じアクセス許可を割り当てます。
- インポート パスまたはエクスポート パスが共有されている場合は、その共有パスの配置先であるリモート コンピューター上の VMM サービス アカウントに対して、Administrator、Power User、Print Operator、または Server Operator グループのメンバーシップを割り当てます。
- いずれかの実行アカウントを使用してホストを追加している場合は、インポート パスおよびエクスポート パスに対する読み取りと書き込みのアクセス許可を VMM の実行アカウントに割り当てます。
- Hyper-V ではループバックの構成がサポートされていないため、インポート用の共有とエクスポート用の共有は、Hyper-V ホスト サーバーとして使用するどのコンピューターにも配置しないでください。
- Active Directory で、保護対象の仮想マシンを含む各 Hyper-V ホスト サーバーに対して、次のように制約付き委任を有効にして構成し、インポート パスとエクスポート パスの配置先であるリモート コンピューターを信頼します。
	1. ドメイン コントローラーで、**[Active Directory ユーザーとコンピューター]** を開きます。
	2. コンソール ツリーで **[ドメイン名]**、**[コンピューター]** の順にクリックします。
	3. Hyper-V ホスト サーバー名を右クリックして、 **[プロパティ]** をクリックします。
	4. **[委任]** タブで、**[指定されたサービスへの委任でのみこのコンピューターを信頼する]** をクリックします。
	5. **[任意の認証プロトコルを使う]** をクリックします。
	6. **[追加]**、**[ユーザーとコンピューター]** の順にクリックします。
	7. エクスポート パスをホストするコンピューターの名前を入力し、**[OK]** をクリックします。利用可能なサービスの一覧で、Ctrl キーを押しながら **[cifs]** をクリックし、**[OK]** をクリックします。インポート パスをホストするコンピューターの名前に対して、同じ手順を繰り返します。必要に応じて、追加の Hyper-V ホスト サーバーに対して同じ手順を繰り返します。


### ネットワーク マッピングの構成

ソース ネットワークとターゲット ネットワークの間にネットワーク マッピングをセットアップします。

- ネットワーク マッピングの概要については、[こちら](#prepare-for-network-mapping)をご覧ください。また、詳細については、[こちら](site-recovery-network-mapping.md)をご覧ください。
- VMM サーバー上の仮想マシンが VM ネットワークに接続されていることを確認します。

マッピングは次のように構成します。

1. **[設定]**、**[Site Recovery インフラストラクチャ]**、**[ネットワーク マッピング]**、**[ネットワーク マッピング]**、**[+ ネットワーク マッピング]** の順にクリックします。

	![ネットワーク マッピング](./media/site-recovery-vmm-to-azure/network-mapping1.png)

2. **[ネットワーク マッピングの追加]** タブで、ソース VMM サーバーとターゲット VMM サーバーを選択します。VMM サーバーに関連付けられている VM ネットワークが取得されます。
3. **[ソース ネットワーク]** で、プライマリ VMM サーバーに関連付けられている VM ネットワークの一覧から、使用するネットワークを選択します。
6. **[ターゲット ネットワーク]** で、セカンダリ VMM サーバーで使用するネットワークを選択します。次に、 **[OK]** をクリックします

	![ネットワーク マッピング](./media/site-recovery-vmm-to-vmm/network-mapping2.png)

ネットワーク マッピングが開始されると、次のように動作します。

- ソース VM ネットワークに対応する既存のレプリカの全仮想マシンが、ターゲット VM ネットワークに接続します。
- ソース VM ネットワークに接続する新しい仮想マシンは、レプリケーション後、マップされたターゲット ネットワークに接続します。
- 既存のマッピングを新しいネットワークで変更すると、レプリカの仮想マシンは新しい設定で接続されます。
- ターゲット ネットワークに複数のサブネットがあり、そのサブネットのいずれかが、ソースの仮想マシンが配置されているサブネットと同じ名前である場合、フェールオーバー後、レプリカの仮想マシンはそのターゲット サブネットに接続されます。ターゲットのサブネットで名前が一致するものがなければ、仮想マシンはネットワークの最初のサブネットに接続されます。

## ステップ 5: キャパシティ プランニング

基本的なインフラストラクチャをセットアップできたので、キャパシティ プランニングを立案し、追加のリソースが必要かどうかを検討できます。

Site Recovery に用意されている Excel ベースの Capacity Planner を使用して、ソース環境、Site Recovery のコンポーネント、ネットワーク、およびストレージに適切なリソースを割り当てることができます。このキャパシティ プランニング ツールは、VM、ディスク、およびストレージの平均数に基づく見積もりを使用するクイック モードか、ワークロード レベルで数値を入力する詳細モードで実行できます。開始する前に、次のことを行う必要があります。

- VM、VM あたりのディスク数、ディスクあたりのストレージなど、レプリケーション環境の情報を収集する。
- レプリケートされた差分データの 1 日の変更 (チャーン) 率を見積もる。この見積もりには、[Capacity planner for Hyper-V Replica](https://www.microsoft.com/download/details.aspx?id=39057) が役立ちます。

1.	**[ダウンロード]** をクリックしてツールをダウンロードし、実行する。ツールに付随する[こちらの記事をご覧ください](site-recovery-capacity-planner.md)。
2.	作業が完了したら、**[Have you run the Capacity Planner? (Capacity Planner を実行しましたか?)]** で **[はい]** を選択する。

	![容量計画](./media/site-recovery-vmm-to-azure/gs-capacity-planning.png)

### 帯域幅の制御

Capacity Planner の Hyper-V レプリカを使用してリアルタイムの差分レプリケーション情報を収集した後に、Excel ベースの Capacity Planner ツールでレプリケーション (初期と差分) に必要な帯域幅を計算できます。レプリケーションに使用される帯域幅の量を制御するには、グループ ポリシーまたは Windows PowerShell を使用して NetQos ポリシーを構成します。これは、次のような何通りかの方法で実行できます。

**PowerShell** | **詳細**
--- | ---
**New -NetQosPolicy "QoS to destination subnet"** | Windows Server 2012 R2 を実行している Hyper-V ホストからセカンダリ サブネットへのトラフィックを調整します。プライマリ サブネットとセカンダリ サブネットが異なる場合に使用します。
**New -NetQosPolicy "QoS to destination port"** | Windows Server 2012 R2 を実行している Hyper-V ホストから宛先ポートへのトラフィックを調整します。
**New -NetQosPolicy "Throttle traffic from VMM"** | vmms.exe からのトラフィックを調整します。これによって、Hyper-V のトラフィックとライブ マイグレーション トラフィックが調整されます。IP プロトコルとポートを照合して絞り込むことができます。

帯域幅の重み設定を使用したり、セカンダリごとのビット単位でトラフィックを制限したりすることができます。クラスターを使用している場合は、すべてのクラスター ノードでこれを行う必要があります。詳細情報


- [Hyper-V レプリカ トラフィックのスロットル](http://www.thomasmaurer.ch/2013/12/throttling-hyper-v-replica-traffic/)に関する Thomas Maurer のブログ
- [New-NetQosPolicy コマンドレット](https://technet.microsoft.com/library/hh967468.aspx)に関する詳細な情報。


## ステップ 6: レプリケーションを有効にする

レプリケーションを有効にするには、次の手順に従います。

1. **[手順 2: アプリケーションをレプリケートする]**、**[ソース]** の順にクリックします。レプリケーションを初めて有効にした後は、コンテナーで **[+ レプリケート]** をクリックして、追加のマシンのレプリケーションを有効にします。

	![Enable replication](./media/site-recovery-vmm-to-vmm/enable-replication1.png)

2. **[ソース]** ブレードで、VMM サーバーと、レプリケートする Hyper-V ホストが配置されているクラウドを選択します。次に、 **[OK]** をクリックします

	![Enable replication](./media/site-recovery-vmm-to-vmm/enable-replication2.png)

3. **[ターゲット]** ブレードで、セカンダリ VMM サーバーとクラウドを確認します。
4. **[仮想マシン]** で、保護する VM を一覧から選択します。

	![仮想マシンの保護の有効化](./media/site-recovery-vmm-to-vmm/enable-replication5.png)

**保護の有効化**アクションの進行状況を追跡するには、[設定]、**[ジョブ]**、**[Site Recovery ジョブ]** の順にクリックします。保護の**最終処理**のジョブが実行されると、仮想マシンは、フェールオーバーを実行できる状態になります。


>[AZURE.NOTE] VMM コンソールでも仮想マシンの保護を有効にできます。仮想マシンのプロパティの **[Azure Site Recovery]** タブで、ツール バーにある **[保護を有効にする]** をクリックします。

レプリケーションを有効にした後、**[設定]**、**[レプリケートされたアイテム]**、VM 名の順にクリックすると、VM のプロパティが表示されます。**[Essentials]** ダッシュボードでは、VM とその状態に関するレプリケーション ポリシーに関する情報を確認できます。**[プロパティ]** をクリックすると、詳細が表示されます。

### 既存の仮想マシンの追加

Hyper-V レプリカを使用してレプリケートされる VMM 内に既存の仮想マシンがある場合は、次の手順で Azure Site Recovery の保護にそれらの仮想マシンを追加できます。

1. 既存の VM をホストしている Hyper-V サーバーがプライマリ クラウドに存在し、レプリカ仮想マシンをホストしている Hyper-V サーバーがセカンダリ クラウドに存在することを確認します。
2. プライマリ VMM クラウドのレプリケーション ポリシーが構成されていることを確認します。
2. プライマリ仮想マシンのレプリケーションを有効にします。Azure Site Recovery と VMM によって、同じレプリカ ホストと仮想マシンが検出され、Azure Site Recovery によって、指定した設定を使用してレプリケーションの再使用と再確立が行われます。


## ステップ 7: デプロイをテストする

デプロイをテストするために、単一の仮想マシンに対してテスト フェールオーバーを実行するか、1 つ以上の仮想マシンを含む復旧計画を作成できます。

### フェールオーバーを準備する

- デプロイを完全にテストするには、レプリケートされたマシンが予想どおりに動作するインフラストラクチャが必要です。Active Directory と DNS をテストする場合は、ドメイン コントローラー兼 DNS として仮想マシンを作成し、これを Azure Site Recovery を使用して Azure にレプリケートします。Active Directory のテスト フェールオーバーの考慮事項については、[こちら](site-recovery-active-directory.md#considerations-for-test-failover)をご覧ください。
- この記事の手順では、ネットワークを使用せずにテスト フェールオーバーを実行する方法について説明しています。この方法では、VM がフェールオーバーされることをテストしますが、VM のネットワーク設定はテストしません。他の方法については、[こちら](site-recovery-failover.md#run-a-test-failover)をご覧ください。
- テスト フェールオーバーではなく計画されていないフェールオーバーを実行する場合は、次の点に注意してください。

	- 可能であれば、プライマリ マシンをシャットダウンしてから、計画されていないフェールオーバーを実行します。こうすることで、ソース マシンとレプリカ マシンが同時に実行されないように確保できます。
	- 計画されていないフェールオーバーを実行すると、プライマリ マシンのデータ レプリケーションが停止され、計画されていないフェールオーバーの開始後に、データの差分は転送されなくなります。また、復旧計画で計画されていないフェールオーバーを実行する場合は、エラーが発生した場合でも、復旧計画は最後まで実行されます。




### テスト フェールオーバーの実行

1. 1 つの VM をフェールオーバーする場合は、**[設定]** の **[レプリケートされたアイテム]** で、VM をクリックして **[+ テスト フェールオーバー]** をクリックします。

	![テスト フェールオーバー](./media/site-recovery-vmm-to-vmm/test-failover.png)

2. 復旧計画をフェールオーバーする場合は、**[設定]** の **[復旧計画]** で、計画を右クリックし、**[テスト フェールオーバー]** をクリックします。復旧計画を作成する場合は、[こちらの手順に従ってください](site-recovery-create-recovery-plans.md)。
2. **[テスト フェールオーバー]** で、**[なし]** を選択します。このオプションでは、VM が想定どおりにフェールオーバーしても、レプリケートされた VM はどのネットワークにも接続されないことをテストします。

	![テスト フェールオーバー](./media/site-recovery-vmm-to-vmm/test-failover1.png)

3. **[OK]** をクリックすると、フェールオーバーが開始されます。進行状況を追跡するには、VM をクリックしてプロパティを開くか、**[設定]**、**[ジョブ]**、**[Site Recovery ジョブ]** の **[テスト フェールオーバー]** ジョブをクリックします。
4. フェールオーバー ジョブが **[テストの完了]** フェーズに達したら、次の手順に従います。

	-  セカンダリ VMM クラウドにレプリカ VM を表示します。
	-  **[Complete the test (テストの完了)]** をクリックして、テスト フェールオーバーを終了します。
	-  **[メモ]** をクリックして、テスト フェールオーバーに関連する監察結果をすべて記録し、保存します。

5. レプリカ仮想マシンが存在するホストと同じホスト上に、テスト仮想マシンが作成されます。これは、レプリカ仮想マシンが配置されているクラウドに追加されます。
6. VM が正常に起動することを確認したら、**[テスト フェールオーバーが完了しました]** をクリックします。この段階で、テスト フェールオーバー時に Site Recovery によって自動的に作成されたすべての要素は削除されます。

	> [AZURE.NOTE] テスト フェールオーバーの実行時間が 2 週間を超えた場合は、強制的に終了されます。



### レプリカ VM IP アドレスを使用した DNS の更新

フェールオーバー後、レプリカ VM は、プライマリ仮想マシンの IP アドレスと異なる IP アドレスを保有する場合があります。

- 仮想マシンは起動後に使用されている DNS サーバーを更新します。
- DNS は、次のように、手動で更新することもできます。

#### IP アドレスの取得

次のサンプル スクリプトを実行して、IP アドレスを取得します。

    	$vm = Get-SCVirtualMachine -Name <VM_NAME>
		$na = $vm[0].VirtualNetworkAdapters>
		$ip = Get-SCIPAddress -GrantToObjectID $na[0].id
		$ip.address  

#### DNS の更新

前のサンプル スクリプトを使用して取得した IP アドレスを指定して、次のサンプル スクリプトを実行し、DNS を更新します。

		string]$Zone,
		[string]$name,
		[string]$IP
		)
		$Record = Get-DnsServerResourceRecord -ZoneName $zone -Name $name
		$newrecord = $record.clone()
		$newrecord.RecordData[0].IPv4Address  =  $IP
		Set-DnsServerResourceRecord -zonename $zone -OldInputObject $record -NewInputObject $Newrecord

## 次のステップ

デプロイをセットアップし、実行状態にできたら、各種フェールオーバーの[詳細を確認](site-recovery-failover.md)します。

<!---HONumber=AcomDC_0824_2016-->