---
title: "Azure Site Recovery を使用して Azure にオンプレミス VMware VM のディザスター リカバリーを設定する |Microsoft Docs"
description: "Azure Site Recovery サービスを使用して Azure にオンプレミス VMware VM のディザスター リカバリーを設定する方法について説明します。"
services: site-recovery
author: rayne-wiselman
manager: carmonm
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/11/2017
ms.author: raynew
ms.custom: MVC
ms.openlocfilehash: 5810ff908d48fc4ff742d734e7c2457fdfe8cb03
ms.sourcegitcommit: e266df9f97d04acfc4a843770fadfd8edf4fa2b7
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/11/2017
---
# <a name="set-up-disaster-recovery-to-azure-for-on-premises-vmware-vms"></a>Azure にオンプレミス VMware VM のディザスター リカバリーを設定する

このチュートリアルでは、Windows を実行するオンプレミス VMware VM のディザスター リカバリーを Azure に設定する方法について説明します。 このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * レプリケーションのソースとターゲットを指定する。
> * ソースのレプリケーション環境 (オンプレミスの Site Recovery コンポーネントなど) と、ターゲットのレプリケーション環境を設定する。
> * レプリケーション ポリシーを作成する
> * VM のレプリケーションを有効にする

これは、シリーズ 3 番目のチュートリアルです。 このチュートリアルでは、前のチュートリアルで以下のタスクがすでに完了していることを前提としています。

1. [Azure を準備する](tutorial-prepare-azure.md)
2. [オンプレミスの VMware を準備する](tutorial-prepare-on-premises-vmware.md)

開始する前に、ディザスター リカバリー シナリオの[アーキテクチャを確認](concepts-vmware-to-azure-architecture.md)しておくと有用です。


## <a name="select-a-replication-goal"></a>レプリケーションの目標を選ぶ

1. **[Recovery Services コンテナー]** で、コンテナー名 **ContosoVMVault** をクリックします。
2. **[作業の開始]** で、[Site Recovery] をクリックします。 次に、**[インフラストラクチャの準備]** をクリックします。
3. **[保護の目標]** > **[マシンのある場所]** で、**[オンプレミス]** を選びます。
4. [マシンをどこにレプリケートしますか] で、**[To Azure]\(Azure\)** を選びます。
5. **[マシンは仮想化されていますか]** で、**[はい (VMware vSphere ハイパーバイザー の場合)]** を選びます。 次に、 **[OK]**をクリックします

## <a name="set-up-the-source-environment"></a>ソース環境をセットアップする

ソース環境を設定するには、Site Recovery 統合セットアップ ファイルをダウンロードします。 セットアップを実行して、オンプレミスの Site Recovery コンポーネントをインストールし、VMware サーバーをコンテナーに登録し、オンプレミスの VM を検出します。

### <a name="verify-on-premises-site-recovery-requirements"></a>オンプレミスの Site Recovery の要件を確認する

オンプレミスの Site Recovery コンポーネントをホストするには、オンプレミスの高可用性 VMware VM が 1 つ必要です。 コンポーネントには、構成サーバー、プロセス サーバー、マスター ターゲット サーバーが含まれます。

- 構成サーバーは、オンプレミスと Azure の間の通信を調整し、データのレプリケーションを管理します。
- プロセス サーバーはレプリケーション ゲートウェイとして機能します。 レプリケーション データを受信し、そのデータをキャッシュ、圧縮、暗号化によって最適化して、Azure Storage に送信します。 また、プロセス サーバーは、レプリケートする VM へのモビリティ サービスのインストールや、オンプレミスの VMware VM の自動検出も行います。
- マスター ターゲット サーバーは、Azure からのフェールバック中にレプリケーション データを処理します。

VM は次の要件を満たしている必要があります。

| **要件** | **詳細** |
|-----------------|-------------|
| CPU コアの数| 8 |
| RAM | 12 GB |
| ディスクの数 | 3-OS ディスク、プロセス サーバーのキャッシュ ディスク、リテンション ドライブ (フェールバック用) |
| ディスクの空き領域 (プロセス サーバー キャッシュ) | 600 GB |
| ディスクの空き領域 (リテンション ディスク) | 600 GB |
| オペレーティング システムのバージョン | Windows Server 2012 R2 |
| オペレーティング システムのロケール | 英語 (en-us) |
| VMware vSphere PowerCLI のバージョン | [PowerCLI 6.0](https://my.vmware.com/web/vmware/details?productId=491&downloadGroup=PCLI600R1 "PowerCLI 6.0") |
| Windows Server の役割 | Active Directory Domain Services、インターネット インフォメーション サービス、Hyper-V のロールは有効にしないでください。 |
| NIC の種類 | VMXNET3 |
| IP アドレスの種類 | 静的 |
| ポート | 443 (コントロール チャネルのオーケストレーション)<br/>9443 (データ転送)|

加えて次の作業を行います。 
- VM のシステム クロックがタイム サーバーと同期されていることを確認します。 時刻の同期は 15 分以内に行う必要があります。 それより大きい場合、セットアップは失敗します。
。
- 構成サーバーの VM が次の URL にアクセスできることを確認します。

    [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]
    
- IP アドレスベースのファイアウォール規則で Azure への通信が許可されていることを確認します。
    - [Azure データセンターの IP 範囲](https://www.microsoft.com/download/confirmation.aspx?id=41653)、ポート 443 (HTTPS)、およびポート 9443 (データ レプリケーション) を許可します。
    - ご利用のサブスクリプションの Azure リージョンと米国西部の IP アドレス範囲を許可します (Access Control と ID 管理に使用されます)。


### <a name="download-the-site-recovery-unified-setup-file"></a>Site Recovery 統合セットアップ ファイルをダウンロードする

1. コンテナーの **[インフラストラクチャの準備]** で、**[ソース]** をクリックします。
1. **[ソースの準備]** で、**[+ 構成サーバー]** をクリックします。
2. **[サーバーの追加]** で、**[サーバーの種類]** に **[構成サーバー]** が表示されていることを確認します。
3. Site Recovery 統合セットアップ インストール ファイルをダウンロードします。
4. コンテナー登録キーをダウンロードします。 このキーは、統合セットアップを実行するときに必要になります。 キーは生成後 5 日間有効です。

   ![Set up source](./media/tutorial-vmware-to-azure/source-settings.png)

### <a name="set-up-the-configuration-server"></a>構成サーバーを設定する

1. 統合セットアップ インストール ファイルを実行します。
2. **[開始する前に]** で、**[Install the configuration server and process server]\(構成サーバーとプロセス サーバーをインストールする\)** を選択して **[次へ]** をクリックします。

3. **[Third-Party Software License]\(サードパーティ製ソフトウェア ライセンス\)** で、**[同意する]** をクリックして MySQL をダウンロードおよびインストールし、**[次へ]** をクリックします。

4. **[登録]** で、コンテナーからダウンロードした登録キーを選択します。

5. **[インターネット設定]** で、構成サーバーで実行されているプロバイダーがインターネット経由で Azure Site Recovery に接続する方法を指定します。

   - マシンで現在セットアップされているプロキシを使用して接続する場合は、**[プロキシ サーバーを使用して Azure Site Recovery に接続する]** を選択します。
   - プロバイダーから直接接続するように指定する場合は、**[プロキシを使用せずに直接 Azure Site Recovery に接続する]** を選択します。
   - 既存のプロキシで認証が必要な場合、またはプロバイダー接続にカスタム プロキシを使用する場合は、**[Connect with custom proxy setting]\(カスタム プロキシ設定を使用して接続する\)** を選択して、アドレス、ポート、資格情報を指定します。

   ![ファイアウォール](./media/tutorial-vmware-to-azure/combined-wiz4.png)

6. **[前提条件の確認]** では、インストールを実行できることを確認するためのチェックが実行されます。 **グローバル時刻の同期チェック**に関する警告が表示された場合は、システム クロックの時刻 (**[日付と時刻]** 設定) がタイム ゾーンと同じであることを確認します。

   ![前提条件](./media/tutorial-vmware-to-azure/combined-wiz5.png)

7. **[MySQL Configuration (MySQL の構成)]** で、インストールする MySQL サーバー インスタンスにログオンするための資格情報を作成します。

8. **[環境の詳細]** で、VMware VM の保護で **[はい]** を選択します。 セットアップで PowerCLI 6.0 がインストールされていることが確認されます。

9. **[インストール場所]** で、バイナリをインストールしキャッシュを格納する場所を選択します。 選択するドライブには使用可能なディスク領域が 5 GB 以上必要ですが、600 GB 以上の空き領域があるキャッシュ ドライブを使用することをお勧めします。

10. **[ネットワークの選択]** で、構成サーバーがレプリケーション データを送受信するリスナー (ネットワーク アダプターと SSL ポート) を指定します。 既定では、ポート 9443 がレプリケーション トラフィックの送受信用に使用されます。このポート番号は、実際の環境の要件に合わせて変更できます。 ポート 443 も開きます。このポートは、レプリケーション操作を調整するために使用されます。 ポート 443 はレプリケーション トラフィックの送受信用に使用しないでください。

11. **[概要]** で情報を確認し、**[インストール]** をクリックします。 セットアップで構成サーバーがインストールされ、Azure Site Recovery サービスに登録されます。

    ![概要](./media/tutorial-vmware-to-azure/combined-wiz10.png)

    インストールが完了すると、パスフレーズが生成されます。 このパスフレーズは、レプリケーションを有効にするときに必要になるので、コピーしてセキュリティで保護された場所に保管してください。 このサーバーは、コンテナーの **[設定]** > **[サーバー]** ウィンドウに表示されます。

### <a name="configure-automatic-discovery"></a>自動検出を構成する

VM を検出するには、構成サーバーがオンプレミス VMware サーバーに接続している必要があります。 このチュートリアルの目的を達成するために、vCenter サーバーまたは vSphere ホストを追加して、サーバーで管理者特権を持つアカウントを使用します。 このアカウントは、[前のチュートリアル](tutorial-prepare-on-premises-vmware.md)で作成しました。 

アカウントを追加するには:

1. 構成サーバーの VM で、**CSPSConfigtool.exe** を起動します。 これはデスクトップにショートカットがあり、*<インストール場所>*\home\svsystems\bin フォルダーに保存されています。

2. **[アカウントの管理]** > **[アカウントの追加]** の順にクリックします。

   ![[アカウントの追加]](./media/tutorial-vmware-to-azure/credentials1.png)

3. **[アカウントの詳細]** で、自動検出に使用するアカウントを追加します。

   ![詳細](./media/tutorial-vmware-to-azure/credentials2.png)

VMware サーバーを追加するには:

1. [Azure Portal](https://portal.azure.com) を開いて **[すべてのリソース]** をクリックします。
2. **ContosoVMVault** という名前の Recovery Service コンテナーをクリックします。
3. **[Site Recovery]** > **[インフラストラクチャの準備]** > **[ソース]** の順にクリックします。
4. **[+ vCenter]** を選んで、vCenter サーバーまたは vSphere ESXi ホストに接続します。
5. **[Add vCenter]\(vCenter の追加\)** で、サーバーのフレンドリ名を指定します。 次に、IP アドレスまたは FQDN を指定します。
6. VMware サーバーが別のポートで要求をリッスンする場合を除き、ポートは 443 のままにしておきます。
7. サーバーへの接続で使用するアカウントを選択します。 **[OK]**をクリックします。

Site Recovery は指定された設定を使用して VMware サーバーに接続し、VM を検出します。

> [!NOTE]
> アカウント名がポータルに表示されるまでに 15 分以上かかることがあります。 すぐに更新するには、**[構成サーバー]** > ***サーバー名*** > **[サーバーを最新の情報に更新する]** の順にクリックします。

## <a name="set-up-the-target-environment"></a>ターゲット環境をセットアップする

ターゲット リソースを選択して確認します。

1. **[インフラストラクチャの準備]** > **[ターゲット]** の順にクリックし、使用する Azure サブスクリプションを選択します。
2. ターゲット デプロイ モデルを Resource Manager ベースとクラシック モードのどちらにするかを指定します。
3. Site Recovery によって、互換性のある Azure ストレージ アカウントとネットワークが 1 つ以上あるかどうかが確認されます。

   ![[ターゲット]](./media/tutorial-vmware-to-azure/storage-network.png)

## <a name="create-a-replication-policy"></a>レプリケーション ポリシーを作成する

1. [Azure Portal](https://portal.azure.com) を開いて **[すべてのリソース]** をクリックします。
2. **ContosoVMVault** という名前の Recovery Service コンテナーをクリックします。
3. レプリケーション ポリシーを作成するには、**[Site Recovery infrastructure]\(Site Recovery インフラストラクチャ\)** > **[レプリケーション ポリシー]** > **[+ レプリケーション ポリシー]** の順にクリックします。
4. **[レプリケーション ポリシーの作成]** で、ポリシー名 **VMwareRepPolicy** を指定します。
5. **[RPO しきい値]** では、既定値の 60 分が使用されます。 この値で、復旧ポイントの作成頻度を指定します。 継続的なレプリケーションがこの制限を超えると、アラートが生成されます。
6. **[復旧ポイントのリテンション期間]** では、各復旧ポイントのリテンション期間に既定値の 24 時間が使用されます。 このチュートリアルでは 72 時間を選択します。 レプリケートされた VM は、期間内の任意の時点に復旧できます。
7. **[アプリ整合性スナップショットの頻度]** では、アプリ整合性スナップショットの作成頻度に既定値の 60 分が使用されます。 **[OK]** をクリックしてポリシーを作成します。

   ![[ポリシー]](./media/tutorial-vmware-to-azure/replication-policy.png)

このポリシーは自動的に構成サーバーに関連付けられます。 既定でフェールバックの照合ポリシーが自動的に作成されます。 たとえば、レプリケーション ポリシーが **rep-policy** の場合、フェールバック ポリシーは **rep-policy-failback** になります。 このポリシーは、Azure からフェールバックを開始するまで使用されません。

## <a name="enable-replication"></a>Enable replication

VM のレプリケーションを有効にすると、Site Recovery がモビリティ サービスをインストールします。 変更が反映されてポータルに表示されるまで 15 分以上かかる場合があります。

レプリケーションを有効にするには、次の手順に従います。

1. **[アプリケーションをレプリケートする]** > **[ソース]** の順にクリックします。
2. **[ソース]** で、構成サーバーを選択します。
3. **[マシンの種類]** で、**[仮想マシン]** を選択します。
4. **[vCenter/vSphere Hypervisor] \(vCenter/vSphere ハイパーバイザー)** で、vSphere ホストを管理する vCenter サーバーを選択するか、ホストを選択します。
5. プロセス サーバー (構成サーバー) を選択します。 その後、**[OK]** をクリックします。
6. **[ターゲット]** で、サブスクリプションと、フェールオーバー対象の VM を作成するリソース グループを選択します。 Azure で、フェールオーバー対象の VM に使用するデプロイ モデル (クラシックまたはリソース管理) を選択します。
7. データのレプリケーションに使用する Azure Storage アカウントを選択します。
8. フェールオーバー後に作成された Azure VM が接続する Azure ネットワークとサブネットを選択します。
9. 保護の対象として選択したすべてのマシンにネットワーク設定を適用する場合は、**[選択したマシン用に今すぐ構成します。]** を選択します。 マシンごとに Azure ネットワークを選択する場合は、**[後で構成する]** を選択します。
10. **[仮想マシン]** > **[仮想マシンの選択]** で、レプリケートする各マシンをクリックして選択します。 選択できるのは、レプリケーションを有効にできるマシンのみです。 次に、 **[OK]**をクリックします
11. **[プロパティ]** > **[プロパティの構成]** で、プロセス サーバーがモビリティ サービスのマシンへの自動インストールで使用するアカウントを選択します。
12. **[レプリケーション設定]** > **[レプリケーション設定の構成]** で、正しいレプリケーション ポリシーが選択されていることを確認します。
13. **[レプリケーションを有効にする]**をクリックします。

**[設定]** > **[ジョブ]** > **[Site Recovery ジョブ]** の順にクリックして、**保護の有効化**ジョブの進行状況を追跡できます。 **保護の最終処理** ジョブが実行されると、マシンはフェールオーバーできる状態になります。

追加する VM を監視するには、**[構成サーバー]** で VM の最終検出時刻を確認します。
> **最後の使用**。 定期検出を待たずに VM を追加するには、構成サーバーを強調表示し (クリックしないでください)、**[更新]** をクリックします。

## <a name="next-steps"></a>次のステップ

> [!div class="nextstepaction"]
> [ディザスター リカバリーのテストを実行する](site-recovery-test-failover-to-azure.md)
