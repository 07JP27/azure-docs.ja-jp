<properties title="Step 5: Publish the Azure Machine Learning web service" pageTitle="手順 5.Machine Learning Web サービスを発行する | Azure" description="手順 5.Azure Machine Learning Studio でスコア付け実験を ML API Web サービスとして発行する" metaKeywords="" services="machine-learning" solutions="" documentationCenter="" authors="garye" manager="paulettm" editor="cgronlun" videoId="" scriptId="" />

<tags ms.service="machine-learning" ms.workload="data-services" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="08/06/2014" ms.author="garye" />


これは、チュートリアル「[Azure Machine Learning を使用した予測ソリューションの開発][develop]」の 5 番目の手順です。

[develop]: ../machine-learning-walkthrough-develop-predictive-solution/


1.	[ML ワークスペースを作成する][create-workspace]
2.	[既存のデータをアップロードする][upload-data]
3.	[新しい実験を作成する][create-new]
4.	[モデルをトレーニングして評価する][train-models]
5.	**Web サービスを発行する**
6.	[Web サービスにアクセスする][access-ws]

[create-workspace]: ../machine-learning-walkthrough-1-create-ml-workspace/
[upload-data]: ../machine-learning-walkthrough-2-upload-data/
[create-new]: ../machine-learning-walkthrough-3-create-new-experiment/
[train-models]: ../machine-learning-walkthrough-4-train-and-evaluate-models/
[publish]: ../machine-learning-walkthrough-5-publish-web-service/
[access-ws]: ../machine-learning-walkthrough-6-access-web-service/

----------

# 手順 5.Azure Machine Learning Web サービスを発行する

この予測モデルを他のユーザーが利用できるようにするには、Azure 上に Web サービスとして発行します。このサービスでは、ユーザーから送信された信用貸付申請データのセットに対して信用リスクの予測が返されます。  

これを実現するには、次の操作を行う必要があります。  

-	実験を発行する準備をします。
-	実験をテストするためにステージング サーバーに発行します。
-	運用環境にデプロイする準備ができたら、実験をライブ サーバーに昇格させます。  

次へ進む前に、編集用にこの実験のコピーを作成します。この操作を行っておくと、モデルをさらに操作する必要があるときにいつでもトレーニング実験に戻ることができます。  

1.	キャンバスの下にある **[名前を付けて保存]** をクリックします。
2.	実験のコピーにわかりやすい名前を付けます。既定では、元の実験名に "- コピー" を付けます。ここでは、"Credit Risk Prediction - Scoring Experiment" という名前を付けます。
3.	**[OK]** をクリックします。  


ML Studio の [実験] ボックスに元の実験とコピーの両方が表示されます。  

![Experiments list][1]
 
##スコア付け実験を準備する
このモデルを Web サービスとして発行できるようにするには、2 つの作業を行う必要があります。  

最初に、*トレーニング実験*から*スコア付け実験*に実験を変換する必要があります。これまでは、モデルのトレーニングを実験してきました。しかし、発行されたサービスについてはトレーニングを行わず、代わりにユーザーの入力のスコア付けを行います。そこで、トレーニングしたモデルのコピーを保存した後、トレーニング用のすべてのコンポーネントを実験から削除します。  

2 番目に、Azure ML Web サービスはユーザーからの入力を受け付けてその結果を返すため、実験におけるこれらの入力ポイントと出力ポイントを識別する必要があります。  

###トレーニング実験からスコア付け実験に変換する
使用にあたってはブースト ツリー モデルの方が優れていると判断したとします。したがって、最初に行うことは、SVM トレーニング モジュールを削除することです。  

1.	**"2 クラス サポート ベクター マシン"** を削除します。
2.	接続されている**モデルのトレーニング** モジュールと**モデルのスコア付け**モジュールを削除します。
3.	**スケーリングによるデータ変換**モジュールを削除します。  

次に、トレーニングしたブースト ツリー モデルを保存します。その後、トレーニングに使用した実験の残りのモジュールを削除して、トレーニング済みのモデルで置き換えます。  

1.	残りの**モデルのトレーニング** モジュールの出力ポートを右クリックし、**[トレーニング済みのモデルとして保存する]** を選択します。
2.	トレーニング済みのモデルの名前と説明を入力します。この例では、「Credit Risk Prediction」と入力します。

	>**メモ**:このトレーニング済みのモデルを保存すると、モデルがモジュール パレットに表示されて他の実験で使用できるようになります。

3.	**[検索]** ボックスに「credit risk」と入力してモジュール パレット内でこのモデルを見つけ、**"Credit Risk Prediction"** トレーニング済みモデルを実験キャンバスにドラッグします。
4.	**2 クラス ブースト デシジョン ツリー** モジュールと**モデルのトレーニング** モジュールを削除します。
5.	**Credit Risk Prediction** モデルの出力を**モデルのスコア付け**モジュールの左側の入力に接続します。   

これで、元のトレーニング モジュールに代わる、モデルの保存済みかつトレーニング済みのバージョンを実験に準備できました。  

実験には、トレーニング用および 2 つのモデル アルゴリズムの評価用に追加した他のコンポーネントがあります。次のコンポーネントも削除できます。  

-	**分割**
-	両方の **R スクリプトの実行**モジュール
-	**モデルの評価**  

注意事項:元のクレジット カード データには Credit Risk 列が含まれていました。前の手順では、これらの値を予測するモデルをトレーニングできるように、この列を**モデルのトレーニング** モジュールに渡しました。しかし、モデルがトレーニングされ、トレーニング済みのモデルによってこの値が予測される今の段階では、この列を渡す必要はありません。そこで、データのフローからこの列を削除するために、**プロジェクト列**モジュールを使用します。  

1.	**プロジェクト列**モジュールを見つけて、キャンバスにドラッグします。
2.	このモジュールを**メタデータ エディター** モジュールの出力に接続します (これで、**分割**モジュールと**R スクリプトの実行**モジュールが削除されます)。
3.	**プロジェクト列**モジュールを選択し、**[列セレクターの起動]** をクリックします。
4.	ドロップダウンで [すべての列] が選択されていることを確認します。
5.	プラス記号 (+) をクリックして、ドロップダウンに新しい行を作成します。
6.	新しいドロップダウンで [列名を除外する] を選択し、テキスト ボックスに「Credit risk」と入力します (列番号の 21 を使用して列を指定することもできます)。
7.	**[OK]** をクリックします。

	>ヒント - 列セレクターは、表示される順序でドロップダウンのロジックに従います。ここでは、**プロジェクト列**モジュールに対し、"Credit risk 列以外のすべての列を渡す" ことを指定しています。最初のドロップダウンの指定を省略した場合、このモジュールは列をまったく渡さなくなります。

8.	**プロジェクト列**モジュールの出力を**モデルのスコア付け**モジュールの右側の入力に接続します。  

現在、実験は以下のようになっています。  

![Scoring the trained model][2]  

###サービスの入力と出力を選択する
元のモデルでは、スコア付けされるデータは**モデルのスコア付け**モジュールの右側の入力ポート ("データセット") に渡され、スコア付けされた結果は出力ポート ("スコア付けされたデータセット") に示されていました。サービスを実行したときも、ユーザーのデータと結果について、これらの同じポートを使用することにします。  

1.	**モデルのスコア付け**モジュールの右側の入力ポートを右クリックし、**[発行の入力として設定する]** を選択します。ユーザーのデータには、特徴ベクトルのすべてのデータが含まれている必要があります。

	>**ヒント** - (**スケーリングによるデータ変換**モジュールを使用して SVM モデルのデータを準備したように) ユーザーのデータをスコア付けモジュールに渡す前に操作する必要がある場合は、Web サービスのモジュールをそのままにして、サービスの入力をモジュールの入力ポートに設定します。

2.	出力ポートを右クリックし、**[発行の出力として設定する]** を選択します。モデルのスコア付けモジュールの出力がサービスによって返されます。これには、特徴ベクトルに加え、信用リスク予測とスコア付け確率値が含まれます。

	>**ヒント** - たとえば特徴ベクトル全体を返す代わりにこのデータの一部のみを Web サービスで返すには、**モデルのスコア付け**モジュールの後に**プロジェクト列**モジュールを追加します。さらに、不要な列を除外するようにこれを構成し、**プロジェクト列**モジュールの出力を Web サービスの出力として設定します。  
  

>**注** - UCI German Credit Card Data データセットとそれに関連付けられているモジュールが**モデルのスコア付け**モジュールに接続されたままになっていることを不思議に思っている人もいるでしょう。このサービスでは、元のデータセットではなくユーザーのデータを使用します。それにもかかわらずなぜこれらを接続したままにしているのでしょうか?

サービスで元のクレジット カード データを必要としないのは本当です。しかし、列がいくつあり、どの列が数値型であるかなどの情報を含むこのデータのスキーマが必要になります。このスキーマ情報は、ユーザーのデータを解釈するうえで必要になります。そこで、これらのコンポーネントを接続したままにして、サービスが実行されているときにスコア付けモジュールがデータセット スキーマを利用できるようにしています。データは使用されません。スキーマだけが使用されます。  

最後にもう一度実験を実行します (**[実行]** をクリックします)。モデルがまだ稼動していることを確認するには、**モデルのスコア付け**モジュールを右クリックし、**[視覚化]** を選択します。元のデータが、信用リスク値 ("スコア付けラベル") とスコア付け確率値 ("スコア付け確率") と共に表示されます。  

##Web サービスを発行する
実験から派生する Web サービスを発行するには、キャンバスの下にある **[Web サービスの発行]** をクリックし、確認メッセージが表示されたら **[はい]** をクリックします。ML Studio によって実験が Web サービスとして ML ステージング サーバーに発行されます。その後、サービス ダッシュボードが表示されます。   

>**ヒント** - Web サービスを発行した後で更新できます。たとえば、モデルを変更する場合は、前の手順で保存したトレーニング実験を編集し、モデル パラメーターを微調整して、トレーニング済みのモデルを保存します (以前に保存したモデルを上書きします)。スコア付け実験をもう一度開くと、内容が変更されたこと (これがトレーニング済みのモデルになります) を示すメッセージが表示され、実験を更新できます。もう一度実験を発行すると、Web サービスが置き換えられ、更新済みのモデルが使用されるようになります。  

サービスを構成するには、**[構成]** タブをクリックします。このタブでは、サービス名 (既定で実験名が付けられます) を変更したり、説明を追加したりできます。また、入力列と出力列にわかりやすいラベルを付けることもできます。  

**[運用の準備ができましたか?]** スイッチについては後で触れます。  

##Web サービスをテストする
**[ダッシュボード]** ページで、**[ステージング サービス]** の下の **[テスト]** リンクをクリックします。サービスの入力データを要求するダイアログが表示されます。これらは、元のドイツの信用リスク データセットに含まれるのと同じ列です。  

データのセットを入力し、**[OK]** をクリックします。  

Web サービスによって生成された結果がダッシュボードの下部に表示されます。サービスの構成に応じて、スコア付けモジュールによって生成された結果が表示されます。   

##Web サービスをライブ サーバーに昇格する
これまでは、ML ステージング サーバー上でサービスを実行してきました。サービスを運用環境にデプロイする準備が整ったら、ライブ サーバーに昇格するよう要求できます。  

**[構成]** タブで、**[運用の準備ができましたか?]** の横の [はい] をクリックします。これにより、この Web サービスを運用環境にデプロイする準備が整ったことを知らせる通知が IT 管理者に送信されます。この通知を受けて、管理者はこの Web サービスをライブ サーバーに昇格します。

![Promoting the service to the live environment][3]  

----------

**次のステップ: [Web サービスにアクセスする][access-ws]**

[1]: ./media/machine-learning-walkthrough-5-publish-web-service/publish1.png
[2]: ./media/machine-learning-walkthrough-5-publish-web-service/publish2.png
[3]: ./media/machine-learning-walkthrough-5-publish-web-service/publish3.png
