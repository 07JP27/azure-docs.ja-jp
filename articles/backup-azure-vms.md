<properties
	pageTitle="Azure 仮想マシンのバックアップ - Backup"
	description="登録後に、Azure 仮想マシンをバックアップする方法について説明します"
	services="backup"
	documentationCenter=""
	authors="aashishr"
	manager="shreeshd"
	editor=""/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="04/30/2015"
	ms.author="aashishr"/>


# Azure 仮想マシンのバックアップ

この記事は、Azure 仮想マシンをバックアップするうえで必読のガイドです。作業を進める前に、[前提条件][prereq]がすべて満たされていることを確認してください。

Azure 仮想マシンのバックアップには、次の 3 つの主要な手順が含まれます。

![Azure 仮想マシンをバックアップするための 3 つの手順][three-steps]

## Azure 仮想マシンの探索
探索プロセスでは、サブスクリプションに含まれる仮想マシンの一覧を、クラウド サービス名、リージョンなどの追加情報と共に Azure に照会します。

> [AZURE.NOTE]この探索プロセスは、常に最初の手順として実行する必要があります。これは、サブスクリプションに追加された新しい仮想マシンが必ず識別されるようにするためです。

探索プロセスを開始するには、次の手順を実行します。

1. Azure ポータルの **\[復旧サービス\]** にあるバックアップ コンテナーに移動し、**\[登録されている項目\]** タブをクリックします。

2. ドロップダウン メニューでワークロードの種類として **\[Azure 仮想マシン\]** を選択し、**\[選択\]** をクリックします。![ワークロードの選択][select-workload]

3. ページの下部にある **\[探索\]** をクリックします。![\[探索\] ボタン][discover-button]

4. 仮想マシンが集計されるまで、この探索プロセスに数分かかる場合があります。探索プロセスの実行中は、画面の下部にトースト通知が表示されます。![VMS の探索][discover-vms]

5. 探索プロセスが完了すると、トースト通知が表示されます。![discover-done][discover-done]

<br><br>
## Azure 仮想マシンの登録
仮想マシンを保護するには、事前に Azure Backup サービスに登録する必要があります。この登録プロセスには、次の 2 つの主要な目的があります。

1. バックアップ拡張機能を仮想マシンの VM エージェントに接続する。

2. 仮想マシンを Azure Backup サービスに関連付ける。

登録は、通常、1 回限りの操作です。Azure Backup サービスは、面倒なユーザーの介入を必要とすることなく、バックアップ拡張機能のアップグレードや修正プログラムの適用をシームレスに処理します。これにより、ユーザーは、一般的にバックアップ製品に関連する、"エージェント管理オーバーヘッド" から解放されます。

### 仮想マシンを登録するには

1. Azure ポータルの **\[復旧サービス\]** にあるバックアップ コンテナーに移動し、**\[登録されている項目\]** タブをクリックします。

2. ドロップダウン メニューでワークロードの種類として **\[Azure 仮想マシン\]** を選択し、選択ボタンをクリックします。![ワークロードの選択][select-workload]

3. ページの下部にある **\[登録\]** をクリックします。![\[登録\] ボタン][register-button]

4. **\[項目の登録\]** ポップアップで、登録する仮想マシンを選択します。同じ名前の仮想マシンが 2 つ以上ある場合は、クラウド サービスを使用して仮想マシンを区別します。

  	**登録**操作は一括して実行できます。つまり、登録する対象として複数の仮想マシンを同時に選択できます。これにより、仮想マシンのバックアップの準備に伴う 1 回限りの労力が大幅に軽減されます。

  	> [AZURE.NOTE]ここには、登録されていない、バックアップ コンテナーと同じリージョンにある仮想マシンのみが表示されます。

  	![登録する VM の一覧][register-vms]

5. 登録する仮想マシンごとにジョブが作成されます。トースト通知にこのアクティビティの状態が示されます。**\[ジョブの表示\]** をクリックして **\[ジョブ\]** ページに移動します。![登録ジョブ][register-job]

6. 仮想マシンが登録済みの項目の一覧にも表示され、登録操作の状態が表示されます。![登録状態 1][register-status1]

7. 操作が完了すると、登録済みの状態を反映するようにポータルの状態が変更されます。![登録状態 2][register-status2]

<br><br>
## Azure 仮想マシンのバックアップ
この手順では、仮想マシンのバックアップおよび保持ポリシーを設定します。仮想マシンを保護するには、次の手順を実行します。

1. Azure ポータルの **\[復旧サービス\]** にあるバックアップ コンテナーに移動し、**\[登録されている項目\]** タブをクリックします。

2. ドロップダウン メニューでワークロードの種類として **\[Azure 仮想マシン\]** を選択し、選択ボタンをクリックします。![ポータルでのワークロードの選択][select-workload]

3. ページの下部にある **\[保護\]** をクリックします。

4. 保護する仮想マシンを選択するための**項目の保護** ウィザードが表示されます。同じ名前の仮想マシンが 2 つ以上ある場合は、クラウド サービスを使用して仮想マシンを区別します。**保護**操作は一括して実行できます。つまり、保護する対象として複数の仮想マシンを同時に選択できます。これにより、仮想マシンの保護に伴う労力が大幅に軽減されます。

	> [AZURE.NOTE]ここには、Azure Backup サービスによって適切に登録され、バックアップ コンテナーと同じリージョンにある仮想マシンのみが表示されます。

	![保護する項目の選択][protect-wizard1]

5. **項目の保護**ウィザードの 2 番目の画面で、選択した仮想マシンをバックアップするために使用するバックアップおよび保持ポリシーを選択します。既存のポリシーのセットから選択することも、新しいポリシーを定義することもできます。

	> [AZURE.NOTE]プレビューでは、最大 30 日間の保持期間と最大で 1 回に 1 日のバックアップがサポートされます。

	![保護ポリシーの選択][protect-wizard2]

	それぞれのバックアップ コンテナーに複数のバックアップ ポリシーを設定することができます。これらのポリシーは、バックアップのスケジュール設定方法と保持方法の詳細を反映するように設定します。たとえば、毎日午後 10 時に実行するバックアップ用にバックアップ ポリシーを 1 つ用意し、毎週朝 6 時に実行するバックアップ用に別のバックアップ ポリシーを設定します。複数のバックアップ ポリシーを使用することで、仮想マシン インフラストラクチャのバックアップを柔軟にスケジュール設定できます。それぞれのバックアップ ポリシーには、複数の仮想マシンを関連付けることができます。仮想マシンは、特定の時点において 1 つのポリシーにのみ関連付けることができます。

6. 仮想マシンごとに、保護ポリシーを構成し、仮想マシンをポリシーに関連付けるためのジョブが作成されます。**\[ジョブ\]** タブをクリックし、適切なフィルターを選択して、**保護の構成**ジョブの一覧を表示します。![保護の構成ジョブ][protect-configure]

7. ジョブが完了すると、仮想マシンがポリシーによって保護されます。最初のバックアップの実行は、スケジュール設定されたバックアップ時刻まで待つ必要があります。仮想マシンが **\[保護された項目\]** タブに表示され、保護状態が *\[保護済み\]* として表示されます \(最初のバックアップが未完了の状態\)。

	> [AZURE.NOTE]現在、保護を構成した直後に最初のバックアップを開始することはできません。

8. スケジュール設定された時刻になると、Azure Backup サービスによって、バックアップする必要があるそれぞれの仮想マシンに対するバックアップ ジョブが作成されます。**\[ジョブ\]** タブをクリックして、**バックアップ** ジョブの一覧を表示します。Azure Backup サービスは、バックアップ操作の一部として、各仮想マシンのバックアップ拡張機能に対して、すべての書き込みをフラッシュし、整合性のあるスナップショットを作成するためのコマンドを発行します。![バックアップが進行中][protect-inprogress]

9. 操作が完了すると、**\[保護された項目\]** タブの仮想マシンの保護状態が *\[保護済み\]* として表示されます。![復旧ポイントを作成した後の仮想マシンのバックアップ][protect-backedup]


## バックアップの状態と詳細の表示
仮想マシンが保護されると、**\[ダッシュボード\]** ページの概要に示される仮想マシンの数が増加します。さらに、\[ダッシュボード\] ページには、過去 24 時間の間に成功したジョブ、失敗したジョブ、現在進行中のジョブの数が表示されます。いずれかのカテゴリをクリックすると、**\[ジョブ\]** ページにそのカテゴリの詳細が表示されます。![\[ダッシュボード\] ページのバックアップの状態][dashboard]


## エラーのトラブルシューティング
次の情報を参考にして、探索と登録の問題のトラブルシューティングを行ってください。

| バックアップ操作 | エラーの詳細 | 対処法 |
| -------- | -------- | -------|
| 探索 | 新しい項目を探索できませんでした - Microsoft Azure Backup で、内部エラーが発生しました。しばらくしてから操作をやり直してください。 | 15 分後に探索プロセスを再試行します。
| 探索 | 新しい項目を探索できませんでした - 別の探索操作が既に進行中です。現在の探索操作が完了するまでお待ちください。 | 既存の探索操作が完了するまで待ちます。 |
| Register | Azure VM ロールは拡張機能をインストールできる状態ではありません - VM が実行中状態であるかどうかを確認してください。Azure Recovery Services 拡張機能を利用するには VM が実行中である必要があります。 | 仮想マシンを起動し、実行中状態になった後で登録操作をやり直してください。|


## 復旧ポイントの整合性
バックアップ データを操作するときにお客様が心配することは、VM が復元された後の動作です。次のような質問がお客様からよく寄せられます。

+ 仮想マシンが起動するか。

+ データがディスク上で使用できるようになるか、\(または\) データの損失が発生するか。

+ アプリケーションでデータを読み取ることができるか、\(または\) データの破損が発生するか。

+ データがアプリケーションにとって意味を成すか、\(または\) アプリケーションで読み取られたときにデータの整合性が保たれているか。

次の表に、Azure VM のバックアップおよび復元中に発生する整合性の種類について説明します。

| 整合性 | VSS ベース | 説明と詳細 |
|-------------|-----------|---------|
| アプリケーションの整合性 | あり | Microsoft ワークロードにとっての理想的な整合性です。次のことが保証されます。<ol><li> VM が*起動する*こと、<li>*破損がない*こと、<li>*データの損失*がないこと、<li>\(VSS を使用してバックアップ時にアプリを関連付けることによって\) データを使用するアプリケーションに対してデータの整合性が保たれること</ol> ボリューム スナップショット サービス \(VSS\) により、データがストレージに適切に書き込まれることが保証されます。ほとんどの Microsoft ワークロードには、データの整合性に関連するワークロードに固有の操作を実行する VSS ライターがあります。たとえば、Microsoft SQL Server には、トランザクション ログ ファイルとデータベースへの書き込みが正常に行われることを保証する VSS ライターがあります。<br><br> Azure VM のバックアップの場合、アプリケーションの整合性の復旧ポイントを取得することは、VM のスナップショットが作成される前に、VSS ワークフローがバックアップ拡張機能によって開始され、*適切に*完了したことを意味します。これは、当然、Azure VM 内のすべてのアプリケーションの VSS ライターが起動されたことも意味します。<br><br>。[VSS の基本](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx)と[詳しいしくみ](https://technet.microsoft.com/ja-jp/library/cc785914%28v=ws.10%29.aspx)について学習する。 |
| ファイル システムの整合性 | はい - Windows マシンの場合 | 次の 2 つのシナリオにおいて、復旧ポイントでファイル システムの整合性が保たれます。<ul><li>Azure の Linux VM のバックアップ。これは、Linux には VSS と同等のプラットフォームがないためです。<li>Azure の Windows VM のバックアップ中の VSS の障害。</li></ul> どちらの場合も、次のことを保証することが最善の対応となります。<ol><li>VM が*起動する*こと、<li>*破損がない*こと、<li>*データの損失*がないこと</ol> アプリケーションでは、復元されたデータに対する独自の "修正" メカニズムを実装する必要があります。|
| クラッシュの整合性 | いいえ | この状況は、\(ソフト リセットまたはハード リセットにより\) コンピューターが "クラッシュ" した状況に相当します。ストレージ メディア上のデータの整合性に関する保証はありません。バックアップ時にディスクに既に存在していたデータのみが、キャプチャされバックアップされます。<ol><li>保証はありませんが、ほとんどの場合、OS は起動します。<li>通常、その後に chkdsk などのディスク検査手順が実行され、破損エラーがあれば修正されます。<li> メモリ内にあったデータや、ディスクに完全にフラッシュされていなかったデータは、すべて失われます。<li> 通常、アプリケーションは、データのロールバックを実行する必要がある場合に独自の検証メカニズムに従います。</ol>Azure VM のバックアップの場合、クラッシュの整合性の復旧ポイントを取得することは、Azure Backup が、OS の観点からもアプリケーションの観点からも、ストレージ上のデータの整合性に関して何も保証しないことを意味します。このような状況は、通常、バックアップ時に Azure VM がシャットダウンしていると発生します。<br><br>たとえば、データベースに存在しないエントリがトランザクション ログにある場合、データベース ソフトウェアは、データの整合性が得られる時点までロールバックします。\(スパン ボリュームのように\) 複数の仮想ディスクにまたがるデータを操作する場合、クラッシュの整合性の復旧ポイントは、データの正確性に関して何も保証しません。|



## 次のステップ
Azure Backup の概要については、次のトピックを参照してください。

- [仮想マシンの復元](backup-azure-restore-vms.md)

[three-steps]: ./media/backup-azure-vms/3-steps-for-backup.png
[select-workload]: ./media/backup-azure-vms/discovery-select-workload.png
[discover-button]: ./media/backup-azure-vms/discover-button.png
[discover-vms]: ./media/backup-azure-vms/discovering-vms.png
[discover-done]: ./media/backup-azure-vms/discovery-complete.png
[register-button]: ./media/backup-azure-vms/register-button.png
[register-job]: ./media/backup-azure-vms/register-create-job.png
[register-vms]: ./media/backup-azure-vms/register-popup.png
[register-status1]: ./media/backup-azure-vms/register-status01.png
[register-status2]: ./media/backup-azure-vms/register-status02.png
[select-workload]: ./media/backup-azure-vms/select-workload.png
[protect-wizard1]: ./media/backup-azure-vms/protect-wizard1.png
[protect-wizard2]: ./media/backup-azure-vms/protect-wizard2.png
[protect-configure]: ./media/backup-azure-vms/protect-configureprotection.png
[protect-inprogress]: ./media/backup-azure-vms/protect-inprogress.png
[protect-backedup]: ./media/backup-azure-vms/protect-backedupvm.png
[dashboard]: ./media/backup-azure-vms/dashboard-protectedvms.png
[prereq]: http://azure.microsoft.com/documentation/articles/backup-azure-vms-introduction/#prerequisites

<!--HONumber=54-->