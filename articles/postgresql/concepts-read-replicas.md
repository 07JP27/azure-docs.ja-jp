---
title: Azure Database for PostgreSQL の読み取りレプリカ
description: この記事では、Azure Database for PostgreSQL での読み取りレプリカについて説明します。
author: rachel-msft
ms.author: raagyema
ms.service: postgresql
ms.topic: conceptual
ms.date: 01/23/2019
ms.openlocfilehash: 9270c3290bd7be0bbb79d30aff8becc04dcfc603
ms.sourcegitcommit: 644de9305293600faf9c7dad951bfeee334f0ba3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/25/2019
ms.locfileid: "54904014"
---
# <a name="read-replicas-in-azure-database-for-postgresql"></a>Azure Database for PostgreSQL の読み取りレプリカ

> [!IMPORTANT]
> 読み取りレプリカ機能はパブリック プレビュー段階にあります。

読み取りレプリカ機能を使用すると、Azure Database for PostgreSQL サーバー (マスター) から、同じ Azure リージョン内にある最大 5 つの読み取り専用サーバー (読み取りレプリカ) にデータをレプリケートできます。 読み取りレプリカは、PostgreSQL エンジンのネイティブ レプリケーション テクノロジを使用して非同期的に更新されます。

レプリカは、通常のスタンドアロン Azure Database for PostgreSQL サーバーと似た方法で管理できる新しいサーバーです。 読み取りレプリカごとに、仮想コア内のプロビジョニング済みコンピューティングとプロビジョニング済みストレージ (GB/月) に対して課金されます。

## <a name="when-to-use-read-replicas"></a>読み取りレプリカを使用する場合
読み取りレプリカ機能の目的は、読み取り集中型ワークロードのパフォーマンスとスケールの向上に役立つことです。 たとえば、書き込みワークロードをマスターに振り向けながら、読み取りワークロードはレプリカに分離することができます。

BI ワークロードおよび分析ワークロードでレポート用のデータ ソースとして使用するのが、読み取りレプリカの一般的なシナリオです。

レプリカは読み取り専用であり、マスターでの書き込み容量の負荷が直接軽減されることはないため、この機能の対象は書き込み集中型のワークロードではありません。

読み取りレプリカ機能では、PostgreSQL の非同期レプリケーションが使用されるので、同期レプリケーション シナリオには適していません。 マスターとレプリカの間には測定可能な遅延が発生します。 レプリカ上のデータは、最終的にマスター上のデータと整合します。 この機能は、この遅延に対応できるワークロードに使用してください。

## <a name="creating-a-replica"></a>レプリカを作成する
マスター サーバーでは、**azure.replication_support** が REPLICA に設定されている必要があります。 このパラメーターの変更を有効にするには、サーバーを再起動する必要があります。 (**Azure.replication_support** パラメーターは、汎用レベルおよびメモリ最適化レベルのみに適用されます)。

レプリカ作成ワークフローを開始すると、空の Azure Database for PostgreSQL サーバーが作成されます。 新しいサーバーには、マスター サーバー上にあったデータが設定されます。 新しいレプリカの作成にかかる時間は、マスター上のデータ量と、最後の週次完全バックアップからの経過時間に依存します。 これは、数分から数時間の範囲になる可能性があります。

読み取りレプリカ機能では、PostgreSQL の (論理レプリケーションではなく) 物理レプリケーションが使用されます。 レプリケーション スロットを使用するストリーミング レプリケーションが、既定の動作モードです。 必要に応じて、遅れを取り戻すためにログ配布が使用されます。

> [!NOTE]
> サーバーがストレージ制限に近づくとレプリケーションに影響するので、そうなったときに通知されるよう、サーバーでストレージ アラートをまだ設定していない場合は設定することをお勧めします。

[Azure portal で読み取りレプリカを作成する方法を確認してください](howto-read-replicas-portal.md)。

## <a name="connecting-to-a-replica"></a>レプリカに接続する
作成されたレプリカでは、マスター サーバーのファイアウォール規則または VNet サービス エンドポイントは継承されません。 これらの規則は、レプリカに対して個別に設定する必要があります。

レプリカの管理者アカウントは、マスター サーバーから継承されます。 マスター サーバー上のすべてのユーザー アカウントが、読み取りレプリカにレプリケートされます。 マスター サーバー上で使用可能なユーザー アカウントを使って読み取りレプリカにのみ接続できます。

通常の Azure Database for PostgreSQL サーバーの場合と同じように、レプリカのホスト名と有効なユーザー アカウントを使用して、レプリカに接続できます。 たとえば、サーバーの名前が myreplica で、管理者ユーザー名が myadmin の場合は、次のようにして psql から接続できます。

```
psql -h myreplica.postgres.database.azure.com -U myadmin@myreplica -d postgres
```
メッセージが表示されたら、ユーザー アカウントのパスワードを入力します。

## <a name="monitoring-replication"></a>レプリケーションを監視する
Azure Monitor では**レプリカ間の最大ラグ**メトリックが使用できます。 このメトリックは、マスター サーバーのみで使用できます。 そのメトリックでは、マスターと最も遅れているレプリカの間の時間差が示されます。 

また、Azure Monitor では**レプリカ ラグ** メトリックも提供されます。 このメトリックは、レプリカのみで使用できます。 

このメトリックは pg_stat_wal_receiver ビューから計算されます。

```SQL
EXTRACT (EPOCH FROM now() - pg_last_xact_replay_timestamp())
```
レプリカ ラグ メトリックでは最後に再生されたトランザクションからの時間が示されることに注意してください。 マスターでトランザクションが発生していない場合、メトリックにはこのタイム ラグが反映されます。

レプリカのラグがワークロードに対して許容できない値に達したときに通知されるアラートを設定することをお勧めします。 

さらに分析情報を得るには、マスター サーバーに対して直接クエリを実行して、すべてのレプリカでのバイト単位のレプリケーション ラグを取得します。
PG 10 では次のようにします。
```SQL
select pg_wal_lsn_diff(pg_current_wal_lsn(), stat.replay_lsn) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

PG 9.6 以下では次のようにします。
```SQL
select pg_xlog_location_diff(pg_current_xlog_location(), stat.replay_location) 
AS total_log_delay_in_bytes from pg_stat_replication;
```

> [!NOTE]
> マスター サーバーまたはレプリカ サーバーを再起動した場合、再起動して追いつくまでにかかった時間が、レプリカ ラグ メトリックに反映されます。

## <a name="stopping-replication-to-a-replica"></a>レプリカへのレプリケーションを停止する
マスターとレプリカの間のレプリケーションは停止することができます。 これにより、レプリカはレプリケーションの設定を削除するために再起動されます。 マスターとレプリカ サーバーの間のレプリケーションを停止すると、レプリカ サーバーはスタンドアロン サーバーになります。 スタンドアロン サーバー内のデータは、レプリケーション停止コマンドが開始された時点でレプリカで使用可能だったデータです。 このスタンドアロン サーバーにはマスター サーバーへの変更が反映されません。

このサーバーをもう一度レプリカにすることはできません。

レプリケーションを停止する前に、必要なすべてのデータがレプリカにあることを確認してください。

[レプリカを停止する方法についてはハウツー ドキュメントをご覧ください](howto-read-replicas-portal.md)。


## <a name="considerations"></a>考慮事項

### <a name="preparing-for-replica"></a>レプリカの準備をする
マスター サーバーで **azure.replication_support** を REPLICA に設定してから、レプリカを作成する必要があります。 このパラメーターの変更を有効にするには、サーバーを再起動する必要があります。 このパラメーターは、汎用レベルおよびメモリ最適化レベルのみに適用されます。

### <a name="stopped-replicas"></a>停止されたレプリカ
マスターとレプリカの間のレプリケーションを停止すると、変更を適用するためにレプリカが再起動されます。 その後、それをもう一度レプリカにすることはできません。

### <a name="replicas-are-new-servers"></a>レプリカは新規サーバー
レプリカは、新しい Azure Database for PostgreSQL サーバーとして作成されます。 既存のサーバーをレプリカに変更することはできません。

### <a name="replica-server-configuration"></a>レプリカ サーバーの構成
レプリカ サーバーは、マスターと同じサーバー構成を使用して作成されます。たとえば、以下の構成が含まれます。
- 価格レベル 
- コンピューティング世代
- 仮想コア
- Storage
- バックアップのリテンション期間
- バックアップ冗長オプション
- PostgreSQL エンジンのバージョン

レプリカが作成された後は、マスター サーバーとは無関係に、価格レベル (Basic への変更および Basic からの変更を除く)、コンピューティング世代、仮想コア、ストレージ、バックアップ保持期間を変更できます。

> [!IMPORTANT]
> マスターのサーバー構成を新しい値に更新する前に、それと同等以上の値にレプリカの構成を更新する必要があります。 これにより、レプリカはマスターに対して行われる変更に対応できます。

具体的には、Postgre では、レプリカ サーバーの max_connections パラメーターの値を、マスターの値と等しいかそれより大きくする必要があります。そうしないと、レプリカは開始されません。 Azure Database for PostgreSQL では、max_connections の値は SKU に応じて設定されます。 詳細については、[制限に関するドキュメント](concepts-limits.md)をご覧ください。 

これに違反する更新を行おうとすると、エラーになります。


### <a name="deleting-the-master"></a>マスターを削除する
マスター サーバーを削除すると、そのすべての読み取りレプリカがスタンドアロン サーバーになります。 この変更を反映するため、レプリカは再起動されます。

### <a name="other"></a>その他
- 読み取りレプリカは、マスターと同じ Azure リージョンにのみ作成できます。
- レプリカのレプリカの作成はサポートされていません。

## <a name="next-steps"></a>次の手順
- [Azure portal で読み取りレプリカの作成と管理を行う方法](howto-read-replicas-portal.md)。
