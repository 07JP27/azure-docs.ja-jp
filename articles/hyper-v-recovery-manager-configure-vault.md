<properties linkid="configure-hyper-v-recovery-vault" urlDisplayName="configure-hyper-v-recovery-vault" pageTitle="VMM クラウド内で仮想マシンを保護するための Hyper-V 回復マネージャーの構成" metaKeywords="hyper-v recovery, VMM, クラウド, 障害復旧" description="Azure の Hyper-V 回復マネージャーを使用して、System Center 2012 の VMM プライベート クラウド内に配置されている仮想マシンのレプリケーションと回復を調整することで、アプリケーションとサービスを保護することができます。" metaCanonical="" umbracoNaviHide="0" disqusComments="1" title="Azure の Hyper-V 回復マネージャーの構成" writer="raynew" editor="jimbe" manager="cfreeman" />


# Azure の Hyper-V 回復マネージャーの構成



<div class="dev-callout"> 

<P>Azure の Hyper-V 回復マネージャーは、System Center 2012 Service Pack 1 (SP1) または System Center 2012 R2 の Virtual Machine Manager (VMM) サーバーのプライベート クラウドに配置された Hyper-V 仮想マシンの保護の調整および管理を行います。Hyper-V 回復マネージャーは、ある内部設置型 Hyper-V ホスト サーバーから、他のホスト サーバーへの仮想マシンのフェールオーバーを調整します。Azure 内にある Hyper-V 回復マネージャー コンテナーを使用して、保護された構成を格納します。</P>

<h2><a id="about"></a>このチュートリアルについて</h2>
<P>このチュートリアルでは、Hyper-V 回復マネージャーの展開について簡潔に説明します。詳細については、次のトピックを参照してください。</P>
<UL>
<LI><a href="http://go.microsoft.com/fwlink/?LinkId=321294">Hyper-V 回復マネージャーのプランニング ガイド</a> - 完全な展開を開始する前に完了する必要のあるプランニングのステップの詳細情報を示します。</LI>
<LI><a href="http://go.microsoft.com/fwlink/?LinkId=321295">Hyper-V 回復マネージャーの展開ガイド</a> - 完全な展開を行うための手順を説明しています。</LI>
<LI>このチュートリアルを使用している場合に問題が発生した場合は、<a href="http://go.microsoft.com/fwlink/?LinkId=389879">Hyper-V 回復マネージャーのエラーの一般的なシナリオと解決策に関するページ</a>を参照するか、<a href="http://go.microsoft.com/fwlink/?LinkId=313628">Azure Recovery Services Forum</a></LI> に質問を投稿してください。
</UL>
</div>


<h2><a id="before"></a>開始する前に</h2>
<div class="dev-callout"> 
<P>このチュートリアルを開始する前に、前提条件を確認してください。</P>

<h3><a id="HVRMPrereq"></a>Hyper-V 回復マネージャーの前提条件</h3>

<UL>
<LI>**Azure アカウント** - Azure 復旧サービスの機能を有効にした Azure アカウントが必要です。アカウントがない場合や、機能が登録されていない場合は、<a href="http://aka.ms/try-azure">Azure の無料評価版に関するページ</a>と「<a href="http://go.microsoft.com/fwlink/?LinkId=378268">Hyper-V 回復マネージャーの料金の詳細</a>」を参照してください。</LI>
<LI>**証明書 (.cer)** - VMM サーバーを Hyper-V 回復マネージャー コンテナーに登録するには、公開キーを含む管理証明書 (.cer) をコンテナーにアップロードする必要があります。以下の点に注意してください。<UL>
	<LI>チュートリアルの目的で、Makecert.exe ツールを使用して作成した自己署名証明書を使用することもできます。完全な展開を実行する場合は、プランニング ガイドの「<a href=" http://go.microsoft.com/fwlink/?LinkId=386485">前提条件とサポート</a>」で説明されている証明書の前提条件に従っている、任意の有効な SSL 証明書を使用できます。</LI>
	<LI>各コンテナーには、常に単一の .cer 証明書が関連付けられています。必要に応じて、新しい証明書をアップロードし、既存の証明書を上書きすることもできます。</LI>
</UL></LI>
<LI>**証明書 (.pfx ファイル)** - .cer 証明書は、(秘密キーを含む) .pfx ファイルとしてエクスポートされていることが必要です。保護する仮想マシンを含む各 VMM サーバーに、このファイルをインポートします。次に、展開を実行して各 VMM サーバーに Hyper-V 回復マネージャー プロバイダー エージェントをインストールするときに、VMM サーバーをコンテナーに登録するためにその .pfx ファイルを選択します。</LI>

</UL>

<h3><a id="VMMPrereq"></a>VMM の前提条件</h3>

<UL>
<LI>System Center 2012 SP1 または System Center 2012 R2 で実行されている、少なくとも 1 つの VMM サーバー。</LI>
<LI>VMM のプライベート クラウド。1 つの VMM サーバーを実行している場合は、2 つのクラウドを構成しておく必要があります。複数の VMM サーバーを使用している場合は、保護するソース VMM サーバー上で少なくとも 1 つのクラウドが必要であり、復旧に使用するターゲット VMM サーバー上でも 1 つのクラウドが必要です。保護するプライマリ クラウドには、次のものが含まれている必要があります。<UL>
	<LI>1 つ以上の VMM ホスト グループ</LI>
	<LI>各ホスト グループ内に 1 つ以上の Hyper-V ホスト サーバー。</LI>
		</UL></LI>
<LI>フェールオーバー後に仮想マシンが VM ネットワークに接続されるようにするには、Hyper-V 回復マネージャーでネットワーク マッピングを構成します。展開を開始する前に、次の項目を確認します。<UL>
	<LI>ソース VMM サーバー上のクラウド内にある仮想マシンが、VM ネットワークに接続されています。その VM ネットワークは、クラウドに関連付けられた論理ネットワークにリンクされている必要があります。</LI>
	<LI>ターゲット VMM サーバー上のターゲット クラウドには、対応する VM ネットワークがあります。その VM ネットワークは、ターゲット クラウドに関連付けられた、対応する論理ネットワークにリンクされている必要があります。</LI>
	</UL></LI>
	
	<P>ネットワーク マッピングの詳細については、プランニング ガイドの<a href="http://go.microsoft.com/fwlink/?LinkId=324817">ネットワーク マッピングの準備に関するページ</a>を参照してください。</P>
</UL>


<h2><a id="tutorial"></a>チュートリアルの手順</h2>

前提条件を確認した後、以下の手順を実行します。
<UL>
<LI><a href="#createcert">証明書の取得と構成</a> - .cer 証明書を取得し、.pfx ファイルとしてエクスポートして、その .pfx ファイルを VMM サーバーにインポートします。</LI>
<LI><a href="#vault">ステップ 1: コンテナーの作成</a> - Azure 内で Hyper-V 回復マネージャー コンテナーを作成します。</LI>
<LI><a href="#upload">ステップ 2: 証明書のアップロード</a> - コンテナーに管理証明書をアップロードします。</LI>
<LI><a href="#download">ステップ 3: プロバイダーのダウンロードとインストール</a> - 保護する VMM サーバーに、Hyper-V 回復マネージャー プロバイダーをダウンロードしてインストールします。その後、VMM サーバーをコンテナーに登録します。</LI>
<LI><a href="#clouds">ステップ 4: クラウドの保護の構成</a> - VMM クラウドの保護設定を構成します。</LI>
<LI><a href="#networks">ステップ 5: ネットワーク マッピングの構成</a> - ソース VMM サーバーからターゲット VMM サーバーに VM ネットワークをマッピングします。</LI>
<LI><a href="#virtualmachines">ステップ 6: 仮想マシンに対する保護の有効化</a> - VMM クラウド内に配置された Hyper-V 仮想マシンに対する保護を有効にします。</LI>
<LI><a href="#recovery plans">ステップ 7: 復旧計画の構成と実行</a> - 複数の仮想マシンをグループ化する復旧計画を作成してカスタマイズします。次に、その復旧計画を実行します。</LI>
<LI><a href="#jobs">ステップ 8: 監視</a> - **[ジョブ]** タブと **[ダッシュボード]** タブを使用して、設定、状態、進捗を監視します。</LI>
</UL>



<a name="createcert"></a> <h2>証明書の取得と構成</h2>

次のステップで、証明書を取得して構成します。<OL>
<LI><a href="#obtaincert">チュートリアルで使用する証明書の取得</a> - MakeCert ツールを使用して証明書を取得するか、<a href="http://go.microsoft.com/fwlink/?LinkId=321294">Hyper-V 回復マネージャー計画ガイド</a>で規定されている証明書の要件を満たす既存の証明書を使用します。</LI>
<LI><a href="#exportcert">.pfx 形式での証明書のエクスポート</a> - 証明書の配置先または作成元であるサーバーで、.cer ファイルを、(秘密キーを含む) .pfx ファイルとしてエクスポートします。</LI>
<LI><a href="#importcert">VMM サーバーへの .pfx 証明書のインポート</a> - .pfx ファイルのエクスポートが完了した後、そのファイルを、コンテナーに登録する各 VMM サーバーの Personal 証明書ストアにインポートします。</LI>
</OL>


<h3><a id="obtaincert"></a>自己署名証明書 (.cer) の取得</h3>
<P>次のように MakeCert ツールを使用して、証明書のすべての要件に準拠している .cer 形式の x.509 証明書を作成します。</P>
<ol>
<LI>
MakeCert を実行するコンピューターに、<a href="http://go.microsoft.com/fwlink/?LinkId=378269">Windows SDK</a> の最新バージョンをダウンロードします。Makecert.exe コマンドが、Core Windows ソフトウェア開発キット (Core SDK) の一部であることに注意してください。そのため、SDK 全体をダウンロードしてインストールする必要はありません。</LI>
<LI>[場所の指定] ページで、**[Windows Software Development Kit for Windows 8.1 をこのコンピューターにインストールします]** を選択します。</LI>
<LI>[カスタマー エクスペリエンス向上プログラムに参加します] (CEIP) ページで、希望する設定を選択します。</LI>
<LI>[使用許諾契約書] ページで、**[同意する]** をクリックして条項に同意します。</LI>
<LI>[インストールする機能を選択してください] ページで、**[Windows ソフトウェア開発キット]** を除き、他のすべてのオプションをオフにします。</LI>
<LI>インストールが完了した後、makecert.exe が C:\ProgramFiles (x86)\Windows Kits\<i>WindowsVersion</i>\bin\x64 フォルダーに表示されていることを確認します。</LI>
<LI>管理者特権でコマンド プロンプト (cmd.exe) を開き、makecert.exe フォルダーに移動します。</LI>
<LI>> 次のコマンドを実行して、自己署名証明書を作成します。CertificateName を、その証明書で使用する名前に置き換えます。また、-e: の後に、証明書の実際の有効期限を指定します。</LI>
<code>
makecert.exe -r -pe -n CN=CertificateName -ss my -sr localmachine -eku 1.3.6.1.5.5.7.3.2 -len 2048 -e 01/01/2016 CertificateName.cer</code>
</ol>
<P>証明書が作成され、同じフォルダーに格納されます。次のステップで証明書をエクスポートするために、よりアクセスしやすい場所に、その証明書を移動することもできます。</P>

<h3><a id="exportcert"></a>.pfx 形式での証明書のエクスポート</h3>
<P>次のステップを完了して、.cer ファイルを .pfx 形式にエクスポートします。</P>
<ol>
<li>スタート画面で「**mmc.exe**」と入力して、Microsoft 管理コンソール (MMC) を開始します。</li>
<li>**[ファイル]** メニューの **[スナップインの追加と削除]** をクリックします。**[スナップインの追加と削除]** ダイアログ ボックスが表示されます。</li>
<li>**[利用できるスナップイン]** で、**[証明書]** をクリックし、**[追加]** をクリックします。</li>
<li>**[コンピューター アカウント]** を選択し、**[次へ]** をクリックします。</li>
<li>**[ローカル コンピューター]** を選択し、**[完了]** をクリックします。</li>
<li>MMC のコンソール ツリーで、**[証明書]** を展開し、**[Personal]** を展開します。</li>
<li>詳細ウィンドウで、管理する証明書をクリックします。</li>
<li>**[アクション]** メニューの **[すべてのタスク]** をポイントし、**[エクスポート]** をクリックします。証明書のエクスポート ウィザードが表示されます。**[次へ]** をクリックします。</li>
<li>**[秘密キーのエクスポート]** ページで **[はい]** をクリックして秘密キーをエクスポートします。**[次へ]** をクリックします。この操作は、インストール後に別のサーバーに秘密キーをエクスポートする場合にのみ必要です。</li>
<li>[エクスポート ファイル形式] ページで、**[Personal Information Exchange – PKCS #12 (.PFX)]** を選択します。**[次へ]** をクリックします。</li>
<li>**[パスワード]** ページで、秘密キーの暗号化時に使用するパスワードを入力し、確認のためにもう一度パスワードを入力します。**[次へ]** をクリックします。</li>
<li>ウィザードの指示に従って、証明書を .pfx 形式でエクスポートします。</li>
</ol>


<h3><a id="importcert"></a>VMM サーバーへの .pfx 証明書のインポート</h3>
<p>サーバーをエクスポートしたら、それを、コンテナーに登録する各 VMM サーバーにコピーし、次のステップでインポートします。VMM サーバーで MakeCert.exe を実行した場合は、そのサーバーに証明書をインポートする必要はありません。</p>
 
<ol>
<li>ローカル サーバーに秘密キー (.pfx) 証明書ファイルをコピーします。</li>
<li>証明書 MMC スナップインで **[コンピューター アカウント]** を選択し、[次へ] をクリックします。</li>
<li>[ローカル コンピューター] を選択し、**[完了]** をクリックします。**[スナップインの追加と削除]** ダイアログ ボックスで **[OK]** をクリックします。</li>
<li>MMC で **[証明書]** を展開し、**[Personal]** を右クリックして、[すべてのタスク] をポイントし **[インポート]** をクリックして、証明書のインポート ウィザードを開始します。</li>
<li>証明書のインポート ウィザードの [ようこそ] ページで、**[次へ]** をクリックします。</li>
<li>[インポートするファイル] ページで、**[参照]** をクリックし、インポートする証明書を含む .pfx 証明書ファイルが格納されたフォルダーを見つけます。適切なファイルを選択し、**[開く]** をクリックします。</li>
<li>[パスワード] ページの **[パスワード]** ボックスに、先の手順で指定した秘密キー ファイル用のパスワードを入力して、**[次へ]** をクリックします。</li>
<li>[証明書ストア] ページで、**[証明書をすべて次のストアに配置する]** を選択し、**[参照]** をクリックして、**[Personal]** ストアを選択し、**[OK]** をクリックして、[次へ] をクリックします。</li>
<li>[証明書のインポート ウィザードの完了] ページで **[完了]** をクリックします。</li>
</ol>

これらのステップを完了した後、コンテナーにアップロードする .cer 証明書を選択し、プロバイダーのインストール時に VMM サーバーを登録するときに .pfx 証明書を選択することができます。
</div>


<a name="vault"></a> <h2>ステップ 1: コンテナーの作成</h2>

1. [管理ポータル](https://manage.windowsazure.com)にサインインします。


2. **[データ サービス]** をクリックし、**[復旧サービス]** をクリックします。

	![プレビュー プログラム](./media/hyper-v-recovery-manager-configure-vault/RS_PreviewProgram.png)

3. **[復旧サービス]**、**[新規作成]** の順にクリックし、**[Hyper-V 回復マネージャー コンテナー]** をポイントして、**[簡易作成]** をクリックします。
	
	![新しいコンテナー](./media/hyper-v-recovery-manager-configure-vault/RS_hvvault.png)

3. **[名前]** ボックスに、コンテナーを識別する表示名を入力します。

4. **[リージョン]** ボックスで、コンテナーのリージョンを選択します。利用可能な地域には、アジア太平洋南東部、北ヨーロッパ、および米国東部が含まれています。****

5. **[サブスクリプション]** に、サブスクリプションの詳細を入力します。

5. **[コンテナーの作成]** をクリックします。

<P>ポータルの下部にある通知で、コンテナーの状態を確認します。コンテナーが正常に作成されたことを確認するメッセージが表示されています。[復旧サービス] ページで、コンテナーは **[オンライン]** と表示されています。</P>

<a name="upload"></a> <h2>ステップ 2: 証明書 (.cer) のアップロード</h2>


2. **[復旧サービス]** ページで、必要なコンテナーを開きます。
3. [クイック スタート] アイコンをクリックして、[クイック スタート] ページを開きます。

	![[クイック スタート] アイコン](./media/hyper-v-recovery-manager-configure-vault/RS_QuickStartIcon.png)

2. **[証明書の管理]** をクリックします。

	![クイック スタート](./media/hyper-v-recovery-manager-configure-vault/RS_QuickStart.png)

3. **[証明書の管理]** ダイアログ ボックスで **[ファイルの参照]** をクリックして、コンテナーにアップロードする .cer ファイルを見つけます。


	![証明書の管理](./media/hyper-v-recovery-manager-configure-vault/RS_ManageCert.png)


<a name="download"></a> <h2>ステップ 3: プロバイダーのダウンロードとインストール</h2>
コンテナーに登録する各 VMM サーバーに、Hyper-V 回復マネージャー プロバイダーをインストールします。最新バージョンのプロバイダーのインストール ファイルは、Azure ダウンロード センターにあります。VMM サーバーでこのファイルを実行すると、プロバイダーがインストールされ、VMM サーバーがコンテナーに登録されます。

1. **[クイック スタート]** ページで **[プロバイダーのダウンロード]** をクリックして、プロバイダーをインストールする .exe ファイルを取得します。VMM サーバーでこのファイルを実行し、プロバイダーのセットアップを開始します。

	![エージェントのダウンロード](./media/hyper-v-recovery-manager-configure-vault/RS_installwiz.png)

2. 表示される指示に従って、プロバイダーのインストールを完了します。

	![セットアップの完了](./media/hyper-v-recovery-manager-configure-vault/RS_SetupComplete.png)

3. プロバイダーのインストールが完了したら、ウィザードの指示に従って、VMM サーバーをコンテナーに登録します。
4. [インターネット接続] ページで、VMM サーバーで実行中のプロバイダーがインターネットに接続する方法を指定します。プロバイダーは、サーバー上にある既定のインターネット接続設定を使用できます。または、**[インターネット要求にプロキシ サーバーを使用]** をクリックして、カスタム設定を使用するように指定することもできます。
	
	![インターネット設定](./media/hyper-v-recovery-manager-configure-vault/RS_ProviderProxy.png)

	このチュートリアルでカスタム設定を使用する場合は、展開ガイドの「<a href="http://go.microsoft.com/fwlink/?LinkId=378266">ステップ 2. プロバイダーのインストールと VMM サーバーの登録</a>」を参照してください。


5. [証明書の登録] ページで、コンテナーにアップロードした .cer ファイルに相当する .pfx ファイルを選択します。

	![証明書の登録](./media/hyper-v-recovery-manager-configure-vault/RS_CertReg1.png)

	![証明書コンテナー](./media/hyper-v-recovery-manager-configure-vault/RS_CertReg2.png)

1. [VMM サーバー] ページで、VMM サーバーの表示名を指定します。この名前は、Hyper-V 回復マネージャー コンソールでサーバーを識別するために使用されます。
2. VMM サーバー上に配置されているすべてのプライベート クラウドに存在するデータを Hyper-V 回復マネージャー コンテナーに同期するには、**[コンテナーとのクラウド データの同期]** を選択します。この操作は、各サーバーで 1 回のみ実行する必要があります。すべてのクラウドを同期することを希望しない場合は、クラウドの保護設定を構成する前に、各クラウドを個別に発行して同期することができます。
3. **[登録]** をクリックしてプロセスを完了します。

	![インターネット設定](./media/hyper-v-recovery-manager-configure-vault/RS_PublishCloudSetup.png)

<P>この段階で、VMM サーバーからのメタデータが Hyper-V 回復マネージャーによって取得され、フェールオーバーと復旧の調整に使用されます。サーバーが正常に登録されると、その表示名が、コンテナーの [サーバー] ページの **[リソース]** タブに表示されます。</P>


<h2><a id="clouds"></a>ステップ 4: クラウドの保護設定の構成</h2>

VMM サーバーを登録した後、クラウドの保護設定を構成することができます。VMM サーバーにプロバイダーをインストールしたときに **[コンテナーとのクラウド データの同期]** オプションをオンにしなかった場合は、VMM コンソールを使用してそのクラウドを Hyper-V 回復マネージャーに発行する必要があります。Hyper-V 回復マネージャーによってそのクラウドが検出された後、保護設定を構成することができます。

<h3><a id="publishclouds"></a>クラウドの発行</h3>

1. VMM コンソールで **[VM とサービス]** ワークスペースを開きます。
2. **[VM とサービス]** ウィンドウで、発行するクラウドを開きます。
3. クラウドのプロパティの **[全般]** ページで、クラウドを発行するために、**[このクラウドに関する構成データを Azure の Hyper-V 回復マネージャーに送信]** を選択します。クラウドが発行されると、クラウドがコンテナーに表示されます。

	![クラウド](./media/hyper-v-recovery-manager-configure-vault/RS_PublishCloud.png)

	![発行済みのクラウド](./media/hyper-v-recovery-manager-configure-vault/RS_Clouds.png)

<h3><a id="configureclouds"></a>クラウドの構成</h3>

クラウドの保護方法を構成するには、以下の手順を実行します。

1. [クイック スタート] ページで、**[保護設定の構成]** をクリックします。
2. **[保護された項目]** タブで、構成するクラウドを選択し、**[構成]** タブに移動します。

	![クラウド構成](./media/hyper-v-recovery-manager-configure-vault/RS_CloudConfig.png)


3. **[ターゲットの場所]** で、復旧時に使用するクラウドを管理する VMM サーバーを指定します。
4. **[ターゲット クラウド]** で、ソース クラウド内の仮想マシンのフェールオーバー時に使用するターゲット クラウドを指定します。
5. **[コピーの頻度]** で、既定の設定をそのまま使用します。この値は、ソースとターゲットの場所の間でデータが同期される頻度を指定します。この設定は、Hyper-V ホストが Windows Server 2012 R2 を実行している場合にのみ該当します。他のサーバーでは、5 分間という既定の設定が使用されます。
6. **[追加の復旧ポイント]** で、規定の設定をそのまま使用します。この値は、追加の復旧ポイントを作成するかどうかを指定します。既定値である 0 を使用する場合は、プライマリ仮想マシンに対応する最新の復旧ポイントのみが、レプリカのホスト サーバーに格納されます。
7. **[アプリケーションの整合性スナップショットの頻度]** で、既定の設定をそのまま使用します。この値は、スナップショットを作成する頻度を指定します。スナップショットは、ボリューム シャドウ コピー サービス (VSS) を使用して、スナップショットを作成するときにアプリケーションを一貫性のある状態に保ちます。チュートリアルでこの値を設定する場合は、構成する追加の復旧ポイントの値より小さくするように注意してください。
8. **[データ転送の圧縮]** で、転送されるレプリケート済みデータを圧縮するかどうかを指定します。
9. **[認証]** で、プライマリおよび復旧用の Hyper-V ホスト サーバー間でトラフィックを認証する方法を指定します。動作している Kerberos 環境が既に構成済みの場合を除き、このチュートリアルで使用する目的で [HTTPS] を選択することをお勧めします。HTTPS を選択した場合は、ホスト サーバーはサーバー証明書を使用して相互を認証し、トラフィックは暗号化されます。Hyper-V 回復マネージャーは、HTTPS 認証に使用する証明書を自動的に構成します。手動で構成する必要はありません。この設定は、Windows Server 2012 R2 で実行されている Hyper-V ホスト サーバーだけに関連することに注意してください。
10. **[ポート]** で、既定の設定をそのまま使用します。この値は、ソースとターゲットの Hyper-V ホスト コンピューターがレプリケーション トラフィックをリッスンするポートの番号を設定します。
11. **[初期レプリケーションの設定]** で、通常のレプリケーションを開始する前に実行する初期レプリケーションで、ソースからターゲットにデータを複製する際の処理方法を指定します。
	- **[ネットワーク経由]** - ネットワーク経由でデータをコピーすると、時間がかかり大量のリソースを消費します。クラウドの仮想マシンで使用する仮想ハード ディスクの容量が比較的小さい場合、そして、プライマリ VMM サーバーがセカンダリ VMM サーバーに高速回線で接続されている場合に、このオプションを使用することをお勧めします。コピーを直ちに開始することも、実行時刻を選択することもできます。ネットワーク レプリケーションを使用する場合は、ピーク時間以外に実行することをお勧めします。
	- **[オフライン]** - この方法は、外部メディアを使用して初期レプリケーションを実行することを指定します。これは、ネットワーク性能の低下を避ける場合、または、場所が地理的に離れている場合に便利です。この方法を使用するには、ソース クラウド上のエクスポート場所と、ターゲット クラウド上のインポート場所を指定します。仮想マシンの保護を有効にすると、指定されたエクスポート場所に仮想ハード ディスクがコピーされます。それをターゲット サイトに送信して、インポート場所にコピーします。インポートされた情報はレプリカ仮想マシンに自動的にコピーされます。オフライン レプリケーションの前提条件の一覧については、展開ガイドの「<a href="http://go.microsoft.com/fwlink/?LinkId=323469">ステップ 3. VMM クラウドの保護設定の構成</a>」を参照してください。

<h4><a id="cloudsettingd"></a>保護を構成した後の設定</h4>
クラウドを構成すると、ソース クラウドおよびターゲット クラウドで構成されているすべてのクラスターとホスト サーバーがレプリケーション用に構成されます。具体的には、次のように構成されます。

- Hyper-V Replica が使用するファイアウォール ルールが構成され、レプリケーション トラフィック用のポートが開かれます。
- レプリケーションに必要な証明書がインストールされます。
- Hyper-V Replica 設定が構成されます。

クラウド設定は **[構成]** タブで変更できます。以下の点に注意してください。

- 保護する仮想マシンの復旧要件を満たしたターゲット クラウドを選択することをお勧めします。
- クラウドは、プライマリ クラウドまたはターゲット クラウドとして、ただ 1 つのクラウド ペアに属することができます。
- クラウド構成を保存すると、ジョブが作成され、これを **[ジョブ]** タブで監視できます。構成を保存した後でターゲットの場所やターゲット クラウドを変更する場合は、クラウド構成を削除して、クラウドを再構成する必要があります。




<h2><a id="networks"></a>ステップ 5: ネットワーク マッピングの構成</h2>

**[ネットワーク]** タブで、ソースおよびターゲット VMM サーバー上にある VM ネットワーク間のマッピングを構成します。ネットワーク マッピングにより、フェールオーバー後に、レプリカ仮想マシンが適切なネットワークに接続されること、およびレプリカ仮想マシンが、VM ネットワークにアクセスできるホストに配置されることが確実になります。VMM ネットワークの要件については、プランニング ガイドの「<a href=" http://go.microsoft.com/fwlink/?LinkId=386485">前提条件とサポート</a>」を参照してください。ネットワークは次のようにマッピングすることをお勧めします。

- 保護を構成した各クラウドで、使用するネットワークをマッピングします。
- ネットワーク マッピングは、仮想マシンで保護を有効にする前に実行します。この結果、レプリカ仮想マシンを配置するときにマッピングが使用されるようになります。保護を有効にした後にマッピングを構成する場合も、マッピングは正常に機能しますが、一部のレプリカ仮想マシンの移行が必要になることがあります。

ネットワークをマッピングするには、以下の手順を実行します。

1. [クイック スタート] ページで、**[ネットワーク マッピングの構成]** をクリックします。
4. **[ソースの場所]** で、ソース VMM サーバーを選択します。
5. **[ターゲットの場所]** で、ターゲット VMM サーバーを選択します。単一の VMM サーバーで Hyper-V 回復マネージャーを展開している場合は、ソースとターゲットが同じです。
ソース VM ネットワークと、それに関連付けられたターゲット VM ネットワークの一覧が表示されます。マッピングされていないネットワークには、空白の値が表示されます。
6. ソースとターゲットのリストで、マッピングされていないエントリを選択し、**[マップ]** をクリックします。サービスによってターゲット サーバー上の VM ネットワークが検出され、表示されます。

	![証明書の管理](./media/hyper-v-recovery-manager-configure-vault/RS_networks.png)

7. [ターゲット ネットワークの選択] ページで、ターゲット VMM サーバーで使用するターゲット VM ネットワークを選択します。
	![ターゲット ネットワーク](./media/hyper-v-recovery-manager-configure-vault/RS_TargetNetwork.png)

8. ソース ネットワーク名とターゲット ネットワーク名の横にある情報アイコンをクリックして、各ネットワークのサブネットと種類を表示します。

	ターゲット ネットワークを選択すると、ソース ネットワークを使用する保護対象のクラウドが表示され、クラウドに関連付けられたターゲット VM ネットワークの可用性も表示されます。保護に使用するすべてのクラウドで使用できるターゲット ネットワークを選択することをお勧めします。

8. チェック マークをクリックして、マッピング処理を完了します。ジョブが開始され、マッピングの進行状況を追跡します。これは、**[ジョブ]** タブに表示されます。

	これで、ソース VM ネットワークに接続されている仮想マシンに対応する既存のレプリカ仮想マシンが、ターゲット VM ネットワークに接続されます。また、ソース VM ネットワークに接続されている仮想マシンでレプリケーションを有効にした後に作成された新しいレプリカ仮想マシンも、ターゲット VM ネットワークに接続されます。

<h3><a id="modifynetworks"></a>ネットワーク マッピングの変更</h3>
ネットワーク マッピングは、**[ネットワーク]** タブで変更したり、削除したりできます。以下の点に注意してください。
<UL>
<LI>選択したマッピングを解除すると、マッピングが削除され、マッピング時に接続されていたネットワークからレプリカ仮想マシンが切断されます。</LI>
<LI>選択したマッピングを変更すると、変更が更新され、提供された新しい設定にレプリカ仮想マシンが接続されます。</LI>
</UL>

<h2><a id="virtualmachines"></a>ステップ 6: 仮想マシンの保護の有効化</h2>

<p>サーバー、クラウド、およびネットワークを正しく構成した後で、クラウド内の仮想マシンで保護を有効にすることができます。VMM コンソールで保護を有効にするには、保護する各仮想マシンを右クリックし、**[復旧を有効にする]** を選択します。</p>

<p>保護を有効にした後、クラウド内にある仮想マシンの一覧で、仮想マシンを表示できます。保護を有効化するアクションの進行状況は、**[ジョブ]** タブに表示されます。</p>

![仮想マシン](./media/hyper-v-recovery-manager-configure-vault/RS_Clouds.png)

<P>仮想マシンの保護を有効にすると、3 つのジョブが作成されます。Enable Protection ジョブが実行されます。そして、初期レプリケーションが完了した後に、さらに 2 つの Finalize Protection ジョブが実行されます。仮想マシンは、これらの 3 つのジョブが正常に完了するまでは、フェールオーバーできる状態になりません。</P>

<h2><a id="recoveryplans"></a>ステップ 7: 復旧計画の構成と実行</h2>
復旧計画では、複数の仮想マシンをグループ化し、その結果、これらの仮想マシンは 1 つのユニットとして処理できるようになります。また、このグループがフェールオーバーされる順序も指定します。仮想マシンのグループ化に加えて、復旧計画をカスタマイズして、自動スクリプトを実行することや、手動アクションの確認画面が表示されるまで待つように設定することができます。復旧計画を作成するには、以下の手順を実行します。

1. [クイック スタート] ページで **[復旧計画の作成]** をクリックします。
2. [復旧計画の名前とターゲットを指定します] ページで、名前と、ソース VMM サーバーおよびターゲット VMM サーバーを入力します。単一の VMM サーバーで Hyper-V 回復マネージャーを展開している場合は、ソースとターゲットのサーバーが同一になります。ソース VMM サーバーには、保護が有効になっている仮想マシンを含める必要があります。

	![復旧計画の作成](./media/hyper-v-recovery-manager-configure-vault/RS_RecoveryPlan1.png)
3. [仮想マシンの選択] ページで、復旧計画に追加する仮想マシンを選択します。これらは、復旧計画の既定のグループ (グループ 1) に追加されます。
4. チェック マークをクリックして、復旧計画を作成します。**[復旧計画]** タブで、作成した復旧計画を削除することもできます。

	![復旧計画の VM](./media/hyper-v-recovery-manager-configure-vault/RS_RecoveryPlan2.png)


復旧計画を作成すると、次の操作を実行できます。

- 計画をカスタマイズします。新しいグループを復旧計画に追加したり、グループに仮想マシンを追加したりできます。指定したグループの前後に完了するスクリプトと手動アクションという形式で、カスタム アクションを定義できます。グループ名は番号が自動的に増加します。既定の復旧計画グループ 1 の後は、グループ 2、グループ 3 の順に作成されます。仮想マシンは、グループの順序に従ってフェールオーバーされます。復旧計画をカスタマイズする方法の詳細については、展開ガイドの「<a href="http://go.microsoft.com/fwlink/?LinkId=378271">ステップ 6. 復旧計画の作成とカスタマイズ</a>」を参照してください 。
- テスト フェールオーバーを実行します。


<h3><a id="run"></a>復旧計画の実行</h3>
復旧計画は、事前対応的なテストまたは計画されたフェールオーバーの一部として実行することも、計画されていないフェールオーバー時に実行することもできます。このチュートリアルでは、テスト フェイル オーバーを実行する方法について説明します。他の種類のフェイル オーバーの詳細については、「<a href="hhttp://go.microsoft.com/fwlink/?LinkId=378272">Operations and monitoring guide</a>」を参照してください。

<h3><a id="protect"></a>計画を実行します。</h3>

復旧計画を確認するために、テスト環境でテスト フェールオーバーを実行します。テスト フェールオーバーは、復旧計画と仮想マシンのフェールオーバー戦略が想定どおりに動作することを確認する場合に便利です。テスト フェールオーバーは、孤立したネットワークでフェールオーバーと復旧のシミュレーションを実行します。

<h5><a id="networkrecommendations"></a>開始する前に</h5>
テスト フェールオーバーがトリガーされると、フェールオーバー後のテスト仮想マシンのネットワークへの接続方法を指定するよう要求されます。
<UL>
<LI>既存のネットワークを使用する場合は、このテストを実行する目的で、運用環境で使用していない独立した論理ネットワークを作成することをお勧めします。</LI>
<LI>テスト VM ネットワークを自動的に作成するオプションを選択した場合は、テスト フェールオーバーが完了した後、一時的なネットワークとテスト仮想マシンが自動的にクリーンアップされます。</LI>
<LI>仮想 LAN (VLAN) ベースの論理ネットワークを使用している場合は、論理ネットワークに追加するネットワーク サイトが孤立していることを確認します。</LI>
<LI>Windows ネットワーク仮想化ベースの論理ネットワークを使用している場合、Hyper-V 回復マネージャーによって孤立した VM ネットワークが自動的に作成されます。</LI>
</UL>


<h5><a id="runtest"></a>テスト フェールオーバーの実行</h5>
復旧計画のテスト フェールオーバーを、次のように実行します。

<OL>
<LI>**[復旧計画]** タブで、必要な復旧計画をクリックします。</LI>
<LI>フェールオーバーを開始するには、**[テスト フェールオーバー]** ボタンをクリックします。</LI>
<LI>[テスト フェールオーバーの確認] ページで、テスト フェールオーバー後の仮想マシンのネットワークへの接続方法を、次のように指定します。</LI>
<UL>
<LI>**[なし]** - テスト フェールオーバーで VM ネットワークを使用しないように指定するには、この設定を選択します。このオプションは、ネットワーク構成ではなく、個々の仮想マシンをテストする場合に使用します。これを選択すると、テスト フェールオーバーが機能するしくみの概要が表示されます。テスト仮想マシンは、フェールオーバー後にネットワークに接続されません。</LI>
<LI>**既存のものを使用** - このオプションは、テスト フェールオーバーに使用する VM ネットワークを既に作成し、孤立させた場合に使用します。フェールオーバー後に、テスト フェールオーバーで使用したすべてのテスト仮想マシンは、**[VM ネットワーク]** で指定したネットワークに接続されます。</LI>
<LI>**自動的に作成** - [論理ネットワーク] で指定した設定と、それに関連するネットワーク サイトに基づいて、Hyper-V 回復マネージャーが VM ネットワークを自動的に作成するよう指定する場合は、この設定を選択します。このオプションは、復旧計画で複数の VM ネットワークを使用する場合に使用します。Windows ネットワーク仮想化ネットワークの場合は、このオプションを使用して、レプリカ仮想マシンのネットワーク内のものと同じ設定 (サブネットおよび IP アドレス プール) の VM ネットワークを自動的に作成できます。これらの VM ネットワークは、テスト フェールオーバーの完了後に自動的にクリーンアップされます。</LI>
</UL>
</OL>


<P>テスト フェールオーバーが完了したら、以下の手順を実行します。</P>
<OL>
<LI>仮想マシンが正常に起動することを確認します。</LI>
<LI>仮想マシンが正常に起動することを確認したら、テスト フェールオーバーを完了して、孤立した環境をクリーンアップします。VM ネットワークの自動作成を選択した場合は、クリーンアップにより、すべてのテスト仮想マシンとテスト ネットワークが削除されます。</LI>
<LI>**[メモ]** をクリックして、テスト フェールオーバーに関連する監察結果をすべて記録し、保存します。</LI>
<LI>復旧計画に対応するテスト フェールオーバーを開始すると、フェールオーバー プロセスが、復旧計画の詳細ページに表示されます。テスト フェールオーバーの個々のステップとその状態を確認し、テスト フェールオーバーに関連するメモを表示したり、作成したりできます。また、フェールオーバー ジョブの詳細を、**[ジョブ]** タブのフェールオーバー ジョブで確認することもできます。詳細には、フェールオーバーに関連する各ジョブ、その状態、開始日時、期間が表示されます。フェールオーバーの一覧にあるジョブは、Excel スプレッドシートにエクスポートできます。</LI>
</OL>


以下の点に注意してください。

- [テスト フェールオーバーの確認] ページには、テスト仮想マシンの作成先になる VMM サーバーの詳細が表示されます。
- テスト フェールオーバー ジョブの進行状況は、**[ジョブ]** タブで確認できます。






<h2><a id="jobsdashboard"></a>ステップ 8: 監視</h2>
<h3><a id="jobsdashboard"></a>[ジョブ] タブとダッシュボードの使用</h3>

<h4><a id="jobs"></a>ジョブ</h4>
**[ジョブ]** タブには、Hyper-V 回復マネージャー コンテナーで実行されるメイン タスクが表示されます。これには、クラウドに対する保護の構成、仮想マシンに対する保護の有効化と無効化、フェールオーバー (計画された、計画されていない、またはテスト) の実行、計画されていないフェールオーバーのコミット、およびレプリケーションの反転の構成が含まれます。

**[ジョブ]** タブでは、次のタスクを実行できます。



- **ジョブ クエリの実行** - 指定した条件に一致するジョブを取得するクエリを実行できます。次のパラメーターを使用して、ジョブをフィルター処理することもできます。

-	特定の VMM サーバーで実行されたジョブを見つけます。
-	クラウド、仮想マシン、ネットワーク、クラウドの復旧計画、またはこれらすべてで実行されたジョブを見つけます。
-	特定の日付および時刻の範囲内に発生したジョブを特定します。

クエリでは最大 200 件のジョブが返されるため、この最大値より少ないジョブが返されるようにパラメーターを絞り込むことをお勧めします。

- **ジョブの詳細の取得** - **[ジョブ]** リストでジョブをクリックして詳細を取得できます。ジョブの詳細には、ジョブ名、そのステータス、開始日時、および継続期間が含まれます。[ジョブの詳細] タブで、ジョブの詳細を Excel スプレッドシートにエクスポートできます。また、失敗、スキップ済み、または取り消し済みのジョブの再開を試みることができます。
- **ジョブのエクスポート** - ジョブ クエリの結果を Excel スプレッドシートにエクスポートできます。
- **再開** - 失敗したジョブを再開して再実行を試みることができます。
- **エラーの詳細** - 失敗したジョブについては、**[エラーの詳細]** をクリックして、ジョブのエラーのリストを取得できます。各エラーについて、考えられる原因と推奨される対処方法が表示されます。エラーの説明をクリップボードにコピーして、トラブルシューティングに利用することができます。


>**[ジョブ]** タブには、次の情報が表示されます。
<UL>
<LI>**名前** - ジョブ名</LI>
<LI>**項目** - クラウド、復旧計画、VMM サーバー、またはジョブが実行された仮想マシン。</LI>
<LI>**状態** - ジョブの状態 (完了、取り消し済み、失敗、その他)</LI>
<LI>**種類** - ジョブの種類</LI>
<LI>**開始日時** - ジョブが開始された日時</LI>
<LI>**タスク時間** - ジョブの期間</LI>
</UL>

![[ジョブ] タブ](./media/hyper-v-recovery-manager-configure-vault/RS_Jobs.png)



<h4><a id="protect"></a>ジョブ クエリの実行</h4>

以下のような条件を指定して、その条件に一致するジョブを取得するクエリを実行できます。
<UL>
	<LI>特定の VMM サーバーで実行されたジョブ。</LI>
	<LI>特定のクラウド、仮想マシン、ネットワーク、復旧計画、またはこれらすべてで実行されたジョブ。</LI>
	<LI>特定の期間に発生したジョブ。</LI>
</UL>
	

ジョブ クエリを実行するには、以下の手順に従います。
<OL>
<LI>**[ジョブ]** タブを開きます</LI>
<LI>**[サーバー]** で、ジョブの実行に使用した VMM サーバーを指定します。</LI>
<LI>**[種類]** で、クラウド、仮想マシン、ネットワーク、クラウドの復旧計画のどれがジョブの実行対象であったかを指定します。</LI>
<LI>**[状態]** で、ジョブの状態を指定します。</LI>
<LI>**[期間]** で、ジョブが発生した期間を指定します。</LI>
</OL>


<h4><a id="dashboard"></a>ダッシュボード</h4>
<P>**[ダッシュボード]** タブには、組織における Hyper-V 回復マネージャー使用状況の概要が表示されます。これは、Hyper-V 回復マネージャー コンテナーで保護される仮想マシンを表示する一元的ゲートウェイです。ダッシュボードでは、次の機能を使用できます。</P>

**[ダッシュボード]** タブで、次のタスクを実行できます。



- **[プロバイダーのダウンロード]** - VMM サーバーにインストールする Hyper-V 回復マネージャー プロバイダーをダウンロードします。
- **証明書の管理** - コンテナーに関連付けられた証明書の設定を変更します。
- **削除** - コンテナーを削除します。
- **仮想マシンの再同期化** - Hyper-V 回復マネージャーで、プライマリおよび復旧仮想マシンが想定どおりに同期されていないことを検出した場合は、関連する仮想マシンの一覧を表示し、ダッシュボードで再同期するものを選択できます。


**[ダッシュボード]** タブには、次の情報が表示されます。
<UL>
<LI**>使用状況の概要** - Hyper-V 回復マネージャーで保護された仮想マシンの数が表示されます。</LI>
<LI>**概要** - 復旧サービスと Hyper-V 回復マネージャー コンテナーに関する重大な構成情報が表示されます。コンテナーがオンラインかどうか、コンテナーに割り当てられている証明書、証明書の有効期限、サービスのサブスクリプションの詳細を確認できます。</LI>
<LI>**最近のジョブ** - 最近 24 時間以内に成功または失敗したジョブ、あるいは進行中またはアクションの待機中であるジョブが表示されます。</LI>
<LI>**問題点** - ダッシュボードには、VMM サーバー接続の問題や、クラウド構成設定または仮想マシン レプリケーションの同期の問題に関する情報が表示されます。問題の詳細情報や、問題に関連付けられたジョブを表示したり、仮想マシンの再同期を試みたりできます。</LI>
</UL>

![ダッシュボード](./media/hyper-v-recovery-manager-configure-vault/RS_Dashboard.png)

<h2><a id="next"></a>次のステップ</h2>
<UL>
<LI>完全な運用環境で Hyper-V 回復マネージャーの計画と展開を実行するには、「<a href="http://go.microsoft.com/fwlink/?LinkId=321294">Hyper-V 回復マネージャー計画ガイド
</a>」と「<a href="http://go.microsoft.com/fwlink/?LinkId=321295">Hyper-V 回復マネージャー展開ガイド</a>」を参照してください。</LI>
<LI>疑問がある場合は、<a href="http://go.microsoft.com/fwlink/?LinkId=313628">Azure 復旧サービス フォーラム</a>にアクセスします。</LI>
</UL>

