<properties 
	pageTitle="Azure Websites 上のアプリケーションが利用できるオペレーティング システムの機能" 
	description="Azure Websites 上の Web アプリケーションで使用できる OS の機能について学習します。" 
	services="web-sites" 
	documentationCenter="" 
	authors="cephalin" 
	manager="wpickett" 
	editor="mollybos"/>

<tags 
	ms.service="web-sites" 
	ms.workload="web" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="11/11/2014" 
	ms.author="cephalin"/>

# Azure Websites 上のアプリケーションが利用できるオペレーティング システムの機能 #

この記事では、Azure Websites 上で動作するすべてのアプリケーションが利用できる基本的なオペレーティング システム機能について説明します。これらの機能には、ファイル アクセス、ネットワーク アクセス、レジストリ アクセス、診断ログ、イベントがあります。 

##目次

* [Web サイトのモード](#websitemodes)
* [開発フレームワーク](#developmentframeworks)
* [ファイル アクセス](#FileAccess)
	* [ローカル ドライブ](#LocalDrives)
	* [ネットワーク ドライブ ("UNC 共有" とも呼ばれます)](#NetworkDrives)
	* [複数のインスタンス間でのファイル アクセス](#multipleinstances)
	* [Web アプリケーションに付与されるファイル アクセスの種類](#TypesOfFileAccess)
* [ネットワーク アクセス](#NetworkAccess)
* [コードの実行、プロセス、メモリ](#Code)
* [診断ログとイベント](#Diagnostics)
* [レジストリ アクセス](#RegistryAccess)

<a id="websitemodes"></a>
<h2>Web サイトのモード</h2>
Azure Websites は、顧客の Web サイトをマルチテナント ホスティング環境で実行します。Free または Shared のスケール モードでデプロイされた Web サイトは、共有仮想マシン上のワーカー プロセスで実行されます。一方、Standard スケール モードでデプロイされた Web サイトは、その顧客専用の仮想マシン上で実行されます。

Azure Websites はどのモードでもシームレスにスケーリングされるので、Web サイトのセキュリティ構成は選択するモードに左右されません。これにより、Web サイトを別のモードに切り替えたとき、Web アプリケーションの動作が突然が変わって予期しないエラーが発生するのを防ぐことができます。

<a id="developmentframeworks"></a>
<h2>開発フレームワーク</h2>

Web サイトで使用できるコンピューティング リソース (CPU、ディスク ストレージ、メモリ、ネットワーク) は、Web サイトのモードによって異なります。ただし、アプリケーションで使用できるフレームワーク機能はどのモードでも変わりません。

Azure Websites は、ASP.NET、クラシック ASP、node.js、PHP、python などの各種の開発フレームワークをサポートしています。これらはすべて、IIS 内で拡張機能として実行されます。セキュリティ構成を標準化して単純にするために、Azure Websites では通常、各種の開発フレームワークが既定の設定で実行されます。Azure Websites では、API へのアクセスと機能を開発フレームワークごとにカスタマイズするのではなく、より汎用的なアプローチをとっています。つまり、Web サイトのアプリケーション開発フレームワークにかかわらず使用できる、共通の基本的なオペレーティング システム機能が用意されています。

この後の各セクションでは、Azure の Web サイトで使用できる汎用オペレーティング システム機能について概説します。


<a id="FileAccess"></a>
<h2>ファイル アクセス</h2>

Azure Websites には、ローカル ドライブやネットワーク ドライブなど、さまざまなドライブが存在します。

<a id="LocalDrives"></a>
<h3>ローカル ドライブ</h3>

根本的に、Azure Websites は、Azure PaaS (Platform as a Service) インフラストラクチャ上で動作するサービスです。したがって、仮想マシンに"接続"されるローカル ドライブは、Azure 上の worker ロールで使用するドライブと同じ種類です。これには、オペレーティング システム ドライブ (D:\ ドライブ)、Azure Websites でのみ使用する (顧客はアクセスできない) Azure パッケージ cspkg ファイルを保存するアプリケーション ドライブ、および"ユーザー" ドライブ (C:\ ドライブ) があり、そのサイズは仮想マシンのサイズによって異なります。

<a id="NetworkDrives"></a>
<h3>ネットワーク ドライブ ("UNC 共有" とも呼ばれます)</h3>

Web アプリケーションのデプロイとメンテナンスを容易にする Azure Websites の特長の 1 つは、すべてのユーザー コンテンツが一連の UNC 共有に保存されることです。このモデルは、複数の負荷分散サーバーを配した内部設置型 Web ホスティング環境で使用される共通のコンテンツ ストレージ パターンに対応します。 

Azure Websites 内で、各データ センターに複数の UNC 共有が作成されます。データ センターごとに、すべての顧客のユーザーコンテンツの割合が各 UNC 共有に反映されます。さらに、個々の顧客のサブスクリプションのすべてのファイル コンテンツは、必ず同じ UNC 共有に配置されます。 

クラウド サービスの性質上、UNC 共有をホストする仮想マシンはその時々で変わります。通常のクラウド運用で仮想マシンが起動または停止するたびに、必要な仮想マシンに UNC 共有が確実にマウントされます。したがって、UNC ファイル パスのマシン情報が常に変わらないことを前提として Web アプリケーションをハードコーディングしないでください。代わりに、Azure Websites に用意されている  *faux* の絶対パス **D:\home\site** を使用してください。この "偽" の絶対パスを使用すれば、サイトとユーザーが変わっても常に目的のサイトを表すことができます。つまり、**D:\home\site** を使用することで、共有ファイルを別のサイトへ移動するたびに新しい絶対パスを構成する必要がなくなります。

<a id="TypesOfFileAccess"></a>
<h3>Web アプリケーションに付与されるファイル アクセスの種類</h3>

顧客のサブスクリプションごとに、データ センター内の UNC 共有上にディレクトリ構造が確保されます。顧客が同じデータ センター内に複数の Web サイトを作成している場合は、その顧客サブスクリプションに属するすべてのディレクトリが同じ UNC 共有上に作成されます。この共有には、コンテンツ ログ、エラー ログ、診断ログのためのディレクトリ、ソース管理によって作成された以前のバージョンの Web サイトのディレクトリなどが配置されます。もちろん、顧客の Web サイトのディレクトリは、実行時に Web サイトのアプリケーション コードから読み書きできます。

Azure Websites では、Web サイトを実行する仮想マシンに接続されたローカル ドライブ (C:\ ドライブ) 上に、その Web サイト専用の一時的なローカル ストレージ領域が確保されます。Web サイトはこの一時ローカル ストレージを自由に読み書きできますが、アプリケーション コードからの直接アクセスは本来の使用方法ではありません。このストレージの目的は、IIS および Web アプリケーション フレームワークに一時的なファイル ストレージを提供することです。さらに、Azure Websites では、各 Web サイトで使用できる一時ローカル ストレージの容量も制限されます。これは、それぞれのサイトがローカル ファイル ストレージを過度に消費するのを防ぐためです。

Azure Websites での一時ローカル ストレージの使用例として、ASP.NET 一時ファイルのディレクトリと IIS 圧縮ファイルのディレクトリがあります。ASP.NET コンパイル システムは、"Temporary ASP.NET Files" ディレクトリをコンパイルの一時的なキャッシュ場所として使用します。IIS は、"IIS Temporary Compressed Files" ディレクトリを使用して圧縮済みの応答出力を保存します。これらはいずれも、Azure Websites では Web サイトごとの一時ローカル ストレージに再マッピングされます。この再マッピングにより、引き続き適切に機能させることができます。

Azure Websites の各 Web サイトは、独自のランダムな低権限ワーカー プロセス ID として実行されます。これを "アプリケーション プール ID" といいます (詳細については、次をご覧ください)。[http://www.iis.net/learn/manage/configuring-security/application-pool-identities](http://www.iis.net/learn/manage/configuring-security/application-pool-identities). アプリケーション コードはこの ID を使用し、オペレーティング システム ドライブ (D:\ ドライブ) に読み取り専用でアクセスします。つまり、アプリケーション コードは、オペレーティング システム ドライブ上の共通ディレクトリ構造を参照し、共通ファイルを読み取ることができます。少々広範なアクセス レベルに思えるかもしれませんが、Azure ホステッド サービスに worker ロールをプロビジョニングしてドライブ コンテンツを読み取る場合も、同じディレクトリとファイルにアクセスできます。 

<a name="multipleinstances"></a>
### 複数のインスタンス間でのファイル アクセス

ホーム ディレクトリにはサイトのコンテンツが含まれ、Web アプリケーションからの書き込みが可能です。Web サイトが複数のインスタンスで実行される場合、ホーム ディレクトリはすべてのインスタンスで共有されるため、すべてのインスタンスが同じディレクトリを参照することになります。たとえば、アップロードされたファイルを Web サイトがホーム ディレクトリに保存すると、それらのファイルはすぐにすべてのインスタンスから利用できるようになります。 

<a id="NetworkAccess"></a>
<h2>ネットワーク アクセス</h2>
アプリケーション コードは、TCP/IP ベースおよび UDP ベースのプロトコルを使用してインターネットに接続し、外部サービスを公開しているエンドポイントにアクセスできます。アプリケーションはこれらの同じプロトコルを使用して、#151;SQL Azure に HTTPS 接続を確立するなどして、Azure 内のサービスに接続できます。

アプリケーションでローカル ループバック接続を確立し、そのローカル ループバック ソケットでリッスンするための機能も限定的に用意されています。主な目的は、アプリケーション機能の一環として、ローカル ループバック ソケットでリッスンできるようにすることです。ループバック接続は顧客のアプリケーションごとに"非公開"である点にご注意ください。つまり、アプリケーション "A" は、アプリケーション "B" が設定したローカル ループバック ソケットではリッスンできません。

1 つの Web サイトの実行に複数のプロセスがかかわっている場合、それらのプロセスが互いに通信する手段 (プロセス間通信: IPC) として、名前付きパイプもサポートされています。たとえば、IIS FastCGI モジュールは、名前付きパイプを利用して PHP ページを実行する複数のプロセスを調整します。


<a id="Code"></a>
<h2>コードの実行、プロセス、メモリ</h2>
前述のように、Web サイトは、ランダムなアプリケーション プール ID を使用して低権限のワーカー プロセス内で実行されます。アプリケーション コードは、ネットワーク プロセス、および CGI プロセスや他のアプリケーションが生成する子プロセスに関連付けられたメモリ空間にアクセスできます。ただし、ある Web サイト上のアプリケーションから、別の顧客の Web サイトのメモリやデータにアクセスすることはできません。これは、別の Web サイトが同じ仮想マシン上に配置されている場合でも同じです。

アプリケーションは、サポート対象の Web アプリケーション開発フレームワークで記述されたスクリプトやページを実行できます。Azure Websites では、Web アプリケーションのフレームワークがより限定的なモードに構成されることはありません。たとえば、Azure Websites 上の ASP.NET サイトは、限定的な信頼モードではなく"完全"信頼で実行されます。アプリケーション フレームワークでは、クラシック ASP と ASP.NET も含めて、Windows オペレーティング システムに既定で登録されている ADO (ActiveX Data オブジェクト) などのインプロセス COM コンポーネントを呼び出すことができます (アウトプロセス COM コンポーネントは対象外)。

Web アプリケーションは任意のコードを生成して実行できます。たとえば、コマンド シェルを生成したり、PowerShell スクリプトを実行したりできます。ただし、Web アプリケーションで任意のコードとプロセスを生成できる場合でも、実行形式のプログラムやスクリプトに与えられる権限は親アプリケーション プールと同じになります。たとえば、Web サイトは外部への HTTP 呼び出しを行う実行可能ファイルを生成できますが、その実行可能ファイルは、仮想マシンの IP アドレスを NIC から解除することはできません。外部へのネットワーク呼び出しは低権限のコードでも実行できますが、仮想マシンのネットワーク設定を再構成するには管理者権限が必要です。


<a id="Diagnostics"></a>
<h2>診断ログとイベント</h2>
一部の Web アプリケーションは、ログ情報というデータ セットにアクセスします。Azure Websites 上のコードが使用できるログ情報には診断ログがあります。これは、Web サイトによって生成され、Web サイトから簡単にアクセスできるログ情報です。 

たとえば、アクティブな Web サイトによって生成される W3C HTTP ログは、その Web サイトのネットワーク共有場所にあるログ ディレクトリか、顧客が W3C ログを設定している場合は BLOB ストレージに格納されます。BLOB ストレージを使用すると、ネットワーク共有のファイル ストレージ制限を気にすることなく大量のログを収集できます。

同様に、.NET のトレース/診断インフラストラクチャを使用すれば、.NET アプリケーションの診断情報をリアルタイムに記録できます。その際、トレース情報を Web サイトのネットワーク共有に書き込むか、BLOB ストレージに書き込むかを選択できます。

Azure 上の Web アプリケーションが使用できない診断情報ログ機能とトレース機能は、Windows ETW イベントと標準の Windows イベント ログ (システム ログ、アプリケーション ログ、セキュリティ イベント ログ) です。(適切な ACL があれば) マシン上で ETW トレース情報を参照できるので、ETW イベントへの読み取りアクセスと書き込みアクセスがブロックされます。アプリケーションの開発時には、ETW イベントや標準の Windows イベント ログを読み書きする API 呼び出しが機能するように見えるかもしれませんが、これは、Azure Websites がそのように"見せかけている"にすぎません。実際には、Web サイトのアプリケーション コードはこれらのイベント データにアクセスできません。

<a id="RegistryAccess"></a>
<h2>レジストリ アクセス</h2>
アプリケーションは、実行基盤となる仮想マシンの多くのレジストリ (すべてのレジストリではありません) に読み取り専用でアクセスできます。つまり、Web アプリケーションは、ローカル ユーザー グループへの読み取り専用アクセスを許可するレジストリ キーにアクセスできることになります。現在、読み取りアクセスまたは書き込みアクセスがサポートされていないレジストリ領域の 1 つに、HKEY\_CURRENT\_USER ハイブがあります。

レジストリへの書き込みアクセスはブロックされます。ユーザーごとのレジストリ キーにも一切アクセスできません。クラウド環境の場合、アプリケーションが他の仮想マシンへ移行される可能性があるので、レジストリへの書き込みアクセスを前提にしてコードを開発しないでください。Web アプリケーションで利用できる唯一の書き込み可能な永続ストレージは、Azure Websites の UNC 共有に格納される Web サイト別のコンテンツ ディレクトリ構造です。 


<!--HONumber=42-->
