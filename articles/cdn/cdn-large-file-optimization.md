---
title: "Azure CDN を介した大きなファイルのダウンロードの最適化"
description: "大きなファイルのダウンロードの最適化の詳細"
services: cdn
documentationcenter: 
author: smcevoy
manager: erikre
editor: 
ms.assetid: 
ms.service: cdn
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/16/2017
ms.author: v-semcev
ms.translationtype: Human Translation
ms.sourcegitcommit: 857267f46f6a2d545fc402ebf3a12f21c62ecd21
ms.openlocfilehash: 27e202b05f86eeee7071f3fae145caeba3d66827
ms.contentlocale: ja-jp
ms.lasthandoff: 06/28/2017

---
# <a name="large-file-download-optimization-via-azure-cdn"></a>Azure CDN を介した大きなファイルのダウンロードの最適化

インターネット経由で配信されるコンテンツのファイル サイズは、機能の強化、グラフィックスの向上、リッチ メディア コンテンツが原因で絶えず拡大してきました。 これは、ブロードバンドの浸透、低価格ストレージ デバイスの大容量化、高解像度ビデオの急増、インターネットに接続されるデバイス (IoT) などの多くの要因によって引き起こされます。このような大きなファイルの高速で効率的な配信メカニズムを提供することは、お客様がスムーズで楽しい経験をすることを可能にするために極めて重要です。 

大きなファイルの配信に固有の課題がいくつかあります。 まず、大きなファイルのダウンロードにかかる平均時間は長い可能性があり、多くのアプリケーションはすべてのデータを順番にはダウンロードしない可能性があります。 場合によっては、アプリケーションはファイルの先頭部分より前に最後の部分をダウンロードすることがあります。 そのため、少量のファイルのみが要求される場合や、ユーザーがダウンロードを一時停止した場合は、ダウンロードか失敗したり、ファイル全体が CDN によって配信元から取得されるまで遅延したりすることがあります。 

次に、インターネット上の大きなファイルの急増により、ユーザーは、ユーザーとファイル間の待機時間が、最終的にスループットやユーザーがコンテンツを参照できるまでの時間を示すことに気づく場合があります。 また、ネットワークの輻輳やキャパシティの問題はスループットにさらなる影響を及ぼし、これらの問題にサーバーとエンド ユーザー間の距離の延長が組み合わされて、パケット損失の発生機会が増加し、品質がさらに低下します。 スループットの制限とパケット損失の増加が原因の品質低下は、ファイル ダウンロードの完了までの待ち時間の大幅な増加に表れることがあります。 

最後に、大きなファイルの多くは完全には配信されません。 ユーザーは、ダウンロードを途中で取り消したり、長い MP4 ビデオの最初の数分のみ視聴したりすることがあります。 そのため、多くのソフトウェアとメディア配信の企業にとって、エンド ユーザーが要求しているファイルの部分だけを配信することが役立ちます。 こうすると、要求された部分だけがインターネットの最も遠い場所に効率よく配信され、配信元からのエグレス トラフィックが減少するため、配信元サーバーのメモリと IO への負荷が低減します。 

Azure CDN from Akamai は、大きなファイルを世界中のエンド ユーザーに短い待ち時間で効率的に配信し、かつ配信元サーバーの負荷を低減する機能を提供するようになりました。 この機能は、"Standard Akamai" の価格レベルで Azure CDN プロファイルで作成された Azure CDN エンドポイントの [最適化の対象] 機能を使用して実現されます。

## <a name="configuring-cdn-endpoint-to-optimize-delivery-of-large-files"></a>大きなファイルの配信を最適化するための CDN エンドポイントの構成

エンドポイント作成時に [最適化の対象] プロパティの選択で [大きなファイルのダウンロード] オプションを選択するだけで、Azure Portal を介した大きなファイルの配信を最適化するように CDN エンドポイントを構成できます。 REST API またはクライアント SDK のいずれかを使ってこれを行うこともできます。 次のスクリーン ショットは、Azure Portal を使ったプロセスを示しています。

![新しい CDN エンドポイント](./media/cdn-large-file-optimization/01_Adding.png)  
 
*図 1: CDN プロファイルから新しい CDN エンドポイントを追加*
 
![LFO が選択されています](./media/cdn-large-file-optimization/02_Creating.png)

*図 2: [大きなファイル ダウンロード] の最適化が選択された CDN エンドポイントの作成*

CDN エンドポイントを作成した後は、特定の条件に一致するすべてのファイルに大きなファイルの最適化が適用されます。 次のセクションでは、これを詳しく説明します。

## <a name="optimizing-for-delivery-of-large-files-with-azure-cdn-from-akamai"></a>Azure CDN from Akamai を使った大きなファイルの配信の最適化

Azure CDN from Akamai では、大きなファイルの最適化の種類の機能を使って、大きなファイルをより高速に、かつ高い応答性で配信するネットワーク最適化と構成を有効にできます。 Akamai による一般的な Web 配信では、1.8 GB 未満のファイルのみキャッシュでき、最大 150 GB のファイルを (キャッシュではなく) トンネルできますが、大きなファイルの最適化により、最大 150 GB のファイルをキャッシュできます。

大きなファイルの最適化は、配信元サーバーの動作、要求されるファイルの種類、要求されるファイルのサイズに関して特定の条件が満たされる場合に効果的です。 それぞれの詳細に進む前に、最適化の動作の大まかな概要を理解しておくことが重要です。 

### <a name="object-chunking"></a>オブジェクト チャンク 

Azure CDN from Akamai では、大きなファイルが要求されたときに、CDN が配信元からファイルの小さな部分を取得する、オブジェクト チャンクという手法が採用されています。 CDN エッジ/POP サーバーは、エンド ユーザーからファイル全体またはバイト範囲の要求を受信すると、ファイルの種類がこの最適化でサポートされるファイルの種類の一覧に属するかどうかと、ファイル サイズ要件を満たすかどうかを確認します。 ファイル サイズが 10 MB より大きい場合、CDN エッジ サーバーは、2 MB のチャンク単位で配信元サーバーへのファイルの要求を開始します。 CDN エッジにチャンクが到着すると、そのチャンクはキャッシュされ、エンド ユーザーに即時に提供されますが、CDN はそれと並行して次のチャンクを "プリフェッチ" します。この "プリフェッチ" により、ユーザーの前にチャンクが 1 つ存在し、エンド ユーザーの待機時間が短縮されるため、コンテンツがより早く使用可能になります。 このプロセスは、ファイル全体がダウンロードされるまで (エンド ユーザーがファイル全体を要求した場合)、要求されたすべてのバイト範囲が使用可能になるまで (エンド ユーザーがバイト範囲を要求した場合)、またはクライアントが接続を終了するまで続きます。 

バイト範囲要求について詳しくは、[RFC 7233](https://tools.ietf.org/html/rfc7233) をご覧ください。

CDN は受け取ったチャンクをキャッシュし、ファイル全体を CDN キャッシュにキャッシュする必要はありません。 ファイルまたはバイト範囲に対する後続の要求は CDN キャッシュから提供され、すべてのチャンクが CDN にキャッシュされているのでない場合は、"プリフェッチ" を使って配信元にチャンクを要求します。 ご覧のように、この最適化はバイト範囲要求をサポートする配信元サーバーに依存します。 _配信元サーバーがバイト範囲要求をサポートしていない場合、この最適化の効果はありません。_ 

### <a name="caching"></a>Caching (キャッシュ)
大きなファイルは、配信レポートとは異なる既定のキャッシュ有効期限を使います。 HTTP 応答コードに基づいて、正のキャッシュと負のキャッシュを区別します。 配信元が応答の Cache-Control または Expires ヘッダーを介した有効期限を使って時間を指定する場合、CDN はその値を常に優先します。 配信元で指定されず、ファイルがこの最適化の種類のファイルの種類とファイル サイズの条件一覧と一致する場合、CDN は大きいファイルの最適化に既定値を使います。 それ以外の場合、CDN は一般的な Web 配信用の既定値を使います。

 
|    | 一般 Web | 大きなファイルの最適化 
--- | --- | --- 
キャッシュ - 正の値 <br> HTTP 200、203、300、 <br> 301、302、410 | 7 日 |1 日  
キャッシュ - 負の値 <br> HTTP 204、305、404、 <br> 405 | なし | 1 秒 

### <a name="dealing-with-origin-failure"></a>配信元のエラーの処理

大きなファイルの最適化の種類では、接続が永続的にタイムアウトにならないように、配信元の読み取りタイムアウトの長さは、大きなファイル サイズを考慮して一般的な Web 配信の 2 秒から 2 分に延長されます。

一般的な Web 配信と同様に、接続がタイムアウトになると、特定の回数再試行した後、クライアントに 504 ゲートウェイ タイムアウト エラーを送信します。 

### <a name="conditions-for-large-file-optimization"></a>大きなファイルの最適化の条件

次の表に、大きなファイルの最適化で満たす必要のある一連の条件を示します。

条件 | 値 
--- | --- 
サポートされるファイルの種類 | 3g2、3gp、asf、avi、bz2、dmg、exe、f4v、flv、 <br> gz、hdp、iso、jxr、m4v、mkv、mov、mp4、 <br> mpeg、mpg、mts、pkg、qt、rm、swf、tar、 <br> tgz、wdp、webm、webp、wma、wmv、zip  
ファイルの最小サイズ | 10 MB 
ファイルの最大サイズ | 150 GB 
配信元サーバーの特性 | バイト範囲要求をサポートする必要があります 

## <a name="optimizing-for-delivery-of-large-files-with-azure-cdn-from-verizon"></a>Azure CDN from Verizon を使った大きなファイルの配信の最適化

Azure CDN from Verizon は、ファイル サイズの上限なしに大きなファイルを配信でき、既定で有効になる大きなファイルの配信の高速化のさまざまな機能を備えています。

### <a name="complete-cache-fill"></a>Complete Cache Fill (完全キャッシュ入力)

Azure CDN from Verizon では、Complete Cache Fill (完全キャッシュ入力) という既定の機能があり、CDN は最初の要求が破棄されるか消失した場合にファイルをキャッシュにプルします。 

この機能は、ユーザーが最初から最後までダウンロードしないことが多い大きい資産 (プログレッシブ ダウンロード ビデオなど) の場合に役立ちます。 そのため、この機能は Azure CDN from Verizon では既定で有効になっています。 この既定の動作では、エッジ サーバーで配信元サーバーからの資産のバックグラウンド フェッチが開始されます。 その後、資産はエッジ サーバーのローカル キャッシュに入れられます。 完全なオブジェクトがキャッシュに入ると、エッジは CDN へのキャッシュ オブジェクトのバイト範囲要求を満たすことができます。

Verizon Premium レベルでは、ルール エンジンを通じて既定の Complete Cache Fill (完全キャッシュ入力) 動作を無効化できます。

### <a name="peer-cache-fill-hotfiling"></a>ピア キャッシュ入力のホットファイリング

これは Azure CDN from Verizon の既定の機能であり、独自の高度なアルゴリズムが帯域幅や要求の集計などのメトリックに基づいて追加のエッジ キャッシュ サーバーを活用し、人気の高い大きなオブジェクトに対するクライアント要求を処理できます。 これにより、多数の追加要求が顧客の配信元サーバーに送信される状況を防ぐことができます。 

### <a name="conditions-for-large-file-optimization"></a>大きなファイルの最適化の条件

Verizon の最適化機能は既定で有効になり、最大ファイル サイズに制限はありません。 

## <a name="additional-considerations"></a>追加の考慮事項

この最適化の種類を使っているときに考慮する必要があるその他いくつかの要素があります。
 
### <a name="azure-cdn-from-akamai"></a>Azure CDN from Akamai

- チャンク プロセスにより、配信元サーバーへの要求が追加で生成されますが、チャンクによって CDN でのキャッシュ特性が向上するため、配信元から配信される全体的なデータ量は大幅に小さくなります。
- ファイルのより小さい部分が配信されるため、配信元でのメモリと IO の負荷が軽減されるという追加のメリットもあります。 
- CDN でキャッシュされているチャンクの場合、コンテンツがキャッシュで期限切れになるか、その他の理由でキャッシュから削除されるまで、配信元に追加の要求は行われません。 
- ユーザーは CDN に対して範囲要求を行うことができ、それらは通常のファイルと同様に扱われます。 最適化は、ファイルの種類が有効で、バイト範囲が 10 MB から 150 GB の間にある場合にのみ適用されます。要求の平均ファイル サイズが 10 MB より小さい場合は、一般的な Web 配信を代わりに使用できます。

### <a name="azure-cdn-from-verizon"></a>Azure CDN from Verizon

一般的な Web 配信の最適化は大きなファイルの配信に対応できます。

