<properties
 pageTitle="デバイス管理ライブラリの概要 | Microsoft Azure"
 description="Azure IoT Hub デバイス管理 (DM) クライアント ライブラリ"
 services="iot-hub"
 documentationCenter=""
 authors="CarlosAlayo"
 manager="timlt"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="na"
 ms.date="04/29/2016"
 ms.author="carlosa"/>

# Azure IoT Hub デバイス管理 (DM) クライアント ライブラリの概要

## 概要

Azure IoT Hub DM クライアント ライブラリを使用すると、Azure IoT Hub で IoT デバイスを管理できます。"管理" には、再起動、出荷時の設定へのリセット、ファームウェアの更新などのアクションが含まれます。現在は、プラットフォームに依存しない C ライブラリを提供していますが、近日中に他の言語のサポートも追加する予定です。[Azure IoT Hub デバイス管理の概要][lnk-dm-overview]で説明したとおり、IoT Hub デバイス管理には次の 3 つの主要な概念があります。

- デバイス ツイン
- デバイス ジョブ
- デバイス クエリ

これらの概念に詳しくない場合は、先に進む前に、概要を確認することをお勧めします。すべてはクライアント ライブラリに密接に関連しています。

DM クライアント ライブラリは、デバイス管理において主な役割が 2 つあります。

- 物理デバイスのプロパティを、IoT Hub でそれに対応するデバイス ツインと同期する
- IoT Hub からデバイスに送信されるデバイス ジョブを構成する

物理デバイスのデバイス プロパティ (バッテリ レベルやシリアル番号など) は定期的にクラウド ベースのデバイス ツインと同期されるため、IoT Hub では、(デバイスが接続されている限り) 各物理デバイスの最新の状態が常に表示されます。

このサービスが物理デバイスと対話する主な方法では、デバイス ジョブとデバイス ツインを使用します。IoT Hub には、次に示すジョブの種類が用意されています。DM クライアント ライブラリは、デバイス ジョブのオーケストレーションのほとんどに対処しますが、それぞれのジョブの種類をサポートするために必要なコールバックをデバイスに実装するかどうかは開発者次第です。

1.	**ファームウェアの更新**: 物理デバイスのファームウェア (または OS イメージ) を更新する
2.	**再起動**: 物理デバイスを再起動する
3.	**出荷時の設定にリセット**: 物理デバイスのファームウェア (または OS イメージ) を、デバイスに格納されている出荷時のバックアップ イメージに戻す
4.	**構成の更新**: 物理デバイスで実行されている IoT Hub クライアント エージェントを構成する
5.	**デバイス プロパティの読み取り**: 物理デバイスのデバイス プロパティの最新の値を取得する
6.	**デバイス プロパティの書き込み**: 物理デバイスのデバイス プロパティを変更する

以降のセクションでは、クライアント ライブラリのアーキテクチャについて説明するほか、デバイスにさまざまなデバイス オブジェクトを実装する方法に関するガイドラインも提供します。

## DM クライアント ライブラリの設計原則と機能的概念
DM クライアント ライブラリは、移植性とクロスプラットフォームの統合を考慮して設計されました。これは、次の設計上の決定により実現しました。

1.	さまざまなデバイスの拡張性に対応するように、COAP 標準プロトコルを介した LWM2M に基づいて構築されました。
2.	各種プラットフォームへの移植性を容易にするために、ANSI C99 で記述されました。
3.	高度なセキュリティのシナリオで使用できるように TCP/TLS と Azure IoT Hub 認証 (SAS トークン) によってセキュリティで保護されました。
4.	既存のものを利用したり、コミュニティに貢献したりするために、[Eclipse Wakaama][lnk-Wakaama] OSS プロジェクトに基づいています。

### 関連する LWM2M の概念
Microsoft では、さまざまなデバイスの拡張性に対応するために LWM2M 標準を選択しました。開発の操作性を簡略化するために、プロトコルの大部分を抽象化しています。ただし、重要なのは、ライブラリの基本的な原則である、主にそのデータ モデルとデータの伝達方法を理解することです。

#### オブジェクトとリソース: LWM2M のデータ モデル
LWM2M データ モデルには、オブジェクトとリソースの概念が導入されています。

- **オブジェクト**は、デバイスやファームウェアの更新など、システムで一貫性のある一連の機能エンティティを記述します。
- **リソース**は、バッテリ レベル情報や再起動アクションなど、それらのオブジェクトに含まれる属性またはアクションを記述します。

このモデルには "1 対多" のリレーションシップが 2 つあることに注目してください。

- **デバイスとオブジェクト**: 各デバイスは、複数のオブジェクトを持つことができます。たとえば、Contoso デバイスには "デバイス オブジェクト" と "サーバー オブジェクト" が必要です (オブジェクトについては、次のセクションで詳しく説明します)。
- **オブジェクトとリソース**: 各オブジェクトは、複数のリソースを持つことができます。たとえば、オブジェクトには、新しいイメージが格納されるパッケージ URI など、Contoso デバイスのファームウェア更新リソースを含めることができます。

#### 監視/通知パターン: LWM2M でデータが伝達されるしくみ
上記の概念に加え、デバイスからサービスへデータがどのように流れるかを理解することが重要です。そのためには、LWM2M では "監視/通知" パターンを定義します。物理デバイスは、サービスに接続すると、選択したデバイス プロパティの "監視" を開始します。その後、物理デバイスはデバイス プロパティの変更をサービスに "通知" します。

クライアント ライブラリでは、デバイス管理データをデバイスから IoT Hub に送信する手段として監視/通知パターンを実装しました。このパターンは、2 つのパラメーターによって制御されます。

- **最短期間**: デバイスが監視対象のプロパティの更新の送信を遅延させる期間。これは 5 分に設定されています。したがって、値がさらに短い間隔で変更される場合でも、デバイスが監視対象のプロパティの更新を送信するのは、せいぜい 5 分おきです。つまり、プロパティが刻一刻と変更される場合、サービスで表示されるのは、5 分間のうち最後の変更のみです。

- **最大期間**: 監視対象のプロパティが変更されるかどうかに関係なく、デバイスがそのプロパティの値の更新を送信する期間。これは 6 時間に設定されています。したがって、値が変更されていない場合でも、デバイスは、少なくとも 6 時間おきに、監視対象のプロパティの値の更新を送信します。

> [AZURE.NOTE]  これらのパラメーターの唯一の例外として、ファームウェアの更新ジョブに使用されるプロパティでは、最短期間が 30 秒に設定されています。これは、これらのプロパティがジョブの実行中に非常に頻繁に変更されるため、更新処理を迅速化するために最短期間を縮小したことが原因です。

## クライアント ライブラリの機能とアーキテクチャ
概要で説明したように、クライアント ライブラリで対処する主な目的は 2 つあります。

- 物理デバイスを、IoT Hub でそれに対応するデバイス ツインと同期する。
- IoT Hub からデバイスに送信されるデバイス ジョブを構成する。

このセクションでは、それぞれの目的について詳しく説明します。

### 物理デバイスをそのデバイス ツインと同期する
クライアント ライブラリは、監視/通知パターンを使用して、デバイス ツインを常に更新された状態にしておきます。デバイス ツインがサーバー側から物理デバイスを表現したものであることに注意してください。この同期を実行するために、次の処理が行われます。

1. 通常は初期化中に、デバイスがサービスに登録されます。例: "自分はデバイスで、アクセス トークン Y を持つデバイス ID Contoso を持っています"。
2. サービスはオブジェクト上のリソースを監視します。例: "Contoso デバイスのバッテリ レベルについて常に最新情報をデバイスに通知します"。
3. デバイスは、リソースの値をサービスに通知します。通知の頻度は、最短期間と最大期間に基づいています。例: "午後 5 時にバッテリ レベル 99%、午後 5 時 5 分にバッテリ レベル 90%"。

### デバイス ジョブを構成する: デバイス ツインとデバイス ジョブの連携
物理デバイスに作用するために、サービスは、関連付けられているデバイス ツインを見つける必要があります。これは、プロパティを照会するか、特定の ID を検索することで見つけることができます。ツイン ID (つまり、物理デバイスとの一致) がわかると、サービスは、物理デバイスでデバイス ジョブを開始できるようになります。

デバイス ジョブは、一連の各種コマンドを表します。この一連のコマンドは、実行する特定の処理 (たとえば、ファームウェアの更新手順) を表します。デバイス ジョブは、複数の手順で構成できます。

1.	デバイス ツインには、デバイス ジョブの状態を表すプロパティがあります。
2.	デバイス ジョブ内の個々の処理の間を進むには、デバイス ツインのプロパティに特定の値を指定する必要があります。したがって、物理デバイスは適切なプロパティを設定し、デバイス ツインと同期され、ジョブが進むことができるようにする必要があります。

このシーケンスは、処理が複数の手順で構成されている場合に繰り返されます (たとえば、ファームウェアの更新中、デバイス ツインは、ジョブが完了したと見なされるまで、さまざまな手順を介して何度もそのプロパティを変更します)。

## クライアントにデバイス管理を実装するためのガイドライン
ここまでのセクションでは、デバイス管理クライアント ライブラリの目的、その設計原則、LWM2M との関係について説明してきました。ここでは、要素がランタイムでどのように統合されるかを説明することに重点的に取り組みます。

基本的に、クライアント ライブラリはデバイスとサービス間の通信を処理するため、残っているものはすべて、デバイス固有のロジックの実装です。これを構成する要素として、次の 2 つがあります。

1.	**デバイス固有の詳細を実装する**: これには、適切なコールバックでサービスによって要求されたアクション (ファームウェア パッケージのダウンロードなど) を実行するためのデバイス固有のロジックの作成が含まれます。ファームウェアの更新パッケージに対するこのコールバックの例を次に示します。コールバックは、[こちら][lnk-github1]にあるフォルダーの .c ファイルで見つかります。

            object_firmwareupdate *obj = get_firmwareupdate_object(0);
            obj->firmwareupdate_packageuri_write_callback =     start_firmware_download;
            // platform specific code
            obj->firmwareupdate_update_execute_callback = start_firmware_update;
            //platform specific code


2.	**プロパティが変更されたときにクライアント ライブラリに通知する**: これを行うには、[こちら][lnk-github2]にあるフォルダーの .h ファイルで対応する設定関数を呼び出します。

        IOTHUB_CLIENT_RESULT set_firmwareupdate_state(uint16_t instanceId, int value);

### DM クライアント ライブラリで実装する必要のあるオブジェクト

先ほどは、デバイス ジョブを実行するためのデバイス固有のロジックを実装する方法について説明しました。ここでは、使用できるオブジェクトについて説明します。

これらのオブジェクトの一部は必須です。つまり、IoT Hub デバイス管理に含まれるようにデバイス固有のロジックを実装する必要があります。他のオブジェクトは省略可能なため、サービスのニーズに応じて選択できます (たとえば、IoT Hub を使用してファームウェア更新を実行しないことも選択できます)。各オブジェクトの説明は次のとおりです。

- **デバイス オブジェクト (必須)**: 製造元情報、モデル番号、シリアル番号、デバイスの時刻など、デバイス固有の情報を提供します。サービスは、この情報を読み取ることができ、場合によってはそれを更新できます。また、サービスがデバイスに対して実行可能な 2 つのアクションとして、再起動と出荷時の設定にリセットも定義します。
- **サーバー オブジェクト (必須)**: 登録の有効期間やトランスポート バインドなど、IoT Hub への接続に使用される接続パラメーターと設定が格納されます。サービスはこの情報を読み取ることのみ可能です。
- **構成オブジェクト (省略可能)**: ユーザー定義の構成情報が格納されます。この情報は、デバイス構成を簡略化するために、デバイスから照会したり、サーバーからデバイスにプッシュしたりできます。サービスは、この情報を読み取って更新できます。
- **ファームウェアの更新オブジェクト (省略可能)**: サービスが呼び出すことのできる、ファームウェアの更新アクションを提供します。また、ファームウェア パッケージの場所や実行中のファームウェア更新操作の状態などの情報も提供します。

これらのオブジェクトそれぞれには、関連付けられている一連のリソースがあります (1 対多の関連付けを思い出してください)。LWM2M オブジェクトと、それに関連付けられた、Azure IoT Hub デバイス管理でサポートされているリソースの一覧は、この記事の最後にあります。

> [AZURE.NOTE] カスタム デバイス プロパティ、複数のリソース インスタンス、および複数のオブジェクト インスタンスは、現在リリースされているシステムではサポートされていません。

### まとめ

以下に、さまざまな要素すべてをまとめた図を示します。右側には、デバイス管理クライアント ライブラリの各種コンポーネント (オブジェクト、ハンドラー、通知方法) を青で示しています。左側には、デバイス アプリケーション レベルで作成する必要があるロジックを緑で示しています。クライアント ライブラリは、アプリケーション ロジックを IoT Hub と結び付けることで、通信と構成が適切に処理されるようにします。

次の図では、DM クライアント ライブラリのコンポーネントを示しています。

![][img-library-overview]

## 次のステップ: 実際に体験してみる
この記事では、C の IoT Hub デバイス管理クライアント ライブラリの使用方法の基本について説明しました。

実際に体験してみるには、次のリソースにアクセスしてください。

- Intel Edison ファームウェアの更新サンプル: Intel Edison デバイスを使用してデバイス管理機能が有効になっているサンプルです。[iotdm\_edison\_sample][lnk-edison-sample] を参照してください。
- シミュレートされたデバイスのサンプル: Linux デバイスと Windows デバイスで動作する、プラットフォームに依存しないデバイス サンプルです。[iotdm\_simple\_sample][lnk-simple-sample] を参照してください。
- LWM2M オブジェクトの詳細については、[OMA LWM2M オブジェクトとリソースの登録][lnk-oma]に関するページを参照してください。

## 付録: 現在サポートされている LWM2M オブジェクトとリソース

### デバイス オブジェクト

| リソース名 | リソースに対して許可されているリモート操作 | 型 | 範囲と単位 | 説明 |
|-----------------|--------------------------------------|---------|-----------------|-------------|
| Manufacturer | 読み取り | String | | 製造元の名前。 |
| ModelNumber | 読み取り | String | | モデル識別子 (製造元が指定した文字列)。 |
| DeviceType | 読み取り | String | | デバイスの種類 (製造元が指定した文字列)。<br/>注: これは、サーバー側の API **SystemPropertyNames.DeviceDescription** にマップされます。 |
| SerialNumber | 読み取り | String | | デバイスのシリアル番号。 |
| FirmwareVersion | 読み取り | String | | デバイスの現在のファームウェア バージョン。 |
| HardwareVersion | 読み取り | String | | デバイスの現在のハードウェア バージョン。 |
| Reboot | Execute | | | デバイスを再起動します。 |
| FactoryReset | Execute | | | デバイスの出荷時の設定へのリセットを実行し、デバイスの構成を初めてデプロイしたときと同じにします。 |
| CurrentTime | 読み取り<br/>書き込み | Time | | デバイスの現在の UNIX 時間。クライアントは、1 秒経過するたびにこの時刻値を大きくする必要があります。<br/>DM サーバーは、クライアントがサーバーの時刻と同期されるように、このリソースに書き込むことができます。 |
| UTCOffset | 読み取り<br/>書き込み | String | | 有効な UTC オフセット。 |
| タイム ゾーン | 読み取り<br/>書き込み | String | | デバイスが位置するタイム ゾーンを示します。 |
| MemoryFree | 読み取り | Integer | KB | デバイスでデータやソフトウェアを格納できる記憶域スペースの推定される現在使用可能なメモリ。 |
| MemoryTotal | 読み取り | Integer | KB | デバイスでデータやソフトウェアを格納できる記憶域スペースの総量。 |
| BatteryLevel | 読み取り | Integer | 0 ～ 100% | 現在のバッテリ レベルの割合 (0 ～ 100) |
| BatteryStatus | 読み取り | Integer | 0 ～ 6 | **0**: バッテリは正常に動作していますが、電源は入っていません。<br/>**1**: バッテリは充電中です。<br/>**2**: バッテリは充電が完了し、送電網を通じて電源が供給されています。<br/>**3**: バッテリは破損しています。<br/>**4**: バッテリの充電が残りわずかです。<br/>**5**: バッテリはありません。<br/> **6**: バッテリ情報を入手できません。 |

### ファームウェアの更新オブジェクト

| リソース名 | 操作 | 型 | 範囲と単位 | 説明 |
|----------------|-----------|---------|-----------------|-------------|
| パッケージ | 書き込み | 非透過的 | | バイナリ形式のファームウェア パッケージ。<br/>マップ先のサービス API:<br/>**SystemPropertyNames.FirmwarePackage** |
| PackageURI | 書き込み | String | 0 ～ 255 バイト | デバイスがファームウェア パッケージをダウンロードできる URI。<br/>マップ先のサービス API: **SystemPropertyNames.FirmwarePackageUri** |
| 更新 | Execute | | | パッケージに格納されているファームウェア パッケージを使用するか、パッケージ URI からダウンロードされたファームウェアを使用して、ファームウェアを更新します。<br/>マップ先のサービス API:<br/>**ScheduleFirmwareUpdateAsync** |
| 状態 | 読み取り | Integer | 1 ～ 3 | ファームウェア更新処理の状態:<br/>**1**: アイドル状態。ファームウェア パッケージをダウンロードする前か、ファームウェア パッケージを適用した後にこの状態である場合があります。<br/>**2**: ファームウェア パッケージのダウンロード中。<br/>**3**: ファームウェア パッケージがダウンロードされました。<br/> マップ先のサービス API: **SystemPropertyNames.FirmwareUpdateState** |
| UpdateResult | 読み取り | Integer | 0 ～ 6 | ファームウェアのダウンロードまたは更新の結果<br/>**0**: 既定値。<br/>**1**: ファームウェアの更新に成功しました。<br/>**2**: 新しいファームウェア パッケージ用に十分な記憶域がありません。<br/>**3**: ファームウェア パッケージのダウンロード中にメモリ不足が発生しました。<br/>**4**: ファームウェア パッケージのダウンロード中に接続が切断されました。<br/>**5**: 新しくダウンロードされたパッケージの CRC チェックが失敗しました。<br/>**6**: ファームウェア パッケージの種類がサポートされていません。<br/>**7**: URI が無効です。マップ先のサービス API: **SystemPropertyNames.FirmwareUpdateResult** |
| PkgName | 読み取り | String | 0 ～ 255 バイト | **Package** リソースによって参照されるファームウェア パッケージのわかりやすい名前。<br/>マップ先のサービス API:<br/>**SystemPropertyNames.FirmwarePackageName** |
| PackageVersion | 読み取り | String | 0 ～ 255 バイト | **Package** リソースによって参照されるファームウェア パッケージのバージョン。<br/>マップ先のサービス API:<br/>**SystemPropertyNames.FirmwarePackageVersion** |

### LWM2M サーバー オブジェクト

| リソース名 | 操作 | 型 | 範囲と単位 | 説明 |
|------------------------|------------|---------|-----------------|---------------|
| 既定の最短期間 | 読み取り/書き込み | Integer | 秒 | デバイスが監視対象のプロパティの更新の送信を遅延させる期間。たとえば、**DefaultMinPeriod** が 5 分であるとした場合、値がさらに短い間隔で変更されても、デバイスが監視対象のプロパティの更新を送信するのは、せいぜい 5 分おきです。マップ先のサービス API: **SystemPropertyNames.DefaultMinPeriod** |
| 既定の最大期間 | 読み取り/書き込み | Integer | 秒 | 監視対象のプロパティが変更されるかどうかに関係なく、デバイスがそのプロパティの値の更新を送信する期間 (秒)。たとえば、**DefaultMaxPeriod** が 6 時間であるとした場合、リソースの変更に関係なく、少なくとも 6 時間おきに、監視対象のプロパティの値の更新が送信されます。<br/>マップ先のサービス API:<br/>**SystemPropertyNames.DefaultMaxPeriod** |
| 有効期間 | 読み取り/書き込み | Integer | 秒 | デバイスの登録の有効期間。新しい登録または更新の要求は、この有効期間内にデバイスから受け取る必要があります。そうしないと、デバイスは、サービスから登録解除されます。<br/>マップ先のサービス API:<br/>**SystemPropertyNames.RegistrationLifetime** |

### 構成オブジェクト

| リソース名 | 操作 | 型 | 範囲と単位 | 説明 |
|---------------|------------|--------|-----------------|-------------|
| 名前 | 読み取り/書き込み | String | | 読み取りまたは更新を行うデバイス構成の名前を一意に識別します。 |
| 値 | 読み取り/書き込み | String | | 読み取りまたは更新を行う構成値を一意に識別します。 |
| 適用 | Execute | | | デバイスに構成の変更を適用します。 |

[img-library-overview]: media/iot-hub-device-management-library/library.png
[lnk-dm-overview]: iot-hub-device-management-overview.md
[lnk-get-started]: iot-hub-device-management-get-started.md
[lnk-simple-sample]: https://github.com/Azure/azure-iot-sdks/tree/dmpreview/c/iotdm_client/samples/iotdm_simple_sample
[lnk-edison-sample]: https://github.com/Azure/azure-iot-sdks/tree/dmpreview/c/iotdm_client/samples/iotdm_edison_sample
[Azure IoT Hub device SDK]: https://github.com/Azure/azure-iot-sdks/tree/dmpreview/c
[Azure IoT Hub]: Link%20to%20DM%20Overview
[Lightweight M2M]: http://openmobilealliance.org/about-oma/work-program/m2m-enablers/
[CoAP]: https://tools.ietf.org/html/rfc7252
[Wakaama]: https://github.com/eclipse/wakaama
[OMA LWM2M Object and resource registry]: http://technical.openmobilealliance.org/Technical/technical-information/omna/lightweight-m2m-lwm2m-object-registry

[lnk-run-linux]: http://TODO
[lnk-Wakaama]: https://github.com/eclipse/wakaama
[lnk-github1]: https://github.com/Azure/azure-iot-sdks/tree/dmpreview/c/iotdm_client/lwm2m_objects
[lnk-github2]: https://github.com/Azure/azure-iot-sdks/tree/dmpreview/c/iotdm_client/lwm2m_objects
[lnk-oma]: http://technical.openmobilealliance.org/Technical/technical-information/omna/lightweight-m2m-lwm2m-object-registry

<!---HONumber=AcomDC_0504_2016-->