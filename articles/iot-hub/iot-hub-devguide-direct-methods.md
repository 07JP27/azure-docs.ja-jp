---
title: 開発者ガイド - ダイレクト メソッド | Microsoft Docs
description: Azure の IoT Hub 開発者ガイド - ダイレクト メソッドを使用して、デバイスでコードを呼び出す
services: iot-hub
documentationcenter: .net
author: nberdy
manager: timlt
editor: ''

ms.service: iot-hub
ms.devlang: multiple
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 09/30/2016
ms.author: nberdy

---
# <a name="invoke-a-direct-method-on-a-device-preview"></a>デバイスでダイレクト メソッドを呼び出す (プレビュー)
## <a name="overview"></a>Overview
IoT Hub には、クラウドからデバイスにメソッドを呼び出す機能が備わっています。 メソッドは、デバイスとの要求/応答を表しています。これは、成功または失敗の直後 (ユーザーが指定したタイムアウト後) に、呼び出しのステータスをユーザーに伝える HTTP 呼び出しと同様のものです。 これは、デバイスがオフラインの場合に SMS ウェイクアップを送信するような、デバイスが応答できるかによって、一連の即時のアクションが異なってくるシナリオで便利です (SMS はメソッドの呼び出しよりもコストがかかります)。

メソッドは、デバイスに直接呼び出すリモート プロシージャ コールと考えることができます。 クラウドから呼び出すことができるメソッドは、デバイスに実装されているメソッドのみです。 メソッドが定義されていないデバイスにクラウドがメソッドを呼び出そうとすると、メソッドの呼び出しが失敗します。

各デバイス メソッドは、1 つのデバイスをターゲットとします。 [ジョブ][lnk-devguide-jobs]を使用すると、複数のデバイスでメソッドを呼び出すことができ、デバイスが接続されていない場合にはメソッドの呼び出しをキューに保存しておくことができます。

IoT Hub で**サービス接続**のアクセス許可を持っていれば、誰でもデバイスでメソッドを呼び出すことができます。

### <a name="when-to-use"></a>使用時の注意
デバイス メソッドは、クラウド バックエンドからデバイスに情報を渡すことができる点で[クラウドからデバイスへのメッセージ][lnk-devguide-messages]と似ていますが、両者の基本となる方法は異なります。 概念的には、メソッドは同期されますが持続性がなく、クラウドからデバイスへのメッセージは非同期で最大 48 時間持続します。

メソッドは、要求応答パターンに従い、持続性を持ちません。 持続性がないため、デバイスでコマンドを実行する際には、次の 2 つのメリットを即座に得ることができます。

* **メソッドの実行時に直ちにフィードバックを得られる**。要求と応答の相関関係を管理する必要がありません。
* **スループットが高くなる**。IoT Hub が持続性を提供しなくてもよいため、操作をより高速に実行できます。 IoT Hub は、クラウドからデバイスへのメッセージよりもユニットあたりにより多くのメソッドを呼び出すことができます。

クラウドからデバイスへのメッセージはデバイスへのコマンドというよりも、一部の情報をデバイスに渡すクラウド サービスです。そのため、デバイスは、都合に合わせてその情報を受信し、応答するかしないかを判断できます。 クラウドからデバイスへのメッセージはタイムアウトまでの時間が長く (最大 48 時間)、メソッドはより短期間に有効期限が切れます。

デバイス メソッドはデバイスで直ちにコマンドを呼び出す場合に使用し、ジョブはスケジュールを設定してデバイスでコマンドを呼び出す場合に使用します。

## <a name="method-lifecycle"></a>メソッドのライフサイクル
メソッドはデバイスに実装され、正しくインスタンス化するには、メソッドのペイロードに 0 個以上の入力が必要になります。 ダイレクト メソッドは、サービス向け URI (`{iot hub}/twins/{device id}/methods/`) を通じて呼び出します。 デバイスは、デバイス固有の MQTT トピック (`$iothub/methods/POST/{method name}/`) からダイレクト メソッドを受け取ります。 将来的には、メソッドに対応するデバイス側のネットワーキング プロトコルが追加される予定です。

> [!NOTE]
> デバイスでダイレクト メソッドを呼び出す場合、プロパティ名と値には ``{'$', '(', ')', '<', '>', '@', ',', ';', ':', '\', '"', '/', '[', ']', '?', '=', '{', '}', SP, HT}`` を除く US-ASCII 印刷可能英数字のみを使用できます。
> 
> 

メソッドは同期され、タイムアウト期間 (既定では 30 秒、最長 3600 秒に設定可能) 後に成功または失敗します。 メソッドは、オンラインの場合にのみデバイスが機能し、コマンドを受け取る対話型のシナリオ (携帯電話から照明を付けるなどの操作) で便利です。 このようなシナリオでは、成功か失敗かを即座に確認し、クラウド サービスがその結果に対してできるだけ早く対応することが必要になります。 デバイスはメッセージの結果として何らかのメッセージ本文を返すことがありますが、メソッドにはその機能は必要ありません。 順番の保証や、メソッドの呼び出しの同時実行セマンティクスはありません。

デバイス メソッド呼び出しは、クラウド側からは HTTP のみに、デバイス側からは MQTT のみになります。

## <a name="reference"></a>リファレンス
### <a name="servicefacing"></a>サービス向け
#### <a name="method-invocation"></a>メソッドの呼び出し
デバイスでのダイレクト メソッドの呼び出しは HTTP 呼び出しであり、次の項目で構成されます。

* デバイスに固有の *URI* (`{iot hub}/twins/{device id}/methods/`)
* POST *メソッド*
* *ヘッダー*。認証、要求 ID、コンテンツの種類、コンテンツのエンコーディングを含む
* 透過的な JSON *本文*。次の形式になります。

```
{
    "methodName": "reboot",
    "timeoutInSeconds": 200,
    "payload": {
        "input1": "someInput",
        "input2": "anotherInput"
    }
}
```

  タイムアウトは秒単位です。 タイムアウトが設定されていない場合の既定値は 30 秒です。

#### <a name="response"></a>Response
バックエンドは次の項目で構成される応答を受け取ります。

* *HTTP 状態コード*。接続されていないデバイスの 404 エラーを含む、IoT Hub からのエラーに使用される
* *ヘッダー*。etag、要求 ID、コンテンツの種類、コンテンツのエンコーディングを含む
* JSON *本文*。次の形式になります。

```
{
    "status" : "OK",
    "payload" : {...}
}
```

   `status` と `body` の両方ともデバイスによって提供され、デバイス自身の状態コードまたは説明とともに応答する場合に使用されます。

### <a name="devicefacing"></a>デバイス向け
#### <a name="method-invocation"></a>メソッドの呼び出し
デバイスは MQTT トピックに関するダイレクト メソッド要求を受け取ります。`$iothub/methods/POST/{method name}/?$rid={request id}`

デバイスが受け取る本文は次の形式になります。

```
{
    "input1": "someInput",
    "input2": "anotherInput"
}
```

メソッドの要求は QoS 0 です。

#### <a name="response"></a>Response
デバイスは応答を `$iothub/methods/res/{status}/?$rid={request id}` に送信します。この場合、

* `status` プロパティは、デバイスから提供される、メソッド実行の状態です。
* `$rid` プロパティは、IoT Hub から受け取るメソッド呼び出しの要求 ID です。

本文はデバイスごとに設定され、任意の状態を設定できます。

### <a name="additional-reference-material"></a>参考資料
開発者ガイド内の他の参照トピックは次のとおりです。

* 「[IoT Hub エンドポイント][lnk-endpoints]」では、各 IoT Hub がランタイムと管理の操作のために公開する、さまざまなエンドポイントについて説明します。
* 「[クォータと調整][lnk-quotas]」では、IoT Hub サービスに適用されるクォータと、サービスを使用するときに想定される調整の動作について説明します。
* 「[IoT Hub のデバイス SDK とサービス SDK][lnk-sdks]」では、IoT Hub とやりとりするデバイスとサービス アプリケーションの両方を開発する際に使用できるさまざまな言語の SDK を紹介します。
* 「[Query language for twins, methods, and jobs (ツイン、メソッド、ジョブのクエリ言語)][lnk-query]」では、IoT Hub からデバイス ツイン、メソッド、ジョブに関する情報を取得する際に使用できるクエリ言語について説明します。
* 「[IoT Hub MQTT サポート][lnk-devguide-mqtt]」では、MQTT プロトコルの IoT Hub サポートについて詳しく説明します。

## <a name="next-steps"></a>次のステップ
ダイレクト メソッドの使用方法を理解できたら、次の開発者ガイドトピックも参考にしてください。

* [複数デバイスでのジョブのスケジュール][lnk-devguide-jobs]

この記事で説明した概念を試す場合は、次の IoT Hub のチュートリアルをご利用ください。

* [クラウドからデバイスへのメソッドの使用][lnk-methods-tutorial]

<!-- links and images -->

[lnk-endpoints]: iot-hub-devguide-endpoints.md
[lnk-quotas]: iot-hub-devguide-quotas-throttling.md
[lnk-sdks]: iot-hub-devguide-sdks.md
[lnk-query]: iot-hub-devguide-query-language.md
[lnk-devguide-mqtt]: iot-hub-mqtt-support.md

[lnk-devguide-jobs]: iot-hub-devguide-jobs.md
[lnk-methods-tutorial]: iot-hub-c2d-methods.md
[lnk-devguide-messages]: iot-hub-devguide-messaging.md



<!---HONumber=Oct16_HO2-->


