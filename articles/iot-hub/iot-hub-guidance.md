<properties
 pageTitle="Azure IoT Hub に関するガイダンス | Microsoft Azure"
 description="Azure IoT Hub を使用したソリューションに関するガイダンスのトピックのコレクション。"
 services="iot-hub"
 documentationCenter=".net"
 authors="fsautomata"
 manager="kevinmil"
 editor=""/>

<tags
 ms.service="iot-hub"
 ms.devlang="na"
 ms.topic="article"
 ms.tgt_pltfrm="na"
 ms.workload="tbd"
 ms.date="09/29/2015"
 ms.author="elioda"/>

# Azure IoT Hub: ガイダンス

## 比較: IoT Hub と Event Hubs
デバイスからのテレメトリ データの収集は、Azure IoT Hub の主なユース ケースの 1 つです。このため、IoT Hub は、低遅延の動作と高い信頼性を確保しながら、クラウドに対する膨大なイベントとテレメトリ データの入り口として利用できるイベント取り込みサービスである [Event Hubs] とよく比較されます。

ただし、サービスには異なる点も多数あります。次のセクションでは、この違いについて詳しく説明します。

| 領域 | IoT Hub | Event Hubs |
| ---- | ------- | ---------- |
| 通信パターン | D2C イベント イングレスと C2D メッセージング。 | イベント イングレスのみ (通常、D2C シナリオのみ)。 |
| セキュリティ | デバイスごとの ID と取り消し可能なアクセス制御。[IoT Hub 開発者ガイド: セキュリティ]に関するページを参照してください。 | Event Hub 全体の[共有アクセス ポリシー][Event Hub - security]。[発行元のポリシー][Event Hub publisher policies]を使用した取り消しが限定的にサポートされています。IoT ソリューションでは、デバイスごとの資格情報となりすまし対策をサポートするために、カスタム ソリューションの実装が求められることがよくあります。 |
| スケール | IoT Hub は、同時接続された数百万のデバイスをサポートするように最適化されています。 | Event Hubs では、同時接続数をさらに制限でき、[Service Bus のクォータ]に基づいて最大 5.000 の AMQP 接続がサポートされます。一方、Event Hubs を使用すると、ユーザーが、送信される各メッセージのパーティションを指定できます。 |
| デバイスの SDK | IoT Hub には、さまざまなプラットフォームと言語を対象とした[デバイス SDK][Azure IoT Hub SDKs] が用意されています。 | Event Hubs は .NET、C でサポートされ、AMQP と HTTP の送信インターフェイスを提供します。 |

まとめると、唯一のユース ケースが D2C テレメトリ イングレスである場合でも、IoT Hub によって IoT デバイス接続用に設計されたサービスを提供し、IoT 固有の機能を使ったシナリオの価値提案を展開し続けることができます。Event Hubs は、大規模なイベント イングレス向けに設計されており、データ センター間およびデータ センター内の両方のシナリオに対応できます。IoT Hub と Event Hubs を組み合わせて使用し、IoT Hub が D2C 通信を処理してから、Event Hubs が後でリアルタイム処理エンジンへのイベント イングレスを処理できるようにすることはよくあります。

## デバイス プロビジョニング <a id="provisioning"></a>
IoT ソリューションでは、さまざまなシステムおよびストアにデバイス情報が保持され、[IoT Hub の ID レジストリ][IoT Hub Developer Guide - identity registry]はそのストアの 1 つです。その他に、アプリケーション固有のデバイス情報が保持されるストアもあります。*プロビジョニング*とは、こうしたシステムすべてに必要なデバイス情報を作成するプロセスです。

デバイス プロビジョニングの要件と戦略は多数あります (詳細については、[IoT Hub デバイス管理のガイダンス]を参照してください)。[IoT Hub ID レジストリ][IoT Hub Developer Guide - identity registry]には、プロビジョニング プロセスで IoT Hub を統合するときに必要な API が用意されています。

## フィールド ゲートウェイ<a id="fieldgateways"></a>
フィールド ゲートウェイは、特別なデバイス アプライアンスまたは汎用的なソフトウェアで、通信イネーブラーとして、また、場合によってはローカルのデバイス管理システムおよびデバイスのデータ処理ハブとして動作します。フィールド ゲートウェイは、デバイスに対するローカル処理および制御機能を実行しながら、デバイスのテレメトリをフィルター処理または集計し、バックエンドに送信されるデータ量を減らすことができます。

フィールド ゲートウェイのスコープには、フィールド ゲートウェイ自体と自身に接続されているすべてのデバイスが含まれます。フィールド ゲートウェイは、その名前が示すように専用データ処理施設外で動作し、通常は、場所がバインドされています。また、アクセスと情報フローを管理するうえで大きな役割を担っているという点で、単なるトラフィック ルーターとは異なります。つまり、これはアプリケーション対応のエンティティで、ネットワーク接続またはセッション ターミナルです (たとえば、この場合、ゲートウェイはデバイス プロビジョニング、データ変換、プロトコル変換、およびイベント ルールの処理に役立ちます)。これに対し、NAT デバイスまたはファイアウォールはフィールド ゲートウェイとは見なされません。これは明示的な接続またはセッション ターミナルではなく、これらを介して行われるルート (または拒否) 接続またはセッションであるためです。

### 透過的なフィールド ゲートウェイと非透過的なフィールド ゲートウェイ
デバイス ID に関しては、フィールド ゲートウェイのスコープ内にある他のデバイスの ID が IoT Hub の ID レジストリに含まれる場合、そのフィールド ゲートウェイは*透過的*です。IoT Hub の ID レジストリに含まれるのが、フィールド ゲートウェイの ID のみである場合、そのフィールド ゲートウェイは*非透過的*です。

重要なのは、*非透過的*なゲートウェイでは、IoT Hub が[デバイス ID なりすまし対策][IoT Hub Developer Guide - Anti-spoofing]を提供できない点です。また、フィールド ゲートウェイのスコープ内にあるすべてのデバイスが IoT Hub では 1 つのデバイスとして示されるため、1 つのデバイスとしてスロットルおよびクォータが適用されます。

### その他の考慮事項

フィールド ゲートウェイは、Azure IoT デバイス SDK を使って実装できます。一部の SDK には、IoT Hub への 1 つの接続で複数のデバイス通信を多重化する機能など、フィールド ゲートウェイ固有の機能が用意されています。[IoT Hub 開発者ガイド: 通信プロトコルの選択]に関するページで説明されているように、フィールド ゲートウェイに対してはトランスポート プロトコルとして HTTP/1 を使用しないでください。

## カスタム デバイスの認証のスキームとサービスの使用<a id="customauth"></a>
Azure IoT Hub では、[デバイス ID レジストリ][IoT Hub Developer Guide - identity registry]を使って、デバイスごとのセキュリティ資格情報とアクセス制御を構成できます。既にカスタム デバイス ID レジストリや認証スキームにかなり投資している IoT ソリューションで、IoT Hub の機能を引き続き利用するには、IoT Hub の*トークン サービス*を作成します。

トークン サービスは、自己デプロイされたクラウド サービスです。このサービスは、**DeviceConnect** アクセス許可が指定された IoT Hub 共有アクセス ポリシーを使用して、*デバイスを対象とする*トークンを作成します。

  ![][img-tokenservice]

トークン サービス パターンの主な手順を次に示します。

1. [IoT Hub 共有アクセス ポリシー][IoT Hub Developer Guide - Security]を作成し、IoT Hub に対する **DeviceConnect** アクセス許可を指定します。トークン サービスは、このポリシーを使用してトークンに署名します。
2. IoT Hub にアクセスする必要があるデバイスは、トークン サービスに署名付きトークンを要求します。デバイスは、カスタム デバイスの ID レジストリと認証スキームを使用できます。
3. トークン サービスは、[IoT Hub 開発者ガイド: セキュリティ]に関するページに従って作成されたトークンを、`/devices/{deviceId}` を `resourceURI` として使用して返します。`deviceId` は、認証されたデバイスです。
4. デバイスは、IoT Hub で直接トークンを使用します。

トークン サービスは、必要に応じて、トークンの有効期限を設定できます。期限が切れた時点で、IoT Hub は接続を提供するため、デバイスは、新しいトークンをトークン サービスに要求する必要があります。有効期限までの期間を短くすると、デバイスとトークン サービスの両方に対する負荷が増加するのは明らかです。

デバイスが接続できるように、IoT Hub でデバイス ID を 引き続き作成するように指定してもよいでしょう。それにより、デバイスでトークンを使った認証を行う場合でも、[IoT Hub 開発者ガイド: ID レジストリ]に関するページの手順に従ってデバイス ID を無効にすることで、デバイスごとのアクセス制御も引き続き有効になります。これにより、長期間有効なトークンが少なくなります。

### カスタム ゲートウェイとの比較
IoT Hub でカスタム ID レジストリ/認証スキームを実装する場合は、トークン サービス パターンをお勧めします。これにより、IoT Hub がほとんどのソリューション トラフィックを処理できるためです。ただし、カスタム認証スキームとプロトコルとの関係が複雑すぎるため ([TLS PSK] など)、すべてのトラフィックを処理するサービス (*カスタム ゲートウェイ*) が必要になる場合があります。詳細については、[プロトコル ゲートウェイ]に関する記事を参照してください。

## IoT Hub のスケーリング
IoT Hub では、IoT Hub S1 または S2 ユニット数を 2.000 に増やすことで、最大 100 万の同時接続デバイスをサポートできます。詳細については、「[IoT Hub の価格][lnk-pricing]」を参照してください。

各 IoT Hub ユニットで、同時に接続できるレジストリ内のデバイス ID 数と、毎日のメッセージ数が許可されます。

ソリューションを適切に調整するには、IoT Hub の使用を工夫する必要があります。具体的には、次の操作カテゴリに対して必要なピーク スループットを検討してください。

* デバイスからクラウドへのメッセージ
* クラウドからデバイスへのメッセージ
* ID レジストリの操作

このスループット情報のほか、[IoT Hub のクォータとスロットル]に関するページを参照して、適切にソリューションを設計してください。

### デバイスからクラウドおよびクラウドからデバイスへのメッセージのスループット
IoT Hub ソリューションのサイズを設定する方法として最適なのは、デバイスごとにトラフィックを評価することです。

デバイスからクラウドへのメッセージは、次の持続スループット ガイドラインに従います。

| レベル | 持続スループット | 持続送信レート |
| ---- | -------------------- | ------------------- |
| S1 | デバイスあたり最大 8 KB/時間 | デバイスあたり平均 4 メッセージ/時間 |
| S2 | デバイスあたり最大 4 KB/分 | デバイスあたり平均 2 メッセージ/分 |

デバイスからクラウドへのメッセージを受信するアプリケーションのバックエンドは、次の最大スループットを期待できます (すべてのリーダー全体が対象)。

| レベル | 持続スループット |
| ---- | -------------------- |
| S1 | ユニットあたり最大 120 KB/分、最小 2 MB/秒。 |
| S2 | ユニットあたり最大 4 MB/分、最小 2 MB/秒。 |

クラウドからデバイスへのメッセージのパフォーマンスはデバイスごとに調整され、デバイスごとに 1 分あたり最大 5 つのメッセージを受信します。

### ID レジストリ操作のスループット
IoT Hub の ID レジストリの操作は、ほとんどがデバイス プロビジョニングに関連しているため、ランタイム操作にはなりません。特定のバースト パフォーマンスの数値については、[IoT Hub のクォータとスロットル]に関するページを参照してください。

### シャーディング
1 つの IoT Hub を数百万のデバイスに拡張できますが、使用しているソリューションに、1 つの IoT Hub では保証できない特定のパフォーマンス特性が必要になる場合があります。この場合は、複数の IoT Hub でデバイスを分割して、トラフィック バーストを円滑化し、必要なスループットまたは操作レートを実現することをお勧めします。

## 高可用性と障害復旧
IoT Hub は、Azure サービスとして、Azure リージョン レベルの冗長性を使用して高可用性 (HA) を提供します。その際、ソリューションによる追加操作は必要ありません。さらに、Azure には、障害復旧 (DR) 機能または複数のリージョンにわたる可用性を備えたソリューションを、必要に応じて構築するときに役立つ機能が複数用意されています。複数のリージョンにわたるグローバルな可用性をデバイスまたはユーザーに提供するには、こうした機能を使用できるようにソリューションを設計し、準備する必要があります。ビジネス継続性および障害復旧のための Azure の組み込み機能については、「[Azure のビジネス継続性テクニカル ガイダンス]」を参照してください。また、「[Azure アプリケーションの障害復旧と高可用性]」では、HADR を実現するための Azure アプリケーションの戦略に関するアーキテクチャのガイダンスを確認できます。

## IoT Hub での地域フェールオーバー
このセクションでは、IoT ソリューションでのデプロイ トポロジの詳細については取り上げませんが、高可用性と障害復旧を実現するために、*地域フェールオーバー* デプロイ モデルについて検討します。

地域フェールオーバー モデルでは、ソリューション バックエンドは、主に 1 つのデータセンターの場所で実行されますが、追加の IoT Hub とバックエンドは、プライマリ データセンターの IoT Hub で障害が発生した場合、またはデバイスからプライマリ データセンターへのネットワーク接続が中断された場合にフェールオーバーできるように、追加のデータセンター リージョンにデプロイされます。プライマリ ゲートウェイにアクセスできない場合は必ず、セカンダリ サービス エンドポイントがデバイスによって使用されます。複数のリージョンにまたがるフェールオーバー機能を使用すると、ソリューションの可用性は、1 つのリージョンの高可用性を超えて向上させることができます。

大まかに言えば、IoT Hub で地域フェールオーバー モデルを実装するには、以下が必要です。

* **セカンダリ IoT Hub とデバイス ルーティングのロジック**: プライマリ リージョンでサービスの中断が発生した場合、セカンダリ リージョンへのデバイスの接続を開始する必要があります。関連するサービスのほとんどがステートフルである場合、ソリューションの管理者がリージョン間のフェールオーバー プロセスをトリガーするのはよくあることです。プロセスの制御を維持しながら、新しいエンドポイントをデバイスに伝達する最善の方法は、*コンシェルジェ* サービスで、現在のアクティブなエンドポイント サービスがないかどうかを定期的にチェックすることです。コンシェルジェ サービスはシンプルな Web アプリケーションで、DNS リダイレクト手法 ([Azure Traffic Manager] など) を使用してレプリケートされ、到達可能な状態が保持されます。
* **ID レジストリ レプリケーション**: 使用するには、ソリューションへの接続が必要なすべてのデバイス ID を、セカンダリ IoT Hub に格納する必要があります。ソリューションでは、デバイス ID の geo レプリケートされたバックアップを保持し、デバイスのアクティブなエンドポイントを切り替える前に、そのバックアップをセカンダリ IoT Hub にアップロードしなければなりません。IoT Hub のデバイス ID エクスポート機能は、この点で役に立ちます ([IoT Hub 開発者ガイド: ID レジストリ]に関するページを参照)。
* **マージ ロジック**: 再度プライマリ リージョンが使用可能になった時点で、セカンダリ サイトで作成されたすべての状態とデータをプライマリ リージョンに移行する必要があります。これは主にデバイス ID およびアプリケーション メタデータと関連しており、プライマリ IoT Hub とマージする必要があります。また、プライマリ リージョンにある他のアプリケーション固有のストアとのマージが必要になることもあります。この手順を簡単にするために、通常は、べき等操作を使用することをお勧めします。これにより、最終的に一貫性のあるイベント分布だけでなく、イベント重複や順不同配信の副次的な影響を最小限に抑えられます。また、アプリケーション ロジックは、システムの "修復" に時間がかかる場合や、目標復旧時点 (RPO) に従う場合があるため、潜在的な不整合や "多少の" 期限切れ状態を許容できるように設計する必要があります。「[フェールセーフ: 回復力のあるクラウド アーキテクチャに関するガイダンス]」では、このトピックに関するガイダンスを確認できます。




[img-tokenservice]: media/iot-hub-guidance/tokenservice.png

[IoT Hub Developer Guide - identity registry]: iot-hub-devguide.md#identityregistry
[IoT Hub 開発者ガイド: ID レジストリ]: iot-hub-devguide.md#identityregistry
[IoT Hub 開発者ガイド: 通信プロトコルの選択]: iot-hub-devguide.md#amqpvshttp
[IoT Hub Developer Guide - Security]: iot-hub-devguide.md#security
[IoT Hub 開発者ガイド: セキュリティ]: iot-hub-devguide.md#security
[IoT Hub Developer Guide - Anti-spoofing]: iot-hub-devguide.md#antispoofing
[プロトコル ゲートウェイ]: iot-hub-protocol-gateway.md
[IoT Hub のクォータとスロットル]: iot-hub-devguide.md#throttling

[IoT Hub デバイス管理のガイダンス]: iot-hub-device-management.md
[Event Hubs]: ../event-hubs/event-hubs-what-is-event-hubs/
[Azure Traffic Manager]: https://azure.microsoft.com/documentation/services/traffic-manager/
[Event Hub - security]: ../event-hubs/event-hubs-authentication-and-security-model-overview/
[Event Hub publisher policies]: ../event-hubs-overview/#common-publisher-tasks
[Service Bus のクォータ]: ../service-bus/service-bus-quotas/
[Azure IoT Hub SDKs]: https://github.com/Azure/azure-iot-sdks/blob/master/readme.md

[TLS PSK]: https://tools.ietf.org/html/rfc4279

[Azure のビジネス継続性テクニカル ガイダンス]: https://msdn.microsoft.com/library/azure/hh873027.aspx
[Azure アプリケーションの障害復旧と高可用性]: https://msdn.microsoft.com/library/azure/dn251004.aspx
[フェールセーフ: 回復力のあるクラウド アーキテクチャに関するガイダンス]: https://msdn.microsoft.com/library/azure/jj853352.aspx

[lnk-pricing]: https://azure.microsoft.com/pricing/details/iot-hub

<!---HONumber=Oct15_HO1-->