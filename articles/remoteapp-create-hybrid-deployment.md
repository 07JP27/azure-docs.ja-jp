<properties title="How to create a hybrid deployment of RemoteApp" pageTitle="How to create a hybrid deployment of RemoteApp" description="Learn how to create a deployment of RemoteApp that connects to your internal network." metaKeywords="" services="" solutions="" documentationCenter="" authors="elizapo"  />

<tags ms.service="remoteapp" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="elizapo"></tags>

# RemoteApp のハイブリッド デプロイメントの作成方法

RemoteApp のデプロイメントには、次の 2 種類の方法があります。

-   クラウド: Azure に完全に常駐し、Azure の管理ポータルの **[簡易作成]** オプションを使用して作成されます。
-   ハイブリッド: 内部設置型アクセス用の仮想ネットワークを含み、管理ポータルの **[VPN で作成]** オプションを使用して作成されます。

このチュートリアルでは、ハイブリッド デプロイメントを作成する手順について説明します。以下の 7 つのステップがあります。

1.  RemoteApp テンプレート イメージを作成する。
2.  RemoteApp サービスを作成する。
3.  仮想ネットワークに関連付ける。
4.  テンプレート イメージに関連付ける。
5.  ディレクトリ同期を構成する。RemoteApp では、内部設置型の Active Directory のユーザー、グループ、連絡先、パスワードを Azure Active Directory テナントと同期するために、この構成が必要となります。
6.  RemoteApp プログラムを発行する。
7.  ユーザー アクセスを構成する。

**開始する前に**

サービスを作成する前に、以下の操作が必要です。

-   Azure RemoteApp のパフォーマンスを高めるために[必須の更新][]をインストールします。
-   [RemoteApp のプレビュー][]にサインアップします。
-   RemoteApp サービス アカウントとして使用するためのユーザー アカウントを Active Directory に作成します。ドメインへのマシンの参加のみが実行可能になるように、このアカウントのアクセス許可を制限します。
-   内部設置型ネットワークに関する情報、つまり IP アドレス情報と VPN デバイスの詳細情報を収集します。
-   [Azure PowerShell][] モジュールをインストールします。
-   アクセス権を付与するユーザーとグループに関する情報を集めます。この情報とは、ユーザーまたはグループの Microsoft アカウントの情報または Active Directory の組織アカウントの情報です。

## **手順 1.テンプレート イメージの作成**

Azure RemoteApp では、ユーザーと共有するすべてのプログラムをホスティングするために Windows Server 2012 R2 のテンプレート イメージを使用します。カスタム RemoteApp テンプレート イメージを作成するには、既存のイメージを使うことも新しく作成することもできます。Azure RemoteApp で使用するためにアップロードできるイメージの要件は次のとおりです。

-   VHD ファイルになければなりません (VHDX ファイルは現在サポートされていません)。
-   VHD は固定サイズにすることも、動的に拡大する容量可変にすることも可能です。固定サイズの VHD より Azure へのアップロードの所要時間が短いことから、容量可変の VHD が推奨されます。
-   ディスクはマスター ブート レコード (MBR) パーティション分割のスタイルを使用して初期化しなければなりません。GUID パーティション テーブル (GPT) パーティション分割のスタイルはサポートされていません。
-   VHD には Windows Server 2012 R2 の単一インストールが含まれていなければなりません。複数のボリュームを含むことはできますが、Windows がインストールされるのは 1 ボリュームのみです。
-   リモート デスクトップ セッション ホスト (RDSH) ロールとデスクトップ エクスペリエンスの機能がインストール済みでなければなりません。
-   暗号化ファイル システム (EFS) は無効にする必要があります。
-   イメージはパラメーター **/oobe /generalize /shutdown** を使用して SYSPREP を実施済みでなければなりません (**/mode:vm** パラメーターは使用しないでください)。

新しいテンプレート イメージを一から作成するには、次の手順に従います。

1.  Windows Server 2012 R2 DVD または ISO イメージを見つけます。
2.  VHD ファイルを作成します。
3.  Windows Server 2012 R2 をインストールします。
4.  リモート デスクトップ セッション ホスト (RDSH) ロールとデスクトップ エクスペリエンスの機能をインストールします。
5.  使用するアプリケーションで必要な追加の機能をインストールします。
6.  アプリケーションをインストールし、構成します。
7.  使用するアプリケーションで必要な追加の Windows 構成を実行します。
8.  暗号化ファイル システム (EFS) を無効にします。
9.  イメージを SYSPREP します。

新しいイメージを作成するための詳しい手順は次のとおりです。

1.  Windows Server 2012 R2 DVD または ISO イメージを見つけます。
2.  ディスクの管理を使用して VHD ファイルを作成します。

    1.  ディスクの管理 (diskmgmt.msc) を起動します。
    2.  40 GB 以上のサイズに動的に拡大する VHD を作成します (Windows、使用するアプリケーション、カスタマイズで必要とされる容量を見積もってください。RDSH ロールとデスクトップ エクスペリエンスの機能がインストールされた Windows Server では約 10 GB の容量が必要になります)。

        1.  **[アクション] \> [VHD の作成]** をクリックします。
        2.  場所、サイズ、VHD 形式を指定します。**[容量可変]** を選択後、**[OK]** をクリックします。

            実行には数秒かかります。VHD の作成完了時、ディスクの管理用コンソールにドライブ文字のない新しいディスクと、[初期化されていません] の状態が表示されます。

        -   (未割り当て領域ではなく) ディスクを右クリックし、次に **[ディスクの初期化]** をクリックします。パーティション分割のスタイルとして **[MBR]** (マスター ブート レコード) を選択し、次に **[OK]** をクリックします。
        -   新しいボリュームの作成: 未割り当て領域を右クリックし、次に **[新しいシンプル ボリューム]** をクリックします。ウィザードの既定をそのまま使用できますが、テンプレート イメージのアップロード時に問題が発生する可能性を避けるためにドライブ文字を必ず割り当てるようにしてください。
        -   ディスクを右クリックして、**[VHD の切断]** をクリックします。

3.  Windows Server 2012 R2 をインストールします。

    1.  新しい仮想マシンを作成します。Hyper-V マネージャーまたはクライアント Hyper-V で仮想マシンの新規作成ウィザードを使用します。

        1.  [仮想ハード ディスクの接続] ページで **[既存の仮想ハード ディスクを使用する]** を選択し、前の手順で作成した VHD を参照します。
        2.  [インストール オプション] ページで **[ブート CD/DVD\_ROM からオペレーティング システムをインストールする]** を選択し、次に Windows Server 2012 R2 のインストール メディアの格納場所を選択します。
        3.  Windows とアプリケーションのインストールに必要な他のオプションをウィザードで選択します。ウィザードを終了します。

    2.  ウィザード終了後、VM の設定を編集し、仮想プロセッサの数などの Windows やプログラムのインストールに必要な他の変更を実行してから、**[OK]** をクリックします。
    3.  VM に接続し、Windows Server 2012 R2 をインストールします。

4.  リモート デスクトップ セッション ホスト (RDSH) ロールとデスクトップ エクスペリエンスの機能を次の手順でインストールします。

    1.  サーバー マネージャーを起動します。
    2.  [ようこそ] 画面上または **[管理]** メニューの **[役割と機能の追加]** をクリックします。
    3.  [開始する前に] ページで **[次へ]** をクリックします。
    4.  **[役割ベースまたは機能ベースのインストール]** を選択し、**[次へ]** をクリックします。
    5.  一覧からローカル コンピューターを選択し、**[次へ]** をクリックします。
    6.  **[リモート デスクトップ サービス]** を選択し、**[次へ]** をクリックします。
    7.  **[ユーザー インターフェイスとインフラストラクチャ]** を展開し、**[デスクトップ エクスペリエンス]** を選択します。
    8.  **[機能の追加]** をクリックしてから **[次へ]** をクリックします。
    9.  [リモート デスクトップ サービス] ページで **[次へ]** をクリックします。
    10. **[リモート デスクトップ セッション ホスト]** をクリックします。
    11. **[機能の追加]** をクリックしてから **[次へ]** をクリックします。
    12. [インストール オプションの確認] ページで、**[必要に応じて対象サーバーを自動的に再起動する]** を選択し、再起動警告が表示されたら **[はい]** をクリックします。
    13. **[インストール]** をクリックします。コンピューターが再起動します。

5.  .NET Framework 3.5 など、アプリケーションで必要な追加の機能をインストールします。機能をインストールするには、役割と機能の追加ウィザードを実行してください。
6.  RemoteApp を使用して発行するプログラムとアプリケーションをインストールして構成します。

    **重要:**Microsoft では、RemoteApp にイメージがアップロードされる前に、アプリケーションの互換性の問題が検出されるように、アプリケーションのインストール前に RDSH ロールをインストールすることをお勧めします。

7.  使用するアプリケーションで必要な追加の Windows 構成を実行します。
8.  暗号化ファイル システム (EFS) を無効にします。管理者特権のコマンド ウィンドウで、次のコマンドを実行してください。

        Fsutil behavior set disableencryption 1

    別の方法としては、次の DWORD 値をレジストリに設定または追加できます。

        HKLM\System\CurrentControlSet\Control\FileSystem\NtfsDisableEncryption = 1

9.  **Azure 仮想マシン**内にイメージを作成している場合は、後で使用するアップロード スクリプトの動作をブロックする **\\Windows\\Panther\\Unattend.xml** ファイルを削除するか名前を変更する必要があります。
10. イメージを SYSPREP します。管理者特権のコマンド プロンプトで、次のコマンドを実行します。

    **C:\\Windows\\System32\\sysprep\\sysprep.exe /generalize /oobe /shutdown**

    **注:** 仮想マシンであっても SYSPREP コマンドに **/mode:vm** スイッチは使用しないでください。

## **手順 2.RemoteApp サービスの作成**

1.  [Azure の管理ポータル][]で、[RemoteApp] ページに移動します。
2.  **[新規] \> [VPN で作成]** の順にクリックします。
3.  サービスの名前を入力してから、**[RemoteApp サービスの作成]** をクリックします。

RemoteApp サービスが作成されたら、RemoteApp の **[クイック スタート]** ページに進んでセットアップの手順を続行します。

## **手順 3.仮想ネットワークとの関連付け**

ユーザーは仮想ネットワークを利用することで、ローカル ネットワーク上のデータに RemoteApp リモート リソースを介してアクセスします。仮想ネットワークの関連付けを構成するには、次の 4 つの手順があります。

1.  [クイック スタート] ページで、**[RemoteApp 仮想ネットワークに関連付ける]** をクリックします。
2.  新しい仮想ネットワークを作成するか、既存のネットワークを使用するか選択します。このチュートリアルでは、新しいネットワークを作成します。
3.  新しいネットワークのために次の情報を提供します。

    -   名前
    -   仮想ネットワークのアドレス空間
    -   ローカル アドレス空間
    -   DNS サーバーの IP アドレス
    -   VPN の IP アドレス

    詳しくは、「[管理ポータルでのサイト間 VPN の構成][]」を参照してください。

4.  次に、[クイック スタート] ページに戻り、**[スクリプトを取得]** をクリックして、先ほど作成した仮想ネットワークに VPN デバイスを接続する構成のためのスクリプトをダウンロードします。VPN デバイスに関する次の情報が必要になります。

    -   ベンダー名
    -   プラットフォーム
    -   オペレーティング システム

    スクリプトを保存し、VPN デバイスで実行します。

    **注:** このスクリプトを実行すると、仮想ネットワークが準備完了状態に移行します。これには 5 ～ 7 分かかる場合があります。ネットワークの準備が完了するまでは使用できません。

5.  最後にもう一度 [クイック スタート] ページで、**[ローカル ドメインに参加]** をクリックします。RemoteApp サービス アカウントをローカル Active Directory ドメインに追加します。追加するには、ドメイン名、組織単位、サービス アカウントのユーザー名とパスワードが必要になります。

## **手順 4.RemoteApp テンプレート イメージの関連付け**

RemoteApp テンプレート イメージにはユーザーと共有するプログラムが含まれています。手順 1 で作成した新しいテンプレート イメージをアップロードすることも、既存のイメージ (既に Azure にアップロード済みのもの) に関連付けることもできます。

新しいイメージをアップロードする場合は、イメージの名前を入力して場所を選択する必要があります。ウィザードの次のページに PowerShell コマンドレットのセットが表示されます。特定のイメージをアップロードするために、このコマンドレットをコピーして管理者特権の Azure PowerShell プロンプトから実行します。

既存のテンプレート イメージを関連付ける場合は、そのイメージ名、保管場所、関連先の Azure のサブスクリプションを指定するだけで実行できます。

## **手順 5.Active Directory ディレクトリの同期の構成**

RemoteApp では、Azure Active Directory と内部設置型 Active Directory との間でディレクトリの同期が必要になります。これにより、ユーザー、グループ、連絡先、およびパスワードが Azure Active Directory テナントと同期します。計画に関する情報、および詳しい手順については、「[ディレクトリ同期のロードマップ][]」を参照してください。

## **手順 6.RemoteApp プログラムの発行**

RemoteApp プログラムは、ユーザーに提供するアプリケーションまたはプログラムのことです。このプログラムは、サービス用にアップロードしたテンプレート イメージに置かれています。ユーザーが RemoteApp プログラムにアクセスすると、プログラムはユーザーのローカル環境で実行しているように見えますが、実際には Azure で実行しています。

ユーザーから RemoteApp プログラムへのアクセスを可能にするには、最初にこのプログラムをエンド ユーザー フィードに発行する必要があります。エンド ユーザー フィードとは、ユーザーが Azure のポータルを通じてアクセスできるプログラムの一覧です。

RemoteApp サービスには複数のプログラムを発行できます。[RemoteApp プログラム] ページから、**[発行]** をクリックしてプログラムを追加します。プログラムは、テンプレート イメージの [スタート] メニューから発行することも、テンプレート イメージのパスをプログラムに指定して発行することもできます。[スタート] メニューから追加する場合は、発行するプログラムを選択します。プログラムのパスを指定して発行する場合は、プログラムの名前と、プログラムがインストールされるテンプレート イメージ上の保存場所までのパスを指定します。

## **手順 7.ユーザー アクセスの構成**

これで RemoteApp サービスが作成できたので、リモート リソースを使用可能にするユーザーとグループを追加する必要があります。アクセス権を付与するユーザーまたはグループは、この RemoteApp サービスを作成するために使用したサブスクリプションに関連付けられた Active Directory テナントに存在している必要があります。

1.  [クイック スタート] ページの **[ユーザー アクセスの構成]** をクリックします。
2.  アクセス権を付与する (Active Directory の) 組織アカウントかグループ名、または Microsoft アカウントを入力します。

    ユーザーに対しては、"<user@domain.com>" 形式を使用するようにしてください。グループに対しては、グループ名を入力します。

3.  ユーザーまたはグループが検証されたら、**[保存]** をクリックします。

## 次のステップ

これで、RemoteApp ハイブリッドのデプロイメントの作成とデプロイが正常に完了しました。次のステップは、ユーザーによるリモート デスクトップ クライアントのダウンロードとインストールです。このクライアントの URL は、RemoteApp の [クイック スタート] ページにあります。次に、ユーザーが Azure にログインし、発行した RemoteApp プログラムにアクセスします。

  [必須の更新]: http://support.microsoft.com/kb/2977219
  [RemoteApp のプレビュー]: http://azure.microsoft.com/en-us/services/remoteapp/
  [Azure PowerShell]: http://azure.microsoft.com/ja-jp/documentation/articles/install-configure-powershell/
  [Azure の管理ポータル]: http://manage.windowsazure.com
  [管理ポータルでのサイト間 VPN の構成]: http://msdn.microsoft.com/library/azure/dn133795.aspx
  [ディレクトリ同期のロードマップ]: http://msdn.microsoft.com//library/azure/hh967642.aspx
