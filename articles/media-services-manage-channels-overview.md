<properties 
	pageTitle="内部設置型のエンコーダーを使用して、マルチビットレートのライブ ストリームをチャネルに送信する" 
	description="このトピックでは、内部設置型のエンコーダーからマルチビットレートのライブ ストリームを受信するチャネルの設定方法について説明します。ストリームは、1 つ以上のストリーミング エンドポイントを介して、HLS、スムーズ ストリーミング、MPEGDASH、HDS のいずれかのアダプティブ ストリーミング プロトコルを使用してクライアントの再生アプリケーションに配布できます。" 
	services="media-services" 
	documentationCenter="" 
	authors="Juliako" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="media-services" 
	ms.workload="media" 
	ms.tgt_pltfrm="na" 
	ms.devlang="ne" 
	ms.topic="article" 
	ms.date="04/06/2015" 
	ms.author="juliako"/>

#内部設置型のエンコーダーを使用して、マルチビットレートのライブ ストリームをチャネルに送信する

##概要

Azure Media Services (AMS) では、**チャネル**はライブ ストリーミング コンテンツを処理するパイプラインを表します。ライブ ストリームでのセグメントの公開と保存は、**プログラム**を使用して制御します。プログラムはチャネルによって管理されます。チャネルとプログラムの関係は、従来のメディアとよく似ています。チャネルが絶えずコンテンツのストリームを配信するのに対し、プログラムは、そのチャネル上で決まった時間に生じるイベントです。 

ライブ ストリーミングを使用する場合、ワークフローに関係するコンポーネントの 1 つは、カメラからライブ ストリーミング サービスに送信されるストリームへの信号を変換するライブ ビデオ エンコーダーです。**チャネル**は、マルチビットレートの RTMP や Fragmented MP4 (スムーズ ストリーミング) ストリームを出力する内部設置型のライブ エンコーダーからライブの入力ストリームを受信できます。スムーズ ストリーミングを出力する次のライブ エンコーダーを使用できます。Elemental、Envivio、Cisco。次のライブ エンコーダーは RTMP を出力します。Adobe Flash Live、Telestream Wirecast、Tricaster トランスコーダー。取り込んだストリームは、追加の処理なしで**チャネル**を通過します。ライブ エンコーダーは単一ビットレートのストリームを取り込むこともできますが、ストリームは処理されないため、クライアント アプリケーションも単一ビットレートのストリームを受信することになります (このオプションはお勧めしません)。受信したコンテンツが発行されると、1 つ以上の**ストリーミング エンドポイント**を介してクライアントの再生アプリケーションにストリームされます。ストリームを再生するには、次のアダプティブ ストリーミング プロトコルを使用できます: HLS、MPEG DASH、スムーズ ストリーム、HDS。 

**ストリーミング エンドポイント**は、コンテンツをクライアント プレーヤー アプリケーションや、再配布のためのコンテンツ配信ネットワーク (CDN) に直接配信するストリーミング サービスを表します。ストリーミング エンドポイント サービスからの送信ストリームには、Media Services アカウントのライブ ストリームやオンデマンド ビデオ アセットがあります。さらに、ストリーミング占有ユニットを調整することで、ストリーミング エンドポイント サービスの容量を制御し、帯域幅の増化ニーズに対応することができます。実稼働環境のアプリケーションに、1 つ以上の予約済みユニットを割り当てる必要があります。詳細については、「[Media Services アカウントでストリーミング エンドポイントを管理する方法](media-services-manage-origins.md#scale_streaming_endpoints)」をご覧ください。

次の図は、内部設置型のライブのエンコーダーを使用してマルチビットレートの RTMP や Fragmented MP4 (スムーズ ストリーミング) ストリームを出力するライブ ストリーミング ワークフローを表しています。 

![ライブのワークフロー][live-overview]

このトピックでは、内部設置型のエンコーダーからのマルチビットレートのライブ ストリームを受信するチャネルの概要を示します。また、チャネルに関連するコンポーネントについても説明します。

##<a id="scenarios"></a>一般的なライブ ストリーミング シナリオ

次の手順では、一般的なライブ ストリーミング アプリケーションの作成に関連するタスクを示します。

1. ビデオ カメラをコンピューターに接続します。複数ビットレ0ートの RTMP や Fragmented MP4 (スムーズ ストリーミング) ストリームを出力する内部設置型のライブ エンコーダーを起動して構成します。詳細については、「[Azure Media Services の RTMP サポートとライブ エンコーダー (ブログの投稿)](http://go.microsoft.com/fwlink/?LinkId=532824)」をご覧ください。
	
	この手順は、チャネルを作成した後でも実行できます。

1. チャネルを作成し、起動します。
1. チャネルの取り込み URL を取得します。 

	取り込み URL は、ライブ エンコーダーがチャネルにストリームを送信する際に使用されます。
1. チャネルのプレビュー URL を取得します。 

	この URL を使用して、チャネルがライブ ストリームを正常に受信できることを確認します。

2. アセットを作成します。
3. 再生時にアセットを動的に暗号化する場合は、次の手順を実行します。 	
	
	1.	コンテンツ キーを作成します。 
	1.	コンテンツ キーの承認ポリシーを構成します。
1. アセットの配信ポリシーを構成します (動的パッケージと動的暗号化に使用されます)。
3. プログラムを作成し、作成したアセットを使用するよう指定します。
1. OnDemand ロケーターを作成して、プログラムに関連付けられたアセットを発行します。  

	コンテンツをストリームするストリーミング エンドポイントに少なくとも 1 つのストリーミング占有ユニットがあることを確認します。
1. ストリーミングとアーカイブの開始を準備するときにプログラムを開始します。
1. イベントのストリーミングとアーカイブを停止するときにプログラムを停止します。
1. プログラムを削除し、アセットを削除 (オプション) します。   

[ライブ ストリーミング タスク](media-services-manage-channels-overview.md#tasks) セクションに、上記のタスクの手順を示すトピックへのリンクがあります。


##<a id="channel_input"></a>チャネル入力 (インジェスト) の構成

###<a id="ingest_protocols"></a>インジェスト ストリーミング プロトコル

Media Services は、次のストリーミング プロトコルを使用したライブのフィードのインジェストをサポートしています。 

- **マルチビットレートの Fragmented MP4**
 
- **マルチビットレートの RTMP** 

	**RTMP** のインジェスト ストリーミング プロトコルが選択されている場合、そのチャンネルに 2 つのインジェスト (入力) エンドポイントが作成されます。 
	
	**プライマリ URL**: チャネルのプライマリ RTMP インジェスト エンドポイントの完全修飾 URL を指定します。

	**セカンダリ URL**(省略可能): チャネルのセカンダリ RTMP インジェスト エンドポイントの完全修飾 URL を指定します。 

	インジェスト ストリームの持続性とフォールト トレランスや、エンコーダーのフェイルオーバーとフォールトトレランスを向上させるには、セカンダリ URL を使用します。 
	
	- インジェストの持続性とフォールト トレランスを向上させるには: 
		
		プライマリとセカンダリの取り込みURL に同じデータを送信する際に 1 つのエンコーダーを使用します。ほとんどの RTMP エンコーダー (Flash Media エンコーダーや Wirecast など) はプライマリ URL とセカンダリ URL を使用できる機能を備えています。

	- エンコーダーのフェイルオーバーとフォールト トレランスを処理するには: 
		
		同じデータを生成してプライマリとセカンダリの取り込みURL に送信する際に複数のエンコーダーを使用します。この方法では、インジェストの持続性とエンコーダーの高可用性の両方を向上させることができます。注: エンコーダーは高可用性シナリオに対応する必要があるのに加えて、内部の時刻同期も必要です (詳細は、エンコーダーの説明書をご覧ください)。
	
 	セカンダリの取り込み URL を使用する際は、追加の帯域幅が必要です。 

チャネルに単一ビットレートを取り込むことはできますが、ストリームはチャネルで処理されないため、クライアント アプリケーションも単一ビットレートのストリームを受信することになります (このオプションはお勧めしません)。

RTMP ライブ エンコーダーの詳細については、「[Azure Media Services の RTMP サポートとライブ エンコーダー (ブログの投稿)](http://go.microsoft.com/fwlink/?LinkId=532824)」をご覧ください。

次の考慮事項が適用されます。

- 取り込みポイントにデータを送信するための十分な空きのインターネット接続があるかどうかを確認します。 
- 受信するマルチビットレート ストリームには、最大 10 のビデオ品質レベル (層) と、最大 5 つのオーディオ トラックを含めることができます。
- ビデオ品質レベル (層) の最高の平均ビットレートは、10 Mbps 以下である必要があります。
- すべてのビデオとオーディオ ストリームの平均ビットレートの合計は、25 Mbps である必要があります。
- チャネルやチャネルに関連付けられたプログラムの実行中は、入力プロトコルを変更できません。別のプロトコルが必要な場合は、入力プロトコルごとに別のチャネルを作成します。 


###取り込み URL (エンドポイント) 

エンコーダーがストリームをチャネルにプッシュできるよう、チャネルがライブ エンコーダーで指定した入力エンドポイント (取り込み URL) を提供します。   

取り込み URL は、チャネルの作成時に取得できます。これらの URL を取得するには、チャネルが開始済み状態である必要はありません。データをチャネルにプッシュする準備ができたら、チャネルを起動する必要があります。チャネルがデータの取り込みを開始すると、プレビュー URL 経由でストリームをプレビューできます。

Fragmented MP4 (スムーズ ストリーミング) のライブ ストリームを、SSL 経由で取り込むこともできます。SSL 経由で取り込むには、取り込み URL を HTTPS に更新する必要があります。現時点では、SSL 経由で RTMP を取り込むことはできません。 

###<a id="keyframe_interval"></a>キーフレームの間隔

内部設置型のライブ エンコーダーを使用してマルチビットレートのストリームを生成する場合、キーフレームの間隔は GOP 期間を指定します (その外部エンコーダーで使用)。チャネルがこの受信ストリームを受信したら、スムーズ ストリーミング、DASH、HLS のいずれかの形式でライブ ストリームをクライアントの再生アプリケーションに配信できます。ライブ ストリーミングの実行中、HLS は常に動的にパッケージ化されます。既定では、Media Services は自動的に HLS セグメントのパッケージ率 (セグメントあたりのフラグメント) をキーフレームの間隔に基づいて計算します。これは、画像グループ (GOP) とも呼ばれ、ライブ エンコーダーから受信します。 

次の表は、セグメントの期間の計算方法を示しています。

<table border="1">
<tr><th>キーフレームの間隔</th><th>HLS セグメントのパッケージ率 (FragmentsPerSegment)</th><th>例</th></tr>
<tr><td>3 秒以下</td><td>3:1</td><td>KeyFrameInterval (または GOP) が 2 秒の場合、既定の HLS セグメントのパッケージ率は 3:1 になり、6 秒間の HLS セグメントが作成されます。</td></tr>
<tr><td>3～5 秒</td><td>2:1</td><td>KeyFrameInterval (または GOP) が 4 秒の場合、既定の HLS セグメントのパッケージ率は 2:1 になり、8 秒間の HLS セグメントが作成されます。</td></tr>
<tr><td>6 秒以上</td><td>1:1</td><td>KeyFrameInterval (または GOP) が 6 秒の場合、既定の HLS セグメントのパッケージ率は 1:1 になり、6 秒間の HLS セグメントが作成されます。</td></tr>
</table>

セグメントあたりのフラグメント率は、チャネルの出力を構成して ChannelOutputHls の FragmentsPerSegment を設定すると変更できます。 

また、キーフレームの間隔の値は、ChanneInput の KeyFrameInterval プロパティを設定すると変更できます。 

KeyFrameInterval を明示的に設定すると、HLS セグメントのパッケージ率 FragmentsPerSegment は、上記の規則を使用して計算されます。  

KeyFrameInterval と FragmentsPerSegment の両方を明示的に設定すると、Media Services は設定された値を使用します。 


###許可された IP アドレス

このチャネルにビデオを発行できる IP アドレスを定義することができます。許可された IP アドレスは、1 つの IP アドレス (例: '10.0.0.1')、IP アドレスと CIDR サブネット マスクを使用した IP 範囲 (例: '10.0.0.1/22')、IP アドレスとピリオドで区切られた 10 進数のサブネット マスクを使用した IP 範囲 (例: '10.0.0.1(255.255.252.0)') のいずれかの形で指定できます。 

IP アドレスが指定されておらず、規則の定義もない場合は、どの IP アドレスも許可されません。すべての IP アドレスを許可するには、規則を作成し、0.0.0.0/0 に設定します。

##チャネルのプレビュー 

###プレビュー URL

ストリームをさらに処理して配信する前にプレビューできるプレビュー エンドポイント (プレビュー URL) がチャネルから提供されます。

プレビュー URL は、チャネルの作成時に取得できます。URL を取得するには、チャネルが開始済み状態である必要はありません。 

チャネルがデータの取り込みを開始した後、ストリームをプレビューできます。

現在、プレビュー ストリームを配信できるのは指定された入力タイプにかかわらず、Fragmented MP4 (スムーズ ストリーミング) 形式のみです。スムーズ ストリーミングのテストには、[http://smf.cloudapp.net/healthmonitor](http://smf.cloudapp.net/healthmonitor) プレーヤーを使用できます。また、Azure 管理ポータルでホストされているプレーヤーを使用してストリームを表示することもできます。


###許可された IP アドレス

プレビューのエンドポイントへの接続を許可する IP アドレスを定義することができます。IP アドレスを指定しない場合、すべての IP アドレスが許可されます。許可された IP アドレスは、1 つの IP アドレス (例: '10.0.0.1')、IP アドレスと CIDR サブネット マスクを使用した IP 範囲 (例: '10.0.0.1/22')、IP アドレスとピリオドで区切られた 10 進数のサブネット マスクを使用した IP 範囲 (例: '10.0.0.1(255.255.252.0)') のいずれかの形で指定できます。

##チャネルの出力

詳細については、[キーフレームの間隔の設定](#keyframe_interval) セクションをご覧ください。


##チャネルのプログラム

チャネルは、ライブ ストリームのセグメントの発行と保存を管理できるプログラムに関連付けられています。プログラムはチャネルによって管理されます。チャネルとプログラムの関係は、従来のメディアとよく似ています。チャネルが絶えずコンテンツのストリームを配信するのに対し、プログラムは、そのチャネル上で決まった時間に生じるイベントです。

プログラムの **[Archive Window (アーカイブ ウィンドウ)]** の長さを設定することで、録画されたコンテンツの保持時間を指定できます。この値は、最小 5 分から最大 25 時間までの範囲で設定できます。クライアントが現在のライブ位置からさかのぼって検索できる最長時間も、Archive Window (アーカイブ ウィンドウ)の長さによって決まります。プログラムの放送は、指定された期間継続しますが、ArchiveWindowLength を過ぎたコンテンツは絶えず破棄されていきます。さらに、このプロパティの値によって、クライアント マニフェストが肥大した場合の最大サイズも決まります。

各プログラムはアセットに関連付けられています。プログラムを公開するには、関連付けられたアセットの OnDemand ロケーターを作成する必要があります。このロケーターを作成すると、ストリーミング URL を構築してクライアントに提供することができます。

チャネルは、最大 3 つの同時実行プログラムをサポートするため、同じ受信ストリームのアーカイブを複数作成できます。これにより、1 つのイベントのさまざまな部分を必要に応じて公開したりアーカイブしたりできます。たとえば、ビジネス要件によって 1 つのプログラムの 6 時間分をアーカイブする一方、最後の 10 分間のみをブロードキャストする場合があります。これを実現するには、2 つの同時実行プログラムを作成する必要があります。1 つのプログラムは 6 時間分のイベントをアーカイブするように設定しますが、プログラムは公開されません。もう 1 つのプログラムは 10 分間のアーカイブを行うように設定します。このプログラムは公開されます。

新しいイベントには既存のプログラムを再使用できません。代わりに、「ライブ ストリーミング アプリケーションのプログラミング」セクションにあるように、各イベントで新しいプログラムを作成し、起動します。

ストリーミングとアーカイブの開始を準備するときにプログラムを開始します。イベントのストリーミングとアーカイブを停止するときにプログラムを停止します。 

アーカイブ済みコンテンツを削除するには、プログラムを停止して削除し、次に関連付けられたアセットを削除します。プログラムがアセットを使用している場合はアセットを削除できません。まずプログラムを削除する必要があります。 

プログラムを停止して削除した後も、アセットを削除していなければアーカイブ済みコンテンツをオンデマンドでのビデオとしてストリームできます。

アーカイブ済みコンテンツを保持したいが、ストリーミングには使用したくない場合は、ストリーミング ロケーターを削除します。

##チャネルの状態

現在のチャネルの状態。指定できる値は、次のとおりです。

- Stopped。これは、チャネル作成後の初期状態です。この状態で、チャネルのプロパティを更新することができますが、ストリーミングは許可されていません。
- Starting。チャネルを開始しています。この状態の場合、更新やストリーミングはできません。エラーが発生した場合は、チャネルは Stopped 状態に戻ります。
- Running。チャネルは、ライブ ストリームを処理できます。
- Stopping。チャネルが停止されました。この状態の場合、更新やストリーミングはできません。
- Deleting。チャネルが削除されました。この状態の場合、更新やストリーミングはできません。 

##クローズド キャプションと広告の挿入 

次の表は、サポートされているクローズド キャプションや広告挿入の標準を示しています。

<table border="1">
<tr><th>標準</th><th>注</th></tr>
<tr><td>CEA-708 と EIA-608 (708/608)</td><td>CEA 708 と EIA 608 は、米国とカナダのクローズド キャプションの標準です。<br/>現時点では、キャプションがサポートされるのはエンコードされた入力ストリーム内でのみです。608 または 708 キャプションを、Media Services に送信されるエンコードされたストリームに挿入できるライブ メディア エンコーダーを使用する必要があります。Media Services はキャプションが挿入されたコンテンツをユーザーに配信します。</td></tr>
<tr><td>ismt (スムーズ ストリーミング テキスト トラック) 内の TTML</td><td>Media Services の動的パッケージ機能では、クライアントが MPEG DASH、HLS、スムーズ ストリーミングのいずれかの形式でコンテンツをストリームできます。ただし、.ismt (スムーズ ストリーミング テキスト トラック) 内のキャプションのある Fragment MP4 を取り込む場合は、ストリーミングを配信できるのはスムーズ ストリーミング クライアントのみになります。</td></tr>
<tr><td>SCTE-35</td><td>広告の挿入のキューには、デジタル信号システムが使用されます。ダウンストリームの受信側は信号を使用して、割り当てられた時間のストリームに広告をスプライスします。SCTE 35 は、入力ストリームのスパース トラックとして送信する必要があります。<br/>現時点では、信号の伝送がサポートされている入力ストリーム形式は Fragmented MP4 (スムーズ ストリーミング) のみです。サポートされている出力形式も、スムーズ ストリーミングのみです。</td></tr>
</table>

##考慮事項

内部設置型のライブ エンコーダーを使用してマルチビットレートのストリームをチャネルに送信する際は、次の考慮事項を適用します。

- 取り込みポイントにデータを送信するための十分な空きのインターネット接続があるかどうかを確認します。 
- 受信するマルチビットレート ストリームには、最大 10 のビデオ品質レベル (10 層) と、最大 5 つのオーディオ トラックを含めることができます。
- ビデオ品質レベル (層) の最高の平均ビットレートは、10 Mbps 以下である必要があります。
- すべてのビデオとオーディオ ストリームの平均ビットレートの合計は、25 Mbps である必要があります。
- チャネルやチャネルに関連付けられたプログラムの実行中は、入力プロトコルを変更できません。別のプロトコルが必要な場合は、入力プロトコルごとに別のチャネルを作成します。 


チャネルと関連コンポーネントの作業に関するその他の考慮事項は次のとおりです。


- 課金はチャネルが実行中の状態のときのみ発生します。
- ライブ エンコーダーを再構成する際は、毎回チャネルで **Reset** メソッドを呼び出します。チャネルをリセットする前に、プログラムを停止する必要があります。チャネルをリセットしたら、プログラムを再起動します。 
- チャネルを停止できるのは実行中の状態で、チャネルのすべてのプログラムが停止しているときのみです。
- 既定では、Media Services カウントに追加できるチャネル数は 5 つのみです。詳細については、「[クォータと制限](media-services-quotas-and-limitations.md)」をご覧ください。
- チャネルやチャネルに関連付けられたプログラムの実行中は、入力プロトコルを変更できません。別のプロトコルが必要な場合は、入力プロトコルごとに別のチャネルを作成します。 

##<a id="tasks"></a>ライブ ストリーミングに関連するタスク

###コンピューターのセットアップ

コンピューターのセットアップ方法の詳細については、「[コンピューターのセットアップ](media-services-set-up-computer.md)」をご覧ください。

###ストリーミング エンドポイントの構成

ストリーミング エンドポイントの概要と、その管理方法については、「[Media Services アカウントでストリーミング エンドポイントを管理する方法](media-services-manage-origins.md)」をご覧ください。

###内部設置型のライブ エンコーダーを使用してマルチ ビットレート ストリーミングをチャネルに出力する

詳細については、「[Azure Media Services でのサード パーティ ライブ エンコーダーの使用](https://msdn.microsoft.com/library/azure/dn783464.aspx)」をご覧ください。

###チャネル、プログラム、アセットの管理
詳細については、「[チャネルとプログラムの管理の概要](media-services-manage-channels-overview.md)」をご覧ください。

**[ポータル]**、**[.NET]**、**[REST API]** をクリックするとサンプルを確認できます。

[AZURE.INCLUDE [media-services-selector-manage-channels](../includes/media-services-selector-manage-channels.md)]

###アセット配信ポリシーの構成

**.NET** または **REST API** を使用してアセット配信ポリシーを構成します。

[AZURE.INCLUDE [media-services-selector-asset-delivery-policy](../includes/media-services-selector-asset-delivery-policy.md)]

###コンテンツ キーの作成

**.NET** や **REST API** を使用してアセットを暗号化するコンテンツ キーを作成します。

[AZURE.INCLUDE [media-services-selector-create-contentkey](../includes/media-services-selector-create-contentkey.md)]

###コンテンツ キーの承認ポリシーの構成 

**.NET** または **REST API** を使用してコンテンツ保護やキー承認ポリシーを構成するには、以下をご覧ください。

[AZURE.INCLUDE [media-services-selector-content-key-auth-policy](../includes/media-services-selector-content-key-auth-policy.md)]


###アセットの公開

**Azure 管理ポータル** または **.NET** を使用してアセットを公開します (ロケータを作成して)。

[AZURE.INCLUDE [media-services-selector-publish](../includes/media-services-selector-publish.md)]


###Azure CDN の有効化

Media Services では、Azure CDN との統合をサポートしています。Azure CDN を有効にする方法については、「[Media Services アカウントでストリーミング エンドポイントを管理する方法](media-services-manage-origins.md#enable_cdn)」をご覧ください。

###Media Services アカウントのスケーリング

準備するアカウントの **ストリーミング占有ユニット** の数を指定して、**Media Services ** の規模を設定できます。 

ストリーミング ユニットの規模の設定については、[「ストリーミング ユニットの拡張](media-services-manage-origins.md#scale_streaming_endpoints.md)」をご覧ください。


[live-overview]: ./media/media-services-overview/media-services-live-streaming-current.png


<!--HONumber=52-->