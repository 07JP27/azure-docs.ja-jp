---
title: Azure ネットワーク セキュリティ グループのフロー ログの変更点 | Microsoft Docs
description: Azure ネットワーク セキュリティ グループのフロー ログの変更点について説明します。
services: network-watcher
documentationcenter: na
author: jimdial
manager: jeconnoc
editor: ''
ms.assetid: ''
ms.service: network-watcher
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 08/16/2018
ms.author: jdial
ms.openlocfilehash: b3a5ca929c83f70c31d667c2d9c811623691cff8
ms.sourcegitcommit: 1aedb52f221fb2a6e7ad0b0930b4c74db354a569
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 08/17/2018
ms.locfileid: "40180561"
---
# <a name="network-security-group-flow-logs--version-2--upcoming-changes"></a>ネットワーク セキュリティ グループのフロー ログ -バージョン 2 – 予定されている変更

2018 年 9 月 15 日から、ネットワーク セキュリティ グループのフロー ログの形式が変更されます。 追加されるフィールドは、フロー状態に関する情報と、各方向に転送されたバイトおよびパケットの増分カウントを提供します。 フロー ログを解析するアプリケーションはこの変更の影響を受けるため、変更内容に応じて更新する必要があります。 この記事では、変更の詳細について説明します。

## <a name="what-is-changing"></a>何が変わるのですか?

ネットワーク セキュリティ グループのフロー ログのバージョンは "バージョン": 1 から "バージョン": 2 に変更され、ログの *flowTuples* プロパティにフィールドが追加されます。 形式の詳細は「[バージョン 2 ではフローがどのようにモデル化されますか?](#how-is-a-flow-modeled-in-version-2)」で説明しています。

### <a name="version-1-flow-tuple-format"></a>バージョン 1 のフローのタプル形式

```
"1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,D"
```

### <a name="version-2-flow-tuple-format"></a>バージョン 2 のフローのタプル形式

```
"1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,A,C,1,103,1,186"
```

## <a name="when-will-this-change-take-place"></a>この変更はいつ行われますか?

この変更は、米国中西部リージョンで **2018 年 9 月 15 日**から有効になります。 パブリック クラウド リージョンでの変更のロールアウトは、2018 年 11 月 30 日までに完了する予定です。それ以降は、バージョン 2 のログのみが利用可能になります。

## <a name="am-i-affected-by-the-change"></a>私は変更の影響を受けますか?

ネットワーク セキュリティ グループのフロー ログ データを処理するアプリケーションを構築または使用している場合は、この変更の影響を受ける可能性があります。

### <a name="if-i-use-traffic-analytics"></a>Traffic Analytics を使用している場合は?

いいえ。 Traffic Analytics は、フロー ログのバージョン 1 からバージョン 2 への移行中に影響を受けません。 提供間近の機能強化では、バージョン 2 のフロー ログで提供される追加のセッションおよび帯域幅情報を利用します。

### <a name="if-im-using-third-party-tooling"></a>サード パーティのツールを使用している場合は?

ログ形式の変更は、すべての [Network Watcher パートナー](https://azure.microsoft.com/services/network-watcher)に事前に通知されています。 詳細については、ベンダーにお問い合わせください。

### <a name="if-i-have-built-a-custom-application-or-integration"></a>カスタム アプリケーションまたは統合を構築済みの場合は?

**はい**。新しい形式の NSG フロー ログを処理するようにアプリケーションを変更する必要があります。

## <a name="what-is-the-new-flow-logging-format"></a>フロー ログの新しい形式はどのようなものですか?

フロー ログのバージョン 2 には、次の形式のフロー タプルが含まれています。

```
"1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,A,C,1,103,1,186".
```

次の表は、ネットワーク セキュリティ グループのバージョン 2 フロー タプルのプロパティ名と説明を示しています。 完全なサンプル レコードは、「[Version 2 sample event](#version2sampleevent)」\(バージョン 2 のサンプル イベント\) にあります。

| プロパティ名                        | 値           | 説明                                                                                                                                                 |
| ------------------------------------ | --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------|
| タイム スタンプ                           | 1493763938      | フロー エントリに対応するタイムスタンプ。 UNIX EPOCH 形式が使用されます。                                                                                       |
| 送信元 IP アドレス                    | 185.170.185.105 |                                                                                                                                                             |
| 宛先 IP アドレス               | 10.2.0.4        |                                                                                                                                                             |
| 発信元ポート                          | 35370           |                                                                                                                                                             |
| 宛先ポート                     | 23              |                                                                                                                                                             |
| Traffic protocol (トラフィック プロトコル)                     | T               | **T**: TCP、**U**: UDP。                                                                                                                                  |
| Traffic flow direction (トラフィック フローの方向)               | I               | **I**: 受信トラフィック。**O**: 送信トラフィック。                                                                                                         |
| Traffic decision (トラフィックに関する決定)                     | A               | **A**: フローが許可された。**D**: フローが拒否された。                                                                                                         |
| Flow state (フロー状態)                           | C               | **B**: 開始。フローが作成された時点です。 統計は提供されません。 **C**: 継続中。フローが進行中です。 5 分間隔で統計が提供されます。 **E**: 終了。フローが終了した時点です。 統計が提供されます。                                                                                                                                                        |
| Packets - Source to destination (パケット - 送信元から宛先へ)      | 1               | 最後の更新以降に送信元から宛先に送信された TCP および UDP パケットの総数。                                                                  |
| Bytes sent - Source to destination (送信済みバイト数 - 送信元から宛先へ)   | 103             | 最後の更新以降に送信元から宛先に送信された TCP および UDP パケットのバイト数の合計。 パケットのバイト数には、パケット ヘッダーとペイロードが含まれます。         |
| Packets sent - Destination to source (送信済みパケット - 宛先から送信元へ) | 1               | 最後の更新以降に宛先から送信元に送信された TCP および UDP パケットの総数。                                                                  |
| Bytes sent - Destination to source (送信済みバイト数 - 宛先から送信元へ)   | 186             | 最後の更新以降に宛先から送信元に送信された TCP および UDP パケットのバイト数の合計。 パケットのバイト数には、パケット ヘッダーとペイロードが含まれます。             |

## <a name="how-is-a-flow-modeled-in-version-2"></a>バージョン 2 ではフローがどのようにモデル化されますか?

ログのバージョン 2 ではフロー状態が導入されます。 フローが開始されると、フロー状態 *B* が記録されます。 フロー状態 *C* およびフロー状態 *E* は、それぞれフローの継続とフローの終了を示す状態です。 *C* 状態と *E* 状態のどちらにも、トラフィックの帯域幅情報が含まれます。

**例**: 185.170.185.105:35370 と 10.2.0.4:23 間の TCP 通信のフロー タプル:

"1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,A,B,,,," "1493695838,185.170.185.105,10.2.0.4,35370,23,T,I,A,C,1021,588096,8005,4610880" "1493696138,185.170.185.105,10.2.0.4,35370,23,T,I,A,E,52,29952,47,27072"

### <a name="how-does-the-format-differ-from-version-1"></a>バージョン 1 とはどのように形式が違うのですか?

バージョン 1 では、フロー タプル["1493763938,185.170.185.105,10.2.0.4,35370,23,T,I,D"] は、フローが確立されるたび、またはフローの確立が試みられるたび (拒否のケース) に作成されます。

### <a name="how-are-bytes-and-packets-accounted-for"></a>バイト数とパケット数はどのように計算されますか?

継続の *C* と終了の *E* の各フロー状態では、バイト数とパケット数は、前のフロー タプル レコードの時点から集計した数です。 前の例の通信では、転送されたパケットの総数は 1021+52+8005+47 = 9125 です。 転送された合計バイト数は 588096+29952+4610880+27072 = 5256000 です。

### <a name="if-my-application-doesnt-understand-the-traffic-bandwidth-fields-how-does-version-2-affect-the-application"></a>アプリケーションがトラフィックの帯域幅フィールドを解釈できない場合、バージョン 2 はアプリケーションにどのような影響がありますか?

ネットワーク セキュリティ グループのフロー ログのバージョン 1 を使用するアプリケーションは通常、一意なフローの数をカウントします。 フロー状態を考慮した変更が解析動作に加えられていない場合、報告されるフロー数の不正確な増加がみられる可能性があります。 *C* および *E* フロー状態のフロー タプルを無視することによって、一意なフローをカウントできます。

## <a name="can-i-control-the-version-format-i-receive"></a>受信するバージョン形式を制御できますか?

いいえ。 フロー ログの有効化と無効化は、ログの出力形式に影響を及ぼしません。 バージョン 1 のログからバージョン 2 のログへの変更はリージョン単位で実施されます。 リージョンでバージョン 1 からバージョン 2 へのアップグレードが行われる際、両方の形式の NSG フロー ログが出現する場合があります。 ロールアウトの完了後は、バージョン 2 のログのみが利用可能になります。

## <a name="while-the-change-occurs-can-i-see-both-formats-for-the-same-network-security-group"></a>変更の実施中、同じネットワーク セキュリティ グループに対して両方の形式が出現する可能性がありますか?

はい。 リージョン内では、移行は MAC アドレス単位で実施されます。 ネットワーク セキュリティ グループは多くのコンピューターに適用される可能性があるため、両方の形式のログがストレージに書き込まれることがあります。 ログはバージョン 1 またはバージョン 2 のどちらかになります。

## <a name="will-i-see-duplicate-data"></a>重複したデータが出現しますか?

フロー ログ データが複数の形式で重複することはありません。 変更の実施中、フローはバージョン 1 またはバージョン 2 のどちらかの形式で記録されます。

## <a name="how-can-i-test-the-new-format-ahead-of-time"></a>新しい形式を事前にテストできる方法はありますか?

はい。 バージョン 2 のフロー ログ ファイルのサンプルを[ダウンロード](https://aka.ms/nsgflowlogsv2blobsample)してソリューションのテストに使用できます。

## <a name="are-there-changes-to-configuration-and-management-of-network-security-group-flow-logging"></a>ネットワーク セキュリティ グループのフロー ログの構成および管理に変更はありますか?

いいえ。 同じ Azure Active Directory テナントを共有するサブスクリプションをまたいだ Azure Storage アカウントのサポートが、今年の前半に[リリース](https://azure.microsoft.com/blog/new-azure-network-watcher-integrations-and-network-security-group-flow-logging-updates/)されました。 この変更により、ネットワーク セキュリティ グループのフロー ログの管理時に必要なストレージ アカウントの数を減らすことができます。

## <a name="questions-or-feedback"></a>質問またはフィードバックはありますか?

ネットワーク セキュリティ グループのフロー ログや Network Watcher に関する皆様の経験についてのご意見をお待ちしています。 フィードバックまたは提案はオンラインまたは電子メール (AzureNetworkWatcher@microsoft.com) からお送りください。

## <a name="version-2-sample"></a>バージョン 2 のサンプル

```json
{

"records": [

{

"time": "2018-08-03T17:00:54.5657764Z",

"systemId": "bbd48473-8ce0-4834-99bb-2e13b9b23ff8",

"category": "NetworkSecurityGroupFlowEvent",

"resourceId":
"/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FLOWLOGSV2DEMO/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/MULTITIERAPP2-NSG",

"operationName": "NetworkSecurityGroupFlowEvents",

"properties": {

"Version": 2,

"flows": [

{

"rule": "DefaultRule_AllowInternetOutBound",

"flows": [

{

"mac": "002248034CC3",

"flowTuples": [

"1533315592,10.1.1.6,204.79.197.200,62375,80,T,O,A,B,,,,",

"1533315595,10.1.1.6,204.79.197.200,62373,80,T,O,A,E,30,1784,92,123631",

"1533315597,10.1.1.6,204.79.197.200,62376,80,T,O,A,B,,,,",

"1533315601,10.1.1.6,204.79.197.200,62374,80,T,O,A,E,13,866,87,123079",

"1533315603,10.1.1.6,204.79.197.200,62377,80,T,O,A,B,,,,",

"1533315604,10.1.1.6,204.79.197.200,62375,80,T,O,A,E,33,1946,90,123247",

"1533315608,10.1.1.6,204.79.197.200,62378,80,T,O,A,B,,,,",

"1533315610,10.1.1.6,204.79.197.200,62376,80,T,O,A,E,20,1244,92,123355",

"1533315613,10.1.1.6,204.79.197.200,62379,80,T,O,A,B,,,,",

"1533315616,10.1.1.6,204.79.197.200,62377,80,T,O,A,E,24,1460,92,123355",

"1533315619,10.1.1.6,204.79.197.200,62380,80,T,O,A,B,,,,",

"1533315622,10.1.1.6,204.79.197.200,62378,80,T,O,A,E,23,1406,93,123409",

"1533315624,10.1.1.6,204.79.197.200,62381,80,T,O,A,B,,,,",

"1533315628,10.1.1.6,204.79.197.200,62379,80,T,O,A,E,16,1028,88,123133",

"1533315630,10.1.1.6,204.79.197.200,62382,80,T,O,A,B,,,,",

"1533315631,10.1.1.6,204.79.197.200,62380,80,T,O,A,E,13,866,87,123079",

"1533315635,10.1.1.6,204.79.197.200,62384,80,T,O,A,B,,,,",

"1533315637,10.1.1.6,204.79.197.200,62381,80,T,O,A,E,15,974,86,123025",

"1533315640,10.1.1.6,204.79.197.200,62385,80,T,O,A,B,,,,",

"1533315643,10.1.1.6,204.79.197.200,62382,80,T,O,A,E,16,1028,88,123139",

"1533315646,10.1.1.6,204.79.197.200,62386,80,T,O,A,B,,,,",

"1533315649,10.1.1.6,204.79.197.200,62384,80,T,O,A,E,21,1298,92,123355",

"1533315651,10.1.1.6,204.79.197.200,62387,80,T,O,A,B,,,,"

]

}

]

}

]

}

},

{

"time": "2018-08-03T17:01:54.5668880Z",

"systemId": "bbd48473-8ce0-4834-99bb-2e13b9b23ff8",

"category": "NetworkSecurityGroupFlowEvent",

"resourceId":
"/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FLOWLOGSV2DEMO/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/MULTITIERAPP2-NSG",

"operationName": "NetworkSecurityGroupFlowEvents",

"properties": {

"Version": 2,

"flows": [

{

"rule": "DefaultRule_DenyAllInBound",

"flows": [

{

"mac": "002248034CC3",

"flowTuples": [

"1533315685,80.211.83.37,10.1.1.6,45321,81,T,I,D,B,,,,"

]

}

]

},

{

"rule": "DefaultRule_AllowInternetOutBound",

"flows": [

{

"mac": "002248034CC3",

"flowTuples": [

"1533315655,10.1.1.6,204.79.197.200,62385,80,T,O,A,E,20,1244,87,123079",

"1533315657,10.1.1.6,204.79.197.200,62388,80,T,O,A,B,,,,",

"1533315658,10.1.1.6,204.79.197.200,62386,80,T,O,A,E,26,1568,92,123355",

"1533315662,10.1.1.6,204.79.197.200,62389,80,T,O,A,B,,,,",

"1533315664,10.1.1.6,204.79.197.200,62387,80,T,O,A,E,15,974,88,123133",

"1533315667,10.1.1.6,204.79.197.200,62390,80,T,O,A,B,,,,",

"1533315670,10.1.1.6,204.79.197.200,62388,80,T,O,A,E,18,1136,88,123139",

"1533315673,10.1.1.6,204.79.197.200,62391,80,T,O,A,B,,,,",

"1533315676,10.1.1.6,204.79.197.200,62389,80,T,O,A,E,14,920,87,123079",

"1533315678,10.1.1.6,204.79.197.200,62392,80,T,O,A,B,,,,",

"1533315679,10.1.1.6,204.79.197.200,62390,80,T,O,A,E,31,1838,94,123739",

"1533315684,10.1.1.6,204.79.197.200,62393,80,T,O,A,B,,,,",

"1533315685,10.1.1.6,204.79.197.200,62391,80,T,O,A,E,28,1676,101,141199",

"1533315689,10.1.1.6,204.79.197.200,62394,80,T,O,A,B,,,,",

"1533315691,10.1.1.6,204.79.197.200,62392,80,T,O,A,E,21,1298,93,123409",

"1533315694,10.1.1.6,204.79.197.200,62395,80,T,O,A,B,,,,",

"1533315697,10.1.1.6,204.79.197.200,62393,80,T,O,A,E,26,1568,91,123393",

"1533315700,10.1.1.6,204.79.197.200,62396,80,T,O,A,B,,,,",

"1533315703,10.1.1.6,204.79.197.200,62394,80,T,O,A,E,14,920,89,123187",

"1533315705,10.1.1.6,204.79.197.200,62397,80,T,O,A,B,,,,",

"1533315706,10.1.1.6,204.79.197.200,62395,80,T,O,A,E,13,866,87,123079",

"1533315711,10.1.1.6,204.79.197.200,62398,80,T,O,A,B,,,,"

]

}

]

}

]

}

}

]

}
```

## <a name="version-1-sample"></a>バージョン 1 のサンプル

```json
{ 

    "records": [ 

        { 

            "time": "2017-02-16T22:00:32.8950000Z", 

            "systemId": "2c002c16-72f3-4dc5-b391-3444c3527434", 

            "category": "NetworkSecurityGroupFlowEvent", 

            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG", 

            "operationName": "NetworkSecurityGroupFlowEvents", 

            "properties": { 

                "Version": 1, 

                "flows": [ 

                    { 

                        "rule": "DefaultRule_DenyAllInBound", 

                        "flows": [ 

                            { 

                                "mac": "000D3AF8801A", 

                                "flowTuples": [ 

                                    "1487282421,42.119.146.95,10.1.0.4,51529,5358,T,I,D" 

                                ] 

                            } 

                        ] 

                    }, 

                    { 

                        "rule": "UserRule_default-allow-rdp", 

                        "flows": [ 

                            { 

                                "mac": "000D3AF8801A", 

                                "flowTuples": [ 

                                    "1487282370,163.28.66.17,10.1.0.4,61771,3389,T,I,A", 

                                    "1487282393,5.39.218.34,10.1.0.4,58596,3389,T,I,A", 

                                    "1487282393,91.224.160.154,10.1.0.4,61540,3389,T,I,A", 

                                    "1487282423,13.76.89.229,10.1.0.4,53163,3389,T,I,A" 

                                ] 

                            } 

                        ] 

                    } 

                ] 

            } 

        }, 

        { 

            "time": "2017-02-16T22:01:32.8960000Z", 

            "systemId": "2c002c16-72f3-4dc5-b391-3444c3527434", 

            "category": "NetworkSecurityGroupFlowEvent", 

            "resourceId": "/SUBSCRIPTIONS/00000000-0000-0000-0000-000000000000/RESOURCEGROUPS/FABRIKAMRG/PROVIDERS/MICROSOFT.NETWORK/NETWORKSECURITYGROUPS/FABRIAKMVM1-NSG", 

            "operationName": "NetworkSecurityGroupFlowEvents", 

            "properties": { 

                "Version": 1, 

                "flows": [ 

                    { 

                        "rule": "DefaultRule_DenyAllInBound", 

                        "flows": [ 

                            { 

                                "mac": "000D3AF8801A", 

                                "flowTuples": [ 

                                    "1487282481,195.78.210.194,10.1.0.4,53,1732,U,I,D" 

                                ] 

                            } 

                        ] 

                    }, 

                    { 

                        "rule": "UserRule_default-allow-rdp", 

                        "flows": [ 

                            { 

                                "mac": "000D3AF8801A", 

                                "flowTuples": [ 

                                    "1487282435,61.129.251.68,10.1.0.4,57776,3389,T,I,A",

                                    "1487282454,84.25.174.170,10.1.0.4,59085,3389,T,I,A",

                                    "1487282477,77.68.9.50,10.1.0.4,65078,3389,T,I,A"

                                ] 

                            } 

                        ] 

                    } 

                ] 

            } 

        } 

    ] 
}
```