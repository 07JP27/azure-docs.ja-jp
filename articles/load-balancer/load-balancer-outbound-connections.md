---
title: Azure の送信接続 | Microsoft Docs
description: この記事では、Azure によって、パブリック インターネット サービスと VM がどのように通信するかを説明します。
services: load-balancer
documentationcenter: na
author: KumudD
manager: jeconnoc
editor: ''
ms.assetid: 5f666f2a-3a63-405a-abcd-b2e34d40e001
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 02/05/2018
ms.author: kumud
ms.openlocfilehash: 32661ad4d647f266273c4c94a5ba177a348c5431
ms.sourcegitcommit: 8aab1aab0135fad24987a311b42a1c25a839e9f3
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/16/2018
---
# <a name="outbound-connections-in-azure"></a>Azure の送信接続

>[!NOTE]
> Load Balancer Standard SKU は現在プレビュー段階です。 プレビュー期間は、一般公開リリースの機能と同じレベルの可用性と信頼性がない場合があります。 詳細については、[Microsoft Azure プレビューのMicrosoft Azure 追加使用条件](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)に関するページをご覧ください。 運用サービスには、一般公開されている [Load Balancer Basic SKU](load-balancer-overview.md) を使用してください。 このプレビューで[可用性ゾーン (プレビュー)](https://aka.ms/availabilityzones) を使用するには、Load Balancer [標準プレビュー](#preview-sign-up)へのサインアップに加え、[別のサインアップ](https://aka.ms/availabilityzones)が必要になります。

Azure では、いくつかの異なるメカニズムを通じて顧客デプロイの送信接続を提供します。 この記事では、どのようなシナリオがあり、それらがいつ適用されるかについて説明するほか、それらのシナリオのしくみと管理方法について説明します。

Azure のデプロイは、パブリック IP アドレス空間で Azure 外部のエンドポイントと通信できます。 インスタンスがパブリック IP アドレス空間の宛先への送信フローを開始すると、Azure によってプライベート IP アドレスがパブリック IP アドレスに動的にマッピングされます。 このマッピングが作成されると、この送信フローの戻りトラフィックも、フローの送信元であるプライベート IP アドレスに到達できます。

Azure は送信元ネットワーク アドレス変換 (SNAT) を使用してこの機能を実行します。 複数のプライベート IP アドレスが単一のパブリック IP アドレスでマスカレードされている場合、Azure では[ポート アドレス変換 (PAT)](#pat) を使用してプライベート IP アドレスがマスカレードされます。 エフェメラル ポートが PAT に使用され、プール サイズに基づいて[事前に割り当て](#preallocatedports)られます。

[送信シナリオ](#scenarios)は複数あります。 必要に応じて、これらのシナリオを組み合わせることができます。 これらを注意深く確認して、実際のデプロイメント モデルとアプリケーション シナリオに適用される際の機能、制約、パターンを把握してください。 また、[これらのシナリオを管理する](#snatexhaust)ためのガイダンスを確認してください。

>[!IMPORTANT] 
>Standard Load Balancer では、発信接続に新しい機能が導入され、動作が変更されています。   たとえば、内部の Standard Load Balancer が存在し、異なる手順を実行する必要がある場合、[シナリオ 3](#defaultsnat) は存在しません。   このドキュメント全体をよく読み、SKU 間の全体的な概念と相違点を理解してください。

## <a name="scenarios"></a>シナリオの概要

Azure には、Azure Resource Manager とクラシックという 2 種類の主なデプロイメント モデルがあります。 [Azure Resource Manager](#arm) を使用している場合、Azure Load Balancer と関連するリソースは明示的に定義されます。 クラシック デプロイでは、ロード バランサーのコンセプトが抽象化され、[クラウド サービス](#classic)のエンドポイントの定義を通じて同様の関数が表されます。 実際のデプロイに適用できる[シナリオ](#scenarios)は、使用するデプロイメント モデルによって決まります。

### <a name="arm"></a>Azure Resource Manager

現在 Azure には、Azure Resource Manager リソースの送信接続を実現するのに 3 つの異なる方法があります。 [クラシック](#classic) デプロイでは、これらのシナリオの一部を使用できます。

| シナリオ | 方法 | [説明] |
| --- | --- | --- |
| [1.インスタンス レベル パブリック IP アドレスを含む VM (ロード バランサーあり、またはなし)](#ilpip) | SNAT (ポート マスカレードは不使用) |インスタンスの NIC の IP 構成に割り当てられたパブリック IP が Azure によって使用されます。 インスタンスには、使用可能なすべてのエフェメラル ポートがあります。 |
| [2.VM に関連付けられたパブリック ロード バランサー (インスタンスにインスタンス レベルのパブリック IP アドレスなし)](#lb) | ロード バランサー フロントエンドを使用したポート マスカレード (PAT) による SNAT |Azure によってパブリック ロード バランサー フロントエンドのパブリック IP アドレスが複数のプライベート IP アドレスと共有されます。 Azure では、フロントエンドのエフェメラル ポートが PAT に使用されます。 |
| [3.スタンドアロン VM (ロード バランサーなし、インスタンス レベルのパブリック IP アドレスなし)](#defaultsnat) | ポート マスカレード (PAT) による SNAT | Azure によって自動的に SNAT 用のパブリック IP アドレスが指定され、このパブリック IP アドレスが可用性セットの複数のプライベート IP アドレスと共有されてから、このパブリック IP アドレスのエフェメラル ポートが使用されます。 これは、上記のシナリオのフォールバック シナリオです。 可視性と制御が必要は場合は推奨されません。 |

VM がパブリック IP アドレス空間で Azure の外部のエンドポイントと通信しないようにする場合、必要に応じてネットワーク セキュリティ グループ (NSG) を使用してアクセスをブロックできます。 NSG の使用の詳細については、「[送信接続の防止](#preventoutbound)」で説明します。 送信アクセスがない仮想ネットワークの設計、実装、および管理のガイダンスについては、この記事の範囲外です。

### <a name="classic"></a>クラシック (クラウド サービス)

クラシック デプロイで使用可能なシナリオは、[Azure Resource Manager](#arm) デプロイと Load Balancer Basic で使用可能なシナリオの一部です。

クラシック仮想マシンには、Azure Resource Manager リソースの説明と同じく 3 つの基本的なシナリオがあります ([1](#ilpip)、[2](#lb)、[3](#defaultsnat))。 クラシック worker ロールのシナリオは 2 つのみです ([2](#lb)、[3](#defaultsnat))。 [軽減策](#snatexhaust)にも同様の違いがあります。

クラシック デプロイで PAT の[エフェメラル ポートの事前割り当て](#ephemeralprots)に使用されるアルゴリズムは、Azure Resource Manager リソース デプロイの場合と同じです。  

### <a name="ilpip"></a>シナリオ 1: インスタンス レベルのパブリック IP アドレスがある VM

このシナリオでは、VM にはインスタンス レベルのパブリック IP (ILPIP) が割り当てられています。 送信接続に関する限り、VM が負荷分散されているかどうかは関係ありません。 このシナリオは他のシナリオよりも優先されます。 ILPIP が使用される場合、すべての送信フローで VM によって ILPIP が使用されます。  

ポート マスカレード (PAT) は使用されず、VM は使用可能なすべてのエフェメラル ポートを備えます。

アプリケーションが多数の送信フローを開始したために SNAT ポート不足が発生した場合は、[SNAT の制約を軽減するために ILPIP](#assignilpip) を割り当てることを検討してください。 その全体像については、[SNAT 不足の管理](#snatexhaust)に関するセクションを確認してください。

### <a name="lb"></a>シナリオ 2: インスタンス レベルのパブリック IP アドレスがない負荷分散 VM

このシナリオでは、VM はパブリック Load Balancer バックエンド プールに含まれます。 VM にパブリック IP アドレスは割り当てられていません。 パブリック IP フロントエンドとバックエンド プール間にリンクを作成するには、ロード バランサー リソースをロード バランサー規則で構成する必要があります。

この規則の構成を完了しないと、[インスタンス レベルのパブリック IP アドレスがないスタンドアロン VM](#defaultsnat) のシナリオで説明される動作になります。 成功するために正常性プローブのバックエンド プールの作業リスナーを規則に含める必要はありません。

負荷分散 VM が送信フローを作成すると、Azure が、送信フローのプライベート ソース IP アドレスをパブリック ロード バランサー フロントエンドのパブリック IP アドレスに変換します。 Azure は、SNAT を使用してこの機能を実行します。 また、Azure は、[PAT](#pat) を使用して、複数のプライベート IP アドレスをパブリック IP アドレスでマスカレードします。 

ロード バランサーのパブリック IP アドレス フロントエンドのエフェメラル ポートを使用して、VM から送信される個々のフローが区別されます。 送信フローが作成されると、[事前に割り当てられたエフェメラル ポート](#preallocatedports)が SNAT によって動的に使用されます。 ここでは、SNAT で使用されるエフェメラル ポートを SNAT ポートと呼びます。

SNAT ポートは、「[SNAT と PAT の理解](#snat)」の説明のとおり事前に割り当てられます。 これは有限のリソースであり、不足する可能性があります。 これらがどのように[消費される](#pat)のかを理解することが重要です。 この消費のための設計と移行を必要に応じて行う方法については、[SNAT 不足の管理](#snatexhaust)に関するセクションを確認してください。

[複数の (パブリック) IP アドレスが Load Balancer Basic に関連付けられている](load-balancer-multivip-overview.md)場合、それらのパブリック IP アドレスはどれも[送信フローの候補](#multivipsnat)になり、その 1 つが選択されます。  

Load Balancer Basic で送信接続の正常性を監視するために、[Load Balancer の Log Analytics](load-balancer-monitor-log.md) と、[SNAT ポート不足メッセージを監視するためのアラート イベント ログ](load-balancer-monitor-log.md#alert-event-log)を使用できます。

### <a name="defaultsnat"></a>シナリオ 3: インスタンス レベルのパブリック IP アドレスがないスタンドアロン VM

このシナリオでは、VM はパブリック Load Balancer プールの一部ではなく (また、内部 Standard Load Balancer プールの一部ではなく)、ILPIP アドレスが割り当てられていません。 VM が送信フローを作成すると、Azure が、送信フローのプライベート ソース IP アドレスをパブリック ソース IP アドレスに変換します。 この送信フローで使用されるパブリック IP アドレスは構成不可能であり、サブスクリプションのパブリック IP リソースの制限に対してカウントされません。

>[!IMPORTANT] 
>このシナリオは、内部 Basic Load Balancer が接続されている場合に__のみ__適用されます。 内部 Standard Load Balancer が VM に接続されている場合、シナリオ 3 は__利用できません__。  内部 Standard Load Balancer を使用することに加え、[シナリオ 1](#ilpip) または[シナリオ 2](#lb) を明示的に作成する必要があります。

Azure は、SNAT とポート マスカレード ([PAT](#pat)) を使用してこの機能を実行します。 このシナリオは、使用される IP アドレスに対するコントロールがない点を除いて、[シナリオ 2](#lb) に類似しています。 これは、シナリオ 1 および 2 がない場合のフォールバック シナリオです。 このシナリオは、送信アドレスに対するコントロールが必要な場合は推奨されません。 発信接続がアプリケーションの重要な部分である場合は、別のシナリオを選ぶ必要があります。

SNAT ポートは、「[SNAT と PAT の理解](#snat)」の説明のとおり事前に割り当てられます。  可用性セットを共有している VM の数によって、適用される事前割り当ての階層が決まります。  事前割り当て (1024 SNAT ポート) を決定する目的の場合、可用性セットのないスタンドアロン VM は、事実上 1 のプールです。 SNAT ポートは有限のリソースであり、不足する可能性があります。 これらがどのように[消費される](#pat)のかを理解することが重要です。 この消費のための設計と移行を必要に応じて行う方法については、[SNAT 不足の管理](#snatexhaust)に関するセクションを確認してください。

### <a name="combinations"></a>組み合わされた複数のシナリオ

これまでのセクションで説明したシナリオを組み合わせることで、特定の結果を実現することができます。 複数のシナリオがある場合、次の優先順位が適用されます。[シナリオ 1](#ilpip) は、[シナリオ 2](#lb) と[シナリオ 3](#defaultsnat) に優先します (Azure Resource Manager のみ)。 [シナリオ 2](#lb) は[シナリオ 3](#defaultsnat) に優先します (Azure Resource Manager およびクラシック)。

たとえば、アプリケーションが限られた数の宛先への送信接続に大きく依存している一方で、ロード バランサー フロントエンド経由で受信フローも受け取っている Azure Resource Manager デプロイがあります。 この場合、シナリオ 1 と 2 を組み合わせて軽減を行えます。 その他のパターンについては、[SNAT 不足の管理](#snatexhaust)に関するセクションを確認してください。

### <a name="multife"></a>送信フローの複数のフロントエンド

#### <a name="load-balancer-basic"></a>Load Balancer Basic

[複数の (パブリック) IP フロントエンド](load-balancer-multivip-overview.md)が送信フローの候補である場合、送信フローに使用される 1 つのフロントエンドが Load Balancer Basic によって選択されます。 この選択は構成することができません。選択アルゴリズムはランダムであると考える必要があります。 「[組み合わされた複数のシナリオ](#combinations)」で説明されているとおり、送信フローに特定の IP アドレスを指定できます。

#### <a name="load-balancer-standard"></a>Load Balancer Standard

[複数の (パブリック) IP フロントエンド](load-balancer-multivip-overview.md)が存在する場合、Load Balancer Standard は発信フローのすべての候補を同時に使用します。 発信接続に対して負荷分散ルールが有効になっている場合、各フロントエンドは使用できる事前割当 SNAT ポートの数を増やします。

新しい負荷分散ルール オプションを使用して、発信接続にフロントエンド IP アドレスが使用されないようにすることができます。

```json    
      "loadBalancingRules": [
        {
          "disableOutboundSnat": false
        }
      ]
```

通常、このオプションの既定は _false_ であり、このルールで、負荷分散ルールのバックエンド プール内の関連する VM の発信 SNAT がプログラムされることを示します。  これを _true_ に変更して、Load Balancer が、この負荷分散ルールのバックエンド プール内の VM の発信接続に、関連するフロントエンド IP アドレスを使用しないようにすることができます。  また、「[組み合わされた複数のシナリオ](#combinations)」で説明されているとおり、送信フローに特定の IP アドレスを指定することもできます。

### <a name="az"></a> 可用性ゾーン

[可用性ゾーンありの Standard Load Balancer](load-balancer-standard-availability-zones.md) を使用する場合、ゾーン冗長フロントエンドでゾーン冗長発信 SNAT 接続を提供できます。また、ゾーン エラーが発生しても SNAT プログラミングは継続されます。  ゾーンのフロントエンドを使用する場合、発信 SNAT 接続の有効期間は属するゾーンと同じです。

## <a name="snat"></a>SNAT と PAT の理解

### <a name="pat"></a>ポート マスカレード SNAT (PAT)

パブリック ロード バランサー リソースが VM インスタンスに関連付けられている場合、各送信接続のソースは書き換えられます。 ソースは、仮想ネットワークのプライベート IP アドレス空間からロード バランサー フロントエンドのパブリック IP アドレスに書き換えられます。 パブリック IP アドレス空間では、フローの 5 タプル (ソース IP アドレス、ソース ポート、IP 転送プロトコル、宛先 IP アドレス、宛先ポート) は一意である必要があります。  

これを実現するために、プライベート ソース IP アドレスの書き換え後にエフェメラル ポート (SNAT ポート) が使用されます。これは複数のフローが単一のパブリック IP アドレスから送信されるためです。 

1 つの SNAT ポートは、1 つの宛先 IP アドレス、ポート、プロトコルへの 1 つのフローで消費されます。 同じ宛先 IP アドレス、ポート、プロトコルへの複数のフローでは、各フローが 1 つの SNAT ポートを消費します。 これにより、同じパブリック IP アドレスから送信されて同じ宛先 IP アドレス、ポート、プロトコルに移動する複数のフローが、一意であることが保証されます。 

別の宛先 IP アドレス、ポート、プロトコルへの複数のフローは、宛先ごとに 1 つの SNAT ポートを共有します。 宛先 IP アドレス、ポート、プロトコルによってフローは一意になります。パブリック IP アドレス空間でフローを区別するための追加のソース ポートは必要ありません。

SNAT ポート リソースがなくなると、既存のフローによって SNAT ポートが解放されない限り、送信フローは失敗します。 Load Balancer はフローが終了すると SNAT ポートを回収します。また、[4 分間のアイドル タイムアウト](#idletimeout)を使用して、アイドル フローからの SNAT ポートを回収します。

SNAT ポート不足を引き起こしやすい状態を軽減するパターンについては、[SNAT の管理](#snatexhaust)に関するセクションを確認してください。

### <a name="preallocatedports"></a>ポート マスカレード SNAT (PAT) 用のエフェメラル ポートの事前割り当て

Azure では、アルゴリズムを使用して、割り当てられる利用可能な SNAT ポートの数が決定されます。これは、ポート マスカレード SNAT ([PAT](#pat)) を使用する際のバックエンド プールのサイズに基づきます。 SNAT ポートは、特定のパブリック IP ソース アドレスについて使用可能なエフェメラル ポートです。

SNAT ポートは Azure によって各 VM の NIC の IP 構成に事前に割り当てられます。 IP 構成がプールに追加されると、バックエンド プール サイズに基づいて SNAT ポートがこの IP 構成に事前割り当てされます。 クラシック worker ロールでは、割り当てはロール インスタンスごとに行われます。 送信フローが作成されると、これらのポートは (事前に割り当てられた上限に達するまで) [PAT](#pat) によって動的に消費されます。そして、フローが終了するか[アイドル タイムアウト](#ideltimeout)が発生すると解放されます。

次の表は、バックエンド プール サイズのレベルに対する SNAT ポートの事前割り当てを示しています。

| プール サイズ (VM インスタンス) | IP 構成あたりの事前に割り当てられる SNAT ポート|
| --- | --- |
| 1-50 | 1,024 |
| 51-100 | 512 |
| 101-200 | 256 |
| 201-400 | 128 |
| 401-800 | 64 |
| 801-1,000 | 32 |

>[!NOTE]
> [複数フロントエンド](load-balancer-multivip-overview.md)で Standard Load Balancer を使用する場合、[フロントエンド IP アドレスごとに、前の表に記載されている使用可能な SNAT ポート数を増やします](#multivipsnat)。 たとえば、2 つの負荷分散ルールを持つ 50 個の VM のバックエンドプールがあり、それぞれ個別のフロントエンド IP アドレスを持っている場合、IP 構成ごとに 2048 (2x 1024) SNAT ポートが使用されます。 詳細については、[複数のフロントエンド](#multife)に関するセクションを参照してください。

利用できる SNAT ポートの数が、そのままフローの数に変換されるわけではないことに注意してください。 複数の一意の送信先に単一の SNAT ポートを再利用できます。 ポートは、フローを一意にするために必要な場合にのみ消費されます。 設計と軽減策のガイダンスについて、[この有限のリソースを管理する方法](#snatexhaust)に関するセクション、および [PAT](#pat) について説明しているセクションを参照してください。

パックエンド プールのサイズを変更すると、確立されたフローの一部に影響が及ぶ可能性があります。 バックエンド プール サイズが増加し、次のレベルに移行すると、1 つ大きいバックエンド プール レベルに移行する間に、事前に割り当てられた SNAT ポートの半分が回収されます。 回収された SNAT ポートに関連付けられているフローはタイムアウトになるので、再確立する必要があります。 新しいフローを試みると、事前に割り当てられたポートが使用可能な限り、フローはすぐに成功します。

バックエンド プールのサイズが減少し、1 つ小さいレベルに移行すると、使用できる SNAT ポートが増えます。 この場合、割り当てられている既存の SNAT ポートと各フローに影響はありません。

## <a name="problemsolving"></a> 問題の解決 

このセクションの内容は、SNAT の枯渇や、Azure の送信接続で発生する可能性のある他のシナリオを軽減するのに役立ちます。

### <a name="snatexhaust"></a> SNAT (PAT) ポート不足の管理
[PAT](#pat) に使用される[エフェメラル ポート](#preallocatedports)は、「[インスタンス レベルのパブリック IP アドレスがないスタンドアロン VM](#defaultsnat)」および「[インスタンス レベルのパブリック IP アドレスがない負荷分散 VM](#lb)」で説明されているように有限のリソースです。

同じ宛先 IP アドレスとポートに対して多数の TCP 送信接続または UDP 送信接続が開始されることがわかっている場合、送信接続エラーが出る場合、または SNAT ポート ([PAT](#pat) によって使用される事前割り当て済みの[エフェメラル ポート](#preallocatedports)) が不足しているとサポートから指摘された場合、いくつかの一般的な軽減策の選択肢があります。 これらのオプションを確認し、使用可能であり、実際のシナリオに最適な選択肢を判断してください。 それらを 1 つまたは複数組み合わせることが状況改善に役立つ場合もあります。

送信接続の動作の理解が難しい場合は、IP スタック統計 (netstat) を使用できます。 また、パケット キャプチャを使用した接続動作を観察することも効果的です。 これらのパケット キャプチャはインスタンスのゲスト OS で実行できます。また、[パケット キャプチャには Network Watcher](../network-watcher/network-watcher-packet-capture-manage-portal.md) も使用できます。

#### <a name="connectionreuse"></a>接続を再利用するようにアプリケーションを変更する 
SNAT に使用される一時ポートの需要は、アプリケーションで接続を再利用することで減らすことができます。 これには、既定で接続が再利用される HTTP/1.1 などのプロトコルが特に有効です。 また、HTTP が転送に使用されるその他のプロトコル (REST など) も活用できます。 

要求ごとに個別にアトミック TCP 接続するよりも、再利用するほうが常に効果的です。 再利用は、TCP トランザクションのパフォーマンス向上と大幅な効率化につながります。

#### <a name="connection pooling"></a>接続プーリングを使用するようにアプリケーションを変更する
アプリケーションでは接続プーリング スキームを利用できます。この場合、接続の固定セットに対して要求が内部的に分散されます (各要求で利用可能な接続が再利用されます)。 このスキームにより、使用される一時ポートの数が制限され、環境の予測可能性が高まります。 さらに、このスキームを使用すると、ある操作の応答で 1 つの接続がブロックされている際に同時に複数の操作を行えるようにして、要求のスループットを向上させることもできます。  

接続プーリングは既に、アプリケーションの開発に使用しているフレームワーク、またはアプリケーションの構成設定の中に存在している可能性があります。 接続プーリングは接続の再利用と組み合わせることができます。 同じ宛先 IP アドレスとポートに対する複数の要求で、固定された予測可能な数のポートを消費します。 これらの要求で、TCP トランザクションを非常に効率的に使用して、待ち時間とリソース使用率を減らすこともできます。 また、UDP フローの数を管理すると不足状態を回避して SNAT ポートの使用率を管理できるので、UDP トランザクションにもメリットがあります。

#### <a name="retry logic"></a>再試行の頻度を抑えるようにアプリケーションのロジックを変更する
[PAT](#pat) に使用される[事前割り当て済みのエフェメラル ポート](#preallocatedports)が不足している場合、またはアプリケーションのエラーが発生している場合、減退やバックオフ ロジックを使わず単純に再試行を繰り返すと、ポート不足が発生したり持続したりします。 エフェメラル ポートの需要は、再試行の頻度を抑えたロジックを使用することで減らすことができます。 

エフェメラル ポートには 4 分間のアイドル タイムアウトが設定されています (調整不可)。 再試行の頻度が高すぎた場合、不足が自動的に解消されることはありません。 そのため、アプリケーションがトランザクションを再試行する方法と頻度を考慮することは、設計において非常に重要です。

#### <a name="assignilpip"></a>インスタンスレベル パブリック IP を個々の VM に割り当てる
ILPIP を割り当てることで、[インスタンスレベル パブリック IP を VM に割り当てる](#ilpip)シナリオに移行します。 この VM で、VM ごとに使用されるパブリック IP のすべてのエフェメラル ポートを使用できます。 (パブリック IP のエフェメラル ポートが、それぞれのバックエンド プールに関連付けられているすべての VM で共有されるシナリオとは対照的です。)パブリック IP アドレスの追加コストや、大量の IP アドレスを個別にホワイトリスト登録することの潜在的な影響など、考慮すべきトレードオフがあります。

>[!NOTE] 
>このオプションは、worker ロールでは使用できません。

#### <a name="multifesnat"></a> 複数のフロントエンドを使用する

パブリック Standard Load Balancer を使用する場合は、[発信接続用に複数のフロントエンド IP アドレス](#multife)を割り当て、[使用可能な SNAT ポートの数を増やします](#preallocatedports)。  フロントエンドのパブリック IP に対して SNAT のプログラミングをトリガーするには、フロントエンド IP の構成、ルール、およびバックエンド プールを作成する必要があります。  このルールが機能する必要はなく、正常性プローブが成功する必要はありません。  受信に複数のフロントエンドを使用する場合は、カスタムの正常性プローブを使用してを信頼性を確保する必要があります。

>[!NOTE]
>ほとんどの場合、SNAT ポートの枯渇は設計に問題があることを示します。  より多くのフロントエンドを使用して SNAT ポートを追加する前に、ポートが枯渇している理由を把握してください。  後で障害につながる可能性のある問題が隠れている可能性があります。

### <a name="idletimeout"></a>キープアライブを使用して送信アイドル タイムアウトをリセットする

送信接続には、4 分間のアイドル タイムアウトが設けられています。 このタイムアウトは調整できません。 ただし、必要に応じて、転送 (TCP キープアライブなど) またはアプリケーション レイヤー キープアライブを使用して、アイドル フローを更新したりこのアイドル タイムアウトをリセットしたりできます。

## <a name="discoveroutbound"></a>VM で使用されるパブリック IP の検出
送信接続のパブリック ソース IP アドレスを判別する方法は多数あります。 OpenDNS によって提供されるサービスで、VM のパブリック IP アドレスを表示できます。 

nslookup コマンドを使用することで、名前 myip.opendns.com に関する DNS クエリを OpenDNS Resolver に送信できます。 このサービスは、クエリの送信に使用されたソース IP アドレスを返します。 VM から次のクエリを実行すると、その VM で使用されるパブリック IP が応答として返されます。

    nslookup myip.opendns.com resolver1.opendns.com

## <a name="preventoutbound"></a>送信接続の防止
場合によっては、VM で送信フローを作成できるのは望ましくない場合があります。 また、送信フローで接続できる宛先や受信フローを開始できる宛先を管理するための要件がある場合もあります。 このような場合は、[ネットワーク セキュリティ グループ](../virtual-network/virtual-networks-nsg.md) を使用すると、VM が接続できる宛先を管理できます。 また、NSG を使用して、受信フローを開始できるパブリックの宛先を管理することもできます。 

負荷分散された VM に NSG を適用するときは、[既定のタグ](../virtual-network/virtual-networks-nsg.md#default-tags)と[既定のルール](../virtual-network/virtual-networks-nsg.md#default-rules)に注意してください。 VM が Azure Load Balancer からのヘルス プローブ要求を受け取ることができるようにしておいてください。 

NSG が AZURE_LOADBALANCER 既定タグからのヘルス プローブ要求をブロックすると、VM のヘルス プローブが失敗して VM が停止しているとマークされます。 ロード バランサーはその VM への新しいフローの送信を停止します。

## <a name="limitations"></a>制限事項
- DisableOutboundSnat は、ポータルで負荷分散ルールを構成するときにオプションとして使用できません。  代わりに、REST、テンプレート、またはクライアント ツールを使用してください。

## <a name="next-steps"></a>次の手順

- [Load Balancer Basic](load-balancer-overview.md) の詳細を確認する。
- [ネットワーク セキュリティ グループ](../virtual-network/virtual-networks-nsg.md)の詳細を確認する。
- Azure のその他の重要な[ネットワーク機能](../networking/networking-overview.md)について参照してください。
