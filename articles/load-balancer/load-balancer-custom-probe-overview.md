<properties 
   pageTitle="ロード バランサー カスタム プローブと正常性状態の監視 | Microsoft Azure"
   description="Azure Load Balancer でカスタム プローブを使用して、ロード バランサーの背後にあるインスタンスを監視する方法を説明します"
   services="load-balancer"
   documentationCenter="na"
   authors="joaoma"
   manager="carmonm"
   editor=""
   tags="azure-resource-manager"
/>
<tags  
   ms.service="load-balancer"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="01/21/2016"
   ms.author="joaoma" />


# ロード バランサー プローブ 

Azure Load Balancer には、プローブを使用してサーバー インスタンスの正常性を監視する機能があります。プローブが応答できない場合は、Azure Load Balancer は異常なインスタンスへの新しい接続の送信を停止します。既存の接続への影響はなく、新しい接続が正常なインスタンスに送信されます。

ロード バランサーの背後にある仮想マシンを使用する場合は、TCP または HTTP カスタム プローブを構成する必要があります。クラウド サービス ロール (Worker ロールと Web ロール) は、ゲスト エージェント プローブの監視を含む唯一のサーバー インスタンスです。
 
## プローブの数とタイムアウトを理解する

プローブの動作は、インスタンスの Up/Down をマークする必要のある成功または失敗プローブの数によって異なります。これは、SuccessFailCount = タイムアウト/頻度によって計算されます。ポータルの場合、タイムアウトは頻度の値の 2 倍に設定されます (タイムアウト = 頻度 * 2)。

エンドポイントに対して負荷分散されたすべてのインスタンス (負荷分散されたセット) のプローブ構成は、同じにする必要があります。つまり、特定のエンドポイントの組み合わせに対してホストされる同じサービス内の各ロール インスタンスまたは仮想マシンに、異なるプローブ構成 (ローカル ポート、タイムアウトなど) を設定することはできません。


>[AZURE.IMPORTANT] ロード バランサー プローブは、IP アドレス 168.63.129.16 を使用します。このパブリック IP アドレスは、IP Virtual Network 持ち込みシナリオの内部プラットフォーム リソースへの通信チャネルを容易にするために使用されます。仮想パブリック IP アドレス 168.63.129.16 は、すべてのリージョンで使用され、変更されることはありません。この IP アドレスはすべてのローカル ファイアウォール ポリシーで使用できるようにすることをお勧めします。内部 Azure プラットフォームのみがそのアドレスからのメッセージをソースにできることを、セキュリティ リスクとして考慮する必要はありません。これを行わない場合、同じ IP アドレス範囲の 168.63.129.16 を構成し、重複している IP アドレスがあるようなさまざまなシナリオで、予期しない動作が発生します。


## プローブの種類

### ゲスト エージェント プローブ

クラウド サービスのみに使用できます。Azure Load Balancer は、仮想マシン内のゲスト エージェントを使用してリッスンし、インスタンスが準備完了状態の場合のみ (ビジー、リサイクル中、停止中などの状態でない場合) HTTP 200 OK 応答を返します。

詳細については、「[正常性プローブのサービス定義ファイル (csdef) を構成する](https://msdn.microsoft.com/library/azure/jj151530.asp)」または「[インターネットに接続するロード バランサー (クラウド サービス用) の作成の開始](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services)」を参照してください。
 
### ゲスト エージェント プローブがインスタンスを異常としてマークする状況

ゲスト エージェントが HTTP 200 OK に応答できない場合、Azure Load Balancer はそのインスタンスを応答不能と見なし、インスタンスへのトラフィックの送信を停止します。Azure Load Balancer は引き続きインスタンスに ping を実行し、ゲスト エージェントが HTTP 200 に応答した場合は、Azure Load Balancer がもう一度そのインスタンスにトラフィックを送信します。

Web ロールを使用する場合、Web サイト コードは通常、Azure ファブリックやゲスト エージェントでは監視されない w3wp.exe で実行されます。そのため、w3wp.exe が失敗 (HTTP 500 応答など) してもゲスト エージェントにレポートされず、ロード バランサーはそのインスタンスがローテーションから除外されたことを認識しません。


### HTTP カスタム プローブ

カスタム HTTP ロード バランサー プローブは、既定のゲスト エージェント プローブを上書きするため、ユーザーは独自のカスタム ロジックを作成してロール インスタンスの正常性を判断できます。ロード バランサーはエンドポイントをプローブし (既定では 15 秒ごと)、タイムアウト期間内 (既定値は 31 秒) にインスタンスが HTTP 200 に応答した場合は、ロード バランサー ローテーション内にあると見なします。これは、ユーザー独自のロジックを実装して、インスタンスをロード バランサーのローテーションから削除する場合に役立ちます (インスタンスが CPU の 90% を超えたら 200 以外の状態を返すなど)。Web ロールの場合は、Web サイト コードが失敗してもロード バランサー プローブに 200 以外の状態が返されるため、w3wp.exe の使用は Web サイトの自動監視を意味します。

>[AZURE.NOTE] HTTP カスタム プローブは、相対パスと HTTP プロトコルのみをサポートします。HTTPS はサポートされていません。


### HTTP カスタム プローブがインスタンスを異常としてマークする状況 

- HTTP アプリケーションが 200 以外の HTTP 応答コードを返します (403 404、500 など)。これは、アプリケーション インスタンスをすぐに使用不能にする肯定応答です。

-  イベントでは、HTTP サーバーはタイムアウト期間後にまったく応答しません。タイムアウト値のセットによって、プローブを Down としてマークする前に、複数のプローブ要求が応答なしに移動される可能性があることに注意してください (SuccessFailCount プローブが送信されます)。
- 	サーバーが TCP リセットによって接続を閉じた場合。

### TCP カスタム プローブ

TCP プローブは、定義済みのポートに 3 ウェイ ハンドシェイクを実行して、接続を開始します。

### TCP カスタム プローブがインスタンスを異常としてマークする状況

- イベントでは、TCP サーバーはタイムアウト期間後にまったく応答しません。これは、プローブがダウンとしてマークされる前に応答なしに移動するように構成された、失敗したプローブ要求の数によって異なります。
- 	ロール インスタンスから TCP リセットを受信します。

HTTP 正常性プローブまたは TCP プローブの構成方法を理解するには、「[リソース マネージャー用のインターネットに接続するロード バランサーの作成の開始](load-balancer-get-started-internet-arm-ps.md#create-lb-rules-nat-rules-a-probe-and-a-load-balancer)」を参照してください。

## ロード バランサーに戻す正常なインスタンスを追加する

次の場合に、TCP と HTTP プローブは正常と見なされ、ロール インスタンスを正常としてマークします。

- 最初の時刻に、VM が起動し、LB が正のプローブを取得します。
- SuccessFailCount の数 (上記参照) は、ロール インスタンスを正常としてマークする必要のある成功のプローブの値を定義しています。ロール インスタンスが削除された場合、成功したプローブの行にあるSuccessFailCount は、ロール インスタンスを UP としてマークする必要があります。

>[AZURE.NOTE] ロール インスタンスの正常性が変動する場合、Azure Load balancer は、ロール インスタンスを正常な状態に戻す前により長く待機します。これは、ユーザーとインフラストラクチャを保護するポリシーによって実行されます。

## ロード バランサーのログ分析

プローブの正常性状態とプローブの数を確認するには、[ロード バランサーのログ分析](load-balancer-monitor-log.md)を使用することができます。ログ記録は、Power BI または Operation Insights と共に使用し、ロード バランサーの正常性状態の統計情報を提供することができます。
 

<!---HONumber=AcomDC_0302_2016-->