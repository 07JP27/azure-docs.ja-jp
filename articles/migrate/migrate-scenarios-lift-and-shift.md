---
title: Azure DMS と Site Recovery を使用してオンプレミスのワークロードを Azure に移行する | Microsoft Docs
description: Azure Database Migration Service と Azure Site Recovery サービスを使用して、オンプレミスのマシンの移行のために Azure を準備する方法について説明します。
services: site-recovery
author: rayne-wiselman
ms.service: site-recovery
ms.topic: conceptual
ms.date: 04/21/2018
ms.author: raynew
ms.openlocfilehash: d6fc1af3c5a587ab62b86dcd4189165d96e6e3bc
ms.sourcegitcommit: e2adef58c03b0a780173df2d988907b5cb809c82
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/28/2018
ms.locfileid: "32182242"
---
# <a name="scenario-2-lift-and-shift-migration-to-azure"></a>シナリオ 2: リフト アンド シフト方式による Azure への移行

Contoso 社は Azure への移行を検討しています。 これを試すため、Contoso は小規模なオンプレミスの旅行アプリを Azure に移行して評価することを望んでいます。 これは 2 層の旅行アプリで、1 つの VM で実行する Web アプリと、別の VM 上の SQL Server データベースで構成されます。 アプリケーションは VMware でデプロイされ、環境は vCenter Server で管理されます。 

[Azure への移行の評価に関するシナリオ 1](migrate-scenarios-assessment.md) では、Data Migration Assistant (DMA) を使ってアプリに対する SQL Server データベースを評価しました。 さらに、Azure Migrate サービスを使ってアプリの VM を評価しました。 このシナリオでは、評価が問題なく完了した後、Azure Database Migration Service (DMS) を使ってデータベースを Azure SQL マネージド インスタンスに移行し、Azure Site Recovery サービスを使ってオンプレミスのマシンを Azure VM に移行します。

[シナリオ 1](migrate-scenarios-assessment.md) を試してから、この説明用の旅行アプリを使ってこのシナリオを試したい場合は、[GitHub](https://github.com/Microsoft/SmartHotel360) からダウンロードできます。



**サービス** | **説明** | **コスト**
--- | --- | ---
[Database Migration Service](https://docs.microsoft.com/azure/dms/dms-overview) | DMS を使うと、複数のデータベース ソースから Azure データ プラットフォームに、最小限のダウンタイムでシームレスに移行できます。 | サービスは現在パブリック プレビューであり (2018 年 4 月)、プレビュー期間中は無料で使用できます。<br/><br/> パブリック プレビューの DMS は、[少数のリージョン](https://docs.microsoft.com/azure/dms/dms-overview)に制限されることに注意してください。
[Azure SQL マネージド インスタンス](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance) | マネージド インスタンスは、Azure クラウド内の完全に管理された SQL Server インスタンスを表すマネージド データベース サービスです。 最新バージョンの SQL Server データベース エンジンと同じコードを共有し、最新の機能、パフォーマンスの向上、およびセキュリティ更新プログラムが適用されています。 | Azure SQL Database Managed Instance を使うと、容量に基づく料金がかかります。 [詳細情報](https://azure.microsoft.com/pricing/details/sql-database/managed/)。 
[Azure Site Recovery](https://docs.microsoft.com/azure/site-recovery/) | このサービスは、Azure VM、オンプレミス VM、物理サーバーの移行とディザスター リカバリーを調整および管理します。  | Azure へのレプリケーションの間に、Azure Storage の料金が発生します。  フェールオーバーが発生すると、Azure VM が作成されて料金がかかります。 料金と価格について[詳しくはこちら](https://azure.microsoft.com/pricing/details/site-recovery/)をご覧ください。

このシナリオでは、DMS がオンプレミスのデータベースに接続し、Azure に Azure SQL マネージド インスタンスを作成して、データベースを移行できるように、サイト間 VPN を設定します。 Site Recovery については、オンプレミスの VMware 環境を準備して、レプリケーションを設定して、VM を Azure に移行します。  


> [!IMPORTANT]
> SQL マネージド インスタンスの限定パブリック プレビューに登録する必要があります。 [サインアップ](https://portal.azure.com#create/Microsoft.SQLManagedInstance)するには、Azure サブスクリプションが必要です。 サインアップが完了するには数日かかることがあるので、このシナリオの展開を始める前に行っておいてください。

## <a name="architecture"></a>アーキテクチャ

### <a name="site-recovery"></a>Site Recovery

![Site Recovery](media/migrate-scenarios-lift-and-shift/asr-architecture.png)  

### <a name="dms"></a>DMS
![DMS](media/migrate-scenarios-lift-and-shift/dms-architecture.png)  

このシナリオでは:

- Contoso は一般的なエンタープライズ組織を表す架空の名前です。 Contoso は、2 階層のオンプレミス旅行アプリを評価し、移行したいと考えています。
- Contoso にはオンプレミスのデータセンター (contoso-datacenter) があり、そこにオンプレミスのドメイン コントローラー (**contosodc1**) が含まれています。
- 社内の旅行アプリは、2 つの VM (WEBVM と SQLVM) に階層化されており、VMware ESXi ホスト (**contosohost1.contoso.com**) 上に配置されています。
- VMware 環境は、VM で実行中の vCenter Server (**vcenter.contoso.com**) によって管理されます。

## <a name="prerequisites"></a>前提条件

このシナリオを実行する場合は、次のものが必要です。

必要条件 | 詳細
--- | ---
**Azure サブスクリプション** | Azure サブスクリプションをお持ちでない場合は、[無料アカウント](https://azure.microsoft.com/pricing/free-trial/)を作成してください。<br/><br/> 無料アカウントを作成する場合、サブスクリプションの管理者としてすべてのアクションを実行できます。<br/><br/> 既存のサブスクリプションを使用しており、管理者でない場合は、管理者に依頼して所有者アクセス許可または共同作成者アクセス許可を割り当ててもらう必要があります。<br/><br/> さらに詳細なアクセス許可が必要な場合は、[こちらの記事](../site-recovery/site-recovery-role-based-linked-access-control.md)をご覧ください。 
**Site Recovery (オンプレミス)** | バージョン 5.5、6.0、または 6.5 を実行しているオンプレミスの vCenter サーバー<br/><br/> バージョン 5.5、6.0、または 6.5 を実行している ESXi ホスト<br/><br/> ESXi ホスト上で実行している 1 つ以上の VMware VM。<br/><br/> VM は [Azure の要件](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#azure-vm-requirements)を満たす必要があります。<br/><br/> サポートされている[ネットワーク](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#network)および[ストレージ](https://docs.microsoft.com/azure/site-recovery/vmware-physical-azure-support-matrix#storage)の構成。
**DMS** | DMS では、[互換性のあるオンプレミスの VPN デバイス](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-devices)が必要です。<br/><br/> オンプレミスの VPN デバイスを構成できる必要があります。 外部接続用のパブリック IPv4 アドレスを持っている必要があり、アドレスが NAT デバイスの内側に存在することはできません。<br/><br/> オンプレミスの SQL Server データベースにアクセスできることを確認します。<br/><br/> Windows ファイアウォールは、移行元のデータベース エンジンにアクセスできる必要があります。 [詳細情報](https://docs.microsoft.com/sql/database-engine/configure-windows/configure-a-windows-firewall-for-database-engine-access)。<br/><br/> データベース マシンの前面にファイアウォールがある場合は、SMB ポート 445 経由でのデータベースおよびファイルへのアクセスを許可する規則を追加します。<br/><br/> 移行元の SQL Server および移行先のマネージド インスタンスへの接続に使用する資格情報は、sysadmin サーバー ロールのメンバーである必要があります。<br/><br/> DMS が移行元データベースのバックアップに使用できるネットワーク共有がオンプレミスのデータベースに存在する必要があります。<br/><br/> 移行元の SQL Server インスタンスを実行しているサービス アカウントに、ネットワーク共有に対する書き込み権限があることを確認します。<br/><br/> ネットワーク共有に対するフル コントロール権限を持つ Windows ユーザー (とパスワード) をメモしておきます。 Azure Database Migration Service は、これらのユーザーの資格情報を偽装して、Azure ストレージ コンテナーにバックアップ ファイルをアップロードします。<br/><br/> SQL Server Express のインストール プロセスでは、TCP/IP プロトコルが既定で**無効化**されます。 これが有効になっていることを確認します。


# <a name="scenario-overview"></a>シナリオの概要

これから実行する内容を次に示します。

> [!div class="checklist"]
> * **ステップ 1: サイト間 VPN 接続を設定する**: DMS はサイト間 VPN 接続を介して、オンプレミスのデータベースに接続します。 VPN 接続用の仮想ネットワークを作成し、後で Site Recovery にこのネットワークを再利用します。 作成するネットワークは、Recovery Services コンテナーと同じリージョンに存在する必要があります。
> * **ステップ 2: SQL Azure マネージド インスタンスを設定する**: オンプレミスの SQL Server データベースの移行先になるマネージド インスタンスを事前に作成しておく必要があります。
> * **ステップ 3: DMS の SA URI を設定する**: ストレージ オブジェクトに制限されたアクセス許可を付与できるように、Shared Access Signature (SAS) の Uniform Resource Identifier (URI) によってストレージ アカウント内のリソースへの委任アクセスが提供されます。 サービスが SQL Server のバックアップ ファイルをアップロードするストレージ アカウント コンテナーに DMS がアクセスできるように、SAS URI を設定します。
> * **ステップ 4: DMS を準備する**: データベース移行プロバイダーを登録し、インスタンスを作成してから、DMS プロジェクトを作成します。
> * **ステップ 5: Site Recovery 用に Azure を準備する**: レプリケートされたデータを保持する Azure ストレージ アカウントを作成します。
> * **ステップ 6: Site Recovery 用にオンプレミスの VMware を準備する**: VM の検出とエージェントのインストール用にアカウントを準備し、フェールオーバー後に Azure VM に接続するための準備をします。 
> * **ステップ 7: VM を複製する**: Site Recovery の移行元環境と移行先環境を構成、レプリケーション ポリシーを設定して、Azure Storage への VM のレプリケーションを開始します。
> * **ステップ 8: DMS を使用してデータベースを移行する**: データベースの移行を実行します。
> * **ステップ 9: Site Recovery で VM を移行する**: フェールオーバーを実行して VM を Azure に移行します。


## <a name="step-1-set-up-site-to-site-vpn-connection"></a>ステップ 1: サイト間 VPN 接続を設定する

VPN のサイト間接続を準備するには、仮想ネットワークとサブネットを設定し、仮想ネットワーク用の VPN ゲートウェイを作成して、オンプレミスの VPN への接続方法が Azure にわかるようにローカル ネットワーク ゲートウェイを設定します。 その後、サイト間接続を作成して確認します。

### <a name="set-up-a-virtual-network"></a>仮想ネットワークを設定する

Azure 仮想ネットワークを作成して、オンプレミスの SQL Server に対するサイト間接続を DMS に提供します。


1. [Azure portal](https://portal.azure.com) で、**[リソースの作成]** をクリックします。 **[ネットワーク]** > **[仮想ネットワーク]** を選びます。
2. **[仮想ネットワーク]** > **[デプロイ モデルの選択]** で、**[Resource Manager]** > **[作成]** の順に選びます
3. **[仮想ネットワークの作成]** > **[名前]** に、ネットワークの一意名を入力します。 このシナリオでは、「**ContosoVNET**」と入力します。
4. **[アドレス空間]** で、IP アドレスの範囲を追加します。 この範囲は、オンプレミスのアドレス空間と重複していてはなりません。
5. **[リソース グループ]** で、新しいグループを作成するか、既存のグループを選びます。 このシナリオでは、**ContosoRG** を使います。
6. **[場所]** で、仮想ネットワークを作成するリージョンを選びます。 ここでは、**[米国東部 2]** を使います。
7. **[サブネット]** で、最初のサブネットの名前とアドレス範囲を追加します。 ここでは、**Apps** サブネットを作成します。
8. サービス エンドポイントを無効にします。

    ![仮想ネットワークの作成](media/migrate-scenarios-lift-and-shift/vnet-create-network.png)

9. 後でネットワークが簡単に見つかるように **[ダッシュボードにピン留めする]** を選び、**[作成]** をクリックします。
10. 仮想ネットワークの作成には数秒かかります。 作成が完了した後、Azure portal ダッシュボードで確認します。
11. 仮想ネットワークで 443、53、9354、445、12000 の各通信ポートが許可されていることを確認します。


### <a name="set-up-subnets"></a>サブネットを設定する

ここでは、Azure ネットワークに 4 つのサブネットを作成します。

![サブネットの一覧](media/migrate-scenarios-lift-and-shift/vnet-subnet-list.png)

ネットワークを作成するときに、最初のサブネット (Apps) を設定しました。 次に、残りのサブネットを作成します。 ゲートウェイ サブネットは、Azure が VPN 接続経由でオンプレミスのサイトにトラフィックを送信するために、VPN ゲートウェイ接続によって使われます。

1. 仮想ネットワークの **[設定]** で、**[サブネット]** > **[+ サブネット]** をクリックします。
2. 次のアドレス範囲を指定してサブネット **Datamigration** を設定し、**[OK]** をクリックします。

    ![データ サブネット](media/migrate-scenarios-lift-and-shift/vnet-subnet-data.png)  


3. **[+ サブネット]** で、次のアドレス範囲を指定してサブネット **Identity** を設定して、**[OK]** をクリックします。
    ![Identity サブネット](media/migrate-scenarios-lift-and-shift/vnet-subnet-identity.png)

4. **[サブネット]** で **GatewaySubnet** をクリックし、**[OK]** をクリックします。
    - このサブネットには、VPN ゲートウェイが VPN 接続に使う IP アドレスが含まれています。
    - Azure が認識できるように、このサブネットの名前は自動的に設定されます。
    - オンプレミスのサブネットと一致するように、自動的に設定されるアドレス範囲を調整します。 

    ![ゲートウェイ サブネット](media/migrate-scenarios-lift-and-shift/vnet-subnet-gateway.png)
    
### <a name="set-up-a-virtual-network-gateway"></a>仮想ネットワーク ゲートウェイを設定する

1. ポータル ページの左側の **+** をクリックし、検索ボックスに「Virtual Network ゲートウェイ」と入力します。 **[結果]** で **[仮想ネットワーク ゲートウェイ]** をクリックします。
2. [仮想ネットワーク ゲートウェイ] ページの下部にある **[作成]** をクリックします。
3. **[仮想ネットワーク ゲートウェイの作成]** >  **[名前]** で、ゲートウェイ オブジェクトの名前を指定します。
4. **[ゲートウェイの種類]** で、**[VPN]** を選びます。
5. **[VPN の種類]** で **[ルート ベース]** を選びます。
6. **[SKU]** で、ゲートウェイの SKU をドロップダウンから選びます。 ドロップダウン リストに表示される SKU は、選択した VPN の種類によって異なります。 アクティブ/アクティブ モードを有効にしないでください。 SKU に関する[詳細](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-about-vpn-gateway-settings#gwsku)。
7. **[仮想ネットワーク]** > **[仮想ネットワークの選択]** で、作成したネットワークを追加します。 ゲートウェイがこのネットワークに追加されます。
8. **[最初の IP 構成]** で、パブリック IP アドレスを指定します。  VPN ゲートウェイには、パブリック IP アドレスが必要です。 このアドレスは、VPN ゲートウェイの作成時にリソースに対して動的に割り当てられます。 現在サポートされているのは動的アドレスのみですが、割り当てられた IP アドレスを変更することはできません。
    - **[ゲートウェイ IP 構成の作成]** をクリックします。 **[パブリック IP アドレスの選択]** で、**[+ 新規作成]** をクリックします。
    - **[パブリック IP アドレスの作成]** で、パブリック IP アドレスの名前を指定します (Contoso-Gateway)。 SKU は **[Basic]** のままにし、**[OK]** をクリックして変更を保存します。
        
    ![仮想ネットワーク ゲートウェイ](media/migrate-scenarios-lift-and-shift/vnet-create-vpn-gateway2.png) 

9. **[作成]** をクリックして、VPN ゲートウェイの作成を開始します。 設定が検証され、ダッシュボードに "Deploying Virtual network gateway" (仮想ネットワーク ゲートウェイを展開しています) と表示されます。

    ![仮想ネットワーク ゲートウェイを検証する](media/migrate-scenarios-lift-and-shift/vnet-vpn-gateway-validate.png)
    
ゲートウェイの作成には、最大で 45 分かかる場合があります。 完了状態を確認するために、ポータル ページの更新が必要な場合があります。

### <a name="set-up-a-local-network-gateway"></a>ローカル ネットワーク ゲートウェイを設定する

オンプレミスのサイトを表すローカル ネットワーク ゲートウェイを Azure 内に設定します。

1. ポータルで **+ [リソースの作成]** をクリックします。
2. 検索ボックスに「**ローカル ネットワーク ゲートウェイ**」と入力し、**Enter** キーを押して検索します。 結果で **[ローカル ネットワーク ゲートウェイ]** > **[作成]** をクリックします。
3. **[ローカル ネットワーク ゲートウェイの作成]** > **[名前]** で、ローカル ネットワーク ゲートウェイ オブジェクトに対して Azure が使う名前を指定します。
4. **[IP アドレス]** で、Azure が接続するオンプレミスの VPN デバイスのパブリック IP アドレスを指定します。 IP アドレスはネットワーク アドレス変換されてはならず、Azure が到達できる必要があります。
5. **[アドレス空間]** に、VPN ゲートウェイを介してオンプレミスのデバイスにルーティングされるローカル ネットワーク アドレス範囲を入力します。 Azure 仮想ネットワークの範囲と重複しないことを確認してください。
6. **[BGP 設定の構成]** はこのシナリオには関係ありません。
7. **[サブスクリプション]** で、サブスクリプションが正しいことを確認します。
8. **[リソース グループ]** で、ネットワークの作成に使ったリソース グループ (ContosoRG) を選びます。
9. **[場所]** で、仮想ネットワークを作成したリージョンを選びます。

    ![ローカル ゲートウェイ](media/migrate-scenarios-lift-and-shift/vnet-create-local-gateway.png)

4. **[作成]** をクリックして、ローカル ゲートウェイを作成します。

### <a name="configure-your-on-premises-vpn-device"></a>オンプレミスの VPN デバイスを構成する

オンプレミスの VPN デバイスでは次のものを構成する必要があります。

- 作成した Azure 仮想ネットワーク ゲートウェイのパブリック IPv4 アドレス。
- 事前共有キー (VPN サイト間接続を作成するときに使ったキー)。  

オンプレミスの VPN デバイスを設定するときは、以下を参考にしてください。

- 使っているオンプレミスの VPN デバイスによっては、VPN デバイス構成スクリプトをダウンロードできる場合があります。 [詳細情報](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-download-vpndevicescript)。
- [役に立つ詳しいリソース](https://docs.microsoft.com/azure/vpn-gateway/vpn-gateway-howto-site-to-site-resource-manager-portal#VPNDevice)をご覧ください。

### <a name="create-the-vpn-connection"></a>VPN 接続を作成する

次に、仮想ネットワーク ゲートウェイとオンプレミスの VPN デバイスとの間にサイト間 VPN 接続を作成します。

1. **[仮想ネットワーク]** > **[概要]** > **[接続されているデバイス]** で、仮想ネットワークのページを開きます。 
2. **[接続]** > **[+ 追加]** をクリックします。
3. **[接続の追加]** > **[名前]** で、接続の名前を指定します。
4. **[接続の種類]** で、**[サイト対サイト (IPSec)]** を選びます。
5. **[仮想ネットワーク ゲートウェイ]** の値は、このゲートウェイから接続するため固定です。
6. **[ローカル ネットワーク ゲートウェイ]** で、作成したローカル ネットワーク ゲートウェイを指定します。
7. **[共有キー]** で、ローカルのオンプレミス VPN デバイスに使っている値と一致するキーを指定します。 この例では "abc123" を使用していますが、より複雑な値を使用することもできます (推奨)。 重要なのは、ここで指定する値は、VPN デバイスを構成する際に指定した値と同じにする必要があることです。
8. **[サブスクリプション]**、**[リソース グループ]**、**[場所]** の値は固定されています。

    ![VPN 接続](media/migrate-scenarios-lift-and-shift/vpn-connection.png) 

4. **[OK]** をクリックして、接続を作成します。 画面に "接続を作成しています" というメッセージが点滅表示されます。
5. 接続が作成された後、仮想ネットワーク ゲートウェイの **[接続]** ページで接続を確認します。 状態は、[不明] > [接続中] > [成功] の順に変わります。

### <a name="verify-the-vpn-connection"></a>VPN 接続の確認

Azure Portal で目的の接続に移動することで、Resource Manager VPN ゲートウェイの接続の状態を確認できます。 

1. **[すべてのリソース]** をクリックし、仮想ネットワーク ゲートウェイに移動します。
2. 仮想ネットワーク ゲートウェイのページで、**[接続]** をクリックします。 各接続の状態が確認できます。
3. 接続の名前をクリックし、**[要点]** で詳しい情報を確認します。 接続に成功していると、状態が "成功" と "接続済み" になります。

VPN 経由で SQL Server VM に接続できることを確認します。 リモート デスクトップ接続を使用し、VM の IP アドレスに接続します。



## <a name="step-2-prepare-an-azure-sql-managed-instance"></a>ステップ 2: Azure SQL マネージド インスタンスを準備する

### <a name="set-up-a-virtual-network"></a>仮想ネットワークを設定する

このシナリオでは、Azure SQL マネージド インスタンスに専用の別の仮想ネットワークを作成する必要があります。  以下の要件に注意してください。

- マネージド インスタンスを作成するには、専用のサブネットが必要です。
- サブネットは空で他のクラウド サービスを含んでいない必要があり、ゲートウェイ サブネットであってはなりません。 マネージド インスタンスを作成した後は、サブネットにリソースを追加することはできません。
- サブネットに NSG が関連付けられていてはなりません。
- サブネットには、割り当てられている唯一のルートとして次ホップ インターネットが 0.0.0.0/0 のユーザー ルート テーブル (UDR) が必要です。 
- 省略可能なカスタム DNS: カスタム DNS が VNet で指定されている場合、Azure の再帰的なリゾルバーの IP アドレス (168.63.129.16 など) をリストに追加する必要があります。 [詳細情報](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-custom-dns)。
- サブネットにサービス エンドポイント (ストレージまたは SQL) を関連付けることはできません。 仮想ネットワークではサービス エンドポイントを無効にする必要があります。
- サブネットには 16 個以上の IP アドレスが必要です。 マネージド インスタンス サブネットのサイズ指定についての[詳細](https://docs.microsoft.com/azure/sql-database/sql-database-managed-instance-vnet-configuration#determine-the-size-of-subnet-for-managed-instances)。

仮想ネットワークを次のように設定します。

1.  Azure Portal で、**[リソースの作成]** をクリックします。 
2. **[ネットワーク]** > **[仮想ネットワーク]** を選びます。
3. **[仮想ネットワーク]** > **[デプロイ モデルの選択]** で、**[Resource Manager]** > **[作成]** の順に選びます。
4. **[仮想ネットワークの作成]** > **[名前]** に、ネットワークの一意名を入力します。 このシナリオでは、**ContosoVNETSQLMI** を使います。
5. **[アドレス空間]** で、IP アドレス範囲を次のように追加します。 この範囲は、オンプレミスおよび ContosoVNET のアドレス空間と重複していてはなりません。
6. **[リソース グループ]** で、新しいグループを作成するか、既存のグループを選びます。 このシナリオでは、**ContosoRG** を使います。
7. **[場所]** で、仮想ネットワークを作成するリージョンを選びます。 ここでは、**[米国東部 2]** を使います。
8. **[サブネット]** で、最初のサブネットの名前とアドレス範囲を追加します。 **ManagedInstances** サブネットを作成しました。
9. サービス エンドポイントを無効にします。

    ![マネージド インスタンスのネットワーク](media/migrate-scenarios-lift-and-shift/network-mi.png)

10. ネットワークを展開した後は、DNS の設定を変更する必要があります。 このシナリオでは、DNS は最初に静的プライベート IP アドレス (172.16.3.4) を使用して Identity サブネット内のドメイン コントローラーを示した後、Azure DNS リゾルバー 168.63.129.16 を示します。

    ![マネージド インスタンスのネットワーク](media/migrate-scenarios-lift-and-shift/network-mi2.png)


### <a name="set-up-routing"></a>ルーティングを設定する

1. Azure Portal の左上隅にある **[リソースの作成]** をクリックします。 **[ルート テーブル]** >  **ページで [作成]** をクリックします。
2. **[ルート テーブルの作成]** > **[名前]** で、テーブルの名前を指定します。
3. サブスクリプション、リソース グループ、場所を選択します。 BGP は無効のままにして、**[作成]** をクリックします。
    ![ルート テーブル](media/migrate-scenarios-lift-and-shift/route-table.png)

4. ルート テーブルが作成された後、それを開いて、**[ルート]** > **[+ 追加]** をクリックします。
5. **[ルートの追加]** > **[名前]** で、ルート名を指定します。
6. **[アドレス プレフィックス]** で、0.0.0.0/0 を指定します。
7. **[次ホップの種類]** で、**[インターネット]** を選びます。 次に、 **[OK]** をクリックします

     ![ルート テーブル](media/migrate-scenarios-lift-and-shift/route-table2.png)


### <a name="apply-the-route-to-the-managed-instance-subnet"></a>マネージド インスタンスのサブネットにルートを適用する

1. 作成した仮想ネットワークを開きます。 **[サブネット]** をクリックし、サブネットの名前をクリックします。
2. **[ルート テーブル]** をクリックし、テーブルの名前をクリックします。 その後、 **[保存]** をクリックします。

     ![ルート テーブル](media/migrate-scenarios-lift-and-shift/route-table3.png)

### <a name="create-a-managed-instance"></a>マネージド インスタンスを作成する

1. **[リソースの作成]** をクリックし、**[マネージ インスタンス]** を探して、**[Azure SQL Database Managed Instance (preview)]\(Azure SQL Database マネージ インスタンス (プレビュー)\)** を選択します。
2. **Create** をクリックしてください。
3. **[SQL マネージ インスタンス]** で、サブスクリプションを選択し、**[プレビューの使用条件]** が **[同意済み]** と表示されることを確認します。
4. **[マネージ インスタンス名]** で、名前を指定します。 
5. インスタンスの管理者のユーザー名とパスワードを指定します。
6. インスタンスのリソース グループ、場所、仮想ネットワークを選択します。
7. **[価格レベル]** をクリックして、計算とストレージのサイズを指定します。 既定では、インスタンスは 32 GB の記憶域スペースを無料で取得します (2018 年 4 月)。
8. ストレージおよび仮想コアの数を指定します。
9. **[適用]** をクリックして設定を保存し、**[作成]** をクリックしてマネージド インスタンスを展開します。 展開の状態を見るには、**[通知]** をクリックして、**[デプロイは進行中です]** をクリックします。

    ![マネージ インスタンス](media/migrate-scenarios-lift-and-shift/mi-1.png)

マネージド インスタンスの展開が完了した後、ContosoRG リソース グループに 2 つの新しいリソース、マネージド インスタンスの仮想クラスターと SQL マネージド インスタンスが表示されます。 どちらも場所は米国東部 2 です。

![マネージ インスタンス](media/migrate-scenarios-lift-and-shift/managed-instance2.png)


## <a name="step-3-get-a-sas-uri-for-dms"></a>ステップ 3: DMS の SAS URI を取得する

DMS がストレージ アカウント コンテナーにアクセスして、Azure SQL Database Managed Instance にデータベースを移行するために使用されるバックアップ ファイルをアップロードできるように、SAS URI を取得します。 

1. ストレージ エクスプローラー (プレビュー) を起動します。
2. 左側のウィンドウで、SAS を取得する BLOB コンテナーが含まれているストレージ アカウントを展開します。 ストレージ アカウントの **[BLOB コンテナー]** を展開します。
3. コンテナーを右クリックして、**[Get Shared Access Signature]\(Shared Access Signature の取得\)** を選択します。

     ![SAS](media/migrate-scenarios-lift-and-shift/sas-1.png)

4. **[Shared Access Signature]** で、リソースのポリシー、開始日と有効期限日、タイム ゾーン、アクセス レベルを指定します。 **[Create]** をクリックします。

    ![SAS](media/migrate-scenarios-lift-and-shift/sas-2.png)

5. 2 番目のダイアログに、BLOB コンテナーと共に、ストレージ リソースへのアクセスに使用できる URL とクエリ文字列が表示されます。 **[コピー]** を選んで値をコピーします。 値を安全な場所に保持します。 DMS を設定するときに必要です。

      ![SAS](media/migrate-scenarios-lift-and-shift/sas-3.png)  

## <a name="step-4-prepare-dms"></a>ステップ 4: DMS を準備する

データベースの移行プロバイダーを登録し、インスタンスを作成します。

### <a name="register-the-microsoftdatamigration-resource-provider"></a>Microsoft.DataMigration リソース プロバイダーを登録する

1. サブスクリプションで、**[リソース プロバイダー]** を選びます。 
2. "migration" を検索し、Microsoft.DataMigration の右側にある **[登録]** を選びます。 


### <a name="create-an-instance"></a>インスタンスを作成する

1. **[+ リソースの作成]** を選び、"Azure Database Migration Service" を検索して、ドロップダウン リストから **[Azure Database Migration Service]** を選びます。
2. Azure Database Migration Service (プレビュー) の画面で、**[作成]** を選びます。
3. サービスの名前、サブスクリプション、リソース グループ、仮想ネットワーク、および価格レベルを指定します。
4. **[作成]** を選択して、サービスを作成します。

    ![DMS](media/migrate-scenarios-lift-and-shift/dms-instance.png)  




## <a name="step-5-prepare-azure-for-the-site-recovery-service"></a>ステップ 5: Site Recovery サービス用に Azure を準備する

### <a name="set-up-a-virtual-network"></a>仮想ネットワークを設定する

フェールオーバー後に作成された Azure VM が配置される Azure ネットワークと、レプリケートされたデータが格納される Azure ストレージ アカウントが必要です。

- このシナリオでは、前に DMS 用に作成した Azure ネットワークを使います。
- 使用するネットワークは、Site Recovery コンテナーと同じリージョン内に存在する必要があることに注意してください。


### <a name="create-an-azure-storage-account"></a>Azure のストレージ アカウントの作成

Site Recovery は、VM のデータを Azure Storage にレプリケートします。 オンプレミスから Azure にフェールオーバーするとき、ストレージから Azure VM が作成されます。

1. [Azure Portal](https://portal.azure.com) のメニューで、**[新規]** > **[ストレージ]** > **[ストレージ アカウント]** を選択します。
2. **[ストレージ アカウントの作成]** で、アカウントの名前を入力します。 この一連のチュートリアルでは、**contosovmsacct1910171607** という名前を使用します。 名前は Azure 内で一意にする必要があります。長さは 3 から 24 文字で、使用できるのは数字と小文字のみです。
3. **[デプロイ モデル]** で、**[Resource Manager]** を選択します。
4. **[アカウントの種類]** で **[汎用]** を選択します。 **[パフォーマンス]** で **[Standard]** を選択します。 Blob ストレージを選択しないでください。
5. **[レプリケーション]** では、ストレージの冗長性のために、既定の **[読み取りアクセス geo 冗長ストレージ]** を選択します。
6. **[サブスクリプション]** で、新しいストレージ アカウントを作成するサブスクリプションを選択します。
7. **[リソース グループ]** で、新しいリソース グループ名を入力します。 Azure リソース グループとは、Azure リソースのデプロイと管理に使用する論理コンテナーです。 この一連のチュートリアルでは、**ContosoRG** という名前を使用します。
8. **[場所]** で、ストレージ アカウントの地理的な場所を選択します。 ストレージ アカウントは、Recovery Services コンテナーと同じリージョンに存在する必要があります。 このシナリオでは、**米国東部 2** リージョンを使います。

   ![ストレージ アカウントの作成](media/migrate-scenarios-lift-and-shift/create-storageacct.png)

9. **[作成]** をクリックしてストレージ アカウントを作成します。

### <a name="create-a-recovery-services-vault"></a>Recovery Services コンテナーを作成する

1. Azure Portal で、**[リソースの作成]** > **[監視 + 管理]** > **[Backup and Site Recovery]\(Backup と Site Recovery\)** の順に選択します。
2. **[名前]** ボックスに、コンテナーを識別する表示名を入力します。 このチュートリアルでは **ContosoVMVault** を使用します。
3. **[リソース グループ]** で、**contosoRG** という名前の既存のリソース グループを選択します。
4. **[場所]** に、Azure リージョン **[米国東部 2]** を入力します。
5. ダッシュボードから資格情報コンテナーにすばやくアクセスするには、**[ダッシュボードにピン留めする]** > **[作成]** の順に選択します。
新しい資格情報コンテナーは、**[ダッシュボード]** > **[すべてのリソース]** と、メインの **[Recovery Services コンテナー]** ページに表示されます。

## <a name="step-6-prepare-on-premises-vmware-for-site-recovery"></a>ステップ 6: Site Recovery 用にオンプレミスの VMware を準備する

Site Recovery 用にオンプレミスの VMware を準備するには、次のことを行う必要があります。

- VM の検出を自動化するために、vCenter サーバーまたは vSphere ESXi ホストのアカウントを準備する
- モビリティ サービスを VMware VM に自動インストールするためのアカウントを準備する
- フェールオーバー後に Azure VM に接続する場合は、オンプレミスの VM を準備する


### <a name="prepare-an-account-for-automatic-discovery"></a>自動検出用のアカウントを準備する

Site Recovery では、次のことを実行するために、VMware サーバーへのアクセスが必要です。

- VM を自動的に検出します。 少なくとも読み取り専用のアカウントが必要です。
- レプリケーション、フェールオーバー、およびフェールバックを調整します。 ディスクを作成および削除する、VM の電源をオンにするなどの操作を実行できるアカウントが必要です。

次の手順に従って、このアカウントを作成します。

1. 専用のアカウントを使用するには、vCenter レベルでロールを作成します。 ロールに **Azure_Site_Recovery** のような名前を付けます。
2. 次の表にまとめられているアクセス許可をそのロールに割り当てます。
3. vCenter サーバーまたは vSphere ホストにユーザーを作成します。 ユーザーにロールを割り当てます。

**タスク** | **ロールとアクセス許可** | **詳細**
--- | --- | ---
**VM 検出** | 読み取り専用以上の権限を持つユーザー<br/><br/> データ センター オブジェクト -> 子オブジェクトへのプロパゲート、ロール=読み取り専用 | ユーザーはデータセンター レベルで割り当てられ、データセンター内のすべてのオブジェクトに対してアクセス権を持ちます。<br/><br/> アクセスを制限するには、**子オブジェクトへの伝達**特権を持つ**アクセスなし**ロールを子オブジェクト (vSphere ホスト、データストア、VM、ネットワーク) に割り当てます。
**完全なレプリケーション、フェールオーバー、フェールバック** |  必要なアクセス許可を備えたロール (Azure_Site_Recovery) を作成し、このロールを VMware のユーザーまたはグループに割り当てる<br/><br/> データ センター オブジェクト –> 子オブジェクトへの伝達、ロール = Azure_Site_Recovery<br/><br/> データストア -> 空間の割り当て、データストアの参照、ファイルの低レベルの操作、ファイルの削除、仮想マシン ファイルの更新<br/><br/> ネットワーク -> ネットワークの割り当て<br/><br/> リソース -> リソース プールへの VM の割り当て、電源がオフの VM の移行、電源がオンの VM の移行<br/><br/> タスク -> タスクの作成、タスクの更新<br/><br/> 仮想マシン -> 構成<br/><br/> 仮想マシン -> 対話 -> 質問への回答、デバイス接続、CD メディアの構成、フロッピー メディアの構成、電源オフ、電源オン、VMware ツールのインストール<br/><br/> 仮想マシン -> インベントリ -> 作成、登録、登録解除<br/><br/> 仮想マシン -> プロビジョニング -> 仮想マシンのダウンロードの許可、仮想マシン ファイルのアップロードの許可<br/><br/> 仮想マシン -> スナップショット -> スナップショットの削除 | ユーザーはデータセンター レベルで割り当てられ、データセンター内のすべてのオブジェクトに対してアクセス権を持ちます。<br/><br/> アクセスを制限するには、**子オブジェクトへの伝達**特権を持つ**アクセスなし**ロールを子オブジェクト (vSphere ホスト、データストア、VM、ネットワーク) に割り当てます。

### <a name="prepare-an-account-for-mobility-service-installation"></a>モビリティ サービスのインストール用のアカウントを準備する

モビリティ サービスは、レプリケートする VM にインストールする必要があります。

- VM のレプリケーションが有効になっていると、Site Recovery はこのコンポーネントの自動プッシュ インストールを行うことができます。
- 自動的にプッシュ インストールする場合は、Site Recovery で VM へのアクセスに使用するアカウントを準備する必要があります。
- Azure コンソールでレプリケーションを設定するときに、このアカウントを指定します。
- VM にインストールするアクセス許可を持つドメイン アカウントまたはローカル アカウントが必要です。


### <a name="prepare-to-connect-to-azure-vms-after-failover"></a>フェールオーバー後に Azure VM に接続するための準備をする

Azure にフェールオーバーした後、オンプレミスのネットワークから Azure のレプリケートされた VM に接続することがあります。

フェールオーバー後に RDP を使用して Windows VM に接続するには、次の操作を行います。

1. インターネット経由でアクセスするには、フェールオーバーの前に、オンプレミスの VM 上の RDP を有効にします。 TCP と UDP の規則が **[パブリック]** プロファイルに追加されていることを確認し、**[Windows ファイアウォール]** > **[許可されたアプリ]** で、すべてのプロファイルで RDP が許可されていることを確認します。
2. サイト間 VPN 経由でアクセスするには、オンプレミスのコンピューターで RDP を有効にします。 RDP は、**[Windows ファイアウォール]** -> **[許可されたアプリおよび機能]** から、**ドメインとプライベート** ネットワークでの使用を許可する必要があります。
3. オペレーティング システムの SAN ポリシーが **[OnlineAll]** に設定されていることを確認します。 [詳細情報](https://support.microsoft.com/kb/3031135)。
4. フェールオーバーをトリガーするときに、VM に保留中の Windows 更新プログラムがないようにします。 ある場合は、更新が完了するまで、仮想マシンにログインすることはできません。
5. フェールオーバー後の Microsoft Azure VM で **[ブート診断]** をオンにして、VM のスクリーンショットを確認します。 接続できない場合は、VM が実行中であることを確認したうえで、[トラブルシューティングのヒント](http://social.technet.microsoft.com/wiki/contents/articles/31666.troubleshooting-remote-desktop-connection-after-failover-using-asr.aspx)を確認してください。



## <a name="step-7-replicate-vms-with-site-recovery"></a>ステップ 7: Site Recovery で VM をレプリケートする

### <a name="select-a-replication-goal"></a>レプリケーションの目標を選ぶ

1. **[Recovery Services コンテナー]** で、コンテナー名 **ContosoVMVault** を選択します。
2. **[作業の開始]** で、[Site Recovery] を選択します。 次に、**[インフラストラクチャの準備]** を選択します。
3. **[保護の目標]** > **[マシンのある場所]** で、**[オンプレミス]** を選びます。
4. **[マシンをどこにレプリケートしますか]** で、**[To Azure]\(Azure\)** を選びます。
5. **[マシンは仮想化されていますか]** で、**[はい (VMware vSphere ハイパーバイザー の場合)]** を選びます。 **[OK]** をクリックします。

    ![OVF テンプレート](./media/migrate-scenarios-lift-and-shift/replication-goal.png)


### <a name="confirm-deployment-planning"></a>展開の計画を確認する

**[デプロイ計画]** のドロップダウン リストで **[はい、完了しました]** をクリックします。

### <a name="set-up-the-source-environment"></a>ソース環境をセットアップする


ソース環境をセットアップするには、オンプレミスの Site Recovery コンポーネントをホストするためのオンプレミスの高可用性マシンが 1 つ必要です。 コンポーネントには、構成サーバーとプロセス サーバーが含まれます。

- 構成サーバーは、オンプレミスと Azure の間の通信を調整し、データのレプリケーションを管理します。
- プロセス サーバーはレプリケーション ゲートウェイとして機能します。 レプリケーション データを受信し、そのデータをキャッシュ、圧縮、暗号化によって最適化して、Azure Storage に送信します。
- また、プロセス サーバーは、レプリケートする VM へのモビリティ サービスのインストールや、オンプレミスの VMware VM の自動検出も行います。


高可用性の VMware VM として構成サーバーを設定するには:

- 準備済みの Open Virtualization Format (OVF) テンプレートをダウンロードします。
- VMware にテンプレートをインポートして VM を作成します。
- 構成サーバーを設定し、それをコンテナーに登録します。 

登録すると、Site Recovery によってオンプレミスの VMware VM が検出されます。



#### <a name="download-the-vm-template"></a>VM テンプレートをダウンロードする

1. コンテナーで、**[インフラストラクチャの準備]** > **[ソース]** の順に移動します。
2. **[ソースの準備]** で **[+ 構成サーバー]** を選びます。

    ![テンプレートのダウンロード](./media/migrate-scenarios-lift-and-shift/new-cs.png)

4. **[サーバーの追加]** で、**[サーバーの種類]** に **[VMware の構成サーバー]** が表示されていることを確認します。
2. 構成サーバー用の OVF テンプレートをダウンロードします。

    ![OVF をダウンロードする](./media/migrate-scenarios-lift-and-shift/add-cs.png)

  > [!TIP]
  構成サーバー テンプレートの最新バージョンは、[Microsoft ダウンロード センター](https://aka.ms/asrconfigurationserver)から直接ダウンロードできます。

#### <a name="import-the-template-in-vmware"></a>VMware にテンプレートをインポートする

1. VMWare vSphere Client を使って、VMware vCenter サーバーにサインインします。
2. **[File]\(ファイル\)** メニューの **[Deploy OVF Template]\(OVF テンプレートのデプロイ\)** を選び、Deploy OVF Template (OVF テンプレートのデプロイ) ウィザードを起動します。 

     ![OVF テンプレート](./media/migrate-scenarios-lift-and-shift/vcenter-wizard.png)

3. **[Select source]\(ソースの選択\)** で、ダウンロードした OVF の場所を入力します。
4. **[Review details]\(詳細の確認\)** で、**[Next]\(次へ\)** を選択します。
5. **[Select name and folder]\(名前とフォルダーの選択\)** および **[Select configuration]\(構成の選択\)** は、既定の設定のままにします。
6. **[Select storage]\(ストレージの選択\)** で、パフォーマンスを最大にするために、**[Select virtual disk format]\(仮想ディスクの形式の選択\)** の **[Thick Provision Eager Zeroed]\(シック プロビジョニング Eager Zeroed\)** を選びます。
7. ウィザードの残りのページでは、既定の設定をそのまま使います。
8. **[Ready to complete]\(完了の準備\)** で、次の操作を行います。

    * 既定の設定で VM をセットアップするには、**[Power on after deployment]\(デプロイ後に電源をオンにする\)** > **[Finish]\(完了\)** の順に選びます。

    * 別のネットワーク インターフェイスを追加する場合は、**[Power on after deployment]\(デプロイ後に電源をオンにする\)** をオフにします。 続けて、**[完了]** を選択します。 既定でデプロイされる構成サーバー テンプレートの NIC は 1 つだけですが、 デプロイ後にさらに NIC を追加することができます。



#### <a name="register-the-configuration-server"></a>構成サーバーを登録する 

1. VMWare vSphere Client のコンソールで、VM をオンにします。
2. VM が Windows Server 2016 のインストール エクスペリエンスで起動します。 使用許諾契約書に同意し、管理者パスワードを入力します。
3. インストールの完了後に、管理者として VM にサインインします。
4. 初めてサインインすると、Azure Site Recovery 構成ツールが起動されます。
5. 構成サーバーを Site Recovery に登録するために使う名前を入力します。 次に、**[次へ]** を選択します。

    ![OVF テンプレート](./media/migrate-scenarios-lift-and-shift/config-server-register1.png)

6. このツールは、VM が Azure に接続できることを確認します。 接続が確立された後、**[サインイン]** を選択して、自分の Azure サブスクリプションにサインインします。 この資格情報は、構成サーバーを登録するコンテナーにアクセスできる必要があります。

    ![OVF テンプレート](./media/migrate-scenarios-lift-and-shift/config-server-register2.png)

7. ツールがいくつかの構成タスクを実行した後、再起動されます。
8. 再度マシンにサインインします。 構成サーバーの管理ウィザードが自動的に起動されます。

#### <a name="configure-settings-and-add-the-vmware-server"></a>設定を構成し、VMware サーバーを追加する

1. 構成サーバーの管理ウィザードで **[接続の設定]** を選び、レプリケーション トラフィックを受信する NIC を選びます。 次に、**[保存]** を選択します。 構成後、この設定を変更することはできません。
2. **[Recovery Services コンテナーを選択する]** で、Azure サブスクリプションと、関連するリソース グループおよびコンテナーを選びます。

    ![コンテナー](./media/migrate-scenarios-lift-and-shift/cswiz1.png) 

3. **[サードパーティ製ソフトウェアのインストール]** でライセンス契約に同意します。 **[ダウンロードしてインストール]** を選択して MySQL サーバーをインストールします。
4. **[VMware PowerCLI のインストール]** を選択します。 この操作を行う前に、すべてのブラウザー ウィンドウを閉じてください。 その後 **[続行]** を選択します。
5. **[アプライアンス構成の検証]** で、続行する前に前提条件が検証されます。
6. **[Configure vCenter Server/vSphere ESXi server]\(vCenter Server/vSphere ESXi サーバーの構成\)** で、レプリケートする VM が存在している vCenter サーバーまたは vSphere ホストの FQDN または IP アドレスを入力します。 サーバーがリッスンするポートを入力します。 コンテナーで VMware サーバーに使うフレンドリ名を入力します。
7. VMware サーバーに接続するために構成サーバーによって使われる資格情報を入力します。 Site Recovery はこれらの資格情報を使って、レプリケーションに利用できる VMware VM を自動的に検出します。 **[追加]**、**[続行]** の順に選択します。

    ![vCenter](./media/migrate-scenarios-lift-and-shift/cswiz2.png)

8. **[仮想マシンの資格情報の構成]** で、レプリケーションが有効になったときにモビリティ サービスをマシンに自動的にインストールするために使われるユーザー名とパスワードを入力します。 Windows マシンの場合、このアカウントは、レプリケートするマシンに対するローカル管理者特権を持っている必要があります。 

    ![vCenter](./media/migrate-scenarios-lift-and-shift/cswiz2.png)

7. **[構成の確定]** を選択して、登録を完了します。 
8. 登録が完了したら、Azure Portal で、構成サーバーおよび VMware サーバーがコンテナーの **[ソース]** ページの一覧に表示されていることを確認します。 その後、**[OK]** を選択して、ターゲットの設定を構成します。
9. Site Recovery は指定された設定を使用して VMware サーバーに接続し、VM を検出します。

> [!NOTE]
> アカウント名がポータルに表示されるまでに 15 分以上かかることがあります。 すぐに更新するには、**[構成サーバー]** > ***[<サーバー名>]*** > **[サーバーを最新の情報に更新する]** の順に選択します。

### <a name="set-up-the-target-environment"></a>ターゲット環境をセットアップする

ターゲット リソースを選択して確認します。

1. **[インフラストラクチャの準備]** > **[ターゲット]** で、使う Azure サブスクリプションを選びます。
2. ターゲットのデプロイ モデルでは、**[Azure Resource Manager]** を選びます。

3. Site Recovery によって、互換性のある Azure ストレージ アカウントとネットワークが 1 つ以上あるかどうかが確認されます。


### <a name="create-a-replication-policy"></a>レプリケーション ポリシーを作成する

1. **[インフラストラクチャの準備]** > **[レプリケーションの設定]** > **[レプリケーション ポリシー]** で、**[作成と関連付け]** をクリックします。
1. **[レプリケーション ポリシーの作成]** で、ポリシー名として「**VMwareRepPolicy**」を入力します。
2. **[RPO しきい値]** では、既定値の 60 分が使用されます。 この値で、復旧ポイントの作成頻度を指定します。 継続的なレプリケーションがこの制限を超えると、アラートが生成されます。
3. **[復旧ポイントのリテンション期間]** では、各復旧ポイントのリテンション期間に既定値の 24 時間が使用されます。 このチュートリアルでは 72 時間を使用します。 レプリケートされた VM は、期間内の任意の時点に復旧できます。
4. **[アプリ整合性スナップショットの頻度]** では、アプリ整合性スナップショットの作成頻度に既定値の 60 分が使用されます。 **[OK]** を選択してポリシーを作成します。

    ![レプリケーション ポリシーの作成](./media/migrate-scenarios-lift-and-shift/replication-policy.png)

5. このポリシーは自動的に構成サーバーに関連付けられます。 

    ![レプリケーション ポリシーを関連付ける](./media/migrate-scenarios-lift-and-shift/replication-policy2.png)



### <a name="enable-replication"></a>レプリケーションを有効にする

VM のレプリケートを開始します。 VM のレプリケーションを有効にすると、Site Recovery は各 VM にモビリティ サービスをインストールします。 


1. **[アプリケーションをレプリケートする]** > **[ソース]** を選択します。
2. **[ソース]** で、構成サーバーを選択します。
3. **[マシンの種類]** で、**[仮想マシン]** を選択します。
4. **[vCenter/vSphere Hypervisor] \(vCenter/vSphere ハイパーバイザー)** で、vSphere ホストを管理する vCenter サーバーを選択するか、ホストを選択します。
5. プロセス サーバー (構成サーバー) を選択します。 **[OK]** をクリックします。

    ![レプリケーションを有効にする](./media/migrate-scenarios-lift-and-shift/enable-replication1.png)

1. **[ターゲット]** で、サブスクリプションと、フェールオーバー対象の VM を作成するリソース グループを選択します。 フェールオーバー対象の VM に Azure で使用するデプロイ モデル (クラシックまたは Resource Manager) を選択します。
2. データのレプリケーションに使用する Azure Storage アカウントを選択します。
3. フェールオーバー後に作成された Azure VM が接続する Azure ネットワークとサブネットを選択します。
4. 保護の対象として選択したすべてのマシンにネットワーク設定を適用する場合は、**[選択したマシン用に今すぐ構成します。]** を選択します。 マシンごとに Azure ネットワークを選択する場合は、**[後で構成する]** を選択します。
5. 仮想ネットワーク内のサブネットを選びます。 **[OK]** をクリックします。

    ![レプリケーションを有効にする](./media/migrate-scenarios-lift-and-shift/enable-replication2.png)

6. **[Virtual Machines]** > **[仮想マシンの選択]** で、使用する VM (WEBVM) を選びます。 選択できるのは、レプリケーションを有効にできるマシンのみです。 

    ![レプリケーションを有効にする](./media/migrate-scenarios-lift-and-shift/enable-replication3.png)

7. 追加する VM を監視するには、**[構成サーバー]** > **[最後の使用]** で VM の最終検出時刻を確認します。 定期検出を待たずに VM を追加するには、構成サーバーを強調表示し (選択しないでください)、**[更新]** を選択します。 変更が反映されてポータルに表示されるまで 15 分以上かかる場合があります。
8. **[プロパティ]** > **[プロパティの構成]** で、モビリティ サービスをマシンに自動的にインストールするためにプロセス サーバーが使用するアカウントを選択します。 

    ![レプリケーションを有効にする](./media/migrate-scenarios-lift-and-shift/enable-replication4.png)

9. **[レプリケーションの設定]** > **[レプリケーション設定の構成]** で、正しいレプリケーション ポリシーが選択されていることを確認します。
10. **[レプリケーションを有効にする]** を選択します。

    ![レプリケーションを有効にする](./media/migrate-scenarios-lift-and-shift/enable-replication5.png)

11. **保護の有効化**ジョブの進行状況を、**[設定]** > **[ジョブ]** > **[Site Recovery ジョブ]** で追跡します。 
12. **保護の最終処理**ジョブが実行されると、マシンはフェールオーバーできる状態になり、**[概要]** > **[要点]** に表示されます。

    ![要点](./media/migrate-scenarios-lift-and-shift/essentials.png)


## <a name="step-8-migrate-the-database-with-dms"></a>ステップ 8: DMS を使用してデータベースを移行する

DMS プロジェクトを作成し、移行を実行します。


### <a name="create-a-database-migration-project"></a>Database Migration プロジェクトを作成する

1. Azure portal で DMS リソースを探して開きます。
2. **[+ New Migration Project]\(+ 新しい移行プロジェクト\)** を選択します。
3. **[新しい移行プロジェクト]** でプロジェクトの名前を指定します。
4. **[Source server type]\(ソース サーバーの種類\)** で、**[SQL Server]** を選択します。 **[ターゲット サーバーの種類]** で、**[Azure SQL Database マネージ インスタンス]** を選びます。
5. **[作成]** をクリックしてプロジェクトを作成します。
6. **[ソースの詳細]** で、オンプレミスの移行元 SQL Server の接続詳細を指定します。 **[Save]** をクリックします。
7. **[ターゲットの詳細]** で、移行先のの接続情報を指定します。このターゲットは、オンプレミスのデータベースの移行先である、事前プロビジョニング済みの Azure SQL Database マネージド インスタンスです。 その後、 **[保存]** をクリックします。
8. **[プロジェクトの概要]** で、移行プロジェクトに関連付けられた詳細を確認します。

    ![DMS プロジェクト](./media/migrate-scenarios-lift-and-shift/dms-project.png)

### <a name="migrate-the-database"></a>データベースを移行する

1. プロジェクトを作成した後、移行ウィザードが表示されます。
2. 移行元と移行先のサーバーの資格情報を指定し、**[保存]** をクリックします。 ウィザードは、オンプレミスの SQL Server へのログインを試みます。

    ![DMS ウィザード](./media/migrate-scenarios-lift-and-shift/dms-wiz1.png)

3. **[ターゲット データベースへマッピング]** で、移行するソース データベースを選びます。 その後、 **[保存]** をクリックします。

    ![DMS ウィザード](./media/migrate-scenarios-lift-and-shift/dms-wiz2.png)

4. **[ターゲットの詳細]** で、**[ターゲットの詳細を把握しています]** を選びます。 資格情報と共に SQL マネージド インスタンスの DNS 名を提供します。 その後、 **[保存]** をクリックします。

    ![DMS ウィザード](./media/migrate-scenarios-lift-and-shift/dms-wiz3.png)

5. 保存したプロジェクトで、**[+ 新しい活動]** を選びます。 次に、**[移行の実行]** を選びます。
6. メッセージが表示されたら、移行元サーバーと移行先サーバーの資格情報を入力します。 その後、 **[保存]** をクリックします。
7. **[ターゲット データベースへマッピング]** で、移行するソース データベースを選びます。 **[保存]**
8. **[移行の設定の構成]** > **[サーバーのバックアップ場所]** で、オンプレミスのマシン上に作成したネットワーク共有を指定します。 DMS は、この共有に移行元のバックアップを取得します。  移行元の SQL Server インスタンスを実行しているサービス アカウントには、この共有に対する書き込み権限が必要であることに注意してください。
9. 復元のため Azure Storage コンテナーにバックアップ ファイルをアップロードするために DMS が偽装できるユーザー名とパスワードを指定します。
10. サービスがバックアップ ファイルをアップロードするストレージ アカウント コンテナーへのアクセスを DMS に提供する SAS URI を指定します。このコンテナーが、Azure SQL Database マネージド インスタンスへのデータベースの移行に使われます。  その後、 **[保存]** をクリックします。
11. **[移行の概要]** で、移行アクティビティの名前を指定して、**[Run the migration]\(移行を実行する\)** をクリックします。
12. プロジェクトの **[概要]** で、移行の状態を監視します。 移行が完了した後、マネージド インスタンスに移行先のデータベースが存在することを確認します。


## <a name="step-9-migrate-vms-with-site-recovery"></a>ステップ 9: Site Recovery で VM を移行する

完全な移行を実行する前に、テスト フェールオーバーを実行して、すべてが想定どおり動作することを確認するすることをお勧めします。 テスト フェールオーバーを実行すると、次の処理が発生します。

1. 移行を実行するために必要なすべての条件が満たされていることを確認する前提条件チェックが実行されます。
2. Azure VM を作成できるように、フェールオーバーによってデータが処理されます。 最新の復旧ポイントを選択した場合は、データから復旧ポイントが作成されます。
3. 前の手順で処理されたデータを使用して、Azure VM が作成されます。

### <a name="run-a-test-failover"></a>テスト フェールオーバーの実行

1. **[保護されているアイテム]** で、**[レプリケートされたアイテム]** をクリックし、VM をクリックします。
2. VM のプロパティで、**[+ テスト フェールオーバー]** をクリックします。

    ![[テスト フェールオーバー]](./media/migrate-scenarios-lift-and-shift/test-failover.png)

3. 利用可能な最新のポイントインタイムに VM をフェールオーバーするには、**[最後に処理があった時点]** を選びます。 タイム スタンプが表示されます。 このオプションを使用すると、データの処理に時間がかからないため、RTO (目標復旧時間) が低くなります。
2. **[テスト フェールオーバー]** で、フェールオーバー後に Azure VM が接続するターゲット Azure ネットワークを選択します。
3. **[OK]** をクリックすると、フェールオーバーが開始されます。 コンテナーの **[設定]** > **[ジョブ]** > **[テスト フェールオーバー]** で、進行状況を追跡できます。
4. フェールオーバーの完了後、レプリカの Azure VM は、Azure Portal の **[仮想マシン]** に表示されます。 VM が適切なサイズであること、適切なネットワークに接続されていること、および実行されていることを確認します。 これで、Azure 内のレプリケートされた VM に接続できるはずです。
5. テスト フェールオーバー中に作成された VM を削除するには、VM で **[テスト フェールオーバーのクリーンアップ]** をクリックします。 **[メモ]** を使用して、テスト フェールオーバーに関連する観察結果をすべて記録し、保存します。

### <a name="migrate-the-machines"></a>マシンを移行する

テスト フェールオーバーが正しく動作するを確認したら、Azure に移行する復旧計画を作成します。

### <a name="create-a-recovery-plan"></a>復旧計画の作成

1. コンテナーで、**[復旧計画 (Site Recovery)]** > **[+ 復旧計画]** を選択します。
2. **[復旧計画の作成]** で、計画の名前を指定します。
3. 移行元の構成サーバーと、移行先としての Azure を選択します。 デプロイ モデルとして **[Resource Manager]** を選びます。 ソースの場所には、フェールオーバーと復旧が有効になったマシンが必要になります。 
4. **[項目の選択]** で、マシン (WEBVM) を計画に追加します。 次に、 **[OK]** をクリックします
5. **[OK]** をクリックすると、計画が作成されます。

    ![復旧計画](./media/migrate-scenarios-lift-and-shift/recovery-plan1.png)

### <a name="run-a-failover"></a>フェールオーバーの実行

1. **[復旧計画]** で、計画をクリックして **[フェールオーバー]** を選びます。
2. **[フェールオーバー]** > **[復旧ポイント]** で、最新の復旧ポイントを選びます。
3. 暗号化キー設定は、このシナリオには関係しません。
4. **[フェールオーバーを開始する前にマシンをシャットダウンします]** を選択します。 Site Recoverty は、ソース仮想マシンのシャットダウンを試行してからフェールオーバーをトリガーします。 仮にシャットダウンが失敗したとしても、フェールオーバーは続行されます。 フェールオーバーの進行状況は **[ジョブ]** ページで確認できます。

    ![フェールオーバー](./media/migrate-scenarios-lift-and-shift/failover1.png)

5. 想定どおりに Azure VM が Azure に表示されることを確認します。

    ![フェールオーバー](./media/migrate-scenarios-lift-and-shift/failover2.png)

6. **[レプリケートされたアイテム]** で [VM] > **[移行の完了]** を右クリックします。 これによって、移行プロセスが終了し、VM のレプリケーションが停止して、その VM での Site Recovery の課金が停止します。

    ![フェールオーバー](./media/migrate-scenarios-lift-and-shift/failover3.png)

### <a name="update-the-connection-string"></a>接続文字列を更新する

移行プロセスの最後ステップでは、アプリケーションの接続文字列を更新して、SQL MI で実行されている移行されたデータベースを指すようにします。

1. Azure portal で **[設定]** > **[接続文字列]** をクリックして、新しい接続文字列を確認します。

    ![フェールオーバー](./media/migrate-scenarios-lift-and-shift/failover4.png)  

2. SQL MI のユーザー名とパスワードで、この文字列を更新する必要があります。
3. 文字列を構成した後は、アプリケーションの web.config ファイルに含まれる現在の接続文字列を置き換える必要があります。
4. ファイルを更新して保存した後、WEBVM で IIS を再起動します。 これは、コマンド プロンプトから IISRESET /RESTART を使って行うことができます。
5. IIS が再起動すると、アプリケーションは SQL MI で実行しているデータベースを使うようになります。
6. この時点で、オンプレミスの SQLVM マシンをシャットダウンすることができ、移行は完了します。



## <a name="conclusion"></a>まとめ

このシナリオでは、以下を実行しました。

> [!div class="checklist"]
> * DMS を使って、オンプレミスのデータベースを Azure SQL マネージド インスタンスに移行しました。
> * Azure Site Recovery サービスを使って、オンプレミスの VM を Azure VM に移行しました。
