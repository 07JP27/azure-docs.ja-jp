---
title: Azure Migrate を使用したスケールの検出と評価 | Microsoft Docs
description: Azure Migrate サービスを使用して、多数のオンプレミス マシンを評価する方法について説明します。
author: rayne-wiselman
ms.service: azure-migrate
ms.topic: conceptual
ms.date: 10/23/2018
ms.author: raynew
ms.openlocfilehash: 32bed3a60c40b93471b75b9d54dccd822ccc3be8
ms.sourcegitcommit: f6050791e910c22bd3c749c6d0f09b1ba8fccf0c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/25/2018
ms.locfileid: "50025876"
---
# <a name="discover-and-assess-a-large-vmware-environment"></a>大規模な VMware 環境の検出と評価

Azure Migrate は 1 プロジェクトあたりのマシン数は 1,500 台に制限されていますが、この記事では、[Azure Migrate](migrate-overview.md) を使用して、多数のオンプレミスの仮想マシン (VM) を評価する方法について説明します。   

## <a name="prerequisites"></a>前提条件

- **VMware**: 移行する予定の VM は、vCenter Server バージョン 5.5、6.0、または 6.5 で管理する必要があります。 また、コレクター VM を展開するために、バージョン 5.0 以降を稼働している ESXi ホストが 1 つ必要です。
- **vCenter アカウント**: vCenter Server にアクセスするために、読み取り専用アカウントが必要です。 Azure Migrate はこのアカウントを使ってオンプレミスの VM を検出します。
- **アクセス許可**: vCenter Server で、.OVA 形式でファイルをインポートして VM を作成するためのアクセス許可が必要です。
- **統計情報の設定**: この要件は、[1 回限りの検出モデル](https://docs.microsoft.com/azure/migrate/concepts-collector#discovery-methods)にのみ適用されます。 1 回限りの検出モデルの場合、デプロイを始める前に、vCenter Server の統計設定をレベル 3 に設定する必要があります。 日、週、月の収集間隔のそれぞれについて、統計情報レベルを 3 に設定する必要があります。 3 つの収集間隔のうち、いずれか 1 つでもレベルが 3 未満の場合、評価は機能しますが、ストレージとネットワークのパフォーマンス データが収集されません。 この場合の推奨サイズは、CPU とメモリのパフォーマンス データと、ディスクおよびネットワーク アダプターの構成データに基づきます。

### <a name="set-up-permissions"></a>アクセス許可の設定

Azure Migrate は、評価対象の VM を自動的に検出するために、VMware サーバーにアクセスする必要があります。 VMware アカウントには次のアクセス許可が必要です。

- ユーザーの種類: 読み取り専用以上
- アクセス許可: データ センター オブジェクト –> 子オブジェクトへの伝達、ロール=読み取り専用
- 詳細: ユーザーはデータセンター レベルで割り当てられ、データセンター内のすべてのオブジェクトに対してアクセス権を持ちます。
- アクセスを制限するには、子オブジェクトへの伝達特権を持つアクセスなしロールを子オブジェクト (vSphere ホスト、データストア、VM、ネットワーク) に割り当てます。

テナント環境にデプロイする場合、これを設定する 1 つの方法を以下に示します。

1.  テナントあたり 1 つのユーザーを作成し、[RBAC](https://docs.microsoft.com/azure/role-based-access-control/role-assignments-portal) を使用して、特定のテナントに属するすべての VM に読み取り専用のアクセス許可を割り当てます。 次にこれらの資格情報を使用して検出を行います。 RBAC により、対応する vCenter ユーザーが、テナント固有の VM のみにアクセスできるようになります。
2. 次の例でユーザー 1 とユーザー 2 について記載されているように、異なるテナント ユーザーに対して RBAC を設定します。

    - **[ユーザー名]** と **[パスワード]** に、コレクターが VM を検出するために使用する読み取り専用の資格情報を指定します。
    - Datacenter1 - ユーザー 1 とユーザー 2 に読み取り専用アクセス許可を付与します。 アクセス許可を個々の VM に設定するため、これらのアクセス許可をすべての子オブジェクトに反映しないようにします。

      - VM1 (テナント 1) (ユーザー 1 への読み取り専用アクセス許可)
      - VM2 (テナント 1) (ユーザー 1 への読み取り専用アクセス許可)
      - VM3 (テナント 2) (ユーザー 2 への読み取り専用アクセス許可)
      - VM4 (テナント 2) (ユーザー 2 への読み取り専用アクセス許可)

   - ユーザー 1 の資格情報を使用して検出を実行する場合、VM1 と VM2 のみが検出されます。

## <a name="plan-your-migration-projects-and-discoveries"></a>移行プロジェクトと検出を計画する

1 つの Azure Migrate コレクターは、複数の vCenter Server からの検出をサポートし (1 つずつ)、さらに複数の移行プロジェクトへの検出もサポートします (1 つずつ)。

コレクターは、1 回限りの検出の場合、ファイア アンド フォーゲット モデルで動作し、検出が完了すると、同じコレクターを使用して別の vCenter Server からデータを収集するか、別の移行プロジェクトにデータを送信できます。 継続的な検出の場合、 1 つのアプライアンスは 1 つのプロジェクトのみに接続されますので、2 つ目の検出をトリガーする同じコレクターを使用することはできません。

以下の制限に基づいて、検出と評価を計画します。

| **エンティティ** | **マシンの制限** |
| ---------- | ----------------- |
| Project    | 1,500             |
| 探索  | 1,500             |
| 評価 | 1,500             |

このような計画の場合は、以下の事項を考慮してください。

- Azure Migrate コレクターを使用して検出を行う場合、検出範囲を vCenter Server フォルダー、データセンター、クラスター、またはホストに設定できます。
- 2 つ以上の検出を行うには、検出を行う VM が、マシンの数が 1500 台という制限に対応しているフォルダー、データセンター、クラスター、またはホスト内にあることを、vCenter Server で確認します。
- 評価を目的としている場合は、複数のマシンを同じプロジェクトと同じ評価内にまとめ、相互に依存関係にある状態にすることをお勧めします。 そして vCenter Server で、依存関係にあるマシンが評価のために同じフォルダー、データセンター、またはクラスター内にあることを確認してください。

シナリオに応じて、以下に示すように検出を分割することができます。

### <a name="multiple-vcenter-servers-with-less-than-1500-vms"></a>VM 数が 1,500 未満の複数の vCenter Server
環境内に複数の vCenter サーバーがあり、仮想マシンの合計数が 1500 より少ない場合は、シナリオに応じて次のアプローチを使用できます。

**1 回限りの検出:** すべての vCenter サーバーにおいてすべての仮想マシンを検出するために、 1 つのコレクターおよび1 つの移行プロジェクトを使用することができます。 1 回限りの検出コレクターは、一度に 1 つの vCenter Server を検出するため、すべての vCenter Server に対して同じコレクターを 1 つずつ実行し、そのコレクターを同じ移行プロジェクトにポイントできます。 すべての検出が完了すると、マシンの評価を作成できます。

**継続的な検出:** 継続的な検出の場合、 1 つのアプライアンスは 1 つのプロジェクトのみに接続できます。 したがって、各 vCenter Server に 1 つのアプライアンスをデプロイし、それに応じて各アプライアンスとトリガー検出用の 1 つのプロジェクトを作成する必要があります。

### <a name="multiple-vcenter-servers-with-more-than-1500-vms"></a>VM 数が 1,500 を超える複数の vCenter Server

複数の vCenter Server がある場合、1 つの vCenter Server あたりの仮想マシン数は 1,500 未満であるが、すべての vCenter Serve では 1,500 を超えるときは、複数の移行プロジェクトを作成する必要があります (1 つの移行プロジェクトでは 1,500 台の VM しか保持できません)。 これを実現するには、vCenter Server ごとに移行プロジェクトを作成し、検出を分割します。

**1 回限りの検出:** 1 つのコレクターを使用して、各 vCenter Server を (1 つずつ) 検出できます。 検出を同時に開始する場合は、複数のアプライアンスをデプロイし、検出を並行して実行することもできます。

**継続的な検出:** 複数のコレクター アプライアンス (各 vCenter Server に 1 つ) を作成し、それに応じて各アプライアンスを 1 つのプロジェクトおよびトリガー検出に接続する必要があります。

### <a name="more-than-1500-machines-in-a-single-vcenter-server"></a>1 つの vCenter Server に 1,500 を超えるマシンがある場合

1 つの vCenter Server に 1,500 を超える仮想マシンがある場合は、検出を複数の移行プロジェクトに分割する必要があります。 検出を分割するには、アプライアンスのスコープ フィールドを活用し、検出したいホスト、クラスター、フォルダーまたはデータセンターを指定することができます。 たとえば、vCenter Server に 2 つのフォルダーがあり、1 つに 1,000 の VM (Folder1) があり、もう 1 つに 800 の VM (Folder2) がある場合は、これらフォルダー間の検出を分割するためにスコープ フィールドを使用することができます。

**1 回限りの検出:** 同じコレクターを使用して両方の検出をトリガーできます。 最初の検出では、スコープとして Folder1 を指定し、最初の移行プロジェクトにポイントすることができ、最初の検出が完了したら、同じコレクターを使用して、スコープを Folder2 に、また移行プロジェクトの詳細を 2 番目の移行プロジェクトに変更し、2 番目の検出を実行できます。

**継続的な検出:** この場合、2 つのコレクター アプライアンスを作成する必要があり、最初のコレクターについては、Folder 1 としてスコープを指定して最初の移行プロジェクトに接続する必要があります。 2 つ目のコレクター アプライアンスを使用して Folder 2 の 検出を並列で開始し、2 つ目の移行プロジェクトに接続することができます。

### <a name="multi-tenant-environment"></a>マルチテナント環境

テナント間で共有されている環境があり、別のテナントのサブスクリプションで 1 つのテナントの VM を検出したくない場合は、コレクター アプライアンスのスコープ フィールドを使用して、検出範囲を指定することができます。 テナントがホストを共有している場合は、特定のテナントに属する VM のみに読み取り専用アクセス権を持つ資格情報を作成してから、コレクター アプライアンスでこの資格情報を使用し、スコープをホストとして指定して検出を実行します。

## <a name="discover-on-premises-environment"></a>オンプレミス環境の検出

計画が準備できたら、オンプレミス仮想マシンの検出を開始できます。

### <a name="create-a-project"></a>プロジェクトの作成

要件に従って Azure Migrate プロジェクトを作成します。

1. Azure Portal で、**[リソースの作成]** を選択します。
2. 「**Azure Migrate**」を検索し、検索結果でサービス **Azure Migrate** を選択します。 **[作成]** を選択します。
3. プロジェクト名およびプロジェクトの Azure サブスクリプションを指定します。
4. 新しいリソース グループを作成します。
5. プロジェクトを作成する場所を指定し、**[作成]** を選択します。 別のターゲット場所の場合でも VM を評価することができます。 プロジェクト用に指定された場所は、オンプレミスの VM から収集されたメタデータを格納するために使用します。

### <a name="set-up-the-collector-appliance"></a>コレクター アプライアンスの設定

Azure Migrate は、コレクター アプライアンスと呼ばれるオンプレミスの VM を作成します。 この VM はオンプレミスの VMware VM を検出し、それについてのメタデータを Azure Migrate サービスに送信します。 コレクター アプライアンスをセットアップするには、.OVA ファイルをダウンロードしてオンプレミスの vCenter Server インスタンスにインポートします。

#### <a name="download-the-collector-appliance"></a>コレクター アプライアンスをダウンロードする

複数のプロジェクトがある場合でも、コレクター アプライアンスをダウンロードして vCenter Server にインポートするのは 1 度だけでかまいません。 アプライアンスをダウンロードしてセットアップした後、それを各プロジェクトで実行し、一意のプロジェクト ID とキーを指定します。

1. Azure Migrate プロジェクトで、**[開始]** > **[検出と評価]** > **[マシンの検出]** の順にクリックします。
2. **[マシンの検出]** には、アプライアンスに使用できるオプションが 2 つあり、設定に基づいて適切なアプライアンスをダウンロードするには **[ダウンロード]** をクリックします。

    a. **1 回限りの検出:** このモデルでのアプライアンスは、vCenter Server と通信して、VM に関するメタデータを収集します。 VM のパフォーマンス データの収集については、vCenter Server に格納されているパフォーマンス データの履歴に依存しており、過去 1 か月のパフォーマンス履歴を収集します。 このモデルでは、Azure Migrate は各メトリックの平均カウンター (ピーク カウンターではない) を収集します。詳細については、[こちら](https://docs.microsoft.com/azure/migrate/concepts-collector#what-data-is-collected)を参照してください。 これは 1 回限りの検出であるため、いったん検出が完了すると、オンプレミス環境での変更は反映されません。 変更を反映したい場合は、同じプロジェクトに対して、同じ環境の再検出を行う必要があります。

    b. **継続的な検出:** このモデルでのアプライアンスは、継続的にオンプレミス環境をプロファイルして、各 VM のリアルタイムの使用状況データを収集します。 このモデルでは、各メトリック (CPU 使用率、メモリ使用率など) のピーク カウンターが収集されます。 このモデルは、パフォーマンス データ収集に関する vCenter Server の統計情報設定に依存しません。 継続的なプロファイルは、いつでもアプライアンスから停止できます。

    > [!NOTE]
    > 継続的な検出の機能は、プレビュー段階にあります。

3. **[プロジェクトの資格情報をコピーします]** で、プロジェクトの ID とキーをコピーします。 これらの情報はコレクターを構成するときに必要になります。


#### <a name="verify-the-collector-appliance"></a>コレクター アプライアンスを確認する

OVA ファイルをデプロイする前に、そのファイルが安全であることを確認します。

1. ファイルをダウンロードしたマシンで、管理者用のコマンド ウィンドウを開きます。

2. 次のコマンドを実行して、OVA のハッシュを生成します。

   ```C:\>CertUtil -HashFile <file_location> [Hashing Algorithm]```

   使用例: ```C:\>CertUtil -HashFile C:\AzureMigrate\AzureMigrate.ova SHA256```

3. 生成されたハッシュが次の設定と一致することを確認します。

#### <a name="one-time-discovery"></a>1 回限りの検出

<<<<<<< HEAD For OVA version 1.0.9.15 (Released on 10/23/2018)

 <a name="algorithm--hash-value"></a>**アルゴリズム** | **ハッシュ値**
=======
OVA バージョン 1.0.9.15 の場合

**アルゴリズム** | **ハッシュ値**
>>>>>>> 20dc93529e7c0a4d17f2f4524752b5e2bead4e37 --- | --- MD5 | e9ef16b0c837638c506b5fc0ef75ebfa SHA1 | 37b4b1e92b3c6ac2782ff5258450df6686c89864 SHA256 | 8a86fc17f69b69968eb20a5c4c288c194cdcffb4ee6568d85ae5ba96835559ba

<<<<<<< HEAD For OVA version 1.0.9.14 (Released on 8/24/2018) ======= For OVA version 1.0.9.14
>>>>>>> 20dc93529e7c0a4d17f2f4524752b5e2bead4e37

**アルゴリズム** | **ハッシュ値**
--- | ---
MD5 | 6d8446c0eeba3de3ecc9bc3713f9c8bd
SHA1 | e9f5bdfdd1a746c11910ed917511b5d91b9f939f
SHA256 | 7f7636d0959379502dfbda19b8e3f47f3a4744ee9453fc9ce548e6682a66f13c

OVA バージョン 1.0.9.12 の場合

**アルゴリズム** | **ハッシュ値**
--- | ---
MD5 | d0363e5d1b377a8eb08843cf034ac28a
SHA1 | df4a0ada64bfa59c37acf521d15dcabe7f3f716b
SHA256 | f677b6c255e3d4d529315a31b5947edfe46f45e4eb4dbc8019d68d1d1b337c2e

OVA バージョン 1.0.9.8 の場合

**アルゴリズム** | **ハッシュ値**
--- | ---
MD5 | b5d9f0caf15ca357ac0563468c2e6251
SHA1 | d6179b5bfe84e123fabd37f8a1e4930839eeb0e5
SHA256 | 09c68b168719cb93bd439ea6a5fe21a3b01beec0e15b84204857061ca5b116ff

OVA バージョン 1.0.9.7 の場合

**アルゴリズム** | **ハッシュ値**
--- | ---
MD5 | d5b6a03701203ff556fa78694d6d7c35
SHA1 | f039feaa10dccd811c3d22d9a59fb83d0b01151e
SHA256 | e5e997c003e29036f62bf3fdce96acd4a271799211a84b34b35dfd290e9bea9c

#### <a name="continuous-discovery"></a>継続的な検出

OVA バージョン 1.0.10.4 の場合

**アルゴリズム** | **ハッシュ値**
--- | ---
MD5 | 2ca5b1b93ee0675ca794dd3fd216e13d
SHA1 | 8c46a52b18d36e91daeae62f412f5cb2a8198ee5
SHA256 | 3b3dec0f995b3dd3c6ba218d436be003a687710abab9fcd17d4bdc90a11276be

### <a name="create-the-collector-vm"></a>コレクター VM を作成する

ダウンロードしたファイルを vCenter Server にインポートします。

1. vSphere Client コンソールで、**[File]** > **[Deploy OVF Template]** の順に選択します。

    ![OVF をデプロイする](./media/how-to-scale-assessment/vcenter-wizard.png)

2. [Deploy OVF Template] ウィザードで **[Source]** を選択し、OVA ファイルの場所を指定します。
3. **[Name]\(名前\)** と **[Location]\(場所\)** で、コレクター VM のフレンドリ名と、VM がホストされるインベントリ オブジェクトを指定します。
4. **[Host/Cluster]\(ホスト/クラスター\)** で、コレクター VM が実行するホストまたはクラスターを指定します。
5. ストレージで、コレクター VM の保存先を指定します。
6. **[Disk Format]\(ディスク フォーマット\)** で、ディスクの種類とサイズを指定します。
7. **[Network Mapping]\(ネットワーク マッピング\)** で、コレクター VM の接続先となるネットワークを指定します。 このネットワークには、Azure にメタデータを送信するためのインターネット接続が必要です。
8. 設定を確認し、**[Finish]\(完了\)** を選択します。

### <a name="identify-the-id-and-key-for-each-project"></a>各プロジェクトの ID とキーの特定

プロジェクトが複数ある場合は、各プロジェクトの ID とキーを特定する必要があります。 キーは、コレクターを実行して VM を検出するときに必要になります。

1. プロジェクト内で、**[開始]** > **[検出と評価]** > **[マシンの検出]** の順に選択します。
2. **[プロジェクトの資格情報をコピーします]** で、プロジェクトの ID とキーをコピーします。
    ![[プロジェクトの資格情報をコピーします]](./media/how-to-scale-assessment/copy-project-credentials.png)

### <a name="set-the-vcenter-statistics-level"></a>vCenter の統計レベルを設定する

コレクター アプライアンスでは、選択した仮想マシンに関する次の静的メタデータを検出します。

1. VM の表示名 (vCenter 上の)
2. VM のインベントリ パス (vCenter でのホスト/フォルダー)
3. IP アドレス
4. MAC アドレス
5. オペレーティング システム
5. コア、ディスク、NIC の数
6. メモリ サイズ、ディスク サイズ
7. 次の表に記載されている、VM、ディスク、およびネットワークのパフォーマンス カウンター。

1 回限りの検出の場合、次の表は、収集される正確なパフォーマンス カウンターと、特定のカウンターが収集されなかった場合に影響がある評価結果を示します。

継続的な検出の場合、同じカウンターがリアルタイム (20 秒間隔) で収集されますので、vCenter の統計情報レベルに依存関係がありません。 20 秒のサンプルからピーク時の値を選択して 15 分ごとに 1 つのデータ ポイントを作成するために、20 秒のサンプルをロールアップし、Azure に送信します。

|カウンター                                  |Level    |デバイスごとのレベル  |評価の影響                               |
|-----------------------------------------|---------|------------------|------------------------------------------------|
|cpu.usage.average                        | 1       |該当なし                |推奨される VM サイズとコスト                    |
|mem.usage.average                        | 1       |該当なし                |推奨される VM サイズとコスト                    |
|virtualDisk.read.average                 | 2       |2                 |ディスク サイズ、ストレージ コスト、VM サイズ         |
|virtualDisk.write.average                | 2       |2                 |ディスク サイズ、ストレージ コスト、VM サイズ         |
|virtualDisk.numberReadAveraged.average   | 1       |3                 |ディスク サイズ、ストレージ コスト、VM サイズ         |
|virtualDisk.numberWriteAveraged.average  | 1       |3                 |ディスク サイズ、ストレージ コスト、VM サイズ         |
|net.received.average                     | 2       |3                 |VM サイズとネットワーク コスト                        |
|net.transmitted.average                  | 2       |3                 |VM サイズとネットワーク コスト                        |

> [!WARNING]
> 1 回限りの検出の場合、統計レベルを高く設定した場合は、パフォーマンス カウンターを生成するのに最大 1 日かかります。 そのため、1 日経ってから検出を実行することをお勧めします。 継続的な検出のモデルの場合、アプライアンスが環境をプロファイルするのを検出開始後少なくとも 1 日待ってから、評価を作成します。

### <a name="run-the-collector-to-discover-vms"></a>コレクターを実行して VM を検出する

実行する必要があるそれぞれの検出について、コレクターを実行して指定のスコープの VM を検出します。 1 つずつ検出を実行します。 検出の同時実行はサポートされておらず、各検出は異なるスコープである必要があります。

1.  vSphere Client コンソールで、[VM] を右クリックして **[Open Console]\(コンソールを開く\)** を選択します。
2.  アプライアンスの設定で、言語、タイム ゾーン、パスワードを指定します。
3.  デスクトップにある **[Run collector]** ショートカットをクリックします。
4.  Azure Migrate コレクターで、**[Set up prerequisites]** を開きます。

    a.[サインオン URL] ボックスに、次のパターンを使用して、ユーザーが Pluralsight アプリケーションへのサインオンに使用する次の URL を入力します。 ライセンス条項に同意し、サード パーティの情報を確認します。

    VM がインターネットにアクセスできることをコレクターがチェックします。

    b. VM がプロキシ経由でインターネットにアクセスしている場合は、**[Proxy settings]** を選択し、プロキシ アドレスとリスニング ポートを指定します。 プロキシで認証が必要な場合は、資格情報を指定します。

    コレクター サービスが実行されていることをコレクターがチェックします。 このサービスは、既定でコレクター VM にインストールされています。

    c. VMware PowerCLI をダウンロードしてインストールします。

5.  **[Specify vCenter Server details]\(vCenter Server 詳細の指定\)** で、次の操作を行います。
    - vCenter Server の名前 (FQDN) または IP アドレスを指定します。
    - **[ユーザー名]** と **[パスワード]** で、コレクターが vCenter Server の VM を検出するために使用する読み取り専用の資格情報を指定します。
    - **[Select scope]\(スコープの選択\)** で、VM 検出のスコープを選択します。 コレクターは、指定されたスコープ内の VM のみを検出できます。 スコープは、指定のフォルダー、データセンター、またはクラスターに設定できます。 VM の数は 1,000 台を超えないようにします。

6.  **[Specify migration project]\(移行プロジェクトの指定\)** で、プロジェクトの ID とキーを指定します。 ID とキーをコピーしなかった場合は、コレクター VM から Azure Portal を開きます。 プロジェクトの **[概要]** ページで、**[マシンの検出]** を選択して値をコピーします。  
7.  **[View collection progress]** で検出プロセスを監視し、VM から収集されたメタデータがスコープ内にあることを確認します。 コレクターがおおよその検出時間を表示します。


#### <a name="verify-vms-in-the-portal"></a>ポータル内での VM の特定

1 回限りの検出の場合、検出時間は検出している VM の数によって異なります。 一般に、100 個の VM であれば、コレクターの実行終了後、構成とパフォーマンスのデータ収集が完了するまで約 1 時間かかります。 検出が行われたらすぐに評価を作成できます (パフォーマンス ベースの評価とオンプレミスの状況通りの評価の両方)。

継続的な検出 (プレビュー段階) では、コレクターは継続的にオンプレミス環境をプロファイルし、1 時間間隔でパフォーマンス データの送信を続行します。 検出を開始して 1 時間経過すると、ポータルでマシンを確認できます。 VM のパフォーマンス ベースの評価を作成する前に、少なくとも 1 日待つことを強くお勧めします。

1. 移行プロジェクト内で、**[管理]** > **[マシン]** の順にクリックします。
2. 検出対象の VM がポータルに表示されていることを確認します。


## <a name="next-steps"></a>次の手順

- 評価のために[グループを作成する](how-to-create-a-group.md)方法を確認します。
- 評価の計算方法の[詳細を確認](concepts-assessment-calculation.md)します。
