---
title: ネットワーク トラフィックをルーティングする - Azure Portal | Microsoft Docs
description: Azure Portal を使用してルート テーブルでネットワーク トラフィックをルーティングする方法について説明します。
services: virtual-network
documentationcenter: virtual-network
author: jimdial
manager: jeconnoc
editor: ''
tags: azure-resource-manager
ms.assetid: ''
ms.service: virtual-network
ms.devlang: azurecli
ms.topic: article
ms.tgt_pltfrm: virtual-network
ms.workload: infrastructure
ms.date: 03/05/2018
ms.author: jdial
ms.custom: ''
ms.openlocfilehash: 4cc814e1fd3ee8979662695f9dec3dcce335dc2a
ms.sourcegitcommit: 168426c3545eae6287febecc8804b1035171c048
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/08/2018
---
# <a name="route-network-traffic-with-a-route-table-using-the-azure-portal"></a>Azure Portal を使用してルート テーブルでネットワーク トラフィックをルーティングする

既定では、仮想ネットワーク内のすべてのサブネット間でトラフィックが自動的にルーティングされます。 Azure の既定のルーティングは、独自のルートを作成して上書きすることができます。 カスタム ルートを作成する機能は、たとえば、サブネット間でファイアウォールを越えてトラフィックをルーティングしたい場合に便利です。 この記事では、次の方法について説明します。

> [!div class="checklist"]
> * ルート テーブルの作成
> * ルートの作成
> * 仮想ネットワーク サブネットへのルート テーブルの関連付け
> * ルーティングのテスト
> * ルーティングのトラブルシューティング

Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) を作成してください。

## <a name="log-in-to-azure"></a>Azure にログインする 

Azure Portal (http://portal.azure.com) にログインします。

## <a name="create-a-route-table"></a>ルート テーブルの作成

既定では、仮想ネットワークのすべてのサブネット間でトラフィックがルーティングされます。 Azure の既定のルートの詳細については、「[システム ルート](virtual-networks-udr-overview.md)」を参照してください。 Azure の既定のルーティングを上書きするには、ルートを含むルート テーブルを作成し、そのルート テーブルを仮想ネットワーク サブネットに関連付けます。

1. Azure Portal の左上隅にある **[+ リソースの作成]** を選択します。
2. **[ネットワーク]**、**[ルート テーブル]** の順に選択します。
3. ご使用の **[サブスクリプション]** を選択し、以下の情報を選択または入力して、**[作成]** を選択します。
 
    ![ルート テーブルを作成する](./media/tutorial-create-route-table-portal/create-route-table.png) 

## <a name="create-a-route"></a>ルートの作成

ルート テーブルには、0 個以上のルートが含まれます。 

1. ポータルの上部にある *[Search resources, services, and docs]\(リソース、サービス、ドキュメントの検索\)* ボックスで、「*myRouteTablePublic*」の入力を開始します。 検索結果に **myRouteTablePublic** が表示されたら、それを選択してください。
2. 次の図に示すように、**[設定]** で **[ルート]** を選択し、**[+ 追加]** を選択します。

    ![ルートを追加する](./media/tutorial-create-route-table-portal/add-route.png) 
 
4. **[ルートの追加]** で以下の情報を選択または入力し、**[OK]** を選択します。
    - **[ルート名]**: *ToPrivateSubnet*
    - **[アドレス プレフィックス]**: 10.0.1.0/24
    - **[次ホップの種類]**: **[仮想アプライアンス]** を選択します。
    - **[次ホップ アドレス]**: 10.0.2.4

    このルートでは、10.0.1.0/24 アドレス プレフィックス宛のすべてのトラフィックが、IP アドレス 10.0.2.4 のネットワーク仮想アプライアンス経由でリダイレクトされます。 ネットワーク仮想アプライアンスと指定されたアドレス プレフィックスを持つサブネットは、以降の手順で作成されます。 サブネット間でトラフィックが直接ルーティングされる Azure の既定のルーティングは上書きされます。 それぞれのルートで次ホップの種類が指定されます。 次ホップの種類は、Azure に対してトラフィックのルーティング方法を指示します。 この例では、次ホップの種類は *VirtualAppliance* です。 Azure で使用できるすべての次ホップの種類の詳細については、[次ホップの種類](virtual-networks-udr-overview.md#custom-routes)に関するページをご覧ください。

## <a name="associate-a-route-table-to-a-subnet"></a>サブネットへのルート テーブルの関連付け

ルート テーブルをサブネットに関連付ける前に、仮想ネットワークとサブネットを作成する必要があります。

1. Azure Portal の左上隅にある **[+ リソースの作成]** を選択します。
2. **[ネットワーク]** を選択してから、**[仮想ネットワーク]** を選択します。
3. **[仮想ネットワークの作成]** で、以下の情報を選択または入力して、**[作成]** を選択します。
    
    - **[名前]**: *myVirtualNetwork*
    - **[アドレス空間]**: *10.0.0.0/16*
    - **[サブスクリプション]**: ご使用のサブスクリプションを選択します。
    - **[リソース グループ]**: **[既存のものを使用]** を選択し、**[myResourceGroup]** を選択します。
    - **[場所]**: "*米国東部*" を選択します
    - **[サブネット名]**: "*パブリック*"
    - **[アドレス範囲]**: *10.0.0.0/24*

4. ポータルの上部にある **[Search resources, services, and docs]\(リソース、サービス、ドキュメントの検索\)** ボックスで、「*myVirtualNetwork*」の入力を開始します。 検索結果に **[myVirtualNetwork]** が表示されたら、それを選択します。
5. 2 つの追加サブネットを仮想ネットワークに追加します。 次の図に示すように、**[設定]** で **[サブネット]** を選択し、**[+ サブネット]** を選択します。

    ![サブネットの追加](./media/tutorial-create-route-table-portal/add-subnet.png) 

6. 以下の情報を選択または入力し、**[OK]** を選択します。
    - **[名前]**: プライベート
    - **[アドレス空間]**: *10.0.1.0/24*

7. 手順 5. と 6. を繰り返して、次の情報を指定します。
    - **[名前]**: DMZ
    - **[アドレス空間]**: *10.0.2.0/24*

1 つのルート テーブルを 0 個以上のサブネットに関連付けることができます。 サブネットには、0 個または 1 個のルート テーブルを関連付けることができます。 サブネットからの送信トラフィックは、Azure の既定のルート、およびサブネットに関連付けるルート テーブルに追加した任意のカスタム ルートに基づいてルーティングされます。 *myRouteTablePublic* ルート テーブルを "*パブリック*" サブネットに関連付けます。

1. **myVirtualNetwork - Subnets** ボックスは、前の手順を完了した後に表示されます。 **[設定]** で **[サブネット]** を選択し、**[パブリック]** を選択します。
2. 次の図に示すように、**[ルート テーブル]** を選択し、**[MyRouteTablePublic]** を選択します。

    ![ルート テーブルを関連付ける](./media/tutorial-create-route-table-portal/associate-route-table.png) 

3. **[保存]** を選択します。

## <a name="test-routing"></a>ルーティングをテストする

ルーティングをテストするために、仮想マシンを作成します。この仮想マシンは、前の手順で作成したルートが経由するネットワーク仮想アプライアンスとして機能します。 ネットワーク仮想アプライアンスを作成したら、仮想マシンを "*パブリック*" サブネットおよび "*プライベート*" サブネットにデプロイします。 その後、"*パブリック*" サブネットから "*プライベート*" サブネットへのトラフィックを、ネットワーク仮想アプライアンスを経由するようにルーティングします。

### <a name="create-a-network-virtual-appliance"></a>ネットワーク仮想アプライアンスを作成する

前の手順では、次ホップの種類としてネットワーク仮想アプライアンスを指定したルートを作成しました。 ネットワーク アプリケーションを実行する仮想マシンは、ネットワーク仮想アプライアンスと呼ばれることがよくあります。 運用環境でデプロイするネットワーク仮想アプライアンスは、ほとんどの場合、構成済みの仮想マシンです。 [Azure Marketplace](https://azuremarketplace.microsoft.com/marketplace/apps/category/networking?search=network%20virtual%20appliance&page=1) では、いくつかのネットワーク仮想アプライアンスを入手できます。 この記事では、基本的な仮想マシンを作成します。

1. Azure Portal の左上隅にある **[+ リソースの作成]** を選択します。
2. **[コンピューティング]**、**[Windows Server 2016 Datacenter]** の順に選択します。 別のオペレーティング システムを選択することもできますが、以降の手順では、**[Windows Server 2016 Datacenter]** を選択したという前提で説明します。 
3. **[基本]** で以下の情報を選択または入力し、**[OK]** を選択します。
    - **[名前]**: *myVmNva*
    - **[リソース グループ]**: **[既存のものを使用]** を選択し、*[myResourceGroup]* を選択します。
    - **[場所]**: *[米国東部]* を選択します。

    入力した**ユーザー名**と**パスワード**は、以降の手順で使用されます。 パスワードは 12 文字以上で、[定義された複雑さの要件](../virtual-machines/windows/faq.md?toc=%2fazure%2fvirtual-network%2ftoc.json#what-are-the-password-requirements-when-creating-a-vm)を満たす必要があります。 選択した**場所**および**サブスクリプション**は、仮想ネットワークの場所およびサブスクリプションと同じである必要があります。 仮想ネットワークが作成されているリソース グループと同じリソース グループを選択することは必須ではありませんが、このチュートリアルでは同じリソース グループを選択しています。
4. **[サイズの選択]** で、VM サイズを選択します。
5. **[設定]** で以下の情報を選択または入力し、**[OK]** を選択します。
    - **[仮想ネットワーク]**: **[myVirtualNetwork]** が選択されていることを確認します。 選択されていない場合は、**[仮想ネットワーク]** を選択し、**[仮想ネットワークの選択]** で **[myVirtualNetwork]** を選択します。
    - **[サブネット]**: **[サブネット]** を選択し、**[サブネットの選択]** で **[DMZ]** を選択します。
    - **[パブリック IP アドレス]**: **[パブリック IP アドレス]** を選択し、**[パブリック IP アドレスの選択]** で **[なし]** を選択します。 この仮想マシンはインターネットと接続されないため、パブリック IP アドレスが割り当てられていません。
6. **[概要]** の **[作成]** で **[作成]** を選択して、仮想マシンのデプロイを開始します。

仮想マシンの作成には、数分かかります。 仮想マシンの作成が完了し、仮想マシンに関する情報を示すボックスが表示されるまでは、次の手順に進まないでください。

Azure では仮想マシンが作成されるとき、[ネットワーク インターフェイス](virtual-network-network-interface.md)も *DMZ* サブネットに作成され、仮想マシンにアタッチされます。 各 Azure ネットワーク インターフェイスに対して IP 転送を有効にする必要があります。ネットワーク インターフェイスは、自身に割り当てられていないすべての IP アドレス宛てのトラフィックを転送します。

1. 次の図に示すように、仮想マシンの作成後、そのマシンに対して表示されたボックスの **[設定]** で **[ネットワーク]** を選択し、**[myvmnva158]** (ユーザーの仮想マシンに対して Azure が作成したネットワーク インターフェイスについては、**myvmnva** の後ろの番号が異なります) を選択します。

    ![仮想マシンのネットワーク](./media/tutorial-create-route-table-portal/virtual-machine-networking.png) 

    *DMZ* サブネット内にネットワーク仮想アプライアンスを作成したとき、ネットワーク インターフェイスが自動的に作成され、仮想マシンにアタッチされた後、プライベート IP アドレス *10.0.2.4* が割り当てられました。 

2. 次の図に示すように、**[設定]** で **[IP 構成]** を選択し、**[IP 転送]** に **[有効]** を選択して、**[保存]** を選択します。

    ![IP 転送を有効にする](./media/tutorial-create-route-table-portal/enable-ip-forwarding.png) 

### <a name="create-virtual-machines"></a>仮想マシンを作成する

後の手順で、"*パブリック*" サブネットからのトラフィックがネットワーク仮想アプライアンス経由で "*プライベート*" サブネットにルーティングされていることを検証できるように、仮想ネットワークに 2 つの仮想マシンを作成します。

「[ネットワーク仮想アプライアンスを作成する](#create-a-network-virtual-appliance)」の手順 1. ～ 6. を実行します。 次の変更を除き、手順 3. と 5. では同じ設定を使用します。

|仮想マシン   |Name      |サブネット      | パブリック IP アドレス     |
|---------         |--------- | -----------|---------              |
|仮想マシン 1 | myVmWeb  | パブリック     | ポータルの既定値を使用 |
|仮想マシン 2 | myVmMgmt | プライベート    | ポータルの既定値を使用 |

*myVmMgmt* 仮想マシンはユーザーが作成できますが、*myVmWeb* 仮想マシンは Azure によって作成されます。 Azure で両方の仮想マシンの作成が完了するまで、以降の手順に進まないでください。

### <a name="route-traffic-through-a-network-virtual-appliance"></a>ネットワーク仮想アプライアンス経由のトラフィックのルーティング

1. ポータルの上部にある *[検索]* ボックスで、「*myVmMgmt*」の入力を開始します。 検索結果に **[myVmMgmt]** が表示されたら、それを選択します。
2. 次の図に示すように、**[接続]** を選択して *myVmMgmt* 仮想マシンへのリモート デスクトップ接続を作成します。

    ![仮想マシンへの接続](./media/tutorial-create-route-table-portal/connect-to-virtual-machine.png)  

3. VM に接続するには、ダウンロードした RDP ファイルを開きます。 メッセージが表示されたら、**[Connect]** を選択します。
4. 仮想マシンの作成時に指定したユーザー名とパスワードを入力し (仮想マシンの作成時に入力した資格情報を指定するために、**[More choices]\(その他の選択肢\)**、**[Use a different account]\(別のアカウントを使用する\)** の選択が必要になる場合があります)、**[OK]** を選択します。
5. サインイン処理中に証明書の警告が表示される場合があります。 **[はい]** を選択して、接続処理を続行します。
6. 後の手順では、ルーティングのテストに tracert.exe コマンドを使用します。 tracert は ICMP を使用しますが、ICMP は Windows ファイアウォールで拒否されます。 コマンド プロンプトから次のコマンドを入力して、Windows ファイアウォールで ICMP を有効にします。

    ```
    netsh advfirewall firewall add rule name=Allow-ping protocol=icmpv4 dir=in action=allow
    ```

    この記事では tracert を使用してルーティングをテストしていますが、運用環境のデプロイでは Windows ファイアウォールで ICMP を許可することは推奨されません。
7. [IP 転送の有効化](#enable-ip-forwarding)に関するセクションで、仮想マシンのネットワーク インターフェイスに対して Azure 内での IP 転送を有効にしました。 仮想マシン内では、オペレーティング システム、または仮想マシン内で実行中のアプリケーションも、ネットワーク トラフィックを転送できる必要があります。 運用環境にネットワーク仮想アプライアンスをデプロイすると、アプライアンスは、通常、トラフィックを転送する前に、フィルター処理、ログ記録などの機能を実行します。 ただし、この記事では、オペレーティング システムは、受信したすべてのトラフィックを単純に転送するものとします。 *myVmMgmt* 仮想マシンから次の手順を実行し、*myVmNva* のオペレーティング システム内で IP 転送を有効にします。

    コマンド プロンプトから次のコマンドを使用して、*myVmNva* 仮想マシンにリモート デスクトップ接続します。

    ``` 
    mstsc /v:myvmnva
    ```
    
    オペレーティング システム内で IP 転送を有効にするには、PowerShell で次のコマンドを入力します。

    ```powershell
    Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters -Name IpEnableRouter -Value 1
    ```
    
    仮想マシンを再起動します。これによりリモート デスクトップ セッションが切断されます。
8. *myVmMgmt* 仮想マシンに接続されている状態で、*myVmNva* 仮想マシンの再起動後、次のコマンドを使用して、*myVmWeb* 仮想マシンへのリモート デスクトップ セッションを作成します。

    ``` 
    mstsc /v:myVmWeb
    ```
    
    コマンド プロンプトから次のコマンドを入力して、Windows ファイアウォールで ICMP を有効にします。

    ```
    netsh advfirewall firewall add rule name=Allow-ping protocol=icmpv4 dir=in action=allow
    ```

9. *myVmWeb* 仮想マシンから *myVmMgmt* 仮想マシンへのネットワーク トラフィックのルーティングをテストするには、コマンド プロンプトから次のコマンドを入力します。

    ```
    tracert myvmmgmt
    ```

    応答は次の例のようになります。
    
    ```
    Tracing route to myvmmgmt.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.1.4]
    over a maximum of 30 hops:
        
    1    <1 ms     *        1 ms  10.0.2.4
    2     1 ms     1 ms     1 ms  10.0.1.4
        
    Trace complete.
    ```
      
    最初のホップが 10.0.2.4 であることを確認できます。これは、ネットワーク仮想アプライアンスのプライベート IP アドレスです。 2 番目のホップは 10.0.1.4 です。これは、*myVmMgmt* 仮想マシンのプライベート IP アドレスです。 *myRouteTablePublic* ルート テーブルに追加され、"*パブリック*" サブネットに関連付けられているルートにより、Azure はトラフィックを "*プライベート*" サブネットに直接ルーティングするのではなく、NVA 経由でルーティングするようになります。
10.  *myVmWeb* 仮想マシンへのリモート デスクトップ セッションを閉じます。*myVmMgmt* 仮想マシンにはまだ接続されたままです。
11. *myVmMgmt* 仮想マシンから *myVmWeb* 仮想マシンへのネットワーク トラフィックのルーティングをテストするには、コマンド プロンプトから次のコマンドを入力します。

    ```
    tracert myvmweb
    ```

    応答は次の例のようになります。

    ```
    Tracing route to myvmweb.vpgub4nqnocezhjgurw44dnxrc.bx.internal.cloudapp.net [10.0.0.4]
    over a maximum of 30 hops:
    
    1     1 ms     1 ms     1 ms  10.0.0.4
    
    Trace complete.
    ```

    トラフィックが *myVmMgmt* 仮想マシンから *myVmWeb* 仮想マシンに直接ルーティングされているのがわかります。 既定では、サブネット間でトラフィックが直接ルーティングされます。
12. *myVmMgmt* 仮想マシンへのリモート デスクトップ セッションを閉じます。

## <a name="troubleshoot-routing"></a>ルーティングのトラブルシューティング

前の手順で説明したように、Azure によって適用される既定のルートは、必要に応じて独自のルートで上書きすることができます。 場合によっては、トラフィックが意図したとおりにルーティングされないことがあります。 Azure Network Watcher の[次ホップ](../network-watcher/network-watcher-check-next-hop-portal.md)機能を使用すると、2 つの仮想マシン間でトラフィックがどのようにルーティングされているかを確認できます。 

1. ポータルの上部にある *[検索]* ボックスで、「*Network Watcher*」の入力を開始します。 検索結果に **[Network Watcher]** が表示されたら、それを選択します。
2. **[ネットワーク診断ツール]** で、**[次ホップ]** を選択します。
3. *myVmWeb* (10.0.0.4) 仮想マシンから *myVmMgmt* (10.0.1.4) 仮想マシンへのトラフィック ルーティングをテストするには、ご使用のサブスクリプションを選択し、次の図に示すように情報 (**ネットワーク インターフェイス**名が少し異なります) を入力して、**[次ホップ]** を選択します。

    ![次のホップ](./media/tutorial-create-route-table-portal/next-hop.png)  

    この**結果**出力により、*myVmWeb* から *myVmMgmt* へのトラフィックの次ホップの IP アドレスが 10.0.2.4 (*myVmNva* 仮想マシン) で、次ホップの種類が *VirtualAppliance* であること、また、ルーティングを発生させるルート テーブルが *myRouteTablePublic* であることがわかります。

各ネットワーク インターフェイスの有効なルートは、Azure の既定のルートと、ユーザーが定義した任意のルートの組み合わせとなります。 仮想マシンのネットワーク インターフェイスに対して有効なすべてのルートを表示するには、次の手順を実行します。

1. ポータルの上部にある *[検索]* ボックスで、「*myVmWeb*」の入力を開始します。 検索結果に **[myVmWeb]** が表示されたら、それを選択します。
2. **[設定]** で **[ネットワーク]** を選択し、**[myvmweb369]** (ユーザーの仮想マシンに対して Azure が作成したネットワーク インターフェイスについては、**myvmweb** の後の番号が異なります) を選択します。
3. 次の図に示すように、**[サポート + トラブルシューティング]** で **[有効なルート]** を選択します。

    ![有効なルート](./media/tutorial-create-route-table-portal/effective-routes.png) 

    Azure の既定のルートと、*myRouteTablePublic* ルート テーブルに追加したルートが表示されます。 Azure がルート一覧からルートを選択する方法の詳細については、[Azure がルートを選択するしくみ](virtual-networks-udr-overview.md#how-azure-selects-a-route)に関するページをご覧ください。

## <a name="clean-up-resources"></a>リソースのクリーンアップ

リソース グループとそれに含まれるすべてのリソースが不要になったら、それらを削除します。 

1. ポータル上部の **[検索]** ボックスに「*myResourceGroup*」と入力します。 検索結果に **[myResourceGroup]** が表示されたら、それを選択します。
2. **[リソース グループの削除]** を選択します。
3. **[TYPE THE RESOURCE GROUP NAME:]\(リソース グループ名を入力してください:\)** に「*myResourceGroup*」と入力し、**[削除]** を選択します。

## <a name="next-steps"></a>次の手順

この記事では、ルート テーブルを作成し、それをサブネットに関連付けました。 トラフィックをパブリック サブネットからプライベート サブネットにルーティングするネットワーク仮想アプライアンスを作成しました。 仮想ネットワーク内では多数の Azure リソースをデプロイできますが、一部の Azure PaaS サービスのリソースは仮想ネットワークにデプロイできなません。 ただし、一部の Azure PaaS サービスのリソースへのアクセスを、仮想ネットワーク サブネットからのトラフィックのみに制限できます。 Azure PaaS リソースへのネットワーク アクセスを制限する方法を確認するには、次のチュートリアルに進みます。

> [!div class="nextstepaction"]
> [PaaS リソースへのネットワーク アクセスを制限する](virtual-network-service-endpoints-configure.md#azure-portal)
