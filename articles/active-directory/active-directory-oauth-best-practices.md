<properties
	pageTitle="Azure Active Directory での OAuth 2.0 のベスト プラクティス | Microsoft Azure"
	description="この記事では、Azure Active Directory で OAuth 2.0 を使用するアプリケーションを開発するためのベスト プラクティスについて説明します。"
	services="active-directory"
	documentationCenter=".net"
	authors="priyamohanram"
	manager="mbaldwin"
	editor=""/>

<tags
	ms.service="active-directory"
	ms.workload="identity"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="05/31/2016"
	ms.author="priyamo"/>


# Azure Active Directory での OAuth 2.0 のベスト プラクティス

[AZURE.INCLUDE [active-directory-protocols](../../includes/active-directory-protocols.md)]

## 状態パラメーターの使用

`state` パラメーターは、ランダムに生成される再利用できない値 (通常は GUID) で、クライアントが要求で送信します。省略可能なパラメーターですが、認証コードの要求に含めることを強くお勧めします。応答にも同じ `state` 値が含まれ、アプリケーションは応答を使用する前に state 値が等しいことを確認する必要があります。

`state` パラメーターは、クライアントに対するクロスサイト リクエスト フォージェリ (CSRF) 攻撃を検出するのに役立ちます。CSRF 攻撃の詳細については、「OAuth 2.0 Authorization Framework (OAuth 2.0 承認フレームワーク)」の「[Cross-Site Request Forgery (クロスサイト リクエスト フォージェリ)](https://tools.ietf.org/html/rfc6749#section-10.12)」を参照してください。

## アクセス トークンのキャッシュ

クライアント アプリケーションからのネットワーク呼び出しとこれに関連する遅延時間を最小限に抑えるために、クライアント アプリケーションは OAuth 2.0 応答で指定されているトークンの有効期間中、アクセス トークンをキャッシュする必要があります。トークンの有効期間を決定するには、`expires_in` または `expires_on` のいずれのパラメーター値を使用します。

Web API リソースから `invalid_token` エラー コードが返された場合、リソースが、トークンの有効期限が切れていると判断した可能性があります。クライアントとリソースのクロック時間が異なる (「時間のずれ」として知られている) 場合、トークンがクライアント キャッシュからクリアされる前に、リソースがトークンの期限が切れていると認識することがあります。このような場合は、計算上の有効期間内である場合でも、キャッシュからトークンをクリアします。

## 更新トークンの処理

更新トークンには、指定された有効期間はありません。通常、更新トークンの有効期間は比較的長いです。ただし、場合によっては、更新トークンの有効期限が切れる、失効する、または目的の操作のための十分な特権がないことがあります。クライアント アプリケーションは、トークン発行エンドポイントから返されるエラーを予期して正しく処理する必要があります。

更新トークン エラーを含む応答を受信したときは、現在の更新トークンを破棄し、新しい認証コードまたはアクセス トークンを要求します。特に、認証コード付与フロー内で更新トークンを使用しているときに `interaction_required` または `invalid_grant` エラー コードを含む応答を受信した場合は、更新トークンを破棄し、新しい認証コードを要求します。

## リソース ID パラメーターの検証

クライアント アプリケーションは、応答に含まれる `resource_id` パラメーターの値を確認する必要があります。確認しないと、悪意のあるサービスが、権限の昇格攻撃を強制的に実行できる可能性があります。

 攻撃を防止するための推奨方法として、resource\_id と、アクセスしている Web API URL のベースが一致していることを確認します。たとえば、https://service.contoso.com/data にアクセスしている場合は、`resource_id` は https://service.contoso.com/ になります。クライアント アプリケーションは、ID を検証する信頼性の高い代替方法がない限り、ベース URL ではじまらない `resource_id` を拒否する必要があります。

## トークン発行と再試行ガイドライン

Azure AD は、クライアントが照会できる複数のトークン発行エンドポイントをサポートしています。次のガイドラインを使用して、ネットワークまたはサーバーの予期しないエラーを処理する、これらのエンドポイントの再試行ロジックを実装します。

通常、再試行に応答する障害では、Azure AD エンドポイントへの要求に対して HTTP 500 番台のエラー コードが返されます。一部のシナリオでは、クライアントは、Azure AD に対して自動要求を行うアプリケーションまたはサービスです。WS-Federation プロトコルを使用する Web ベースのフェデレーションなどの他のシナリオでは、クライアントは Web ブラウザーであり、エンドユーザーは手動で再試行する必要があります。

### HTTP 500 番台のエラー応答に基づく再試行ロジックの実装

Active Directory の Access Control Service (ACS) から HTTP 500 番台のエラーが返されるときは、再試行ロジックを強く推奨します。次のトピックがあります。

- HTTP エラー 500 - 内部サーバー エラー
- HTTP エラー 502 - ゲートウェイが無効
- HTTP エラー 503 - サービス利用不可
- HTTP エラー 504 - ゲートウェイ タイムアウト

再試行ロジックで個々の HTTP コードを明示的にリストすることができますが、HTTP 500 番台のエラーのいずれかが返された場合に再試行ロジックを呼び出すだけで十分です。

通常、HTTP 400 番台のエラー コードが返されるときは、再試行ロジックは推奨されません。ACS からの 400 番台の HTTP エラー応答コードは、要求が無効であり改訂する必要があることを意味します。

再試行ロジックは、ACS90005 などの ACS エラー コードではなく、HTTP 504 (外部サーバー タイムアウト) など、つまり HTTP 500 番台のエラー コードの HTTP エラー コードによってトリガーする必要があります。ACS エラー コードは情報提供のためのコードであり、変更される可能性があります。

### 再試行では、最適なフロー制御のためにバックオフ タイマーを使用する必要があります。

HTTP 500 番台のエラーを受信した場合、クライアントは、要求を再試行する前に待機する必要があります。最良の結果を得るために、後続の再試行ごとにこの時間を長くすることをお勧めします。この方法により、一時的なエラーをすばやく解決しつつ、解決に時間がかかるネットワークまたはサーバーの一時的な問題に対する要求の処理率を最適化することができます。

たとえば、再試行 1 回目: 1 秒、再試行 2 回目: 2 秒、再試行 3 回目: 4 秒 (以降も同様) のように、インスタンスごとに再試行までの遅延時間を指数関数的に増やす、指数バックオフ タイマーを使用します。

再試行の回数と各再試行までの時間は、ユーザー エクスペリエンス要件に基づいて調整します。ただし、最大で 5 回の再試行を 5 分の間に行うことをお勧めします。タイムアウトによって発生したエラーは、解決に時間がかかります。

## 次のステップ

[Active Directory Authentication Libraries (ADAL) (Azure Active Directory 認証ライブラリ (ADAL))](active-directory-authentication-libraries.md)

<!---HONumber=AcomDC_0608_2016-->