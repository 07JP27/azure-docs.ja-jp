---
title: "Azure AD アプリケーション プロキシ コネクタを理解する | Microsoft Docs"
description: "Azure AD アプリケーション プロキシ コネクタの基本について説明します。"
services: active-directory
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/02/2017
ms.author: kgremban
ms.translationtype: HT
ms.sourcegitcommit: bde1bc7e140f9eb7bb864c1c0a1387b9da5d4d22
ms.openlocfilehash: 0c9adf369dfecc25d1bf3dc8a77cb3778e867af5
ms.contentlocale: ja-jp
ms.lasthandoff: 07/21/2017

---

# <a name="understand-azure-ad-application-proxy-connectors"></a>Azure AD アプリケーション プロキシ コネクタを理解する

コネクタとは、Azure AD アプリケーション プロキシを実行可能にするもののことです。 コネクタはシンプルで、デプロイと管理が簡単なうえに、非常に強力です。 この記事では、コネクタの詳細と動作、およびデプロイを最大限に活用するためのベスト プラクティスについて説明します。 

## <a name="deployment"></a>デプロイ

アプリケーション プロキシは、社内ネットワークに "コネクタ" と呼ばれる Windows Server サービスをインストールすることによって機能します。 高可用性や拡張性のニーズに応じて、複数のコネクタをインストールしても構いません。 コネクタ 1 つから始めて、必要に応じてさらに追加することができます。 コネクタをインストールするたびに、テナントで機能するコネクタのプールに追加されます。

アプリケーションをホストしているのと同じサーバーにはコネクタをインストールしないことをお勧めします。 ただし、アプリケーションには、コネクタをインストールするサーバーからアクセスできる必要があります。


## <a name="maintenance"></a>メンテナンス 
コネクタとサービスは、高可用性のすべてのタスクに対処します。 コネクタは動的に追加したり削除できます。 新しい要求は、受信するたびにその時点で使用できるコネクタのいずれかにルーティングされます。 コネクタは、一時的に使用できない場合はトラフィックに応答しません。

コネクタはステートレスであり、サービス設定への接続とコネクタを認証する証明書以外には、コンピューターに構成データが格納されません。 サービスに接続すると、すべての必要な構成データをプルして、数分ごとに更新します。
また、サーバーをポーリングして、新しいバージョンのコネクタがあるかどうかを調べます。 新しいバージョンが見つかると、コネクタは自身を更新します。

イベント ログとパフォーマンス カウンターを使用するか、Azure Portal の [アプリケーション プロキシ] で、コネクタを実行しているコンピューターからコネクタを監視することができます。

 ![Azure AD アプリケーション プロキシ コネクタ](./media/application-proxy-understand-connectors/app-proxy-connectors.png)

使用されていないコネクタを手動で削除する必要はありません。 コネクタが動作してサービスに接続すると、アクティブな状態が保たれます。 使用していないコネクタは_非アクティブ_としてタグ付けされ、非アクティブな状態が 10 日間続くと削除されます。 

## <a name="automatic-updates"></a>自動更新

Azure AD では、デプロイしたすべてのコネクタの自動更新をサポートしています。 アプリケーション プロキシ コネクタ アップデーター サービスを実行している限り、コネクタは自動更新されます。 サーバーにコネクタ アップデーター サービスが見つからない場合は、[コネクタを再インストール](active-directory-application-proxy-enable.md)して更新プログラムを取得する必要があります。 複数のコネクタを持つテナントの場合、環境でのダウンタイムを避けるために、自動更新では各グループで一度に 1 つのコネクタが対象となります。 

お使いのコネクタの番まで自動更新を待てない場合は、手動アップグレードを実行できます。 コネクタが配置されたサーバーの[コネクタ ダウンロード ページ](https://download.msappproxy.net/subscription/d3c8b69d-6bf7-42be-a529-3fe9c2e70c90/connector/download)に移動し、**[ダウンロード]** を選択します。 これで、ローカル コネクタのアップグレードが開始されます。 

コネクタの更新を行う際、次のような場合ダウンタイムが生じることがあります。  
- コネクタが 1 つしかない場合:  このようなダウンタイムを回避して可用性を改善するには、2 つめのコネクタをインストールして[コネクタ グループを作成する](active-directory-application-proxy-connectors-azure-portal.md)ことをお勧めします。  
- 更新の開始時にコネクタがトランザクションの処理中であった場合:  ブラウザーにより自動で操作が再試行されますが、ページの更新を行っても構いません。 要求が再送信されると、トラフィックはバックアップ コネクタへルーティングされます。

## <a name="outbound-only-networking"></a>送信専用ネットワーク
コネクタは送信要求のみを送信するため、接続は常にコネクタによって開始されます。 セッションが確立するとトラフィックは両方向に流れるため、受信ポートを開く必要はありません。

送信トラフィックは、アプリケーション プロキシ サービスと公開済みアプリケーションに送信されます。 サービスへのトラフィックは、いくつかの異なるポート番号の Azure データセンターに送信されます。 使用されるポートの詳細については、[Azure Portal でのアプリケーション プロキシの有効化](active-directory-application-proxy-enable.md)に関するページをご覧ください。

送信トラフィックしかないため、コネクタ間で負荷分散を設定したり、ファイアウォール経由で受信アクセスを構成したりする必要はありません。

送信トラフィックのファイアウォール規則を構成する方法の詳細については、「[既存のオンプレミス プロキシ サーバーと連携する](application-proxy-working-with-proxy-servers.md)」を参照してください。

[Azure AD アプリケーション プロキシ コネクタ ポート テスト ツール](https://aadap-portcheck.connectorporttest.msappproxy.net/)を使った、コネクタがアプリケーション プロキシ サービスにアクセスできることを確認します。 少なくとも、米国中部リージョンと自分に最も近いリージョンにすべて緑色のチェックマークが表示されていることを確認します。 さらに、緑色のチェックマークが多いほど、リカバリ性が高いことを意味します。 

## <a name="network-security"></a>ネットワークのセキュリティ

コネクタは、アプリケーション プロキシ サービスとバックエンド アプリケーションの両方に要求を送信することを許可するネットワーク上の任意の場所にインストールできます。 コネクタは、インストール先が企業ネットワーク内や非武装地帯 (DMZ) 内、あるいはクラウドで実行されている仮想マシン上であっても正常に動作します。 ただし、コネクタを実行するコンピューターもアプリにアクセスできる必要があります。

DMZ へのデプロイは、より複雑です。 しかし、DMZ 内にコネクタをデプロイする理由の 1 つとして、バックエンド アプリケーション ロード バランサーや侵入検知システムなどの他のインフラストラクチャを使用できることが挙げられます。

## <a name="domain-joining"></a>ドメイン参加

コネクタは、ドメインに参加していないコンピューターで実行できます。 ただし、統合 Windows 認証 (IWA) を使用するアプリケーションへのシングル サインオン (SSO) を行う場合は、ドメイン参加済みのコンピューターが必要です。 この場合、コネクタを実行するコンピューターは、公開済みアプリケーションの関連ユーザーの代わりに [Kerberos](https://web.mit.edu/kerberos) の制約付き委任を実行できるドメインに参加する必要があります。

コネクタは、部分的な信頼関係のあるドメインやフォレスト、または読み取り専用ドメイン コントローラーに参加することもできます。

## <a name="connectors-on-hardened-environments"></a>制限の厳しい環境でのコネクタ

通常、コネクタのデプロイはとても簡単で、特別な構成は必要ありません。 ただし、考慮すべき特別な条件がいくつかあります。

* 送信トラフィックを制限している組織では、[必要なポートを開く](active-directory-application-proxy-enable.md#open-your-ports)必要があります。
* FIPS 準拠のコンピューターは、コネクタ サービス、コネクタ アップデーター サービス、およびそのインストーラーが証明書を生成して格納することを許可するよう、構成を変更する必要のある場合があります。
* ネットワーク要求を発行するプロセスに基づいて環境をロック ダウンしている組織では、コネクタ サービスとコネクタ アップデーター サービスの両方が、すべての必要なポートと IP アドレスにアクセスできることを確認する必要があります。
* 場合によっては、送信/転送プロキシにより証明書の双方向認証が中断されて、通信に失敗することがあります。

## <a name="connector-authentication"></a>コネクタの認証

セキュリティで保護されたサービスを提供する場合、コネクタはサービスに対して認証を行い、サービスはコネクタに対して認証を行う必要があります。 これを実行するには、コネクタが接続を開始するときにクライアント証明書とサーバー証明書を使用します。 こうすることで、管理者のユーザー名とパスワードがコネクタを実行するコンピューターに保存されることはありません。

使用する証明書は、アプリケーション プロキシ サービス固有のものです。 これらの証明書は新規登録時に作成され、コネクタによって数か月ごとに自動で更新されます。 

コネクタが数か月間サービスに接続していないと、証明書の有効期限が切れることがあります。 このような場合は、コネクタをアンインストールしてから再インストールして、登録をトリガーします。 次の PowerShell コマンドを実行できます。

```
Import-module AppProxyPSModule
Register-AppProxyConnector
```

## <a name="performance-and-scalability"></a>パフォーマンスと拡張性

オンライン サービスではスケールについてユーザーが気にする必要はありませんが、コネクタに関してはスケールが重要な要因になります。 ピーク時のトラフィックを処理するには十分なコネクタが必要です。 コネクタはステートレスであるため、ユーザー数やセッション数の影響を受けません。 その代わりに、要求数やペイロード サイズに反応します。 標準的な Web トラフィックの場合、平均的なコンピューターでは 1 秒間に数千件の要求を処理されます。 具体的な容量は、実際のコンピューターの特性によって異なります。

コネクタのパフォーマンスは、CPU とネットワークの制約を受けます。 SSLによる暗号化と暗号化解除にはCPU のパフォーマンスが必要であり、Azure でアプリケーションとオンライン サービスへの高速接続を実現するにはネットワークが重要です。 

これに対し、コネクタにとってメモリはあまり重要ではありません。 処理の大半はオンライン サービスによって行われ、すべての認証されていないトラフィックが処理されます。 クラウドでできることはすべてクラウドで実行しています。

パフォーマンスに関するその他の要因としては、コネクタと次の項目間のネットワークの品質が挙げられます。

* **オンライン サービス:** 接続の速度が遅かったり待機時間が長かったりすると、コネクタ サービスに影響が及びます。 Express Route 経由で Azure に接続することをお勧めします。 それ以外の場合は、ネットワーク チームに、Azure への接続が効率的な方法で確実に処理されるように依頼してください。  
* **バックエンド アプリケーション:** コネクタとバックエンド アプリケーション間にプロキシが追加されていることがあります。 こうしたシナリオの問題は、コネクタを実行するコンピューターからブラウザーを開き、これらのアプリケーションにアクセスすることで解決できます。 コネクタを Azure で実行し、アプリケーションはオンプレミスで実行している場合は、ユーザーが期待するほどのエクスペリエンスが得られないことがあります。
* **ドメイン コントローラー:** Kerberos の制約付き委任 (KCD) を使用して SSO を実行する場合、コネクタは、バックエンドに要求を送信する前にドメイン コントローラーに接続します。 コネクタには Kerberos チケットのキャッシュがありますが、ビジー状態では、ドメイン コントローラーの応答性がエクスペリエンスに影響することがあります。 こうした問題は、コネクタを Azure で実行しながらドメイン コントローラーはオンプレミスで実行している場合によく見られます。

## <a name="under-the-hood"></a>コネクタの性能

コネクタは Windows Server の Web アプリケーション プロキシをベースとしているため、Windows イベント ログや

 ![イベント ビューアーを使用したイベント ログの管理](./media/application-proxy-understand-connectors/event-view-window.png)

Windows パフォーマンス カウンターなど、同じ管理ツールのほとんどが備わっています。 

 ![パフォーマンス モニターを使用したコネクタへのカウンターの追加](./media/application-proxy-understand-connectors/performance-monitor.png)

コネクタには管理者ログとセッション ログがあります。 管理者ログには主要なイベントとそのエラーが含まれます。 セッション ログには、すべてのトランザクションとその処理の詳細が含まれます。 

ログを参照するには、イベント ビューアーに移動し、**[表示]** メニューで、**[分析およびデバッグ ログの表示]** を有効にする必要があります。 次に、ログを有効にしてイベントの収集を開始します。 コネクタはより新しいバージョンに基づいているため、Windows Server 2012 R2 の Web アプリケーション プロキシでは管理者ログとセッション ログは表示されません。

[サービス] ウィンドウでサービスの状態を確認することができます。 コネクタは、コネクタそのものと更新を処理するサービスの、2 つの Windows サービスで構成されています。 この両方を常に実行する必要があります。

 ![AzureAD サービスのローカル](./media/application-proxy-understand-connectors/aad-connector-services.png)

## <a name="next-steps"></a>次のステップ
[アプリケーション プロキシの問題とエラー メッセージのトラブルシューティング](active-directory-application-proxy-troubleshoot.md)

[既存のオンプレミス プロキシ サーバーと連携する](application-proxy-working-with-proxy-servers.md)

[Azure AD アプリケーション プロキシ コネクタをサイレント インストールする方法](active-directory-application-proxy-silent-installation.md)


