<properties title="How to use diagnostics" pageTitle="How to use diagnostics" description="Learn how to set up diagnostics for your resources in Azure." authors="stepsic"  />

<tags ms.service="application-insights" ms.workload="tbd" ms.tgt_pltfrm="ibiza" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="stepsic"></tags>

# 診断を設定する

Azure ポータル プレビューでは、Windows 仮想マシンおよびストレージ アカウントについての高頻度で多様なデータの監視および診断を構成できるようになりました。

## 仮想マシンから多様なデータを収集する

1.  [Azure ポータル プレビュー][Azure ポータル プレビュー]で、**[参照]**、**[仮想マシン]** の順にクリックします。監視する仮想マシンを選択します。
2.  **[監視]** レンズには、**[CPU の割合]**、**[ディスクの読み書き]**、**[接続および切断したネットワーク]** などの既定のメトリックが含まれます。いずれかのパーツをクリックすると、**[メトリック]** ブレードが表示されます。  
    ![[監視] レンズ](./media/insights-how-to-use-diagnostics/Insights_VMMonitoringLens.png)
3.  **[メトリック]** ブレードには、選択したメトリックに関する詳細が表示されます。ブレードの上部にはグラフがあり、下部にある表では、平均、最小値、最大値など、これらのメトリックに関する集約が表示されます。その下には、既に定義したアラートの一覧があり、ブレード上に表示されているメトリックに関連するものだけが表示されるようにフィルターが適用されています。  
    ![[メトリック] ブレード](./media/insights-how-to-use-diagnostics/Insights_VMMetricBlade.png)
4.  多様な診断を行えるようにするには、**[設定]** ボタンをクリックし、**[診断]** ブレードを表示します。**[オン]** を選択します。
    ![[診断] ブレード](./media/insights-how-to-use-diagnostics/Insights_VMDiagnosticsBlade.png)

    -   **基本メトリック**: プロセッサやメモリーなどの仮想マシンについての正常性のメトリック
    -   **ディスクごとのメトリック**: 仮想マシンに接続しているすべてのディスクについてのメトリック
    -   **.NET メトリック**: 仮想マシン上で実行されている .NET アプリケーションおよび ASP.NET アプリケーションについてのメトリック
    -   **ネットワーク メトリック**: ネットワーク接続と Web サービスに関するメトリック
    -   **Windows イベント アプリケーション ログ**: アプリケーション チャネルに送信される Windows イベント
    -   **Windows イベント システム ログ**: システム チャネルに送信される Windows イベント。これには、[Microsoft マルウェア対策][Microsoft マルウェア対策]からのすべてのイベントも含まれます。
    -   **Windows イベント セキュリティ ログ**: セキュリティ チャネルに送信される Windows イベント
    -   **診断インフラストラクチャ ログ**: 診断コレクション インフラストラクチャについてのログ
    -   **IIS ログ**: IIS サーバーについてのログ
        メトリックとログすべては 1 分間隔で記録されるので、ご使用のマシンに関する情報はいつでも最新のものとなります。

ストレージ アカウントに対する診断情報を有効にすると、対象アカウントで通常のストレージ、トランザクション、送信の料金が課金されます。ただし、こうした機能により多量のデータが生成されることはありません。IIS ログだけは例外の場合があります。送信料金を最小限に抑えるには、仮想マシンと同じリージョンにあるストレージ アカウントを選択してください。

**[OK]** をクリックすると、ご使用のストレージ アカウントに数分以内でデータが表示されます。Linux で実行されている仮想マシンの診断を有効にすることはできません。また診断を有効にするためには、ゲスト エージェントのインストールが必要です。

## ストレージ アカウントから多様なデータを収集する

これまでもストレージ アカウントからある種のデータをいつでも収集できましたが、Azure ポータル プレビューでは、1 分間隔で細かくデータを収集できるので、ストレージ アカウント内部で生じている事柄を正確に把握できるようになりました。1 分間隔のメトリックを有効にする手順は、仮想マシンの場合と似ています。

1.  **[ストレージ アカウント]** ブレードのいずれかのグラフをクリックして、**[メトリック]** ブレードに移動します。
2.  コマンド バーにある **[診断]** ボタンをクリックします。
3.  ストレージ アカウントで収集するデータを選択します。  
    ![ストレージの [診断]](./media/insights-how-to-use-diagnostics/Insights_StorageDiagnostics.png)
4.  **[OK]** をクリックします。初めての場合、データが表示されるまで数分かかります。

## 診断データを視覚化する

診断を有効にした後、選択可能なメトリックすべての一覧を表示できます。そのためには、いずれかのグラフを右クリックし、**\[クエリの編集]** に移動します。

![クエリの編集][クエリの編集]

これらのメトリックをプロットし、**[過去 1 時間]**、**[過去 1 週間]**、または **[カスタム]** の時間範囲を選択できます。

![カスタムの時間範囲][カスタムの時間範囲]

こうしたメトリックは、これまで選択可能となっていたデータよりも粒度が細かくなり、遅延が小さくなっている点に注目してください。

現時点では、プロセスごとのメトリックやディスクごとのメトリックなど、複数インスタンスが含まれるメトリックはプロットできません。監視グラフをカスタマイズする方法について詳しくは、[監視のカスタマイズ方法][監視のカスタマイズ方法]を参照してください。

## 診断データに基づいてアラートを送信する

メトリックの視覚化に加え、ポータル プレビューでこうしたメトリックについてのアラートを出すことができます。最初に、[仮想マシン] ブレードまたは [ストレージ] ブレードの **[アラート ルール]** パーツまで下方にスクロールし、**\[アラートの追加]** をクリックします。

![アラートの追加][アラートの追加]

次に、診断用に有効にしたメトリックのいずれかを選択できます。

![JIT アラート][JIT アラート]

グラフに、過去のメトリックと比較したアラートしきい値のプレビューが表示されます。**[保存]** をクリックしてから数分以内で、選択したメトリックがしきい値を超えたかどうかが通知されます。

プレビュー ポータルにのみ表示されるメトリックは、フル ポータルではアラートを通知することはできないという点に注意してください。そのため、プレビュー ポータルのアラート ルールの中には、フル ポータルでは表示されないものがあります。

  [Azure ポータル プレビュー]: https://portal.azure.com/
  [Microsoft マルウェア対策]: http://go.microsoft.com/fwlink/?LinkID=404171&clcid=0x409
  [クエリの編集]: ./media/insights-how-to-use-diagnostics/Insights_VMEditQuery.png
  [カスタムの時間範囲]: ./media/insights-how-to-use-diagnostics/Insights_VMCustomTime.png
  [監視のカスタマイズ方法]: http://go.microsoft.com/fwlink/?LinkID=394523&clcid=0x409
  [アラートの追加]: ./media/insights-how-to-use-diagnostics/Insights_VMAlerts.png
  [JIT アラート]: ./media/insights-how-to-use-diagnostics/Insights_VMJITAlert.png
