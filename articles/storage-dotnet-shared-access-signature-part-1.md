<properties 
	pageTitle="共有アクセス署名:SAS モデルについて | Microsoft Azure" 
	description="共有アクセス署名を使用して BLOB、キュー、およびテーブル リソースへのアクセスを委任する方法について説明します。" 
	services="storage" 
	documentationCenter="" 
	authors="tamram" 
	manager="adinah" 
	editor=""/>

<tags 
	ms.service="storage" 
	ms.workload="storage" 
	ms.tgt_pltfrm="na" 
	ms.devlang="dotnet" 
	ms.topic="article" 
	ms.date="11/10/2014" 
	ms.author="tamram"/>



# 共有アクセス署名、パート 1:SAS モデルについて

共有アクセス署名 (SAS) の使用は、アカウント キーを知らせずに、自分のストレージ アカウントの BLOB、テーブル、およびキューへの制限付きアクセスを他のクライアントに許可するための優れた方法です。共有アクセス署名についてのこのチュートリアルの第 1 部では、SAS モデルの概要と SAS のベスト プラクティスについて説明します。[チュートリアルのパート 2](storage-dotnet-shared-access-signature-part-2.md) では、BLOB サービスで共有アクセス署名を作成するプロセスを詳しく説明します。

## 共有アクセス署名とは ##

共有アクセス署名を使用すると、ストレージ アカウント内のリソースへの委任アクセスが可能になります。つまり、自分の BLOB、キュー、またはテーブルへの制限付きアクセス許可を、期間とアクセス許可セットを指定してクライアントに付与できます。また、アカウント アクセス キーを共有する必要はありません。SAS とは、ストレージ リソースへの認証アクセスに必要なすべての情報をクエリ パラメーター内に含む URI です。クライアントは、SAS 内で適切なコンストラクターまたはメソッドに渡すだけで、SAS でストレージ リソースにアクセスできます。

## 共有アクセス署名を使用するタイミング ##

SAS は、自分のアカウント キーを知らせたくないクライアントに、自分のストレージ アカウント内のリソースへのアクセスを許可する場合に使用できます。ストレージ アカウント キーには、プライマリ キーとセカンダリ キーの両方が含まれており、これらによって、アカウントとそのすべてのリソースへの管理アクセスが付与されます。これらのアカウント キーのいずれかを知らせると、悪意で、または誤ってアカウントが使用される可能性が生じます。共有アクセス署名は、アカウント キーが不要で安全な代替方法です。この方法で、他のクライアントは、付与されたアクセス許可に従ってストレージ アカウント内のデータの読み取り、書き込み、削除を実行できます。

SAS が役立つ一般的なシナリオは、ストレージ アカウント内でユーザーが自分のデータの読み取りや書き込みを行うサービスです。ストレージ アカウントにユーザー データが格納されるシナリオには、2 種類の典型的な設計パターンがあります。


1\. 認証を実行するフロントエンド プロキシ サービス経由で、クライアントがデータのアップロードとダウンロードを行います。このフロントエンド プロキシ サービスには、ビジネス ルールの検証が可能であるという利点がありますが、データやトランザクションが大量である場合は、需要に応じて拡張可能なサービスの作成にコストがかかったり、困難が生じたりする可能性があります。

![sas-storage-fe-proxy-service][sas-storage-fe-proxy-service]

2\.	軽量サービスが、必要に応じてクライアントを認証してから、SAS を生成します。クライアントは、SAS を受信すると、SAS で定義されたアクセス許可と SAS で許可された期間で、ストレージ アカウントのリソースに直接アクセスできるようになります。SAS によって、すべてのデータをフロントエンド プロキシ サービス経由でルーティングする必要性が減少します。

![sas-storage-provider-service][sas-storage-provider-service]

実際のサービスの多くでは、関連するシナリオに応じて、この 2 種類のアプローチのハイブリッドを使用できます。つまり、一部のデータをフロントエンド プロキシで処理および検証し、それ以外のデータを SAS で直接保存したり、読み取ったりします。

## 共有アクセス署名の機能 ##

共有アクセス署名は、ストレージ リソースを指す URI であり、クライアントがリソースにアクセスする方法を示すクエリ パラメーターの特殊なセットを含んでいます。これらのパラメーターの 1 つである署名は、SAS パラメーターで作成されており、アカウント キーで署名されています。この署名を使用して、Azure のストレージが SAS を認証します。

共有アクセス署名は、その定義である、次の制約を含んでいます。各制約は、URI でパラメーターとして表示されます。

- **ストレージ リソース。**そのアクセスを委任できるストレージ リソースには、コンテナー、BLOB、キュー、テーブル、およびテーブル エンティティの範囲があります。
- **開始時刻。**SAS が有効になる時刻です。共有アクセス署名の開始時刻は省略可能です。省略した場合は、SAS がすぐに有効にします。
- **有効期限。**SAS が無効になる時刻です。SAS の有効期限を指定するか、保存されているアクセス ポリシー (詳細は後述) に関連付けることをお勧めします。
- **アクセス許可。**SAS に指定されたアクセス許可は、クライアントが SAS を使用して、ストレージ リソースに対して実行できる操作を示します。

BLOB に読み書きアクセス許可を付与する SAS URI の例を、次に示します。表では、SAS での機能がわかりやすいように、URI の部分ごとに説明しています。

https://myaccount.blob.core.windows.net/sascontainer/sasblob.txt?sv=2012-02-12&st=2013-04-29T22%3A18%3A26Z&se=2013-04-30T02%3A23%3A26Z&sr=b&sp=rw&sig=Z%2FRHIX5Xcg0Mq2rqI3OlWTjEg2tYkboXr1P9ZUXDtkk%3D

<table border="1" cellpadding="0" cellspacing="0">
    <tbody>
        <tr>
            <td valign="top" width="213">
                <p>
                    Blob URI
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    https://myaccount.blob.core.windows.net/sascontainer/sasblob.txt
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    BLOB のアドレス。HTTPS の使用を強くお勧めします。
                </p>
            </td>
        </tr>
        <tr>
            <td valign="top" width="213">
                <p>
                    ストレージ サービスのバージョン
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    sv=2012-02-12
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    ストレージ サービス バージョン 2012-02-12 以降では、このパラメーターは、使用するバージョンを示します。
                </p>
            </td>
        </tr>
        <tr>
            <td valign="top" width="213">
                <p>
                    開始時刻
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    st=2013-04-29T22%3A18%3A26Z
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    ISO 8061 形式で指定されます。SAS をすぐに有効にする場合は、開始時刻を省略します。
                </p>
            </td>
        </tr>
        <tr>
            <td valign="top" width="213">
                <p>
                    有効期限
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    se=2013-04-30T02%3A23%3A26Z
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    ISO 8061 形式で指定されます。
                </p>
            </td>
        </tr>
        <tr>
            <td valign="top" width="213">
                <p>
                    リソース
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    sr=b
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    リソースは BLOB です。
                </p>
            </td>
        </tr>
        <tr>
            <td valign="top" width="213">
                <p>
                    アクセス許可
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    sp=rw
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    SAS で付与されるアクセス許可には、読み取り (r) および書き込み (w) が含まれます。
                </p>
            </td>
        </tr>
        <tr>
            <td valign="top" width="213">
                <p>
                    署名
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    sig=Z%2FRHIX5Xcg0Mq2rqI3OlWTjEg2tYkboXr1P9ZUXDtkk%3D
                </p>
            </td>
            <td valign="top" width="213">
                <p>
                    BLOB へのアクセスを認証するために使用します。署名は、SHA256 アルゴリズムを使用して署名対象文字列とキーを計算した後に、Base 64 エンコードを使用してエンコードした HMAC 値です。
                </p>
            </td>
        </tr>
    </tbody>
</table>


## 保存されているアクセス ポリシーによる共有アクセス署名の制御 ##

共有アクセス署名の形式は、次の 2 つのいずれかです。

- **アドホック SAS:** アドホック SAS を作成すると、開始時刻、有効期限、および SAS へのアクセス許可がすべて、SAS URI で指定されます (または、開始時刻を省略した場合は、暗黙で指定されます)。コンテナー、BLOB、テーブル、キューには、この種類の SAS が作成される場合があります。
- **アクセス ポリシーが保存された SAS:** 保存されたアクセス ポリシーはリソース コンテナー上 (BLOB コンテナー、テーブル、キュー) に定義され、1 つ以上の共有アクセス署名の制約を管理するのに使用できます。保存されたアクセス ポリシーに SAS を関連付けると、保存されたアクセス ポリシーに定義された制約 (開始時間、有効期限、アクセス権限) を SAS が継承します。

1 つの重要なシナリオ、失効では、この 2 つの形式の相違点が重要です。SAS は URL であるため、取得したユーザーはだれでも、どのユーザーが最初に要求したかに関係なく、SAS を使用できます。SAS が一般ユーザーに発行された場合は、世界中のだれでも使用できます。配布された SAS は、次の 4 つの状況のいずれかになるまで有効です。

1.	SAS に指定された有効期限に達した。
2.	保存されているアクセス ポリシーに指定された、SAS が参照する有効期限に達した (保存されているアクセス ポリシーが参照される場合、かつ有効期限が指定されている場合)。これは、期間が経過したため、または保存されているアクセス ポリシーの有効期限を過去の日時に変更したために発生します。このような有効期限の変更は、SAS を失効させる方法の 1 つです。
3.	SAS の参照先である保存されているアクセス ポリシーが削除されている。これは、SAS を失効させる、もう 1 つの方法です。保存されているアクセス ポリシーを、完全に同じ名前で再作成すると、そのアクセス ポリシーに関連付けられたアクセス許可に従って、すべての既存の SAS トークンが再び有効になります (SAS の有効期限が過ぎていないことが前提です)。SAS を失効させるつもりで、将来の時間を有効期限に指定してアクセス ポリシーを再作成する場合は必ず、異なる名前を使用してください。
4.	SAS の作成に使用したアカウント キーが再度生成された。これを行うと、そのアカウント キーを使用するすべてのアプリケーション コンポーネントが、別の有効なアカウント キー、または新しく再生成されたアカウント キーを使用するよう更新されるまで、認証に失敗します。
 
## 共有アクセス署名の使用のベスト プラクティス ##

アプリケーションで共有アクセス署名を使用する場合は、次の 2 つの潜在的なリスクに注意する必要があります。

- SAS が漏えいすると、取得した人はだれでも使用できるため、ストレージ アカウントの安全性が損なわれるおそれがあります。
- クライアント アプリケーションに提供された SAS が期限切れになり、アプリケーションがサービスから新しい SAS を取得できない場合は、アプリケーションの機能が損なわれる可能性があります。  

共有アクセス署名の使用に関する次の推奨事項に従うと、これらのリスクが軽減されます。

1. SAS を作成したり、SAS を配布したりする場合は、**常に HTTPS を使用します**。SAS が HTTP で渡され、傍受された場合、中間者攻撃を実行している攻撃者は、SAS を読み取って、宛先のユーザーと同様に使用することができます。このため、機密データの安全性が損なわれたり、悪意のあるユーザーによるデータ破損が発生したりする可能性があります。
2. **保存されたアクセス ポリシーがある場合は、そのアクセス ポリシーを使用します。**保存されたアクセス ポリシーでは、ストレージ アカウント キーを再生成しなくても、アクセス権限を失効させることができます。有効期限を非常に長い期間 (または無期限) に設定し、有効期限を以降の日時に移動するように定期的に更新されていることを確認します。
3. **アドホック SAS には短期間の有効期限を使用します。**こうすることで、SAS が知らないうちに侵害された場合でも、実行期間を短期間にとどめることができます。保存されたアクセス ポリシーを参照できない場合には、この処理が特に重要になります。また、BLOB へのアップロード期間を制限することで、BLOB に書き込むことができるデータ量を制限できるのも便利です。
4. **必要に応じて、クライアントの SAS を自動的に更新します。**SAS を提供するサービスが使用できなくなった場合、再試行する時間を許可するために、有効期限が切れる前にクライアントは SAS を更新する必要があります。SAS を即時の、短期間で行う少数の操作 (特定の有効期限内に完了すると想定されているもの) に使用する場合は SAS の更新が想定されていないため、この処理は必要ない場合があります。ただし、SAS 経由で定期的に要求を行うクライアントがある場合は、有効期限が切れてしまうということも考えられます。キーを考慮するときは、SAS を短期間だけ使用する場合 (上述) と、SAS の更新前に有効期限切れとなって中断が発生しないよう、クライアントが定期的に更新を要求する場合のバランスをとる必要があります。
5. **SAS の開始時間に注意します。**SAS の開始時間を**[今すぐ]** に設定すると、クロック スキュー (マシンが異なることによる現在時刻の差異) により、最初の数分間にエラーが断続的に発生することがあります。一般的に、開始時間を少なくとも 15 分後以降に設定するか、まったく設定しないようにします。設定しないと、あらゆる場合においてすぐに有効になります。同じことは有効期限にもあてはまります。最大 15 分間、いずれかの方向の要求にエラーが発生する場合があります。バージョン 2012-02-12 より前の REST を使用するクライアントの場合、SAS が保存されたアクセス ポリシーを参照しない最大時間は 1 時間であり、それよりも長い時間を指定するポリシーはすべてエラーが発生します。
6.	**アクセスするリソースに固有の設定を行います。**一般的なセキュリティでは、ユーザーに最低限必要な権限のみを提供します。ユーザーが単一エンティティの読み取り権限のみを必要とする場合は、その単一のエンティティの読み取り権限を付与し、すべてのエンティティへの読み取り/書き込み/削除権限は付与しないようにします。こうすることで、SAS が攻撃者に与える余地を減らすことができ、侵害される SAS への脅威を軽減できます。
7.	**SAS を含む、あらゆる使用に対してアカウントに課金されることを理解します。**BLOB へのアクセス権限を付与している場合、ユーザーは 200GB の BLOB をアップロードできます。同様に書き込み権限を付与している場合、ユーザーがその BLOB を 10 回ダウンロードすると、2TB の転送コストがかかります。また、付与するアクセス権限を制限することで、悪意のあるユーザーの潜在的な脅威を軽減できます。こういった脅威を軽減するには、短期間の SAS を使用します (ただし、終了時間のクロック スキューに注意します)。
8.	**SAS を使用して書き込まれたデータを検証します。**クライアント アプリケーションがストレージ アカウントにデータを書き込む場合、データに問題が発生する場合があるので注意が必要です。アプリケーションでデータを使用する前にデータの検証や承認を必要とする場合、データが書き込まれた後からアプリケーションがそのデータを使用する前までに、検証を行う必要があります。こうすることで、適切に SAS を取得したユーザーや漏えいした SAS を悪用するユーザーが、破損したデータや悪意のあるデータをアカウントに書き込むのを防ぐこともできます。
9. **SAS を常時使い続けるようなことのないようにします。**ときには、ストレージ アカウントに対する特定の操作に関連するリスクが、SAS のメリットに勝る場合があります。そのような操作の場合は、ビジネス上の取り決めによる検証、認証、監査の後に、ストレージ アカウントに書き込みを行う中間層のサービスを作成します。さらに、その他の方法の方がアクセスを管理しやすくなる場合もあります。たとえば、コンテナー内のすべての BLOB を一般公開して読み取り可能にする場合は、アクセス用にクライアントごとに SAS を提供するのではなく、コンテナーをパブリックに設定します。
10.	**Storage Analytics を使用してアプリケーションを監視します。**ログ機能や基準を使用することで、SAS プロバイダー サービスの停止や保存されたアクセス ポリシーを不注意に削除してしまったことで発生する認証エラーの急増を監視することができます。詳細については、[Azure Storage チームのブログ](http://blogs.msdn.com/b/windowsazurestorage/archive/2011/08/03/windows-azure-storage-logging-using-logs-to-track-storage-requests.aspx)を参照してください。

## まとめ ##

共有アクセス署名は、アカウント キーを知らせずに、ストレージ アカウントへの制限付きアクセス許可をクライアントに付与する場合に便利です。したがって、Azure のストレージを使用するあらゆるアプリケーションのセキュリティ モデルの重要な部分となります。ここに示すベスト プラクティスに従うと、アプリケーションのセキュリティを損なうことなく、SAS を使用して、ストレージ アカウントのリソースへのアクセスの柔軟性を高めることができます。

## 次のステップ ##

[共有アクセス署名、第 2 部 : BLOB サービスによる SAS の作成および使用](storage-dotnet-shared-access-signature-part-2.md)

[Microsoft Azure ストレージ リソースへのアクセスの管理](http://msdn.microsoft.com/library/windowsazure/ee393343.aspx)

[共有アクセス署名によるアクセスの委任 (REST API) に関するページ](http://msdn.microsoft.com/library/windowsazure/ee395415.aspx)

[テーブルおよびキュー SAS についての MSDN ブログ](http://blogs.msdn.com/b/windowsazurestorage/archive/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas.aspx)
[sas-storage-fe-proxy-service]: ./media/storage-dotnet-shared-access-signature-part-1/sas-storage-fe-proxy-service.png
[sas-storage-provider-service]: ./media/storage-dotnet-shared-access-signature-part-1/sas-storage-provider-service.png


<!--HONumber=42-->
