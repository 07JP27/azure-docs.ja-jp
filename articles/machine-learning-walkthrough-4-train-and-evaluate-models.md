<properties title="Step 4: Train and evaluate the predictive analytic models" pageTitle="Step 4: Train and evaluate the predictive analytic models | Azure" description="Step 4: Train, score, and evaluate multiple models in Azure Machine Learning Studio" metaKeywords="" services="" solutions="" documentationCenter="" authors="garye" videoId="" scriptId="" />

<tags ms.service="machine-learning" ms.workload="tbd" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="01/01/1900" ms.author="garye" />

これは、チュートリアル「[Azure Machine Learning を使用した予測ソリューションの開発][Azure Machine Learning を使用した予測ソリューションの開発]」の 4 番目の手順です。

1.  [ML ワークスペースを作成する][ML ワークスペースを作成する]
2.  [既存のデータをアップロードする][既存のデータをアップロードする]
3.  [新しい実験を作成する][新しい実験を作成する]
4.  **モデルをトレーニングして評価する**
5.  [Web サービスを発行する][Web サービスを発行する]
6.  [Web サービスにアクセスする][Web サービスにアクセスする]

------------------------------------------------------------------------

# 手順 4.予測分析モデルをトレーニングして評価する

この実験では、予測モデルを完成させるためにさまざまなアルゴリズムを試します。2 種類の異なるモデルを作成し、これらのスコア結果を比較することで、最終的な実験で使用するアルゴリズムを決定します。

選択できるモデルは数多くあります。これらのモデルを表示するには、モジュール パレットの **[機械学習]** ノードを展開して、**[モデルの初期化]** とその下にあるノードを展開します。実験の目的に合わせて、ここでは [サポート ベクター マシン (SVM)] と [2 クラス ブースト デシジョン ツリー] を選択します。学習アルゴリズムの初期化には、そのための適切なモジュールを使用し、モジュールのトレーニングには、**モデルのトレーニング** モジュールを使用します。

## モデルをトレーニングする

まず、ブースト デシジョン ツリー モデルを以下の手順で設定します。

1.  モジュール パレットで **2 クラス ブースト デシジョン ツリー** モジュールを見つけ、キャンバスにドラッグします。
2.  **モジュールのトレーニング** モジュールを見つけてキャンバスにドラッグし、 ブースト デシジョン ツリー モジュールの出力を、**モデルのトレーニング モジュール**の左側の入力ポート ([未トレーニングのモデル]) に接続します。
3.  **R スクリプトの実行**モジュールの出力を、**モデルのトレーニング** モジュールの右側の入力ポート ([データセット]) に接続します。

    > ヒント - この実験では、**R スクリプトの実行**モジュールの入力 2 つと出力 1 つは必要ないため、そのままにしておきます。これはいくつかのモジュールではよくある処理です。

4.  **モデルのトレーニング** モジュールを選択します。**[プロパティ]** ウィンドウの **[列セレクターの起動]** をクリックし、最初のドロップダウンにある [列インデックス] を選択して、テキスト フィールドに「21」と入力します ([列名] を選択して「Credit risk」と入力してもかまいません)。これによって、モデルが予測する列として、21 列目の信用リスク値が指定されます。

実験の一部は以下のようになっているはずです。

![Training a model][Training a model]

次に SVM モデルを設定します。

ブースト デシジョン ツリーはあらゆる種類の特徴で問題なく使うことができます。ただし、SVM モジュールは線形分類器を生成するため、これによって生成されるモデルでは、すべての数値特徴のスケールが同一である場合に最適なテスト エラーが得られます。すべての数値特徴を同じスケールに変換するには、**スケーリングによるデータ変換**モジュールと Tanh 変換を使用します。これによって特徴が [0,1] の範囲に変換されます。文字列特徴は SVM モジュールによってカテゴリ特徴に変換され、バイナリ 0/1 特徴に変換されます。このため文字列特徴を手動で変換する必要はありません。また、[Credit Risk] 列 (21 列目) は変換しません。これは数値ですが、トレーニングによってモデルが予測する値です。このため、この値はそのままにしておきます。

1.  モジュール パレットで **2 クラス サポート ベクター マシン** モジュールを見つけ、キャンバスにドラッグします。
2.  **モデルのトレーニング** モジュールを右クリックして **[コピー]** を選択し、キャンバスを右クリックして **[貼り付け]** を選択します。**モデルのトレーニング** モジュールのコピーでも、元のモジュールと同じ列が選択されています。
3.  SVM モジュールの出力を、**モデルのトレーニング** モジュールの左側の入力ポート ([未トレーニングのモジュール]) に接続します。
4.  **スケーリングによるデータ変換**モジュールを見つけ、キャンバスにドラッグします。
5.  この変換モジュールの入力を、**R スクリプトの実行**モジュールの左側の出力に接続します。
6.  変換モジュールの左側の出力ポート ([変換済みデータセット]) を、**モデルのトレーニング** モジュールの右側の入力ポート ([データセット]) に接続します。
7.  変換モジュールの **[プロパティ]** ウィンドウで、**[変換メソッド]** パラメーターに [Tanh] を選択します。
8.  **[列セレクターの起動]** をクリックします。最初のドロップダウンで [列の型] を選択し、2 つ目のドロップダウンで [数値] を選択します (3 つ目のドロップダウンは [すべて] が選択されたままにします)。これによって、すべての数値列が (そして数値列のみが) 変換されます。
9.  プラス記号 (+) をクリックして、ドロップダウンに新しい行を作成します。最初のドロップダウンで [列インデックスを除外] を選択し、テキスト フィールドに「21」と入力します。これによって 21 列目 ([Credit risk] 列) が無視されます。
10. **[OK]** をクリックします。

これで、**スケーリングによるデータ変換**モジュールが、[Credit Risk] 列以外のすべての数値列に tanh 変換を実行するよう設定されました。

実験の一部は以下のようになっているはずです。

![Training the second model][Training the second model]

## モデルにスコアを付け、評価する

**分割**モジュールによって分離されたスコア付けデータを使用して、トレーニングされたモデルにスコアを付けます。その後、2 つのモデルの結果を比較して、どちらのモデルがより適した結果を生成したかを判断します。

1.  **モデルのスコア付け**モジュールを見つけ、キャンバスにドラッグします。
2.  このモジュールの左側の入力ポートを、ブースト デシジョン ツリー モデルに接続します (入力ポートを、**2 クラス ブースト デシジョン ツリー** モジュールに接続されている**モデルのトレーニング** モジュールの出力ポートに接続します)。
3.  **モデルのスコア付け**モジュールの右側の入力ポートを、**R スクリプトの実行**モジュールの右側の出力に接続します。これで、モジュールを複数の場所に出力できるようになりました。
4.  **モデルのスコア付け**モジュールをコピーして貼り付け、2 つ目のコピーを作成します。または新しいモジュールをキャンバスにドラッグします。
5.  モジュールの左側の入力ポートを SVM モデルに接続します (入力ポートを、**2 クラス サポート ベクター マシン** モジュールに接続されている**モデルのトレーニング** モジュールの出力ポートに接続します)。
6.  SVM モデルでは、トレーニング用データに対する変換と同様の変換を、テスト用データにも実行する必要があります。このため、**スケーリングによるデータ変換**モジュールをコピーして貼り付けて 2 つ目のコピーを作成し、**R スクリプトの実行**モジュールの右側の出力に接続します。
7.  **モデルのスコア付け**モジュールの右側の入力ポートを、**スケーリングによるデータ変換**モジュールの出力に接続します。

2 つのスコア結果を比較するには、**モデルの評価**モジュールを使用します。

1.  **モデルの評価**モジュールを見つけ、キャンバスにドラッグします。
2.  左側の入力ポートを、ブースト デシジョン ツリー モデルに関連付けられている**モデルのスコア付け**モジュールの出力ポートに接続します。
3.  右側の入力ポートを、もう一方の**モデルのスコア付け**モジュールに接続します。

実験は以下のようになっているはずです。

![Evaluating both models][Evaluating both models]

キャンバスの下にある **[実行]** ボタンをクリックすると実験が実行されます。これには数分かかることがあります。実行中であることを示す各モジュールのインジケーターが回転して、モジュールが完了すると、緑色のチェック マークが表示されます。

すべてのモジュールにチェック マークが付いたら、実験の実行は完了しています。結果を確認するには、**モデルの評価**モジュールの出力ポートを右クリックして **[視覚化]** をクリックします。

**モデルの評価**モジュールが生成する曲線と測定値のペアを使用して、スコア付けされた 2 つのモデルの結果を比較できるようになります。結果は、Receiver Operator Characteristic (ROC) 曲線、Precision/Recall 曲線、または Lift 曲線で表示できます。表示されるその他の情報には、混同行列、累積の AUC 値、その他の測定値があります。スライダーを左右に移動してしきい値を変更することで、変更が測定値に与える影響を確認することもできます。

[スコア付けされたデータセット] または [スコア付けされた比較対象のデータセット] をクリックすると、関連付けられた曲線が強調表示され、関連する測定値が下部分に表示されます。曲線の凡例では、[スコア付けされたデータセット] は、**モデルの評価**モジュールの左側の入力ポート (この場合、ブースト デシジョン ツリー モデル) に対応しています。[スコア付けされた比較対象のデータセット] は、右側の入力ポート (この場合、SVM モデル) に対応しています。いずれかのラベルをクリックすると、そのモデルの曲線が強調表示され、関連する測定値が表示されます。

![ROC curves for models][ROC curves for models]

これらの値を検証することで、求めている結果に最も近い結果が得られるモデルを判断することができます。モデルと値を変えて実験を再度実行することもできます。

> ヒント - 実験を実行するたびに、イテレーションの記録が実行履歴に保存されます。キャンバスの下にある **[実行履歴を表示]** をクリックすると、これらのイテレーションをいつでも表示し、いつでも実験に戻ることができます。また、**[プロパティ]** ウィンドウの **[前回の実行]** をクリックすると、現在開いているイテレーションの前のイテレーションがすぐに表示されます。

また、キャンバスの下にある **[名前を付けて保存]** をクリックすると、実験のイテレーションのコピーを作成できます。これによって、実験が複製され、イテレーションの複製バージョンの新しい実行履歴が作成されます。新しいコピーは **[実験]** の一覧に元のイテレーションと共に表示されます。この機能は、実験のイテレーションを新しい分岐で開始する場合などに便利です。

実験キャンバスのすべてのモジュールにコメントを追加できるため、モジュールのパラメーターに加えた変更も簡単に追跡できます。コメントは、モジュールをダブルクリックするか、右クリックして **[コメントの編集]** を選択するだけで追加できます。これらのコメントは実験のイテレーションと共に保存されるため、作業に説明を追加する際に役立てることができます。

------------------------------------------------------------------------

**次の手順: [Web サービスを発行する][Web サービスを発行する]**

  [Azure Machine Learning を使用した予測ソリューションの開発]: ../machine-learning-walkthrough-develop-predictive-solution/
  [ML ワークスペースを作成する]: ../machine-learning-walkthrough-1-create-ml-workspace/
  [既存のデータをアップロードする]: ../machine-learning-walkthrough-2-upload-data/
  [新しい実験を作成する]: ../machine-learning-walkthrough-3-create-new-experiment/
  [Web サービスを発行する]: ../machine-learning-walkthrough-5-publish-web-service/
  [Web サービスにアクセスする]: ../machine-learning-walkthrough-6-access-web-service/
  [Training a model]: ./media/machine-learning-walkthrough-4-train-and-evaluate-models/train1.png
  [Training the second model]: ./media/machine-learning-walkthrough-4-train-and-evaluate-models/train2.png
  [Evaluating both models]: ./media/machine-learning-walkthrough-4-train-and-evaluate-models/train3.png
  [ROC curves for models]: ./media/machine-learning-walkthrough-4-train-and-evaluate-models/train4.png
