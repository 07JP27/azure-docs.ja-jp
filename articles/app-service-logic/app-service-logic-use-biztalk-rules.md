<properties
   pageTitle="BizTalk ルール"
   description="このトピックでは、BizTalk ルールの機能とその使用方法について説明します"
   services="app-service\logic"
   documentationCenter=".net,nodejs,java"
   authors="anuragdalmia"
   manager="dwrede"
   editor=""/>

<tags
   ms.service="app-service-logic"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="integration"
   ms.date="07/02/2015"
   ms.author="andalmia"/>

#BizTalk ルール

ビジネス ルールには、ビジネス プロセスを制御するポリシーと意思決定がカプセル化されます。これらのポリシーは、手順書、契約書、合意書で正式に定義されることも、従業員が知識や専門知識として持っていることもあります。これらのポリシーは動的であり、ビジネス プランや規則の変更、またはその他の理由により時間が経つと変更されることがあります。

これらのポリシーを従来のプログラミング言語で実装するにはかなりの時間と調整が必要であり、プログラマーが参加しないと、ビジネス ポリシーの作成と維持管理を行うことができません。BizTalk のビジネス ルールでは、これらのポリシーを迅速に実装し、ビジネス プロセスの残りの部分と分離する方法を提供します。これにより、ビジネス プロセスの残りの部分に影響を与えることなく、必要に応じてビジネス ポリシーを変更できます。

##ルールを使用する理由

ビジネス プロセスで BizTalk のビジネス ルールを使用する主な理由は、次の 3 つです。

* アプリケーション コードからビジネス ロジックを分離する
- ビジネス アナリストがビジネス ロジックの管理をより制御できるようにする
+ ビジネス ロジックの変更をより早く運用環境に送る

##ルールの概念

##ボキャブラリ

ルールの条件やアクションを定義するために使用される用語は、通常、分野固有または業界固有の用語体系に従って表現されます。たとえば、電子メールを使用するユーザーがメッセージの "差出人" や "特定日時以降に受信" に基づくルールを記述したり、保険のビジネス アナリストが "リスク要因" や "補償範囲額" に基づくルールを記述したりします。
この分野固有の用語の背景には、ルールの条件やルールのアクションを実装するテクノロジ アーティファクト (オブジェクト、データベース テーブル、XML ドキュメント) が存在します。ボキャブラリは、ビジネス セマンティクスと実装のギャップを解消するために設計されています。

たとえば、承認状態のデータ バインドは、SQL クエリとして表される特定のデータベースの特定の行の単一の列を示す場合があります。ルールに直接このような複雑な表現を挿入する代わりに、たとえば、データ バインドに関連付けるボキャブラリ定義をフレンドリ名 "Status" で作成します。 後で任意の数のルールに "Status" を含めることができるので、ルール エンジンは、テーブルから対応するデータを取得できます。
_ボキャブラリ_とは、ルールの条件とアクションで使用されるコンピューティング オブジェクトのフレンドリ名で構成される定義をまとめたものです。ボキャブラリを定義すると、特定のビジネス分野のユーザーによるルールの参照、理解、共有が簡単になります。

##ルール

ビジネス ルールは、ビジネス プロセスの実施を管理する宣言型ステートメントです。ルールは条件とアクションで構成されます。条件が評価され、その結果が true であれば、ルール エンジンがアクションを開始します。ビジネス ルール フレームワークではルールは次の形式で定義されます。

_IF_ _条件_ _THEN_ _アクション_

次の例を考えてみます。

*IF 金額が使用可能な資金以下である*  
*THEN 取引を行い、レシートを印刷する*

このルールはビジネス ロジックを適用して、2 つの金額、ここでは取引金額と使用可能な資金を比較し、取引を行うかどうかを決定します。
ビジネス ルールの作成、変更、デプロイにはビジネス ルールを使用します。これらの作業を、プログラムで実行することもできます。

###条件

条件は 1 つ以上の述語から成る true/false (ブール値) 式です。この例では、述語の "以下である" が "金額" と "使用可能な資金" に適用されます。この条件の評価結果は常に true と false のいずれかになります。
述語は論理演算子の AND、OR、および NOT と組み合わせることができます。そのようにして作成された論理式は非常に大きくなることもありますが、評価結果は必ず true または false になります。

###アクション

アクションは条件評価の機能的な結果です。ルールの条件が満たされると、対応するアクションが開始されます。
この例では、"取引を行う" と "レシートを印刷する" がアクションです。これらのアクションは、条件 (IF 金額が使用可能な資金以下である) が true の場合にのみ実行されます。
ビジネス ルール フレームワークでは、アクションは XML ドキュメントに対する集合演算という形で表現されます。

##ポリシー

ポリシーは、ルールの論理的なグループです。ポリシーの作成、保存、テストを行い、目的の結果が得られた場合には、運用環境で使用することができます。

###ポリシーの作成

ルール ポータルでポリシーを作成できます。ポリシーには、任意の大きさのルールのセットを含めることができますが、通常は、ポリシーを使用するアプリケーションのコンテキスト内で特定のビジネス ドメインに関連するルールからポリシーを作成します。

###ポリシーのテスト
ポリシーを運用環境で使用する前に、ポリシーのテスト実行を効果的に行うことができます。ルール ポータルを使用して、入力をポリシーに提供し、ポリシーを実行し、その出力を表示することができます。出力に含まれるのは、ログ、ルールの実行、条件の評価、および結果の出力です。

##サンプル シナリオ - 保険金請求
サンプル シナリオに沿って進め、シナリオと同じビジネス ロジックを作成します。

![Alt text][1]

このごく簡単な保険金請求のシナリオでは、請求者は (Web サイト、携帯電話のアプリなど任意のクライアントを利用して) 保険金請求を提出します。この請求リクエストは企業の請求処理ユニットに送信され、処理の結果に基づいて、請求は承認または却下されるか、さらに手動で処理するように送信されることもあります。
このシナリオでは、請求処理ユニットにシステムのビジネス ロジックが含まれます。このユニットについて詳しくは次をご覧ください。

![Alt text][2]

このビジネス ロジックを実装するには、ビジネス ルールを使用します。


##ルール API アプリの作成


1. Azure ポータルにログインして、ホーム ページにアクセスします。
1. [新規]、[Azure Marketplace]、[API Apps]、[Biz Talk ルール]、[作成] の順にクリックします。![Alt text][3]
1. 新しく開いたブレードで、次の情報を入力します。  
	1. [名前] - ルール API アプリの名前を指定します
	1. [アプリ ホスティング プラン] - Web ホスティング プランを選択または作成します
	1. [価格レベル] - このアプリが属する価格レベルを選択します
	1. [リソース グループ] - このアプリが属するリソース グループを選択します
	1. [場所] - アプリをデプロイする地域を選択します
4.	[作成] をクリックします。数分以内に BizTalk ルール API アプリが作成されます。

##ボキャブラリの作成
BizTalk ルール API アプリを作成したら、次にボキャブラリを作成します。この演習を実行する開発者は一般的な人を想定しています。ボキャブラリを作成するには、次の手順に従います。


1. ブラウザーで作成済みの API アプリを参照し、[API Apps]、自分のルール API アプリの順に移動します。この操作により、次に示すようなルール API アプリのダッシュボードにアクセスします。

   ![Alt text][4]

2. 次に、[ボキャブラリの定義] をクリックします。ボキャブラリ作成画面が表示されます。[追加] をクリックして新しいボキャブラリの定義を追加します。現在、ボキャブラリの定義では、リテラルと XML の 2 つの型がサポートされています。

##リテラルの定義
1.	[追加] をクリックすると、[定義の追加] ブレードが新しく開きます。次の値を入力します。
  1.	[名前] - 英数字のみを使用できます。特殊文字は使用できません。既存のボキャブラリ定義リストに対して一意である必要もあります。
  2.	[説明] - オプション フィールドです。
  3.	[型] - 2 つの型がサポートされています。この例では [リテラル] を選択します。
  4.	[入力の型] - ここでユーザーは定義のデータ型を選択できます。現在 4 つのデータ型が選択できます。
    i.	文字列 – 値は二重引用符で囲んで入力する必要があります ("文字列の例")。  
    ii.	[ブール] - 値は true または false のどちらかです。  
    iii.	[数値] - 値は 10 進数です。  
    iv.	[日時] - 定義が日時型であることを意味します。値は "mm/dd/yyyy hh:mm:ss AM\PM" の形式で入力する必要があります。  
    v.	[入力] – ここには定義する値を入力します。ここに入力する値は選択したデータ型と一致する必要があります。ユーザーは単一の値を入力することも、コンマ区切りの値のセットを入力することも、キーワード to を使用して値の範囲を入力することもできます。たとえば、一意の値として「1」を、値のセットとして「1, 2, 3」を、値の範囲として「1 to 5」を入力することができます。範囲がサポートしているのは数字のみであることに注意してください。

![Alt text][5]
##XML の定義
ボキャブラリの型に XML を選択する場合、次の情報を入力する必要があります。  
  a.	[スキーマ] – ここをクリックすると、新しいブレードが表示され、ユーザーは既にアップロードしたスキーマの一覧から選択するか、新しくアップロードすることができます。   
  b.	[XPATH] – 前の手順でスキーマを選択した後にのみ、この入力はロックが解除されます。これをクリックすると、選択したスキーマが表示され、ユーザーはボキャブラリの定義を作成する必要のあるノードを選択できます。  
  c.	[ファクト] – この入力は、ルール エンジンにフィードして処理するデータ オブジェクトを識別します。これは高度なプロパティであり、既定では、選択した XPATH の親に設定されます。FACT は、チェーンと収集のシナリオに特に重要です。

![Alt text][6]

### 一括追加
前の手順では、ボキャブラリの定義を作成しました。一度作成すると、作成したボキャブラリの定義はリスト形式で表示されます。前の手順を毎回繰り返す代わりに、同じスキーマから複数の定義を作成しなければならない場合もあります。このような場合、[一括追加] 機能は非常に便利です。[一括追加] をクリックすると、新しいブレードが開きます。まず、複数の定義を作成するスキーマを選択します。 
これをクリックすると、新しいブレードが開き、ユーザーは既にアップロード済みのスキーマのリストから選択することも、新しいスキーマをアップロードすることもできます。
これで XPATHS プロパティのロックが解除されます。このプロパティをクリックすると、複数のノードが選択できるスキーマ ビューアーが開きます。
作成した複数の定義の名前は既定では選択したノードの名前になります。この名前は作成後にいつでも変更できます。

![Alt text][7]

##ポリシーの作成
開発者が必要なボキャブラリを作成したら、ビジネス アナリストが Azure ポータルを利用してビジネス ポリシーを作成することを想定します。
	1.	作成したルール アプリで、[ポリシー] レンズをクリックすると、ポリシー作成ページに移動します。
	2.	このページには、ルール アプリに含まれるポリシーの一覧が表示されます。ポリシーの名前を入力し、タブをクリックするだけで簡単に新しいポリシーを追加できます。1 つのルール API アプリに複数のポリシーを含めることができます。
	3.	作成したポリシーをクリックすると、ポリシー内のルールを確認できるポリシーの詳細ページに移動します。
	![Alt text][8] 
	4.	新しいルールを追加するには、[新規追加] をクリックします。新しいブレードが開きます。

##ルールの作成
ルールは条件とアクションのステートメントで構成されます。条件が true と評価されると、アクションが実行されます。[ルールの作成] ブレードでは、ポリシーに対して一意のルール名を指定し、説明をオプションで入力します。[条件] ボックスを使用すると、複数の条件ステートメントを作成できます。次のキーワードがサポートされています。
1. 	And – 条件演算子 
2. 	Or – 条件演算子 
3. 	does_not_exist 
4. 	exists 
5. 	false 
6. 	is_equal_to 
7. 	is_greater_than 
8. 	is_greater_than_equal_to 
9. 	is_in 
10. is_less_than 
11. is_less_than_equal_to 
12. is_not_in 
13. is_not_equal_to 
14. mod 
15. true

[アクション(Then)] ボックスには実行されるアクションを作成するために複数のステートメントを含めることができます (1 行につき 1 つ)。次のキーワードがサポートされています。  
1.	equals  
2.	false  
3.	true  
4.	halt  
5.	mod  
6.	null  
7.	update  

[条件] ボックスと [アクション] ボックスでは、ユーザーがルールを簡単に作成するための Intellisense を提供します。この機能は Ctrl キーを押しながら Space キーを押すか、入力を開始することによって起動されます。入力した文字に一致するキーワードが自動的に下にフィルターされ、表示されます。Intellisense ウィンドウにはすべてのキーワードとボキャブラリの定義が表示されます。
![Alt text][9]

##明示的なフォワード チェーン
BizTalk ルールでは明示的なフォワード チェーンがサポートされています。これにより、ユーザーが特定のアクションに応答してルールを再評価する場合、ある特定のキーワードを使用することでルールの再評価をトリガーできます。次のキーワードがサポートされています。  
   1.	update <vocabulary definition> – このキーワードを使用すると、条件内で指定したボキャブラリの定義を使用するすべてのルールを再評価できます。  
   2.	Halt – このキーワードにより、すべてのルールの実行を停止します。

##ルールの有効化/無効化
ポリシーの各ルールは有効または無効にできます。既定では、すべてのルールが有効です。無効に設定したルールはポリシーの実行時に実行されません。ルールの有効化/無効化は、[ルール] ブレードから直接行うことができます。このコマンドは、ブレードの上部のコマンド バーにあります。また、コンテキスト メニュー (ルールを右クリック) に有効化/無効化のオプションがあります。

##ルールの優先順位
すべてのポリシーのルールは順番に実行されます。実行の優先順位は、ポリシー内の順番で決定されます。この優先順位はルールをドラッグ アンド ドロップするだけで変更できます。

##ポリシーのテスト
ポリシーの作成後、運用環境で使用する前にポリシーのテストが用意されています。[ポリシーのテスト] コマンドを使用すると、[ポリシーのテスト] ブレードが開きます。このブレードでは、ポリシーで使用されているボキャブラリの定義の一覧が表示され、ユーザーは入力を求められます。ユーザーはテストのためにこれらの入力に対して手動で値を追加できます。代わりに、入力のテスト XML をインポートすることもできます。すべての入力が完了すると、テストを実行でき、各ボキャブラリの定義の出力が出力列に表示されるので、簡単に確認できます。ビジネス アナリストにとってわかりやすいログを表示するには、[ログの表示] をクリックして、実行ログを表示します。ログを保存するには、[出力の保存] を利用します。個別の分析のテスト関連データをすべて保存できます。

## ロジック アプリでのルールの使用
ポリシーは作成とテストが完了すると、使用できます。ユーザーは、新しいロジック アプリを [新規]、[ロジック アプリ] の順に選択して作成できます。BizTalk ルールは、デザイナーのギャラリーの右側から使用できます。デザイナーの画面上にドラッグ アンド ドロップすることができます。この操作により、対象とするルール API アプリ (アクション) を選択します。アクションには、実行される一連のポリシーが含まれます。ポリシーを選択したら、そのポリシーに対して必要な入力を行います。ユーザーはルール API アプリのダウンストリームからの出力を、後続の決定に使用できます。

## API 経由でのルールの使用
ルール API アプリは豊富な API のセットを使用して起動することもできます。ユーザーはフローの使用だけに限定されず、REST の呼び出しを行うことで任意のアプリケーションでルールを実行できます。利用できる REST API　を確認するには、ルールのダッシュボードで [API の定義] レンズをクリックします。

![Alt text][10]

この API を C# で使用する方法の例を次に示します。

   			// Constructing the JSON message to use in API call to Rules API App

			// xmlInstance is the XML message instance to be passed as input to our Policy
            string xmlInstance = "<ns0:Patient xmlns:ns0="http://tempuri.org/XMLSchema.xsd">  <ns0:Name>Name_0</ns0:Name>  <ns0:Email>Email_0</ns0:Email>  <ns0:PatientID>PatientID_0</ns0:PatientID>  <ns0:Age>10.4</ns0:Age>  <ns0:Claim>    <ns0:ClaimDate>2012-05-31T13:20:00.000-05:00</ns0:ClaimDate>    <ns0:ClaimID>10</ns0:ClaimID>    <ns0:TreatmentID>12</ns0:TreatmentID>    <ns0:ClaimAmount>10000.0</ns0:ClaimAmount>    <ns0:ClaimStatus>ClaimStatus_0</ns0:ClaimStatus>    <ns0:ClaimStatusReason>ClaimStatusReason_0</ns0:ClaimStatusReason>  </ns0:Claim></ns0:Patient>";

            JObject input = new JObject();

			// The JSON object is to be of form {"<XMLSchemName>_<RootNodeName>":"<XML Instance String>".
			// In the below case, we are using XML Schema - "insruanceclaimsschema" and the root node is "Patient".
			// This is CASE SENSITIVE.
            input.Add("insuranceclaimschema_Patient", xmlInstance);
            string stringContent = JsonConvert.SerializeObject(input);


            // Making REST call to Rules API App
            HttpClient httpClient = new HttpClient();

			// The url is the Host URL of the Rules API App
            httpClient.BaseAddress = new Uri("https://rulesservice77492755b7b54c3f9e1df8ba0b065dc6.azurewebsites.net/");
            HttpContent httpContent = new StringContent(stringContent);
            httpContent.Headers.ContentType = MediaTypeHeaderValue.Parse("application/json");

            // Invoking API "Execute" on policy "InsruranceClaimPolicy" and getting response JSON object. The url can be gotten from the API Definition Lens
            var postReponse = httpClient.PostAsync("api/Policies/InsuranceClaimPolicy?comp=Execute", httpContent).Result;

先ほどのルール API アプリのセキュリティ設定が [パブリック (匿名)] であることに注意してください。これは、API アプリ内で、[すべての設定]、[アプリケーション設定]、[アクセス レベル] の順に選択して設定できます。

![Alt text][11]

## ボキャブラリとポリシーの編集
ビジネス ルールを使用する利点は、ビジネス ロジックの変更をより早く運用環境に送ることができる点です。ボキャブラリとポリシーに対する変更は運用環境ですぐに適用されます。ユーザーがボキャブラリの定義やポリシーを個別に参照し、変更を行うだけで、変更が適用されます。

<!--Image references-->
[1]: ./media/app-service-logic-use-biztalk-rules/InsuranceScenario.PNG
[2]: ./media/app-service-logic-use-biztalk-rules/InsuranceBusinessLogic.png
[3]: ./media/app-service-logic-use-biztalk-rules/CreateRuleApiApp.png
[4]: ./media/app-service-logic-use-biztalk-rules/RulesDashboard.png
[5]: ./media/app-service-logic-use-biztalk-rules/LiteralVocab.PNG
[6]: ./media/app-service-logic-use-biztalk-rules/XMLVocab.PNG
[7]: ./media/app-service-logic-use-biztalk-rules/BulkAdd.PNG
[8]: ./media/app-service-logic-use-biztalk-rules/PolicyList.PNG
[9]: ./media/app-service-logic-use-biztalk-rules/RuleCreate.PNG
[10]: ./media/app-service-logic-use-biztalk-rules/APIDef.PNG
[11]: ./media/app-service-logic-use-biztalk-rules/PublicAnon.PNG

<!---HONumber=August15_HO6-->