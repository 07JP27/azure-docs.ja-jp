<properties 
	pageTitle="検出、トリアージ、診断" 
	description="クラッシュを分析し、アプリケーションのパフォーマンスに関する問題を検出して診断する" 
	authors="alancameronwills" 
	services="application-insights" 
    documentationCenter=""
	manager="keboyd"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="04/02/2015" 
	ms.author="awills"/>

# Application Insights を使用した検出、トリアージ、および診断

*Application Insights はプレビュー段階です。*


アプリケーションを発行したら、Application Insights を使用して、アプリケーションが問題なく実行され、正常に動作していることを確認できます。問題がある場合は、そのことをすぐに知り、何をするべきかを特定する必要があります。

* *"当社は数日前に、"軽微" な修正プログラムをデプロイしました。広範なテストは実行しなかったのですが、困ったことに、予期しない変更がペイロードにマージされ、フロント エンドとバック エンドの間に非互換性の問題が発生しました。すぐにサーバーの例外が急増し、アラートが発行され、私たちは状況に気付きました。Application Insights ポータルで数回クリックしただけで、例外の呼び出し履歴から情報を取得し、問題を絞り込むことができました。私たちは直ちにロールバックし、損害を抑えることができました。Application Insights のおかげで、開発運用サイクルのこの部分がとても簡単で実用的なものになっています。"*

開発運用サイクルのこの部分は、1 つのパイプラインと考えることができます。

![検出、トリアージ、診断](./media/app-insights-detect-triage-diagnose/01-pipe1.png)


問題の診断を終えると、コードのデバッグ、割り当てメモリの追加、依存関係のフォローアップなど、どの領域に重点を置いて取り組めばいいかがわかります。最後には、修正措置がうまく機能しているかどうかを確認できます。



![修復、検証](./media/app-insights-detect-triage-diagnose/02-pipe2.png)


Application Insights の働きをパイプラインの段階ごとに見てみましょう。

Application Insights は、デバイス アプリと Web アプリケーションに対して使用できます。このチュートリアルでは、Web アプリケーションを中心に説明します。Fabrikam 銀行でオンライン銀行取引システムを担当している OBS チームを例に取りましょう。チームでは既に Web プロジェクトに Application Insights を追加しています。


![銀行の Web サイトの例](./media/app-insights-detect-triage-diagnose/03-bank.png)



## 可用性の低下を検出する 


Marcela Markova は OBS チームのテスト スペシャリストで、オンライン パフォーマンスの監視を主導しています。Marcela は次のような [Web テスト][availability]を設定しました。

* アプリのメイン ランディング ページの単一 URL テスト (http://fabrikambank.com/onlinebanking/)。Marcela は HTTP コード 200 と "ようこそ!" というテキストの条件を設定しました。このテストに失敗した場合は、ネットワークまたはサーバーに重大な不具合があるか、デプロイメントの問題が発生しています (または、他のメンバーが Marcela に知らせずに、ページの "ようこそ" メッセージに変更を加えた可能性もあります)。 


* 複数手順の詳細なテスト。ログインし、現在のアカウント一覧を取得して、各ページに関する主要な詳細情報を調べます。このテストでは、アカウント データベースへの接続が機能していることを確認します。架空の顧客 ID を使用し、その一部はテスト目的で保持されます。


これらのテストを設定することで、Marcela は、システムが停止してもチームがすぐに知ることができるという安心感を得られています。


エラーは Web テストの概要チャートに赤い点として表示されます。

![前の期間に実行された Web テストの表示](./media/app-insights-detect-triage-diagnose/04-webtests.png)


さらに重要なこととして、あらゆるエラーに関するアラートが開発チームに電子メールで送信されます。このようにして、チームは、ほとんどの顧客よりも先にエラーの発生を把握できます。


## パフォーマンス メトリックを監視する 


可用性チャートと同じ概要ページには、さまざまな[主要メトリック][perf]を示す 1 つのチャートがあります。


![さまざまなメトリック](./media/app-insights-detect-triage-diagnose/05-perfMetrics.png)

[クライアントの処理時間] グラフは、Web ページから直接送信されるテレメトリから生成されます。他のグラフは、Web サーバーで計算されたメトリックを示しています。


[失敗した要求] の数は、ユーザーがエラーに遭遇した事例の数を示しています。このエラーは通常、コード内で例外がスローされた後に発生するエラーです。通常、ユーザーには "申し訳ありませんが、詳細を更新できませんでした" という内容のメッセージが表示されます。また、最悪の場合は、Web サーバーによってユーザーの画面にスタック ダンプが出力されます。


Marcela は、これらのチャートをときどき確認するのを気に入っています。失敗した要求が一定して背景にあるのは少し気がかりですが、これはチームが調査中のバグに関連しているため、修正プログラムがリリースされたら下がるはずです。ただし、失敗した要求や、サーバーの応答時間など他のメトリックの一部で急激な上昇があった場合、Marcela はそのことをすぐに知る必要があります。このような急上昇は、コードのリリースによって生じた予期しない問題、データベースなどの依存関係における障害、または負荷の高い要求に対する異常な反応を示している可能性があります。

#### アラート

そのため、Marcela は 2 つの[アラート][metrics]を設定しています。1 つは応答時間が通常のしきい値を超えた場合に生成され、もう 1 つは失敗した要求の割合が現在の背景より大きくなった場合に生成されます。


これらのアラートと可用性アラートのおかげで、Marcela は、異常事態が発生するとすぐに気付くことができるという自信を持てています。


その他のさまざまなメトリックにもアラートを設定できます。たとえば、例外数が多くなった場合や、使用可能なメモリが少なくなった場合、クライアントの要求が急増した場合に、電子メールを受け取ることができます。



![[アラート] ブレードの追加](./media/app-insights-detect-triage-diagnose/07-alerts.png)




## 例外の検出


Application Insights に例外が報告されるようにするには、次に示すように、[TrackException()][api] を呼び出します。

    var telemetry = new TelemetryClient();
    ...
    try 
    { ...
    }
    catch (Exception ex)
    {
       // Set up some properties:
       var properties = new Dictionary <string, string> 
         {{"Game", currentGame.Name}};

       var measurements = new Dictionary <string, double>
         {{"Users", currentGame.Users.Count}};

       // Send the exception telemetry:
       telemetry.TrackException(ex, properties, measurements);
    }


Fabrikam 銀行のチームは、明らかな回復が見られない限り、例外に関するテレメトリを必ず送信するという習慣を確立してきました。

実際には、それよりはるかに広範な戦略となっており、コード内に対応する例外があるかどうかにかかわらず、希望していた結果について顧客が不満を示している場合は常にテレメトリを送信しています。たとえば、(顧客の過失以外の) 運用上の理由により外部の銀行間振替システムから "このトランザクションを完了できません" という趣旨のメッセージが返された場合、チームはそのイベントを追跡します。

    var successCode = AttemptTransfer(transferAmount, ...);
    if (successCode < 0)
    {
       var properties = new Dictionary <string, string> 
            {{ "Code", returnCode, ... }};
       var measurements = new Dictionary <string, double>
         {{"Value", transferAmount}};
       telemetry.TrackEvent("transfer failed", properties, measurements);
    }

TrackException はスタックのコピーを送信するので、例外を報告するために使用されます。TrackEvent はその他のイベントを報告するために使用されます。これらに、診断に役立つ可能性のあるプロパティをアタッチできます。

例外とイベントは、[[診断検索]][diagnostic] ブレードに表示されます。ここで詳細を調査し、細かいプロパティとスタック トレースを確認できます。

![[診断検索] で、フィルターを使用して特定の型のデータを表示する](./media/appinsights/appinsights-333facets.png)

## 良好なイベントの監視 


Fabrikam の開発チームでは、問題のあるイベントだけでなく良好なイベントも追跡しています。その理由の 1 つは、良好なイベントがどれくらい、どの領域で発生しているかを知ることは気分が良いためで、もう 1 つの理由は、良好なイベントが突然停止したときは何か問題が生じているためです。


一例を挙げると、多くのユーザー行動にははっきりとした "じょうご" があります。たとえば、多数の顧客が各種ローンの金利を調べます。そのうちの一部が見積もりフォームに入力し、さらに、見積もりを取得した顧客の一部が実際にローンを組みます。


開発チームは、このじょうごの各段階に TrackMetric() の呼び出しを挿入しています。これにより、ビジネス アーキテクトの Brian は、メトリックス エクスプローラーで、各メトリックの値を比較し、システムにおけるローンの売れ行きを予測できます。


UX スペシャリストの Ursula も良好なメトリックを監視しています。チャート上でじょうごのいずれかの段階に急激な低下が見られる場合は、何か問題が発生していることを示しています。適切なボタンを見つけにくいか、文言に訴求力が足りないのかもしれません。バグが発生している可能性もあります。ユーザーがボタンをクリックしても動作しないのかもしれません。


## プロアクティブな監視  


Marcela は、ただ座ってアラートを待っているのではありません。再デプロイメントの後には、いつもすぐに、例外数だけでなく、[応答時間][perf]に関して、全体的な数値と最も遅い要求の表の両方を確認しています。



![応答時間のグラフとサーバー応答時間のグリッド](./media/app-insights-detect-triage-diagnose/09-dependencies.png)

これをもとに、各デプロイメントがパフォーマンスに与える影響を評価できます。Marcela は通常は各週の値を前週の値と比較しています。急な悪化が見られる場合は、関連する開発者に連絡します。


## トリアージ 


トリアージとは、問題の重要度と影響範囲に関する評価のことで、検出後の最初のステップです。深夜にチームを呼び出すべきか。 都合がつく次の空きまでバックログに残せるか。 トリアージには重要な問いが伴います。


どの程度発生しているか。 [概要] ブレードのチャートを見れば、問題について特定の観点を得ることができます。たとえば、ある晩、Fabrikam のアプリケーションによって 4 つの Web テスト アラートが生成されました。翌朝チームはチャートを見て、テストの大半が緑色である中に赤い点がいくつかあることに気付きました。可用性チャートを詳細に調べると、断続的な問題がすべて 1 つのテスト場所から発生していることがわかりました。これは明らかに、ネットワークの問題が 1 つのルートのみに影響を与えているためで、自然に解決する可能性が高そうでした。


一方、例外数や応答時間のグラフに急激な上昇が見られる場合は、当然、直ちに対処が必要です。


トリアージに役立つ戦術は、"自分でやってみる" です。同じ問題に遭遇すれば、それが現実であることがわかります。


どれくらいの割合のユーザーが影響を受けているのか。 そのおおよその答えは、障害発生率をセッション数で割って得ることができます。


![失敗した要求およびセッションのチャート](./media/app-insights-detect-triage-diagnose/10-failureRate.png)

応答速度の低下の場合は、最も反応が遅い要求の表を各ページの使用頻度と比較します。


ブロックされたシナリオの重要度はどれくらいでしょうか。 特定のユーザー ストーリーをブロックしている機能上の問題は、重要度が高いのでしょうか。 顧客が請求書の支払いをできないのであれば重大です。画面の色の設定を変更できない場合は急がなくても大丈夫でしょう。イベントや例外の詳細、または遅いページの ID を見れば、顧客に問題が発生している領域がわかります。


## 診断 


診断は、デバッグとまったく同じではありません。コードのトレースを開始するには、まず、問題が発生している原因、場所、状況について大まかに理解する必要があります。


**どのような状況で発生するのか。** イベント チャートやメトリック チャートで提供される履歴ビューを使用すると、影響と考えられる原因とを関連付けるのが容易になります。応答時間や例外率に断続的なピークが見られる場合は、要求数を確認します。複数のピークが同時に発生している場合は、リソースの問題が考えられます。CPU やメモリの割り当てを増やす必要があるか、 依存関係で負荷に対処できていないのかもしれません。


**自社システムが原因か。** 特定の種類の要求のパフォーマンスが急激に低下している場合、たとえば、顧客が口座明細書を必要としているときなどは、Web アプリケーションではなく外部のサブシステムが原因である可能性があります。メトリック エクスプローラーで、[依存関係のエラー] の割合と [依存関係の期間] の割合を選択し、検出された問題を過去数時間または数日の履歴と比較します。相関関係のある変更が見つかる場合は、外部のサブシステムに原因があると考えられます。


![依存関係のエラーおよび依存関係の呼び出しの時間のチャート](./media/app-insights-detect-triage-diagnose/11-dependencies.png)

依存関係の速度低下の問題の中には、地理的な問題があります。Fabrikam 銀行では Azure Virtual Machines を使用していますが、Web サーバーとアカウント サーバーが意図せず複数の国に配置されていることがわかりました。そのうち 1 つを移行することで、速度は大幅に改善されました。


**何を実行したか。** 依存関係に問題が見つからない場合や、以前は常に問題があったわけではない場合、最近の変更が問題の原因である可能性があります。メトリック チャートやイベント チャートで提供される履歴を確認すれば、急激な変化とデプロイメントの関連付けが容易になります。これにより、問題の検索を絞り込むことができます。


**何が起こっているのか。** 問題によっては、まれにしか発生しないために、オフラインでテストして追跡するが難しいものがあります。このような場合は、ライブ環境で発生したときにバグをキャプチャするしかありません。例外レポートでスタック ダンプを調査できます。また、使い慣れたログ記録フレームワークか TrackTrace() または TrackEvent() を使用して、トレースの呼び出しを記述できます。


Fabrikam では、口座間振替で断続的な問題が発生しましたが、該当するのは特定の種類の口座のみでした。何が起こっていたかを詳しく理解するために、チームはコード内の主要ポイントに TrackTrace() の呼び出しを挿入し、各呼び出しにプロパティとして口座の種類をアタッチしました。こうすることで、[診断検索] でトレースをフィルター処理しやすくなりました。また、トレースの呼び出しにプロパティおよび測定値としてパラメーター値をアタッチしました。


## 問題への対処 


問題を診断したら、修正のためのプランを作成できます。最近の変更をロールバックする必要があるかもしれませんし、修正を加えることができるかもしれません。修正が済めば、Application Insights を使用して、成功したかどうかを確認できます。


Fabrikam 銀行の開発チームは、Application Insights を使用する前と比べて、パフォーマンス測定に対するアプローチが次のように構造化されています。

* Application Insights の [概要] ページで特定の測定値についてパフォーマンスの目標を設定しました。 

* "じょうご" 内のユーザーの進み具合を測定するメトリックなど、パフォーマンスの測定値を最初からアプリケーションに組み込みました。




## 使用法

Application Insights を使用して、ユーザーによるアプリの使用状況を知ることもできます。アプリが問題なく実行されているなら、チームは、どの機能に最も人気があるか、ユーザーは何を気に入っていて何がうまくいっていないか、どれくらいの頻度で使用しているかを知りたいと考えるでしょう。それらを把握すれば、今後の作業に優先順位を付けるのに役立ちます。開発サイクルの一環として、各機能の効果を評価する計画を立てることができます。詳細については、[こちら][usage]を参照してください。

## ご利用のアプリケーションへの応用

この記事では、1 つのチームが Application Insights を使用して、個々の問題を修正するだけでなく、開発ライフサイクルを改善するようすを紹介しました。皆様が Application Insights を活用してアプリケーションのパフォーマンスを向上する方法を理解するお役に立てればさいわいです。

## ビデオ

[AZURE.VIDEO app-insights-performance-monitoring]

<!--Link references-->

[api]: app-insights-api-custom-events-metrics.md
[availability]: app-insights-monitor-web-app-availability.md
[diagnostic]: app-insights-diagnostic-search.md
[metrics]: app-insights-metrics-explorer.md
[perf]: app-insights-web-monitor-performance.md
[usage]: app-insights-web-track-usage.md


<!--HONumber=54-->