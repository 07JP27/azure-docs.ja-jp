<properties 
   pageTitle="ユーザー定義のルートと IP 転送の概要"
   description="ユーザー定義のルート (UDR) と IP 転送の概要"
   services="virtual-networks"
   documentationCenter="na"
   authors="telmosampaio"
   manager="adinah"
   editor="tysonn" />
<tags 
   ms.service="virtual-networks"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="04/22/2015"
   ms.author="telmos" />

# ユーザー定義のルートと IP 転送
Azure では、IP トラフィックを各パケットの宛先に基づいて転送する方法がルート テーブルを使用して決定されます。Azure には、仮想ネットワークの設定に基づく既定のルート テーブルが備わっていますが、そのテーブルにカスタム ルートを追加しなければならないこともあります。ルート テーブルにカスタム エントリが必要となる最も一般的な状況は、Azure 環境で仮想アプライアンスを使用するケースです。以下の図のシナリオを考えてみます。フロントエンドのサブネットから中間層とバックエンドのサブネットに向かうすべてのトラフィックに仮想ファイアウォール アプライアンスを経由させる必要があるとします。そのアプライアンスを仮想ネットワークに追加して各サブネットに接続しただけでは、この機能を実現できません。仮想ファイアウォール アプライアンスに対してパケットが確実に転送されるように、サブネットに適用されたルーティング テーブルにも変更を加える必要があります。

同じことは、Azure Virtual Network とインターネット間のトラフィックを制御する仮想 NAT アプライアンスが導入されている場合にも当てはまります。確実に仮想アプライアンスを経由させるためには、インターネットに向かうすべてのトラフィックを仮想アプライアンスに転送するようにルートを作成しなければなりません。

## ルーティング
パケットは、物理ネットワーク上の各ノードに定義されているルート テーブルに基づき、TCP/IP ネットワークを介してルーティングされます。ルート テーブルは、宛先 IP アドレスに基づいてパケットの転送先を決定する目的で使用される個々のルートの集まりです。ルートの構成要素を次に示します。

- **アドレス プレフィックス**。ルートの適用対象となる宛先の CIDR 表記 (例: 10.1.0.0/16)。
- **次ホップの種類**。パケットの送信先となる Azure ホップの種類。次のいずれかの値になります。
	- **Local**: ローカルの仮想ネットワークを表します。たとえば、同じ仮想ネットワークに 10.1.0.0/16 と 10.2.0.0/16 の 2 つのサブネットがある場合、ルート テーブル内の各サブネットのルートは、次ホップの値が *Local* になります。
	- **VPN Gateway**:Azure S2S VPN ゲートウェイを表します。 
	- **Internet**: Azure インフラストラクチャによって提供される既定のインターネット ゲートウェイを表します。 
	- **Virtual Appliance**:Azure Virtual Network に追加した仮想アプライアンスを表します。
	- **NULL**: ブラック ホールを表します。ブラック ホールに転送されたパケットはまったく転送されません。
- **次ホップの値**。次ホップの値には、パケットの転送先となる IP アドレスが格納されます。次ホップの値が使用できるのは、次ホップの種類が *Virtual Appliance* であるルートに限られます。

## 既定のルート
仮想ネットワークに作成されるすべてのサブネットは、既定のルート ルールを含んだルート テーブルに自動的に関連付けられます。次のルールがあります。仮想ネットワーク内のすべてのサブネットには、
- **ローカル Vnet ルール**が自動的に作成されます。VNet 内の VM どうしの間に直接リンクが存在し、中間の次ホップは存在しない、というルールが記述されています。オンプレミス アドレス範囲宛てのすべてのトラフィックには
- **オンプレミス ルール**が適用されます。このルールでは、VPN ゲートウェイが次ホップの宛先として使用されます。
- **インターネット ルール**は、パブリック インターネット宛てのすべてのトラフィックを処理するルールです。インフラストラクチャのインターネット ゲートウェイが、インターネット宛てのすべてのトラフィックの次ホップとして使用されます。

## BGP のルート
オンプレミス ネットワークと Azure との間に ExpressRoute 接続が存在する場合、BGP を有効にして、オンプレミス ネットワークから Azure へとルートを伝達することができます。これらの BGP ルートは、各 Azure サブネットで既定のルートやユーザー定義のルートと同じように使用されます。詳細については、[ExpressRoute の概要](../expressroute-introduction)に関するページを参照してください。

[AZURE.IMPORTANT]VPN ゲートウェイを次ホップとする、サブネット 0.0.0.0/0 宛てのユーザー定義のルートを作成することで、オンプレミス ネットワークを介した強制トンネリングを使用するように Azure 環境を構成することができます。ただし、この方法が利用できるのは、VPN ゲートウェイを使用している場合に限られます。ExpressRoute では利用できません。ExpressRoute の場合、強制トンネリングは BGP を介して構成します。

## ユーザー定義のルート
以上、Azure 環境の既定のルートについて述べてきましたが、それらのルートを表示することはできません。また、実際に必要となるのは、ほとんどの環境では既定のルートだけです。ただし、ある特定のケースにおいては、ルート テーブルを作成して独自にルートを追加する必要があります。その例を次に示します。

- インターネットへのオンプレミス ネットワークを介した強制トンネリング。
- Azure 環境での仮想アプライアンスの使用。
- 
以上のシナリオでは、ルート テーブルを作成してユーザー定義のルートを追加する必要があります。ルート テーブルは複数設定することができ、また、同じルート テーブルを 1 つまたは複数のサブネットに関連付けることができます。ただし、関連付けることができるルート テーブルは各サブネットにつき 1 つだけです。サブネット内のすべての VM およびクラウド サービスは、そのサブネットに関連付けられているルート テーブルを使用します。

サブネットにルート テーブルが関連付けられるまでは、既定のルートが使用されます。いったん関連付けがなされると、ユーザー定義のルートと既定のルートとで、LPM (Longest Prefix Match) に基づくルーティングが行われます。同じ LPM マッチの複数のルートが存在する場合は、そのルートが検出された経緯に応じて次の順序でルートが選択されます。

1. ユーザーの定義ルート
1. BGP のルート (ExpressRoute を使用している場合)
1. 既定のルート

[AZURE.IMPORTANT]ユーザー定義のルートが適用されるのは、Azure VM とクラウド サービスだけです。たとえば、オンプレミス ネットワークと Azure との間にファイアウォール仮想アプライアンスを追加する場合、オンプレミスのアドレス空間に向かうすべてのトラフィックを仮想アプライアンスに転送するユーザー定義のルートを Azure ルート テーブルに作成する必要があります。一方、オンプレミスのアドレス空間から入ってくるトラフィックは、VPN ゲートウェイまたは ExpressRoute 回線を経由し、仮想アプライアンスを飛び越えて直接 Azure 環境に向かいます。

## IP 転送
これまで説明してきたように、ユーザー定義のルートを作成する主な目的の 1 つは、トラフィックを仮想アプライアンスに転送することです。仮想アプライアンスは、アプリケーションを実行する VM にすぎません。ファイアウォールや NAT デバイスなど、ネットワーク トラフィックを何らかの方法で処理するために使用されるアプリケーションが仮想アプライアンスで実行されます。

仮想アプライアンスとして機能するこの VM は、自分宛てではない着信トラフィックを受信できることが必要です。VM が自分以外の宛先に向かうトラフィックを受信するためには、VM の IP 転送を有効にする必要があります。

## 関連項目

[Azure でルートを作成して IP 転送を有効にする方法](../virtual-networks-udr-how-to)

[インスタンスレベル パブリック IP (ILIP)](../virtual-networks-instance-level-public-ip)

[仮想ネットワークの概要](https://msdn.microsoft.com/library/azure/jj156007.aspx)

<!--HONumber=52-->
 