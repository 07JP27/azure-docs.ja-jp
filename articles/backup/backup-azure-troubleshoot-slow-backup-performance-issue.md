<properties
   pageTitle="Azure Backup でファイルやフォルダーのバックアップが遅い場合のトラブルシューティング | Microsoft Azure"
   description="Azure Backup のパフォーマンスの問題を診断して原因を絞り込むためのトラブルシューティングの指針を紹介します。"
   services="backup"
   documentationCenter=""
   authors="genlin"
   manager="jimpark"
   editor=""/>

<tags
    ms.service="backup"
    ms.workload="storage-backup-recovery"
    ms.tgt_pltfrm="na"
    ms.devlang="na"
    ms.topic="article"
    ms.date="07/20/2016"
    ms.author="genli"/>

# Azure Backup でファイルやフォルダーのバックアップが遅い場合のトラブルシューティング

この記事では、Azure Backup で行うファイルやフォルダーのバックアップに関して、パフォーマンスが低下している原因を診断して絞り込むためのトラブルシューティングの指針を紹介します。Azure Backup エージェントを使用してファイルをバックアップするとき、予想以上にバックアップ処理に時間がかかる場合があります。次のいずれかまたは複数の事柄が原因として考えられます。

-	[バックアップ対象コンピューターにパフォーマンスのボトルネックが存在する](#cause1)。
-	[別のプロセスまたはウイルス対策ソフトウェアが Azure Backup の妨げとなっている](#cause2)。
-	[Azure 仮想マシン (VM) で Backup エージェントが実行されている](#cause3)。
-	[大量 (数百万個以上) のファイルをバックアップしようとしている](#cause4)。

次のセクションでは、問題の具体的な原因をわかりやすく説明しています。

トラブルシューティングを開始する前に、[最新の Azure Backup エージェント](http://aka.ms/azurebackup_agent)をダウンロードしてインストールするようお勧めします。Backup エージェントは、さまざまな問題の解決、機能の追加、パフォーマンスの改善を目的として絶えず更新されています。

また、一般的な構成の問題ではないことを確認するために、「[Azure Backup サービス - FAQ](backup-azure-backup-faq.md)」に目を通すよう強くお勧めします。

[AZURE.INCLUDE [support-disclaimer](../../includes/support-disclaimer.md)]

## トラブルシューティングの手順
<a id="cause1"></a>
## 原因 1: バックアップ対象コンピューターにパフォーマンスのボトルネックが存在するためにバックアップが遅い

### 解決策

バックアップ対象コンピューターに、速度低下の原因となる何らかのボトルネックが存在する可能性があります。たとえばコンピューターのディスク読み取り/書き込み能力や、ネットワーク経由でのデータ送信に使用される帯域幅が挙げられます。

こうしたボトルネックを検出するために、Windows には[パフォーマンス モニター](https://technet.microsoft.com/magazine/2008.08.pulse.aspx) (Perfmon) と呼ばれるツールがネイティブで搭載されています。以下の表は、パフォーマンス カウンターと Backup が最適な状態で動作する範囲をまとめたものです。

パフォーマンス カウンターとボトルネック診断の目安となる範囲を以下に示します。

| カウンター | 状態 |
|---|---|
|Logical Disk(Physical Disk)--%idle | • 100% アイドル～ 50% アイドル = 正常</br>• 49% アイドル～ 20% アイドル = 警告または監視</br>• 19% アイドル～ 0% アイドル = 重大または基準不適合|
| Logical Disk(Physical Disk)--%Avg.Disk Sec Read or Write | • 0.001ms ～ 0.015ms = 正常</br>• 0.015ms ～ 0.025 = 警告または監視</br>• 0.026ms 超 = 重大または基準不適合|
| Logical Disk(Physical Disk)--Current Disk Queue Length (全インスタンス) | 要求数が 80 件の状態が 6 分超 |
| Memory--Pool Non Paged Bytes|• プールの 60% 未満を消費 = 正常<br>• プールの 61% ～ 80% を消費 = 警告または監視</br>• プールの 80% 超を消費 = 重大または基準不適合|
| Memory--Pool Paged Bytes |• プールの 60% 未満を消費 = 正常</br>• プールの 61% ～ 80% を消費 = 警告または監視</br>• プールの 80% 超を消費 = 重大または基準不適合|
| Memory--Available Megabytes| • 空きメモリ 50% 以上 = 正常</br>• 空きメモリ 25% = 監視</br>• 空きメモリ 10% = 警告</br>• 空きメモリ 100 MB または 5% = 重大または基準不適合|
|Processor--\\%Processor Time (全インスタンス)|• 60% 未満を消費 = 正常</br>• 61% ～ 90% を消費 = 監視または注意</br>• 91% ～ 100% を消費 = 重大|


> [AZURE.NOTE] 当該インフラストラクチャに問題の原因がある可能性が高いとわかったら、パフォーマンスを改善するために、保護対象となるディスクのデフラグを定期的に実行することをお勧めします。

<a id="cause2"></a>
## 原因 2: 別のプロセスまたはウイルス対策ソフトウェアが Azure Backup プロセスの妨げとなっている

Windows システム内の他のプロセスが Azure Backup エージェントのプロセスのパフォーマンスに悪影響を及ぼすいくつかのケースが確認されています。たとえば Azure Backup エージェントと別のプログラムを両方使用してデータをバックアップしている場合や、ウイルス対策ソフトウェアが実行されていてバックアップ対象ファイルがロックされている場合、ファイルに対する複数のロックが競合している可能性があります。この状況ではバックアップに失敗するか、ジョブに予想以上の時間がかかる可能性があります。

### 解決策

この状況で最も推奨される対策は、他のバックアップ プログラムを無効にして、Azure Backup エージェントのバックアップ時間が変化するかどうかを確認することです。通常、複数のバックアップ ジョブが同時に実行されないようにすれば、互いに干渉する状況は回避できます。

ウイルス対策プログラムの場合は、次のファイルと場所を除外するようお勧めします。

- C:\\Program Files\\Microsoft Azure Recovery Services Agent\\bin\\cbengine.exe をプロセスとして除外します。
- C:\\Program Files\\Microsoft Azure Recovery Services Agent\\ フォルダーを除外します。
- Scratch の場所を除外します (上記の標準的な場所を使用していない場合)。

<a id="cause3"></a>
## 原因 3: Azure 仮想マシン (VM) で Backup エージェントが実行されている

### 解決策

Backup エージェントを VM で実行している場合、パフォーマンスは物理マシンで実行した場合よりも低くなります。これは IOPS の制限によるものと考えられます。ただし、バックアップ対象のデータ ドライブを Premium Storage に切り替えることによってパフォーマンスを最適化することができます。Microsoft は現在この問題の解決に取り組んでおり、将来のリリースで修正プログラムが公開される予定です。

<a id="cause4"></a>
## 原因 4: 大量 (数百万個以上) のファイルをバックアップしようとしている

### 解決策

当然、大きなデータを移動するときの方が、小さいデータを移動するときよりも時間がかかります。しかし場合によっては、バックアップ時間が、データのサイズだけでなく、ファイル数やフォルダー数に関係していることもあります。何百万という小さな (数バイトから数キロバイトの) ファイルがバックアップ対象であるときはなおさらです。

この動作の原因は、Microsoft がデータをバックアップして Azure に移動する際、同時にファイルをカタログ化しており、まれに、カタログ化の処理に時間がかかる場合があるためです。

次の手順に従ってボトルネックを把握し、それに応じた対策を講じてください。

a.**転送済みデータ量の進行状況が UI に表示されている** - この場合、データの転送は進行中です。ネットワークの帯域幅またはデータのサイズが速度低下を招いている可能性があります。

b.**進行状況が UI に表示されていない** - この場合は、"C:\\Microsoft Azure Recovery Services Agent\\Temp" に格納されているログを開き、"FileProvider::EndData" というログ エントリが記録されているかどうかを確認します。このエントリは、データ転送が完了し、カタログ処理が進行中であることを表します。バックアップ ジョブをキャンセルせずに、カタログ化の処理が完了するまで、もうしばらくお待ちください。問題が解決しない場合は、[Azure サポート](https://portal.azure.com/#create/Microsoft.Support)にお問い合わせください。

<!---HONumber=AcomDC_0727_2016-->