---
title: DPM を使用してワークロードを Azure にバックアップする
description: DPM データを Azure Recovery Services コンテナーにバックアップする手順の概要。
services: backup
author: adigan
manager: nkolli
keywords: System Center Data Protection Manager, Data Protection Manager, DPM バックアップ
ms.service: backup
ms.topic: conceptual
ms.date: 8/22/2018
ms.author: adigan
ms.openlocfilehash: 2da5b04f56a5746fb77de6bc954bb5971eb4664b
ms.sourcegitcommit: 55952b90dc3935a8ea8baeaae9692dbb9bedb47f
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/09/2018
ms.locfileid: "48885172"
---
# <a name="preparing-to-back-up-workloads-to-azure-with-dpm"></a>DPM を使用して Azure へのワークロードをバックアップするための準備
> [!div class="op_single_selector"]
> * [Azure Backup Server](backup-azure-microsoft-azure-backup.md)
> * [SCDPM](backup-azure-dpm-introduction.md)
>
>

この記事では、System Center Data Protection Manager (DPM) データを Azure にバックアップする方法を説明します。次の内容が含まれています。

* DPM サーバー データを Azure にバックアップする方法
* スムーズなバックアップ操作を実現するための前提条件
* 一般的に発生するエラーとその対処法
* サポートされるシナリオ

> [!NOTE]
> Azure には、リソースの作成と操作に関して 2 種類のデプロイメント モデルがあります。[Resource Manager デプロイメント モデルとクラシック デプロイメント モデル](../azure-resource-manager/resource-manager-deployment-model.md)です。 この記事では、Resource Manager モデルを使用してデプロイされた VM を復元するための情報および手順を示しています。
>
>

[System Center DPM](https://docs.microsoft.com/system-center/dpm/dpm-overview) は、ファイルとアプリケーション データをバックアップします。 サポートされるワークロードについて詳しくは、[こちら](https://docs.microsoft.com/system-center/dpm/dpm-protection-matrix)をご覧ください。 DPM にバックアップされるデータは、テープやディスクに保存することも、Microsoft Azure Backup を使って Azure にバックアップすることもできます。 DPM は、Azure Backup と次のように対話します。

* **物理サーバーまたはオンプレミス仮想マシンとしてデプロイされている DPM** — 物理サーバーまたはオンプレミス Hyper-V 仮想マシンとしてデプロイされている DPM は、ディスクやテープだけでなく、Recovery Services コンテナーにもデータをバックアップします。
* **Azure の仮想マシンとしてデプロイされている DPM** — System Center 2012 R2 Update 3 以降、 Azure 仮想マシンとして DPM をデプロイできます。 DPM が Azure 仮想マシンとしてデプロイされている場合、VM にアタッチされている Azure ディスクにデータをバックアップできます。またはデータを Recovery Services コンテナーにバックアップして、データ ストレージをオフロードすることもできます。

## <a name="why-back-up-dpm-to-azure"></a>DPM を Azure にバックアップする理由
DPM サーバーを Azure にバックアップするメリットは、次のとおりです。

* オンプレミスの DPM デプロイでは、Azure をテープへの長期的なデプロイの代替手段として使用できます。
* Azure 内の VM への DPM のデプロイでは、Azure ディスクからストレージをオフロードできます。 Recovery Services コンテナーに古いデータを格納することで、ディスクに新しいデータを格納してビジネスをスケールアップできます。

## <a name="prerequisites"></a>前提条件
DPM データをバックアップするために Azure Backup を準備するには、次のようにします。

1. **Recovery Services コンテナーの作成** — Azure ポータルでコンテナーを作成します。
2. **コンテナーのダウンロード** — Recovery Services コンテナーに DPM サーバーを登録するために使用する資格情報をダウンロードします。
3. **Azure Backup エージェントのインストール** — 各 DPM サーバーにエージェントをインストールします。
4. **サーバーの登録** — Recovery Services コンテナーに DPM サーバーを登録します。

[!INCLUDE [backup-upgrade-mars-agent.md](../../includes/backup-upgrade-mars-agent.md)]

## <a name="key-definitions"></a>重要な定義
DPM 用の Azure へのバックアップに関する重要な定義を次に示します。

1. **コンテナー資格情報** - コンテナー資格情報は、Azure Backup サービスで識別されたコンテナーにバックアップ データを送信するコンピューターを認証するために必要になります。 コンテナーからダウンロードすることができ、有効期間は 48 時間です。
2. **パスフレーズ** - パスフレーズは、クラウドへのバックアップを暗号化する際に使用されます。 回復操作中に必要になるため、ファイルは安全な場所に保存してください。
3. **セキュリティ PIN** - コンテナーの [セキュリティ設定](https://docs.microsoft.com/azure/backup/backup-azure-security-feature) を有効にしている場合、重要なバックアップ操作を実行する際にセキュリティ PIN が必要になります。 この多要素認証により、セキュリティの別のレイヤーが追加されます。 
4. **回復先フォルダー** - クラウドの回復中に、クラウドからのバックアップがこのフォルダーに一時的にダウンロードされます。 サイズは、同時に回復するバックアップ アイテムのサイズとほぼ同じである必要があります。

[!INCLUDE [backup-create-rs-vault.md](../../includes/backup-create-rs-vault.md)]

## <a name="edit-storage-replication"></a>ストレージ レプリケーションを編集する

ストレージ レプリケーションでは、geo 冗長ストレージとローカル冗長ストレージのどちらかを選択できます。 既定では、コンテナーには geo 冗長ストレージがあります。 コンテナーがプライマリ バックアップの場合は、オプションの設定を geo 冗長ストレージのままにします。 耐久性が十分でなくても低コストなバックアップが必要な場合は、以下の手順を使用して、ローカル冗長ストレージを構成します。 [geo 冗長](../storage/common/storage-redundancy-grs.md)ストレージ オプションと[ローカル冗長](../storage/common/storage-redundancy-lrs.md)ストレージ オプションの詳細については、[Azure Storage のレプリケーションの概要](../storage/common/storage-redundancy.md)に関する記事をご覧ください。

ストレージ レプリケーション設定を編集するには、次の手順を実行します。

> [!NOTE] 
> 最初のバックアップをトリガーする前に、ストレージ レプリケーションを構成してください。 保護された項目をバックアップした後にストレージ レプリケーションの構成を変更することにした場合は、ストレージ構成を切り替える前に、コンテナー上の保護を停止する必要があります。
>  

1. 目的のコンテナーを選択し、そのコンテナー ダッシュボードを開きます。

2. **[管理]** セクションで、**[バックアップ インフラストラクチャ]** をクリックします。

3. **[バックアップ構成]** メニューで、コンテナーのストレージ レプリケーション オプションを選択します。

    ![バックアップ コンテナーの一覧](./media/backup-azure-dpm-introduction/choose-storage-configuration-rs-vault.png)

    コンテナーのストレージ オプションを選択したら、VM をコンテナーに関連付けることができます。 関連付けを開始するには、Azure 仮想マシンを検出して登録する必要があります。

## <a name="download-vault-credentials"></a>コンテナー資格情報のダウンロード
コンテナーの資格情報ファイルは、各バックアップコンテナーごとにポータルによって生成される証明書です。 ポータルは公開キーを Access Control Service (ACS) にアップロードします。 マシン登録ワークフローの中で、ユーザーは、証明書の秘密キーを使用できるようになります。この秘密キーによって、マシンが認証されます。 認証に基づき、Azure Backup サービスは、指定されたコンテナーにデータを送信します。

コンテナーの資格情報は登録ワークフロー中しか使用されません。 コンテナーの資格情報ファイルが漏えいしないようにするのはユーザーの責任です。 資格情報のコントロールが失われた場合は、コンテナーの資格情報を使用して、他のマシンをコンテナーに登録できます。 ただし、バックアップ データは顧客に属するパスフレーズを使用して暗号化されているため、既存のバックアップ データが漏えいすることはありません。 また、このような懸念を緩和するために、コンテナーの資格情報は、48 時間が経過すると期限切れになります。 新しいコンテナー資格情報は、必要な回数だけダウンロードしてください。 ただし、登録ワークフローでは、最新のコンテナー資格情報ファイルのみを使用してください。

コンテナーの資格情報ファイルは、セキュリティで保護されたチャネルを介して Azure ポータルからダウンロードされます。 Azure Backup サービスでは、証明書の秘密キーは認識されません。また、ポータルまたはサービスでは、この秘密キーは使用できません。 コンテナーの資格情報ファイルをローカル コンピューターにダウンロードするには、次の手順を使用します。

1. [Azure Portal](https://portal.azure.com/) にサインインします。

2. DPM サーバーに登録する Recovery Services コンテナーを開きます。

3. [設定] メニューが既定で開きます。 このメニューが開かない場合は、コンテナー ダッシュボード上で **[設定]** をクリックして開きます。 **[設定]** メニューで、**[プロパティ]** をクリックします。

    ![コンテナー メニューを開く](./media/backup-azure-dpm-introduction/vault-settings-dpm.png)

4. [プロパティ] ページの **[バックアップ資格情報]** の下で、**[ダウンロード]** をクリックします。 ポータルは、ダウンロードで使用可能な資格情報コンテナーの資格情報ファイルを生成します。

    ![[ダウンロード]](./media/backup-azure-dpm-introduction/vault-credentials.png)

ポータルは、コンテナーの名前と現在の日付の組み合わせを使用して、コンテナーの資格情報を生成します。 **[保存]** をクリックして、コンテナーの資格情報をローカル アカウントのダウンロード フォルダーにダウンロードするか、[保存] メニューから [名前を付けて保存] を選択して、保存場所を指定します。 ファイルの生成には最大で 1 分かかります。

### <a name="note"></a>注
* 資格情報コンテナーの資格情報ファイルは、使用するコンピューターからアクセスできる場所に保存してください。 ファイル共有 / SMB に格納されている場合は、アクセス許可を確認します。
* コンテナーの資格情報ファイルは登録ワークフロー中しか使用されません。
* コンテナーの資格情報ファイルの有効期限は 48 時間であり、ポータルからダウンロードすることができます。

## <a name="install-backup-agent"></a>Backup エージェントのインストール
Azure Backup コンテナーを作成したら、エージェントを各 Windows コンピューター (Windows Server、Windows クライアント、System Center Data Protection Manager サーバー、Azure Backup サーバー コンピューター) にインストールする必要があります。このエージェントにより、データやアプリケーションを Azure にバックアップできるようになります。

1. DPM コンピューターを登録する Recovery Services コンテナーを開きます。
2. [設定] メニューが既定で開きます。 それが閉じている場合は、**[設定]** をクリックして [設定] メニューを開きます。 [設定] メニューの **[プロパティ]** をクリックします。

    ![コンテナー メニューを開く](./media/backup-azure-dpm-introduction/vault-settings-dpm.png)
3. [設定] ページで、**[Azure Backup エージェント]** の下の **[ダウンロード]** をクリックします。

    ![[ダウンロード]](./media/backup-azure-dpm-introduction/azure-backup-agent.png)

   エージェントがダウンロードされたら、MARSAgentInstaller.exe を実行して Azure Backup エージェントのインストールを開始します。 エージェントに必要なインストール フォルダーとスクラッチ フォルダーを選択します。 指定されたキャッシュの場所には、バックアップ データの 5% 以上の空き領域が必要です。

4. プロキシ サーバーを使用してインターネットに接続する場合、 **[プロキシ構成]** 画面で、プロキシ サーバーの詳細を入力します。 認証済みのプロキシを使用する場合は、この画面でユーザー名とパスワードの詳細を入力します。

5. Azure Backup エージェントは、.NET Framework 4.5 と Windows PowerShell を (まだ使用可能でない場合は) インストールして、インストールを完了します。

6. エージェントがインストールされたら、ウィンドウを **閉じます** 。

   ![閉じる](../../includes/media/backup-install-agent/dpm_FinishInstallation.png)

7. 資格情報コンテナーに **DPM サーバーを登録する**には、**[管理]** タブで **[オンライン]** をクリックします。 次に、**[登録]** を選択します。 これにより、Register Setup (セットアップの登録) ウィザードが開きます。

8. プロキシ サーバーを使用してインターネットに接続する場合、 **[プロキシ構成]** 画面で、プロキシ サーバーの詳細を入力します。 認証済みのプロキシを使用する場合は、この画面でユーザー名とパスワードの詳細を入力します。

    ![[プロキシ構成]](../../includes/media/backup-install-agent/DPM_SetupOnlineBackup_Proxy.png)
9. [コンテナーの資格情報] 画面で、以前にダウンロードされたコンテナーの資格情報ファイルを参照して選択します。

    ![コンテナー資格情報 ](../../includes/media/backup-install-agent/DPM_SetupOnlineBackup_Credentials.jpg)

    コンテナーの資格情報ファイルは (ポータルからダウンロード後) 48 時間のみ有効です。 この画面でなんらかのエラー (例: "指定されたコンテナーの資格情報ファイルは期限切れです。") が発生した場合は、Azure ポータルにログインし、コンテナーの資格情報ファイルを再度ダウンロードします。

    セットアップ アプリケーションがアクセスできる場所に、コンテナーの資格情報ファイルがあることを確認します。  アクセス関連のエラーが発生した場合は、コンテナーの資格情報ファイルをこのコンピューターの一時的な場所にコピーし、操作をやり直してください。

    コンテナーの資格情報が無効であるというエラー (例: "無効なコンテナーの資格情報が指定されました。ファイルが破損しているか、最新の資格情報が回復サービスと関連付けられていません。") が発生した場合、ファイルが破損しているか、最新の資格情報が回復サービスと関連付けられていません。 ポータルから新しいコンテナーの資格情報ファイルをダウンロードしてから操作をやり直してください。 このエラーは通常、ユーザーが Azure ポータルで **[コンテナー資格情報のダウンロード]** オプションを連続でクリックした場合に発生します。 この場合、2 番目の資格情報コンテナーの資格情報ファイルだけが有効です。

10. 営業時間内外のネットワーク帯域幅の使用を制御するには、 **[使用帯域幅の調整]** 画面で、帯域幅の使用の制限を設定し、営業時間と非営業時間を定義できます。

    ![[使用帯域幅の調整]](../../includes/media/backup-install-agent/DPM_SetupOnlineBackup_Throttling.png)

11. **[回復先フォルダーの設定]** 画面で、Azure からダウンロードされたファイルを一時的にステージングするフォルダーを参照します。

    ![[回復先フォルダーの設定]](../../includes/media/backup-install-agent/DPM_SetupOnlineBackup_RecoveryFolder.png)

12. **[暗号化の設定]** 画面で、パスフレーズを生成するか、パスフレーズ (最小 16 文字) を指定することができます。 必ず安全な場所にパスフレーズを保存してください。

    ![暗号化](../../includes/media/backup-install-agent/DPM_SetupOnlineBackup_Encryption.png)

    > [!WARNING]
    > パスフレーズを紛失または忘れてしまった場合、Microsoft はバックアップ データの回復を支援することはできません。 エンド ユーザーは暗号化パスフレーズを所有していますが、Microsoft はエンド ユーザーが使用するパスフレーズを確認できません。 回復操作中に必要になる場合もあるため、ファイルは安全な場所に保存してください。
    >
    >

13. **[登録]** ボタンをクリックすると、コンピューターはコンテナーに正常に登録され、Microsoft Azure へのバックアップを開始できるようになります。

14. Data Protection Manager を使用する場合は、**[管理]** タブで **[オンライン]** を選択して **[構成]** オプションをクリックすることによって、登録ワークフロー時に指定した設定を変更できます。

## <a name="requirements-and-limitations"></a>要件 (および制限)
* DPM は、物理サーバーとして、または System Center 2012 SP1 か System Center 2012 R2 にインストールされている Hyper-V 仮想マシンとして実行することができます。 さらに、DPM は、System Center 2012 R2 (少なくとも DPM 2012 R2 更新プログラム ロールアップ 3 が適用されているもの) で実行する Azure 仮想マシンとして、または System Center 2012 R2 (少なくとも更新プログラム ロールアップ 5 が適用されているもの) で実行する VMware の Windows 仮想マシンとして実行することもできます。
* DPM を System Center 2012 SP1 で実行する場合は、System Center Data Protection Manager SP1 用の更新プログラム ロールアップ 2 をインストールする必要があります。 この手順は、Azure Backup エージェントをインストールする前に実行する必要があります。
* DPM サーバーには、Windows PowerShell および .Net Framework 4.5 がインストール済みである必要があります。
* DPM は、ほとんどのワークロードを Azure Backup にバックアップできます。 サポート対象の詳細な一覧については、次に示す Azure Backup サポートの項目を参照してください。
* Azure Backup に格納されているデータは、"テープにコピー" オプションでは回復できません。
* Azure Backup 機能が有効になっている Azure アカウントを使用する必要があります。 アカウントがない場合は、無料試用アカウントを数分で作成することができます。 [Azure Backup の料金](https://azure.microsoft.com/pricing/details/backup/)を参照してください。
* Azure Backup を使用するには、バックアップ対象のサーバーに Azure Backup エージェントがインストールされていることが必要です。 各サーバーをローカル ストレージとして使用するには、バックアップするデータのサイズの 5% 以上の空き領域が必要です。 たとえば、100 GB のデータをバックアップするには、スクラッチ場所に少なくとも 5 GB の空き領域が必要です。
* データは、Azure コンテナー ストレージに格納されます。 Azure Backup コンテナーにバックアップできるデータ量に制限はありませんが、データ ソース (仮想マシンやデータベースなど) のサイズは 54,400 GB を超えないようにする必要があります。

Azure へのバックアップがサポートされているファイルの種類は、次のとおりです。

* 暗号化ファイル (完全バックアップのみ)
* 圧縮ファイル (増分バックアップがサポートされる)
* スパース ファイル (増分バックアップがサポートされる)
* 圧縮されたスパース ファイル (スパースとして処理)

次のものはサポートされていません。

* 大文字と小文字を区別するファイル システムのサーバーはサポートされません。
* ハード リンク (スキップされる)
* 再解析ポイント (スキップされる)
* 暗号化されている圧縮ファイル (スキップされる)
* 暗号化されているスパース ファイル (スキップされる)
* 圧縮ストリーム
* スパース ストリーム

> [!NOTE]
> System Center 2012 DPM (SP1) 以降は、保護されたワークロードを Azure にバックアップできます。
>
>
