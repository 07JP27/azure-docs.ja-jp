<properties
	pageTitle="Azure 仮想マシンのバックアップ - Backup"
	description="登録後に、Azure 仮想マシンをバックアップする方法について説明します"
	services="backup"
	documentationCenter=""
	authors="aashishr"
	manager="shreeshd"
	editor=""/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="hero-article"
	ms.date="07/06/2015"
	ms.author="aashishr"/>


# Azure 仮想マシンのバックアップ
この記事は、Azure 仮想マシンをバックアップするうえで必読のガイドです。作業を進める前に、[前提条件](backup-azure-vms-introduction.md#prerequisites)がすべて満たされていることを確認してください。

Azure 仮想マシンのバックアップには、次の 3 つの主要な手順が含まれます。

![Azure 仮想マシンをバックアップするための 3 つの手順](./media/backup-azure-vms/3-steps-for-backup.png)

## 1\.Azure 仮想マシンの探索
探索プロセスでは、サブスクリプションに含まれる仮想マシンの一覧を、クラウド サービス名、リージョンなどの追加情報と共に Azure に照会します。

> [AZURE.NOTE]この探索プロセスは、常に最初の手順として実行する必要があります。これは、サブスクリプションに追加された新しい仮想マシンが必ず識別されるようにするためです。

### 探索プロセスをトリガーするには

1. Azure ポータルの **[復旧サービス]** にあるバックアップ コンテナーに移動し、**[登録されている項目]** タブをクリックします。

2. ドロップダウン メニューでワークロードの種類として **[Azure 仮想マシン]** を選択し、**[選択]** をクリックします。![ワークロードの選択](./media/backup-azure-vms/discovery-select-workload.png)

3. ページの下部にある **[探索]** をクリックします。![[探索] ボタン](./media/backup-azure-vms/discover-button-only.png)

4. 仮想マシンが集計されるまで、この探索プロセスに数分かかる場合があります。探索プロセスの実行中は、画面の下部にトースト通知が表示されます。![VMS の探索](./media/backup-azure-vms/discovering-vms.png)

5. 探索プロセスが完了すると、トースト通知が表示されます。![discover-done](./media/backup-azure-vms/discovery-complete.png)

##  2\.Azure 仮想マシンの登録
仮想マシンを保護するには、事前に Azure Backup サービスに登録する必要があります。この登録プロセスには、次の 2 つの主要な目的があります。

1. バックアップ拡張機能を仮想マシンの VM エージェントに接続する。

2. 仮想マシンを Azure Backup サービスに関連付ける。

登録は、通常、1 回限りの操作です。Azure Backup サービスは、面倒なユーザーの介入を必要とすることなく、バックアップ拡張機能のアップグレードや修正プログラムの適用をシームレスに処理します。これにより、ユーザーは、一般的にバックアップ製品に関連する、"エージェント管理オーバーヘッド" から解放されます。

### 仮想マシンを登録するには

1. Azure ポータルの **[Recovery Services]** にあるバックアップ コンテナーに移動し、**[登録されている項目]** タブをクリックします。

2. ドロップダウン メニューでワークロードの種類として **[Azure 仮想マシン]** を選択し、選択ボタンをクリックします。![ワークロードの選択](./media/backup-azure-vms/discovery-select-workload.png)

3. ページの下部にある **[登録]** をクリックします。![[登録] ボタン](./media/backup-azure-vms/register-button-only.png)

4. **[項目の登録]** ポップアップで、登録する仮想マシンを選択します。同じ名前の仮想マシンが 2 つ以上ある場合は、クラウド サービスを使用して仮想マシンを区別します。

    **登録**操作は一括して実行できます。つまり、登録する対象として複数の仮想マシンを同時に選択できます。これにより、仮想マシンのバックアップの準備に伴う 1 回限りの労力が大幅に軽減されます。

    >[AZURE.NOTE]ここには、登録されていない、バックアップ コンテナーと同じリージョンにある仮想マシンのみが表示されます。

5. 登録する仮想マシンごとにジョブが作成されます。トースト通知にこのアクティビティの状態が示されます。**[ジョブの表示]** をクリックして **[ジョブ]** ページに移動します。![登録ジョブ](./media/backup-azure-vms/register-create-job.png)

6. 仮想マシンが登録済みの項目の一覧にも表示され、登録操作の状態が表示されます。![登録状態 1](./media/backup-azure-vms/register-status01.png)

7. 操作が完了すると、登録済みの状態を反映するようにポータルの状態が変更されます。![登録状態 2](./media/backup-azure-vms/register-status02.png)

## 3\.保護: Azure Virtual Machines のバックアップ
この手順では、仮想マシンのバックアップおよび保持ポリシーを設定します。仮想マシンを保護するには、次の手順を実行します。

### Azure Virtual Machines をバックアップするには
1. Azure ポータルの **[復旧サービス]** にあるバックアップ コンテナーに移動し、**[登録されている項目]** タブをクリックします。
2. ドロップダウン メニューでワークロードの種類として **[Azure 仮想マシン]** を選択し、**[選択]** をクリックします。![ポータルでのワークロードの選択](./media/backup-azure-vms/select-workload.png)

3. ページの下部にある **[保護]** をクリックします。

4. 保護する仮想マシンを選択するための**項目の保護** ウィザードが表示されます。同じ名前の仮想マシンが 2 つ以上ある場合は、クラウド サービスを使用して仮想マシンを区別します。

    **保護**操作は一括して実行できます。つまり、保護する対象として複数の仮想マシンを同時に選択できます。これにより、仮想マシンの保護に伴う労力が大幅に軽減されます。

    >[AZURE.NOTE]ここには、Azure Backup サービスによって適切に登録され、バックアップ コンテナーと同じリージョンにある仮想マシンのみが表示されます。

5. **項目の保護**ウィザードの 2 番目の画面で、選択した仮想マシンをバックアップするために使用するバックアップおよび保持ポリシーを選択します。既存のポリシーのセットから選択することも、新しいポリシーを定義することもできます。

    >[AZURE.NOTE]プレビューでは、最大 30 日間の保持期間と最大で 1 回に 1 日のバックアップがサポートされます。

    それぞれのバックアップ コンテナーに複数のバックアップ ポリシーを設定することができます。これらのポリシーは、バックアップのスケジュール設定方法と保持方法の詳細を反映するように設定します。たとえば、毎日午後 10 時に実行するバックアップ用にバックアップ ポリシーを 1 つ用意し、毎週朝 6 時に実行するバックアップ用に別のバックアップ ポリシーを設定します。複数のバックアップ ポリシーを使用することで、仮想マシン インフラストラクチャのバックアップを柔軟にスケジュール設定できます。

    それぞれのバックアップ ポリシーには、複数の仮想マシンを関連付けることができます。仮想マシンは、特定の時点において 1 つのポリシーにのみ関連付けることができます。

6. 仮想マシンごとに、保護ポリシーを構成し、仮想マシンをポリシーに関連付けるためのジョブが作成されます。**[ジョブ]** タブをクリックし、適切なフィルターを選択して、**保護の構成**ジョブの一覧を表示します。![保護の構成ジョブ](./media/backup-azure-vms/protect-configureprotection.png)

7. ジョブが完了すると、仮想マシンがポリシーによって保護されます。最初のバックアップの実行は、スケジュール設定されたバックアップ時刻まで待つ必要があります。仮想マシンが **[保護された項目]** タブに表示され、保護状態が *[保護済み]* として表示されます (最初のバックアップが未完了の状態)。
    >[AZURE.NOTE]現在、保護を構成した直後に最初のバックアップを開始することはできません。

8. スケジュール設定された時刻になると、Azure Backup サービスによって、バックアップする必要があるそれぞれの仮想マシンに対するバックアップ ジョブが作成されます。**[ジョブ]** タブをクリックして、**バックアップ** ジョブの一覧を表示します。Azure Backup サービスは、バックアップ操作の一部として、各仮想マシンのバックアップ拡張機能に対して、すべての書き込みをフラッシュし、整合性のあるスナップショットを作成するためのコマンドを発行します。![バックアップが進行中](./media/backup-azure-vms/protect-inprogress.png)

9. 操作が完了すると、**[保護された項目]** タブの仮想マシンの保護状態が *[保護済み]* として表示されます。![復旧ポイントを作成した後の仮想マシンのバックアップ](./media/backup-azure-vms/protect-backedupvm.png)

## バックアップの状態と詳細の表示
仮想マシンが保護されると、**[ダッシュボード]** ページの概要に示される仮想マシンの数が増加します。さらに、[ダッシュボード] ページには、過去 24 時間の間に成功したジョブ、失敗したジョブ、現在進行中のジョブの数が表示されます。いずれかのカテゴリをクリックすると、**[ジョブ]** ページにそのカテゴリの詳細が表示されます。![[ダッシュボード] ページのバックアップの状態](./media/backup-azure-vms/dashboard-protectedvms.png)

## エラーのトラブルシューティング
次の表に示す情報を使って、Azure Backup の使用中に発生したエラーのトラブルシューティングを行うことができます。

| バックアップ操作 | エラーの詳細 | 対処法 |
| -------- | -------- | -------|
| 探索 | 新しい項目を探索できませんでした - Microsoft Azure Backup で、内部エラーが発生しました。しばらくしてから操作をやり直してください。 | 15 分後に探索プロセスを再試行します。
| 探索 | 新しい項目を探索できませんでした - 別の探索操作が既に進行中です。現在の探索操作が完了するまでお待ちください。 | なし |
| Register | Azure VM ロールは拡張機能をインストールできる状態ではありません - VM が実行中状態であるかどうかを確認してください。Azure Recovery Services 拡張機能を利用するには VM が実行中である必要があります。 | 仮想マシンを起動し、実行中状態になった後で登録操作をやり直してください。|
| Register | 仮想マシンに接続されたデータ ディスクの数がサポートされている上限を超えています - この仮想マシンのデータ ディスクをいくつか切断してから、操作をやり直してください。Azure Backup では、バックアップ用に Azure の仮想マシンに接続できるデータ ディスクは 5 つまでです。 | なし |
| Register | Microsoft Azure Backup で内部エラーが発生しました。しばらくしてから操作をやり直してください。引き続き問題が発生する場合は、Microsoft サポートにお問い合わせください。 | 次のいずれかの構成がサポートされていないことが原因で、このエラーが発生する場合があります。<ol><li>Premium LRS <li>マルチ NIC <li>ロード バランサー</ol> |
| Register | VM ゲスト エージェント証明書がありません | このエラーを解決するには、次の手順を実行してください。<ol><li>[ここ](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)から、最新バージョンの VM エージェントをダウンロードします。ダウンロードしたエージェントのバージョンが 2.6.1198.718 以上であることを確認します。<li>仮想マシンに VM エージェントをインストールします。</ol> VM エージェントのバージョンを確認する方法については、[こちら](#validating-vm-agent-installation)を参照してください。 |
| Register | エージェントのインストール処理がタイムアウトしたため、登録できませんでした | 仮想マシンの OS のバージョンがサポート対象かどうかを確認します。 |
| Register | コマンド実行に失敗しました - この項目で別の操作が実行中です。前の操作が完了するまでお待ちください。 | なし |
| バックアップ | バックアップ資格情報コンテナーからの VHD のコピーがタイムアウトしました - 数分以内に操作をやり直してください。問題が解決しない場合は、Microsoft サポートにお問い合わせください。 | これは、データが多すぎてコピーできなかった場合に発生します。データ ディスクが 5 個以下であることを確認してください。 |
| バックアップ | スナップショット VM サブタスクがタイムアウトしました - 数分以内に操作をやり直してください。問題が解決しない場合は、Microsoft サポートにお問い合わせください。 | VM エージェントに問題があるか、Azure インフラストラクチャへのネットワーク アクセスが何らかの原因でブロックされている場合に、このエラーがスローされます。<ul><li>VM エージェントの問題のデバックについて詳しくは[こちら](#Troubleshooting-vm-agent-related-issues) <li>ネットワークの問題のデバッグについて詳しくは[こちら](#troubleshooting-networking-issues) </ul> |
| バックアップ | バックアップ操作は内部エラーのため失敗しました - 数分以内に操作をやり直してください。問題が解決しない場合は、Microsoft サポートにお問い合わせください。 | このエラーが発生する原因は、次の 2 つです。<ol><li> データが多すぎてコピーできない。データ ディスクが 5 個以下であることを確認してください。<li>元の VM が削除されているため、バックアップを実行できない。削除された VM のバックアップ データを保持しながら、バックアップ エラーを停止するには、仮想マシンの保護を解除し、データを保持するオプションを選択します。これにより、バックアップ スケジュールを停止しながら、エラー メッセージが繰り返し表示されることも回避できます。 |
| バックアップ | 選択した項目に Azure Recovery Services 拡張機能をインストールできませんでした - VM エージェントは、Azure Recovery Services 拡張機能の前提条件です。Azure VM エージェントをインストールしてから、登録操作をやり直してください。 | <ol> <li>VM エージェントが正しくインストールされていることを確認します。<li>VM 構成のフラグが正しく設定されていることを確認します。</ol> VM エージェントのインストール方法と、VM エージェントのインストールを検証する方法については、[こちら](#validating-vm-agent-installation)を参照してください。 |
| バックアップ | コマンド実行に失敗しました - 現在、この項目で別の操作が実行中です。前の操作が完了するまで待ってから、やり直してください。 | 仮想マシンで既存のバックアップ ジョブまたは復元ジョブが実行されている場合、既存のジョブの実行中に新しいジョブを開始することはできません。<br><br>実行中のジョブを取り消すオプションが必要だと思われる方は、[Azure フィードバック フォーラム](http://feedback.azure.com/forums/258995-azure-backup-and-scdpm/suggestions/7941501-add-feature-to-allow-cancellation-of-backup-restor)で投票してください。 |

### VM エージェントに関する問題のトラブルシューティング

#### VM エージェントの設定
通常、VM エージェントは、Azure ギャラリーから作成された仮想マシン内に既に存在しています。しかし、オンプレミスのデータセンターから移行された仮想マシンには VM エージェントがインストールされていません。このような仮想マシンについては、VM エージェントを明示的にインストールする必要があります。既存の仮想マシンに VM エージェントをインストールする方法については、[こちら](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx)を参照してください。

Windows VM の場合:

- [エージェント MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409) をダウンロードしてインストールします。インストールを実行するには、管理者特権が必要です。
- [VM プロパティを更新](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx)して、エージェントがインストールされていることを示します。


#### VM エージェントの更新
VM エージェントを更新するには、単純に [VM エージェント バイナリ](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)を再インストールします。ただし、VM エージェントの更新中にバックアップ操作が実行されないようにする必要があります。


#### VM エージェントのインストールの検証
Windows VM 上で VM エージェントのバージョンを確認する方法:

1. Azure Virtual Machine にログオンし、フォルダー *C:\\WindowsAzure\\Packages* に移動します。WaAppAgent.exe ファイルを探します。
2. このファイルを右クリックして、**[プロパティ]** をクリックした後、**[詳細]** タブを選択します。[製品バージョン] が 2.6.1198.718 以上であることを確認します。

### ネットワークに関する問題のトラブルシューティング
Backup 拡張機能は、他の拡張機能と同様に、パブリックなインターネットへのアクセスが必要です。パブリックなインターネットにアクセスできない場合、さまざまな問題が発生する可能性があります。

- 拡張機能のインストールが失敗する
- ディスク スナップショットなどのバックアップ操作が失敗する
- バックアップ操作の状態を表示できない

パブリックなインターネット アドレスを解決する必要性については、[この記事](http://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx)をご覧ください。VNET 用の DNS 構成を確認し、Azure の URI が解決できることを確認する必要があります。

名前解決が正しく実行された後で、Azure IP へのアクセスも提供する必要があります。Azure インフラストラクチャへのアクセスのブロックを解除するには、次の手順に従います。

1. ホワイトリストに登録する [Azure データセンター IP](https://msdn.microsoft.com/library/azure/dn175718.aspx) の一覧を取得します。
2. [New-NetRoute](https://technet.microsoft.com/library/hh826148.aspx) コマンドレットを使用して、IP アドレスのブロックを解除します。管理者特権の PowerShell ウィンドウ (管理者として実行) で、Azure VM 内でこのコマンドレットを実行します。


## 復旧ポイントの整合性
バックアップ データを操作するときにお客様が心配することは、VM が復元された後の動作です。次のような質問がお客様からよく寄せられます。

- 仮想マシンが起動するか。
- データがディスク上で使用できるようになるか、(または) データの損失が発生するか。
- アプリケーションでデータを読み取ることができるか、(または) データの破損が発生するか。
- データがアプリケーションにとって意味を成すか、(または) アプリケーションで読み取られたときにデータの整合性が保たれているか。

次の表に、Azure VM のバックアップおよび復元中に発生する整合性の種類について説明します。

| 整合性 | VSS ベース | 説明と詳細 |
|-------------|-----------|---------|
| アプリケーションの整合性 | あり | Microsoft ワークロードにとっての理想的な整合性です。次のことが保証されます。<ol><li> VM が*起動する*こと、<li>*破損がない*こと、<li>*データの損失*がないこと、<li>(VSS を使用してバックアップ時にアプリを関連付けることによって) データを使用するアプリケーションに対してデータの整合性が保たれること</ol> ボリューム スナップショット サービス (VSS) により、データがストレージに適切に書き込まれることが保証されます。ほとんどの Microsoft ワークロードには、データの整合性に関連するワークロードに固有の操作を実行する VSS ライターがあります。たとえば、Microsoft SQL Server には、トランザクション ログ ファイルとデータベースへの書き込みが正常に行われることを保証する VSS ライターがあります。<br><br> Azure VM のバックアップの場合、アプリケーションの整合性の復旧ポイントを取得することは、VM のスナップショットが作成される前に、VSS ワークフローがバックアップ拡張機能によって開始され、*適切に*完了したことを意味します。これは、当然、Azure VM 内のすべてのアプリケーションの VSS ライターが起動されたことも意味します。<br><br>。[VSS の基本](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx)と[詳しいしくみ](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)について学習する。 |
| ファイル システムの整合性 | はい - Windows マシンの場合 | 次の 2 つのシナリオにおいて、復旧ポイントでファイル システムの整合性が保たれます。<ul><li>Azure の Linux VM のバックアップ。これは、Linux には VSS と同等のプラットフォームがないためです。<li>Azure の Windows VM のバックアップ中の VSS の障害。</li></ul> どちらの場合も、次のことを保証することが最善の対応となります。<ol><li>VM が*起動する*こと、<li>*破損がない*こと、<li>*データの損失*がないこと</ol> アプリケーションでは、復元されたデータに対する独自の "修正" メカニズムを実装する必要があります。|
| クラッシュの整合性 | いいえ | この状況は、(ソフト リセットまたはハード リセットにより) コンピューターが "クラッシュ" した状況に相当します。これは通常、バックアップ時に Azure Virtual Machine がシャットダウンされるときに発生します。Azure Virtual Machine のバックアップの場合、クラッシュの整合性の復旧ポイントを取得することは、Azure Backup が、オペレーティング システムの観点からもアプリケーションの観点からも、ストレージ メディア上のデータの整合性に関して何も保証しないことを意味します。バックアップ時にディスクに既に存在していたデータのみが、キャプチャされバックアップされます。<br/><br/>保証はありませんが、ほとんどの場合、OS は起動します。通常、その後に chkdsk などのディスク検査手順が実行され、破損エラーがあれば修正されます。メモリ内にあったデータや、ディスクに完全にフラッシュされていなかったデータは、すべて失われます。通常、アプリケーションは、データのロールバックを実行する必要がある場合に独自の検証メカニズムに従います。Azure VM のバックアップの場合、クラッシュの整合性の復旧ポイントを取得することは、Azure Backup が、OS の観点からもアプリケーションの観点からも、ストレージ上のデータの整合性に関して何も保証しないことを意味します。このような状況は、通常、バックアップ時に Azure VM がシャットダウンしていると発生します。<br><br>たとえば、データベースに存在しないエントリがトランザクション ログにある場合、データベース ソフトウェアは、データの整合性が得られる時点までロールバックします。(スパン ボリュームのように) 複数の仮想ディスクにまたがるデータを操作する場合、クラッシュの整合性の復旧ポイントは、データの正確性に関して何も保証しません。|

## 次のステップ
Azure Backup の概要については、次のトピックを参照してください。

- [仮想マシンの復元](backup-azure-restore-vms.md)
- [仮想マシンの管理](backup-azure-manage-vms)

<!---HONumber=July15_HO3-->