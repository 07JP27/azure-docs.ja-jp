<properties
	pageTitle="Azure 仮想マシンのバックアップ - Backup"
	description="登録後に、Azure 仮想マシンをバックアップする方法について説明します"
	services="backup"
	documentationCenter=""
	authors="aashishr"
	manager="shreeshd"
	editor=""/>

<tags
	ms.service="backup"
	ms.workload="storage-backup-recovery"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="hero-article"
	ms.date="05/26/2015"
	ms.author="aashishr"/>


# Azure の仮想マシンをバックアップします。

この記事は、Azure 仮想マシンをバックアップするうえで必読のガイドです。作業を進める前に、[前提条件](backup-azure-vms-introduction.md#prerequisites)がすべて満たされていることを確認してください。

Azure 仮想マシンのバックアップには、次の 3 つの主要な手順が含まれます。

![Azure 仮想マシンをバックアップするための 3 つの手順](./media/backup-azure-vms/3-steps-for-backup.png)

## Azure の仮想マシンを検出します。
追加情報をサブスクリプション内の仮想マシンの一覧については、探索のプロセス クエリ Azure など、クラウド サービス名、リージョンができます。

> [AZURE.NOTE]この探索プロセスは、常に最初の手順として実行する必要があります。これは、サブスクリプションに追加された新しい仮想マシンが必ず識別されるようにするためです。

探索プロセスを開始するには、次の手順を実行します。

1. Azure ポータルの **[復旧サービス]** にあるバックアップ コンテナーに移動し、**[登録されている項目]** タブをクリックします。

2. ドロップダウン メニューでワークロードの種類として **[Azure 仮想マシン]** を選択し、**[選択]** をクリックします。![ワークロードの選択](./media/backup-azure-vms/discovery-select-workload.png)

3. クリックして、 **DISCOVER** 、ページの下部にボタンをクリックします。 ![[探索] ボタン](./media/backup-azure-vms/discover-button.png)

4. 仮想マシンが集計されるまで、この探索プロセスに数分かかる場合があります。探索プロセスの実行中は、画面の下部にトースト通知が表示されます。![VMS の探索](./media/backup-azure-vms/discovering-vms.png)

5. 探索プロセスが完了すると、トースト通知が表示されます。![discover-done](./media/backup-azure-vms/discovery-complete.png)


## Azure の仮想マシンを登録します。
仮想マシンを保護する前に、Azure Backup サービスに登録する必要があります。この登録プロセスには、次の 2 つの主要な目的があります。

1. バックアップ拡張機能を仮想マシンの VM エージェントに接続する。

2. 仮想マシンを Azure Backup サービスに関連付ける

登録は、通常、1 回限りの操作です。Azure Backup サービスは、面倒なユーザーの介入を必要とすることなく、バックアップ拡張機能のアップグレードや修正プログラムの適用をシームレスに処理します。これにより、ユーザーは、一般的にバックアップ製品に関連する、"エージェント管理オーバーヘッド" から解放されます。

### 仮想マシンを登録するには

1. バックアップのようなコンテナーにあるに移動 **復旧サービス** でクリックすると、Azure ポータルで、 **登録されている項目** ] タブ

2. としては、ドロップダウン メニューでワークロードの種類を選択して **Azure の仮想マシン** 選択ボタンをクリックします。 ![ワークロードの選択](./media/backup-azure-vms/discovery-select-workload.png)

3. クリックして、 **登録** 、ページの下部にボタンをクリックします。 ![[登録] ボタン](./media/backup-azure-vms/register-button.png)

4. **[項目の登録]** ポップアップで、登録する仮想マシンを選択します。ある場合と同じ名前の 2 つ以上の仮想マシンは、仮想マシン間で区別するために、クラウド サービスを使用します。

    **登録**操作は一括して実行できます。つまり、登録する対象として複数の仮想マシンを同時に選択できます。これにより、仮想マシンのバックアップの準備に伴う 1 回限りの労力が大幅に軽減されます。

    >[AZURE.NOTE]登録されていないバックアップ資格情報のコンテナーと同じリージョンにあるバーチャル マシンのみが表示されます。

5. 登録する仮想マシンごとにジョブが作成されます。トースト通知にこのアクティビティの状態が示されます。**[ジョブの表示]** をクリックして **[ジョブ]** ページに移動します。![登録ジョブ](./media/backup-azure-vms/register-create-job.png)

6. 仮想マシンが登録済みの項目の一覧にも表示され、登録操作の状態が表示されます。![登録状態 1](./media/backup-azure-vms/register-status01.png)

7. 操作が完了すると、登録済みの状態を反映するようにポータルの状態が変更されます。![登録状態 2](./media/backup-azure-vms/register-status02.png)

## Azure の仮想マシンをバックアップします。
この手順では、仮想マシンのバックアップおよび保持ポリシーを設定します。仮想マシンを保護するには、次の手順を実行します。

1. Azure ポータルの **[復旧サービス]** にあるバックアップ コンテナーに移動し、**[登録されている項目]** タブをクリックします。
2. ドロップダウン メニューでワークロードの種類として **[Azure 仮想マシン]** を選択し、**[選択]** をクリックします。![ポータルでのワークロードの選択](./media/backup-azure-vms/select-workload.png)

3. クリックして、 **保護** 、ページの下部にボタンをクリックします。

4. 保護する仮想マシンを選択するための**項目の保護** ウィザードが表示されます。ある場合と同じ名前の 2 つ以上の仮想マシンは、仮想マシン間で区別するために、クラウド サービスを使用します。

    **保護**操作は一括して実行できます。つまり、保護する対象として複数の仮想マシンを同時に選択できます。これにより、仮想マシンの保護に伴う労力が大幅に軽減されます。

    >[AZURE.NOTE]ここには、Azure Backup サービスによって適切に登録され、バックアップ コンテナーと同じリージョンにある仮想マシンのみが表示されます。

5. **項目の保護**ウィザードの 2 番目の画面で、選択した仮想マシンをバックアップするために使用するバックアップおよび保持ポリシーを選択します。既存のポリシーのセットから選択することも、新しいポリシーを定義することもできます。

    >[AZURE.NOTE]プレビューでは、最大 30 日間の保持期間と最大で 1 回に 1 日のバックアップがサポートされます。

    それぞれのバックアップ コンテナーに複数のバックアップ ポリシーを設定することができます。これらのポリシーは、バックアップのスケジュール設定方法と保持方法の詳細を反映するように設定します。たとえば、毎日午後 10 時に実行するバックアップ用にバックアップ ポリシーを 1 つ用意し、毎週朝 6 時に実行するバックアップ用に別のバックアップ ポリシーを設定します。複数のバックアップ ポリシーを使用することで、仮想マシン インフラストラクチャのバックアップを柔軟にスケジュール設定できます。

    それぞれのバックアップ ポリシーには、複数の仮想マシンを関連付けることができます。仮想マシンは、特定の時点において 1 つのポリシーにのみ関連付けることができます。

6. 仮想マシンごとに、保護ポリシーを構成し、仮想マシンをポリシーに関連付けるためのジョブが作成されます。**[ジョブ]** タブをクリックし、適切なフィルターを選択して、**保護の構成**ジョブの一覧を表示します。![保護の構成ジョブ](./media/backup-azure-vms/protect-configureprotection.png)

7. ジョブが完了すると、仮想マシンがポリシーによって保護されます。最初のバックアップの実行は、スケジュール設定されたバックアップ時刻まで待つ必要があります。仮想マシンが **[保護された項目]** タブに表示され、保護状態が *[保護済み]* として表示されます (最初のバックアップが未完了の状態)。
    >[AZURE.NOTE]現在、保護を構成した直後に最初のバックアップを開始することはできません。

8. スケジュール設定された時刻になると、Azure Backup サービスによって、バックアップする必要があるそれぞれの仮想マシンに対するバックアップ ジョブが作成されます。**[ジョブ]** タブをクリックして、**バックアップ** ジョブの一覧を表示します。Azure Backup サービスは、バックアップ操作の一部として、各仮想マシンのバックアップ拡張機能に対して、すべての書き込みをフラッシュし、整合性のあるスナップショットを作成するためのコマンドを発行します。![バックアップが進行中](./media/backup-azure-vms/protect-inprogress.png)

9. 操作が完了すると、**[保護された項目]** タブの仮想マシンの保護状態が *[保護済み]* として表示されます。![復旧ポイントを作成した後の仮想マシンのバックアップ](./media/backup-azure-vms/protect-backedupvm.png)

## バックアップの状態と詳細を表示します。
仮想マシンが保護されると、**[ダッシュボード]** ページの概要に示される仮想マシンの数が増加します。さらに、[ダッシュボード] ページには、過去 24 時間の間に成功したジョブ、失敗したジョブ、現在進行中のジョブの数が表示されます。いずれかのカテゴリをクリックすると、**[ジョブ]** ページにそのカテゴリの詳細が表示されます。![[ダッシュボード] ページのバックアップの状態](./media/backup-azure-vms/dashboard-protectedvms.png)

## エラーのトラブルシューティング
情報を含む Azure Backup を使用して、次の表に示されているときに発生したエラーのトラブルシューティングを行うことができます。

| バックアップ操作 | エラーの詳細 | 対処法 |
| -------- | -------- | -------|
| 探索 | 新しい項目を探索できませんでした - Microsoft Azure Backup で、内部エラーが発生しました。しばらくしてから操作をやり直してください。 | 15 分後に探索プロセスを再試行します。
| 探索 | 新しい項目を探索できませんでした - 別の探索操作が既に進行中です。現在の探索操作が完了するまでお待ちください。 | なし |
| Register | Azure VM ロールは拡張機能をインストールできる状態ではありません - VM が実行中状態であるかどうかを確認してください。Azure Recovery Services 拡張機能を利用するには VM が実行中である必要があります。 | 仮想マシンを起動し、実行中状態になった後で登録操作をやり直してください。|
| Register | 仮想マシンに接続されたデータ ディスクの数をサポートされている上限を超えました - してください。 この仮想マシン上のいくつかのデータ ディスクをデタッチして、操作をやり直してください。Azure backup のバックアップを Azure の仮想マシンにアタッチされている最大 5 つのデータ ディスクをサポートしています | なし |
| Register | Microsoft Azure Backup には、いくつか分開こうとして、操作の待機に内部エラーが発生しました。問題が解決しない場合は、Microsoft サポートにお問い合わせください。 | 次のサポートされていない構成のいずれかの理由のこのエラーが発生することができます <ol><li>Premium LRS <li>複数 NIC <li>ロード バランサー。 </ol> |
| Register | VM ゲスト エージェント証明書が見つかりません | エラーを解決するのには次の手順に従って: <ol><li>からには、VM エージェントの最新バージョンをダウンロード [ここ](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)です。ダウンロードした、エージェントのバージョンが 2.6.1198.718 であることを確認またはそれ以降。<li>仮想マシンで、VM エージェントをインストールします。</ol> [学習](#validating-vm-agent-installation) 、VM エージェントのバージョンを確認する方法です。 |
| Register | 登録は、エージェントのインストール操作がタイムアウトに失敗しました | 仮想マシンの OS のバージョンはサポートされているかどうかを確認します。 |
| Register | コマンドの実行に失敗しました - 別の操作がこの項目の実行中です。前の操作が完了するまでお待ちください。 | なし |
| バックアップ | Vhd をコピーする - タイムアウトのバックアップ資格情報コンテナーから操作をやり直してください、数分以内にします。問題が解決しない場合は、Microsoft サポートにお問い合わせください。 | これは、大量のデータをコピーするがある場合に発生します。6 未満のデータ ディスクがあるかどうかに確認してください。 |
| バックアップ | 仮想マシンのスナップショットのサブ タスクがタイムアウトになりました - 少し後で操作をやり直してください。問題が解決しない場合は、Microsoft サポートにお問い合わせください。 | VM エージェントに問題があるか、何らかの方法で、Azure インフラストラクチャへのネットワーク アクセスがブロックされている場合、このエラーがスローされます。<ul><li>について学習 [VM エージェントの問題のデバッグ](#Troubleshooting-vm-agent-related-issues) <li>について [ネットワークの問題をデバッグ](#troubleshooting-networking-issues) </ul> |
| バックアップ | バックアップには、内部エラーのため失敗しました - 少し後で操作をやり直してください。問題が解決しない場合は、Microsoft サポートにお問い合わせください。 | 2 上の理由からこのエラーが発生することができます。 <ol><li> は大量のデータをコピーします。小さい 6 台のディスクがあるかどうかに確認してください。<li>元の VM が削除され、したがってバックアップを実行することはできません。削除された VM のバックアップのデータを保持がバックアップのエラーを停止するために、仮想マシンの保護を解除し、データを保持するオプションを選択します。これは、バックアップのスケジュールとも、定期的なエラー メッセージを停止します。 |
| バックアップ | Azure Recovery Services のインストールに失敗した場合に VM エージェント - 選択した項目の拡張子は、Azure Recovery Services 拡張機能の前提です。Azure VM エージェントをインストールし、登録操作を再開してください。 | <ol> <li>、VM エージェントが正しくインストールされているかどうかを確認します。<li>VM 構成上のフラグが正しく設定されていることを確認します。</ol> [詳細](#validating-vm-agent-installation) VM エージェントをインストールして、VM エージェントのインストールを検証する方法です。 |
| バックアップ | コマンドの実行に失敗しました - 別の操作は現在この項目の進行状況のされてです。前の操作が完了するまで待ち、再試行して | 既存のバックアップ、仮想マシンの復元ジョブが実行されていると、既存のジョブの実行中に、新しいジョブを開始することはできません。<br><br>進行中のジョブをキャンセルするオプションが希望される場合は、投票を追加、 [Azure フィードバック フォーラム](http://feedback.azure.com/forums/258995-azure-backup-and-scdpm/suggestions/7941501-add-feature-to-allow-cancellation-of-backup-restor)です。 |

### VM エージェントのトラブルシューティングに関連する問題

#### VM エージェントを設定します。
通常、VM エージェントは、Azure ギャラリーから作成される Vm 内に存在既にいます。ただし、内部設置型データ センターから移行される仮想マシンは、VM エージェントがインストールされていないがあります。このような vm の場合、VM エージェントを明示的にインストールする必要があります。詳細について [既存の仮想マシンに VM エージェントをインストールする](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx)です。

Windows vm の場合。

- ダウンロードし、インストール、 [エージェント MSI](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)です。インストールを完了するには管理者特権の必要があります。
- [VM プロパティを更新](http://blogs.msdn.com/b/mast/archive/2014/04/08/install-the-vm-agent-on-an-existing-azure-vm.aspx) をエージェントがインストールされていることを示します。


#### VM エージェントの更新
再インストールするように単純では、VM エージェントの更新、 [VM エージェント バイナリ](http://go.microsoft.com/fwlink/?LinkID=394789&clcid=0x409)です。ただし、バックアップ操作が実行されていないこと、VM エージェントの更新を確認する必要があります。


#### VM エージェントのインストールの検証
Windows Vm 上で VM エージェントのバージョンを確認する方法。

- Azure の仮想マシンにログインし、フォルダーに移動 *C:\WindowsAzure\Packages*です。
- WaAppAgent.exe ファイルの存在が見つかる必要があります。
- 」に進んでください、ファイルを右クリックして **プロパティ**, 、クリックして、 **詳細** タブです。
- 製品のバージョン フィールド 2.6.1198.718 をする必要がありますまたはそれ以上

### ネットワークの問題のトラブルシューティング
バックアップの拡張機能にはすべての拡張機能のように動作するパブリックなインターネットへのアクセスを必要があります。パブリック インターネットへのアクセスが不可能のさまざまなの方法で発生します。

- 拡張機能のインストールが失敗します。
- (ディスク スナップショット) と同様に、バックアップ操作が失敗します。
- 失敗することが、バックアップ操作の状態を表示します。

インターネットのパブリック アドレスを解決するための必要性が表現されて [ここ](http://blogs.msdn.com/b/mast/archive/2014/06/18/azure-vm-provisioning-stuck-on-quot-installing-extensions-on-virtual-machine-quot.aspx)です。VNET 用の DNS 構成を確認して、Azure の Uri が解決できることを確認する必要があります。

名前解決が正しく完了すると、Azure の ip アドレスへのアクセスも提供する必要があります。Azure インフラストラクチャへのアクセスのブロックを解除するには次の手順に従います。

1. 一覧を取得 [Azure データ センターの Ip](https://msdn.microsoft.com/
2. /library/azure/dn175718.aspx) ホワイト リストに登録します。
2. 使用して、ip アドレスのブロックを解除、 [新規 NetRoute](https://technet.microsoft.com/library/hh826148.aspx) コマンドレットです。(管理者として実行)、管理者特権の PowerShell ウィンドウで、Azure VM 内で、このコマンドレットを実行します。


## 復旧ポイントの整合性
バックアップ データを扱う場合に顧客は復元した後、VM の動作について心配です。次のような質問がお客様からよく寄せられます。

- 仮想マシンが起動するか。
- データがディスク上で使用できるようになるか、(または) データの損失が発生するか。
- アプリケーションでデータを読み取ることができるか、(または) データの破損が発生するか。
- データがアプリケーションにとって意味を成すか、(または) アプリケーションで読み取られたときにデータの整合性が保たれているか。

次の表に、Azure VM のバックアップおよび復元中に発生する整合性の種類について説明します。

| 整合性 | VSS ベース | 説明と詳細 |
|-------------|-----------|---------|
| アプリケーションの整合性 | あり | Microsoft ワークロードにとっての理想的な整合性です。次のことが保証されます。<ol><li> VM が*起動する*こと、<li>*破損がない*こと、<li>*データの損失*がないこと、<li>(VSS を使用してバックアップ時にアプリを関連付けることによって) データを使用するアプリケーションに対してデータの整合性が保たれること</ol> ボリューム スナップショット サービス (VSS) により、データがストレージに適切に書き込まれることが保証されます。ほとんどの Microsoft ワークロードには、データの整合性に関連するワークロードに固有の操作を実行する VSS ライターがあります。たとえば、Microsoft SQL Server には、トランザクション ログ ファイルとデータベースへの書き込みが正常に行われることを保証する VSS ライターがあります。<br><br> Azure VM のバックアップの場合、アプリケーションの整合性の復旧ポイントを取得することは、VM のスナップショットが作成される前に、VSS ワークフローがバックアップ拡張機能によって開始され、*適切に*完了したことを意味します。これは、当然、Azure VM 内のすべてのアプリケーションの VSS ライターが起動されたことも意味します。<br><br>。[VSS の基本](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx)と[詳しいしくみ](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)について学習する。 |
| ファイル システムの整合性 | はい - Windows マシンの場合 | 次の 2 つのシナリオにおいて、復旧ポイントでファイル システムの整合性が保たれます。<ul><li>Azure の Linux VM のバックアップ。これは、Linux には VSS と同等のプラットフォームがないためです。<li>Azure の Windows VM のバックアップ中の VSS の障害。</li></ul> どちらの場合も、次のことを保証することが最善の対応となります。<ol><li>VM が*起動する*こと、<li>*破損がない*こと、<li>*データの損失*がないこと</ol> アプリケーションでは、復元されたデータに対する独自の "修正" メカニズムを実装する必要があります。|
| クラッシュの整合性 | いいえ | この状況は、(ソフト リセットまたはハード リセットにより) コンピューターが "クラッシュ" した状況に相当します。ストレージ メディア上のデータの整合性に関する保証はありません。バックアップ時にディスクに既に存在していたデータのみが、キャプチャされバックアップされます。<ol><li>保証はありませんが、ほとんどの場合、OS は起動します。<li>通常、その後に chkdsk などのディスク検査手順が実行され、破損エラーがあれば修正されます。<li> メモリ内にあったデータや、ディスクに完全にフラッシュされていなかったデータは、すべて失われます。<li> 通常、アプリケーションは、データのロールバックを実行する必要がある場合に独自の検証メカニズムに従います。</ol>Azure VM のバックアップの場合、クラッシュの整合性の復旧ポイントを取得することは、Azure Backup が、OS の観点からもアプリケーションの観点からも、ストレージ上のデータの整合性に関して何も保証しないことを意味します。このような状況は、通常、バックアップ時に Azure VM がシャットダウンしていると発生します。<br><br>たとえば、データベースに存在しないエントリがトランザクション ログにある場合、データベース ソフトウェアは、データの整合性が得られる時点までロールバックします。(スパン ボリュームのように) 複数の仮想ディスクにまたがるデータを操作する場合、クラッシュの整合性の復旧ポイントは、データの正確性に関して何も保証しません。|

## 次のステップ
Azure Backup の概要については、次のトピックを参照してください。

- [仮想マシンの復元](backup-azure-restore-vms.md)
- [仮想マシンの管理](backup-azure-manage-vms)

<!---HONumber=GIT-SubDir--> 