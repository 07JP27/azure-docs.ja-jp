<properties
	pageTitle="Azure 仮想マシンのバックアップ - Backup | Microsoft Azure"
	description="登録後に Azure 仮想マシンをバックアップする方法について説明します"
	services="backup"
	documentationCenter=""
	authors="aashishr"
	manager="shreeshd"
	editor=""/>

<tags ms.service="backup" ms.workload="storage-backup-recovery" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="hero-article" ms.date="09/09/2015" ms.author="aashishr"; "jimpark"/>


# Azure 仮想マシンのバックアップ
この記事は、Azure 仮想マシンをバックアップするうえで必読のガイドです。作業を進める前に、[前提条件](backup-azure-vms-introduction.md#prerequisites)がすべて満たされていることを確認してください。

Azure 仮想マシンのバックアップには、次の 3 つの主要な手順が含まれます。

![Azure 仮想マシンをバックアップするための 3 つの手順](./media/backup-azure-vms/3-steps-for-backup.png)

>[AZURE.NOTE]仮想マシンは、ローカルにバックアップされます。特定の Azure リージョンのバックアップ コンテナーは、別の Azure リージョンの仮想マシンのバックアップを許可しません。したがって、バックアップが必要な VM がある Azure リージョンごとに、そのリージョン内に少なくとも 1 つ以上のバックアップ コンテナーを作成する必要があります。

## 1\.Azure 仮想マシンの探索
探索プロセスでは、サブスクリプションに含まれる仮想マシンの一覧を、クラウド サービス名、リージョンなどの追加情報と共に Azure に照会します。この探索プロセスは、常に最初の手順として実行する必要があります。これは、サブスクリプションに追加された新しい仮想マシンが必ず識別されるようにするためです。

### 探索プロセスを開始するには

1. Azure ポータルの **[Recovery Services]** にあるバックアップ コンテナーに移動し、**[登録済みの項目]** タブをクリックします。

2. ドロップダウン メニューでワークロードのタイプとして **[Azure 仮想マシン]** を選択し、**[選択]** ボタンをクリックします。

    ![ワークロードの選択](./media/backup-azure-vms/discovery-select-workload.png)

3. ページの下部にある **[探索]** をクリックします。![[探索] ボタン](./media/backup-azure-vms/discover-button-only.png)

4. 仮想マシンが集計されるまで、この探索プロセスに数分かかる場合があります。探索プロセスの実行中は、画面の下部にトースト通知が表示されます。

    ![VMS の探索](./media/backup-azure-vms/discovering-vms.png)

5. 探索プロセスが完了すると、トースト通知が表示されます。

    ![discover-done](./media/backup-azure-vms/discovery-complete.png)

##  2\.Azure 仮想マシンの登録
仮想マシンを保護するには、事前に Azure Backup サービスに登録する必要があります。登録プロセスの主な目的は、仮想マシンを Azure Backup サービスに関連付けることです。登録は、通常、1 回限りの操作です。

>[AZURE.NOTE]登録の手順では、バックアップの拡張機能はインストールされません。現在、バックアップ エージェントのインストールと更新は、スケジュールされたバックアップ ジョブの一部となっています。

### 仮想マシンを登録するには

1. Azure ポータルの **[Recovery Services]** にあるバックアップ コンテナーに移動し、**[登録されている項目]** タブをクリックします

2. ドロップダウン メニューでワークロードのタイプとして **[Azure 仮想マシン]** を選択し、[選択] ボタンをクリックします。

    ![ワークロードの選択](./media/backup-azure-vms/discovery-select-workload.png)

3. ページの下部にある **[登録]** をクリックします。

    ![[登録] ボタン](./media/backup-azure-vms/register-button-only.png)

4. **[項目の登録]** ショートカット メニューで、登録する仮想マシンを選択します。同じ名前の仮想マシンが 2 つ以上ある場合は、クラウド サービスを使用して仮想マシンを区別します。

    **登録**操作は一括して実行できます。つまり、登録する対象として複数の仮想マシンを同時に選択できます。これにより、仮想マシンのバックアップの準備に伴う 1 回限りの労力が大幅に軽減されます。

5. 登録する仮想マシンごとにジョブが作成されます。トースト通知にこのアクティビティの状態が示されます。**[ジョブの表示]** をクリックして **[ジョブ]** ページに移動します。

    ![登録ジョブ](./media/backup-azure-vms/register-create-job.png)

6. 仮想マシンが登録済みの項目の一覧にも表示され、登録操作の状態が表示されます。

    ![登録状態 1](./media/backup-azure-vms/register-status01.png)

7. 操作が完了すると、登録済みの状態を反映するようにポータルの状態が変更されます。

    ![登録状態 2](./media/backup-azure-vms/register-status02.png)

## 3\.保護: Azure 仮想マシンのバックアップ
この手順では、仮想マシンのバックアップおよび保持ポリシーを設定します。単一の保護操作を使用して、多数の仮想マシンを一括して保護することができます。

>[AZURE.NOTE]2015 年 5 月以降に作成された Azure のバックアップ コンテナーには、コンテナーに既定のポリシーが組み込まれています。この既定のポリシーには、30 日間の既定の保持期間と 1 日 1 回のバックアップ スケジュールが含まれています。

仮想マシンを保護するには、次の手順を実行します。

1. Azure ポータルの **[Recovery Services]** にあるバックアップ コンテナーに移動し、**[登録済みの項目]** タブをクリックします。
2. ドロップダウン メニューでワークロードのタイプとして **[Azure 仮想マシン]** を選択し、**[選択]** ボタンをクリックします。

    ![ポータルでのワークロードの選択](./media/backup-azure-vms/select-workload.png)

3. ページの下部にある **[保護]** をクリックします。**項目の保護**ウィザードが表示されます。このウィザードには、保護されていない登録済みの仮想マシンのみが一覧表示されます。

4. **項目の保護**ウィザードでは、保護する仮想マシンを選択できます。同じ名前の仮想マシンが 2 つ以上ある場合は、クラウド サービスを使用して仮想マシンを区別します。

    **保護**操作は一括して実行できます。つまり、保護する対象として複数の仮想マシンを同時に選択できます。これにより、仮想マシンの保護に伴う労力が大幅に軽減されます。

    ![Configure protection at scale](./media/backup-azure-vms/protect-at-scale.png)

5. **項目の保護**ウィザードの 2 番目の画面で、選択した仮想マシンをバックアップするために使用するバックアップ スケジュールを選択します。既存のポリシーのセットから選択することも、新しいポリシーを定義することもできます。

    それぞれのバックアップ コンテナーに複数のバックアップ ポリシーを設定することができます。これらのポリシーは、バックアップのスケジュール設定方法と保持方法の詳細を反映するように設定します。たとえば、毎日午後 10 時に実行するバックアップ用にバックアップ ポリシーを 1 つ用意し、毎週土曜朝 6 時に実行するバックアップ用に別のバックアップ ポリシーを設定します。複数のバックアップ ポリシーを使用することで、仮想マシン インフラストラクチャのバックアップを柔軟にスケジュール設定できます。

    それぞれのバックアップ ポリシーには、複数の仮想マシンを関連付けることができます。仮想マシンは、特定の時点において 1 つのポリシーにのみ関連付けることができます。

    ![Protect with new policy](./media/backup-azure-vms/policy-schedule.png)

6. **項目の保護**ウィザードの 3 番目の画面で、作成したバックアップに関連付ける保持期間の範囲を選択します。この画面では、業界標準の GFS(Grandfather-Father-Son) ベースの保持スキーマをサポートします。詳細については、「[長期的な保持](backup-azure-vms-introduction.md#Long term retention)」を参照してください。

    バックアップ ポリシーは、スケジュールされたバックアップの保持スキーマにも関係します。前の画面で既存のバックアップ ポリシーを選択すると、保持スキーマの変更は無効となり、バックアップはポリシーで定義されている保持ポリシーに従って実施されます。

    ![Protect with flexible retention](./media/backup-azure-vms/policy-retention.png)

7. 仮想マシンごとに、保護ポリシーを構成し、仮想マシンをポリシーに関連付けるためのジョブが作成されます。**[ジョブ]** タブをクリックし、適切なフィルターを選択して、**保護の構成**ジョブの一覧を表示します。

    ![保護の構成ジョブ](./media/backup-azure-vms/protect-configureprotection.png)


## 保護後のアクティビティ

### バックアップ拡張機能のインストール
Azure Backup サービスは、面倒なユーザーの介入を必要とすることなく、バックアップ拡張機能のアップグレードや修正プログラムの適用をシームレスに処理します。これにより、ユーザーは、一般的にバックアップ製品に付随する "エージェント管理オーバーヘッド" から解放されます。

#### オフライン VM
VM が実行されている場合、バックアップ拡張機能がインストールされます。また、VM が実行されている場合は、アプリケーションの整合性の復旧ポイントを取得できる可能性が高くなります。Azure Backup サービスは、VM がオフになっている場合は、VM のバックアップを継続しますが、拡張機能はインストールしません (オフライン VM と呼ばれます)。このような場合は、整合性に影響があり、復旧ポイントは*クラッシュ整合性*を備えたものとなります。

### 初回バックアップ
ポリシーを使用して保護した仮想マシンは、**[保護された項目]** タブに表示され、保護の状態は *[保護済み (初回バックアップは完了していません)]* と表示されます。既定では、スケジュールされた最初のバックアップが初回バックアップとなります。保護の構成直後に初回バックアップをトリガーするには、**[保護された項目]** ページの下の **[今すぐバックアップ]** ボタンを使用します。

Azure Backup サービスによって、初回バックアップ操作用にバックアップ ジョブが作成されます。**[ジョブ]** タブをクリックしてジョブの一覧を表示します。Azure Backup サービスは、バックアップ操作の一部として、各仮想マシンのバックアップ拡張機能に対して、すべての書き込みをフラッシュし、整合性のあるスナップショットを作成するためのコマンドを発行します。

![バックアップが進行中](./media/backup-azure-vms/protect-inprogress.png)

初回バックアップが完了すると、**[保護された項目]** タブの仮想マシンの*保護の状態*は *[保護済み]* と表示されます。

![復旧ポイントを作成した後の仮想マシンのバックアップ](./media/backup-azure-vms/protect-backedupvm.png)

### バックアップの状態と詳細の表示
仮想マシンが保護されると、**[ダッシュボード]** ページの概要に示される仮想マシンの数が増加します。さらに、**[ダッシュボード]** ページには、過去 24 時間の間に成功したジョブ、失敗したジョブ、現在進行中のジョブの数が表示されます。いずれかのカテゴリをクリックすると、**[ジョブ]** ページにそのカテゴリの詳細が表示されます。

![[ダッシュボード] ページのバックアップの状態](./media/backup-azure-vms/dashboard-protectedvms.png)

### 長期的な保持
保有ポリシーは、バックアップを格納する必要がある期間を指定します。顧客は、すべてのバックアップ ポイントに "均一の保持期間" を指定するのではなく、バックアップが作成された時期に基づいて別の保持ポリシーを指定できます。たとえば、各四半期の最後に実行されるバックアップ ポイントは、監査のために長期間保持する必要がありますが、毎日実行されるバックアップ ポイント (運用上の復旧ポイントとして機能する) は、90 日間保持する必要があります。

1. **日ごとの保持ポリシー**: バックアップは毎日作成され、30 日間保持されます。
2. **週ごとの保持ポリシー**: バックアップは毎週日曜日に作成され、104 週間保持されます。
3. **月ごとの保持ポリシー**: バックアップは各月の最後の日曜日に作成され、120 か月保持されます。
4. **年ごとの保持ポリシー**: バックアップは 1 月の最初の日曜日に作成され、99 年間保持されます。

## 復旧ポイントの整合性
バックアップ データを操作するときにお客様が心配することは、VM が復元された後の動作です。次のような質問がお客様からよく寄せられます。

- 仮想マシンが起動するか。
- データがディスク上で使用できるようになるか、(または) データの損失が発生するか。
- アプリケーションでデータを読み取ることができるか、(または) データの破損が発生するか。
- データがアプリケーションにとって意味を成すか、(または) アプリケーションで読み取られたときにデータの整合性が保たれているか。

次の表に、Azure VM のバックアップおよび復元中に発生する整合性の種類について説明します。

| 整合性 | VSS ベース | 説明と詳細 |
|-------------|-----------|---------|
| アプリケーションの整合性 | あり | これは次のことを保証するため、Microsoft ワークロードにとって最適な場所です。<ol><li> VM が*起動する*。<li>*破損がない*。<li>*データの損失がない*。<li> バックアップの時点で VSS を使用してアプリケーションを関連付けるので、データとそのデータを使用するアプリケーションとの間に整合性が保たれる。</ol> ボリューム スナップショット サービス (VSS) により、データがストレージに適切に書き込まれることが保証されます。ほとんどの Microsoft ワークロードには、データの整合性に関連するワークロードに固有の操作を実行する VSS ライターがあります。たとえば、Microsoft SQL Server には、トランザクション ログ ファイルとデータベースへの書き込みが正常に行われることを保証する VSS ライターがあります。<br><br> Azure VM のバックアップの場合、アプリケーションの整合性の復旧ポイントを取得することは、VM のスナップショットが作成される前に、VSS ワークフローがバックアップ拡張機能によって開始され、*適切に*完了したことを意味します。これは、当然、Azure VM 内のすべてのアプリケーションの VSS ライターが起動されたことも意味します。<br><br>。[VSS の基本](http://blogs.technet.com/b/josebda/archive/2007/10/10/the-basics-of-the-volume-shadow-copy-service-vss.aspx)と[詳しいしくみ](https://technet.microsoft.com/library/cc785914%28v=ws.10%29.aspx)について学習する。 |
| ファイル システムの整合性 | はい - Windows マシンの場合 | 次の 2 つのシナリオにおいて、復旧ポイントでファイル システムの整合性が保たれます。<ul><li>Azure の Linux VM のバックアップ。これは、Linux には VSS と同等のプラットフォームがないためです。<li>Azure の Windows VM のバックアップ中の VSS の障害。</li></ul> どちらの場合でも、次のことを確保することが重要です。<ol><li> VM が*起動する*。<li>*破損がない*。<li>*データの損失がない*。</ol> アプリケーションでは、復元されたデータに対する独自の "修正" メカニズムを実装する必要があります。|
| クラッシュの整合性 | いいえ | この状況は、(ソフト リセットまたはハード リセットにより) コンピューターが "クラッシュ" した状況に相当します。これは通常、バックアップ時に Azure 仮想マシンがシャットダウンされるときに発生します。Azure 仮想マシンのバックアップの場合、クラッシュの整合性の復旧ポイントを取得することは、Azure Backup が、オペレーティング システムの観点からもアプリケーションの観点からも、ストレージ メディア上のデータの整合性に関して何も保証しないことを意味します。バックアップ時にディスクに既に存在していたデータのみが、キャプチャされバックアップされます。<br/><br/>保証はありませんが、ほとんどの場合、OS は起動します。通常、その後に chkdsk などのディスク検査手順が実行され、破損エラーがあれば修正されます。メモリ内にあったデータや、ディスクに完全にフラッシュされていなかったデータは、すべて失われます。通常、アプリケーションは、データのロールバックを実行する必要がある場合に独自の検証メカニズムに従います。Azure VM のバックアップの場合、クラッシュの整合性の復旧ポイントを取得することは、Azure Backup が、OS の観点からもアプリケーションの観点からも、ストレージ上のデータの整合性に関して何も保証しないことを意味します。このような状況は、通常、バックアップ時に Azure VM がシャットダウンしていると発生します。<br><br>たとえば、データベースに存在しないエントリがトランザクション ログにある場合、データベース ソフトウェアは、データの整合性が得られる時点までロールバックします。(スパン ボリュームのように) 複数の仮想ディスクにまたがるデータを操作する場合、クラッシュの整合性の復旧ポイントは、データの正確性に関して何も保証しません。|


## パフォーマンスおよびリソース使用率
Azure で VM にバックアップする場合、オンプレミスにデプロイされているソフトウェアの場合と同様に、容量およびリソースの使用率を計画する必要があります。[Azure Storage の制限](azure-subscription-service-limits.md#storage-limits)には、実行中のワークロードに対する影響を最小に抑え、パフォーマンスを最大にする VM のデプロイの構成が定義されています。バックアップのパフォーマンスに影響を与える Azure Storage の制限には、主に次の 2 つがあります。

- ストレージ アカウントあたりの最大送信速度
- ストレージ アカウントあたりの合計要求レート

顧客のストレージ アカウントからバックアップ データがコピーされると、ストレージ アカウントの IOPS および送信速度 (ストレージ出力) メトリックが計算されます。このとき同時に、IOPS およびスループットを消費する仮想マシンも実行されています。この目標は、バックアップおよび仮想マシンのトラフィック合計が、ストレージ アカウントの制限を超過しないことです。

バックアップは貪欲で、可能な限りバックアップを早く完了するために、使用可能なリソースをできるだけ多く消費しようとします。ただし、すべての IO 操作には *1 秒あたり 60 MB* の*単一 Blob のターゲット スループット*の制限があります。バックアップ プロセスを高速化するために、VM の各ディスクは*並列*でバックアップされます。つまり、VM にディスクが 4 つある場合、Azure Backup は 4 つのディスクをすべて並行して更新します。したがって、顧客のストレージ アカウントから送信されるバックアップ トラフィックを決定する最も重要な唯一の要因は、ストレージ アカウントからバックアップされる**ディスクの数**になります。

パフォーマンスに影響を与える 2 番目の要因は、**バックアップ スケジュール**です。すべての VM が同時にバックアップされるように構成した場合、Azure Backup は、できるだけ多くのディスクをバックアップしようとするので、*並列*でバックアップされるディスクの数は増えます。したがって、ストレージ アカウントからバックアップされるトラフィックを減らすには、それぞれの VM が重複せずにバックアップされるように 1 日の異なる時間にバックアップするのが 1 つの方法です。

### 容量計画
これらの要素をすべてまとめると、ストレージ アカウントの用途は正確に計画する必要があることを意味します。ディスクに対する影響およびバックアップ スケジュールの選択肢を確認するには、[VM のバックアップ容量計画に関する Excel シート](https://gallery.technet.microsoft.com/Azure-Backup-Storage-a46d7e33)をダウンロードしてください。

### バックアップのスループット
バックアップ対象の各ディスクは、Azure Backup がディスク上のブロックを読み込み、変更されたデータのみを格納します (増分バックアップ)。次の表では、Azure Backup で予想される平均スループットの値を示します。

| バックアップ操作 | 最適なスループット |
| ---------------- | ---------- |
| 初回バックアップ | 160 Mbps |
| 増分バックアップ (DR) | 640 Mbps <br><br> このスループットは、ディスクにバックアップ対象の分散したチャーンが多数ある場合に、大幅に減ります。 |

これを使用すると、特定のサイズのディスクをバックアップするために要する時間を見積もることができます。

### VM のバックアップの合計時間
VM のバックアップには、データの読み取りやコピーに多くの時間が費やされますが、他にも合計時間に影響を与える操作があります。

1. [バックアップ拡張機能のインストールまたは更新](backup-azure-vms.md#offline-vms)に費やされる時間。
2. キューの待機時間。サービスは複数の顧客のバックアップを処理するため、バックアップ操作は直ちに開始されない場合があります。VM の平均待機時間は 15 ～ 30 分です。

## エラーのトラブルシューティング
仮想マシンのバックアップ時に発生するエラーを回避する方法の一覧については、

- [仮想マシンのバックアップのトラブルシューティング](backup-azure-vms-troubleshoot.md)に関するページを参照してください。

## 次のステップ
Azure Backup の概要については、次のトピックを参照してください。

- [仮想マシンの復元](backup-azure-restore-vms.md)
- [仮想マシンの管理](backup-azure-manage-vms.md)

<!---HONumber=Sept15_HO2-->