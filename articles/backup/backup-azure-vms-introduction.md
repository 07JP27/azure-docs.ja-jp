---
title: Azure VM バックアップについて
description: Azure VM バックアップについて、また、いくつかのベスト プラクティスについて説明します。
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 01/08/2019
ms.author: raynew
ms.openlocfilehash: cac219414418277ace09ba3a0b442f3bf74e6025
ms.sourcegitcommit: 30d23a9d270e10bb87b6bfc13e789b9de300dc6b
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/08/2019
ms.locfileid: "54107431"
---
# <a name="about-azure-vm-backup"></a>Azure VM バックアップについて

この記事では、[Azure Backup サービス](backup-introduction-to-azure-backup.md)が Azure VM をどのようにバックアップするかについて説明します。

## <a name="backup-process"></a>バックアップ プロセス

Azure Backup が Azure VM のバックアップを完了する方法を説明します。

1. バックアップの対象として選択されている Azure VM に対して、Azure Backup サービスはユーザーが指定したバックアップ スケジュールに従ってバックアップ ジョブを開始します。
2. サービスはバックアップの拡張機能をトリガーします。
    - Windows VM は _VMSnapshot_ 拡張機能を使用します。
    - Linux VM は _VMSnapshotLinux_ 拡張機能を使用します。
    - 拡張機能は、最初の VM バックアップ中にインストールされます。
    - 拡張機能をインストールするには、VM が実行されている必要があります。
    - VM が実行されていない場合、Backup サービスは基盤となるストレージのスナップショットを取ります (VM が停止している間はアプリケーション書き込みが行われないため)。
4. バックアップ拡張機能によってストレージレベルのクラッシュ整合性/ファイル整合性スナップショットが作成されます。
5. スナップショットが作成されると、データはバックアップ コンテナーに転送されます。 効率を最大に高めるために、前回のバックアップ以降に変更されたデータ ブロック (差分) が特定され、そのデータのみが転送されます。
5. データ転送が完了すると、スナップショットが削除され、回復ポイントが作成されます。

![Azure 仮想マシンのバックアップ アーキテクチャ](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="data-encryption"></a>データの暗号化

Azure Backup では、データはバックアップ プロセスの一部として暗号化されません。 Azure Backup では、Azure Disk Encryption を使用して暗号化された Azure VM のバックアップがサポートされています。

- マネージドおよびアンマネージド Azure VM については、Bitlocker 暗号化キー (BEK) のみで暗号化された VM、およびキー暗号化キー (KEK) で暗号化された BEK がサポートされています。
- 認証されたユーザーによってキー コンテナーに復元される場合のみ読み取りと使用が可能となるように、BEK (シークレット) と KEK (キー) バックアップがバックアップされます。
- BEK もバックアップされるため、BEK が失われた場合、認証されたユーザーは BEK を KeyVault に復元し、暗号化された VM を回復できます。 暗号化された VM のキーとシークレットは、暗号化形式でバックアップされるため、認証されていないユーザーや Azure はいずれもバックアップされたキーやシークレットを読み取ったり使用したりすることはできません。 正しいレベルの権限を持つユーザーのみが暗号化された VM、およびキーとシークレットをバックアップして復元できます。

## <a name="snapshot-consistency"></a>スナップショットの整合性

アプリの実行中にスナップショットを作成するために、Azure Backup ではアプリ整合性スナップショットを作成します。

- **Windows VM**:Windows VM については、Backup サービスはボリューム シャドウ コピー サービス (VSS) と連携して VM のディスクの一貫したスナップショットを取得します。
    - 既定では、Azure Backup は完全 VSS バックアップを取得します。 [詳細情報](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)。
    - Azure Backup が VSS コピー バックアップを作成するように設定を変更する場合は、以下のレジストリ キーを設定してください。
        ```
        [HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]
        ""USEVSSCOPYBACKUP"="TRUE"
        ```
- **Linux VM**:Azure Backup がスナップショットを作成する場合に Linux VM にアプリケーション整合性を持たせるには、Linux 事前/事後スクリプト フレームワークを使用します。 VM スナップショットを取るときの整合性を確保できるよう自分のカスタム スクリプトを記述することができます。
    -  Azure Backup は、ユーザーが書き込んだ事前スクリプトと事後スクリプトだけを呼び出します。
    - 事前スクリプトと事後スクリプトが正常に実行されると、Azure Backup は復旧ポイントをアプリケーション整合性としてマークします。 ただし、カスタム スクリプトを使用したときのアプリケーション整合性の最終的な責任はユーザーが担います。
    - スクリプトの構成の[詳細](backup-azure-linux-app-consistent.md)を確認します。


#### <a name="consistency-types"></a>整合性の種類

次の表で、整合性の種類について説明します。

**スナップショット** | **VSS ベース** | **詳細** | **復旧**
--- | --- | --- | ---
**アプリケーションの整合性** | あり (Windows のみ) | アプリ整合性バックアップでは、メモリの内容と保留中の I/O 操作がキャプチャされます。 アプリ整合性スナップショットでは、バックアップが発生する前にアプリ データの整合性を保証する VSS ライター (または Linux の事前/事後スクリプト) を使用します。 | アプリ整合性スナップショットで復旧する場合、VM が起動します。 データの損失や破損はありません。 アプリは整合性が確保された状態で開始します。
**ファイル システム整合性** | あり (Windows のみ) |  ファイル整合性バックアップでは、同時にすべてのファイルのスナップショットを作成することでディスク ファイルの整合性バックアップを提供します。<br/><br/> Azure Backup の復旧ポイントは次についてのファイル整合性です。<br/><br/> - 事前/事後スクリプトのない、または失敗したスクリプのある Linux VM のバックアップ。<br/><br/> - VSS が失敗した Windows VM のバックアップ。 | ファイル整合性スナップショットによる復旧では、VM が起動します。 データの損失や破損はありません。 復元されたデータに一貫性が保たれるようにするために、アプリは独自の "修正" メカニズムを実装する必要があります。
**クラッシュ整合性** | いいえ  | クラッシュ整合性は多くの場合、バックアップ時に Azure VM がシャットダウンされるときに発生します。  バックアップ時にディスクに既に存在していたデータのみが、キャプチャされバックアップされます。<br/><br/> クラッシュ整合性の復旧ポイントは、オペレーティング システムやアプリのデータ整合性を保証しません。 | 保証はありませんが、通常、VM が起動します。その後、ディスク検査が実行されて、破損エラーが修正されます。 メモリ内にあったデータやディスクに転送されなかった書き込みは、すべて失われます。 アプリは独自のデータ検証を実装しています。 たとえば、データベース アプリの場合、トランザクション ログにデータベース内に存在しないエントリが含まれている場合、データベース ソフトウェアはデータの整合性が得られるまでロールします。


## <a name="service-and-subscription-limits"></a>サービスとサブスクリプションの制限

Azure Backup にはサブスクリプションとコンテナーについてさまざまな制限があります。

[!INCLUDE [azure-backup-limits](../../includes/azure-backup-limits.md)]


## <a name="backup-performance"></a>バックアップ パフォーマンス

### <a name="disk-considerations"></a>ディスクに関する考慮事項

バックアップ操作は、VM の各ディスクを並行してバックアップすることで最適化されます。 たとえば、VM にディスクが 4 つある場合、サービスは 4 つすべてのディスクを並列でバックアップしようとします。 バックアップ対象の各ディスクは、Azure Backup がディスク上のブロックを読み込み、変更されたデータのみを格納します (増分バックアップ)。


### <a name="scheduling-considerations"></a>スケジュールに関する考慮事項

スケジュールのバックアップは、パフォーマンスに影響します。

- すべての VM が同時にバックアップされるようにポリシーを構成した場合、バックアップ プロセスはすべてのディスクを並行にバックアップしようとするため、トラフィックが輻輳します。
- バックアップ トラフィックを減らすには、重複がないよう、異なる VM を一日の異なる時間にバックアップします。


### <a name="time-considerations"></a>時間に関する考慮事項

バックアップ時間のほとんどはデータの読み取りとコピーに費やされますが、VM のバックアップには、他にも必要な合計時間が増える操作があります。

- **バックアップ拡張機能のインストール**:バックアップ拡張機能のインストールまたは更新の所要時間。
- **スナップショットのトリガー**:スナップショットをトリガーするのにかかった時間です。 スナップショットは、スケジュールされたバックアップ時刻の近くでトリガーされます。
- **キューの待機時間**:バックアップ サービスにより複数の顧客ストレージ アカウントからのジョブが同時に処理されるため、スナップショットは Recovery Services コンテナーにすぐにコピーされないことがあります。 負荷のピーク時には、バックアップが処理されるまでに最大 8 時間がかかることがあります。 ただし、毎日のバックアップ ポリシーでは、VM バックアップの合計時間は 24 時間未満になります。
- **初回バックアップ**:増分バックアップには 24 時間未満の合計バックアップ時間が有効ですが、初回バックアップには有効ではないことがあります。 必要な時間はデータのサイズとバックアップが取得された時間に応じて異なります。
- **データ転送時間**:バックアップ サービスが前回のバックアップからの増分変更を計算し、これらの変更をコンテナー ストレージに転送するために必要な時間です。

### <a name="factors-affecting-backup-time"></a>バックアップ時間に影響する要因

バックアップは、スナップショットの作成と、コンテナーへのスナップショットの転送という、2 つのフェーズで構成されています。 Backup サービスはストレージ用に最適化されます。

- スナップショット データをコンテナーに転送するとき、サービスは前のスナップショットからの増分変更のみを転送します。
- 増分変更を特定するため、サービスはブロックのチェックサムを計算します。
    - 変更されたブロックは、コンテナーに送信されるブロックとして識別されます。
    - サービスは識別された各ブロックをさらに詳しく調べて、転送するデータを最小化する可能性を探ります。
    - 変更されたブロックをすべて評価した後、サービスは変更箇所を結合して、コンテナーに送ります。

バックアップ時間に影響を与える状況には次のようなものがあります。

- **既に保護されている VM に新しく追加されたディスクの初回のバックアップ**:VM が増分バックアップの最中である場合、その VM に新しいディスクが追加されると、既存のディスクのデルタ レプリケーションと共に、新しく追加されたディスクの初期レプリケーションも必要になるため、バックアップの所要時間が 24 時間を超える可能性があります。
- **断片化**:バックアップ製品では、2 つのバックアップ操作間の差分変更がスキャンされます。 バックアップ操作は、それぞれの変更が併置されている場合のほうが、ディスク上で分散している場合よりも高速に実行されます。 
- **チャーン**:(増分レプリケーションの) ディスクあたりの日次チャーンが 200 GB を超える場合は、操作の完了までに 8 時間以上かかる可能性があります。 VM にディスクが 2 つ以上ある場合、いずれかのディスクでバックアップの時間が長引くと、全体のバックアップ操作に影響が及ぶ可能性があります (またはエラーが発生する可能性があります)。 
- **チェックサム比較 (CC) モード**:CC モードでは、インスタント RP で使用される最適化モードと比べて処理が遅くなります。 インスタント RP を既に使用している場合で、Tier-1 のスナップショットを削除した場合は、バックアップが CC モードに切り替わり、バックアップ操作が 24 時間を超える (または失敗する) 結果につながります。

## <a name="restore-considerations"></a>復元に関する考慮事項

復元操作は 2 つのメイン タスクで構成されています。選択したストレージ アカウントにコンテナーからデータをコピーすることと仮想マシンを作成することです。 コンテナーからデータをコピーするために必要な時間は、Azure でバックアップが保存されている場所とストレージ アカウントの場所によって決まります。 データのコピーに使用される時間は、次に依存します。

- **キューの待機時間**:サービスは複数のストレージ アカウントからの復元ジョブを同時に処理するため、復元要求はキューに入れられます。
- **データ コピー時間**:データがコンテナーからストレージ アカウントにコピーされます。 復元時間は、Azure Backup サービスが使用する、選択したストレージ アカウントの IOPS とスループットに依存します。 復元処理中のコピー時間を短縮するには、他のアプリケーションの書き込みと読み取りが読み込まれないストレージ アカウントを選びます。

## <a name="best-practices"></a>ベスト プラクティス

VM バックアップを構成するときには、次のプラクティスに従うことをお勧めします。

- コンテナーをインスタント RP にアップグレードします。 これらの[利点](backup-upgrade-to-vm-backup-stack-v2.md)と[考慮事項](backup-upgrade-to-vm-backup-stack-v2.md#considerations-before-upgrade)を確認し、こちらの[指示](backup-upgrade-to-vm-backup-stack-v2.md#upgrade)に従ってアップグレードに進んでください。  
- リソースの使用を最適化するためにデータのスナップショットが取得される場合は、既定で指定されたポリシー時刻を変更することを検討してください (たとえば、 既定のポリシー時刻が午前 12 時 00 分である場合は、それを数分先に進めることを検討してください)。
- インスタント RP 機能を使用しない場合、Premium VM のバックアップには、ストレージ アカウントの総容量の約 50% を割り当ててください。 バックアップ サービスでは、スナップショットを同じストレージ アカウントにコピーし、それをコンテナーに転送するために、この容量が必要になります。
- 1 つのコンテナーから複数の VM を復元する場合は、ターゲットのストレージ アカウントがスロットルされないようにするために、それぞれ異なる  [v2 ストレージ アカウント](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade) を使用することを強くお勧めします。 たとえば、各 VM にはそれぞれ異なるストレージ アカウントを使用する必要があります (10 個の VM を復元する場合は、異なる 10 個のストレージ アカウントを使用することを検討してください)。
- Tier-1 ストレージ レイヤー (スナップショット) からの復元は (ストレージ アカウントが同じなので) 数分で完了しますが、Tier-2 ストレージ レイヤー (コンテナー) の場合は数時間かかる可能性があります。 利用可能なデータが Tier-1 にある場合は、復元を高速化するために、[インスタント RP](backup-upgrade-to-vm-backup-stack-v2.md) 機能を使用することをお勧めします (データをコンテナーから復元しなければならない場合は、処理時間が長くなります)。
- ストレージ アカウントあたりのディスク数の制限は、IaaS VM で実行されているアプリケーションがディスクにどれくらいアクセスするかによって決まります。 1 つのストレージ アカウントで複数のディスクがホストされているかどうかを確認してください。 通常、1 つのストレージ アカウント上に 5 ～ 10 個以上のディスクが存在する場合は、一部のディスクを別のストレージ アカウントに移動して負荷を分散します。

## <a name="backup-costs"></a>バックアップのコスト

Azure Backup を使用してバックアップされている Azure VM は、[Azure Backup の価格](https://azure.microsoft.com/pricing/details/backup/)の対象になります。

- 課金は、最初のバックアップが正常に完了するまでは開始されません。 この時点では、ストレージと保護するインスタンスの両方に対する課金が開始されます。
- 仮想マシンのコンテナー内に格納されたバックアップ データが存在する限り、課金は継続されます。 仮想マシンの保護を停止しても、仮想マシンのバックアップ データがコンテナーに存在していると、課金は継続します。
- 指定された VM に対する課金は、保護が停止され、かつすべてのバックアップ データが削除されている場合にのみ停止します。
- 保護が停止してアクティブなバックアップ ジョブがないとき、最後に成功した VM バックアップのサイズは、毎月の課金に使用する保護インスタンスのサイズになります。
- 保護されたインスタンスの計算は、仮想マシンの*実際の*サイズ (一時ストレージを除く、仮想マシン内のすべてのデータの合計) に基づきます。
- 価格は、データ ディスクに格納された実際のデータに基づきます。
- VM をバックアップするための価格は、仮想マシンに接続されたデータ ディスクごとのサポートされる最大サイズには基づきません。
- 同様に、バックアップ ストレージの課金は、Azure Backup に格納されているデータ量 (各回復ポイントの実際のデータの合計) に基づきます。

たとえば、最大サイズが各 4 TB のデータ ディスクが 2 台追加で搭載されている A2 標準サイズの仮想マシンがあります。 次の表は、これらの各ディスクに格納されている実際のデータです。

| ディスクの種類 | 最大サイズ | 実際のデータ量 |
| --------- | -------- | ----------- |
| オペレーティング システム ディスク |4095 GB |17 GB |
| ローカル ディスク/一時ディスク |135 GB |5 GB (バックアップに含まれない) |
| データ ディスク 1 |4095 GB |30 GB |
| データ ディスク 2 |4095 GB |0 GB |

- この場合の VM 仮想マシンの実際のサイズは、17 GB + 30 GB + 0 GB = 47 GB です。
- この保護するインスタンスのサイズ (47 GB) が、毎月の課金の基礎になります。
- 仮想マシンのデータ量が大きくなると、課金に使用される保護インスタンスのサイズもそれに応じて変化します。


## <a name="next-steps"></a>次の手順

バックアップ プロセスとパフォーマンスに関する考慮事項を確認した後、以下を実施してください。

- Azure ストレージの最適化パフォーマンスのためのアプリの調整についての[詳細を確認](../virtual-machines/windows/premium-storage-performance.md)する。 この記事ではプレミアム ストレージが使われていますが、標準ストレージのディスクにも当てはまります。
- VM のサポートと制限、コンテナーの作成、および VM のバックアップの準備を確認することで、バックアップを[開始](backup-azure-arm-vms-prepare.md)する。
