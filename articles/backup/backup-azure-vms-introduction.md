---
title: Azure VM バックアップについて
description: Azure VM バックアップについて、また、いくつかのベスト プラクティスについて説明します。
services: backup
author: rayne-wiselman
manager: carmonm
ms.service: backup
ms.topic: conceptual
ms.date: 02/17/2019
ms.author: raynew
ms.openlocfilehash: c38c457bbf428d7252cf57168685201a2ca227ba
ms.sourcegitcommit: 6cab3c44aaccbcc86ed5a2011761fa52aa5ee5fa
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/20/2019
ms.locfileid: "56446802"
---
# <a name="about-azure-vm-backup"></a>Azure VM バックアップについて

この記事では、[Azure Backup サービス](backup-introduction-to-azure-backup.md)が Azure VM をどのようにバックアップするかについて説明します。

## <a name="backup-process"></a>バックアップ プロセス

Azure Backup が Azure VM のバックアップを完了する方法を説明します。

1. バックアップの対象として選択されている Azure VM に対して、Azure Backup サービスはユーザーが指定したバックアップ スケジュールに従ってバックアップ ジョブを開始します。
2. 最初のバックアップ時に、バックアップ拡張機能が VM (実行されている場合) にインストールされます。
    - Windows VM の場合、_VMSnapshot_ 拡張機能がインストールされます。
    - Linux VM の場合、_VMSnapshotLinux_ 拡張機能がインストールされます。
3. 実行されている Windows VM の場合、Backup は VSS と連携して、VM のアプリ整合性スナップショットを取得します。
    - 既定では、Backup で完全 VSS バックアップを取得します。
    - Backup はアプリ整合性スナップショットを取得できない場合、基になるストレージのファイル整合性スナップショットを取得します (VM の停止中はアプリケーションの書き込みは行われないため)。
4. Linux VM の場合、Backup ではファイル整合性スナップショットが取得されます。 アプリ整合性スナップショットの場合は、事前/事後スクリプトを手動でカスタマイズする必要があります。
5. スナップショットが作成されると、データはバックアップ コンテナーに転送されます。 
    - Backup は、各 VM ディスクを並行してバックアップすることで最適化されます。
    - バックアップされているディスクごとに、Azure Backup はディスク上のブロックを読み取り、前回のバックアップ以降に変更されたデータ ブロックのみ (差分) を識別して転送します。
    - スナップショットが取得された後、データはコンテナーに転送されます。
    - スナップショット データはコンテナーにすぐにコピーされない場合があります。 ピーク時には、数時間かかる場合があります。 毎日のバックアップ ポリシーでは、VM のバックアップの合計時間は 24 時間未満になります。

6. データ転送が完了すると、スナップショットが削除され、回復ポイントが作成されます。

![Azure 仮想マシンのバックアップ アーキテクチャ](./media/backup-azure-vms-introduction/vmbackup-architecture.png)

## <a name="encrypting-azure-vm-backups"></a>Azure VM バックアップの暗号化

Azure Backup を使用して Azure VM をバックアップするとき、保存中の VM は Storage Service Encryption (SSE) を使用して暗号化されます。 加えて、Azure Backup では、Azure Disk Encryption (ADE) を使用して暗号化された Azure VM をバックアップできます。


**暗号化** | **詳細** | **サポート**
--- | --- | ---
**ADE** | ADE は Azure VM の OS とデータ ディスクの両方を暗号化します。<br/><br/> ADE は、シークレットとしてキー コンテナーで保護されている BitLocker 暗号化キー (BEK)、または Azure Key Vault キー暗号化キー (KEK) と統合されます。 | Azure Backup は、BEK のみで、または BEK と KEK を併用して暗号化されたマネージドおよびアンマネージド Azure VM のバックアップをサポートします。<br/><br/> BEK とバックアップの両方が暗号化されます。<br/><br/> KEK と BEK がバックアップされるため、必要な場合、アクセス許可を持ったユーザーがキーとシークレットをキー コンテナーに復元し、暗号化された VM を復旧することができます。<br/><br/> 暗号化されたキーとシークレットは、承認されていないユーザーによって、または Azure によって読み取ることはできません。
**SSE** | SSE では、データを格納する前に自動的に暗号化し、取得前に暗号化を解除することによって、保存中の暗号化を Azure ストレージが提供します。 | Azure Backup では、Azure VM の保存中暗号化のために SSE を使用します。

- マネージドおよびアンマネージド Azure VM では、BitLocker 暗号化キー (BEK) のみで暗号化された VM、およびキー暗号化キー (KEK) で暗号化された BEK がサポートされています。
- バックアップされる BEK (シークレット) と KEK (キー) は暗号化されます。 承認されたユーザーによってキー コンテナーに復元されたときに限り、読み取りと使用が可能です。 承認されていないユーザーも Azure も、バックアップされたキーまたはシークレットの読み取りまたは使用はできません。
- BEK もバックアップされるため、BEK が失われた場合、承認されたユーザーは BEK を KeyVault に復元し、暗号化された VM を復旧できます。 
- 正しいレベルの権限を持つユーザーのみが暗号化された VM、およびキーとシークレットをバックアップして復元できます。



## <a name="taking-snapshots"></a>スナップショットの取得

Azure Backup はバックアップ スケジュールに従ってスナップショットを取得します。 

- **Windows VM**:Windows VM については、Backup サービスはボリューム シャドウ コピー サービス (VSS) と連携して VM ディスクのアプリ整合性スナップショットを取得します。
    - 既定では、Azure Backup は完全 VSS バックアップを取得します。 [詳細情報](http://blogs.technet.com/b/filecab/archive/2008/05/21/what-is-the-difference-between-vss-full-backup-and-vss-copy-backup-in-windows-server-2008.aspx)。
    - Azure Backup が VSS コピー バックアップを作成するように設定を変更する場合は、コマンド プロンプトから次のレジストリ キーを設定してください。**REG ADD "HKLM\SOFTWARE\Microsoft\BcdrAgent" /v USEVSSCOPYBACKUP /t REG_SZ /d TRUE /f**
- **Linux VM**:Linux VM のアプリ整合性スナップショットを取得する場合は、Linux の事前スクリプトおよび事後スクリプトのフレームワークを使用して、整合性を保証するための独自のカスタム スクリプトを記述してください。
    -  Azure Backup は、ユーザーが記述した事前/事後スクリプトのみを呼び出します。
    - 事前スクリプトと事後スクリプトが正常に実行されると、Azure Backup は復旧ポイントをアプリケーション整合性としてマークします。 ただし、カスタム スクリプトを使用したときのアプリケーション整合性の最終的な責任はユーザーが担います。
    - スクリプトの構成の[詳細](backup-azure-linux-app-consistent.md)を確認します。


### <a name="snapshot-consistency"></a>スナップショットの整合性

次の表で、整合性の種類について説明します。

**スナップショット** | **詳細** | **復旧** | **考慮事項**
--- | --- | --- | ---
**アプリケーションの整合性** | アプリ整合性バックアップでは、メモリの内容と保留中の I/O 操作がキャプチャされます。 アプリ整合性スナップショットでは、バックアップが発生する前にアプリ データの整合性を保証する VSS ライター (または Linux の事前/事後スクリプト) を使用します。 | アプリ整合性スナップショットで復旧する場合、VM が起動します。 データの損失や破損はありません。 アプリは整合性が確保された状態で開始します。 | Windows:すべての VSS ライターが成功した<br/><br/> Linux:事前/事後スクリプトが構成されて成功した
**ファイル システム整合性** | ファイル整合性バックアップでは、同時にすべてのファイルのスナップショットを作成することでディスク ファイルの整合性バックアップを提供します。<br/><br/> | ファイル整合性スナップショットによる復旧では、VM が起動します。 データの損失や破損はありません。 復元されたデータに一貫性が保たれるようにするために、アプリは独自の "修正" メカニズムを実装する必要があります。 | Windows:一部の VSS ライターが失敗した <br/><br/> Linux:既定 (事前/事後スクリプトが構成されていないか失敗した)
**クラッシュ整合性** | クラッシュ整合性は多くの場合、バックアップ時に Azure VM がシャットダウンされるときに発生します。  バックアップ時にディスクに既に存在していたデータのみが、キャプチャされバックアップされます。<br/><br/> クラッシュ整合性の復旧ポイントは、オペレーティング システムやアプリのデータ整合性を保証しません。 | 保証はありませんが、通常、VM が起動します。その後、ディスク検査が実行されて、破損エラーが修正されます。 メモリ内にあったデータやディスクに転送されなかった書き込みは、すべて失われます。 アプリは独自のデータ検証を実装しています。 たとえば、データベース アプリの場合、トランザクション ログにデータベース内に存在しないエントリが含まれている場合、データベース ソフトウェアはデータの整合性が得られるまでロールします。 | VM がシャット ダウン状態にある


## <a name="restore-considerations"></a>復元に関する考慮事項 



**考慮事項** | **詳細**
--- | ---
**ディスク** | VM ディスクのバックアップは並列です。 たとえば、VM にディスクが 4 つある場合、サービスは 4 つすべてのディスクを並列でバックアップしようとします。 バックアップは増分的 (変更されたデータのみ) です。
**スケジュール設定** |  バックアップ トラフィックを減らすには、重複がないよう、異なる VM を一日の異なる時間にバックアップします。 同時に VM をバックアップすると、トラフィックの渋滞が発生します。
**バックアップの準備** | バックアップの準備時間を考慮してください。これには、バックアップ拡張機能のインストールまたは更新と、バックアップ スケジュールに従ったスナップショットのトリガーが含まれます。
**データ転送** | バックアップ サービスが前回のバックアップからの増分変更を計算するために必要な時間です。<br/><br/> 増分バックアップでは、変更を特定するために、サービスはブロックのチェックサムを計算します。 ブロックが変更されている場合、コンテナーへの送信用に識別されます。 サービスは識別されたブロックを精査して、転送するデータをさらに最小化しようとします。 変更されているすべてのブロックを評価した後、変更がコンテナーに転送されます。<br/><br/> スナップショットを取得してからコンテナーにコピーするまでの間、ラグが生じる場合があります。<br/><br/> ピーク時には、バックアップの処理に最大 8 時間かかる可能性があります。 毎日のバックアップでは、VM のバックアップ時間は 24 時間未満になります。
**初回バックアップ** | 増分バックアップには 24 時間未満の合計バックアップ時間が有効ですが、初回バックアップには有効ではないことがあります。 必要な時間はデータのサイズとバックアップが取得された時間に応じて異なります。
**復元キュー** | Azure Backup は複数のストレージ アカウントからの復元ジョブを同時に処理し、復元要求はキューに入れられます。
**復元コピー** | 復元処理の間、データがコンテナーからストレージ アカウントにコピーされます。<br/><br/> 復元時間はストレージ アカウントの IOPS とスループットによって異なります。<br/><br/> コピー時間を短縮するには、他のアプリケーションの書き込みおよび読み取りの負荷がないストレージ アカウントを選択します。


### <a name="backup-performance"></a>バックアップ パフォーマンス

以下の一般的なシナリオは、バックアップ時間に影響を与える可能性があります。

- 保護された Azure VM に新しいディスクを追加する:増分バックアップが実行されている VM に新しいディスクを追加した場合、既存ディスクの差分レプリケーションに加えて新しいディスクの初期レプリケーションが行われるため、バックアップが 24 時間で終わらないことがあります。
- 断片化したディスク:ディスクの変更が併置されていると、バックアップ操作が速くなります。 変更がディスク全体に分散および断片化している場合、バックアップは遅くなります。 
- ディスク チャーン:増分バックアップが実行されている保護されたディスクで毎日のチャーンが 200 GB を超える場合、バックアップの完了に時間がかかる (8 時間を超える) 可能性があります。 
- バックアップのバージョン:(インスタント リストア バージョンと呼ばれる) 最新バージョンのバックアップを使用している場合、変更の比較に、チェックサム比較よりも最適化されたプロセスが使用されます。 最新バージョンを使用していて、バックアップ スナップショットを削除した場合、チェックサム比較を使用したバックアップに切り替わり、バックアップ操作は 24 時間を超えます (または失敗します)。

## <a name="best-practices"></a>ベスト プラクティス 
VM バックアップを構成するときには、次のプラクティスに従うことをお勧めします。

- ポリシーで設定されている既定のスケジュール時間の変更を検討します。 たとえば、ポリシーで既定の時間が 12:00AM の場合、リソースの使用を最適化するために分単位で時間を進めることを検討してください。
- インスタント RP 機能を使用しない場合、Premium VM のバックアップには、ストレージ アカウントの総容量の約 50% を割り当ててください。 バックアップ サービスでは、スナップショットを同じストレージ アカウントにコピーし、それをコンテナーに転送するために、この容量が必要になります。
- 1 つのコンテナーから複数の VM を復元する場合は、ターゲットのストレージ アカウントがスロットルされないようにするために、それぞれ異なる [v2 ストレージ アカウント](https://docs.microsoft.com/azure/storage/common/storage-account-upgrade)を使用することを強くお勧めします。 たとえば、各 VM にはそれぞれ異なるストレージ アカウントを使用する必要があります (10 個の VM を復元する場合は、異なる 10 個のストレージ アカウントを使用することを検討してください)。
- Tier-1 ストレージ レイヤー (スナップショット) からの復元は (ストレージ アカウントが同じなので) 数分で完了しますが、Tier-2 ストレージ レイヤー (コンテナー) の場合は数時間かかる可能性があります。 利用可能なデータが Tier-1 にある場合は、復元を高速化するために、[インスタント リストア](backup-instant-restore-capability.md)機能を使用することをお勧めします (データをコンテナーから復元しなければならない場合は、処理時間が長くなります)。
- ストレージ アカウントあたりのディスク数の制限は、IaaS VM で実行されているアプリケーションがディスクにどれくらいアクセスするかによって決まります。 1 つのストレージ アカウントで複数のディスクがホストされているかどうかを確認してください。 通常、1 つのストレージ アカウント上に 5 ～ 10 個以上のディスクが存在する場合は、一部のディスクを別のストレージ アカウントに移動して負荷を分散します。

## <a name="backup-costs"></a>バックアップのコスト

Azure Backup を使用してバックアップされている Azure VM は、[Azure Backup の価格](https://azure.microsoft.com/pricing/details/backup/)の対象になります。

- 課金は、最初のバックアップが正常に完了するまでは開始されません。 この時点で、ストレージと保護する VM の両方に対する課金が開始されます。
- VM のコンテナー内に格納されたバックアップ データが存在する限り、課金は継続されます。 VM の保護を停止したが VM のバックアップ データがコンテナーに存在している場合、課金は継続されます。
- 指定された VM に対する課金は、保護が停止され、かつすべてのバックアップ データが削除されている場合にのみ停止します。
- 保護が停止してアクティブなバックアップ ジョブがないとき、最後に成功した VM バックアップのサイズは、毎月の課金に使用する保護されたインスタンスのサイズになります。
- 保護されたインスタンスの計算は、VM の*実際の*サイズ (一時ストレージを除く、VM 内のすべてのデータの合計) に基づきます。
- 価格は、データ ディスクに格納された実際のデータに基づきます。
- VM をバックアップするための価格は、VM に接続されたデータ ディスクごとのサポートされる最大サイズには基づきません。
- 同様に、バックアップ ストレージの課金は、Azure Backup に格納されているデータ量 (各回復ポイントの実際のデータの合計) に基づきます。

たとえば、最大サイズが各 4 TB のデータ ディスクが 2 台追加で搭載されている A2 標準サイズの VM があります。 次の表は、これらの各ディスクに格納されている実際のデータです。

**ディスク** | **最大サイズ** | **実際のデータ量**
--- | --- | ---
OS ディスク | 4095 GB | 17 GB 
ローカル/一時ディスク | 135 GB | 5 GB (バックアップに含まれない) 
データ ディスク 1 | 4095 GB | 30 GB 
データ ディスク 2 | 4095 GB | 0 GB 

- この場合の VM の実際のサイズは、17 GB + 30 GB + 0 GB = 47 GB です。
- この保護されたインスタンスのサイズ (47 GB) が、毎月の課金の基礎になります。
- VM のデータ量が大きくなると、課金に使用される保護されたインスタンスのサイズもそれに応じて変化します。


## <a name="next-steps"></a>次の手順

Azure VM バックアップの[準備](backup-azure-arm-vms-prepare.md)に進みます。
