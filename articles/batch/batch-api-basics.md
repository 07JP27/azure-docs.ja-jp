<properties 
	pageTitle="Azure Batch の API の基本" 
	description="開発者に Azure Batch API と Batch サービスについて知ってもらうための概念" 
	services="batch" 
	documentationCenter=".net" 
	authors="yidingzhou" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="batch" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="big-compute" 
	ms.date="03/19/2015" 
	ms.author="yidingz"/>

<!--The next line, with one pound sign at the beginning, is the page title-->
# Azure Batch の API の基本

Azure Batch サービスは、スケーラブルな分散計算を実現するジョブ スケジューリング フレームワークを提供します。Batch サービスは、異なるクラスターやデータ センターに配置されている仮想マシンのセットを Azure に保持します。Batch サービスは、これらの VM の指定されたコレクションで 1 つまたは複数のプログラムを実行して分散計算を実行します。これらのプログラムは、オンデマンドで実行することも、特定の時刻に実行するようにスケジュールすることもできます。Batch サービスは、これらの VM を管理して、お客様から指定されたリソース要件、仕様、および制約に従って計算タスクを実行します。

Batch サービスを使用すると、コンピューティング リソースをキューイング、スケジュール設定、割り当て、および管理するためのコードを記述する必要がなくなります。これにより、お客様は特定のアプリケーションに注力でき、基になるプラットフォームのジョブのスケジュールやリソース管理の複雑さについて心配する必要がなくなります。さらに、処理する必要があるデータへのアクセスに加えて、これらのジョブの場所を最適化できるようになります。

Batch サービスを使用して実現できるシナリオのいくつかを次に示します。

- 計算負荷の高い並列処理

- ファイルの毎日のクリーンアップ

- バッチ処理

## <a name="resource"></a> バッチのサービスのリソース

Batch サービスを使用する際は次のリソースを使用します。

- [アカウント](#account)

- [タスク仮想マシン](#taskvm)

- [プール](#pool)

- [作業項目](#workitem)

- [ジョブ](#job)

- [タスク](#task)

	- [タスクを開始します。](#starttask)
	
	- [ジョブの ManagerTask](#jobmanagertask)

### <a name="account"></a>アカウント

Batch アカウントは、Batch サービス内で一意に識別されるエンティティです。すべての処理は、Batch アカウントを介して行われます。Batch サービスで処理を実行するには、アカウントの名前とキーが必要になります。バッチのアカウントに関するセクションを参照して、バッチのアカウントを作成する [Azure バッチの概要][]です。


### <a name="taskvm"></a>タスク仮想マシン

タスク仮想マシン (TVM) は、アプリケーションの特定のワークロード専用の Azure VM です。TVM のサイズによって、CPU コアの数、メモリ容量、および TVM に割り当てられるローカル ファイル システムのサイズが決まります。TVM」の説明に従って、小さな、l、または使って巨大の仮想マシンを指定できます [仮想マシンと Azure のクラウド サービスのサイズ](http://msdn.microsoft.com/library/dn197896.aspx)です。

TVM で実行できるプログラムの種類には、実行可能ファイル (.exe)、コマンド ファイル (.cmd)、バッチ ファイル (.bat)、およびスクリプト ファイルが含まれます。また、TVM は、次の属性を持ちます。

- タスク固有で共有されているファイル システム フォルダー。フォルダーの構造と環境の変数は、各プールの仮想マシンに作成されます。アプリケーションとデータのタスク、および各タスク用のフォルダー間で共有される「共有」フォルダーとは、次のフォルダー構造が作成されます。

![][1]

- Stdout.txt ファイルと Stderr.txt ファイル。これらのファイルは、タスクに固有のフォルダーに書き込まれます。

- 処理のための環境変数。

- アクセスを制御するために構成されるファイアウォール設定。

>VM のアクセス
>
>バーチャル マシンへのアクセスがたとえばデバッグのために必要な場合、リモート デスクトップを介して仮想マシンへのアクセスに使用できる、RDP ファイルを取得できます。


### <a name="pool"></a>プール

プールは、アプリケーションが実行される TVM のコレクションです。プールはお客様が作成できるほか、お客様が実行する操作を指定するときに Batch サービスによって自動的にプールが作成されるように設定することもできます。お客様は、アプリケーションのニーズを満たすプールを作成して管理できます。プールは、そのプールを作成した Batch アカウントのみが使用できます。1 つの Batch アカウントで複数のプールを持つことができます。

Azure のバッチのプールは、中核となる Azure のコンピューティング プラットフォームの上に構築します。バッチのプールは、大規模な割り当て、アプリケーションとデータのインストール、データの移動、状態の監視、および仮想マシンのスケーリングの柔軟性が提供します。

プールに追加されたすべての TVM に対し、一意の名前と関連 IP アドレスが割り当てられます。TVM をプールから削除すると、オペレーティング システム、すべてのローカル ファイル、その名前、およびその IP アドレスに加えられた変更は失われます。TVM をプールから削除すると、その有効期間が終了します。

プール内の TVM 間の通信を許可するようにプールを構成できます。プールに対してプール内通信が要求された場合、Batch サービスは、プール内の各 TVM で 1100 を超えるポートを有効にします。プール内の各 TVM は、このポート範囲への着信接続およびプール内の他の TVM からの着信接続のみを許可および制限するように構成されます。アプリケーションが TVM 間の通信を必要としない場合、Batch サービスは、異なるクラスターまたはデータ センターにまたがる大量の TVM をプールに割り当てることにより、より大規模な並列処理を実現できます。

プールを作成するときに次の属性を指定できます。

-  **Vm のサイズ** プールにします。
	- 適切な VM のサイズの特性と、アプリケーションまたは VM で使用する予定のアプリケーションの要件に応じて、選択する必要があります。1 つのタスクが、VM で一度に実行されると仮定した場合、VM のサイズが選択される通常たとえば、アプリケーションがマルチ スレッドし、必要なメモリ量、最も適切かつコスト効率の高い VM のサイズが決定されます。それが割り当てられている複数のタスクを使用することで、複数のアプリケーション インスタンスの VM の場合、並列で実行されているが選択通常 – [VM あたりの最大のタスク] の下を参照してください。 
	- すべての VM のプールでは、同じサイズである必要があります。別のアプリケーションが別のシステム要件やさまざまな負荷を実行する場合に別々 のプールを作成してください。
	- A0 を除き、プールのすべてのクラウド サービスの VM サイズを構成することができます。

- オペレーティング システム ファミリおよびバージョンを Vm で実行します。
	- ワーカー ロールの場合と同様には、OS ファミリ、およびオペレーティング システムのバージョンを構成することができます。
	- OS ファミリは、.NET のバージョンは、OS と共にインストールも決定します。
	- ワーカー ロール、OS のバージョンについてはお勧めするように"*"、VM は自動的にアップグレードされて存在しないように新規のバージョンに対応するために必要な作業に使用します。メインのユース ケースを特定の OS バージョンを選択するには、旧バージョンとの互換性を更新するバージョンを許可する前に実行するテストを許可することで、アプリケーションの互換性は維持するためにです。検証、プールの OS のバージョンを更新して、新しい OS イメージ インストールされていると、実行中のタスクが中断され再キューに置かれました。

- Vm、プールに使用できる必要があるの目標の数。

- プールのスケーリング ポリシー。Vm の数、以外も各プールの自動スケーリングの数式を指定できます。バッチのサービスは、プールとワーク アイテムの統計情報に基づいて仮想マシンの数を変更する式を実行します。

- スケジュールの構成
	- 既定の構成は、プールの仮想マシン上でいつでも実行するタスクを 1 つの VM 上で同時に実行することができる 1 つ以上のタスクがあると便利があるシナリオがあります。1 つの例では、アプリケーションでは、I/O を待機する場合は、VM の使用率を向上するには1 つ以上のアプリケーションを実行すると CPU 使用率が増加します。別の例では、プール内の VM の数を削減するには大規模な参照データのセットに必要なデータのコピーの量を減らすこの可能性があります。A1 は、アプリケーションの適切なサイズは、A4 が選択される可能性し、構成が 8 のタスクを最大で 1 回実行する各による消費、コアに設定します。
	- [VM あたりの最大のタスク] の構成は、並列で実行できるタスクの最大数を決定します。
	- "Fill ポリシー"も指定できます VM の最初のページまたはかどうかのタスクが分散して、VM のすべてのバッチを入力するかどうかを決定します。
 
- プール内のバーチャル マシンの通信状態です。
 	- シナリオの大部分は、タスク、独立した操作し、他のタスクと通信する必要はありませんが一部のアプリケーションのタスクが (MPI を使用してアプリケーションなど) を通信します。
	- 構成は、VM は、通信するためにできるかどうかを制御する、基になるネットワーク インフラストラクチャと影響の配置、VM の構成に使用されます。

- プール内の TVM の開始タスク。

プールを作成するときに、プールを関連付けるストレージ アカウントを指定できます。Batch サービスにより、ネットワーク接続および帯域幅容量がより優れているデータ センターの TVM が指定されたストレージ アカウントに割り当てられます。これにより、ワークロードがより効率的にデータにアクセスできるようになります。

### <a name="workitem"></a>作業項目

作業項目は、プール内の TVM 上での計算の実行方法を指定します。

- 作業項目には、1 つまたは複数のジョブが関連付けられていることができます。(省略可能)、スケジュールの場合、スケジュールのたびに 1 つのジョブが作成、作業項目の指定できます。スケジュールを指定しない場合、オンデマンドでの作業で、ジョブがすぐに作成されます。
- 作業項目には、作業を実行するプールを指定します。プールは、ユーザーが既存、既に多くの作業項目で使用されているプールを作成できますが、作業項目に関連付けられているジョブごとに、または作業項目に関連付けられているすべてのジョブの別の方法として、プールを作成できます。
- (省略可能)、優先度を指定することができます。優先度が高い他の実行中の作業項目よりも、作業項目が送信されるときにより高い優先度の作業項目のタスクを取得、低い優先度の作業項目のタスクよりも先のキューに挿入されます。既に実行されている優先順位の低いタスクを事前にはなりません。
- 関連付けられたジョブまたはジョブに適用される制約を指定できます。
	- ジョブの最大 wallclock 時刻を設定できます。指定された最大 wallclock 時間より長い、ジョブが実行されるジョブと関連付けられているすべてのタスクを終了するされます。
	- Azure のバッチは、タスクが失敗し、タスクを再試行を検出できます。タスク再試行の最大数は、制約として指定できます既定などのタスクは、常にことを指定する再試行または再試行ことはありません。再試行、タスク、タスクが再度キューに置かれたおよびをもう一度実行することを意味します。
- タスクの作業項目のジョブの実行は、作業項目が作成されているが、ジョブ マネージャーのタスクを指定することがまたはできますを同じ方法で、クライアントによって指定できます。ジョブ マネージャー タスクは、バッチ API を使用して、プールの VM のいずれかで実行中のタスクをジョブの必要なタスクを作成するコードが含まれています。ジョブ マネージャーのタスクはバッチで具体的には処理-は、ジョブが作成され、何らかの理由で失敗した場合は再起動と、すぐにキューに配置します。ジョブ マネージャーが、ジョブがインスタンス化される前に、タスクを定義する唯一の方法があると同時に関連付けられたスケジュールでの作業項目の必要です。

### <a name="job"></a>ジョブ

ジョブは、作業項目の実行中のインスタンスです。ジョブは、タスクのコレクションで構成されます。Batch サービスは、作業項目の構成に基づいてジョブをインスタンス化します。ジョブは、作業項目に関連付けられているプールの TVM を使用します。

### <a name="task"></a>タスク

タスクは、TVM 上で実行される、ジョブに関連付けられた計算の単位です。タスクの実行用の VM に割り当てられたまたは VM が無料になるまではキューに登録されます。タスクは、次のリソースを使用します。

- 作業項目で指定されたプログラム。

- 処理するデータを含むリソース ファイル。これらのファイルは BLOB ストレージから TVM に自動的にコピーされます。詳細については、「ファイルとディレクトリ」を参照してください。

- プログラムで必要とされる環境設定。詳細については、「タスクの環境設定」を参照してください。

- 計算に適用される制約。たとえば、タスクの実行が許可される最大時間、タスクの実行が失敗した場合に再試行する最大回数、作業ディレクトリにファイルを保持する最大時間などです。

TVM で計算を実行するために定義できるタスクに加えて、Batch サービスによって提供される次の特殊なタスクを使用できます。

- [タスクを開始します。](#starttask)

- [ジョブ マネージャーのタスク](#jobmanagertask)

#### <a name="starttask"></a>タスクを開始します。

開始タスクをプールに関連付けることによって、プール内の Vm のオペレーティング システムを構成できます。開始タスクで実行できる操作の例として、ソフトウェアのインストールやバックグラウンド プロセスの起動があります。開始タスクは、プールに残るに限りの VM が開始されるたびに実行されます。

として他のバッチのタスクと Azure のストレージ内のファイルの一覧は、指定できますだけでなく、バッチで実行されるコマンド ライン。Azure のバッチ最初のファイルを Azure ストレージからコピーをし、コマンドラインを実行することができます。プールの開始タスクをファイルの一覧には通常、アプリケーションのファイルまたはパッケージが含まれていますが、プール VM ので実行されているすべてのタスクで使用される参照データを含めることもできます。PowerShell スクリプトや robocopy、たとえば、アプリケーション ファイルをフォルダーにコピーします「共有」です。 コマンドラインを実行できます。MSI を実行することもできます。

通常のバッチの開始タスクを完了し、VM をタスクに割り当てられる状態にすること検討して待機することが望ましいですが、これは構成できます。

プールの VM の開始タスクが失敗した場合、VM の状態がエラーを反映するように更新し、VM を割り当てられるタスクに対しては使用されません。開始タスクが失敗するは、問題の開始タスクに指定されたファイルのコピーがあるか、[プロセスの開始タスクを 0 以外を返します。

VM を構成し、アプリケーションをインストールするために必要なすべての情報が宣言されていること、ファクトは、プール内の VM の数を増やすことがだけです。 新しい、必要な数を指定することを意味します。バッチが、VM の構成し、タスクをそのまま使用するために必要なすべての情報です。

開始タスクは、プールの追加操作の要求本文に、JSON のセクションを追加することによって定義されます。次の例は、開始タスクの基本的な定義を示しています。

	{
		“commandLine”:”mypoolsetup.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”mypoolsetup.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“maxTaskRetryCount”:0
	}

C# インターフェイスは、次のようになります。

	ICloudPool pool = pm.CreatePool(poolName, targetDedicated: 3, vmSize: "small", osFamily: "3");
	pool.StartTask = new StartTask();
	pool.StartTask.CommandLine = "mypoolsetup.exe";
	pool.StartTask.ResourceFiles = new List<IResourceFile>();
	pool.StartTask.ResourceFiles.Add(new ResourceFile("http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d", "mypoolsetup.exe"));
	pool.Commit();


#### <a name="jobmanagertask"></a>ジョブ マネージャーのタスク

ジョブ マネージャー タスクは、他のすべてのタスクの前に開始されます。ジョブ マネージャー タスクには、次の利点があります。

- ジョブの作成時に Batch サービスによって自動的に作成されます。

- ジョブ内の他のタスクの前にスケジュールされます。

- ジョブ マネージャー タスクに関連付けられた TVM は、プールが縮小されるときに最後にプールから削除されます。

- 再起動する必要がある場合に最も高い優先順位が割り当てられます。アイドル状態の TVM を使用できない場合、Batch サービスは、この TVM が実行する余地を確保するためにプール内のいずれかの実行中のタスクを終了する場合があります。

- ジョブ マネージャー タスクの終了を、ジョブ内のすべてのタスクの終了に関連付けることができます。

ジョブ内のジョブ マネージャー タスクは、他のジョブ内のタスクよりも優先されません。ジョブ間では、ジョブ レベルの優先順位のみが適用されます。ジョブ マネージャー タスクは、作業項目の追加操作の要求本文に XML セクションを追加することによって定義します。次の例は、ジョブ マネージャー タスクの基本的な定義を示しています。

	{
		“name”:”jmTask”,
		“commandLine”:”myapp1.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp1.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“taskConstraints”:
		{
			“maxWallClockTime”:”PT1H”,
			“maxTaskRetryCount”:0,
			“retentionTime”:”PT1H”
		},
		“killJobOnCompletion”:true,
		“runElevated”:false,
		“runExclusive”:true
	}




## <a name="workflow"></a>バッチのサービスのワークフロー

Batch サービスを使用するには、Batch アカウントが必要です。計算をスケジュールするには、サービスの複数のリソースを使用します。Batch サービスによる分散計算シナリオを作成する場合は、次の基本的なワークフローを使います。

1. Azure のストレージ アカウントに分散計算シナリオで使用するファイルをアップロードします。これらのファイルは、Batch サービスがアクセスできるように、ストレージ アカウントに配置する必要があります。これらのファイルは、Batch サービスによってタスクの実行時に TVM に読み込まれます。

2. は、ストレージ アカウントに依存するバイナリ ファイルをアップロードします。バイナリ ファイルとは、タスクによって実行されるプログラムと依存アセンブリを表します。これらのファイルはストレージからもアクセスできる必要があります。これらのファイルは、TVM に読み込まれます。

3. Tvm のプールを作成します。プールの作成時に、使用するタスク仮想マシンのサイズを割り当てることができます。タスクを実行すると、このプールから TVM が割り当てられます。

4. はワーク アイテムを作成します。作業項目を作成すると、ジョブが自動的に作成されます。作業項目を使って、タスクのジョブを管理できます。

5. はワーク アイテムにタスクを追加します。各タスクは、アップロードされたプログラムを使用して、アップロードされたファイルの情報を処理します。

6. では、出力の結果を監視します。

## <a name="files"></a>ファイルとディレクトリ

各タスクは作業ディレクトリを持ちます。この作業ディレクトリ内に、タスクによって実行されるプログラム、タスクによって処理されるデータ、およびタスクによって実行された処理の出力を格納するためのディレクトリおよびファイルが 0 個以上作成されます。これらのディレクトリとファイルは、ジョブの実行中に他のタスクから使用できます。TVM 上のすべてのタスク、ファイル、およびディレクトリは、単一のユーザー アカウントによって所有されます。

Batch サービスは、TVM 上のファイル システムの一部をルート ディレクトリとして公開します。TVM のルート ディレクトリは、タスク、WATASK_TVM_ROOT_DIR 環境変数を使用できます。環境変数の使用に関する詳細については、「タスクの環境設定」を参照してください。

ルート ディレクトリには、次のサブディレクトリが含まれます。

- **タスク** – この場所は、すべてのファイルが格納される、TVM 上で実行されるタスクに属しています。各タスクでは、バッチ サービスは %watask_tvm_root_dir%/tasks/workitemname/jobname/taskname/の形式で一意のパスを作業ディレクトリを作成します。このディレクトリでは、タスクへの読み取り/書き込みアクセスが可能です。タスクは、このディレクトリの下で、ファイルを作成、読み取り、更新、および削除できます。このディレクトリは、タスクに対して指定された RetentionTime 制約に基づいて保持されます。

- **共有** – この場所は、共有ディレクトリのすべてのアカウントでのタスクです。TVM 上、共有ディレクトリは %watask_tvm_root_dir%/shared です。このディレクトリでは、タスクへの読み取り/書き込みアクセスが可能です。タスクは、このディレクトリの下で、ファイルを作成、読み取り、更新、および削除できます。

- **開始** – この場所は、開始タスクによって、作業ディレクトリとして使用します。開始タスクを起動するために Batch サービスによってダウンロードされるファイルもすべてこのディレクトリに格納されます。TVM 上、開始ディレクトリは %watask_tvm_root_dir%/start です。タスクは、このディレクトリの下で、ファイルを作成、読み取り、更新、および削除できます。開始タスクは、このディレクトリを使用して、オペレーティング システムを構成できます。

TVM をプールから削除すると、TVM に格納されているすべてのファイルが削除されます。

## <a name="lifetime"></a>プールと仮想マシンの有効期間

基本的な設計の決定は、プールを作成するときと、VM は使用可能な保持期間です。

1 つの極端な例として、ジョブが送信され、VM の削除タスクの実行を完了するとジョブごとに、プールを作成することができます。VM の絶対に必要なときにのみを割り当てられるし、アイドル状態のシャット ダウンになるとすぐには使用率を最大化されます。わけでは、VM の割り当てには、個別に使用すると、すぐにタスク vm のスケジュールすることに注意してくださいことは重要ですが割り当てられているし、スタートのタスクが完了するとします。 ジョブを待機する必要があります。つまり、プール内のすべての VM が使用可能な使用率の低下につながるとするようになるまで、バッチは待機しません。

プールを作成する必要があり、ジョブを送信する前に、仮想マシンで使用可能なジョブの開始がある場合に、優先度はすぐに実行です。タスクが、すぐに開始できますが、VM の負荷に応じて、ジョブのタスクを待つ間アイドル状態になります。

継続的な負荷の量は、プールを複数のジョブが送信される、上または下の負荷。 に従って仮想マシンの数の小数点以下桁数がある場合に、1 つの一般的なパターンこれを行う事後対応的または事前に負荷を予測できる場合です。

## <a name="scaling"></a>アプリケーションのスケーリング

アプリケーションのスケールを簡単かつ自動的に拡大または縮小して、必要な計算ニーズに対応できます。現在のワークロードとリソース使用状況統計に従って、プール内の TVM の数を動的に調整できます。また、自動的にスケーリングを行うように構成することにより、アプリケーションの全体的な実行コストを最適化することもできます。プールの作成時にスケーリング設定を指定できます。また、いつでも構成を更新することができます。

仮想マシンの数の減少、考慮する必要がある VM で実行されているタスクがあります。割り当て解除ポリシーは、VM をすぐに、または、VM が削除される前に完了するタスクができるかどうかを削除する実行中のタスクが停止するかどうかを決定するを指定します。VM のターゲットを設定、ジョブの最後にゼロしますが、[完了]、使用率を最大化するタスクを実行していることができます。

アプリケーションの自動スケーリングを指定するには、一式のスケーリング式を使用します。式を使用して、次のスケーリング間隔のプールに含まれる TVM の数を決定できます。たとえば、プールでのスケジュール対象として大量のタスクを送信する必要があるとします。この場合、現在の保留中のタスクの数とタスクの完了率に基づいてプールのサイズを指定するスケーリング式をプールに割り当てることができます。Batch サービスは、定期的に式を評価し、ワークロードに基づいてプールのサイズを変更します。

式には次のメトリックを使用できます。

- **時間メトリック** – 5 分おきに指定した数時間の収集された統計情報に基づいています。

- **リソース メトリック** – CPU 使用状況、帯域幅の使用率、メモリ使用量、および Tvm の数に基づいています。

- **メトリック タスク** – 保留中のアクティブなどのタスクの状態に基づきし、完了します。

アプリケーションの自動スケーリングの詳細については、「Configure Autoscaling of Task Virtual Machines (タスク仮想マシンの自動スケーリングの構成)」を参照してください。

>VM を削除します。
>
>多くの場合、必須ではありませんが、プールから削除するの個々 の VM を指定することになります。以下であるというは、疑いがある場合、VM がある場合は、信頼できることを削除できますなど。

## <a name="cert"></a>アプリケーションの証明書

通常、機密情報を暗号化するときは証明書を使用する必要があります。証明書は TVM にインストールすることができます。暗号化された機密情報は、コマンドライン パラメーターでタスクに渡されるか、またはリソースの 1 つに埋め込まれ、インストールされた証明書を使用して復号化できます。機密情報の一例としてストレージ アカウントのキーがあります。

Batch アカウントに証明書を追加するには、証明書の追加操作を使用します。次に、新規または既存のプールに証明書を関連付けることができます。証明書がプールに関連付けられると、Batch サービスは、プール内の各 TVM に証明書をインストールします。Batch サービスは、TVM の起動時に、いずれかのタスク (開始タスク、ジョブ マネージャー タスクも含まれます) を起動する前に、適切な証明書をインストールします。

## <a name="scheduling"></a>スケジューリング優先順位

作業項目を作成するときに優先順位を割り当てることができます。作業項目の下の各ジョブは、この優先順位で作成されます。Batch サービスは、ジョブの優先順位値を使用して、アカウント内のジョブ スケジューリングの順序を決定します。優先順位として、-1000 ～ 1000 の値を使用します。-1000 は最も低い優先順位を示し、1000 は最も高い優先順位を示します。ジョブの優先順位を更新するには、ジョブの更新操作を使用します。

同じアカウント内で、優先順位の高いジョブは優先順位の低いジョブよりも優先的にスケジュールされます。あるアカウントの優先順位値が高いジョブが、異なるアカウントの優先順位値が低い別のジョブよりも優先的にスケジュールされることはありません。

異なるプールのジョブ スケジューリングは独立しています。異なるプール間では、関連するそのプールでアイドル状態の TVM が不足している場合、優先順位の高い方のジョブが最初にスケジュールされるとは限りません。同じプール内のジョブの場合、優先順位が同じであれば、スケジュールされる可能性は等しくなります。

## <a name="environment"></a>タスクの環境の設定

タスクのコンテキストで使用可能な環境設定を指定できます。開始タスクおよびジョブで実行されるタスクの環境設定は、タスクの追加操作またはタスクの更新操作の要求本文に XML セクションを追加することによって定義します。

次の例は、環境設定の定義を示しています。

ジョブでスケジュールされるすべてのタスクに対し、特定の環境変数のセットが Batch サービスによって設定されます。次の表に、すべてのタスクに対して Batch サービスによって設定される環境変数を示します。

<table>
  <tr>
   <th>環境変数の名前
   </th>
   <th>
   説明
   </th>
  </tr>
 <tr>
  <td>
  WATASK_ ACCOUNT_NAME
  </td>
  <td>
  タスクが所属するアカウントの名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_WORKITEM_NAME
  </td>
  <td >タスクが所属する作業項目の名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_JOB_NAME
  </td>
  <td >タスクが所属するジョブの名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TASK_NAME
  </td>
  <td >現在のタスクの名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_POOL_NAME
  </td>
  <td >タスクが実行されているプールの名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_NAME
  </td>
  <td >タスクが実行されている TVM の名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_ROOT_DIR
  </td>
  <td >TVM 上のルート ディレクトリの完全パス。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_PORTRANGE_LOW WATASK_PORTRANGE_HIGH
</td>
<td>
  プール間通信が有効な場合にタスクが通信用に使用できるポートの範囲 (両端でその値を含みます)。
</td>
</table>

**注意してください。**

これらのシステム定義の変数を上書きすることはできません。

環境設定の値を取得するには、タスクの取得操作を使用します。

## <a name="errorhandling"></a>エラー処理

###タスクのエラー処理
タスクの失敗は、次のカテゴリに分類されます。

- エラーのスケジュールを設定します。
	- タスクのファイルも指定しない場合は、1 つまたは複数のファイルのコピーは失敗します。ファイルを移動した可能性があります、ストレージ アカウントは、終了など、使用可能です。
	- 「スケジューリング エラー」は、ここでは、タスクに設定します。
- アプリケーション障害:
	- コマンドラインで指定されたタスクの処理も失敗します。プロセスは、ゼロ以外の終了コードが返されたときに失敗したと見なされます。
	- アプリケーション エラーには、指定された回数まで、タスクを自動的に再試行するバッチを構成することです。 
- 制約の障害:
	- ジョブまたはタスクを実行できる時間の最大量の制約を指定できます。ハング状態にするタスクを終了するのに便利です。
	- 時間の最大数を超過したし、タスクは完了とマークしますが、終了コードとしてマークされている場合に `0xC000013A` schedulingError フィールドとしてマークされます `{ category:“ServerError”, code=“TaskEnded”}`です。

###アプリケーション エラーのデバッグ

アプリケーションは、問題をトラブルシューティングするために使用する診断を生じることがあります。多くの場合、アプリケーションは、stdout と stderr ファイルまたはカスタムのファイルへの出力に情報を書き込みます。このような場合は、タスク、または VM のいずれかを指定して、ファイルを取得する API は提供されます。

プール VM にログインすることもできます。API を使用できる VM の RDP ファイルを返しますを VM にログインします。

###食のタスクのエラーと問題について

タスクが失敗する可能性またはのいくつかの理由から中断します。タスクのアプリケーション自体が失敗する、タスクが実行されている VM を再起動した場合、または、VM は、除外の割り当てのポリシー設定をタスクの完了を待たずにすぐに、VM を削除すると、プールのサイズ変更によって削除します。すべてのケースでは、タスクが自動的に再によってキューに入れるバッチし、別の VM で実行します。

タスク応答を停止または実行に時間がかかりを断続的な懸案事項のことです。最大実行時間には、タスクのセットでしきい値を超えるバッチが、タスクのアプリケーションを中断しているかどうかがあります。現時点では、自動キューに登録し、この場合のことはできませんが、ケースは、新しいタスクを送信できるクライアントによって検出できます。

###食の「不良」の VM

各仮想マシン、プールには、一意の名前と、タスクの meta データに含まれるタスクが実行されている VM に付与します。ここで何らかの理由で失敗するため、タスクを原因となっているバーチャル マシンがあるし、クライアントと問題のある VM は、プールから削除してこれを判断する場合です。タスクは、削除された VM で実行されていた、し、コンピューターはする自動的に再キューに置かれたを別の VM で実行します。


<!--Image references-->
[1]: ./media/batch-api-basics/batch-api-basics-01.png

[Azure バッチの概要]: batch-technical-overview.md

<!---HONumber=GIT-SubDir-->