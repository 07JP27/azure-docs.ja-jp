<properties 
	pageTitle="Azure Batch の API の基本" 
	description="開発者に Azure Batch API と Batch サービスについて知ってもらうための概念" 
	services="batch" 
	documentationCenter=".net" 
	authors="yidingzhou" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="batch" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="big-compute" 
	ms.date="07/14/2015" 
	ms.author="yidingz"/>

<!--The next line, with one pound sign at the beginning, is the page title-->
# Azure Batch の API の基本

Azure Batch サービスは、スケーラブルな分散計算を実現するジョブ スケジューリング フレームワークを提供します。Batch サービスは、異なるクラスターやデータ センターに配置されている仮想マシンのセットを Azure に保持します。Batch サービスは、これらのノードの指定されたコレクションで 1 つまたは複数のプログラムを実行して分散計算を実行します。これらのプログラムは、オンデマンドで実行することも、特定の時刻に実行するようにスケジュールすることもできます。Batch サービスは、これらのノードを管理して、お客様から指定されたリソース要件、仕様、および制約に従って計算タスクを実行します。

Batch サービスを使用すると、コンピューティング リソースをキューイング、スケジュール設定、割り当て、および管理するためのコードを記述する必要がなくなります。これにより、お客様は特定のアプリケーションに注力でき、基になるプラットフォームのジョブのスケジュールやリソース管理の複雑さについて心配する必要がなくなります。さらに、処理する必要があるデータへのアクセスに加えて、これらのジョブの場所を最適化できるようになります。

Batch サービスを使用して実現できるシナリオのいくつかを次に示します。

- 計算負荷の高い並列処理

- ファイルの毎日のクリーンアップ

- バッチ処理

## <a name="resource"></a> Batch サービスのリソース

Batch サービスを使用する際は次のリソースを使用します。

- [アカウント](#account)

- [計算ノード](#computenode)

- [プール](#pool)

- [ジョブ](#job)

- [タスク](#task)

	- [開始タスク](#starttask)
	
	- [ジョブ マネージャー タスク](#jobmanagertask)

- [ジョブ スケジュール](#jobschedule)

### <a name="account"></a>アカウント

Batch アカウントは、Batch サービス内で一意に識別されるエンティティです。すべての処理は、Batch アカウントを介して行われます。Batch サービスで処理を実行するには、アカウントの名前とキーが必要になります。Batch アカウントの作成方法については、[Azure Batch の概要][]に関するページで Batch アカウントのセクションを参照してください。


### <a name="computenode"></a>計算ノード

計算ノード (Node) は、アプリケーションの特定のワークロード専用の Azure ノードです。Node のサイズによって、CPU コアの数、メモリ容量、および Node に割り当てられるローカル ファイル システムのサイズが決まります。Node には、「[Azure の仮想マシンとクラウド サービスのサイズ](http://msdn.microsoft.com/library/dn197896.aspx)」に説明されているように、サイズが "小"、"大"、または "特大" の仮想マシンを使用できます。

Node で実行できるプログラムの種類には、実行可能ファイル (.exe)、コマンド ファイル (.cmd)、バッチ ファイル (.bat)、およびスクリプト ファイルが含まれます。また、Node は、次の属性を持ちます。

- ファイル システム フォルダー。タスクに固有のフォルダーと共有のフォルダーがあります。フォルダー構造と環境変数は、各プールのノードに作成されます。次のように、作成されるフォルダー構造には、タスク間で共有されるアプリケーションおよびデータ用の "共有" フォルダーと、各タスク用のフォルダーが含まれます。

<pre><code> ─ %AZ_BATCH_NODE_ROOT_DIR%
   ├─shared
   ├─startup
   └─&lt;JOB_ID>
     ├─&lt;TASK_ID_1>
     │ └─wd
     └─&lt;TASK_ID_2>
       └─wd
</code></pre>


- Stdout.txt ファイルと Stderr.txt ファイル。これらのファイルは、タスクに固有のフォルダーに書き込まれます。

- 処理のための環境変数。

- アクセスを制御するために構成されるファイアウォール設定。

>ノード アクセス
>
>デバッグなどの目的でノードへのアクセスが必要な場合、RDP ファイルを取得し、それを使用してリモート デスクトップ経由でノードにアクセスすることができます。


### <a name="pool"></a>プール

プールは、アプリケーションが実行される Node のコレクションです。プールはお客様が作成できるほか、お客様が実行する操作を指定するときに Batch サービスによって自動的にプールが作成されるように設定することもできます。お客様は、アプリケーションのニーズを満たすプールを作成して管理できます。プールは、そのプールを作成した Batch アカウントのみが使用できます。1 つの Batch アカウントで複数のプールを持つことができます。

Azure Batch プールは、コア Azure コンピューティング プラットフォームの上に構築されています。Batch プールによって、大規模な割り当て、アプリケーションおよびデータのインストール、データの移動、状態の監視、ノードの柔軟なスケーリングが可能になります。

プールに追加されたすべての Node に対し、一意の名前と関連 IP アドレスが割り当てられます。Node をプールから削除すると、オペレーティング システム、すべてのローカル ファイル、その名前、およびその IP アドレスに加えられた変更は失われます。Node をプールから削除すると、その有効期間が終了します。

プール内の Node 間の通信を許可するようにプールを構成できます。プールに対してプール内通信が要求された場合、Batch サービスは、プール内の各 Node で 1100 を超えるポートを有効にします。プール内の各 Node は、このポート範囲への着信接続およびプール内の他の Node からの着信接続のみを許可および制限するように構成されます。アプリケーションが Node 間の通信を必要としない場合、Batch サービスは、異なるクラスターまたはデータ センターにまたがる大量の Node をプールに割り当てることにより、より大規模な並列処理を実現できます。

プールを作成するときに次の属性を指定できます。

- プール内の **ノードのサイズ**。
	- ノードで使用する予定のアプリケーションの特性と要件に応じて、適切なノードのサイズを選ぶ必要があります。一般的には、ノードで一度に 1 つのタスクが実行されると想定してノードのサイズを選びます。たとえば、アプリケーションがマルチ スレッドで処理されるかどうか、どれだけのメモリが必要かなどの条件に応じて、最も適切かつコスト効率の高いノードのサイズを決定します。複数のタスクを割り当てて、複数のアプリケーション インスタンスを並列して実行することができます。通常、その場合にはより大きいノードサイズを選びます。詳しくは、ノードあたりの最大タスク数に関する説明を参照してください。 
	- プール内のすべてのノードが同じサイズである必要があります。システム要件や負荷が異なる別々のアプリケーションを実行する場合には、別々のプールを作成してください。
	- プールには、A0 を除くすべてのクラウド サービス ノード サイズを構成することができます。

- ノード上で実行するオペレーティング システム ファミリおよびバージョン。
	- worker ロールの場合と同様に、OS ファミリおよび OS バージョンを構成することができます。
	- OS ファミリによって、OS と同時にインストールされる .NET のバージョンも決まります。
	- worker ロールの場合と同様に、OS バージョンについては "*" を使用することをお勧めします。そうすることで、ノードが自動的にアップグレードされ、新しいバージョンに対応するための作業が不要になります。特定の OS バージョンを選択するのは、主にアプリケーションの互換性を維持する必要がある場合です。そのために、バージョンの更新を許可する前に旧バージョンとの互換性テストを実行できるようにします。検証が終わると、プールの OS バージョンを更新して、新しい OS イメージをインストールできます。その際、実行中のタスクはすべて中断され、再びキューに置かれます。

- プールで使用できるようにするノードの数。

- プールのスケーリング ポリシー。ノード数だけでなく、各プールに自動スケールの数式を指定することもできます。その数式は Batch サービスによって実行され、プールと作業項目の統計情報に基づいてノード数が調整されます。

- スケジュールの構成
	- 既定の構成では、プール ノードに対して 1 つのタスクを任意の時間に実行しますが、ノード上で複数のタスクを同時に実行できる方がメリットがあるシナリオもあります。たとえば、アプリケーションで I/O を待機する必要があるときに、ノードの使用率を増やす場合です。複数のアプリケーションを実行することで、CPU 使用率が増加します。また、プール内のノードの数を削減することで、大規模な参照データ セットに必要なデータ コピーの量を減らすことができます。アプリケーションの適切なサイズが A1 である場合、A4 を選択して一度に 8 個のタスクを実行する (各タスクが 1 個のコアを消費) ように構成することができます。
	- "ノードあたりの最大タスク数" の構成によって、並列実行できるタスク数の上限が決まります。
	- さらに、Batch によって先にノードに入力されるかどうか、またタスクがすべてのノードに分散されるのかどうかを決定する "入力ポリシー" も指定できます。
 
- プール内のノードの通信状態。
 	- ほとんどのシナリオでは、タスクは独立して実行され、他のタスクと通信する必要はありませんが、タスクが通信するアプリケーションも一部存在します (MPI を使用するアプリケーションなど)。
	- ノードが通信可能になるかどうかを制御する構成があるので、その構成を使用して基になるネットワーク インフラストラクチャを構成します。これは、ノードの配置に影響します。

- プール内の Node の開始タスク。

プールを作成するときに、プールを関連付けるストレージ アカウントを指定できます。Batch サービスにより、ネットワーク接続および帯域幅容量がより優れているデータ センターの Node が指定されたストレージ アカウントに割り当てられます。これにより、ワークロードがより効率的にデータにアクセスできるようになります。

### <a name="job"></a>ジョブ

ジョブはタスクのコレクションです。ジョブは、プール内の計算ノードの実行方法を指定します。

- ジョブによって、作業が実行されるプールを指定します。多くのジョブで使用されている作成済みのプールを指定できますが、ジョブ スケジュールに関連付けられているジョブごとに、またはジョブ スケジュールに関連付けられているすべてのジョブに対して、プールを作成することもできます。
- 必要に応じて、優先度を指定することができます。まだ実行中のジョブよりも優先度が高いジョブが送信されると、優先度の高いジョブのタスクが、優先度の低いジョブのタスクよりも先にキューに挿入されます。既に実行されている優先度の低いタスクは後回しになります。
- 制約
	- ジョブの最大実行時間を設定できます。指定された最大実行時間よりも長くジョブが実行されると、ジョブおよびジョブに関連付けられているすべてのタスクが終了されます。
	- Azure Batch は失敗したタスクを検出して、再試行することができます。既定のタスク再試行の最大回数を制約として指定できます。タスクを常に再試行するように指定したり、再試行を禁止したりすることもできます。タスクを再試行すると、タスクがもう一度キューに置かれて実行されます。
- そのジョブに対して実行されるタスクはクライアントによってジョブに追加できますが、ジョブ マネージャーのタスクは別に指定できます。ジョブ マネージャー タスクは Batch API を使用します。このタスクには、プールのいずれかのノードで実行中のタスクを含むジョブに必要なタスクを作成するためのコードが含まれます。ジョブ マネージャー タスクは Batch によってのみ処理されます。ジョブ マネージャー タスクはジョブが作成されるとすぐにキューに配置され、何らかの理由で失敗すると、再開されます。ジョブ スケジュールによって作成されたジョブに関しては、ジョブ マネージャーが必須です。ジョブがインスタンス化される前にタスクを定義する手段は、ジョブ マネージャーのみであるためです。


### <a name="task"></a>タスク

タスクは、Node 上で実行される、ジョブに関連付けられた計算の単位です。タスクは、ノードに割り当てられて実行されるか、ノードが解放されるまでキューに格納されます。タスクは、次のリソースを使用します。

- 作業項目で指定されたプログラム。

- 処理するデータを含むリソース ファイル。これらのファイルは BLOB ストレージから Node に自動的にコピーされます。詳細については、「ファイルとディレクトリ」を参照してください。

- プログラムで必要とされる環境設定。詳細については、「タスクの環境設定」を参照してください。

- 計算に適用される制約。たとえば、タスクの実行が許可される最大時間、タスクの実行が失敗した場合に再試行する最大回数、作業ディレクトリにファイルを保持する最大時間などです。

Node で計算を実行するために定義できるタスクに加えて、Batch サービスによって提供される次の特殊なタスクを使用できます。

- [開始タスク](#starttask)

- [ジョブ マネージャー タスク](#jobmanagertask)

#### <a name="starttask"></a>開始タスク

開始タスクをプールに関連付けることで、プール内のノードのオペレーティング システムを構成できます。開始タスクで実行できる操作の例として、ソフトウェアのインストールやバックグラウンド プロセスの起動があります。開始タスクは、プール内に保持されている限り、ノードが起動されるたびに実行されます。

Batch タスクと同様に、Batch によって実行されるコマンド ラインの追加として Azure ストレージのファイル一覧を指定できます。Azure Batch では、最初に Azure Storage のファイルをコピーした後で、コマンド ラインを実行します。プール開始タスクの場合、通常はこのファイル一覧にアプリケーション ファイルまたはパッケージが含まれますが、プール ノードで実行されているすべてのタスクで使用される参照データが含まれている場合もあります。コマンド ラインでは任意の PowerShell スクリプトを実行できます。たとえば、robocopy を実行してアプリケーション ファイルを "共有" フォルダーにコピーできます。さらに、MSI を実行することもできます。

一般的には、Batch が開始タスクの完了まで待機し、タスクを割り当てられる状態になっているノードを検討することが望ましいですが、これは構成可能です。

プール ノードに対する開始タスクが失敗した場合、そのノードの状態が更新されてエラーが反映され、そのノードは割り当てタスクに使用できなくなります。開始タスクに指定されたファイルのコピー中にエラーが発生した場合や、開始タスク プロセスで 0 以外が返された場合、開始タスクが失敗することがあります。

ノードの構成とアプリケーションのインストールに必要なすべての情報が宣言されているということは、プール内のノード数を増やすには新たに必要な数を指定するだけでよいことを意味します。Batch には、タスクに対応できるようにノードを構成するために必要な情報がすべて揃っています。

開始タスクを定義するには、Add Pool 操作の要求本文に JSON セクションを追加します。次の例は、開始タスクの基本的な定義を示しています。

	{
		“commandLine”:”mypoolsetup.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”mypoolsetup.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“maxTaskRetryCount”:0
	}

C# インターフェイスは次のようになります。

	CloudPool pool = pm.CreatePool(poolId, targetDedicated: 3, virtualMachineSize: "small", osFamily: "3");
	pool.StartTask = new StartTask();
	pool.StartTask.CommandLine = "mypoolsetup.exe";
	pool.StartTask.ResourceFiles = new List<IResourceFile>();
	pool.StartTask.ResourceFiles.Add(new ResourceFile("http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d", "mypoolsetup.exe"));
	pool.Commit();


#### <a name="jobmanagertask"></a>ジョブ マネージャー タスク

ジョブ マネージャー タスクは、他のすべてのタスクの前に開始されます。ジョブ マネージャー タスクには、次の利点があります。

- ジョブの作成時に Batch サービスによって自動的に作成されます。

- ジョブ内の他のタスクの前にスケジュールされます。

- ジョブ マネージャー タスクに関連付けられた Node は、プールが縮小されるときに最後にプールから削除されます。

- 再起動する必要がある場合に最も高い優先順位が割り当てられます。アイドル状態の Node を使用できない場合、Batch サービスは、この Node が実行する余地を確保するためにプール内のいずれかの実行中のタスクを終了する場合があります。

- ジョブ マネージャー タスクの終了を、ジョブ内のすべてのタスクの終了に関連付けることができます。

ジョブ内のジョブ マネージャー タスクは、他のジョブ内のタスクよりも優先されません。ジョブ間では、ジョブ レベルの優先順位のみが適用されます。ジョブ マネージャー タスクは、作業項目の追加操作の要求本文に XML セクションを追加することによって定義します。次の例は、ジョブ マネージャー タスクの基本的な定義を示しています。

	{
		“name”:”jmTask”,
		“commandLine”:”myapp1.exe”,
		“resourceFiles”:
		[
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp1.exe”
			},
			{
				“blobSource”:”http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d”,
				“filePath”:”myapp2.exe”
			}
		],
		“taskConstraints”:
		{
			“maxWallClockTime”:”PT1H”,
			“maxTaskRetryCount”:0,
			“retentionTime”:”PT1H”
		},
		“killJobOnCompletion”:true,
		“runElevated”:false,
		“runExclusive”:true
	}


### <a name="jobschedule"></a>ジョブ スケジュール

ジョブ スケジュールはスケジュールに複数のジョブを作成する手段です。ジョブ スケジュールが作成される際、スケジュールの各オカレンスに対して 1 つのジョブが作成されます。

## <a name="workflow"></a>Batch サービスのワークフロー

Batch サービスを使用するには、Batch アカウントが必要です。計算をスケジュールするには、サービスの複数のリソースを使用します。Batch サービスによる分散計算シナリオを作成する場合は、次の基本的なワークフローを使います。

1\. Azure ストレージ アカウントに分散計算シナリオで使用するファイルをアップロードします。これらのファイルは、Batch サービスがアクセスできるように、ストレージ アカウントに配置する必要があります。これらのファイルは、Batch サービスによってタスクの実行時に Node に読み込まれます。

2\. 依存バイナリ ファイルをストレージ アカウントにアップロードします。バイナリ ファイルとは、タスクによって実行されるプログラムと依存アセンブリを表します。これらのファイルはストレージからもアクセスできる必要があります。これらのファイルは、Node に読み込まれます。

3\. Node のプールを作成します。プールの作成時に、使用するタスク仮想マシンのサイズを割り当てることができます。タスクを実行すると、このプールから Node が割り当てられます。

4\. 作業項目を作成します。作業項目を作成すると、ジョブが自動的に作成されます。作業項目を使って、タスクのジョブを管理できます。

5\. 作業項目にタスクを追加します。各タスクは、アップロードされたプログラムを使用して、アップロードされたファイルの情報を処理します。

6\. 出力の結果を監視します。

## <a name="files"></a>ファイルとディレクトリ

各タスクは作業ディレクトリを持ちます。この作業ディレクトリ内に、タスクによって実行されるプログラム、タスクによって処理されるデータ、およびタスクによって実行された処理の出力を格納するためのディレクトリおよびファイルが 0 個以上作成されます。これらのディレクトリとファイルは、ジョブの実行中に他のタスクから使用できます。Node 上のすべてのタスク、ファイル、およびディレクトリは、単一のユーザー アカウントによって所有されます。

Batch サービスは、Node 上のファイル システムの一部をルート ディレクトリとして公開します。Node のルート ディレクトリは、WATASK\_TVM\_ROOT\_DIR 環境変数を介してタスクで利用できます。環境変数の使用に関する詳細については、「タスクの環境設定」を参照してください。

ルート ディレクトリには、次のサブディレクトリが含まれます。

- **タスク** - Node 上で実行されるタスクに属しているすべてのファイルが格納されます。Batch サービスにより、それぞれのタスクに対して、%AZ\_BATCH\_TASK\_ROOT\_DIR% 形式の一意のパスを持つ作業ディレクトリが作成されます。このディレクトリでは、タスクへの読み取り/書き込みアクセスが可能です。タスクは、このディレクトリの下で、ファイルを作成、読み取り、更新、および削除できます。このディレクトリは、タスクに対して指定された RetentionTime 制約に基づいて保持されます。

- **共有** - アカウントのすべてのタスクの共有ディレクトリです。Node の共有ディレクトリは %az\_batch\_node\_shared\_dir% にあります。このディレクトリでは、タスクへの読み取り/書き込みアクセスが可能です。タスクは、このディレクトリの下で、ファイルを作成、読み取り、更新、および削除できます。

- **開始** - この場所は、開始タスクによって作業ディレクトリとして使用されます。開始タスクを起動するために Batch サービスによってダウンロードされるファイルもすべてこのディレクトリに格納されます。Node のスタート ディレクトリは %AZ\_BATCH\_NODE\_START\_DIR% にあります。タスクは、このディレクトリの下で、ファイルを作成、読み取り、更新、および削除できます。開始タスクは、このディレクトリを使用して、オペレーティング システムを構成できます。

Node をプールから削除すると、Node に格納されているすべてのファイルが削除されます。

## <a name="lifetime"></a>プールとノードの有効期間

設計に関する基本事項として、プールの作成時期と、ノードが使用可能な期間を決定します。

極端な例として、ジョブが送信されたときに各ジョブに対してプールを作成し、タスクの実行が完了したときにノードを削除することもできます。この場合、ノードが絶対に必要なときにのみノードを割り当て、ノードがアイドル状態になるとすぐにシャットダウンするため、使用率が最大になります。ジョブはノードが割り当てられるまで待機する必要がありますが、タスクが個別に使用可能になって割り当てられ、開始タスクが完了するとすぐに、タスクがノードに対してスケジュール設定されることに注意してください。つまり、プール内のすべてのノードが使用可能になるまで Batch が待機することはありません。そうした場合、使用率が低下するためです。

ジョブをすぐに実行開始することが重要である場合は、ジョブが送信される前にプールを作成して、ノードを使用可能にしておく必要があります。タスクはすぐに開始できますが、負荷によっては、ノードがアイドル状態でジョブのタスクを待ち受ける場合があります。

継続的な負荷の量が変動する場合、一般的には複数のジョブが送信されるプールを用意し、負荷に応じてノード数を増減するようにします。このとき、状況に応じて対応することも、負荷が予測できる場合には予防的に対処することもできます。

## <a name="scaling"></a>アプリケーションのスケーリング

アプリケーションのスケールを簡単かつ自動的に拡大または縮小して、必要な計算ニーズに対応できます。現在のワークロードとリソース使用状況統計に従って、プール内の Node の数を動的に調整できます。また、自動的にスケーリングを行うように構成することにより、アプリケーションの全体的な実行コストを最適化することもできます。プールの作成時にスケーリング設定を指定できます。また、いつでも構成を更新することができます。

ノード数が減少している場合、考慮が必要なタスクがノードで実行されている可能性があります。割り当て解除ポリシーを指定することで、実行中のタスクを停止してノードをすぐに削除するかどうか、ノードが削除される前にタスクが完了することを許可するかどうかを決定します。ジョブ完了時のノードの目標個数を 0 に設定し、実行中のタスクの完了を許可した場合に、使用率が最大になります。

アプリケーションの自動スケーリングを指定するには、一式のスケーリング式を使用します。式を使用して、次のスケーリング間隔のプールに含まれる Node の数を決定できます。たとえば、プールでのスケジュール対象として大量のタスクを送信する必要があるとします。この場合、現在の保留中のタスクの数とタスクの完了率に基づいてプールのサイズを指定するスケーリング式をプールに割り当てることができます。Batch サービスは、定期的に式を評価し、ワークロードに基づいてプールのサイズを変更します。

式には次のメトリックを使用できます。

- **時間メトリック** - 指定した時間数内で 5 分おきに収集された統計情報に基づきます。

- **リソース メトリック** - CPU 使用量、帯域幅使用量、メモリ使用量、および Node の数に基づきます。

- **タスク メトリック** - タスクの状態 (保留中、アクティブ、完了) に基づきます。

アプリケーションの自動スケーリングの詳細については、タスク仮想マシンの自動スケールの構成に関するトピックを参照してください。

>ノードを削除します。
>
>ノードの削除が必要になることはあまりありませんが、ノードを個別に指定してプールから削除することができます。たとえば、ノードの信頼性に疑いがある場合などに削除することが考えられます。

## <a name="cert"></a>アプリケーションの証明書

通常、機密情報を暗号化するときは証明書を使用する必要があります。証明書は Node にインストールすることができます。暗号化された機密情報は、コマンドライン パラメーターでタスクに渡されるか、またはリソースの 1 つに埋め込まれ、インストールされた証明書を使用して復号化できます。機密情報の一例としてストレージ アカウントのキーがあります。

Batch アカウントに証明書を追加するには、証明書の追加操作を使用します。次に、新規または既存のプールに証明書を関連付けることができます。証明書がプールに関連付けられると、Batch サービスは、プール内の各 Node に証明書をインストールします。Batch サービスは、Node の起動時に、いずれかのタスク (開始タスク、ジョブ マネージャー タスクも含まれます) を起動する前に、適切な証明書をインストールします。

## <a name="scheduling"></a>スケジューリング優先順位

作業項目を作成するときに優先順位を割り当てることができます。作業項目の下の各ジョブは、この優先順位で作成されます。Batch サービスは、ジョブの優先順位値を使用して、アカウント内のジョブ スケジューリングの順序を決定します。優先順位として、-1000 ～ 1000 の値を使用します。-1000 は最も低い優先順位を示し、1000 は最も高い優先順位を示します。ジョブの優先順位を更新するには、ジョブの更新操作を使用します。

同じアカウント内で、優先順位の高いジョブは優先順位の低いジョブよりも優先的にスケジュールされます。あるアカウントの優先順位値が高いジョブが、異なるアカウントの優先順位値が低い別のジョブよりも優先的にスケジュールされることはありません。

異なるプールのジョブ スケジューリングは独立しています。異なるプール間では、関連するそのプールでアイドル状態の Node が不足している場合、優先順位の高い方のジョブが最初にスケジュールされるとは限りません。同じプール内のジョブの場合、優先順位が同じであれば、スケジュールされる可能性は等しくなります。

## <a name="environment"></a>タスクの環境設定

タスクのコンテキストで使用可能な環境設定を指定できます。開始タスクおよびジョブで実行されるタスクの環境設定は、タスクの追加操作またはタスクの更新操作の要求本文に XML セクションを追加することによって定義します。

次の例は、環境設定の定義を示しています。

ジョブでスケジュールされるすべてのタスクに対し、特定の環境変数のセットが Batch サービスによって設定されます。次の表に、すべてのタスクに対して Batch サービスによって設定される環境変数を示します。

| 環境変数の名前 | 説明 |
|------------------------------------|--------------------------------------------------------------------------|
| AZ\_BATCH\_ACCOUNT\_NAME | タスクが所属するアカウントの名前。 |
| AZ\_BATCH\_JOB\_ID | タスクが所属するジョブの名前。 |
| AZ\_BATCH\_TASK\_ID | 現在のタスクの名前。 |
| AZ\_BATCH\_POOL\_ID | タスクが実行されているプールの名前。 |
| AZ\_BATCH\_NODE\_ID | タスクが実行されている Node の名前。 |
| AZ\_BATCH\_NODE\_ROOT\_DIR | ノード上のルート ディレクトリの完全パス。 |
| AZ\_BATCH\_NODE\_SHARED\_DIR | ノード上の共有ディレクトリの完全パス。 |
| AZ\_BATCH\_NODE\_STARTUP\_DIR | ノード上のプール ノードのスタートアップ タスク ディレクトリの完全パス。 |
| AZ\_BATCH\_NODE\_TASK\_DIR | ノード上のタスク ディレクトリの完全パス。 |
| AZ\_BATCH\_NODE\_TASK\_WORKING\_DIR | ノード上のタスク作業ディレクトリの完全パス。 |
| AZ\_BATCH\_NODE\_JOB\_PREP\_DIR | ノード上のジョブ準備タスク ディレクトリの完全パス。 |
| AZ\_BATCH\_NODE\_JOB\_PREP\_WORKING\_DIR | ノード上のジョブ準備タスク作業ディレクトリの完全パス。 |

**注**

これらのシステム定義の変数を上書きすることはできません。

環境設定の値を取得するには、タスクの取得操作を使用します。

## <a name="errorhandling"></a>エラー処理

###タスクのエラー処理
タスク エラーは、次のカテゴリに分類されます。

- スケジュール エラー:
	- タスクにファイルが指定されている場合、1 つ以上のファイルをコピーすると失敗することがあります。原因としては、ファイルが移動されている、ストレージ アカウントが使用できなくなっているなどが考えられます。
	- このような場合、タスクに "スケジュール エラー" が設定されます。
- アプリケーション エラー:
	- コマンド ラインで指定されたタスクの処理も失敗することがあります。0 以外の終了コードが返された場合、処理が失敗したと見なされます。
	- アプリケーション エラーについては、指定された回数まで自動的にタスクを再試行するように Batch を構成することができます。 
- 制約エラー:
	- ジョブまたはタスクの最大実行時間に制約を指定できます。これは、応答を停止したタスクを終了させるために役立ちます。
	- 最大実行時間を超過したタスクは完了としてマークされますが、終了コードは `0xC000013A` とマークされ、schedulingError フィールドに `{ category:“ServerError”, code=“TaskEnded”}` とマークされます。

###アプリケーション エラーのデバッグ

アプリケーションによって診断情報が生成される場合があり、それを利用して問題をトラブルシューティングできます。多くのアプリケーションは stdout ファイルと stderr ファイルに情報を書き込みます。カスタム ファイルに情報を出力する場合もあります。このような場合は、タスクまたはノードを指定することで、ファイルを取得する API が提供されます。

プール ノードにログインすることもできます。API はノードの RDP ファイルを返すため、これを使ってノードにログインすることができます。

###タスクのエラーおよび問題への対応

いくつかの理由で、タスクが失敗したり、中断したりする場合があります。タスク アプリケーション自体でエラーが発生したり、タスクが実行されているノードが再起動したりする場合があります。また、タスクの完了を待たずに直ちにノードを削除する割り当て解除ポリシーが設定されているときに、プールのサイズ変更によってノードが削除される場合もあります。どのようなケースでも、Batch によってタスクを自動的をキューに戻し、別のノードで実行することができます。

断続的に発生する問題によって、タスクが応答を停止したり、実行に長い時間がかかるようになる場合もあります。タスクに最大実行時間を設定すると、その時間を超過したときにタスク アプリケーションを中断できます。現時点では、この場合はタスクをキューに戻すことはできませんが、クライアントでこの状況を検出して新しいタスクを送信することができます。

###問題のある Node への対応

プール内のノードにはそれぞれ一意の名前があり、タスクが実行されるノードにタスクのメタデータが含まれています。何らかの原因でタスク エラーを発生させたノードが存在する場合、クライアントからそれを特定し、問題があると思われるノードをプールから削除することができます。削除されたノードでタスクが実行されていた場合、そのタスクは自動的にキューに戻され、別のノードで実行されます。


<!--Image references-->
[1]: ./media/batch-api-basics/batch-api-basics-01.png

[Azure Batch の概要]: batch-technical-overview.md

<!---HONumber=August15_HO6-->