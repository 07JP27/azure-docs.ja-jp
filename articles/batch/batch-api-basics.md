<properties
	pageTitle="Azure Batch 機能の概要 | Microsoft Azure"
	description="開発の観点から、Batch サービスとその API の機能について説明します。"
	services="batch"
	documentationCenter=".net"
	authors="yidingzhou"
	manager="timlt"
	editor=""/>

<tags
	ms.service="batch"
	ms.devlang="multiple"
	ms.topic="get-started-article"
	ms.tgt_pltfrm="na"
	ms.workload="big-compute"
	ms.date="01/21/2016"
	ms.author="yidingz;v-marsma"/>

# Azure Batch 機能の概要

この記事では、Azure Batch サービスのコア API 機能の基本的な概要について説明します。分散コンピューティング ソリューションの開発に [Batch REST][batch_rest_api] と [Batch .NET][batch_net_api] API のどちらを利用する場合でも、以下で説明されるエンティティと機能の多くを使用することになります。

> [AZURE.TIP] Batch の技術的な概要については、「[Azure Batch の基礎](batch-technical-overview.md)」を参照してください。

## <a name="workflow"></a>Batch サービスのワークフロー

次の高レベルのワークフローは、Batch サービス内で開発されるほぼすべての分散コンピューティング シナリオで使用される、典型的なものです。

1. [Azure Storage][azure_storage] アカウントに分散コンピューティング シナリオで使用する*データ ファイル*をアップロードします。これらのファイルは、Batch サービスがアクセスできるように、ストレージ アカウントに配置する必要があります。タスクは、実行されたときに、これらのファイルを[コンピューティング ノード](#computenode)にダウンロードします。

2. 依存*バイナリ ファイル*をストレージ アカウントにアップロードします。これらのバイナリ ファイルには、タスクによって実行されるプログラムとその依存アセンブリが含まれています。これらのファイルにもストレージ アカウントからアクセスできる必要があるため、タスクがコンピューティング ノードにダウンロードできます。

3. コンピューティング ノードの[プール](#pool)を作成します。プールの作成時に、使用する[コンピューティング ノードのサイズ][cloud_service_sizes]を指定すると、タスクの実行時に、このプール内のノードにそのサイズが割り当てられます。

4. [ジョブ](#job)を作成します。ジョブを使用すると、コレクション タスクを管理することができます。

5. ジョブに[タスク](#task)を追加します。各タスクは、アップロードされたプログラムを使用して、ストレージ アカウントにアップロードされたデータ ファイルの情報を処理します。

6. ジョブの進行状況を監視し、結果を取得します。

> [AZURE.NOTE] Batch サービスを使用するには [Batch アカウント](batch-account-create-portal.md)が必要であり、ほぼすべてのソリューションはファイルの保存と取得に [Azure Storage][azure_storage] アカウントを使用します。

以下のセクションでは、上記のワークフローで言及されている各リソースと、分散コンピューティング シナリオを可能にする Batch のその他の多くの機能について説明します。

## <a name="resource"></a> Batch サービスのリソース

Azure Batch サービスを使用する際は、以下のリソースを利用します。

- [アカウント](#account)

- [コンピューティング ノード](#computenode)

- [プール](#pool)

- [ジョブ](#job)

- [タスク](#task)

	- [開始タスク](#starttask)

	- [ジョブ マネージャー タスク](#jobmanagertask)

	- [ジョブ準備タスクおよびジョブ解放タスク](#jobpreprelease)

	- [マルチインスタンス タスク](#multiinstance)

- [ジョブ スケジュール](#jobschedule)

### <a name="account"></a>アカウント

Batch アカウントは、Batch サービス内で一意に識別されるエンティティです。すべての処理は、Batch アカウントに関連付けられています。Batch サービスで処理を実行するには、アカウント名とアカウント キーが必要です。Batch アカウントを作成する方法については、「[Azure ポータルでの Azure Batch アカウントの作成と管理](batch-account-create-portal.md)」を参照してください。

### <a name="computenode"></a>コンピューティング ノード

コンピューティング ノードは、アプリケーションの特定のワークロード専用の Azure 仮想マシンです。ノードのサイズによって、CPU コアの数、メモリ容量、およびノードに割り当てられるローカル ファイル システムのサイズが決まります。ノードは、A0 以外の任意の[クラウド サービス ノード サイズ][cloud_service_sizes]にすることができます。

ノードは、実行可能ファイルとスクリプトを実行できます。たとえば、実行可能ファイル (.exe)、コマンド (.cmd) ファイル、バッチ (.bat) ファイル、PowerShell スクリプトなどです。また、ノードには以下の属性もあります。

- 標準**フォルダー構造**と、それに関連付けられている、パスを示す**環境変数**が、各コンピューティング ノードに作成されます。詳細については、後の「[ファイルとディレクトリ](#files)」を参照してください。
- タスクから参照できる**環境変数**。
- アクセスを制御するために構成される**ファイアウォール**設定。
- デバッグなどの目的でコンピューティング ノードへの**リモート アクセス**が必要な場合、RDP ファイルを取得し、それを使用して*リモート デスクトップ*経由でノードにアクセスすることができます。

### <a name="pool"></a>プール

プールは、アプリケーションが実行されるノードのコレクションです。プールはお客様が手動で作成できるほか、実行する操作を指定した場合は Batch サービスによって自動的に作成されます。アプリケーションのニーズを満たすプールを作成して管理することができ、プールを作成した Batch アカウントだけが、そのプールを使用できます。1 つの Batch アカウントで複数のプールを持つことができます。

Azure Batch プールは、コア Azure コンピューティング プラットフォームの上に構築されています。Batch プールによって、大規模な割り当て、アプリケーションのインストール、データの分散、状態の監視や、プール内のコンピューティング ノード数の柔軟な調整 (スケーリング) が可能になります。

プールに追加されたすべてのノードに対し、一意の名前と IP アドレスが割り当てられます。ノードがプールから削除されると、オペレーティング システムまたはファイルに加えられた変更は失われ、将来使用できるように名前と IP アドレスが解放されます。ノードをプールから削除すると、その有効期間が終了します。

プール内のノード間の通信を許可するようにプールを構成できます。プールに対してプール内通信が要求された場合、Batch サービスは、プール内の各ノードで 1100 より大きい番号のポートを有効にします。プール内の各ノードは、このポート範囲への着信接続およびプール内の他のノードからの着信接続のみを許可するように構成されます。アプリケーションがノード間の通信を必要としない場合、Batch サービスは多くの別のクラスターおよびデータ センターのプールに大量のノードを割り当てることにより、並列処理能力を向上させることができます。

プールを作成するときに次の属性を指定できます。

- プール内の**ノードのサイズ**
	- ノードで実行する予定のアプリケーションの特性と要件を考慮して、適切なノードのサイズを選ぶ必要があります。ノードのサイズは、通常、ノードで複数のタスクが同時に実行されることはないという想定で選択されます。最も適切でコスト効率の高いノード サイズを決定するには、アプリケーションがマルチ スレッドかどうかや、どのくらいのメモリが消費されるかといった点を考慮してください。複数のタスクを割り当てて、複数のアプリケーション インスタンスを並列して実行することができます。その場合は、通常、より大きいノードが選ばれます。詳細については、後の「タスク スケジュール ポリシー」を参照してください。
	- プール内のすべてのノードが同じサイズである必要があります。システム要件や負荷レベルが異なる複数のアプリケーションを実行する場合は、個別にプールを作成してください。
	- プールには、A0 を除くすべての[クラウド サービス ノード サイズ][cloud_service_sizes]を構成することができます。

- ノード上で実行する**オペレーティング システム ファミリ**および**バージョン**。
	- Cloud Services 内の worker ロールと同様に、*OS ファミリ*と *OS バージョン*を指定できます (worker ロールの詳細については、「*Azure が提供するコンピューティング ホスティング オプション*」の「[Cloud Services の概要][about_cloud_services]」セクションを参照してください)。
	- OS ファミリによって、OS と同時にインストールされる .NET のバージョンも決まります。
	- worker ロールの場合と同様に、OS バージョンには "`*`" を指定することをお勧めします。これにより、ノードは自動的にアップグレードされ、新たにリリースされたバージョンに対応するための作業が不要になります。特定の OS バージョンを選択するのは、主にアプリケーションの互換性を維持する必要がある場合です。こうすることで、バージョンの更新を許可する前に旧バージョンとの互換性をテストできます。検証が終わると、プールの OS バージョンを更新して、新しい OS イメージをインストールできます。その際、実行中のタスクはすべて中断され、再びキューに置かれます。

- プールで使用できるようにする**ノードの数**

- プールの**スケーリング ポリシー**
	- ノード数だけでなく、プールに[自動スケールの数式](batch-automatic-scaling.md)を指定することもできます。Batch サービスは式を実行し、指定されたさまざまなプール、ジョブ、およびタスク パラメーターに基づいて、プール内のノード数を調整します。

- **タスク スケジュール** ポリシー
	- [ノードあたりの最大タスク数](batch-parallel-node-tasks.md)の構成オプションによって、プール内の各ノードで並列実行できるタスク数の上限が決まります。
	- 既定の構成では、コンピューティング ノードで 1 つのタスクだけを実行しますが、ノード上で複数のタスクを同時に実行できる方がメリットがあるシナリオもあります。たとえば、アプリケーションが I/O を待機しなければならないときに、ノードの使用率を向上させる場合です。複数のアプリケーションを同時に実行すると、CPU の使用率が増加します。もう 1 つの例は、プール内のノード数を減らす場合です。そうすることで、大規模な参照データ セットに必要なデータ転送の量を減らすことができます。アプリケーションには A1 ノード サイズで十分な場合、代わりに A4 ノード サイズを選択し、プールを 8 個の並列タスク用に構成できます (各タスクが 1 つのコアを使用)。
	- "フィルの種類" を指定することもできます。それによって、Batch がタスクをすべてのノードに均等に配分するか、1 つのノードに最大数のタスクを割り当ててからプール内の次のノードにタスクを割り当てていくかが決まります。

- プール内のノードの**通信状態**
	- プールは、プール内のノード間の通信を許可するように構成できます。それによって、基になるネットワーク インフラストラクチャが決まります。クラスター内のノードの配置にも影響することに注意してください。
	- ほとんどのシナリオでは、タスクは独立して動作し、相互に通信する必要はありませんが、一部のアプリケーションではタスクの通信が必要である場合があります。

- プール内のノードの**開始タスク**
	- *開始タスク*を指定することができます。このタスクは、コンピューティング ノードがプールに参加するたびに実行され、ノードの再開時にも実行されます。このタスクは、多くの場合、ノード上で実行されるタスクによって使用されるアプリケーションをインストールするために使用されます。

### <a name="job"></a>ジョブ

ジョブはタスクのコレクションであり、プール内のコンピューティング ノードでの計算の実行方法を指定します。

- ジョブによって、作業が実行される**プール**を指定します。プールには、さまざまなジョブで使用するためにこれまでに作成した既存のプールを指定できます。また、ジョブ スケジュールに関連付けられている各ジョブ用、またはジョブ スケジュールに関連付けられているすべてのジョブ用に、オンデマンドで作成することもできます。
- 必要に応じて、**ジョブ優先度**を指定することができます。現在実行中のジョブよりも優先度が高いジョブが送信されると、優先度の高いジョブのタスクが、優先度の低いジョブのタスクよりも先にキューに挿入されます。既に実行されている優先度の低いタスクは後回しになります。
- ジョブ**制約**は、ジョブの特定の制限を指定します。
	- ジョブの**最大実行時間**を設定できます。指定された最大実行時間よりも長くジョブが実行されると、ジョブおよびジョブに関連付けられているすべてのタスクが終了されます。
	- Azure Batch は失敗したタスクを検出して、再試行することができます。**タスク再試行の最大回数**を制約として指定できます。タスクを常に再試行するように指定したり、再試行を禁止したりすることもできます。タスクの再試行とは、タスクをもう一度実行するためにキューに置くことです。
- タスクは、クライアント アプリケーションでジョブに追加できます。または、[ジョブ マネージャー タスク](#jobmanagertask)を指定できます。ジョブ マネージャー タスクは、Batch API を使用します。このタスクには、ジョブに必要なタスクを作成するための情報と、プール内のいずれかのコンピューティング ノードで実行されているタスクが含まれます。ジョブ マネージャー タスクは Batch によってのみ処理されます。ジョブが作成されるとすぐにキューに配置され、失敗すると再開されます。ジョブ スケジュールによって作成されたジョブには、ジョブ マネージャー タスクが必要です。ジョブ マネージャー タスク以外では、ジョブがインスタンス化される前にタスクを定義できないためです。ジョブ マネージャー タスクの詳細については、以下で説明します。


### <a name="task"></a>タスク

タスクは、ジョブに関連付けられ、ノード上で実行される、計算の単位です。タスクはノードに割り当てられて実行されるか、ノードが解放されるまでキューに格納されます。タスクは、次のリソースを使用します。

- タスクの**コマンド ライン**で指定されたアプリケーション。

- 処理するデータを含む**リソース ファイル**。これらのファイルは、Azure ストレージ アカウントの Blob Storage からノードに自動的にコピーされます。詳細については、後の「[ファイルとディレクトリ](#files)」を参照してください。

- アプリケーションで必要な**環境変数**。詳細については、後の「[タスクの環境設定](#environment)」を参照してください。

- 計算に適用される**制約**。たとえば、タスクの実行が許可される最大時間、タスクが失敗した場合に再試行する最大回数、作業ディレクトリにファイルを保持する最大時間などです。

ノードで計算を実行するために定義するタスクに加えて、Batch サービスによって次のような特殊なタスクも用意されています。

- [開始タスク](#starttask)
- [ジョブ マネージャー タスク](#jobmanagertask)
- [ジョブ準備タスクおよびジョブ解放タスク](#jobmanagertask)
- [マルチインスタンス タスク](#multiinstance)

#### <a name="starttask"></a>開始タスク

**開始タスク**をプールに関連付けることによって、ソフトウェアのインストールやバックグラウンド プロセスの開始などのアクションを行い、ノードの操作環境を構成することができます。開始タスクは、プール内に保持されている限り、ノードが起動されるたびに実行されます。ノードが最初にプールに追加されるときにも実行されます。開始タスクの主な利点は、ジョブ タスクの実行に必要なコンピューティング ノードの構成とアプリケーションのインストールを行うためのすべての情報が含まれていることです。そのため、プール内のノード数を増やすには、新しいターゲット ノードの数を指定するだけで済みます。新しいノードの構成と、タスクを受け付けるための準備に必要なすべての情報は、Batch が既に持っています。

Batch タスクと同様に、実行する**コマンド ライン**の他に、[Azure Storage][azure_storage] 内の**リソース ファイル**の一覧を指定できます。Azure Batch では、最初に Azure Storage のファイルをコピーしてから、コマンド ラインを実行します。プール開始タスクの場合、通常はこのファイル一覧にアプリケーション パッケージまたはファイルが含まれますが、コンピューティング ノードで実行されているすべてのタスクで使用される参照データが含まれている場合もあります。開始タスクのコマンド ラインは、PowerShell スクリプトを実行したり、`robocopy` 操作を行う場合があります。たとえば、アプリケーション ファイルを "共有" フォルダーにコピーしてから、MSI または `setup.exe` を実行します。

一般的には、Batch サービスが開始タスクの完了まで待機してから、タスクを割り当てられる状態になっているノードを判断することが望ましいですが、これは構成可能です。

コンピューティング ノードで開始タスクが失敗した場合、そのノードの状態が更新されてエラーが反映され、そのノードは割り当てタスクに使用できなくなります。ストレージからのリソース ファイルのコピーに問題があったり、コマンド ラインで実行されたプロセスからゼロ以外の終了コードが返されたりした場合に、開始タスクは失敗することがあります。

#### <a name="jobmanagertask"></a>ジョブ マネージャー タスク

**ジョブ マネージャー タスク**は、通常、ジョブの制御や監視に使用されます。たとえば、ジョブのタスクの作成と送信、実行する追加タスクの決定、いつ作業が完了するかの判断などを行います。ジョブ マネージャー タスクは、このようなアクティビティだけに限定されません。ただし、ジョブに必要なアクションを実行できる、完全な独立したタスクである必要があります。たとえば、ジョブ マネージャー タスクは、パラメーターとして指定されたファイルをダウンロードし、ファイルの内容を分析して、その内容に基づいて追加のタスクを送信します。

ジョブ マネージャー タスクは、他のすべてのタスクより先に起動され、次のような機能を提供します。

- ジョブの作成時に Batch サービスによって自動的にタスクとして送信されます。

- ジョブ内の他のタスクより先に実行されるようにスケジュールされます。

- ジョブ マネージャー タスクに関連付けられたノードは、プールが縮小される際、プールから最後に削除されます。

- ジョブ マネージャー タスクの終了を、ジョブ内のすべてのタスクの終了に関連付けることができます。

- ジョブ マネージャー タスクを再起動する必要がある場合は、最も高い優先順位が割り当てられます。アイドル状態のノードを使用できない場合、Batch サービスはジョブ マネージャー タスクを実行する余地を確保するために、プール内のいずれかの実行中のタスクを終了する場合があります。

- あるジョブ内のジョブ マネージャー タスクに、他のジョブのタスクに対して高い優先順位が割り当てられることはありません。ジョブ間では、ジョブ レベルの優先順位のみが適用されます。

#### <a name="jobpreprelease"></a>ジョブ準備タスクおよびジョブ解放タスク

Batch には、ジョブ前にセットアップを実行するためのジョブ準備タスクと、ジョブ後のメンテナンスまたはクリーンアップのためのジョブ解放タスクが用意されています。

- **ジョブ準備タスク** - ジョブ準備タスクは、タスクの実行がスケジュールされているすべてのコンピューティング ノードで、他のジョブ タスクが実行される前に実行されます。たとえば、ジョブごとに異なるものの、すべてのタスクによって共有されるデータをコピーするために、ジョブ準備タスクを使用します。
- **ジョブ解放タスク** - ジョブが完了すると、少なくとも 1 つのタスクを実行したプールの各ノードでジョブ解放タスクが実行されます。たとえば、ジョブ準備タスクによってコピーされたデータを削除したり、診断ログ データを圧縮してアップロードしたりするために、ジョブ解放タスクを使用します。

ジョブ準備タスクおよびジョブ解放タスクのどちらでも、タスクをいつ呼び出すかをコマンド ラインで指定し、ファイルのダウンロード、管理者特権での実行、カスタム環境変数、最大実行期間、再試行回数、ファイル保持時間などの機能を提供できます。

ジョブ準備タスクとジョブ解放タスクの詳細については、「[Azure Batch コンピューティング ノードでのジョブ準備タスクとジョブ完了タスクの実行](batch-job-prep-release.md)」を参照してください。

#### <a name="multiinstance"></a>マルチインスタンス タスク

[マルチインスタンス タスク][rest_multiinstance]は、複数のコンピューティング ノードで同時に実行するように構成されたタスクです。複数のコンピューティング ノードをまとめて 1 つのワークロードの処理に割り当てる Message Passing Interface (MPI) など、ハイ パフォーマンス コンピューティングが要求されるシナリオには、マルチインスタンス タスクを使って対応することができます。

Batch では、標準的な[タスク](#task)にマルチインスタンスの設定を指定することによってマルチインスタンス タスクを作成します。これらの設定には、タスクを実行するコンピューティング ノードの数、メイン タスクのコマンド ライン ("アプリケーション コマンド")、調整コマンド、タスクごとの一連の共通リソース ファイルが含まれます。

マルチインスタンス設定のタスクをジョブに送信すると、Batch サービスによって次の処理が実行されます。

1. 1 つのプライマリ タスクと十分な数のサブタスクを自動的に作成します。これらのタスクは、指定した数の全ノード上で同時に実行されます。次に、Batch は、これらのタスクをノード上で実行するためのスケジュールを設定します。ここでまず、指定した共通リソース ファイルがダウンロードされます。
2. 共通リソース ファイルがダウンロードされると、プライマリ タスクとサブタスクによって調整コマンドが実行されます。通常この調整コマンドがバックグラウンド サービス ([MS-MPI][msmpi] の `smpd.exe` など) を開始し、ノードの準備が整っている (ノード間でやり取りされるメッセージを処理できる状態にある) ことを確認します。
3. プライマリ タスクとすべてのサブタスクの調整コマンドが正常に完了すると、タスクのコマンド ライン ("アプリケーション コマンド") が、プライマリ タスクによってのみ実行されます。一般に、ノード上で目的のワークロードを処理する MPI 対応のカスタム アプリケーションは、このコマンドで開始します。たとえば、Windows MPI のシナリオでは、通常、アプリケーション コマンドから [MS-MPI][msmpi] の `mpiexec.exe` を使用して MPI 対応アプリケーションを実行することになります。

### <a name="jobschedule"></a>スケジュールされたジョブ

ジョブ スケジュールを使用すると、Batch サービス内に、繰り返し発生するジョブを作成することができます。ジョブ スケジュールは、ジョブをいつ実行するかを指定し、実行されるジョブの仕様を持っています。ジョブ スケジュールではスケジュールの期間の詳細を指定できます。スケジュールがいつ有効になって、どのくらいの期間有効であるかや、その期間中にどのくらいの頻度でジョブを作成するかなどです。

## <a name="files"></a>ファイルとディレクトリ

各タスクには作業ディレクトリがあります。この作業ディレクトリ内に、タスクによって実行されるプログラム、タスクによって処理されるデータ、およびタスクによって実行された処理の出力を格納するためのファイルおよびディレクトリが 0 個以上作成されます。これらのファイルとディレクトリは、ジョブの実行中に他のタスクから使用できます。ノード上のすべてのタスク、ファイル、およびディレクトリは、単一のユーザー アカウントによって所有されます。

Batch サービスは、ノード上のファイル システムの一部を "ルート ディレクトリ" として公開します。 ルート ディレクトリは、`%AZ_BATCH_NODE_ROOT_DIR%` 環境変数にアクセスすることによって、タスクから使用できます。環境変数の使用に関する詳細については、「[タスクの環境設定](#environment)」を参照してください。

![コンピューティング ノードのディレクトリ構造][1]

ルート ディレクトリには、次のディレクトリ構造が含まれています。

- **Shared** – この場所は、ジョブに関係なく、ノード上で実行されるすべてのタスクの共有ディレクトリです。ノードでは、共有ディレクトリは `%AZ_BATCH_NODE_SHARED_DIR%` を通じてアクセスされます。このディレクトリは、ノードで実行されるすべてのタスクに読み取り/書き込みアクセスを提供します。タスクは、このディレクトリのファイルを作成、読み取り、更新、および削除できます。

- **Startup** - この場所は、開始タスクによって作業ディレクトリとして使用されます。開始タスクを起動するために Batch サービスによってダウンロードされるファイルもすべてこのディレクトリに格納されます。ノードでは、開始ディレクトリは `%AZ_BATCH_NODE_START_DIR%` 環境変数を通じて使用されます。開始タスクは、このディレクトリのファイルを作成、読み取り、更新、および削除できます。また、このディレクトリを使用して、オペレーティング システムを構成できます。

- **Tasks** - ノード上で実行されるタスクごとに、ディレクトリが作成されます。そのディレクトリには、`%AZ_BATCH_TASK_DIR%` を通じてアクセスします。各タスク ディレクトリ内に、Batch サービスによって作業ディレクトリ (`wd`) が作成されます。その一意のパスは、`%AZ_BATCH_TASK_WORKING_DIR%` 環境変数によって指定されます。このディレクトリは、タスクに読み取り/書き込みアクセスを提供します。タスクは、このディレクトリのファイルを作成、読み取り、更新、および削除できます。このディレクトリは、タスクに対して指定された *RetentionTime* 制約に基づいて保持されます。
  - `stdout.txt` および `stderr.txt` - これらのファイルは、タスクの実行中にタスク フォルダーに書き込まれます。

ノードをプールから削除すると、ノードに格納されているすべてのファイルが削除されます。

## <a name="lifetime"></a>プールとコンピューティング ノードの有効期間

Azure Batch ソリューションを設計するときは、いつ、どのようにプールを作成するかと、それらのプール内のコンピューティング ノードをどのくらいの期間利用できるようにしておくかを考慮する必要があります。

極端な例として、ジョブが送信されたときに各ジョブに対してプールを作成し、タスクの実行が完了したらすぐにノードを削除することもできます。この場合、ノードが絶対に必要なときにのみノードを割り当て、ノードがアイドル状態になるとすぐにシャットダウンするため、使用率が最大になります。ジョブはノードが割り当てられるまで待機する必要がありますが、ノードが個別に使用可能になって割り当てられ、開始タスクが完了するとすぐに、タスクがノードに対してスケジュール設定されることに注意してください。つまり、プール内のすべてのノードが使用可能になるまで Batch がタスクの割り当てを待機することは*ありません*。そのため、使用可能なすべてのノードで使用率が最大になります。

もう一方の極端な例では、ジョブをすぐに開始することが最優先事項である場合、プールを事前に作成し、ジョブが送信される前にノードを使用可能にしておくことができます。このシナリオでは、ジョブ タスクをすぐに開始できますが、ノードはタスクの割り当てを待つ間、アイドル状態で待機する可能性があります。

変化する進行中の負荷を処理するために通常使用される折衷的なアプローチでは、複数のジョブが送信されるプールを用意し、ジョブの負荷に応じてノード数を増減します (後の「*アプリケーションのスケーリング*」を参照)。この方法では、現在の負荷に応じて事後的に対応することができ、負荷を予測できる場合は事前に対応することもできます。

## <a name="scaling"></a>アプリケーションのスケーリング

[自動スケーリング](batch-automatic-scaling.md)を使用すると、アプリケーションのスケールを簡単かつ自動的に拡大または縮小して、必要な計算に対応できます。現在のワークロードとリソース使用状況の統計情報に基づいて、プール内のノード数を動的に調整できます。そのため、必要なリソースのみを使用することで、アプリケーションの実行の全体的なコストを削減できます。プールの作成時にスケーリング設定を指定できます。また、いつでもこの構成を更新することができます。

ノード数を自動的に減らす場合は、実行中のタスクについて考慮する必要があります。割り当て解除ポリシーを指定することで、実行中のタスクを停止してノードをすぐに削除するか、タスクが完了してからノードを削除するかを決定します。ジョブ完了時のノードの目標個数を 0 に設定し、実行中のタスクは完了するまで実行するようにした場合に、使用率が最大になります。

アプリケーションの自動スケーリングを行うには、スケーリング式のセットを指定します。これらの式は、次のスケーリング間隔でプールに含まれるノードの目標数を決定するために使用されます。たとえば、実行をスケジューリングされる多数のタスクが送信されることをジョブが必要としている場合があります。この場合、現在の保留中のタスクの数とこれらのタスクの完了率に基づいてプールのサイズ (ノード数) を調整するスケーリング式をプールに割り当てることができます。Batch サービスは、定期的に式を評価し、ワークロードに基づいてプールのサイズを変更します。

スケーリング式には、次のメトリックを使用できます。

- **時間メトリック** - 指定した時間数内で 5 分おきに収集された統計情報に基づきます。

- **リソース メトリック** - CPU 使用量、帯域幅使用量、メモリ使用量、およびノードの数に基づきます。

- **タスク メトリック** - タスクの状態 (保留中、アクティブ、完了) に基づきます。

アプリケーションの自動的なスケーリングの詳細については、「[Azure Batch プール内のコンピューティング ノードの自動スケール](batch-automatic-scaling.md)」を参照してください。

> [AZURE.TIP]
 ノードの削除が必要になることはあまりありませんが、ノードを個別に指定してプールから削除することができます。たとえば、信頼性が低いと思われるノードがある場合は、プールから削除して、タスクがさらに割り当てられないようにすることができます。

## <a name="cert"></a>証明書によるセキュリティ

証明書を使用する必要があるのは、通常、[Azure ストレージ アカウント][azure_storage]のキーなど、タスクの機密情報を暗号化または復号化するときです。そのような場合をサポートするために、証明書はノードにインストールすることができます。暗号化された機密情報は、コマンド ライン パラメーターを通じてタスクに渡されるか、タスク リソースの 1 つに埋め込まれます。インストールされた証明書を使用して、機密情報を復号化できます。

[証明書の追加][rest_add_cert]操作 (Batch REST API) または [CertificateOperations.CreateCertificate][net_create_cert] メソッド (Batch .NET API) を使用して、Batch アカウントに証明書を追加できます。次に、新規または既存のプールに証明書を関連付けることができます。証明書がプールに関連付けられると、Batch サービスは、プール内の各ノードに証明書をインストールします。Batch サービスは、ノードの起動時に、いずれかのタスク (開始タスク、ジョブ マネージャー タスクも含まれます) を起動する前に、適切な証明書をインストールします。

## <a name="scheduling"></a>スケジューリング優先順位

Batch で作成するジョブには、優先順位を割り当てることができます。Batch サービスは、ジョブの優先順位値を使用して、アカウント内のジョブ スケジューリングの順序を決定します。優先順位として、-1000 ～ 1000 の値を使用します。-1000 は最も低い優先順位を示し、1000 は最も高い優先順位を示します。ジョブの優先順位を更新するには、[ジョブのプロパティの更新][rest_update_job]操作 (Batch REST API) を使用するか、[CloudJob.Priority][net_cloudjob_priority] プロパティ (Batch .NET API) を変更します。

同じアカウント内で、優先順位の高いジョブは優先順位の低いジョブよりも優先的にスケジュールされます。あるアカウントの優先順位値が高いジョブが、異なるアカウントの優先順位値が低い別のジョブよりも優先的にスケジュールされることはありません。

複数のプールにわたるジョブ スケジューリングは、独立しています。異なるプール間では、関連するそのプールでアイドル状態のノードが不足している場合、優先順位の高い方のジョブが最初にスケジュールされるとは限りません。同じプール内のジョブの場合、優先順位が同じであれば、スケジュールされる可能性は等しくなります。

## <a name="environment"></a>タスクの環境設定

Batch ジョブ内で実行される各タスクは、Batch サービスによって設定された環境変数 (システム定義。下の表を参照) とユーザー定義の環境変数の両方にアクセスします。コンピューティング ノード上のタスクによって実行されるアプリケーションとスクリプトは、ノードでの実行中に、これらの環境変数にアクセスします。

ユーザー定義環境変数を設定するには、[ジョブへのタスクの追加][rest_add_task]操作 (Batch REST API) を使用するか、ジョブにタスクを追加するときに [CloudTask.EnvironmentSettings][net_cloudtask_env] プロパティ (Batch .NET API) を変更します。

タスクの環境変数を取得するには、システム定義であっても、ユーザー定義であっても、[タスクについての情報の取得][rest_get_task_info]操作 (Batch REST API) を使うか、[CloudTask.EnvironmentSettings][net_cloudtask_env] プロパティ (Batch .NET API) にアクセスします。前述のように、コンピューティング ノードで実行中のプロセスも、すべての環境変数にアクセスできます。たとえば、一般的な `%VARIABLE_NAME%` 構文を使用してアクセスします。

ジョブでスケジュールされるすべてのタスクに、以下のシステム定義環境変数のセットが、Batch サービスによって設定されます。

| 環境変数の名前 | 説明 |
|---------------------------------|--------------------------------------------------------------------------|
| `AZ_BATCH_ACCOUNT_NAME` | タスクが所属するアカウントの名前。 |
| `AZ_BATCH_JOB_ID` | タスクが所属するジョブの ID。 |
| `AZ_BATCH_JOB_PREP_DIR` | ノード上のジョブ準備タスク ディレクトリの完全パス。 |
| `AZ_BATCH_JOB_PREP_WORKING_DIR` | ノード上のジョブ準備タスク作業ディレクトリの完全パス。 |
| `AZ_BATCH_NODE_ID` | タスクが実行されているノードの ID。 |
| `AZ_BATCH_NODE_ROOT_DIR` | ノード上のルート ディレクトリの完全パス。 |
| `AZ_BATCH_NODE_SHARED_DIR` | ノード上の共有ディレクトリの完全パス。 |
| `AZ_BATCH_NODE_STARTUP_DIR` | ノード上のコンピューティング ノードのスタートアップ タスク ディレクトリの完全パス。 |
| `AZ_BATCH_POOL_ID` | タスクが実行されているプールの ID。 |
| `AZ_BATCH_TASK_DIR` | ノード上のタスク ディレクトリの完全パス。 |
| `AZ_BATCH_TASK_ID` | 現在のタスクの ID。 |
| `AZ_BATCH_TASK_WORKING_DIR` | ノード上のタスク作業ディレクトリの完全パス。 |

>[AZURE.NOTE] 上記のシステム定義変数は、上書きできません。読み取り専用です。

## <a name="errorhandling"></a>エラー処理

Batch ソリューション内のタスクとアプリケーションの障害を処理しなければならないことがあります。

### タスクのエラー処理
タスク エラーは、以下のカテゴリに分類されます。

- **スケジュール エラー**
	- タスク用に指定されたファイルの転送がなんらかの理由で失敗すると、タスクの "スケジュール エラー" が設定されます。
	- スケジュール エラーの原因には、ファイルが移動された、ストレージ アカウントが利用できなくなった、ノードへのコピーを失敗させるようなその他の問題が発生した、などがあります。
- **アプリケーション エラー**
	- タスクのコマンド ラインで指定されたプロセスも失敗することがあります。タスクによって実行されたプロセスによって 0 以外の終了コードが返された場合、プロセスが失敗したと見なされます。
	- アプリケーション エラーについては、指定された回数まで自動的にタスクを再試行するように Batch を構成することができます。
- **制約エラー**
	- ジョブまたはタスクの最大実行期間を指定する制約である *maxWallClockTime* を設定することができます。これは、"ハング" タスクを終了させる場合に便利です。
	- 最大実行時間を超過したタスクは*完了*としてマークされますが、終了コードは `0xC000013A` に設定され、*schedulingError* フィールドは `{ category:"ServerError", code="TaskEnded"}` としてマークされます。

### アプリケーション エラーのデバッグ

アプリケーションの実行中に、問題のトラブルシューティングに利用できる診断情報が生成される場合があります。上の「[ファイルとディレクトリ](#files)」で説明したように、Batch サービスは stdout および stderr 出力をコンピューティング ノードのタスク ディレクトリにある `stdout.txt` および `stderr.txt` ファイルに送信します。Batch .NET API の [ComputeNode.GetNodeFile][net_getfile_node] および [CloudTask.GetNodeFile][net_getfile_task] を使用して、このようなファイルをトラブルシューティング用に取得できます。

*リモート デスクトップ*を使用してコンピューティング ノードにログインすると、さらに広範なデバッグを実行できます。リモート ログインには、[ノードからリモート デスクトップ プロトコル ファイルを取得する][rest_rdp] (Batch REST API) か、[ComputeNode.GetRDPFile][net_rdp] メソッド (Batch .NET API) を使用します。

>[AZURE.NOTE] RDP を通じてノードに接続するには、まず、ノード上にユーザーを作成する必要があります。Batch REST API で[ノードにユーザー アカウントを追加する][rest_create_user]か、Batch .NET で [ComputeNode.CreateComputeNodeUser][net_create_user] メソッドを使用します。

### タスクのエラーや中断の理由

タスクは、エラーが発生したり中断されたりする場合があります。タスク アプリケーション自体でエラーが発生したり、タスクが実行されているノードが再起動したりすることがあります。また、プールの割り当て解除ポリシーが、タスクの完了を待たずに直ちにノードを削除するように設定されている場合は、サイズ変更操作中にノードがプールから削除されることもあります。どのようなケースでも、Batch によってタスクを自動的にキューに戻し、別のノードで実行することができます。

断続的に発生する問題によって、タスクが応答を停止したり、実行に長い時間がかかるようになる場合もあります。タスクに最大実行時間を設定すると、その時間を超過したときにタスク アプリケーションを中断できます。

### 問題のあるノードの理由

プール内のノードにはそれぞれ一意の ID があり、タスクが実行されるノードはタスクのメタデータに含まれています。特定のノードでタスクのエラーが発生している場合、そのことは Batch クライアント アプリケーションによって判断することができ、疑わしいノードはプールから削除できます。ノードを削除するときに実行されているタスクがある場合、タスクは自動的にキューに入れ直され、他のノードで実行されます。

## 次のステップ

- 「[.NET 向け Azure Batch ライブラリの概要](batch-dotnet-get-started.md)」の手順に従って、最初の Batch アプリケーションを作成します
- Batch ソリューションを開発するときに使用する [Batch Explorer][batch_explorer_project] サンプル プロジェクトをダウンロードしてビルドするBatch Explorer を使用すると、次のようなことを実行できます。
  - Batch アカウント内のプール、ジョブ、およびタスクの監視と操作
  - ノードからの `stdout.txt`、`stderr.txt` などのファイルのダウンロード
  - ノードでのユーザーの作成と、リモート ログインのための RDP ファイルのダウンロード

[1]: ./media/batch-api-basics/node-folder-structure.png

[about_cloud_services]: https://azure.microsoft.com/documentation/articles/fundamentals-application-models/#tell-me-about-cloud-services
[azure_storage]: https://azure.microsoft.com/services/storage/
[batch_explorer_project]: https://github.com/Azure/azure-batch-samples/tree/master/CSharp/BatchExplorer
[cloud_service_sizes]: https://azure.microsoft.com/documentation/articles/cloud-services-sizes-specs/
[msmpi]: https://msdn.microsoft.com/library/bb524831.aspx

[batch_net_api]: https://msdn.microsoft.com/library/azure/mt348682.aspx
[net_cloudjob_jobmanagertask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudjob.jobmanagertask.aspx
[net_cloudjob_priority]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudjob.priority.aspx
[net_cloudpool_starttask]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudpool.starttask.aspx
[net_cloudtask_env]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudtask.environmentsettings.aspx
[net_create_cert]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.certificateoperations.createcertificate.aspx
[net_create_user]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.createcomputenodeuser.aspx
[net_getfile_node]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.getnodefile.aspx
[net_getfile_task]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.cloudtask.getnodefile.aspx
[net_multiinstancesettings]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.multiinstancesettings.aspx
[net_rdp]: https://msdn.microsoft.com/library/azure/microsoft.azure.batch.computenode.getrdpfile.aspx

[batch_rest_api]: https://msdn.microsoft.com/library/azure/Dn820158.aspx
[rest_add_job]: https://msdn.microsoft.com/library/azure/mt282178.aspx
[rest_add_pool]: https://msdn.microsoft.com/library/azure/dn820174.aspx
[rest_add_cert]: https://msdn.microsoft.com/library/azure/dn820169.aspx
[rest_add_task]: https://msdn.microsoft.com/library/azure/dn820105.aspx
[rest_create_user]: https://msdn.microsoft.com/library/azure/dn820137.aspx
[rest_get_task_info]: https://msdn.microsoft.com/library/azure/dn820133.aspx
[rest_multiinstance]: https://msdn.microsoft.com/ja-JP/library/azure/mt637905.aspx
[rest_multiinstancesettings]: https://msdn.microsoft.com/library/azure/dn820105.aspx#multiInstanceSettings
[rest_update_job]: https://msdn.microsoft.com/library/azure/dn820162.aspx
[rest_rdp]: https://msdn.microsoft.com/library/azure/dn820120.aspx

<!---HONumber=AcomDC_0218_2016-->