---
title: "カスタム イメージから Azure Batch プールをプロビジョニングする | Microsoft Docs"
description: "カスタム イメージから Batch プールを作成して、アプリケーションで必要なソフトウェアとデータを含むコンピューティング ノードをプロビジョニングできます。 カスタム イメージは、Batch ワークロードを実行するコンピューティング ノードを構成するための効率的な方法です。"
services: batch
author: tamram
manager: timlt
ms.service: batch
ms.topic: article
ms.date: 08/07/2017
ms.author: tamram
ms.translationtype: HT
ms.sourcegitcommit: f9003c65d1818952c6a019f81080d595791f63bf
ms.openlocfilehash: 1248aeeaa159789b008eb003c2cd7babe0432919
ms.contentlocale: ja-jp
ms.lasthandoff: 08/09/2017

---

# <a name="use-a-custom-image-to-create-a-pool"></a>カスタム イメージを使用してプールを作成する

Azure Batch でプールを作成する際は、プール内の各コンピューティング ノードのオペレーティング システムを構成する仮想マシン (VM) イメージを指定します。 プールは、Azure Marketplace イメージを使用するか、自分で準備したカスタム イメージを提供することで作成できます。 カスタム イメージを使用すると、各コンピューティング ノードのプロビジョニング時にオペレーティング システムをどのように構成するかを制御できます。 カスタム イメージには、コンピューティング ノードがプロビジョニングされたときにすぐに使用可能になるアプリケーションと参照データを含めることもできます。

カスタム イメージを使用すると、プールのコンピューティング ノードが Batch ワークロードを実行できるようになる時間を短縮できます。 Azure Marketplace イメージの使用と、プロビジョニング後の各コンピューティング ノードでのソフトウェアのインストールはいつでも実行できますが、この方法は、カスタム イメージの使用よりも効率が悪くなる場合があります。 大規模なアプリケーションのインストール、大量のデータのコピー、またはセットアップ プロセス中の VM の再起動が必要な場合は、ニーズに合うように構成したカスタム イメージを使用することを検討してください。  

## <a name="prerequisites"></a>前提条件

- **ユーザー サブスクリプション プール割り当てモードで作成された Batch アカウント** カスタム イメージを使用して仮想マシン プールをプロビジョニングするには、ユーザー サブスクリプション [プール割り当てモード](batch-api-basics.md#pool-allocation-mode)で Batch アカウントを作成します。 このモードでは、Batch プールはアカウントが存在するサブスクリプションに割り当てられます。 Batch アカウントを作成する際のプール割り当てモードの設定の詳細については、「[Batch を使って大規模な並列コンピューティング ソリューションを開発する](batch-api-basics.md)」の「[アカウント](batch-api-basics.md#account)」セクションを参照してください。

- **Azure ストレージ アカウント。** カスタム イメージを使用して仮想マシン構成プールを作成するには、カスタム VHD イメージを格納する 1 つ以上の Standard Azure Storage アカウントが必要です。 カスタム イメージは BLOB として格納されます。 プールを作成するときにカスタム イメージを参照するには、カスタム イメージの VHD BLOB の URI を、[virtualMachineConfiguration](https://docs.microsoft.com/rest/api/batchservice/add-a-pool-to-an-account#bk_vmconf) プロパティの [osDisk](https://docs.microsoft.com/rest/api/batchservice/add-a-pool-to-an-account#bk_osdisk) プロパティに指定します。

    ストレージ アカウントが次の条件を満たしていることを確認します。   
    
    - カスタム イメージの VHD BLOB を含むストレージ アカウントは、Batch アカウントと同じサブスクリプション (ユーザー サブスクリプション) 内に存在する必要があります。
    - 指定されたストレージ アカウントは、Batch アカウントと同じリージョン内にある必要があります。
    - 現在、Standard 汎用ストレージ アカウントしかサポートされていません。 Azure Premium Storage は、将来的にサポートされる予定です。
    - 複数のカスタム VHD BLOB を含む 1 つのストレージ アカウントを指定するか、それぞれが 1 つの BLOB を含む複数のストレージ アカウントを指定できます。 複数のストレージ アカウントを使用してパフォーマンスを向上させることをお勧めします。
    - 一意の 1 つのカスタム イメージ VHD BLOB でサポートできるのは、最大 40 個の Linux VM インスタンスまたは最大 20 個の Windows VM インスタンスです。 VHD BLOB のコピーを作成して、さらに多くの VM を含むプールを作成できます。 たとえば、200 個の Windows VM を含む 1 つのプールは、一意の VHD BLOB 10 個を **osDisk** プロパティに指定する必要があります。
    
## <a name="prepare-a-custom-image"></a>カスタム イメージを準備する

Batch で使用するカスタム イメージを準備するには、Linux または Windows の既存のインストールを汎用化する必要があります。 オペレーティング システムのインストールを汎用化すると、コンピュータに固有の情報が削除されます。 その結果、他のコンピューターまたは VM にインストールできるイメージになります。  

カスタム イメージのベース イメージとして Azure Marketplace イメージを使用できます。 ベース イメージをカスタマイズするには、Azure VM を作成し、アプリケーションやデータを追加します。 その後、カスタム イメージとして使用できるように VM を汎用化します。   

Azure VM からカスタムの Linux イメージを準備する方法の詳細については、「[仮想マシンまたは VHD のイメージを作成する方法](../virtual-machines/linux/capture-image.md)」を参照してください。 

Azure VM からカスタムの Windows イメージを準備する方法については、[Azure PowerShell を使用したカスタム VM イメージの作成](../virtual-machines/windows/tutorial-custom-images.md)と [Sysprep (システムの準備) の概要](https://docs.microsoft.com/windows-hardware/manufacture/desktop/sysprep--system-preparation--overview)に関する記事を参照してください。 

> [!IMPORTANT]
> カスタム イメージを準備するときには、次の点に注意してください。
> - Batch プールのプロビジョニングに使用するベース OS イメージにカスタム スクリプト拡張機能などの Azure 拡張機能がプレインストールされていないことを確認します。 イメージにプレインストールされた拡張機能が含稀る場合、Azure で VM のデプロイ時に問題が発生する可能性があります。
> - Batch ノード エージェントでは現在、既定の一時ドライブが要求されるため、提供するベース OS イメージで既定の一時ドライブが使用されることを確認します。
>
>
    
## <a name="create-a-pool-from-a-custom-image-in-the-portal"></a>ポータルでカスタム イメージからプールを作成する

Azure ポータルを使用してカスタム イメージからプールを作成するには:

1. Azure ポータルの Batch アカウントに移動します。
2. **[設定]** ブレードで **[プール]** メニュー項目を選択します。
3. **[プール]** ブレードで **[追加]** コマンドを選択します。**[プールの追加]** ブレードが表示されます。
4. **[イメージの種類]** ドロップダウンから **[カスタム イメージ (Linux/Windows)]** を選択します。 ポータルに **[カスタム イメージ]** ピッカーが表示されます。 同じコンテナーの 1 つ以上の VHD を選択し、**[選択]** ボタンをクリックします。 
   異なるストレージ アカウントと異なるコンテナーから VHD を選択することのサポートは、今後のリリースで使用可能になる予定です。
5. カスタム VHD の適切な **パブリッシャー/プラン/SKU** を選択して、必要な **[キャッシュ]** モードを選択してから、プールのその他のパラメーターを設定します。
6. プールがカスタム イメージに基づいているかを調べるには、**[プール]** ブレードのリソースの概要セクションで **[オペレーティング システム]** プロパティを確認します。 このプロパティの値は **[カスタム VM イメージ]** であることが必要です。
7. プールに関連付けられているすべてのカスタム VHD がプールの **[プロパティ]** ブレードに表示されます。
 
## <a name="next-steps"></a>次のステップ

- Batch の詳細な概要については、「[Batch を使って大規模な並列コンピューティング ソリューションを開発する](batch-api-basics.md)」を参照してください。
- Batch アカウントの作成の詳細については、「[Azure ポータルで Batch アカウントを作成する](batch-account-create-portal.md)」を参照してください。
