---
title: "カスタム イメージから Azure Batch プールをプロビジョニングする | Microsoft Docs"
description: "カスタム イメージから Batch プールを作成して、アプリケーションで必要なソフトウェアとデータを含むコンピューティング ノードをプロビジョニングできます。 カスタム イメージは、Batch ワークロードを実行するコンピューティング ノードを構成するための効率的な方法です。"
services: batch
author: dlepow
manager: jeconnoc
ms.service: batch
ms.topic: article
ms.date: 10/11/2017
ms.author: danlep
ms.openlocfilehash: 63a567e9fdfef8dfceb275953cc0ac606355ea30
ms.sourcegitcommit: 9d317dabf4a5cca13308c50a10349af0e72e1b7e
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/01/2018
---
# <a name="use-a-managed-custom-image-to-create-a-pool-of-virtual-machines"></a>マネージ カスタム イメージを使用して仮想マシンのプールを作成する 

仮想マシンの構成を使用して Azure Batch プールを作成するときは、プールの各コンピューティング ノードにオペレーティング システムを提供する VM イメージを指定します。 仮想マシンのプールを作成するには、Azure Marketplace イメージまたはカスタム イメージ (自分で作成して構成した VM イメージ) のいずれかを使用します。 カスタム イメージは、Batch アカウントと同じ Azure サブスクリプションとリージョンにある "*マネージ イメージ*" リソースである必要があります。

## <a name="why-use-a-custom-image"></a>カスタム イメージを使用する理由
カスタム イメージを提供すると、オペレーティング システムの構成と、使用するオペレーティング システムおよびデータ ディスクの種類を制御できます。 カスタム イメージには、Batch プール ノードがプロビジョニングされると、そのすべてのノードですぐに使用可能になるアプリケーションと参照データを含めることができます。

カスタム イメージを使用すると、Batch ワークロードを実行できるように、プールのコンピューティング ノードを準備する時間を短縮できます。 プロビジョニング後、Azure Marketplace イメージを使用して、各コンピューティング ノードにソフトウェアをインストールできますが、カスタム イメージを使用する方が効率的である可能性があります。

シナリオに合わせて構成されたカスタム イメージを使用すると、次のようなメリットがあります。

- **オペレーティング システム (OS) の構成**。 カスタム イメージのオペレーティング システム ディスクでは、オペレーティング システムの特殊な構成を行うことができます。 
- **アプリケーションの事前インストール。** 事前インストールされたアプリケーションを含むカスタム イメージを OS ディスクに作成できます。これは、StartTask を使用してコンピューティング ノードをプロビジョニングしてからアプリケーションをインストールするよりも、エラーが発生しにくく、効率的です。
- **VM での再起動時間の節約。** アプリケーションのインストールには、通常、VM の再起動が必要で、これに時間がかかります。 アプリケーションを事前インストールすることで、再起動の時間を節約できます。 
- **大量のデータを 1 度にコピー。** マネージ カスタム イメージの静的データの部分を、マネージ イメージのデータ ディスクにコピーすることで作成できます。 この作業は 1 回行うだけで、プールの各ノードでデータを使用できるようになります。
- **ディスクの種類の選択。** VHD、Azure VM のマネージ ディスク、こうしたディスクのスナップショット、自身で構成した独自の Linux または Windows インストールから、マネージ カスタム イメージを作成できます。 OS ディスクやデータ ディスク用に Premium Storage を使用することもできます。
- **任意のサイズにプールを拡大。** マネージ カスタム イメージを使用してプールを作成するとき、そのプールは、必要なサイズに拡大できます。 VM 数に合わせてイメージ BLOB VHD をコピーする必要がありません。 


## <a name="prerequisites"></a>前提条件

- **マネージ イメージ リソース**。 カスタム イメージを使用して仮想マシンのプールを作成するには、Batch アカウントと同じ Azure サブスクリプションおよびリージョンに、マネージ イメージ リソースを作成する必要があります。 マネージ イメージの準備オプションについては、次のセクションを参照してください。
- **Azure Active Directory (AAD) 認証**。 Batch クライアント API では、AAD 認証を使用する必要があります。 AAD の Azure Batch のサポートについては、「[Batch サービスの認証に Active Directory を使用する](batch-aad-auth.md)」に記載されています。

    
## <a name="prepare-a-custom-image"></a>カスタム イメージを準備する
マネージ イメージの準備は、VHD、マネージ ディスクを備えた Azure VM、または VM スナップショットから行います。 

イメージを準備するときには、次の点に注意してください。

* Batch プールのプロビジョニングに使用するベース OS イメージにカスタム スクリプト拡張機能などの Azure 拡張機能がプレインストールされていないことを確認します。 イメージにプレインストールされた拡張機能が含稀る場合、Azure で VM のデプロイ時に問題が発生する可能性があります。
* 提供するベース OS イメージには、必ず既定の一時ドライブを使用するようにしてください。 現在、Batch ノード エージェントでは、既定の一時ドライブを使用する必要があります。
* Batch プールによって参照されるマネージ イメージ リソースは、プールの有効期間が終わるまで削除できません。 マネージ イメージ リソースが削除されていると、プールを拡大できません。 

### <a name="to-create-a-managed-image"></a>マネージ イメージを作成するには
既存の準備済み Windows または Linux オペレーティング システム ディスクを使用して、マネージ イメージを作成できます。 たとえば、ローカル イメージを使用する場合は、AzCopy または他のアップロード ツールを使用して、Batch アカウントと同じサブスクリプションおよびリージョンにある Azure ストレージ アカウントに、ローカル ディスクをアップロードします。 VHD をアップロードし、マネージ イメージを作成する詳細な手順については、[Windows](../virtual-machines/windows/upload-generalized-managed.md) または [Linux](../virtual-machines/linux/upload-vhd.md) VM のガイダンスをご覧ください。

新規または既存の Azure VM または VM スナップショットから、マネージ イメージを準備することもできます。 

* 新しい VM を作成する場合は、Azure Marketplace イメージをマネージ イメージのベース イメージとして使用し、それをカスタマイズすることができます。 

* ポータルを使用してイメージをキャプチャする場合は、VM がマネージ ディスクを使用して作成されていることを確認します。 これは VM を作成するときの既定のストレージ設定です。

* VM が実行状態になったら、RDP (Windows の場合) または SSH (Linux の場合) を使用して VM に接続します。 必要なソフトウェアをインストールするか、必要なデータをコピーしてから、VM を汎用化します。  

Azure VM を汎用化し、マネージ イメージを作成する手順については、[Windows](../virtual-machines/windows/capture-image-resource.md) または [Linux](../virtual-machines/linux/capture-image.md) VM のガイダンスをご覧ください。

イメージを使用して Batch プールを作成する方法に応じて、次の識別子がイメージに必要です。

* Batch API を使用してイメージでプールを作成する場合は、イメージの**リソース ID**。形式は次のとおりです。`/subscriptions/xxxx-xxxxxx-xxxxx-xxxxxx/resourceGroups/myResourceGroup/providers/Microsoft.Compute/images/myImage` 
* ポータルを使用する場合は、イメージの**名前**。 





## <a name="create-a-pool-from-a-custom-image-in-the-portal"></a>ポータルでカスタム イメージからプールを作成する

カスタム イメージを保存し、そのリソース ID または名前を特定したら、そのイメージから Batch プールを作成できます。 次の手順は、Azure Portal からプールを作成する方法を示しています。

> [!NOTE]
> Batch API のいずれかを使用してプールを作成する場合は、AAD 認証に使用する ID に、イメージ リソースへのアクセス許可が付与されていることを確認してください。 「[Batch サービスの認証に Active Directory を使用する](batch-aad-auth.md)」を参照してください。
>

1. Azure Portal の Batch アカウントに移動します。 このアカウントは、カスタム イメージを含むリソース グループと同じサブスクリプションおよびリージョン内にある必要があります。 
2. 左側の **[設定]** ウィンドウで、**[プール]** メニュー項目を選択します。
3. **[プール]** ウィンドウで、**[追加]** コマンドを選択します。
4. **[プールの追加]** ウィンドウで、**[イメージの種類]** ボックスの一覧の **[カスタム イメージ (Linux/Windows)]** を選択します。 **[カスタム VM イメージ]** ドロップダウンで、イメージ名 (リソース ID の短い形式) を選択します。
5. **[Publisher]\(パブリッシャー\)、[Offer]\(プラン\)、[SKU]** で、カスタム イメージに対して適切な値を選択します。
6. **[ノード サイズ]**、**[ターゲットの専用ノード数]**、**[低優先度ノード]** など、残りの必須の設定ほか、オプションの設定も必要に応じて指定します。

    たとえば、Microsoft Windows Server Datacenter 2016 のカスタム イメージの場合、**[プールの追加]** ウィンドウは次のように表示されます。

    ![カスタム Windows イメージからプールを追加する](media/batch-custom-images/add-pool-custom-image.png)
  
既存のプールがカスタム イメージに基づいているかどうかを調べるには、**[プール]** ウィンドウのリソースの概要セクションで **[オペレーティング システム]** プロパティを確認します。 プールがカスタム イメージから作成されている場合、値は **[カスタム VM イメージ]** に設定されます。

プールに関連付けられているすべてのカスタム イメージがプールの **[プロパティ]** ウィンドウに表示されます。
 
## <a name="next-steps"></a>次の手順

- Batch の詳細な概要については、「[Batch を使って大規模な並列コンピューティング ソリューションを開発する](batch-api-basics.md)」を参照してください。
