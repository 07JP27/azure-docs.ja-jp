---
title: "Azure IoT Edge のモジュールを展開および監視する | Microsoft Docs"
description: "エッジ デバイスで実行するモジュールの管理"
services: iot-edge
keywords: 
author: kgremban
manager: timlt
ms.author: kgremban
ms.date: 12/07/2017
ms.topic: article
ms.service: iot-edge
ms.openlocfilehash: cc7d1e290465d9254cbd7fe9e8ba71cc740b0368
ms.sourcegitcommit: 357afe80eae48e14dffdd51224c863c898303449
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 12/15/2017
---
# <a name="deploy-and-monitor-iot-edge-modules-at-scale---preview"></a>大規模な IoT Edge モジュールの展開と監視 - プレビュー

Azure IoT Edge を使用することにより、分析をエッジに移動しクラウド インターフェイスを提供して、各 IoT Edge デバイスに物理的にアクセスしなくても、管理および監視することができます。 デバイスをリモート管理できる機能は、モノのインターネット ソリューションの規模と複雑性が増加している今、重要性が高まっています。 Azure IoT Edge は、追加するデバイスの数に関係なく、ビジネス目標を支援できるよう設計されています。

デバイスを個別に管理し、それらにモジュールを一括展開できます。 また、大規模な環境でのデバイスに変更を加える場合は、**IoT Edge デプロイ**を作成できます。 デプロイは、一度に複数のモジュールを複数のデバイスに展開し、モジュールの状態と正常性を追跡し、必要に応じて変更できる動的プロセスです。 

## <a name="identify-devices-using-tags"></a>タグを使用したデバイスの識別

デプロイを作成する前に、影響を与えるデバイスを指定できる必要があります。 Azure IoT Edge では、デバイス ツイン内の**タグ**を使用してデバイスを識別します。 各デバイスには複数のタグを設定することができ、ソリューションに適した任意の方法で定義できます。 たとえば、スマート ビルのキャンパスを管理している場合は、デバイスに次のタグを追加できます。

```json
"tags":{
    "location":{
        "building": "20",
        "floor": "2"
    },
    "roomtype": "conference",
    "environment": "prod"
}
```

デバイス ツインとタグの詳細については、「[IoT Hub のデバイス ツインの理解と使用][lnk-device-twin]」を参照してください。

## <a name="create-a-deployment"></a>デプロイの作成

1. [Azure Portal][lnk-portal] で IoT Hub に移動します。 
1. **[IoT Edge (preview)]\(IoT Edge (プレビュー)\)** を選択します。
1. **[Add IoT Edge Deployment]\(IoT Edge の展開の追加\)** を選びます。

デプロイを作成するには、5 つの手順があります。 次のセクションで、手順ごとに説明します。 

### <a name="step-1-name-and-label"></a>手順 1: 名前とラベル

1. 展開に一意名を付けます。 スペースや、無効な文字は使用しないでください。`& ^ [ ] { } \ | " < > /`
1. デプロイを追跡するためのラベルを追加します。 ラベルは、デプロイを説明する、**[名前]** と **[値]** で一組になっています。 たとえば、`HostPlatform, Linux` または `Version, 3.0.1` です。
1. **[次へ]** を選択して手順 2 に進みます。 

### <a name="step-2-add-modules-optional"></a>手順 2: モジュールの追加 (省略可能)

デプロイに追加できるモジュールは 2 種類あります。 1 つめは、ストレージ アカウントや Stream Analytics などの Azure サービスを使用するモジュールです。 2 つめは、ユーザー独自のコードを使用するモジュールです。 各種類の複数のモジュールをデプロイに追加できます。 

モジュールを含まない展開を作成すると、デバイスから既存のモジュールが削除されます。 

>[!NOTE]
>Azure Machine Learning および Azure Functions では、自動化された Azure サービスの展開はまだサポートされていません。 デプロイにそれらのサービスを手動で追加するには、カスタム モジュールの展開を使用します。 

Azure Stream Analytics からモジュールを追加するには、次の手順を実行します。
1. **[Import Azure Stream Analytics IoT Edge module]\(Azure Stream Analytics IoT Edge モジュールのインポート\)** を選択します。
1. ドロップダウン メニューを使用して、展開する Azure サービスのインスタンスを選択します。
1. **[保存]** を選択してデプロイにモジュールを追加します。 

モジュールとしてカスタム コードを追加する、または Azure のサービス モジュールを手動で追加するには、次の手順を実行します。
1. **[Add IoT Edge module]\(IoT Edge モジュールの追加\)** を選択します。
1. モジュールに **[名前]** を付けます。
1. **[イメージの URL]** フィールドに、モジュールの Docker コンテナー イメージを入力します。 
1. コンテナーに渡す **[Container Create Options]\(コンテナー作成オプション\)** を指定します。 詳細については、[Docker の作成][lnk-docker-create]に関するページを参照してください。
1. ドロップダウン メニューを使用して、**[再起動ポリシー]** を選択します。 次のオプションから選択します。 
   * **[Always]\(常時\)** - 何らかの理由でシャット ダウンした場合に必ずモジュールを再起動します。
   * **[Never]\(再起動しない\)** - 何らかの理由でシャット ダウンした場合でも、モジュールは再起動されません。
   * **[On-failed]\(障害時\)** - クリーンなシャットダウンではなく、クラッシュした場合に、モジュールを再起動します。 
   * **[On-unhealthy]\(異常時\)**-モジュールがクラッシュまたは異常な状態を返したときに再起動します。 正常性ステータス関数を実装するかどうかは、各モジュールによって異なります。 
1. ドロップダウン メニューを使用してモジュールの **[Desired Status]\(目的の状態\)** を選択します。 次のオプションから選択します。
   * **[実行中]** - これが既定のオプションです。 モジュールは、展開された後すぐに実行が開始されます。
   * **[停止]** - 展開された後、ユーザーまたは別のモジュールによって開始されるまで、モジュールはアイドル状態になります。
1. モジュール ツインにタグまたは必要なプロパティを追加する場合は、**[有効化]** を選択します。 
1. **[保存]** を選択してデプロイにモジュールを追加します。 

展開するすべてのモジュールを構成したら、**[次へ]** を選択して手順 3 に進みます。

### <a name="step-3-specify-routes-optional"></a>手順 3: ルートの指定 (省略可能)

ルートは、デプロイ内のモジュール間の通信方法を定義します。 デプロイのルートを指定し、**[次へ]** を選択して手順 4 に進みます。 

### <a name="step-4-target-devices"></a>手順 4: 対象デバイス

このデプロイの対象となるデバイスを、デバイスからのタグ プロパティを使用して指定します。 

同じデバイスが複数のデプロイの対象となっている場合があるため、各デプロイに優先順位番号を付ける必要があります。 競合した場合は、優先度が高いデプロイが優先されます。 2 つのデプロイの優先度が同じ場合は、作成された時期が最近のデプロイが優先されます。 

1. デプロイの**[優先度]** を正の整数で入力します。
1. どのデバイスがこのデプロイの対象となるかを指定する **[Target condition]\(対象の条件\)**を入力します。 条件はデバイス ツイン タグに基づいており、式の形式に一致する必要があります。 たとえば、「`tags.environment='test'`」のように入力します。 
1. **[次へ]** を選択して最後の手順に進みます。

### <a name="step-5-review-template"></a>手順 5: テンプレートのレビュー

デプロイ情報を確認し、**[送信]** を選択します。

## <a name="monitor-a-deployment"></a>デプロイの監視

デプロイの詳細を確認し、それを実行するデバイスを監視するには、次の手順を実行します。

1. [Azure Portal][lnk-portal] にサインインし、IoT ハブに移動します。 
1. **[IoT Edge (preview)]\(IoT Edge (プレビュー)\)** を選択します。
1. **[IoT Edge deployments]\(IoT Edge デプロイ\)** を選択します。 

   ![IoT Edge デプロイの表示][1]

1. デプロイの一覧を確認します。 デプロイごとに、次の詳細を表示できます。
   * **[ID]** - デプロイの名前。
   * **[Target condition]\(対象の条件\)** - 対象となるデバイスを定義するためのタグ。
   * **[優先度]** - デプロイに割り当てられた優先順位番号。
   * **[IoT Edge agent status]\(IoT Edge エージェントの状態\)** - デプロイが適用されたデバイスの数とその正常状態。 
   * **[Unhealthy modules]\(異常なモジュール\)** - エラーを報告したデプロイ内のモジュールの数。 
   * **[作成時刻]** - デプロイが作成されたときからのタイムスタンプ。 2 つのデプロイの優先順位が同じ場合に、このタイムスタンプを使用して優先するデプロイを決定します。 
1. 監視するデプロイを選択します。  
1. デプロイの詳細を確認します。 デプロイが適用されたデバイスに関する特定の詳細情報を表示するには、タブを使用します。 
   * **[対象]** - 対象の条件と一致する Edge デバイス。 
   * **[適用済み]** - 優先度の高い他のデプロイの対象となっていない対象 Edge デバイス。 これらは、実際にデプロイが適用されるデバイスです。 
   * **[Reporting success]\(成功を報告\)** - モジュールの展開が成功したことをサービスに報告した適用済みの Edge デバイス。 
   * **[Reporting failure]\(失敗を報告\)** - 1 つまたは複数のモジュールの展開が失敗したことをサービスに報告した適用済みの Edge デバイス。 エラーの調査を進めるには、これらのデバイスにリモート接続し、ログ ファイルを参照する必要があります。 
   * **[Reporting unhealthy modules]\(モジュールの異常を報告\)** - 1 つまたは複数のモジュールの展開が成功したことをサービスに報告したが、現在エラーを報告している適用済みの Edge デバイス。 

## <a name="modify-a-deployment"></a>デプロイの変更

デプロイを変更すると、変更はすべての対象デバイスにただちにレプリケートされます。 

対象の条件を更新すると、次の更新が実行されます。
* デバイスが古い対象条件を満たさないが、新しい対象条件を満たしており、このデプロイのそのデバイスに対する優先度が最も高い場合は、このデプロイは、このデバイスに適用されます。 
* このデプロイを現在実行しているデバイスが対象条件を満たさなくなった場合、このデプロイはアンインストールされ、次に優先度の高いデプロイが適用されます。 
* このデプロイを現在実行しているデバイスが対象条件を満たさなくなり、他のデプロイの対象条件を満たさない場合は、デバイスではなにも変更されません。 デバイスは現在の状態で現在のモジュールを実行し続けますが、このデプロイの一部としては管理されなくなります。 デバイスが他のデプロイの対象の条件を満たすと、このデプロイはアンインストールされ、新しいデプロイが適用されます。 

デプロイを変更するには、次の手順を実行します。 

1. [Azure Portal][lnk-portal] にサインインし、IoT ハブに移動します。 
1. **[IoT Edge (preview)]\(IoT Edge (プレビュー)\)** を選択します。
1. **[IoT Edge deployments]\(IoT Edge デプロイ\)** を選択します。 

   ![IoT Edge デプロイの表示][1]

1. 変更するデプロイを選択します。 
1. 次のフィールドに変更を加えます。 
   * ターゲット条件 
   * ラベル 
   * 優先順位 
1. **[保存]** を選択します。
1. [デプロイの監視][anchor-monitor]に記載された手順に従って、変更が適用されることを確認します。 

## <a name="delete-a-deployment"></a>デプロイの削除

デプロイを削除すると、デバイスには、次に高い優先順位のデプロイが適用されます。 デバイスが他のいずれのデプロイの対象条件も満たさない場合、デプロイが削除されても、モジュールは削除されません。 

1. [Azure Portal][lnk-portal] にサインインし、IoT ハブに移動します。 
1. **[IoT Edge (preview)]\(IoT Edge (プレビュー)\)** を選択します。
1. **[IoT Edge deployments]\(IoT Edge デプロイ\)** を選択します。 

   ![IoT Edge デプロイの表示][1]

1. チェックボックスを使用して、削除するデプロイを選択します。 
1. **[削除]**を選択します。
1. この操作によりこのデプロイが削除され、すべてのデバイスが以前の状態に戻されることを警告する、プロンプトが表示されます。  これにより、優先度の低いデプロイが適用されます。  対象となっているデプロイがない場合は、モジュールは削除されません。 お客様がモジュールの削除を希望する場合は、モジュールがないデプロイを作成し、同じデバイスに展開する必要があります。 先に進むには、**[はい]** を選択します。 

## <a name="next-steps"></a>次の手順

詳細については [Edge デバイスへのモジュールの展開][lnk-deployments]を参照してください。

<!-- Images -->
[1]: ./media/how-to-deploy-monitor/iot-edge-deployments.png

<!-- Links -->
[lnk-device-twin]: ../iot-hub/iot-hub-devguide-device-twins.md
[lnk-portal]: https://portal.azure.com
[lnk-docker-create]: https://docs.docker.com/engine/reference/commandline/create/
[lnk-deployments]: module-deployment-monitoring.md

<!-- Anchor links -->
[anchor-monitor]: #monitor-a-deployment
