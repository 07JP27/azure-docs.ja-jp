<properties 
   pageTitle="Service Bus のアーキテクチャ"
   description="Azure Service Bus のメッセージ処理アーキテクチャについて説明します。"
   services="service-bus"
   documentationCenter="na"
   authors="sethmanheim"
   manager="timlt"
   editor="tysonn" />
<tags 
   ms.service="service-bus"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="tbd"
   ms.date="07/24/2015"
   ms.author="sethm" />

# Service Bus のアーキテクチャ

次のセクションでは、Azure Service Bus のメッセージ処理アーキテクチャについて説明します。

## Service Bus スケール ユニット

Service Bus は、*スケール ユニット*別に編成されます。スケール ユニットはデプロイの単位であり、サービスの実行に必要なコンポーネントをすべては含みます。各リージョンでは、1 つまたは複数の Service Bus スケール ユニットをデプロイします。

Service Bus の名前空間は、スケール ユニットにマップされます。スケール ユニットは、すべての種類の Service Bus エンティティを処理します。これらには、リレー、仲介型メッセージング エンティティ (キュー、トピック、サブスクリプション)、および通知ハブがあります。Service Bus スケール ユニットは、次のコンポーネントで構成されています。

- **ゲートウェイ ノードのセット。** ゲートウェイ ノードは、受信要求を認証し、リレー要求を処理します。各ゲートウェイ ノードには、パブリック IP アドレスが割り当てられます。

- **メッセージング ブローカー ノード。** メッセージング ブローカー ノードは、メッセージング エンティティに関する要求を処理します。

- **通知ノードのセット。** 通知ノードは、すべての登録済みデバイスにプッシュ通知を送信します。

- **1 つのゲートウェイ ストア。** ゲートウェイ ストアは、このスケール ユニット内に定義されているすべてのエンティティのデータを保持します。ゲートウェイ ストアは、SQL Azure データベース上に実装されます。

- **多数のメッセージング ストア。** メッセージング ストアは、このスケール ユニット内に定義されているすべてのキュー、トピック、およびサブスクリプションのメッセージを保持します。また、すべてのサブスクリプション データも含まれています。[メッセージング エンティティのパーティション分割](https://msdn.microsoft.com/library/azure/dn520246.aspx)が有効でない限り、キューまたはトピックが 1 つメッセージング ストアにマップされます。サブスクリプションは、その親トピックと同じメッセージング ストアに格納されます。メッセージング ストアは、SQL Azure データベース上に実装されます。

- **複数の登録ストア。** 登録ストアには、このスケール ユニット内に定義されているすべての通知ハブに対するデバイス登録が含まれています。登録ストアは、SQL Azure データベース上に実装されます。

## コンテナー

各メッセージング エンティティには、特定のコンテナーが割り当てられます。コンテナーとは、1 つのメッセージング ストアだけを使用して、このコンテナーのすべての関連データを格納する論理構成です。各コンテナーは、メッセージング ブローカー ノードに割り当てられます。通常、メッセージング ブローカー ノードよりもコンテナーの数が多くなります。そのため、各メッセージング ブローカー ノードは、複数のコンテナーを読み込みます。メッセージング ブローカー ノードに対するコンテナーの配分は、すべてのメッセージング ブローカー ノードが均等に読み込まれるように編成されています。読み込みパターンが変わった場合 (たとえば、1 つのコンテナーの負荷が非常に大きくなった場合)、またはメッセージング ブローカー ノードが一時的に使用できなくなった場合は、メッセージング ブローカー ノード間で、コンテナーが再配分されます。

## 受信メッセージ要求の処理

クライアントが Service Bus に要求を送信すると、その要求が Azure Load Balancer によってゲートウェイ ノードのいずれかにルーティングされます。ゲートウェイ ノードは、要求を承認します。要求がメッセージング エンティティ (キュー、トピック、サブスクリプション) に関連する場合は、ゲートウェイ ノードはゲートウェイ ストア内のエンティティを検索し、どのメッセージング ストアにエンティティがあるかを特定します。その後、現在どのメッセージング ブローカー ノードがこのコンテナーにサービスを提供しているかを調べ、そのメッセージング ブローカー ノードに要求を送信します。メッセージング ブローカー ノードは、要求を処理し、コンテナー ストア内のエンティティの状態を更新します。その後、メッセージング ブローカー ノードはゲートウェイ ノードに応答を送信します。ゲートウェイ ノードは、元の要求を発行したクライアントに適切な応答を送信します。

![Processing of Incoming Messaging Requests](./media/service-bus-architecture/IC690644.png)

## 受信リレー要求の処理

クライアントが Service Bus に要求を送信すると、その要求が Azure Load Balancer によってゲートウェイ ノードのいずれかにルーティングされます。要求がリッスン要求である場合は、ゲートウェイ ノードは新しいリレーを作成します。要求が特定のリレーへの接続要求の場合は、ゲートウェイ ノードはリレーを所有するゲートウェイ ノードに接続要求を転送します。リレーを所有するゲートウェイ ノードは、リッスンしているクライアントにランデブー要求を送信します。その際、接続要求を受信したゲートウェイ ノードへの一時的なチャネルを作成するようリスナーに求めます。

リレー接続が確立されると、クライアントはランデブーに使用されるゲートウェイ ノードを経由してメッセージを交換できます。

![Processing of Incoming Relay Requests](./media/service-bus-architecture/IC690645.png)

## 通知ハブの受信要求の処理

クライアントが Service Bus に要求を送信すると、その要求が Azure Load Balancer によってゲートウェイ ノードのいずれかにルーティングされます。要求が既存の通知ハブに対するデバイス登録である場合、ゲートウェイ ノードは、登録を登録ストアに書き込み、呼び出し元のデバイスに返信を送信します。要求が通知メッセージである場合は、ゲートウェイ ノードが通知キューにメッセージを登録します。通知ノードの 1 つは、通知キューからメッセージを削除し、登録ストアに登録されているすべてのデバイスにメッセージを送信します。メッセージが多数のデバイスで受信される場合は、複数の通知ノードがデバイスへのメッセージの送信に関与します。

![Processing of Incoming Notification Hub Requests](./media/service-bus-architecture/IC690646.png)

## 次のステップ

ここまで、Service Bus のしくみの概要を説明しました。使用を開始するには、次のリンクを参照してください。

- [Service Bus メッセージングの概要](service-bus-messaging-overview.md)
- [Service Bus の基礎](service-bus-fundamentals-hybrid-solutions.md)
- [Service Bus キューを使用するキューに格納されたメッセージング ソリューション](service-bus-dotnet-multi-tier-app-using-service-bus-queues.md)

<!---HONumber=July15_HO5-->