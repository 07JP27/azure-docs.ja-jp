<properties 
   pageTitle="入れ子になった Traffic Manager プロファイル | Microsoft Azure"
   description="この記事では、Azure Traffic Manager の ";入れ子になったプロファイル"; 機能について説明します。"
   services="traffic-manager"
   documentationCenter=""
   authors="sdwheeler"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/25/2016"
   ms.author="sewhee" />

# 入れ子になった Traffic Manager プロファイル

Traffic Manager では、さまざまなトラフィック ルーティング方法を使用して、Traffic Manager が各エンド ユーザーからのトラフィックを受信するエンドポイントを選択する方法を制御できます。トラフィック ルーティング方法については、「[Traffic Manager のトラフィック ルーティング方法](traffic-manager-routing-methods.md)」をご覧ください。トラフィック ルーティング方法により、Traffic Manager は最も一般的なトラフィック ルーティング要件に対応できます。

Traffic Manager プロファイルごとに 1 つのトラフィック ルーティング方法を指定します。ただし、より複雑なアプリケーションでは、単一の Traffic Manager プロファイルで提供できるものよりも高度なトラフィック ルーティングが必要になる場合もあります。

このような複雑なアプリケーションをサポートするために、Traffic Manager では Traffic Manager プロファイルを組み合わせる、つまりは*入れ子にする*ことができます。これにより、2 つのアプリケーションで複数のトラフィック ルーティング方法を使用することによるメリットが得られます。入れ子になったプロファイルを使用すると、柔軟性の高い強力なトラフィック ルーティング スキームを作成して、より大規模で複雑なデプロイメントのニーズに対応できます。

また、入れ子になったプロファイルでは、リージョン内でのトラフィックのルーティングや、パフォーマンス トラフィック ルーティング使用時のフェールオーバーなど、場合によっては、Traffic Manager の既定の動作を上書きできます。

このページの残りの部分では、一連の例を使って、入れ子になった Traffic Manager プロファイルをさまざまなシナリオで使用する方法について説明します。最後に、入れ子になったプロファイルについてよく寄せられる質問を紹介します。

## 例 1: "パフォーマンス" トラフィック ルーティングと "加重" トラフィック ルーティングの組み合わせ

アプリケーションが複数の Azure リージョン (米国西部、西ヨーロッパ、東アジア) にデプロイされているとします。Traffic Manager の "パフォーマンス" トラフィック ルーティング方法を使用して、ユーザーに最も近いリージョンにトラフィックを振り分けます。

![単一の Traffic Manager プロファイル][1]

次に、サービスの更新を広くロールアウトする前に、少数のユーザーで試してみる必要があるとします。この場合、"加重" トラフィック ルーティング方法を使用することで、トラフィックのごく一部を試用デプロイメントに送信できます。単一プロファイルでは、"加重" と "パフォーマンス" のトラフィック ルーティングを組み合わせることはできません。入れ子になったプロファイルを使用すると、この両方を実行できます。

その方法を説明します。たとえば、新しいデプロイメントを西ヨーロッパで試したいとします。この場合、既存の運用環境デプロイメントと共にに試用デプロイメントをセットアップし、この 2 つのエンドポイントと "加重" トラフィック ルーティング方法を使用して Traffic Manager プロファイルを作成します。次に、この "子" プロファイルを "親" プロファイルにエンドポイントとして追加します。"親" プロファイルでは、パフォーマンス トラフィック ルーティング方法が引き続き使用され、エンドポイントとして他のグローバル デプロイメントも含まれています。

次の図にこの例を示します。

![入れ子になった Traffic Manager プロファイル][2]

この配置では、親プロファイルを経由して送信されるトラフィックは、通常どおり各リージョンに振り分けられます。西ヨーロッパ内では、割り当てられた重みに従って、運用環境デプロイメントと試用デプロイメントにトラフィックが送信されます。

親プロファイルで "パフォーマンス" トラフィック ルーティング方法を使用するときは、各エンドポイントの場所がわかっている必要があります。入れ子になったエンドポイントの場合、外部エンドポイントに関して、この場所をエンドポイント構成の一部として指定する必要があります。使用するデプロイメントに最も近い Azure リージョンを選択します。Azure リージョンは、インターネット待機時間テーブルでサポートされている場所であるため選択可能です。詳細については、[Traffic Manager の "パフォーマンス" トラフィック ルーティング方法](traffic-manager-routing-methods.md#performance-traffic-routing-method)に関するセクションをご覧ください。

## 例 2: 入れ子になったプロファイルでのエンドポイントの監視

Traffic Manager は、各サービス エンドポイントの正常性をアクティブに監視します。エンドポイントが異常であると判断された場合、Traffic Manager はユーザーを代替エンドポイントにルーティングすることで、サービスの全体的な可用性を維持します。このエンドポイントの監視とフェールオーバーの動作は、すべてのトラフィック ルーティング方法に適用されます。詳細については、[Traffic Manager のエンドポイント監視](traffic-manager-monitoring.md)に関する記事をご覧ください。

入れ子になったプロファイルの場合、特別なエンドポイント監視ルールが適用されます。親プロファイルに子プロファイルが入れ子になったエンドポイントとして構成されている場合、親が子の正常性チェックを直接実行するわけではありません。代わりに、子プロファイルのエンドポイントの正常性を使用して、子プロファイル全体の正常性が計算されます。この情報が入れ子になったプロファイル階層に伝達され、親プロファイル内の入れ子になったエンドポイントの正常性が判断されます。この判断によって、親プロファイルがトラフィックを子に送信するかどうかが決定されます。親プロファイルの入れ子になったエンドポイントの正常性が子プロファイルの正常性から計算されるしくみの詳細については、[こちら](#faq)をご覧ください。

例 1 に戻って、西ヨーロッパの運用環境デプロイメントで障害が発生したとします。既定では、"子" プロファイルはすべてのトラフィックを試用デプロイメントに送信します。試用デプロイメントでも障害が発生した場合、親プロファイルは、すべての子エンドポイントが異常であるため、子プロファイルはトラフィックを受信できないと判断し、西ヨーロッパのすべてのトラフィックを他のリージョンにフェールオーバーします。

![入れ子になったプロファイルのフェールオーバー (既定の動作)][3]

この配置で問題ない場合もありますが、西ヨーロッパのすべてのトラフィックのフェールオーバーとして試用デプロイメントを使用することに懸念があり、西ヨーロッパの運用環境デプロイメントで障害が発生した場合は、試用デプロイメントの正常性に*関係なく*、他のリージョンにフェールオーバーする方が望ましい場合もあります。次のような方法もあります。子プロファイルを親プロファイルのエンドポイントとして構成するときに、"MinChildEndpoints" パラメーターを指定します。このパラメーターは、子プロファイルで使用できる必要があるエンドポイントの最小数を指定するものです。このしきい値 (既定値は 1) を下回ると、親プロファイルは子プロファイル全体を使用不可と見なし、トラフィックを他の親プロファイル エンドポイントに送信します。

次の例では、MinChildEndpoints の値が 2 に設定されています。この場合、西ヨーロッパのいずれかのデプロイメントで障害が発生すると、親プロファイルは子プロファイルがトラフィックを受信できないと判断し、ユーザーを他のリージョンにルーティングします。

!["MinChildEndpoints" が 2 に設定された入れ子になったプロファイルのフェールオーバー][4]

子プロファイルで "優先順位" トラフィック ルーティング方法を使用すると、その子へのすべてのトラフィックが 1 つのエンドポイントで受信されます。そのため、この場合、MinChildEndpoints を "1" 以外の値に設定してもほとんど意味はありません。

## 例 3: "パフォーマンス" トラフィック ルーティングにおける優先フェールオーバー リージョン

"パフォーマンス" トラフィック ルーティングを使用する単一プロファイルがあり、エンドポイント (西ヨーロッパなど) で障害が発生した場合、そのエンドポイントに送信されていたすべてのトラフィックが、代わりに全リージョンの他のエンドポイントに分散されます。これは、次に最も近いエンドポイントが過負荷になり、連鎖的な障害が発生するのを防ぐことを目的とした、"パフォーマンス" トラフィック ルーティング方法の既定の動作です。

![既定のフェールオーバーを使用する "パフォーマンス" トラフィック ルーティング][5]

西ヨーロッパのトラフィックをなるべく米国西部にフェールオーバーし、これらのエンドポイントがどちらも使用できない場合にのみ、他の場所に送信するとします。これを実行するには、次のように、"優先順位" トラフィック ルーティング方法を使用する子プロファイルを作成します。

![優先フェールオーバーを使用する "パフォーマンス" トラフィック ルーティング][6]

西ヨーロッパ エンドポイントは米国西部エンドポイントよりも優先順位が高いため、どちらもオンラインの場合は、すべてのトラフィックが西ヨーロッパ エンドポイントに送信されます。西ヨーロッパで障害が発生した場合、トラフィックは米国西部に送信されます。米国西部でも障害が失敗した場合にのみ、西ヨーロッパのトラフィックは東アジアに送信されます。

親プロファイルの全 3 つのエンドポイントを 3 つの子プロファイルに置き換え、それぞれの子プロファイルで優先フェールオーバー シーケンスを提供することで、すべてのリージョンでこのパターンを繰り返すことができます。

## 例 4: 同じリージョンの複数のエンドポイント間での "パフォーマンス" トラフィック ルーティングの制御

米国西部など、特定のリージョンの複数のエンドポイントを含むプロファイルで "パフォーマンス" トラフィック ルーティング方法が使用されているとします。既定では、そのリージョンに送信されるトラフィックは、そのリージョンの使用可能なすべてのエンドポイントに均等に分散されます。

!["パフォーマンス" トラフィック ルーティングのリージョン内トラフィック分散 (既定の動作)][7]

この既定の動作は、入れ子になった Traffic Manager プロファイルを使用して変更できます。米国西部に複数のエンドポイントを追加するのではなく、それらのエンドポイントを別の子プロファイルに含め、その子プロファイルを米国西部の唯一のエンドポイントとして親に追加することができます。その後、(たとえば) そのリージョン内で優先順位ベースまたは加重のトラフィック ルーティングを有効にすることで、子プロファイルの設定を使用して米国西部でのトラフィック分散を制御できます。

!["パフォーマンス" トラフィック ルーティングのカスタムのリージョン内トラフィック分散][8]

## 例 5: エンドポイントごとの監視設定

従来のオンプレミス Web サイトと Azure でホストされる新しいクラウドベースのバージョン間でトラフィックをスムーズに移行するために、Traffic Manager を使用するとします。従来の Web サイトでは、ホーム ページ (パスは "/") を使用してサイトの正常性を監視しますが、新しいクラウドベースのバージョンでは、その他のチェックも含まれたカスタムの監視ページ (パスは "/monitor.aspx") を実装します。

![Traffic Manager のエンドポイント監視 (既定の動作)][9]

Traffic Manager プロファイルの監視設定は、そのプロファイル内のすべてのエンドポイントに適用されるので、これまでは両方のサイトで同じパスを使用しなければなりませんでした。入れ子になった Traffic Manager プロファイルを使用すると、サイトごとに子プロファイルを使用して、それぞれ異なる監視設定を定義できるようになります。

![エンドポイントごとの設定を使用する Traffic Manager のエンドポイント監視][10]

## FAQ

### 入れ子になったプロファイルを構成するにはどうすればよいですか。

入れ子になった Traffic Manager プロファイルは、Azure Resource Manager (ARM) と Azure Service Management (ASM) REST API (PowerShell コマンドレットとクロスプラットフォームの Azure CLI コマンド) を使用して構成できます。入れ子になった Traffic Manager プロファイルは、Azure ポータルでもサポートされていますが、"クラシック" ポータルではサポートされていません。

### Traffic Manager では、何層の入れ子がサポートされますか。
プロファイルは最大 10 レベルまで入れ子にすることができます。"ループ" は使用できません。

### 同じ Traffic Manager プロファイルに、入れ子になった子プロファイルと他の種類のエンドポイントを混在させることはできますか。

はい。プロファイル内での異なる種類のエンドポイントの組み合わせには制限はありません。

### 入れ子になったプロファイルに対して課金モデルはどのように適用されますか。

入れ子になったプロファイルの使用が料金に悪影響を及ぼすことはありません。

Traffic Manager の課金には、エンドポイントの正常性チェックと数百万の DNS クエリの 2 つの構成要素があります (詳細については、[価格に関するページ](https://azure.microsoft.com/pricing/details/traffic-manager/)をご覧ください)。 これは入れ子になったプロファイルに次のように適用されます。

- エンドポイントの正常性チェック: 親プロファイルのエンドポイントとして構成されている子プロファイルには課金されません。基になるサービスを監視する子プロファイルのエンドポイントには、通常どおり課金されます。

- DNS クエリ: 各クエリは 1 回だけカウントされます。子プロファイルからエンドポイントを返す親プロファイルに対するクエリは、親プロファイルにのみ課金されます。

### 入れ子になったプロファイルでは、パフォーマンスへの影響はありますか。

いいえ。入れ子になったプロファイルを使用しても、パフォーマンスに影響はありません。

Traffic Manager のネーム サーバーは、各 DNS クエリを処理するときにプロファイル階層を内部的にスキャンするので、親プロファイルに対する DNS クエリは子プロファイルのエンドポイントで DNS 応答を受信できます。

そのため、単一の Traffic Manager プロファイルを使用するのと同様に、CNAME レコードが 1 つだけ使用されます。階層内のプロファイルごとに一連の CNAME レコードを必要と**しない**ため、パフォーマンスが低下することはありません。

### Traffic Manager では、子プロファイルの正常性に基づいて、親プロファイルの入れ子になったエンドポイントの正常性をどのように計算するのですか。

親プロファイルに子プロファイルが入れ子になったエンドポイントとして構成されている場合、親が子の正常性チェックを直接実行するわけではありません。代わりに、子プロファイルのエンドポイントの正常性を使用して、子プロファイル全体の正常性が計算されます。この情報が入れ子になったプロファイル階層に伝達され、親プロファイル内の入れ子になったエンドポイントの正常性が判断されます。この判断によって、親プロファイルがトラフィックを子に送信するかどうかが決定されます。

次の表に、子プロファイルを参照する親プロファイルの入れ子になったエンドポイントに対する Traffic Manager 正常性チェックの動作を示します。

|子プロファイル モニターの状態|親エンドポイント監視の状態|メモ|
|---|---|---|
|無効。子プロファイルは、ユーザーによって無効化されています。|停止済み|親エンドポイントの状態は停止で、無効ではありません。無効な状態は、親プロファイルでエンドポイントを無効にしたことを示すために予約されています。|
|低下。1 つ以上の子プロファイル エンドポイントが "低下" 状態です。|オンライン: 子プロファイルの "オンライン" 状態のエンドポイントの数が MinChildEndpoints の値以上です。エンドポイントの確認: 子プロファイルの "オンライン" 状態および "エンドポイントの確認" 状態のエンドポイントの数が MinChildEndpoints の値以上です。低下: それ以外の場合。|トラフィックは、"エンドポイントの確認" 状態のエンドポイントにルーティングされます。MinChildEndpoints の設定値が大きすぎると、エンドポイントは常に "低下" 状態になります。|
|オンライン。1 つ以上の子プロファイル エンドポイントが "オンライン" 状態であり、いずれも "低下" 状態ではありません。|上記を参照してください。||
|エンドポイントの確認。1 つ以上の子プロファイル エンドポイントが "エンドポイントの確認" 状態であり、いずれも "オンライン" 状態または "低下" 状態ではありません。|上記と同じです。||
|非アクティブ。すべての子プロファイル エンドポイントが "無効" 状態または "停止済み" 状態であるか、プロファイルにエンドポイントがありません。|停止済み||


## 次のステップ

[Traffic Manager のしくみ](traffic-manager-how-traffic-manager-works.md)の詳細を確認する

[Traffic Manager プロファイルの作成](traffic-manager-manage-profiles.md)方法を確認する

<!--Image references-->
[1]: ./media/traffic-manager-nested-profiles/figure-1.png
[2]: ./media/traffic-manager-nested-profiles/figure-2.png
[3]: ./media/traffic-manager-nested-profiles/figure-3.png
[4]: ./media/traffic-manager-nested-profiles/figure-4.png
[5]: ./media/traffic-manager-nested-profiles/figure-5.png
[6]: ./media/traffic-manager-nested-profiles/figure-6.png
[7]: ./media/traffic-manager-nested-profiles/figure-7.png
[8]: ./media/traffic-manager-nested-profiles/figure-8.png
[9]: ./media/traffic-manager-nested-profiles/figure-9.png
[10]: ./media/traffic-manager-nested-profiles/figure-10.png

<!---HONumber=AcomDC_0824_2016-->