<properties 
   pageTitle="Traffic Manager - トラフィック ルーティング方法 | Microsoft Azure"
   description="この記事では、Traffic Manager で使用されるさまざまなトラフィック ルーティング方法について説明します。"
   services="traffic-manager"
   documentationCenter=""
   authors="jtuliani"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="traffic-manager"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/25/2016"
   ms.author="jtuliani" />

# Traffic Manager のトラフィック ルーティング方法

このページでは、Azure Traffic Manager でサポートされるトラフィック ルーティング方法について説明します。トラフィック ルーティング方法は、エンド ユーザーを適切なサービス エンドポイントにルーティングするために使用されます。

> [AZURE.NOTE] Traffic Manager の Azure Resource Manager (ARM) API では、Azure Service Management (ASM) API とは異なる用語を使用します。この変更は、よりわかりやすくし、よくある誤解を減らすために、お客様からのフィードバックに従って導入されました。このページでは、ARM の用語を使用します。違いは次のとおりです。

>- ARM では、特定の時点での特定のエンド ユーザーのルーティング先となるエンドポイントを決定する際に使用するアルゴリズムを "トラフィック ルーティング方法" と呼びます。ASM では、これは "負荷分散方法" と呼ばれていました。

>- ARM では、エンドポイントごとに定義された重みに基づいて、使用可能なすべてのエンドポイントにトラフィックを分散させるトラフィック ルーティング方法を "加重" と呼びます。ASM では、これは "ラウンド ロビン" と呼ばれていました。
>- ARM では、順序指定されたリスト内で最初に使用可能となったエンドポイントにすべてのトラフィックを送信するトラフィック ルーティング方法を "優先" と呼びます。ASM では、これは "フェールオーバー" と呼ばれていました。

> いずれの場合も違いは名前だけです。機能に違いはありません。


Azure Traffic Manager では、エンド ユーザーをさまざまなサービス エンドポイントにルーティングする方法を決定する複数のアルゴリズムをサポートします。これらは、トラフィック ルーティング方法と呼ばれます。トラフィック ルーティング方法は、DNS 応答先のエンドポイントを決定するために、受信した各 DNS クエリに適用されます。

Traffic Manager では、次の 3 つのトラフィック ルーティング方法を使用できます。

- **優先順位:** すべてのトラフィックにプライマリ サービス エンドポイントを使用し、プライマリ エンドポイントまたはバックアップ エンドポイントが使用できない場合に備えてバックアップを用意する場合は、"優先順位" を選択します。詳細については、「[優先順位トラフィック ルーティング方法](#priority-traffic-routing-method)」をご覧ください。

- **加重:** 一連のエンドポイントに、均等にまたは定義した重みに従ってトラフィックを分散させる場合は、"加重" を選択します。詳細については、「[加重トラフィック ルーティング方法](#weighted-traffic-routing-method)」をご覧ください。

- **パフォーマンス**: 複数のエンドポイントが地理的に異なる場所にあり、エンド ユーザーが、ネットワーク待ち時間が最も短いという意味で "最も近い" エンドポイントを使用できるようにする場合は、"パフォーマンス" を選択します。詳細については、「[パフォーマンス トラフィック ルーティング方法](#performance-traffic-routing-method)」をご覧ください。

> [AZURE.NOTE] すべての Traffic Manager プロファイルには、エンドポイントの正常性とエンドポイントの自動フェールオーバーの継続的な監視が含まれます。これは、すべてのトラフィック ルーティング方法でサポートされています。詳細については、[Traffic Manager のエンドポイント監視](traffic-manager-monitoring.md)に関する記事をご覧ください。

1 つの Traffic Manager プロファイルで使用できるトラフィック ルーティング方法は 1 つに限られます。プロファイルの別のトラフィック ルーティング方法をいつでも選択できます。変更は 1 分以内に適用され、ダウンタイムは発生しません。入れ子になった Traffic Manager プロファイルを使用することで、トラフィック ルーティング方法を組み合わせることができます。これにより、高度で柔軟性のあるトラフィック ルーティング構成を作成して、より大規模で複雑なアプリケーションのニーズに対応できます。詳細については、「[入れ子になった Traffic Manager プロファイル](traffic-manager-nested-profiles.md)」をご覧ください。

## 優先順位トラフィック ルーティング方法

多くの場合、組織ではサービスの信頼性を提供したいと考えており、主要なサービスがダウンした場合に備えて 1 つ以上のバックアップ サービスを用意することでこれを実行しています。"優先順位" トラフィック ルーティング方法を使用すると、Azure ユーザーはこのフェールオーバー パターンを簡単に実装できます。

![Azure Traffic Manager の "優先" トラフィック ルーティング方法][1]

Traffic Manager プロファイルは、サービス エンドポイントの優先順位リストを使用して構成されます。既定では、すべてのエンド ユーザー トラフィックは、プライマリ (優先順位が一番高い) エンドポイントに送信されます。(構成済みのエンドポイントの有効/無効状態と継続的なエンドポイント監視に基づき) プライマリ エンドポイントが使用できない場合、ユーザーは 2 番目のエンドポイントにルーティングされます。プライマリとセカンダリのどちらのエンドポイントも使用できない場合、トラフィックは 3 番目のエンドポイントに送信されます。以降も同様です。

エンドポイントの優先順位の構成方法は、ARM API (および新しい Azure ポータル) と ASM API (およびクラシック ポータル) で異なります。

- ARM API では、エンドポイントごとに定義された "priority" プロパティを使用して、エンドポイントの優先順位が明示的に構成されます。このプロパティには、1 から 1000 の値を指定する必要があります。値が小さいほど優先順位が高くなります。2 つのエンドポイントが同じ優先順位値を共有することはできません。このプロパティは省略可能です。省略した場合、エンドポイントの順序に基づく既定の優先順位が使用されます。

- ASM API では、プロファイル定義でエンドポイントが列挙されている順序に基づいて、エンドポイントの優先順位が暗黙的に構成されます。Azure "クラシック" ポータルのプロファイルの [構成] ページで、フェールオーバーの順序を構成することもできます。

## 加重トラフィック ルーティング方法

高可用性とサービス使用率の最大化の両方を実現する一般的な方法として、一連のエンドポイントを提供し、すべてのエンドポイントに、均等にまたは定義済みの加重を使用してトラフィックを分散させます。これは、"加重" トラフィック ルーティング方法によってサポートされます。

![Azure Traffic Manager の "加重" トラフィック ルーティング方法][2]

加重トラフィック ルーティング方法では、Traffic Manager プロファイル構成の一部として、各エンドポイントに重みが割り当てられます。各重みは 1 から 1000 の整数です。このパラメーターは省略可能です。省略した場合、既定の重みの "1" が使用されます。
  
エンド ユーザー トラフィックは、(構成済みのエンドポイントの有効/無効状態と継続的なエンドポイント監視に基づいて) 使用可能なすべてのサービス エンドポイントに割り振られます。受信した DNS クエリごとに、使用可能なエンドポイントと他の使用可能なエンドポイントに割り当てられた重みに基づく確率でランダムにエンドポイントが選択されます。

すべてのエンドポイントに同じ重みを使用すると、トラフィックが均等に分散されます。これは、一連の同一のエンドポイントで使用率を均一にする場合に適しています。一部のエンドポイントの重みを大きくする (または小さくする) と、それらのエンドポイントは DNS からの応答の頻度が増える (または減る) ため、受信するトラフィックが増えます。これにより、次のような多数の役立つシナリオに対応できます。

- アプリケーションの段階的アップグレード: 新しいエンドポイントにルーティングするトラフィックのパーセンテージを割り当て、時間と共に 100% までトラフィックを徐々に増やします。

- Azure へのアプリケーション移行: Azure と外部エンドポイントの両方でプロファイルを作成し、各エンドポイントにルーティングするトラフィックの重みを指定します。

- 追加容量のクラウド バースト: Traffic Manager プロファイルに対応させることで、オンプレミスのデプロイメントをクラウドにすばやく拡張します。クラウドに追加容量が必要なとき、エンドポイントを追加または有効にして、各エンドポイントに送るトラフィックの割り当てを指定します。

加重トラフィック ルーティングは、新しい Azure ポータルを使用して構成できますが、"クラシック" ポータルで重みを構成することはできません。また、Azure PowerShell、Azure CLI、Azure REST API を使用して、ARM と ASM で構成することもできます。

注: DNS 応答は、クライアントとクライアントが DNS クエリの実行に使用する再帰 DNS サーバーの両方でキャッシュされます。加重されたトラフィック分散に対してこのキャッシュが及ぼす可能性のある影響を理解しておくことが重要です。インターネットに接続する一般的なアプリケーションの場合と同様に、クライアントと再帰 DNS サーバーの数が多い場合、トラフィック分散は予想どおりに機能します。ただし、クライアントまたは再帰 DNS サーバーの数が少ない場合は、このキャッシュによってトラフィック分散に大きな偏りが生じる可能性があります。このような状況が発生する可能性のある一般的なユース ケースは次のとおりです。

- 開発環境とテスト環境
- アプリケーション間の通信
- 共通の再帰 DNS インフラストラクチャを共有する限られたユーザー基盤 (組織の従業員など) を対象とするアプリケーション

これらの DNS キャッシュの影響は、Azure Traffic Manager だけでなく、DNS ベースのすべてのトラフィック ルーティング システムに共通するものです。DNS キャッシュの明示的なクリアが回避策になる場合もあれば、別のトラフィック ルーティング方法の方が適している場合もあります。

## パフォーマンス トラフィック ルーティング方法

世界中の複数の場所にエンドポイントをデプロイし、エンド ユーザーをそのユーザーに "最も近い" 場所にルーティングすることで、多くのアプリケーションの応答性を向上させることができます。これが "パフォーマンス" トラフィック ルーティング方法の目的です。

![Azure Traffic Manager の "パフォーマンス" トラフィック ルーティング方法][3]

応答性を最大限に高める場合、"最も近い" エンドポイントが必ずしも地理的な距離で最も近いとは限りません。"パフォーマンス" トラフィック ルーティング方法では、ネットワーク待ち時間を尺度にエンド ユーザーに最も近いエンドポイントを特定します。これは、IP アドレス範囲と各 Azure データセンター間のラウンドトリップ時間を示すインターネット待機時間テーブルによって決定されます。

Traffic Manager は、各受信 DNS 要求を調べ、インターネット待機時間テーブルでその要求の送信元 IP アドレスを調べます。これにより、その IP アドレスから各 Azure データセンターまでの待機時間がわかります。Traffic Manager は、(構成済みのエンドポイントの有効化/無効化状態と継続的なエンドポイント監視に基づいて) 使用可能なエンドポイントの中から待機時間が最も短いエンドポイントを選択し、そのエンドポイントを DNS 応答で返します。そのため、エンド ユーザーは待機時間が最も短いエンドポイントにルーティングされるので、最適なパフォーマンスが得られます。

「[How Traffic Manager Works (Traffic Manager のしくみ)](traffic-manager-how-traffic-manager-works.md)」で説明するように、Traffic Manager は DNS クエリをエンド ユーザーから直接受信するわけではなく、DNS クエリが使用するように構成されている再帰 DNS サービスから受信します。そのため、"最も近い" エンドポイントの特定に使用される IP アドレスはエンド ユーザーの IP アドレスではなく、再帰 DNS サービスの IP アドレスになります。実際には、この IP アドレスはエンド ユーザーにとってこの目的に適したプロキシとなります。

グローバル インターネットの変化と新しい Azure リージョンの追加による変化に対応するために、Traffic Manager は使用するインターネット待機時間テーブルを定期的に更新します。ただし、インターネットでのパフォーマンスや負荷のリアルタイムの変動を考慮することはできません。

Traffic Manager はエンドポイントを監視し、エンドポイントが使用できない場合は DNS クエリの応答にそれらのエンドポイントを含めませんが、パフォーマンス トラフィック ルーティング方法では特定のサービス エンドポイントに対する負荷は考慮されません。

注意する点:

- プロファイルに同じ Azure リージョンの複数のエンドポイントが含まれている場合、そのリージョンに送信されるトラフィックは、(構成済みのエンドポイントの有効化/無効化状態と継続的なエンドポイント監視に基づいて) 使用可能なエンドポイントに均等に分散されます。リージョン内で別のトラフィック分散を使用する場合、これは[入れ子になった Traffic Manager プロファイル](traffic-manager-nested-profiles.md)を使用して実現できます。

- (継続的なエンドポイント監視に基づいて) 特定の Azure リージョンで有効化されているすべてのエンドポイントが "低下" 状態にある場合、これらのエンドポイントへのトラフィックは、次に最も近いエンドポイントではなく、プロファイルで指定されている他のすべての使用可能なエンドポイントに分散されます。これは、次に近いエンドポイントが過負荷になった場合に発生する可能性のある連鎖エラーを回避するのに役立ちます。エンドポイントのフェールオーバー シーケンスを定義する場合は、[入れ子になった Traffic Manager プロファイル](traffic-manager-nested-profiles.md)を使用して定義できます。

- 外部エンドポイントまたは入れ子になったエンドポイントでパフォーマンス トラフィック ルーティング方法を使用する場合は、それらのエンドポイントの場所を指定する必要があります。使用するデプロイに最も近い Azure リージョンを選択します。Azure リージョンは、インターネット待機時間テーブルでサポートされている場所であるため選択可能です。

- 特定のエンド ユーザーに返すエンドポイントを選択するアルゴリズムは確定的であり、ランダム性を伴いません。同じクライアントからの反復 DNS クエリは、同じエンドポイントに送信されます。ただし、特定のユーザーを常に特定のデプロイにルーティングするために (たとえば、そのユーザーのユーザー データが 1 か所にのみ保存されている場合に必要になることがあります)、パフォーマンス トラフィック ルーティング方法に依存しないでください。エンド ユーザーは出張先で通常は異なる再帰 DNS サーバーを使用するので、別のエンドポイントにルーティングされる可能性があるためです。また、エンド ユーザーは、インターネット待機時間テーブルの更新の影響を受ける場合もあります。

- インターネット待機時間テーブルが更新されたときに、一部のクライアントが別のエンドポイントにルーティングされていることに気付く場合があります。影響を受けるユーザーの数を最小限に抑え、現在の待機時間データに基づいてより正確なルーティングが反映されるようにします。これらの更新は、インターネットが継続的に発展する中で、パフォーマンス トラフィック ルーティングの精度を維持するために不可欠となります。


## 次のステップ

[Traffic Manager のエンドポイント監視](traffic-manager-monitoring.md)機能を使用して高可用性アプリケーションを開発する方法を確認する

[Traffic Manager プロファイルの作成](traffic-manager-manage-profiles.md)方法を確認する


<!--Image references-->
[1]: ./media/traffic-manager-routing-methods/priority.png
[2]: ./media/traffic-manager-routing-methods/weighted.png
[3]: ./media/traffic-manager-routing-methods/performance.png

<!---HONumber=AcomDC_0727_2016-->