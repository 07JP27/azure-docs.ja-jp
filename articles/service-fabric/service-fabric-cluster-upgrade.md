<properties
   pageTitle="Service Fabric クラスターのアップグレード | Microsoft Azure"
   description="Service Fabric クラスターを実行している Service Fabric コード、構成、またはその両方をアップグレードします。たとえば、証明書のアップグレード、アプリケーション ポートの追加、OS 修正プログラムの適用などを行います。アップグレードを実行しているときに、どのようなことが起きるでしょうか?"
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="02/16/2016"
   ms.author="chackdan"/>

# Service Fabric クラスターのアップグレード

Azure Service Fabric クラスターは、お客様が所有するものの、Microsoft が部分的に管理するリソースです。この記事では、何が自動的に管理され、何をお客様が構成できるかについて説明します。

## 自動的に管理されるクラスター構成

Microsoft は、クラスターで実行されるファブリック コードと構成を管理します。必要に応じて、ソフトウェアに対して自動的な監視付きアップグレードを実行します。これらのアップグレードは、コード、構成、またはその両方で行うことができます。これらのアップグレードによるアプリケーションへの影響がないか最小限であることを確認するために、アップグレードは次の 3 つのフェーズで行われます。

### フェーズ 1: アップグレードが、すべてのクラスター正常性ポリシーを使用して実行される

このフェーズ中、アップグレード ドメインは 1 つずつ処理され、クラスターで実行されていたアプリケーションはダウンタイムなしで実行され続けます。クラスター正常性ポリシー (ノードの正常性と、クラスターで実行されているすべてのアプリケーションの正常性の組み合わせ) は、アップグレードの実行中、遵守されます。

クラスター正常性ポリシーを満たしていない場合は、アップグレードがロールバックされ、サブスクリプションの所有者に電子メールが送信されます。この電子メールには以下の情報が含まれています。

- クラスターのアップグレードをロールバックする必要があるという通知
- 推奨される対応策 (ある場合)
- フェーズ 2 を実行するまでの日数 (n)。

インフラストラクチャに関する理由でアップグレードに失敗した場合は、同じアップグレードが数回実行されます。電子メールの送信日から n 日後に、フェーズ 2 に進みます。

クラスター正常性ポリシーが満たされた場合は、アップグレードが成功したと見なされ、完了としてマークされます。このフェーズの最初のアップグレードで成功することも、何回目かの再実行で成功することもあります。実行が成功した場合、電子メールでの確認はありません。これは、送信される電子メールが多くなりすぎないようにするためです。電子メールを受信するのは、正常でないことが起きた場合だけです。クラスターのアップグレードの大半は、アプリケーションの可用性に影響することなく、成功すると思われます。

### フェーズ 2: アップグレードが、既定の正常性ポリシーだけを使用して実行される

正常性ポリシーは、アップグレードの開始時に正常だったアプリケーションの数が、アップグレード プロセス中も同じ数であり続けるように設定されています。フェーズ 1 のように、フェーズ 2 中に、アップグレード ドメインが 1 つずつ処理され、クラスターで実行されていたアプリケーションはダウンタイムなしで実行され続けます。クラスター正常性ポリシー (ノードの正常性と、クラスターで実行されているすべてのアプリケーションの正常性の組み合わせ) は、アップグレードの実行中、遵守されます。

有効なクラスター正常性ポリシーを満たしていない場合は、アップグレードがロールバックされ、サブスクリプションの所有者に電子メールが送信されます。この電子メールには以下の情報が含まれています。

- クラスターのアップグレードをロールバックする必要があるという通知
- 推奨される対応策 (ある場合)
- フェーズ 3 を実行するまでの日数 (n)。

インフラストラクチャに関する理由でアップグレードに失敗した場合は、同じアップグレードが数回実行されます。リマインダーの電子メールが、n 日の数日前に送信されます。電子メールの送信日から n 日後に、フェーズ 3 に進みます。フェーズ 2 で送信された電子メールは、真剣に受け止め、修復操作を実行する必要があります。

クラスター正常性ポリシーが満たされた場合は、アップグレードが成功したと見なされ、完了としてマークされます。このフェーズの最初のアップグレードで成功することも、何回目かの再実行で成功することもあります。実行が成功した場合、電子メールでの確認はありません。

### フェーズ 3: アップグレードが、アグレッシブな正常性ポリシーを使用して実行される

これらの正常性ポリシーは、アプリケーションの正常性よりもアップグレードの完了のために調整されています。このフェーズで終了するクラスター アップグレードは、ほとんどありません。クラスターがこのフェーズに達すると、アプリケーションが正常な状態でなくなるか、可用性が失われたりする確率が高くなります。

他の 2 つのフェーズと同様に、フェーズ 3 でもアップグレード ドメインが 1 つずつ処理されます。

有効なクラスター正常性ポリシーが満たされていない場合は、アップグレードがロールバックされます。インフラストラクチャに関する理由でアップグレードに失敗した場合は、同じアップグレードが数回実行されます。その後、そのクラスターはサポートやアップグレードを受信しなくなるように固定されます。

この情報と修復操作が記載された電子メールが、サブスクリプションの所有者に送信されます。クラスターがフェーズ 3 でも失敗する状態になることは、想定していません。

クラスター正常性ポリシーが満たされた場合は、アップグレードが成功したと見なされ、完了としてマークされます。このフェーズの最初のアップグレードで成功することも、何回目かの再実行で成功することもあります。実行が成功した場合、電子メールでの確認はありません。

## お客様が制御するクラスター構成

ライブ クラスターでお客様が変更できる構成は、次のとおりです。

### 証明書

プライマリまたはセカンダリ証明書は、ポータル (下図参照) から、または servicefabric.cluster リソースへの PUT コマンドの発行を通じて、簡単に更新できます。

![Screen shot that shows certificate thumbprints in the Azure portal.][CertificateUpgrade]

>[AZURE.NOTE] クラスター リソースに使用する証明書を特定する前に、次の手順を完了しておく必要があります。この手順を行わなかった場合、新しい証明書は使用されません。1. Key Vault に新しい証明書をアップロードします。手順については、「[Service Fabric クラスターのセキュリティ保護](service-fabric-cluster-security.md)」を参照してください。そのドキュメントの手順 2. から開始します。2.証明書がデプロイされるように、クラスターを構成するすべての仮想マシンを更新します。そのためには、[Azure Key Vault チームのブログ](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx)を参照してください。

### アプリケーション ポート

アプリケーション ポートは、ノードの種類に関連付けられたロード バランサー リソースのプロパティを変更することで変更できます。ポータルを使用することも、リソース マネージャーの PowerShell を直接使用することもできます。

ノードの種類内のすべての VM で新しいポートを開くには、次の手順を行います。

1. 適切なロード バランサーに新しいプローブを追加します。

    ポータルを使用してクラスターをデプロイした場合、ノードの種類ごとのロード バランサーの名前は "loadBalancer-0"、"loadBalancer-1" のようになります。ロード バランサー名はリソース グループ内でのみ一意であるため、検索は特定のリソース グループの下で行うことをお勧めします。

    ![Screen shot that shows adding a probe to a load balancer in the portal.][AddingProbes]

2. ロード バランサーに新しい規則を追加します。

    同じロード バランサーに対して、前の手順で作成したプローブを使用して新しい規則を追加します。

    ![Screen shot that shows adding a new rule to a load balancer in the portal.][AddingLBRules]


### 配置プロパティ

ノードの種類ごとに、アプリケーションで使用するカスタム配置プロパティを追加できます。NodeType は、明示的に追加せずに使用できる、既定のプロパティです。

>[AZURE.NOTE] 配置プロパティの使用方法の詳細については、「[配置の制約の概要](service-fabric-placement-constraint.md)」を参照してください。

### 容量メトリック

ノードの種類ごとに、アプリケーションで負荷をレポートするために使用するカスタム容量メトリックを追加できます。容量メトリックを使用して負荷をレポートする方法の詳細については、「[動的な負荷レポートの概要](service-fabric-resource-balancer-dynamic-load-reporting.md)」を参照してください。

### クラスターを構成する VM の OS 修正プログラム

これは、自動化された機能として提供される予定です。ただし、現時点では、お客様が VM に修正プログラムを適用する必要があります。同時に複数の VM を停止しないように、この操作は、VM 1 つずつで実行する必要があります。

### クラスターを構成する VM の OS アップグレード

クラスターの仮想マシンで OS イメージをアップグレードする必要がある場合は、一度に 1 つの VM で、お客様自身がアップグレードを行う必要があります。現時点では、自動化はできません。

## 次のステップ

- [クラスターの拡大と縮小](service-fabric-cluster-scale-up-down.md)の方法を学習する
- [アプリケーションのアップグレード](service-fabric-application-upgrade.md)の方法を学習する

<!--Image references-->
[CertificateUpgrade]: ./media/service-fabric-cluster-upgrade/CertificateUpgrade.png
[AddingProbes]: ./media/service-fabric-cluster-upgrade/addingProbes.png
[AddingLBRules]: ./media/service-fabric-cluster-upgrade/addingLBRules.png

<!---HONumber=AcomDC_0218_2016-->