<properties
   pageTitle="Service Fabric クラスターのアップグレード | Microsoft Azure"
   description="Service Fabric クラスターを実行しているファブリック コードや構成をアップグレードします。たとえば、証明書のアップグレード、アプリケーション ポートの追加、OS 修正プログラムの適用などを行います。アップグレードを実行しているときに、どのようなことが起きるでしょうか?"
   services="service-fabric"
   documentationCenter=".net"
   authors="ChackDan"
   manager="timlt"
   editor=""/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="11/23/2015"
   ms.author="chackdan"/>

# Service Fabric クラスターのアップグレード

Service Fabric クラスターは、お客様が所有するものの、Microsoft が部分的に管理するリソースです。この記事では、何が自動的に管理され、何をお客様が構成できるかについて説明します。

## 自動的に管理されるクラスター構成

Microsoft は、クラスターで実行されるファブリック コードと構成を保守します。必要に応じて、ソフトウェアへの自動的な監視付きアップグレードを行います。これらのアップグレードは、コード、構成、またはその両方で行うことができます。これらのアップグレードによるアプリケーションへの影響がないか最小限であることを確認するために、アップグレードは 3 つのフェーズで行われます。

### フェーズ 1: アップグレードが、すべてのクラスター正常性ポリシーを使用して実行される

このフェーズ中に、アップグレード ドメインが 1 つずつ処理され、クラスターで実行されていたアプリケーションはダウンタイムなしで実行され続けます。クラスターの正常性ポリシー (ノードの正常性と、クラスターで実行されているすべてのアプリケーションの正常性の組み合わせ) は、アップグレードの実行中、遵守されます。

クラスターの正常性ポリシーが満たされない場合、アップグレードはロールバックされます。クラスターのアップグレードをロールバックしなければならなかったこと、修復操作があれば、それが行われること、後 n 日でフェーズ 2 が実行されることを示す電子メールが、サブスクリプションの所有者に送信されます。インフラが原因でアップグレードが失敗したのではないことを確認するために、同じアップグレードが数回試行され、電子メールの送信日から n 日後にフェーズ 2 に進みます。

クラスターの正常性ポリシーが満たされた場合は、アップグレードが成功したと見なされ、完了としてマークされます。このフェーズの最初のアップグレードで成功することも、何回か目の再実行で成功することもあります。実行が成功した場合、電子メールでの確認はありません。これは、送信される電子メールが多くなりすぎないようにするためです。電子メールを受信するのは、正常でないことが起きた場合だけです。ほとんどのクラスターのアップグレードは、アプリケーションの可用性に影響しないと思われます。

クラスターのカスタム正常性ポリシーを設定する方法の詳細については、「[クラスターのアップグレードと正常性パラメーター](service-fabric-cluster-health-parameters.md)」を参照してください。

### フェーズ 2: アップグレードが、既定の正常性ポリシーだけを使用して実行される

正常性ポリシーは、アップグレードの開始時に正常であったアプリケーションの数が、アップグレード プロセス中も同じ数であり続けるように設定されています。フェーズ 1 のように、このフェーズ中はアップグレード ドメインが 1 つずつ処理され、クラスターで実行されていたアプリケーションはダウンタイムなしで実行され続けます。クラスターの正常性ポリシー (ノードの正常性と、クラスターで実行されているすべてのアプリケーションの正常性の組み合わせ) は、アップグレードの実行中、遵守されます。

クラスターの有効な正常性ポリシーが満たされない場合、アップグレードはロールバックされます。クラスターのアップグレードをロールバックしなければならなかったこと、修復操作があれば、それが行われること、後 n 日でフェーズ 3 が実行されることを示す電子メールが、サブスクリプションの所有者に送信されます。

インフラが原因でアップグレードが失敗したのではないことを確認するために、同じアップグレードが数回試行されます。リマインダーの電子メールが、n 日の数日前に送信されます。電子メールの送信日から n 日後に、フェーズ 3 に進みます。フェーズ 2 で送信された電子メールは、真剣に受け止め、修復操作を実行する必要があります。

クラスターの正常性ポリシーが満たされた場合は、アップグレードが成功したと見なされ、完了としてマークされます。このフェーズの最初のアップグレードで成功することも、何回か目の再実行で成功することもあります。実行が成功した場合、電子メールでの確認はありません。

### フェーズ 3: アップグレードが、アグレッシブな正常性ポリシーを使用して実行される

これらの正常性ポリシーは、アプリケーションの正常性よりもアップグレードの完了のために調整されています。このフェーズで終了するクラスター アップグレードは、ほとんどありません。クラスターがこのフェーズで終了する場合は、アプリケーションが正常な状態でなくなったり、可用性が失われたりする確率が高くなります。

他の 2 つのフェーズと同様に、フェーズ 3 でもアップグレード ドメインが 1 つずつ処理されます。

クラスターの有効な正常性ポリシーが満たされない場合は、アップグレードがロールバックされます。インフラが原因で失敗したのではないことを確認するために、同じアップグレードが数回試行され、その後、そのクラスターはサポートやアップグレードを受信しなくなるように固定されます。

この情報と修復操作が記載された電子メールが、サブスクリプションの所有者に送信されます。クラスターがフェーズ 3 でも失敗する状態になることは、想定していません。

クラスターの正常性ポリシーが満たされた場合は、アップグレードが成功したと見なされ、完了としてマークされます。このフェーズの最初のアップグレードで成功することも、何回か目の再実行で成功することもあります。実行が成功した場合、電子メールでの確認はありません。

## お客様が制御するクラスター構成

ライブ クラスターでお客様が変更できる構成は、次のとおりです。

### 証明書

ポータルから、または servicefabric.cluster リソースへの PUT コマンドの発行を通じて、プライマリまたはセカンダリ証明書を簡単に更新できます。

![CertificateUpgrade][CertificateUpgrade]

**注** クラスター リソースに使用する証明書を特定する前に、次の手順を完了しておく必要があります。この手順を行わなかった場合、新しい証明書は使用されません。1) 新しい証明書を Key Vault にアップロードします。[Service Fabric のセキュリティ](service-fabric-cluster-security.md)に関するページの手順を参照し、手順 2 から開始してください。2) 証明書がデプロイされるように、クラスターを構成するすべての Virtual Machines を更新します。手順については、[このブログの投稿](http://blogs.technet.com/b/kv/archive/2015/07/14/vm_2d00_certificates.aspx)を参照してください。

### アプリケーション ポート

この制御は、ノードのタイプに関連付けられている、ロード バランサーのリソース プロパティを変更することによって行います。ポータルを使用するか、ARM PowerShell で直接行います。

ノード タイプ内のすべての VM の新しいポートを開くには、以下の操作を行う必要があります。

1. **適切なロード バランサーに新しいプローブを追加する**

    ポータルを使用して、クラスターをデプロイした場合、ノード タイプごとのロード バランサーの名前は "loadBalancer-0"、"loadBalancer-1" のようになります。ロード バランサー名はリソース グループ (RG) 内でのみ一意であるため、検索は特定の RG の下で行うことをお勧めします。

    ![AddingProbes][AddingProbes]


2. **ロード バランサーに新しい規則を追加する**

    同じロード バランサーに、前の手順で作成したプローブを使用して、新しい規則を追加します。

    ![AddingLBRules][AddingLBRules]


### 配置プロパティ

  ノードの種類ごとに、アプリケーションで使用するカスタム配置プロパティを追加できます。NodeType は、明示的に追加せずに使用できる、既定のプロパティです。

  >[AZURE.NOTE]配置プロパティの使用方法の詳細については、[配置の制約のドキュメント](service-fabric-placement-constraint.md)を参照してください。

### 容量メトリック

ノードの種類ごとに、アプリケーションで負荷をレポートするために使用するカスタム容量メトリックを追加できます。容量メトリックを使用して負荷をレポートする方法の詳細については、[動的な負荷レポートの概要](service-fabric-resource-balancer-dynamic-load-reporting.md)を参照してください。

### クラスターを構成する Virtual Machines への OS 修正プログラムの適用
これは、準備中の機能です。現時点では、お客様が VM に修正プログラムを適用する必要があります。同時に複数の VM をダウンさせないために、この操作は一度に 1 つずつの VM に行う必要があります。

### クラスターを構成する Virtual Machines での新しい OS へのアップグレード
使用している OS イメージをアップグレードする必要がある場合は、一度に 1 つずつの VM で、お客様自身がアップグレードを行う必要があります。現時点では、自動化はできません。


## 次のステップ

- [クラスターのスケールアップとスケールダウン](service-fabric-cluster-scale-up-down.md)の方法を学習する
- [アプリケーションのアップグレード](service-fabric-application-upgrade.md)の方法を学習する

<!--Image references-->
[CertificateUpgrade]: ./media/service-fabric-cluster-upgrade/CertificateUpgrade.png
[AddingProbes]: ./media/service-fabric-cluster-upgrade/addingProbes.png
[AddingLBRules]: ./media/service-fabric-cluster-upgrade/addingLBRules.png

<!---HONumber=AcomDC_1210_2015-->