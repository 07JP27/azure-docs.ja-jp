---
title: Service Fabric クラスター リソース マネージャー - アプリケーション グループ | Microsoft Docs
description: Service Fabric クラスター リソース マネージャーのアプリケーション グループ機能の概要
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: ''

ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/19/2016
ms.author: masnider

---
# アプリケーション グループの概要
通常、Service Fabric のクラスター リソース マネージャーは、クラスター全体で (メトリックで表される) 負荷を均等に分散することによって、クラスター リソースを管理します。Service Fabric では、クラスター内のノードの容量、および容量の全体的な概念としてクラスターも管理されます。これは、非常に多くの種類のワークロードに適していますが、複数の Service Fabric アプリケーションのインスタンスを頻繁に使用するパターンの場合、追加の要件が生じることがあります。一般的な追加要件の例として、以下が挙げられます。

* 多数のノード上でアプリケーション インスタンスのサービスの容量を予約する機能
* アプリケーション内の指定された一連のサービスの実行が許可されているノードの合計数を制限する機能
* アプリケーション インスタンス内のサービスの数または全体的なリソースの消費量を制限するための、アプリケーション インスタンス自体の容量の定義

これらの要件を満たすため、アプリケーション グループと呼ばれる機能を対象としたサポートを開発しました。

## アプリケーション容量の管理
アプリケーション容量を使用して、アプリケーションによって使用されるノードの数、および個々のノード上にあるアプリケーションのインスタンスの合計メトリック負荷を制限することができます。これを使用して、アプリケーションのクラスター内でリソースを予約することも使用できます。

アプリケーション容量は、新しいアプリケーションの作成時に、これらのアプリケーションに対して設定できます。アプリケーション容量を指定せずに作成された既存のアプリケーションに対しても新しく設定することができます。

### 最大ノード数の制限
アプリケーション容量の最も簡単な使用例は、アプリケーションのインスタンス化を、特定の最大ノード数に制限する必要がある場合です。アプリケーション容量が指定されていない場合は、Service Fabric クラスター リソース マネージャーによって、通常の規則 (負荷分散または最適化) に従ってレプリカがインスタンス化されます。これは通常、サービスがクラスター内のすべての使用可能なノードに対して、または最適化が有効になっている場合には任意の少数のノードに対して分散されることを意味します。

次の図は、最大ノード数が定義されていない状態でのアプリケーション インスタンスの配置と、最大ノード数が設定されている場合の同じアプリケーションの配置を示しています。どのサービスのどのレプリカまたはインスタンスが一緒に配置されるかについては保証されません。

![最大ノード数を定義したアプリケーション インスタンス][Image1]

左の例では、アプリケーションにはアプリケーション容量が設定されておらず、3 つのサービスが含まれます。CRM では、クラスター内の最適なバランスを実現するために、使用可能な 6 つのノードにすべてのレプリカを分散する論理意思決定が行われています。右側の例では、同じアプリケーションが 3 つのノードに限られており、Service Fabric CRM はアプリケーションのサービスのレプリカの最適なバランスを実現していることがわかります。

この動作を制御するパラメーターは、MaximumNodes と呼ばれます。このパラメーターは、アプリケーションの作成時に設定するか、または既に実行中のアプリケーション インスタンスに対して新しく設定することができます。この場合、Serivice Fabric CRM は、アプリケーションのサービスのレプリカを定義された最大ノード数に制限します。

Powershell

``` posh
New-ServiceFabricApplication -ApplicationName fabric:/AppName -ApplicationTypeName AppType1 -ApplicationTypeVersion 1.0.0.0 -MaximumNodes 3
Update-ServiceFabricApplication –Name fabric:/AppName –MaximumNodes 5
```

C#

``` csharp
ApplicationDescription ad = new ApplicationDescription();
ad.ApplicationName = new Uri("fabric:/AppName");
ad.ApplicationTypeName = "AppType1";
ad.ApplicationTypeVersion = "1.0.0.0";
ad.MaximumNodes = 3;
fc.ApplicationManager.CreateApplicationAsync(ad);

ApplicationUpdateDescription adUpdate = new ApplicationUpdateDescription(new Uri("fabric:/AppName"));
adUpdate.MaximumNodes = 5;
fc.ApplicationManager.UpdateApplicationAsync(adUpdate);

var appMetric = new ApplicationMetricDescription();
appMetric.Name = "Metric1";
appMetric.TotalApplicationCapacity = 1000;

adUpdate.Metrics.Add(appMetric);
```

## アプリケーションのメトリック、負荷、および容量
アプリケーション グループを使用して、特定のアプリケーション インスタンスに関連付けられたメトリックと、これらのメトリックに関してアプリケーション容量を定義することもできます。たとえば、作成する必要のある数だけサービスを定義できます。

各メトリックについて、そのアプリケーション インスタンスの容量を指定する 2 つの値を設定できます。

* アプリケーションの合計容量 - 特定のメトリックに対するアプリケーションの合計容量を表します。Service Fabric CRM では、このアプリケーションのサービスのメトリック負荷合計が指定した値に制限されます。さらに、アプリケーションのサービスが既にこの上限まで負荷を消費している場合、負荷合計がこの上限を超過しないように、新しいサービスやパーティションの作成が Service Fabric クラスター リソース マネージャーによって禁止されます。
* 最大ノード容量 - 単一ノード上のアプリケーションのサービスのレプリカに対する最大負荷合計を指定します。ノードの負荷合計がこの容量を超過すると、Service Fabric CRM は、レプリカを他のノードに移動して容量の制約を順守しようとします。

## 容量の予約
アプリケーション グループの別の一般的な用途として、クラスター内に特定のアプリケーション インスタンスのサービスがない場合、またはこのアプリケーション インスタンスがまだリソースを消費していない場合でも、クラスター内のリソースをこのアプリケーション インスタンス用に確保することが挙げられます。この確保を行う方法を以下で説明します。

### 最小ノード数とリソースの予約の指定
アプリケーションのインスタンス用にリソースを予約するには、追加パラメーター *MinimumNodes* と *NodeReservationCapacity* を指定する必要があります。

* MinimumNodes - アプリケーション内のサービスを実行できるターゲット最大ノード数を指定するのと同様に、アプリケーションを実行する必要のある最小ノード数も指定できます。この設定により、リソースが予約される必要のある最小ノード数が実質的に定義され、アプリケーション インスタンス作成の一部として、クラスター内の容量が確保されます。
* NodeReservationCapacity - アプリケーション内の各メトリックに対して NodeReservationCapacity を定義することができます。これにより、アプリケーション内のサービスのレプリカやインスタンスが配置されているノード上で、そのアプリケーション用に予約されているメトリック負荷の量が定義されます。

容量の予約の例を以下に示します。

![予約容量を定義したアプリケーション インスタンス][Image2]

左の例では、アプリケーションにアプリケーション容量が定義されていません。Service Fabric クラスター リソース マネージャーは、アプリケーションの子サービスのレプリカとインスタンスの負荷を、このアプリケーション以外の他のサービスのレプリカとインスタンスと合わせて分散し、クラスター内でのバランスを保ちます。

右の例では、アプリケーションは、MinimumNodes が 2、MaximumNodes が 3 に設定された状態で作成され、アプリケーションのメトリックについては予約が 20、ノードの最大容量が 50、合計アプリケーション容量が 100 で定義されています。Service Fablic は青のアプリケーションに対して 2 つのノードで容量を予約し、クラスター内の他のレプリカによるこの容量の消費を禁止します。この予約されたアプリケーション容量は、残りのクラスター容量に対して消費されたものとみなされてカウントされます。

アプリケーションが予約ありで作成されると、クラスター リソース マネージャーは MinimumNodes と NodeReservationCapacity の積と同等の容量をクラスター内で予約しますが、特定のノードの容量は、アプリケーションのサービスのレプリカが作成されて配置されるまで予約されません。これにより、ノードは、新しいレプリカが作成された場合にのみこれらのレプリカに対して選択されるため、柔軟性が向上します。特定のノードに 1 つ以上のレプリカが配置されると、そのノードの容量が予約されます。

## アプリケーションの負荷情報の取得
アプリケーション容量が定義されている各アプリケーションについて、サービスのレプリカ別に報告される負荷の集計に関する情報を取得できます。Service Fabric では、このために PowerShell とマネージ API のクエリが用意されています。

たとえば、負荷は次の PowerShell コマンドレットを使用して取得できます。

``` posh
Get-ServiceFabricApplicationLoad –ApplicationName fabric:/MyApplication1

```

このクエリの出力には、最小ノード数や最大ノード数など、アプリケーションで指定されたアプリケーション容量に関する基本情報が含まれています。アプリケーションが現在使用しているノードの数に関する情報も含まれます。そのため、負荷メトリックごとに次の情報があります。

* Metric Name: メトリックの名前。
* Reservation Capacity: このアプリケーションで予約されているクラスター容量。
* Application Load: このアプリケーションの子レプリカの負荷合計。
* Application Capacity: アプリケーションの負荷の最大許容値。

## アプリケーション容量の削除
アプリケーション容量の各パラメーターは、アプリケーションに対して設定した後で、アプリケーション更新 API または PowerShell コマンドレットを使用して削除できます。次に例を示します。

``` posh
Update-ServiceFabricApplication –Name fabric:/MyApplication1 –RemoveApplicationCapacity

```

このコマンドにより、アプリケーションからすべてのアプリケーション容量パラメーターが削除されます。Service Fabric クラスター リソース マネージャーでのこのアプリケーションの処理は、クラスター内のこれらのパラメーターが定義されていない他のアプリケーションと同様になります。コマンドは即座に効果を発揮し、クラスター リソース マネージャーはこのアプリケーションのすべてのアプリケーション容量パラメーターを削除します。これらのパラメーターを再び指定するには、アプリケーション更新 API を適切なパラメーターで呼び出す必要があります。

## アプリケーション容量に関する制限事項
アプリケーション容量パラメーターには、順守する必要があるいくつかの制限があります。検証エラーが発生した場合、アプリケーションの作成または更新は拒否され、エラーが表示されます。すべての整数パラメーターは、マイナスではない数字にする必要があります。さらに、個別のパラメーターに対する制限は以下のとおりです。

* MinimumNodes を MaximumNodes より大きくすることはできません。
* 負荷メトリックの容量を定義する場合、これらの容量は以下の規則に従う必要があります。
  * ノードの予約容量を最大ノード容量よりも大きくすることはできません。たとえば、ノードのメトリック "CPU" の容量を 2 ユニットに制限してから、各ノードで 3 ユニットを予約することはできません。
  * MaximumNodes を指定する場合は、MaximumNodes と最大ノード容量の積はアプリケーションの合計容量を超えないようにする必要があります。たとえば、メトリック "CPU" の最大ノード容量を 8 に設定し、MaximumNodes を 10 に設定した場合、この負荷メトリックに対するアプリケーションの合計容量は 80 より大きくする必要があります。

この制限は、アプリケーションの作成時 (クライアント側) とアプリケーションの更新中 (サーバー側) の両方で適用されます。以下の作成時の例では、MaximumNodes より MinimumNodes が大きくなっているため明らかに要件違反であり、このコマンドは、要求が Service Fabric クラスターに送信される前にクライアントでエラーを生じます。

``` posh
New-ServiceFabricApplication –Name fabric:/MyApplication1 –MinimumNodes 6 –MaximumNodes 2
```

無効な更新の例を以下に示します。次のように、既存のアプリケーションを指定して最大ノード数を一定の値に更新すると、更新は正常に行われます。

``` posh
Update-ServiceFabricApplication –Name fabric:/MyApplication1 6 –MaximumNodes 2
```

その後、次のように最小ノード数の更新を試行したとします。

``` posh
Update-ServiceFabricApplication –Name fabric:/MyApplication1 6 –MinimumNodes 6
```

クライアントにはアプリケーションに関する十分なコンテキストがないため、この更新の操作は Service Fabric クラスターに渡されます。しかし、Service Fabric はクラスター内で既存のパラメーターと共に新しいパラメーターを検証すると、最小ノード数の値が最大ノード数の値より大きいため、更新操作は失敗します。この場合、アプリケーション容量パラメーターは変更されないままとなります。

これらの制限は、クラスター リソース マネージャーがアプリケーションのサービスのレプリカを最適に配置できるように設けられています。

## アプリケーション容量を使用すべきでない場合
* アプリケーション容量は、アプリケーションを特定のノードのサブセットに制限するために使用しないでください。Service Fabric はアプリケーション容量が指定されているアプリケーションで最大ノード数が順守されるようにしますが、ユーザーはアプリケーションがインスタンス化されるノードを決定することができません。これは、サービスの配置の制約を使用して実現できます。
* アプリケーション容量は、同じアプリケーションの 2 つのサービスが常に並んで配置されるようにするために使用しないでください。これは、サービス間でのアフィニティの関係を使用して実現でき、アフィニティは一緒に配置する必要があるサービスのみに制限できます。

## 次のステップ
* サービスの構成に利用できるその他のオプションの詳細については、「[サービスの構成について学習する](service-fabric-cluster-resource-manager-configure-services.md)」にあるその他のクラスター リソース マネージャーに関するトピックを参照してください。
* クラスター リソース マネージャーでクラスターの負荷を管理し、分散するしくみについては、[負荷分散](service-fabric-cluster-resource-manager-balancing.md)に関する記事を参照してください。
* 最初から開始して、[Service Fabric クラスター リソース マネージャーの概要を確認するにはこちらを参照してください](service-fabric-cluster-resource-manager-introduction.md)。
* メトリックの一般的な動作について詳しくは、[Service Fabric の負荷メトリック](service-fabric-cluster-resource-manager-metrics.md)に関する記事を参照してください。
* クラスター リソース マネージャーには、クラスターを記述するためのさまざまなオプションがあります。オプションの詳細については、[Service Fabric クラスターの記述](service-fabric-cluster-resource-manager-cluster-description.md)に関する記事を参照してください。

[Image1]: ./media/service-fabric-cluster-resource-manager-application-groups/application-groups-max-nodes.png
[Image2]: ./media/service-fabric-cluster-resource-manager-application-groups/application-groups-reserved-capacity.png

<!---HONumber=AcomDC_0824_2016-->