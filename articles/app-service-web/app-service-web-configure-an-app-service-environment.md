<properties 
	pageTitle="App Service 環境の構成方法" 
	description="App Service 環境の構成、管理、および監視" 
	services="app-service" 
	documentationCenter="" 
	authors="ccompy" 
	manager="stefsch" 
	editor=""/>

<tags 
	ms.service="app-service" 
	ms.workload="na" 
	ms.tgt_pltfrm="na" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="06/20/2016" 
	ms.author="ccompy"/>


# App Service 環境の構成 #

## 概要 ##

大まかに言えば、App Service 環境は次に挙げるいくつかの主要なコンポーネントで構成されます。

- Azure App 環境ホステッド サービスで実行中のコンピューティング リソース
- Storage
- データベース
- 1 つ以上のサブネットを持つクラシック "v1" Virtual Network
- Azure App 環境のホストされるサービスが実行されるサブネット

### コンピューティング リソース

コンピューティング リソースは、4 つのリソース プールに使用されます。各 App Service Environment には、フロント エンドと 3 つの使用可能なワーカー プールのセットがあります。3 つのワーカー プールすべてを使用する必要はありません。1 つか 2 つだけ使用することもできます。リソース プール、フロント エンド、ワーカーは、テナントに直接アクセスできません。テナントに対する RDP、プロビジョニングの変更、テナントでの管理者権限での操作は実行できませんが、テナントの数とサイズの設定は可能です。ASE には、P1 ～ P4 の 4 つのサイズ オプションがあります。これらのサイズとその価格設定の詳細については、「[App Service の価格](../app-service/app-service-value-prop-what-is.md)」を参照してください。一度に実行できるスケール操作は 1 つだけです。

**フロント エンド** フロント エンドは、ASE に保持されているアプリの HTTP/HTTPS エンドポイントです。フロント エンドではワークロードを実行しません。

- ASE の当初の構成は 2 つの P2 です。これは、開発/テストのワークロードと低レベルの運用ワークロードに対応するうえでは十分な構成です。負荷の大きい運用ワークロードに対応する必要がある場合は、P3 の採用を強くお勧めします。
- 負荷の大きい運用ワークロードに対応する必要がある場合は、少なくとも 4 つの P3 にして、スケジュールされているメンテナンスの実施時に十分な数のフロント エンドが実行されるようにすることをお勧めします。スケジュールされているメンテナンス アクティビティが実行されると、一度に 1 つのフロント エンドが停止されます。そのため、メンテナンス アクティビティ中には、フロント エンド全体の対応能力が減ることになります。
- 新しいフロント エンド インスタンスを瞬時に追加することはできません。プロビジョニングには 2 ～ 3 時間かかる可能性があります。
- スケールの微調整の際には、フロント エンド プールの CPU 使用率、メモリ使用率、アクティブな要求数のメトリックを監視する必要があります。P3 での運用時に CPU 使用率またはメモリ使用率が 70% を超えている場合は、フロント エンドを追加してください。アクティブな要求数が平均で 15K ～ 20K に達している場合も、フロント エンドを追加する必要があります。全体的な目標は、P3 で運用中のフロント エンドごとに、CPU とメモリの使用率を 70% 未満に抑え、アクティブな要求数が平均で 15K 未満になるようにすることです。  

**ワーカー** ワーカーとは、アプリが実際に実行される場所です。App Service プランをスケールアップする場合、関連付けられているワーカー プール内のワーカーがすべて使用されます。

- ワーカーを瞬時に追加することはできません。追加するワーカーの数に関係なく、プロビジョニングには 2 ～ 3 時間かかる可能性があります。
- プールのコンピューティング リソースのサイズをスケールする場合、更新ドメインごとに 2 ～ 3 時間かかります。ASE には 20 の更新ドメインがあります。10 インスタンスのワーカー プールのコンピューティング サイズをスケールした場合、完了するまでに 20 ～ 30 時間かかる可能性があります。 
- ワーカー プールで使用されるコンピューティング リソースのサイズを変更すると、そのワーカー プールで実行中のアプリのコールド スタートが実行されます。

アプリが実行されていないワーカー プールのコンピューティング リソースのサイズを最も短時間で変更する方法は、以下のとおりです。

- インスタンスの数を 0 にスケールダウンします。インスタンスの割り当てが解除されるまでに約 30 分かかります。
- 新しいコンピューティング サイズとインスタンスの数を選択します。この処理を始めてから完了するまでに 2 ～ 3 時間かかります。

アプリにより大きなコンピューティング リソース サイズが必要な場合は、前のガイダンスは使えません。そのアプリをホストするワーカー プールのサイズを変更する代わりに、目的のサイズのワーカーが含まれる別のワーカー プールを設定し、アプリをそのプールに移動してください。

- 必要なコンピューティング サイズのインスタンスを別のワーカー プールに別途作成します。これが完了するまでに 2 ～ 3 時間かかります。
- より大きなサイズを必要とするアプリをホストする App Service プランを、新たに構成したワーカー プールに割り当て直します。これは 1 分未満で完了する高速の処理です。  
- 最初のワーカー プールをスケールダウンします (使用されないこれらのインスタンスが必要なくなった場合)。この処理が完了するまでに 30 分程度かかります。

**自動スケール** コンピューティング リソースの使用を管理するのに役立つ手段の 1 つが、フロント エンドまたはワーカー プールに対して実行できる自動スケールです。朝に任意の種類のプールのインスタンスを増やして夕方に減らす、ワーカー プール内の利用可能なワーカーの数が特定のしきい値を下回ったときにインスタンスを増やすなど、さまざまな活用方法があります。コンピューティング リソース プールのメトリックに関する自動スケール規則を設定する場合は、プロビジョニングに必要な時間を考慮してください。App Service Environment の自動スケールの詳細については、[App Service Environment で自動スケールを構成する方法][ASEAutoscale]に関する記事を参照してください。

### Storage

各 ASE には、500 GB の記憶域が構成されています。この領域は、ASE 内のすべてのアプリケーションに使用されます。この記憶域は ASE の一部であり、顧客の記憶域を使用するように切り替えることはできません。VNET ルーティングまたはセキュリティを調整する場合も、Azure Storage へのアクセスを許可する必要があります。そうしないと、ASE が機能しません。

### データベース

データベースには、環境を定義する情報だけでなく、環境内で実行されているアプリに関する詳細情報が格納されています。このような情報も、Azure に保持されているサブスクリプションの一部であり、顧客が直接操作できる情報ではありません。VNET ルーティングまたはセキュリティを調整する場合も、SQL Azure へのアクセスを許可する必要があります。そうしないと、ASE が機能しません。

### ネットワーク

ASE に使用される仮想ネットワークには、ASE の作成時または事前に作成したネットワークを使用できます。VNET を、ASE に使用されたものとは異なるリソース グループにする場合は、ASE 作成フローから別に VNET を作成する必要があります。ASE の作成時にサブネットを作成する場合は、VNET と同じリソース グループ内にしか ASE を作成できません。

ASE に使用される VNET にはいくつかの制限があります。

- 現時点では、V1 の "クラシック" VNET しかサポートされていない
- VNET は地域 VNET であることが必要
- 2016 年 6 月に行われた直近の変更で、パブリック アドレス範囲*または* RFC1918 アドレス空間 (つまりプライベート アドレス) の*どちらか*を使用した仮想ネットワークに ASE をデプロイできるようになりました。パブリック アドレス範囲の仮想ネットワークを使用するには、あらかじめサブネットを作成しておき、ASE の作成インターフェイスでそのサブネットを選択する必要があります。
- ASE がデプロイされる 8 個以上のアドレスを持つサブネットが必要
- ASE のホストにサブネットが使用されたら、サブネットのアドレス範囲を変更できます。このため、将来の ASE の拡大に対応できるように、サブネットに 64 個以上のアドレスが含まれるようにすることをお勧めします。 
- **ASE をホストするために使用されているサブネットに、他のコンピューティング リソースを含めることはできません。**

ASE などのホステッド サービスとは異なり、[Virtual Network][virtualnetwork] とサブネットは、すべてがユーザーの制御下にあります。VNET の管理は、Virtual Network UI または PowerShell によって行われます。

この機能によって Azure App Service が VNET に配置されるため、ASE でホストされているアプリが ExpressRoute またはサイト間 VPN によってリソースに直接アクセスできるようになっています。App Service 環境をホストしている VNET から利用できるリソースにアクセスするために、App Service 環境内のアプリにネットワーク機能を追加する必要はありません。つまり、VNET 統合またはハイブリッド接続を使用して、リソースを取り込んだり、VNET に接続したりする必要はありません。VNET に接続されていないネットワーク内のリソースにアクセスするために、今後もこれらの両方の機能を使用できます。たとえば、VNET 統合を使用して、サブスクリプション内にあり、ASE が属している VNET に接続していない VNET と統合することができます。また、ハイブリッド接続を使用して、通常と同様の方法で他のネットワーク内のリソースにアクセスすることもできます。

ExpressRoute VPN を使用して VNET を構成している場合、ASE に関するいくつかのルーティング ニーズに気を付ける必要があります。ASE とは互換性がないユーザー定義ルート (UDR) 構成がいくつかあります。ExpressRoute を使用する VNET 環境で ASE を実行する場合の詳細については、「[ExpressRoute を使用した App Service Environment のネットワーク構成の詳細][ExpressRoute]」を参照してください。

ネットワーク セキュリティ グループを使用して、アプリへのアクセスを制御することもできるようになりました。この機能によって、App Service 環境をロック ダウンして必要な IP アドレスのみに制限することができます。この方法の詳細については、「[App Service 環境での受信トラフィックの制御方法](app-service-app-service-environment-control-inbound-traffic.md)」のドキュメントを参照してください。

## ポータル

App Service Environment を管理および監視する UI は、Azure ポータルから使用できます。ASE があれば、ほとんどの場合、サイドバーに App Service 記号が表示されます。この記号は、Azure ポータルに App Service Environment があることを示すために使用されます。

![][1]

アイコンを使用するか、サイドバーの下部にある不等号 (大なり記号) を選択し、App Service Environment を選択します。いずれの操作でも、全 App Service Environment の一覧を表示する UI が開きます。表示されている ASE のいずれかを選択すると、監視および管理に使用される UI が開きます。

![][2]

この最初のブレードには、ASE の一部のプロパティと、リソース プールごとのメトリック グラフが表示されます。Essentials ブロックに表示されるプロパティの一部は、関連付けられているブレードを開くハイパーリンクです。たとえば、VNET 名を選択して、ASE が実行されている VNET と関連付けられた UI を開くことができます。App Service プランとアプリでそれぞれブレードが開き、ASE 内にある項目が一覧表示されます。

### Monitoring

グラフから、各リソース プールの多様なパフォーマンス メトリックを確認できます。フロント エンド プールについては、CPU とメモリの平均値を監視できます。ワーカー プールについては、使用されている数と使用可能な数を監視できます。App Service プランが複数ある場合、ワーカー プール内のワーカーを利用することができます。ワークロードはフロント エンド サーバーと同様の方法では分散されないため、CPU とメモリの使用率からは有用な情報はそれほど得られません。それまでに使用したワーカー数と、特に、このシステムを管理する場合に、他のシステムが使用できるワーカー数を追跡することは重要です。

グラフで追跡できるすべてりメトリックは、アラートの設定にも使用できます。アラートの設定は、App Service の他の設定と同様に行います。アラートを設定するには、アラートの UI 部分を使用するか、メトリック UI から [アラートの追加] を選択します。
 
![][3]

これまでに説明したメトリックは、App Service Environment メトリックです。App Service プラン レベルで使用できるメトリックもあります。これは、CPU とメモリの監視が重要な場合のメトリックです。ASE のすべての ASP は、専用の ASP です。つまり、その ASP に割り当てられているホストで実行されているアプリのみが、その ASP 内のアプリです。ASP の詳細を確認するには、ASE UI の任意の一覧から ASP を選択するか、すべての ASP が表示される App Service プランを閲覧します。

### 設定

ASE ブレードには [設定] セクションがあり、そこにいくつかの重要な機能が用意されています。

**[設定] > [プロパティ]** ASE ブレードを選択すると、[設定] ブレードが自動的に開きます。その一番上に [プロパティ] が表示されます。プロパティには多数の項目があり、Essentials に表示される項目と重複していますが、VIP アドレスと発信 IP アドレスはとても便利です。

![][4]

**[設定] > [IP アドレス]** ASE に IP SSL アプリを作成する場合は、IP SSL アドレスが必要です。そのため、ASE には、割り当てが可能な独自の IP アドレスが存在する必要があります。ASE の作成時に、この目的で使用できる IP SSL アドレスが 1 つ用意されますが、追加することもできます。「[App Service の価格][AppServicePricing]」の SSL 接続のセクションに、IP SSL アドレスを追加する際の価格が記載されています。追加の価格は、IP SSL の価格です。

**[設定] > [フロントエンド プール]/[ワーカー プール]** 各リソース プール ブレードでは、そのリソース プールに関する情報のみを表示できます。また、そのリソース プールのスケールを完全に制御できます。

各リソース プールの基本ブレードには、そのリソース プールのメトリックを使用したグラフが表示されます。ASE ブレードのグラフと同様に、グラフにアクセスし、必要に応じてアラートを設定することができます。特定のリソース プールに関する ASE ブレードからアラートを設定する操作は、リソース プールからアラートを設定する操作と同じです。ワーカー プールの [設定] ブレードから、そのワーカー プールで実行されているアプリまたは App Service プランすべての一覧にアクセスできます。

![][5]

### ポータルのスケール機能  

スケール処理には、次の 3 つがあります。

- IP SSL に使用できる ASE 内の IP アドレス数を変更する
- リソース プールに使用されるコンピューティング リソースのサイズを変更する
- 手動または自動スケールで、リソース プールに使用されるコンピューティング リソース数を変更する

ポータルでは、次の 3 とおりの方法でリソース プール内のサーバーの数を制御できます。

- 上部にあるメイン ASE ブレードからのスケール操作。フロント エンドとワーカー プールに対し、複数のスケール構成の変更を加えることができます。この変更は、すべて 1 回の操作で適用されます。
- 次に、個々のリソース プールの [設定] にある [スケール] ブレードからの手動スケール操作
- 最後に、個々のリソース プールの [スケール] ブレードから設定する自動スケールです。

ASE ブレードでスケール操作を使用するには、目的の数までスライダーをドラッグし、保存します。この UI は、サイズの変更もサポートしています。

![][6]

特定のリソース プールで手動または自動スケール機能を使用するには、*[設定] に移動し、必要に応じて [フロントエンド プール] または [ワーカー プール] に移動して*、変更するプールを開きます。*[設定]、[スケールアウト] の順に移動するか、[設定]、[スケールアップ] の順に移動します*。*[スケールアウト]* ブレードでは、インスタンスの数を制御できます。*[スケールアップ]* では、リソース サイズを制御できます。

![][7]

## フォールト トレランスに関する考慮事項

App Service 環境は合計 55 個までのコンピューティング リソースを使用するように構成できます。この 55 個のコンピューティング リソースのうち、ワークロードのホストに使用できるのは 50 個のみです。その理由は 2 つあります。フロントエンドのコンピューティング リソースは最小で 2 つです。これにより、ワーカー プールの割り当てのサポートには最大で 53 個残ります。フォールト トレランスを提供するには、次のルールに従い、追加のコンピューティング リソースを割り当てる必要があります。

- 各ワーカー プールには、ワークロードに割り当てることができない追加のコンピューティング リソースを 1 つ以上用意する必要があります。
- ワーカー プール内のコンピューティング リソースの数量が特定の値を超えた場合、フォールト トレランスのために別のコンピューティング リソースが必要になります。この対応は、フロント エンド プールの場合には該当しません。

1 つのワーカー プール内でのフォールト トレランスの要件は、ワーカー プールに割り当てられたリソースの任意の値 X について、

- X が 2 ～ 20 の場合、ワークロードに使用できるコンピューティング リソースの数は X-1 です。
- X が 21 ～ 40 の場合、ワークロードに使用できるコンピューティング リソースの数は X-2 です。
- X が 41 ～ 53 の場合、ワークロードに使用できるコンピューティング リソースの数は X-3 です。

最低限のフットプリントは 2 つのフロント エンド サーバーと 2 つのワーカーです。上記の文は、わかりやすくするための例です。

- 1 つのプール内に 30 個のワーカーがある場合、そのうち 28 個をワークロードのホストに使用できます。 
- 1 つのプール内に 2 つのワーカーがある場合、1 つをワークロードのホストに使用できます。
- 1 つのプール内に 20 個のワーカーがある場合、19 個をワークロードのホストに使用できます。  
- 1 つのプール内に 21 個のワーカーがある場合でも、ワークロードのホストに使用できるのは 19 個のみです。  

フォールト トレランスの側面は重要ですが、スケールが特定のしきい値を超える場合に注意する必要があります。20 個のインスタンスから容量を追加するには、22 個以上に増やします。これは、21 個では容量が追加されないためです。同様に、40 個を超える数に増やす場合、容量が追加される次の数は 42 です。

## App Service 環境の削除 ##

App Service 環境を削除する必要がある場合は、単に [App Service 環境] ブレード上部の [削除] アクションを使用します。この操作を実行すると、App Service Environment の名前を入力し、操作の実行を確定するように求められます。注: App Service Environment を削除すると、その内部のすべてのコンテンツも削除されます。

![][9]

## 使用の開始
App Service 環境に関するすべての記事と作業方法は [Application Service Environments の README](../app-service/app-service-app-service-environments-readme.md) を参照してください。

App Service 環境の使用を開始するには、[App Service 環境の作成方法](app-service-web-how-to-create-an-app-service-environment.md)に関するページを参照してください。

Azure App Service プラットフォームの詳細については、[Azure App Service](../app-service/app-service-value-prop-what-is.md) に関するページを参照してください。

[AZURE.INCLUDE [app-service-web-whats-changed](../../includes/app-service-web-whats-changed.md)]

[AZURE.INCLUDE [app-service-web-try-app-service](../../includes/app-service-web-try-app-service.md)]

<!--Image references-->
[1]: ./media/app-service-web-configure-an-app-service-environment/ase-icon.png
[2]: ./media/app-service-web-configure-an-app-service-environment/aseconfig-aseblade.png
[3]: ./media/app-service-web-configure-an-app-service-environment/aseconfig-poolchart.png
[4]: ./media/app-service-web-configure-an-app-service-environment/aseconfig-properties.png
[5]: ./media/app-service-web-configure-an-app-service-environment/aseconfig-poolblade.png
[6]: ./media/app-service-web-configure-an-app-service-environment/aseconfig-scalecommand.png
[7]: ./media/app-service-web-configure-an-app-service-environment/aseconfig-poolscale.png
[8]: ./media/app-service-web-configure-an-app-service-environment/aseconfig-pricingtiers.png
[9]: ./media/app-service-web-configure-an-app-service-environment/aseconfig-deletease.png

<!--Links-->
[WhatisASE]: http://azure.microsoft.com/documentation/articles/app-service-app-service-environment-intro/
[Appserviceplans]: http://azure.microsoft.com/documentation/articles/azure-web-sites-web-hosting-plans-in-depth-overview/
[HowtoCreateASE]: http://azure.microsoft.com/documentation/articles/app-service-web-how-to-create-an-app-service-environment/
[HowtoScale]: http://azure.microsoft.com/documentation/articles/app-service-web-scale-a-web-app-in-an-app-service-environment/
[ControlInbound]: http://azure.microsoft.com/documentation/articles/app-service-app-service-environment-control-inbound-traffic/
[virtualnetwork]: https://azure.microsoft.com/documentation/articles/virtual-networks-faq/
[AppServicePricing]: http://azure.microsoft.com/pricing/details/app-service/
[AzureAppService]: http://azure.microsoft.com/documentation/articles/app-service-value-prop-what-is/
[ASEAutoscale]: http://azure.microsoft.com/documentation/articles/app-service-environment-auto-scale/
[ExpressRoute]: http://azure.microsoft.com/documentation/articles/app-service-app-service-environment-network-configuration-expressroute/

<!---HONumber=AcomDC_0622_2016-->