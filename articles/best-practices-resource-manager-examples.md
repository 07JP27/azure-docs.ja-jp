<properties
	pageTitle="テンプレート実装のベスト プラクティスの具体的な例"
	description="ベスト プラクティスを示す Azure リソース マネージャーのテンプレートの例を紹介します。"
	services="azure-resource-manager"
	documentationCenter=""
	authors="mmercuri"
	manager="georgem"
	editor="tysonn"/>

<tags
	ms.service="azure-resource-manager"
	ms.workload="multiple"
	ms.tgt_pltfrm="na"
	ms.devlang="na"
	ms.topic="article"
	ms.date="07/16/2015"
	ms.author="mmercuri"/>

# テンプレート実装のベスト プラクティスの具体的な例

このトピックでは、Azure リソース マネージャーのテンプレートを実装する方法に関する 7 つの具体的な例を紹介します。これらの例で説明する原理の概要については、「[Azure リソース マネージャーのテンプレートを設計するためのベスト プラクティス](best-practices-resource-manager-design-templates.md)」を参照してください。

## 機能スコープ テンプレートをエンド ツー エンド ソリューション スコープ テンプレートに移行する

機能スコープ テンプレートを開発するためのパターンは、既に共有されていますが、ここで考えてみる疑問の 1 つに、この機能スコープ テンプレートを単独で使用する場合とエンド ツー エンド ソリューション スコープ テンプレートの一部として使用する場合で考慮事項が異なるかどうかがあります。

たとえば、SQL Server を機能としてデプロイするテクノロジに重点を置いたテンプレートがあった場合に、そのテンプレートを単独で使用すること、またはその SQL Server を使用して Web アプリケーションをサポートするより広範囲にわたるエンド ツー エンド ソリューション スコープ テンプレートの一部として使用することから、どのような考慮事項があるでしょうか。

このシナリオを考える場合は、関連するリソースの数に注目することが適切です。堅牢な実装の場合、機能スコープ テンプレートは、単にストレージ アカウントと、1 つの SQL Server がインストールされている単一の VM ではありません。堅牢な機能スコープ テンプレートでは、高可用性を実現するために SQL Server がデプロイされた VM を複数デプロイします。Analysis Services などの一部の機能では、トポロジでも Active Directory と共に SQL Server がデプロイされる場合があります。

このシナリオの重要な 2 つの考慮事項として、SQL Server がどのように使用されるかを示すライフサイクルと、SQL Server に適用する RBAC があります。具体的には、ソリューションの残りの部分で SQL Server が更新されたり削除されたりするのか、または SQL Server のライフサイクルがソリューションまたはソリューションの他の部分によって異なるのか、ということです。ライフサイクルが異なる場合、別のリソース グループに配置することを検討します。

もう 1 つの考慮事項は、RBAC を SQL Server の機能スコープ ソリューション テンプレートに適用する方法です。トポロジ内で RBAC を適用する方法に基づいて、これらの詳細に合うようにさまざまなリソース グループを選択できます。RBAC はリソース レベルで適用できますが、SQL Server の機能スコープ ソリューション テンプレートのリソース数を考慮すると、別のリソース グループに RBAC を適用することを検討する必要があります。

また、別の考慮事項として、SQL Server の機能スコープ ソリューション テンプレートの評価が挙げられます。これにより、現時点で特定のリソース自体が作成されるのか、"リソース持ち込み" を可能にするのかが特定されます。 "リソース持ち込み" (BYOR) モデルで、機能スコープ ソリューション テンプレートを使用すると、自身のテンプレートで、ストレージ アカウント、仮想ネットワーク、可用性セットという典型的な例と共に、既存のリソースを再利用できます。BYOR アプローチが機能スコープ テンプレートに存在しない場合は、このドキュメントの前半で定義されているオプション リソース テンプレートのアプローチを使用して変更できます。この場合、エンド ツー エンド ソリューション スコープ テンプレートには、このような一般的なリソースを含む共有リソース テンプレートが含まれており、機能スコープ テンプレートは、オプションとしてこれらのリソースをサポートするように拡張されます。これにより、より優れた機能ソリューション スコープ テンプレートが作成され、単独で使用したり、構成の一部として使用できるようになります。

エンド ツー エンド ソリューション スコープ テンプレートからストレージ アカウントを渡す必要があるかどうかを評価する際は、RBAC も再評価する必要があります。具体的には、この特定のリソースに RBAC が適用されるようにする必要があるかどうかです。 必要な場合は、リソースを渡すときに RBAC が適用されると予測される場合、ソリューション ブロックだけでなく、個別に使用する際に必要に応じて機能スコープ テンプレートに RBAC を指定する任意のユーザーにも、一定レベルの信頼が置かれます。RBAC が重要な場合は、RBAC の適用を機能スコープ ソリューション テンプレート内で省略可能なテンプレートにするか、機能スコープ ソリューション テンプレート内から必要な RBAC が適用されたテンプレートの作成を要求するかを検討する必要があります。

異なるリソース グループにこれらを配置することが決まった場合は、リソースが複数のリソース グループにまたがるときでも、リソース リンクを使用してリソース間のリレーションシップを定義することもできます。

## 複数の機能スコープ テンプレートを含むエンド ツー エンド ソリューション スコープ テンプレートを作成する

これは主に、前の例のスーパーセットです。このシナリオでは、Kafka、Apache Hadoop、Apache Spark、Apache Storm など、1 つのソリューションのブロックにまとめたい一連のデータ テクノロジの機能スコープ ソリューション テンプレートが組織に複数あるとします。結果となる構成では、これらの機能スコープ ソリューション テンプレートと共に、特定のサブネットが割り当てられた共有ストレージと仮想ネットワークも使用します。

必要とされる特定の機能スコープ テンプレートとは別に、機能スコープ テンプレートをまとめて構成するスクリプトがあったとしても、ソリューションには追加リソースが必要になります。

この場合、共有の仮想ネットワークとストレージ アカウントがあることが識別されます。このようなシナリオに対応するには、エンド ツー エンド ソリューション スコープ テンプレート内の共有リソース テンプレートにこれらを追加し、機能スコープ テンプレートで "リソース持ち込み" アプローチがサポートされていることを確認する必要があります。対応していない場合は、前の例で説明したように、機能スコープ テンプレートを変更して対応させることができます。

追加するその他のリソースについては、個々の機能スコープ テンプレートの作成に使用されるパターンのスーパーセットに従います。この場合、新しいリソース用の共有リソース テンプレート、オプション リソース テンプレート、メンバー ノード テンプレート、望ましい状態への構成 (スクリプト、Chef、Puppet、Powershell DSC) を追加します。依存関係がある場合は、デプロイメントの並列処理 (および速度) に影響する可能性のある依存関係が散在することがないように、可能な限り暗黙的な参照と dependsOn を比較して使用するように最適化します。また、これらのリソースのライフサイクル、RBAC の考慮事項、依存関係を考慮して、これらのリソースを異なるリソース グループに配置する必要があるかどうかを判断します。

共有のストレージ アカウントなどの共有リソースを追加する際は、リソース ロックがそのリソースに必要かどうかを評価する必要もあります。これは、誤って削除されることを回避するのに役立つためです。

新しいリソースを追加する際は、エンド ツー エンド ソリューション スコープ テンプレートに追加するリソースのいずれかを機能スコープ テンプレート自体として分離できるかどうかを調べる必要もあります。分離できる場合、分解をさらに促進することで再利用とテストの両方に効果が得られるため、積極的に検討する必要があります。

ソリューション ブロックに統合する際は、次に、前の例で示したように、個々の機能スコープ テンプレートのライフサイクルがより広範なソリューションのライフサイクルと異なるかどうか、RBAC の要件として、このようなテンプレートを別々のリソース グループに分離する必要があるかどうかを明確にすることを検討します。

最後に、リソースの間のリンクを定義および照会できるようにするかどうかを検討します。定義および照会できるようにする場合は、リソース リンクを使用すると、複数のリソース グループにまたがる場合でも、エンド ツー エンド ソリューション スコープ テンプレート全体でこの操作を実行できるようになります。

## 部分的なオン/オフの切り替えパターンを使用してエンド ツー エンド ソリューション スコープ テンプレートを作成する

このシナリオは、前のシナリオの変化形です。この場合、顧客は 1 日のうち一定の間隔でオンプレミスのシステムからデータを抽出します。顧客は、このように抽出したデータを処理するためのデータ パイプラインと、そのデータを常にクエリに使用できるリレーショナル データ ストアを所有しています。クラウドは従量課金モデルであるため、顧客は、処理するデータが存在する場合にこの間隔でのみデータ パイプラインを運用できるようにしたいと考えています。

データ パイプラインの一部として導入した SQL Server では、処理後のデータを受け取り、そのデータを照会できるようにします。顧客は、決まったスケジュールでパイプラインの取り込み部分とその処理部分のオンとオフを切り替えると同時に、SQL Server を常に使用可能な状態にしておくことを希望しています。

このシナリオでは、ライフサイクルに明確な違いと考えられる点があり、顧客から提起されていないものの、評価する必要のあるその他の考慮事項も存在する可能性があります。

説明したとおり、SQL Server のデプロイは、他のリソースが作成されたり削除されたりする間も維持されます。リソースは最初にまとめてデプロイされますが、その後、テンプレートの他のメンバーは別のライフサイクルで破棄されて作成されます。これらは、別のリソース グループに分離することも、SQL Server のリソースにリソース ロックを適用した状態で同じリソース グループ内に残すこともできます。特に SQL Server は、前の例で説明したように、より大規模なリソースのセットとして表される可能性があるため、独自のリソース グループに分離することが適しています。

その他の考慮事項として、顧客がスケジュールに従ってデータ パイプラインの残りの部分のオンとオフを切り替えることについては触れたものの、レポート システムの動作の不一致については考慮していない可能性がある点があります。サード パーティによるデータの定期的な配信は必ずしも正確ではありません。接続が一定時間使用できない、ローカル サーバーまたはクラウド ベースのサーバーのクロックに誤差がある、時刻の変更が予想どおりに行われるかどうかがわからないなどの現象が発生する場合があります。取り込みメカニズムをオンとオフの切り替えパターンでも使用するかどうかを評価し、使用する場合は、そのライフサイクルが処理コンポーネントのライフサイクルよりも長いかどうかを評価する必要があります。

Azure Data Factory や Event Hub などの管理されたサービスを使用している場合は、その運用モデルと関連する課金方法によって、簡単にデータを取り込んでストレージに配置できるようになるため、これはさほど問題にはなりません。Kafka などの別のテクノロジを仮想マシンにデプロイして使用している場合は、それと、取り込みに必要な関連するストレージ アカウントを使用できるようにする方法のライフサイクルにも注目する場合があります。その結果、取り込みと処理のリソースは、そのライフサイクルに基づいて別のリソース グループに配置される可能性があります。

## 1 つのサブスクリプション内で異なる環境をサポートする

サービスを効果的に配信するために、多くの組織は、スケール、課金の分離、説明責任の分離、地理的な分離という、対応する必要のあるニーズを抱えています。組織は、Azure のサービスを設計する際、このようなニーズを満たす方法に、サブスクリプションのパーティション分割を使用してきました。

リソース マネージャーにより、サブスクリプション内でデプロイできる、特定の種類のリソース数に対する制約が緩和され、リソース グループ、RBAC、監査も導入されています。これらを組み合わせることで、組織はリソース グループをパーティション分割に使用できるようになるため、要件を満たし、実行が必要になる可能性のあるサブスクリプションのパーティション分割がある場合はその量を減らすことができます。

このセクションでは、このような種類の環境に見られる要件を確認し、ARM でその要件を満たす環境を実現する方法についてガイダンスを示します。

### 分離に関する考慮事項

このセクションでは、環境の分離、課金の分離、地理的な分離に関する一般的な顧客要因について詳しく説明します。

#### 環境の分離

サービスの所有者は、異なる環境を分離したいと考えています。各環境を分離することで、チームは、その環境にアクセスできるユーザーをより細かく制御できます。開発環境は、アクセス可能なユーザー数の観点からよりオープンである場合もありますが、環境のスコープが運用に近づくにつれ、ユーザーの数 (自動化に使用されるユーザー アカウントまたはシステム アカウント) は、コンプライアンスを支援し、全体的なリスクを最小限に抑えるために少なくなります。

#### 課金の分離 – サービスの開発と実行

売上原価 (COGS) と営業経費 (OpEx) を正確に反映するために、経営者は、サービスの調査と構築にかかるコストとサービスの運用コストを切り離せるようにしたいと考えています。

既に説明した環境の分離のスーパーセットとして、前者については個別の課金や集計された課金の対象である開発とテストを統合するのに対し、後者については運用環境の独立性を確保することを目的としています。

#### 課金の分離 – サービスの使用にかかるコストに対する透明性と説明責任の追加

課金の分離は、特定のチームによるプラットフォーム使用に関連したコストへの透明性の追加と、適切なレベルの説明責任の導入の両方にも使用されます。

クラウドはエラスティックであり、従量課金モデルにすることは可能ですが、これは、ハードウェアを調達して所有する非クラウド モデルを使用する一部の開発者にとってはあまりなじみがありません。非クラウド モデルでは、有効にできる "コンピューター" の数に関して物理的な制限がありました。また、使用されていないときにリソースをスケールダウンまたは無効にするようにインセンティブも限られていました。この専用ハードウェアの調達は、多くの場合、それを使用している開発者が行っていたわけではありません。

サブスクリプションを分離し、それらのサブスクリプションの説明責任を特定のチームに任命することで、サービスの所有者は、この種のサブスクリプションのパーティション分割が目的の動作の促進と適用に役立つことに気付きます。

#### 地理的な分離 – 特定の地域に固有のデプロイと特定の地域の法律に準拠するデプロイ

特定のコンテキストでは、特定の地域を対象としたサービスで、コンプライアンスの考慮事項に対応するようにそのデプロイ方法を検討するという要件があります。

サービスは本来グローバルですが、特定地域の内部に存在するデプロイや、特定地域にサービスを提供するデプロイは、運用スタッフの要件に準拠する場合があります。具体的には、特定の国または定められた国の市民であるユーザーや特定の背景審査過程を通過したユーザーのみがこれらのサービスを運用しています。

地理的な分離には、新しいプラットフォームのサービスと機能を利用するという観点でもメリットがあります。中国などの一部の地域では、プラットフォーム サービスの一部しか使用できない場合や、プラットフォーム サービスが遅れてデプロイされる場合があります。

地理的な分離により、チームは、新しいプラットフォームや強化されたプラットフォームのサービスと機能を適宜活用できるように、サービスを進化させることができます。

### コンプライアンスの考慮事項

サービスは、複数の地域や業界に配信される場合があります。これらの対象ユーザーは、多くの場合、機密のデータやプロセスを自身のアプリケーション内に格納しており、そのデータやプロセスの保護とそれらに対する取り組みの監査の両方を目的とした、コンプライアンスの関連規制が存在します。

#### ロールと義務の分離

ロールと義務の分離は、内部サービスを企業内ポリシーに準拠させるための主な要件です。また、多くの商用サービスでは、政府や業界の規制ガイドラインの準拠を維持するためにこのような要件も課されています。サービスでは、サービスとその基になるリソースへのアクセスを、特定の状況において承認済みのロールに限定する必要があります。多くのサービスでは、RBAC と監査という 2 つの機能を提供するためにスキャフォールディングが作成されています。

#### ロールベースのアクセス制御 (RBAC) の使用事例

コンプライアンスのシナリオでは、特定のリソースへのアクセスを制限することが重要です。

たとえば、正常性情報、財務データ、税の記録など、コンプライアンスが関連する複数のシナリオで機密データを確認する場合は、そのデータのアクセス、表示、または操作を実行できるユーザーの数を、親組織の業務を行うためにアクセスを必要とするユーザーのみに制限することが重要です。

RBAC により、個々のユーザー、システム、グループに対して、特定の条件下で特定のリソースへのアクセスが提供されます。

#### 監査

組織は、RBAC によって提供される限定的アクセスだけでなく、リソースへのアクセスとリソースとの対話を監査する必要があります。

### Azure リソース マネージャーによる実装

これまで、組織は、このような目標を達成するために、サブスクリプションのパーティション分割を使用していました。この方法は可能ですが、理想的ではありませんでした。サブスクリプションの作成は実質的に商取引のアクティビティであるため、サービス管理 API では、新しいサブスクリプションを自動的に作成または削除するためのメカニズムが公開されていないので、サブスクリプションを手動で作成する必要がありました。その結果、サブスクリプションの数が大幅に増大する可能性があります。マイクロソフト独自の商用サービスなど、非常に多くのサービスでは、その数が 1,000 を上回る場合もあります。そのため、多くの場合、組織のサブスクリプションを作成および管理するためにカスタム スキャフォールディングが作成されます。

リソース マネージャーを使用すると、サブスクリプション内で複数の環境をデプロイすることはさらに簡単になります。これにより、以前のモデルに存在したリソースに対して固定された以前の上限が緩和され、リソースの制約によるパーティション分割のニーズが大幅に軽減されます。

環境は、リソース グループに配置できます。これらのリソース グループに特定の RBAC を適用すると、環境を分離できるようになります。地理的な分離が必要なシナリオでは、リソース グループを使用して実現することも可能です。リソース グループが地域にまたがる場合もあるため、1 つ以上の地域に特定した分離を実行することもできます。

課金のロールアップや概要の表示に使用できるリソースとリソース グループにタグを適用することで、課金を分離できます。タグを使用すると、環境の種類 (研究、教育、開発、テスト、運用)、説明責任のある組織または個人 ("人事"、"経理"、"John Smith"、"Jane Jones" など) を定義できます。

監査の要件は、基礎となる Azure リソース マネージャーのそのまますぐに使用できる機能の一部として提供されており、一元的に表示できます。

最終顧客は、認証や、環境およびリソースに対するロールベースのアクセス制御に使用するアカウントを Azure Active Directory に登録しています。

#### 密度の最適化

リソースの制限は Azure リソース マネージャーで緩和されますが、それでも一定の制限はあります。環境自体の作成にとどまらず、サブスクリプション内での環境の密度の実現にも注目する必要があります。環境を提供することは、個人または組織に容量を提供することであるため、使用する関連の "T シャツ サイズ" を評価する必要があります。具体的には、必要なリソースの観点から、小規模、中規模、大規模、超大規模の顧客から指定します。

さらに密度を高くするために、"T シャツ サイズ" ごとに異なるサブスクリプションを使用することもできます。たとえば、特定のサブスクリプションでは、S サイズのデプロイ 1000 件、M サイズのデプロイ 500 件、L サイズのデプロイ 100 件、XL サイズのデプロイ 10 件に対応できます。複数のサブスクリプションを所有するのに課金コストはかからないため、各サイズを別々のサブスクリプションに分離して、密度を最大限に高めることができます。これは、サブスクリプションの数を比較的抑えて管理しやすい状態のまま実行できます。

ここで考慮すべき重要な点の 1 つは、顧客が "T シャツ サイズ" を大きくしたり変更したりできるようにするつもりかどうか、また、そうする場合にどのように対応するかということです。

1 つには、顧客が既存のリソース グループ内で追加容量を取得できるようにする方法があります。技術的には簡単に対応できますが、密度に影響します。この方法では、すべての顧客のサイズを明確に定義する代わりに、一定レベルの変動性を導入することで、密度を最適化するためのオーバーヘッドが追加されます。すべての小規模環境をサイズ X とした場合、最適な密度になるように、サブスクリプション内に配置する小規模環境の数をあらかじめ簡単に計算することができます。顧客が環境をカスタマイズできるようにすると、結果的に、環境のバリエーション数や数量が X、X+1、X+2 のように予測できなくなります。このレベルの変動性では、このような相違に対応するためにサブスクリプション内の容量を確保する必要があるため、密度が小さくなります。

この方法は可能ですが、一般的な方法としてはあまり理想的ではありません。これは、密度が小さくなり、より多くのオーバーヘッドを管理する必要があるためです。大規模な環境では、これがより有効なオプションとなる場合があります。サブスクリプションに配置されるこのような大規模環境と超大規模環境の数が少なくなると、今後の拡張に対応するために、サブスクリプションに配置するこうした環境の数を減らすこともできます。

また、顧客の現在のサイズの環境を削除して、別のサイズで新しい環境を作成する方法もあります。この方法は一部のシナリオに適していませんが、開発環境やテスト環境など、一時的に使用される環境に効果的です。

ここで次に簡単な方法として、顧客がより規模の大きい環境を取得し、自身でその環境への移行を管理できるようにします。たとえば、小規模環境に SQL Server をデプロイしている顧客は、中規模環境を購入することができ、個別に責任を持ってデータとカスタム状態を転送します。

または、このようなある規模から別の規模への移行に対応する管理されたサービスを提供する方法もあります。この方法は明らかに複雑ですが、ワークロードと顧客によっては、組織が積極的に使用する方法になる可能性もあります。

## 顧客ポリシーの制約が追加された環境を提供する

組織によっては、デプロイする環境に関する追加の要件とポリシーがある場合もあります。具体的には、組織には、外部に公開されるポートを制限するポリシーがあります。また、その環境の発信トラフィックと着信トラフィックの監視を要求するポリシーがある場合もあります。サポートとコストを考慮する場合は、最終顧客が作成、更新、削除できるリソースに対する制約があることもあります。環境を提供する組織では、通常、サポートするためにサブスクリプションへのアクセスも必要になります。

前のシナリオのスーパーセットであるこのシナリオでは、特定の種類のリソースを作成できるユーザーとできないユーザーに関する制約が設けられている特定のリソースの追加が必要になります。

ユーザーが特定のリソースを作成、更新、または削除できるかどうかは、ロールベースのアクセス制御を使用して制限できます。たとえば、特定のネットワーク VNET と、場合によっては、最終顧客が更新または削除できないサブネットを必要とする組織などがあります。

リソース ロックを実装して、リソースを読み取り専用にする、つまり、削除できないようにすることができます。RBAC を使用すると、ユーザーまたはサービス プリンシパルがリソースまたはリソース グループに対して特定のアクティビティを実行できるようにすることができます。

特定のトラフィック (アプリケーション内の階層間のトラフィックなど) が最初に中継ドメイン (仮想ネットワーク アプライアンスなど) を経由する必要がある組織では、ユーザー定義のルートを使用する必要があります。

仮想アプライアンスは、アプリケーションを実行する VM にすぎません。ファイアウォールや NAT デバイスなど、ネットワーク トラフィックを何らかの方法で処理するために使用されるアプリケーションが仮想アプライアンスで実行されます。数多くのサード パーティが Azure に仮想ネットワーク アプライアンスを提供していますが、組織は独自のアプライアンスを用意することもできます。

アプライアンスを "独自に用意する" 手法により、組織はオンプレミスの環境で使用できる既存のコードを再利用できます。仮想アプライアンスとして機能するこの VM は、自分宛てではない着信トラフィックを受信できることが必要です。VM が自分以外の宛先に向かうトラフィックを受信するためには、VM の IP 転送を有効にする必要があります。

これまでの例と同様に、リソースのライフサイクルと RBAC の制約をリソース グループ戦略の一環として見直して検討する必要があります。

## 内部の悪意のあるユーザーからリソースを保護する

組織にとっての懸念事項の 1 つとして、リソースとそのリソースをプロビジョニングするテンプレートを悪意のあるユーザーから保護する点が挙げられます。

この一例として、ある銀行では、悪意のあるソフトウェア開発者やその IT スタッフのメンバーが重要な情報を改ざんまたは抽出することで、データが犯罪を目論む悪意のあるユーザーの手に渡らないようにしたいと考えています。

一般的な企業シナリオでは、デプロイされたワークロード内の重要なシークレットにアクセスできる少人数の信頼されたオペレーターのグループと、それよりも少し大きなグループとして VM のデプロイを作成または更新できる開発者/運用担当者のグループを作ります。

VM のシークレットと証明書を調整および格納するには、Azure Key Vault を ARM と共に使用します。

資格情報コンテナー (キー マテリアルが格納されます) の作成と VM のデプロイ (資格情報コンテナーに格納されたキーへの参照を含みます) 用に、個別の ARM テンプレートを維持することをお勧めします。

Key Vault に格納されたシークレットは、厳密な RBAC により信頼されたオペレーターの手で制御されます。信頼されたオペレーターが退職または異動すると、自身が Vault 内に作成したキーにアクセスできなくなります。

デプロイ用の ARM テンプレートには、シークレットへの URI 参照のみが含まれます。つまり、実際のシークレットは、コード リポジトリ、構成リポジトリ、ソース コード リポジトリには存在しません。これにより、シークレットがフィッシングされる可能性が低くなるほか、悪意のあるユーザーによる改ざんの可能性も抑えることができます。

このドキュメントで既に説明したように、グローバルな Key Vault はありません。Key Vault は常に局所的であるため、シークレットは常に VM と同じローカリティ (および主権) を持ちます。

この方法の実装例については、このドキュメントの「シークレットと証明書」で説明しました。

## "サブスクリプション持ち込み" モデルを有効にする

社内 IT 部門、システム インテグレーター、クラウド サービス ベンダーは、顧客と共同で "サブスクリプション持ち込み" モデルを使用する場合があります。具体的には、組織が最終顧客にサービスを提供し、その顧客の Azure サブスクリプションをなんらかの方法で使用します。

この方法には複数のバリエーションがあり、次に説明するように、それぞれで要件が若干異なります。

### アカウント内のリソースを監視するための第三者アクセスを有効にする

監視用のアプリケーションを持つ組織では、そのアプリケーションで使用するデータを取得するために、顧客のサブスクリプションに対する読み取り専用アクセスが必要になる場合があります。この場合、期間限定の読み取り専用アクセスが必要です。監視サービスのプロバイダーとの関係が解消された場合にアクセスを終了できるように、アクセスは顧客が制御する必要があります。

#### Azure リソース マネージャーによる実装

この実装については、[こちら](http://www.dushyantgill.com/blog/2015/05/23/developers-guide-to-auth-with-azure-resource-manager-api/)にある Azure リソース マネージャー API による認証に関する開発者ガイドで詳しく説明しています。このドキュメントでは、実装の詳細な手順に加え、サンプル コードも示しています。

### ソフトウェアを 1 回だけデプロイするための第三者アクセスを有効にする

別の例では、組織は、顧客のアカウントにソフトウェアのあるバージョンをデプロイして構成する際、デプロイする期間中に書き込みアクセスを必要とする場合があります。

#### Azure リソース マネージャーによる実装

この例では、前の例と同様の方法に従います。

インストールの特定のニーズによっては、サービス プリンシパルに割り当てられている特定のロールで、インストールを実行するのに必要な最低レベルのアクセスだけを許可し、インストールの完了直後にそのアクセスを取り消す必要があります。

### データの保存に顧客のサブスクリプションを使用するための第三者アクセスを有効にする

たとえば、組織は、独自の環境でソフトウェアを実行する一方で、データの保存には顧客のアカウントを使用したいと考える場合があります。そうすると、顧客は、常に自身のデータを管理できるようになり、企業の IT 部門、システム インテグレーター、機能を提供する CSV へのコストや料金を余分に負担することなく、自身の判断によってプラットフォーム上で他のテクノロジ (Azure Machine Learning や HDInsight など) を利用できるようになります。そのためには、組織のストレージ アカウントに継続的にアクセスできる必要があります。その際、顧客を制御した状態で、その情報にアクセスするための監査情報にアクセスできるようにします。

#### Azure リソース マネージャーによる実装

これは、他の例と同じパターンを使用して実装されます。サービス プリンシパルには、ストレージ リソースへのアクセスが提供されます。このシナリオでは、ストレージ アカウントへの読み取りアクセスと書き込みアクセスをロールに設定する必要があるため、組み込みの共同作成者ロールをサービス プリンシパルに割り当てて、このレベルのアクセスを実現します。

このシナリオには、共有ストレージ アカウントを使用する当事者と第三者の両方が関与するため、ストレージ アカウントが誤って削除されないようにすることも求められます。シナリオのこの側面については、ストレージ アカウントにリソース ロックを適用します。

### 第三者によるサービスの管理を有効にする

別の例では、組織が、顧客のサブスクリプションでソフトウェアをデプロイ、監視、管理したいと考える場合があります。ソフトウェアがデプロイされた環境に対して可能な変更 (より明確にするには不可能な変更) という観点から、顧客に制約が課される場合があります。

#### Azure リソース マネージャーによる実装

これは、このセクションの冒頭で示されたパターンのスーパーセットに従います。具体的には、第三者が使用するサービス プリンシパルに、リソース グループ内のリソースへのフル アクセスを提供します。

さらに、顧客に対する制約があるため、顧客のユーザーまたはグループには、環境を使用するために適切な権限が付与されます。これは、このセクションで既に示したテンプレートを使用して実行できます。

最後に、特定のリソースが誤って削除されないようにすることが求められる場合もあります。その場合は、このような保護を必要とするリソースに対するリソース ロックも検討してください。

## 次のステップ

- テンプレート作成の詳細については、[テンプレートの作成](resource-group-authoring-templates.md)に関するページを参照してください。
- Azure リソース マネージャーのセキュリティ上の推奨事項については、「[Azure リソース マネージャーのセキュリティに関する考慮事項](best-practices-resource-manager-security.md)」を参照してください。
- テンプレート内やテンプレート間での状態の共有方法については、「[Azure リソース マネージャーのテンプレートでの状態の共有](best-practices-resource-manager-state.md)」を参照してください。

<!---HONumber=August15_HO6-->