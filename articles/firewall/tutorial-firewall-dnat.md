---
title: Azure portal で Azure Firewall DNAT を使用して受信トラフィックをフィルター処理する
description: このチュートリアルでは、Azure portal を使用して Azure Firewall DNAT をデプロイして構成する方法を学習します。
services: firewall
author: vhorne
ms.service: firewall
ms.topic: tutorial
ms.date: 9/25/2018
ms.author: victorh
ms.custom: mvc
ms.openlocfilehash: 766ad04251fbe404d43734115e41e23ae0a4be28
ms.sourcegitcommit: 32d218f5bd74f1cd106f4248115985df631d0a8c
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/24/2018
ms.locfileid: "46982051"
---
# <a name="tutorial-filter-inbound-traffic-with-azure-firewall-dnat-using-the-azure-portal"></a>チュートリアル: Azure portal で Azure Firewall DNAT を使用して受信トラフィックをフィルター処理する

受信トラフィックの変換とサブネットに対するフィルター処理を行うように Azure Firewall 宛先ネットワーク アドレス変換 (DNAT) を構成できます。 Azure Firewall には、受信規則と送信規則という概念はありません。 あるのはアプリケーション ルールとネットワーク ルールであり、それらがファイアウォールに入ってくるすべてのトラフィックに適用されます。 ネットワーク ルールが先に適用され、次にアプリケーション ルールが適用された後、これらのルールが終了します。

>[!NOTE]
>Firewall DNAT 機能は、現在 Azure PowerShell と REST のみで利用できます。

たとえば、ネットワーク ルールが一致した場合、アプリケーション ルールによるパケットの評価は行われません。 一致するネットワーク ルールが存在せず、パケットのプロトコルが HTTP/HTTPS の場合、パケットはアプリケーション ルールによって評価されます。 一致が見つからない場合、パケットは[インフラストラクチャ ルール コレクション](infrastructure-fqdns.md)に対して評価されます。 それでも一致するものがない場合、パケットは既定では拒否されます。

DNAT を構成すると、NAT ルール コレクションの動作は、**宛先ネットワーク アドレス変換 (DNAT)** に設定されます。 ファイアウォールのパブリック IP とポートは、プライベート IP アドレスとポートに変換されます。 その後、ルールが通常どおりに適用されます (ネットワーク ルールが先、その後にアプリケーション ルール)。 たとえば、TCP ポート 3389 でリモート デスクトップ トラフィックを許可するネットワーク ルールを構成するとします。 まずアドレス変換が発生し、その後、変換後のアドレスを使用してネットワーク ルールとアプリケーション ルールが適用されます。

このチュートリアルでは、以下の内容を学習します。

> [!div class="checklist"]
> * テスト ネットワーク環境を設定する
> * ファイアウォールをデプロイする
> * 既定のルートを作成する
> * DNAT ルールを構成する
> * ネットワーク ルールを構成する
> * ファイアウォールをテストする

Azure サブスクリプションをお持ちでない場合は、開始する前に [無料アカウント](https://azure.microsoft.com/free/?WT.mc_id=A261C142F) を作成してください。

このチュートリアルでは、2 つのピアリングされた VNet を作成します。
- **VN-Hub** - ファイアウォールはこの VNet 内にあります。
- **VN-Spoke** - ワークロード サーバーはこの VNet 内にあります。

## <a name="create-a-resource-group"></a>リソース グループの作成
1. Azure Portal ([http://portal.azure.com](http://portal.azure.com)) にサインインします。
1. Azure portal のホーム ページで **[リソース グループ]** をクリックし、**[追加]** をクリックします。
2. **[リソース グループ名]** に「**RG-DNAT-Test**」と入力します。
3. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
4. **[リソース グループの場所]** で、場所を選択します。 後で作成するすべてのリソースは同じ場所にある必要があります。
5. **Create** をクリックしてください。

## <a name="set-up-the-network-environment"></a>ネットワーク環境を設定する
最初に VNet を作成し、次にそれらをピアリングします。

### <a name="create-the-hub-vnet"></a>ハブ VNet を作成する
1. Azure portal のホーム ページで、**[すべてのサービス]** をクリックします。
2. **[ネットワーク]** で、**[仮想ネットワーク]** をクリックします。
3. **[追加]** をクリックします。
4. **[名前]** に「**VN-Hub**」と入力します。
5. **[アドレス空間]** に「**10.0.0.0/16**」と入力します。
7. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
8. **[リソース グループ]** で **[既存のものを使用]** を選択し、**[RG-DNAT-Test]** を選択します。
9. **[場所]** で、以前使用したのと同じ場所を選択します。
10. **[サブネット]** で、**[名前]** に「**AzureFirewallSubnet**」と入力します。

     ファイアウォールはこのサブネットに配置されます。サブネット名は AzureFirewallSubnet **でなければなりません**。
     > [!NOTE]
     > AzureFirewallSubnet サブネットの最小サイズは /25 です。
11. **[アドレス範囲]** に「**10.0.1.0/24**」と入力します。
12. 他の設定については既定値を使用し、**[作成]** をクリックします。

### <a name="create-a-spoke-vnet"></a>スポーク VNet を作成する

1. Azure portal のホーム ページで、**[すべてのサービス]** をクリックします。
2. **[ネットワーク]** で、**[仮想ネットワーク]** をクリックします。
3. **[追加]** をクリックします。
4. **[名前]** に「**VN-Spoke**」と入力します。
5. **[アドレス空間]** に「**192.168.0.0/16**」と入力します。
7. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
8. **[リソース グループ]** で **[既存のものを使用]** を選択し、**[RG-DNAT-Test]** を選択します。
9. **[場所]** で、以前使用したのと同じ場所を選択します。
10. **[サブネット]** の下の **[名前]** に「**SN-Workload**」と入力します。

    サーバーはこのサブネットに含まれます。
1. **[アドレス範囲]** に「**192.168.1.0/24**」と入力します。
2. 他の設定については既定値を使用し、**[作成]** をクリックします。

### <a name="peer-the-vnets"></a>VNet をピアリングする

次に、2 つの VNet をピアリングします。

#### <a name="hub-to-spoke"></a>ハブからスポークへ

1. **VN-Hub** 仮想ネットワークをクリックします。
2. **[設定]** で **[ピアリング]** をクリックします。
3. **[追加]** をクリックします。
4. 名前として「**Peer-HubSpoke**」と入力します。
5. 仮想ネットワークとして **[VN-Spoke]** を選択します。
7. **[OK]** をクリックします。

#### <a name="spoke-to-hub"></a>スポークからハブへ

1. **VN-Spoke** 仮想ネットワークをクリックします。
2. **[設定]** で **[ピアリング]** をクリックします。
3. **[追加]** をクリックします。
4. 名前として「**Peer-SpokeHub**」と入力します。
5. 仮想ネットワークとして **[VN-Hub]** を選択します。
6. **[転送されたトラフィックを許可する]** をクリックします。
7. **[OK]** をクリックします。

## <a name="create-a-virtual-machine"></a>仮想マシンを作成する

ワークロード仮想マシンを作成して、**SN-Workload** サブネットに配置します。

1. Azure portal のホーム ページで、**[すべてのサービス]** をクリックします。
2. **[Compute]** で、**[仮想マシン]** をクリックします。
3. **[追加]**、**[Windows Server]**、**[Windows Server 2016 Datacenter]**、**[作成]** を順にクリックします。

**基本**

1. **[名前]** に「**Srv-Workload**」と入力します。
5. ユーザー名とパスワードを入力します。
6. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
7. **[リソース グループ]** で **[既存のものを使用]** を選択し、**[RG-DNAT-Test]** をクリックします。
8. **[場所]** で、以前使用したのと同じ場所を選択します。
9. Click **OK**.

**サイズ**

1. Windows Server を実行するテスト仮想マシンの適切なサイズを選択します。 例: **[B2ms]** (8 GB RAM、16 GB のストレージ)。
2. **[選択]** をクリックします。

**設定**

1. **[ネットワーク]** の **[仮想ネットワーク]** で、**[VN-Spoke]** を選択します。
2. **[サブネット]** で、**[SN-Workload]** を選択します。
3. **[パブリック IP アドレス]** をクリックし、**[なし]** をクリックします。
4. **[パブリック受信ポートを選択]** で、**[パブリック受信ポートなし]** を選択します。 
2. 他の設定については既定値のままにし、**[OK]** をクリックします。

**まとめ**

概要を確認し、**[作成]** をクリックします。 これが完了するまでに数分かかります。

デプロイが完了したら、仮想マシンのプライベート IP アドレスをメモしてください。 これは、後でファイアウォールを構成するときに使用します。 仮想マシンの名前をクリックし、**[設定]** で **[ネットワーク]** をクリックして、プライベート IP アドレスを見つけます。


## <a name="deploy-the-firewall"></a>ファイアウォールをデプロイする

1. ポータルのホーム ページで、**[リソースの作成]** をクリックします。
2. **[ネットワーク]** をクリックし、**[おすすめ]** の後で **[すべて表示]** をクリックします。
3. **[ファイアウォール]** をクリックし、**[作成]** をクリックします。 
4. **[ファイアウォールの作成]** ページで、次の表を使用してファイアウォールを構成します。
   
   |設定  |値  |
   |---------|---------|
   |名前     |FW-DNAT-test|
   |サブスクリプション     |\<該当するサブスクリプション\>|
   |リソース グループ     |**既存のものを使用**: RG-DNAT-Test |
   |場所     |以前使用したのと同じ場所を選択します|
   |仮想ネットワークの選択     |**既存のものを使用**: VN-Hub|
   |パブリック IP アドレス     |**新規作成**。 パブリック IP アドレスは、Standard SKU タイプであることが必要です。|

2. **[Review + create]\(レビュー + 作成\)** をクリックします。
3. 概要を確認し、**[作成]** をクリックしてファイアウォールを作成します。

   デプロイが完了するまでに数分かかります。
4. デプロイが完了したら、**RG-DNAT-Test** リソース グループに移動し、**FW-DNAT-test** ファイアウォールをクリックします。
6. プライベート IP アドレスをメモします。 後で既定のルートを作成するときにこれを使用します。


## <a name="create-a-default-route"></a>既定のルートを作成する

**SN-Workload** サブネットで、送信の既定ルートがファイアウォールを通過するように構成します。

1. Azure portal のホーム ページで、**[すべてのサービス]** をクリックします。
2. **[ネットワーク]** で、**[ルート テーブル]** をクリックします。
3. **[追加]** をクリックします。
4. **[名前]** に「**RT-FWroute**」と入力します。
5. **[サブスクリプション]** で、ご使用のサブスクリプションを選択します。
6. **[リソース グループ]** で **[既存のものを使用]** を選択し、**[RG-DNAT-Test]** を選択します。
7. **[場所]** で、以前使用したのと同じ場所を選択します。
8. **Create** をクリックしてください。
9. **[更新]** をクリックし、**[RT-FWroute]** ルート テーブルをクリックします。
10. **[サブネット]**、**[関連付け]** の順にクリックします。
11. **[仮想ネットワーク]** をクリックし、**[VN-Spoke]** を選択します。
12. **[サブネット]** で、**[SN-Workload]** をクリックします。
13. Click **OK**.
14. **[ルート]** をクリックし、**[追加]** をクリックします。
15. **[ルート名]** に「**FW-DG**」と入力します。
16. **[アドレス プレフィックス]** に「**0.0.0.0/0**」と入力します。
17. **[次ホップの種類]** で、**[仮想アプライアンス]** を選択します。

    Azure Firewall は実際はマネージド サービスですが、この状況では仮想アプライアンスが動作します。
1. **[次ホップ アドレス]** に、前にメモしておいたファイアウォールのプライベート IP アドレスを入力します。
2. Click **OK**.


## <a name="configure-a-dnat-rule"></a>DNAT ルールを構成する

```azurepowershell-interactive
 $rgName  = "RG-DNAT-Test"
 $firewallName = "FW-DNAT-test"
 $publicip = type the Firewall public ip
 $newAddress = type the private IP address for the Srv-Workload virtual machine 
 
# Get Firewall
    $firewall = Get-AzureRmFirewall -ResourceGroupName $rgName -Name $firewallName
  # Create NAT rule
    $natRule = New-AzureRmFirewallNatRule -Name RL-01 -SourceAddress * -DestinationAddress $publicip -DestinationPort 3389 -Protocol TCP -TranslatedAddress $newAddress -TranslatedPort 3389
  # Create NAT rule collection
    $natRuleCollection = New-AzureRmFirewallNatRuleCollection -Name RC-DNAT-01 -Priority 200 -Rule $natRule
  # Add NAT Rule collection to firewall:
    $firewall.AddNatRuleCollection($natRuleCollection)
  # Save:
    $firewall | Set-AzureRmFirewall
```
## <a name="configure-a-network-rule"></a>ネットワーク ルールを構成する

1. **RG-DNAT-Test** を開き、**FW-DNAT-test** ファイアウォールをクリックします。
1. **FW-DNAT-test** ページの **[設定]** で、**[ルール]** をクリックします。
2. **[ネットワーク ルール コレクションの追加]** をクリックします。

次の表を使用するルールを構成し、**[追加]** をクリックします。


|パラメーター  |値  |
|---------|---------|
|名前     |**RC-Net-01**|
|優先順位     |**200**|
|動作     |**許可**|

**ルール**:

|パラメーター  |設定  |
|---------|---------|
|名前     |**RL-RDP**|
|プロトコル     |**TCP**|
|ソース アドレス     |*|
|宛先アドレス     |**Srv-Workload** のプライベート IP アドレス|
|ターゲット ポート|**3389**|


## <a name="test-the-firewall"></a>ファイアウォールをテストする

1. リモート デスクトップをファイアウォールのパブリック IP アドレスに接続します。 **Srv-Workload** 仮想マシンに接続する必要があります。
3. リモート デスクトップを閉じます。
4. **RC-Net-01** ネットワーク ルール コレクションの動作を **[拒否]** に変更します。
5. もう一度、ファイアウォールのパブリック IP アドレスへの接続を試します。 **[拒否]** ルールのため、今回は成功しないはずです。

## <a name="clean-up-resources"></a>リソースのクリーンアップ

次のチュートリアルのためにファイアウォール リソースを残しておくことができます。不要であれば、**RG-DNAT-Test** リソース グループを削除して、ファイアウォール関連のすべてのリソースを削除します。

## <a name="next-steps"></a>次の手順

このチュートリアルで学習した内容は次のとおりです。

> [!div class="checklist"]
> * テスト ネットワーク環境を設定する
> * ファイアウォールをデプロイする
> * 既定のルートを作成する
> * DNAT ルールを構成する
> * ネットワーク ルールを構成する
> * ファイアウォールをテストする

次に、Azure Firewall のログを監視することができます。

> [!div class="nextstepaction"]
> [チュートリアル: Azure Firewall のログを監視する](./tutorial-diagnostics.md)
