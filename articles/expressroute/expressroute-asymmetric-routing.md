<properties
   pageTitle="非対称ルーティング | Microsoft Azure"
   description="この記事では、送信先へのリンクが複数存在する場合に、ネットワーク内の非対称ルーティングに関して発生する可能性がある問題について説明します。"
   documentationCenter="na"
   services="expressroute"
   authors="osamazia"
   manager="carmonm"
   editor=""/>
<tags
   ms.service="expressroute"
   ms.devlang="na"
   ms.topic="get-started-article" 
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="08/23/2016"
   ms.author="osamazia"/>

# 複数のネットワーク パスを使用した非対称ルーティング

この記事では、送信元と送信先の間で利用できるパスが複数存在する場合に、行きと戻りでトラフィックが異なるルートを取る場合がある理由について説明します。

非対称ルーティングについて理解するには、2 つの概念を把握する必要があります。1 つは、複数のネットワーク パスの影響です。もう 1 つは、ファイアウォールなど、状態を維持するデバイスの動作です。これらのデバイスはステートフル デバイスと呼ばれます。これらの 2 つの要素が組み合わさると、ステートフル デバイスを介して発信されるトラフィックがステートフル デバイスによって認識されないためにドロップされることがあります。

## 複数のネットワーク パス

インターネット サービス プロバイダーを介したインターネットへのリンクがエンタープライズ ネットワークに 1 つしかない場合、インターネットとの間のトラフィックの往来はすべて同じパスを経由して行われます。多くの場合、企業は (冗長パスとして) 複数の回線を調達し、ネットワークのアップタイム向上を図ります。このような場合、ネットワークの外部のインターネットへと出て行くトラフィックはあるリンクを経由し、戻ってくるトラフィックは別のリンクを経由するということがあり得ます。この現象は一般に非対称ルーティングと呼ばれ、逆方向のトラフィックが元のフローとは異なるパスを経由します。

![Routing3](./media/expressroute-asymmetric-routing/AsymmetricRouting3.png)

上の説明はインターネットに関するものですが、複数のパスの他の組み合わせにも当てはまります。たとえば、同一の送信先に対してインターネット パスとプライベート パスがそれぞれ 1 つある場合、同一の送信先に対してプライベート パスが複数ある場合などです。

送信元から送信先の途上に位置する各ルーターは、計算に基づいて、送信先に到達するうえで最適なパスを導き出します。最適と思われるパスの決定は主に 2 つの要因に基づきます。

1.	外部ネットワーク間のルーティングは、(一般に BGP と呼ばれる) ボーダー ゲートウェイ プロトコルというルーティング プロトコルに基づきます。BGP では、アドバタイズメントが近隣ノードから取得され、数段階を経てそれらが実行されることで、送信先までの最適なパスが決定されます。その後、そのパスがルーティング テーブルに追加されます。
2.	ルートに関連付けられたサブネット マスクの長さ。IP アドレスは同一であるがサブネット マスクは異なる複数のアドバタイズメントが受け取られた場合、サブネット マスクの長いアドバタイズメントが優先されます。これは、サブネット マスクの長い方がより具体的なルートであると判断されるためです。

## ステートフル デバイス

ルーターは、ルーティングを行うためにパケットの IP ヘッダーを確認します。しかし、パケットをより詳細に確認するデバイスが存在します。これらのデバイスは通常、レイヤー 4 (TCP/UDP) のヘッダー、またはレイヤー 7 (アプリケーション レイヤー) のヘッダーまで確認します。このようなデバイスは、セキュリティ デバイスと帯域幅最適化デバイスのいずれかです。たとえば、一般的なステートフル デバイスとしてファイアウォールが挙げられます。プロトコル、TCP/UDP ポート、URL ヘッダーなどの各点に基づいて、ファイアウォールはそのインターフェイスを介してパケットを許可または拒否します。このパケット インスペクションでは、デバイスに大きな処理負荷がかかります。パフォーマンスを向上させるために、ファイアウォールではフローの最初のパケットが検査されます。パケットが許可されると、ファイアウォールの状態テーブルにフロー情報が保持されます。このフローに関連する後続パケットはすべて、最初の決定に基づいて許可されます。つまり、既存のフローに属するパケットがファイアウォールに届いたときに、パケットに関する事前の状態情報がない場合、このパケットはファイアウォールによってドロップされます。

## ExpressRoute を使用した非対称ルーティング

ExpressRoute 経由で Microsoft に接続すると、ネットワークに次のような変更が生じます。

1.	Microsoft へのリンクが複数になります。1 つは既存のインターネット接続で、もう 1 つは ExpressRoute によるものです。Microsoft に向かうトラフィックの一部がインターネットを経由して送信され、ExpressRoute を経由して戻ってくることがあります (またはその逆)。
2.	ExpressRoute 経由で特定の IP アドレスを受け取ります。これにより、ExpressRoute によって提供されるサービスについては、ユーザーのネットワークから Microsoft へのトラフィックで常に ExpressRoute が使用されます。

上記 2 つの変更の影響を理解するために、シナリオをいくつか見てみましょう。インターネットへの回線が 1 つのみであり、Microsoft のサービスをすべてインターネット経由で利用しているとします。ユーザーのネットワークから Microsoft へと送信され戻ってくるトラフィックは、同じインターネット リンクを経由し、ファイアウォールを通過します。ファイアウォールによって最初のパケットが確認され、フローが記録されます。状態テーブルにフローがあるため、戻りのパケットは許可されます。

![Routing1](./media/expressroute-asymmetric-routing/AsymmetricRouting1.png)


ここで ExpressRoute を有効にし、Microsoft から提供されるサービスを ExpressRoute を介して利用します。Microsoft の他のサービスはすべてインターネットを介して利用します。ExpressRoute に接続している境界に別のファイアウォールをデプロイします。特定のサービスについて、Microsoft によってより具体的なプレフィックスが ExpressRoute 経由でネットワークにアドバタイズされます。ルーティング インフラストラクチャは、これらのプレフィックスの優先パスとして ExpressRoute を選択します。パブリック IP アドレスが ExpressRoute 経由で Microsoft にアドバタイズされていない場合、Microsoft はインターネット経由でパブリック IP アドレスと通信します。そのため、ユーザーのネットワークから Microsoft への送信トラフィックには ExpressRoute が使用され、Microsoft から戻ってくるトラフィックにはインターネットが使用されます。境界のファイアウォールによって、状態テーブルにないフローの応答パケットが確認されると、戻りトラフィックがドロップされます。

ExpressRoute とインターネットに同一の NAT プールを使用する場合、ネットワーク内にあるプライベート IP アドレスのクライアントについて同様の問題が発生します。Windows Update などのサービスについては IP アドレスが ExpressRoute 経由でアドバタイズされていないため、これらのサービスに対する要求はインターネット経由で送信されます。ただし、戻りトラフィックは ExpressRoute 経由になります。インターネットと ExpressRoute から同じサブネット マスクの IP アドレスを受け取った場合、Microsoft はインターネットより ExpressRoute を優先します。ExpressRoute に接続するネットワーク境界に存在するファイアウォールまたはその他のステートフル デバイスに、フローに関する事前情報がない場合、そのフローに属するパケットはドロップされます。

## 非対称ルーティングの解決策

非対称ルーティングに関する問題を解決する方法は主に 2 つあります。1 つはルーティングで、もう 1 つは送信元ベースの NAT (SNAT) です。

1. ルーティング

    - パブリック IP アドレスは必ず適切な WAN リンクにアドバタイズする必要があります。たとえば、認証トラフィックにはインターネット、電子メール トラフィックには ExpressRoute を使用するつもりだとします。この場合、ADFS パブリック IP アドレスは ExpressRoute 経由でアドバタイズしないようにしてください。同様に、オンプレミスの ADFS サーバーは ExpressRoute 経由で受け取った IP アドレスに公開しないようにしてください。ExpressRoute 経由で受け取ったルートはより具体的であるため、Microsoft への認証トラフィックのパスとして ExpressRoute が優先されます。これにより、非対称ルーティングが発生します。

    - ExpressRoute を認証に使用したい場合は、NAT を使用せずに ExpressRoute 経由で ADFS パブリック IP アドレスをアドバタイズする必要があります。こうすることで、Microsoft からオンプレミスの ADFS サーバーに発信されたトラフィックが ExpressRoute を経由し、ユーザーから Microsoft に戻るトラフィックが、インターネットよりも優先される ExpressRoute を使用するようになります。

2. 送信元ベースの NAT

	非対称ルーティングの問題を解決するもう 1 つの方法は、送信元 NAT (SNAT) です。たとえば、SMTP サーバーによる通信にインターネットを使用するため、オンプレミスの SMTP サーバーのパブリック IP アドレスを ExpressRoute 経由でアドバタイズしていないとします。Microsoft からオンプレミスの SMTP サーバーに送信される要求はインターネットを経由します。送信元 NAT を使用して受信要求を内部 IP アドレスに変換します。SMTP サーバーからの逆方向トラフィックは、ExpressRoute ではなく (NAT に使用される) 境界ファイアウォールに届きます。これにより、戻りトラフィックがインターネットを経由するようになります。


![Routing2](./media/expressroute-asymmetric-routing/AsymmetricRouting2.png)

## 非対称ルーティングの検出

traceroute は、トラフィックが予想されるパスを経由していることを確認するうえで、最善の手段です。オンプレミスの SMTP サーバーから Microsoft に送信されるトラフィックがインターネット パスを経由することが予想される場合、SMTP サーバーから Office 365 に traceroute を使用します。その結果から、トラフィックが実際にユーザーのネットワークから (ExpressRoute ではなく) インターネットに向かって送信されていることが確認できます。

<!---HONumber=AcomDC_0824_2016-->