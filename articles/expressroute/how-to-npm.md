---
title: "Azure ExpressRoute 回線に使用する Network Performance Monitor の構成 (プレビュー) | Microsoft Docs"
description: "ExpressRoute 回線に使用する NPM を構成します。 (プレビュー)"
documentationcenter: na
services: expressroute
author: cherylmc
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 
ms.service: expressroute
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 11/13/2017
ms.author: cherylmc
ms.openlocfilehash: 9e459a42a9fd7caedfa255a7baf51273eef2265a
ms.sourcegitcommit: 8aa014454fc7947f1ed54d380c63423500123b4a
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/23/2017
---
# <a name="configure-network-performance-monitor-for-expressroute-preview"></a>ExpressRoute に使用する Network Performance Monitor の構成 (プレビュー)

Network Performance Monitor (NPM) は、Azure クラウド デプロイとオンプレミス拠点 (支社など) との間の接続性を監視するクラウドベースのネットワーク監視ソリューションです。 NPM は、Microsoft Operations Management Suite (OMS) に含まれています。 新たに ExpressRoute 用の拡張機能が追加され、プライベート ピアリングを使用するように構成された ExpressRoute 回線上のネットワーク パフォーマンスを監視できるようになりました。 ExpressRoute に対して NPM を構成することにより、特定して排除すべきネットワークの問題を検出することができます。

次のようにすることができます。

* 各種 VNet 間の損失と待ち時間を監視し、アラートを設定する

* ネットワーク上のすべてのパス (冗長パスを含む) を監視する

* 再現が難しい、ネットワークに関する一過性の問題と特定時点の問題をトラブルシューティングする

* パフォーマンス低下の原因となっている特定のセグメントをネットワーク上で見つけ出す

* 仮想ネットワークごとのスループットを把握する (各 VNet にエージェントがインストールされている場合)

* 過去の時点の ExpressRoute システム状態を確認する

## <a name="regions"></a>サポートされているリージョン

ExpressRoute 回線は、世界中どこにあっても、次のいずれかのリージョンにホストされているワークスペースで監視することができます。

* 西ヨーロッパ 
* 米国東部 
* 東南アジア 

## <a name="workflow"></a>ワークフロー

監視エージェントは、複数のサーバー (オンプレミスと Azure の両方) にインストールされます。 これらのエージェントは互いに通信を行いますが、データは送信せず、TCP ハンドシェイク パケットを送信します。 エージェント間の通信によって、Azure は、トラフィックが通過する可能性のある経路とネットワーク トポロジとをマッピングすることができます。

1. [サポートされているいずれかのリージョン](#regions)に NPM ワークスペースを作成します。
2. ソフトウェア エージェントをインストールして構成します。 
    * オンプレミス サーバーと Azure VM に監視エージェントをインストールします。
    * 監視エージェントが通信を行うことができるように、監視エージェント サーバー上の設定を構成します  (ファイアウォール ポートを開放するなど)。
3. Azure VM にインストールされている監視エージェントがオンプレミスの監視エージェントと通信を行うことができるようにネットワーク セキュリティ グループ (NSG) 規則を構成します。
4. NPM ワークスペースをホワイトリストに登録するよう依頼します。
5. 監視の設定を行います。NPM で表示可能なネットワークを自動検出して管理します。

既に Network Performance Monitor を使用して他のオブジェクトやサービスを監視しており、かつワークスペースが既に、サポートされているいずれかのリージョンに存在する場合は、手順 1. と手順 2. を省略し、手順 3. で構成を始めてください。

## <a name="configure"></a>手順 1. ワークスペースを作成する

1. [Azure Portal](https://portal.azure.com) で、**[Marketplace]** のサービス一覧で "Network Performance Monitor" を検索します。 検索結果で **[Network Performance Monitor]** をクリックしてそのページを開きます。

  ![ポータル](.\media\how-to-npm\3.png)<br><br>
2. **[Network Performance Monitor]** メイン ページの一番下にある **[作成]** をクリックして **[Network Performance Monitor - 新しいソリューションの作成]** ページを開きます。 **[OMS ワークスペース - ワークスペースを選択します]** をクリックしてワークスペース ページを開きます。 **[+ 新しいワークスペースの作成]** をクリックしてワークスペース ページを開きます。
3. **[OMS ワークスペース]** ページの **[新規作成]** を選択し、次の設定を構成します。

  * [OMS ワークスペース] - ワークスペースの名前を入力します。
  * [サブスクリプション] - 複数のサブスクリプションがある場合は、新しいワークスペースに関連付けるサブスクリプションを 1 つ選択します。
  * [リソース グループ] - リソース グループを作成するか、既存のリソース グループを使用します。
  * [場所] - [サポートされているリージョン](#regions)を選択する必要があります。
  * [価格レベル] - [無料] を選択します。
  
  >[!NOTE]
  >ExpressRoute 回線は、世界中のどこにあってもかまいません。ワークスペースと同じリージョンにある必要はありません。
  >


  ![ワークスペース](.\media\how-to-npm\4.png)<br><br>
4. 設定テンプレートを保存してデプロイするには、**[OK]** をクリックします。 テンプレートの検証後、**[作成]** をクリックしてワークスペースをデプロイします。
5. ワークスペースがデプロイされたら、作成した **[NetworkMonitoring(<名前>)]** リソースに移動します。 設定を確認して、**[このソリューションにはさらに構成が必要です]** をクリックします。

  ![追加の構成](.\media\how-to-npm\5.png)
6. **[ネットワーク パフォーマンス モニターへようこそ]** ページの **[代理トランザクションに TCP を使います]** を選択し、**[送信]** をクリックします。 TCP トランザクションは、接続の確立と切断にのみ使用されます。 これらの TCP 接続上でデータが送信されることはありません。

  ![代理トランザクションに TCP を使用](.\media\how-to-npm\6.png)

## <a name="agents"></a>手順 2. エージェントをインストールして構成する

### <a name="download"></a>2.1. エージェントのセットアップ ファイルをダウンロードする

1. 該当するリソースの **[ネットワーク パフォーマンス モニターの構成 - TCP のセットアップ] ページ**の **[OMS エージェントをインストールする]** セクションで、サーバーのプロセッサに対応するエージェントをクリックし、セットアップ ファイルをダウンロードします。

  >[!NOTE]
  >エージェントは Windows Server (2008 SP1 以降) にインストールする必要があります。 Windows デスクトップ OS や Linux OS を使用した ExpressRoute 回線の監視はサポートされていません。 
  >
  >
2. 次に、**[ワークスペース ID]** と **[主キー]** をメモ帳にコピーします。
3. **[エージェントを構成する]** セクションで PowerShell スクリプトをダウンロードします。 この PowerShell スクリプトは、TCP トランザクションに必要なファイアウォール ポートを開くのに役立ちます。

  ![PowerShell スクリプト](.\media\how-to-npm\7.png)

### <a name="installagent"></a>2.2. 各監視サーバーに監視エージェントをインストールする

冗長性のため、ExpressRoute 接続 (つまり、オンプレミス、Azure Vnet) の両側に、少なくとも 2 つのエージェントをインストールすることをお勧めします。 次の手順を使用してエージェントをインストールします。

1. ExpressRoute の監視に使用する各サーバーに対し、**セットアップ**を実行してエージェントをインストールします。 監視に使用するサーバーとしては、VM とオンプレミスとがあり、どちらもインターネット アクセスが必須です。 エージェントは、オンプレミスに少なくとも 1 つインストールすると共に、Azure で監視する各ネットワーク セグメントにつき 1 つインストールする必要があります。
2. **[ようこそ]** ページで **[次へ]** をクリックします。
3. **[ライセンス条項]** ページの記述内容を確認し、**[同意する]** をクリックします。
4. **[インストール先フォルダー]** ページで、既定のインストール フォルダーを変更するか、そのまま使用して、**[次へ]** をクリックします。
5. **[エージェントのセットアップ オプション]** ページで、Azure Log Analytics (OMS) または Operations Manager にエージェントを接続することを選択できます。 また、エージェントを後から構成する場合は、この選択肢を空欄にしておいてもかまいません。 必要な選択を行ったら、**[次へ]** をクリックします。

  * **Azure Log Analytics (OMS)** に接続することを選んだ場合は、前のセクションでメモ帳にコピーしておいた**ワークスペース ID** と**ワークスペース キー** (主キー) を貼り付けます。 次に、 **[次へ]**をクリックします。

    ![ID とキー](.\media\how-to-npm\8.png)
  * **Operations Manager** に接続することを選んだ場合は、**[管理グループの構成]** ページで **[管理グループ名]**、**[管理サーバー]**、**[管理サーバー ポート]** に入力します。 次に、 **[次へ]**をクリックします。

    ![Operations Manager](.\media\how-to-npm\9.png)
  * **[エージェント アクション アカウント]** ページで、**[ローカル システム]** アカウントまたは **[ドメインまたはローカル コンピューターのアカウント]** を選択します。 次に、 **[次へ]**をクリックします。

    ![アカウント](.\media\how-to-npm\10.png)
6. **[インストールの準備完了]** ページで、設定内容を確認し、**[インストール]** をクリックします。
7. **[構成は正常に終了しました]** ページで **[完了]** をクリックします。
8. 完了すると、コントロール パネルに Microsoft Monitoring Agent が表示されます。 そこでは構成を検証して、エージェントが Operational Insights (OMS) に接続されていることを確認できます。 OMS に接続されると、"**Microsoft Monitoring Agent は Microsoft Operations Management Suite サービスに正常に接続しました**" というメッセージがエージェントにより表示されます。

### <a name="proxy"></a>2.3. プロキシ設定の構成 (省略可能)

Web プロキシを使用してインターネットにアクセスしている場合、以下の手順を使用して、Microsoft Monitoring Agent のプロキシ設定を構成します。 これらの手順は、各サーバーに対して実行してください。 構成が必要なサーバーの数が多い場合には、このプロセスを自動化するスクリプトを使った方が作業が簡単に済むことも考えられます。 その場合は、「[スクリプトを使って Microsoft Monitoring Agent のプロキシ設定を構成するには](../log-analytics/log-analytics-windows-agents.md#to-configure-proxy-settings-for-the-microsoft-monitoring-agent-using-a-script)」を参照してください。

コントロール パネルを使って Microsoft Monitoring Agent のプロキシ設定を構成するには:

1. **コントロール パネル**を開きます。
2. **[Microsoft Monitoring Agent]**を開きます。
3. **[プロキシ設定]** タブをクリックします。
4. **[プロキシ サーバーを使用する]** をオンにして、URL と (必要に応じて) ポート番号を入力します。 プロキシ サーバーで認証が必要な場合には、プロキシ サーバーにアクセスするためのユーザー名とパスワードを入力します。

  ![proxy](.\media\how-to-npm\11.png)

### <a name="verifyagent"></a>2.4. エージェントの接続を確認する

エージェントが通信できているかどうかは簡単に確認できます。

1. 監視エージェントがインストールされているサーバーの**コントロール パネル**を開きます。
2. **[Microsoft Monitoring Agent]** を開きます。
3. **[Azure Log Analytics (OMS)]** タブをクリックします。
4. **[状態]** 列に、エージェントが Operations Management Suite サービスに正常に接続されていることが表示されます。

  ![status](.\media\how-to-npm\12.png)

### <a name="firewall"></a>2.5. 監視エージェント サーバーのファイアウォール ポートを開放する

TCP プロトコルを使用するには、ファイアウォール ポートを開放して、監視エージェントを確実に通信可能な状態にする必要があります。

Network Performance Monitor に必要なレジストリ キーを作成したり、監視エージェントが互いに TCP 接続を作成できるように Windows ファイアウォール規則を作成したりするための PowerShell スクリプトを実行できます。 スクリプトによって作成されたレジストリ キーは、デバッグ ログとログ ファイルのパスを記録するかどうかも指定します。 また、通信で使用されるエージェント TCP ポートを定義します。 これらのキーの値は、スクリプトによって自動的に設定されるため、これらのキーを手動で変更しないようにしてください。

ポート 8084 は既定で開放されます。 パラメーター "portNumber" をスクリプトに指定することでカスタム ポートを使用できます。 ただし、その場合は、スクリプトの実行対象となるすべてのサーバーで同じポートを指定する必要があります。

>[!NOTE]
>PowerShell スクリプト "EnableRules" によって Windows ファイアウォール規則を構成できるのは、スクリプトを実行したコンピューターだけです。 ネットワーク ファイアウォールがある場合、ネットワーク パフォーマンス モニターによって使用されている TCP ポート宛てのトラフィックを必ず許可する必要があります。
>
>

エージェント サーバー上で、管理特権で PowerShell ウィンドウを開きます。 あらかじめダウンロードしておいた PowerShell スクリプト [EnableRules](https://gallery.technet.microsoft.com/OMS-Network-Performance-04a66634) を実行します。 パラメーターは一切使用しません。

  ![PowerShell_Script](.\media\how-to-npm\script.png)

## <a name="opennsg"></a>手順 3. ネットワーク セキュリティ グループ規則を構成する

Azure 内の監視エージェント サーバーについては、NPM の代理トランザクションに使用されるポートの TCP トラフィックを許可するようにネットワーク セキュリティ グループ (NSG) 規則を構成する必要があります。 既定のポートは 8084 です。 これにより、Azure VM にインストールされている監視エージェントが、オンプレミスの監視エージェントと通信できるようになります。

NSG の詳細については、[ネットワーク セキュリティ グループ](../virtual-network/virtual-networks-create-nsg-arm-portal.md)に関するページを参照してください。

## <a name="whitelist"></a>手順 4. ワークスペースをホワイトリストに登録するよう依頼する

>[!NOTE]
>この手順に進む前に、エージェント (オンプレミス サーバー エージェントと Azure サーバー エージェントの両方) がインストール済みであること、また PowerShell スクリプトを実行済みであることを確認してください。
>
>

NPM の ExpressRoute 監視機能を使用するには、ワークスペースをホワイトリストに登録するようあらかじめ依頼しておく必要があります。 [こちらをクリックして表示されるページで、依頼フォームに入力してください](https://aka.ms/npmcohort)。 (ヒント: このリンクは、新しいウィンドウまたは新しいタブで開けます)。 ホワイトリストへの登録プロセスには、1 営業日以上かかることがあります。 ホワイトリストへの登録が完了したら、こちらからメールにてご連絡いたします。

## <a name="setupmonitor"></a>手順 5. ExpressRoute 監視用に NPM を構成する

>[!WARNING]
>ワークスペースがホワイトリストに登録されて確認のメールが届くまで、この先の手順は実行しないでください。
>
>

これまでのセクションが完了し、ホワイトリストへの登録が確認できたら、監視の設定作業に入ることができます。

1. **[すべてのリソース]** ページに移動し、ホワイトリストに登録された NPM ワークスペースをクリックして、Network Performance Monitor の概要タイルに移動します。

  ![npm ワークスペース](.\media\how-to-npm\npm.png)
2. **[Network Performance Monitor]** の概要タイルをクリックしてダッシュボードを表示します。 ダッシュボード内の ExpressRoute ページに、ExpressRoute が "未構成状態" であることが示されます。 **[機能のセットアップ]** をクリックして Network Performance Monitor の構成ページを開いてください。

  ![機能のセットアップ](.\media\how-to-npm\npm2.png)
3. 構成ページの左側のパネルにある [ExpressRoute ピアリング] タブに移動します。 **[今すぐ検出する]** をクリックします。

  ![検出](.\media\how-to-npm\13.png)
4. 検出が完了すると、回線名と VNet 名ごとの規則が表示されます。 初期状態では、これらの規則は無効になっています。 各規則を有効にしてから、監視エージェントとしきい値を選択します。

  ![規則](.\media\how-to-npm\14.png)
5. 規則を有効にして監視対象の値とエージェントを選択した後、30 ～ 60 分ほど待つと、値が反映され始め、**[ExpressRoute の監視]** タイルが利用できる状態になります。 監視中のタイルが表示されていれば、ExpressRoute 回線と接続リソースが NPM によって監視されています。

  ![監視タイル](.\media\how-to-npm\15.png)

## <a name="explore"></a>手順 6. 監視タイルを表示する

### <a name="dashboard"></a>[Network Performance Monitor] ページ

NPM ページには、ExpressRoute に関して、その回線とピアリングの正常性を大まかに示したページが表示されます。

  ![ダッシュボード](.\media\how-to-npm\dashboard.png)

### <a name="circuits"></a>回線の一覧

監視対象の全 ExpressRoute 回線の一覧を表示するには、**[ExpressRoute 回線]** タイルをクリックします。 いずれかの回線を選択すると、その正常性状態のほか、パケット損失、帯域幅使用率、待ち時間の各トレンド グラフを表示できます。 これらのグラフは対話操作が可能です。 グラフのプロット対象となる時間枠を自分で選んでカスタマイズすることができます。 グラフ上の領域でマウスをドラッグすることによってデータ ポイントを拡大し、細かく表示することができます。

  ![回線一覧](.\media\how-to-npm\circuits.png)

#### <a name="trend"></a>パケット損失、待ち時間、スループットのトレンド

帯域幅、待ち時間、損失の各グラフは対話操作が可能です。 これらのグラフの任意のセクションをマウス操作で拡大することができます。 また、左上の [アクション] ボタンの下にある **[日付/時刻]** をクリックすることによって、帯域幅、待ち時間、損失データの表示対象間隔を変更することもできます。

![トレンド](.\media\how-to-npm\16.png)

### <a name="peerings"></a>ピアリング一覧

ダッシュボードの **[プライベート ピアリング]** タイルをクリックすると、プライベート ピアリング上の仮想ネットワークに対するすべての接続の一覧が表示されます。 ここでいずれかの仮想ネットワークの接続を選択すると、その正常性状態のほか、パケット損失、帯域幅使用率、待ち時間の各トレンド グラフを表示できます。

  ![回線一覧](.\media\how-to-npm\peerings.png)

### <a name="topology"></a>回線トポロジ

回線トポロジを表示するには、**[トポロジ]** タイルをクリックします。 この操作により、選択した回線またはピアリングのトポロジ ビューが表示されます。 トポロジ ダイアグラムには、ネットワーク上の各セグメントの待ち時間が表示され、各レイヤー 3 ホップがダイアグラムのノードで表現されます。 いずれかのホップをクリックすると、そのホップについてのさらに詳しい情報が表示されます。
**[フィルター]** の下のスライダー バーを動かすことで、視認性を高めて表示範囲をオンプレミスのホップにまで広げることができます。 スライダー バーを左右に動かすと、トポロジ グラフに表示されるホップ数が増減します。 各セグメントの待ち時間が視覚的に確認できるので、ネットワーク上のセグメントの中で、待ち時間の長いセグメントを短時間で切り分けることができます。

![filters](.\media\how-to-npm\topology.png)

#### <a name="detailed-topology-view-of-a-circuit"></a>回線の詳細なトポロジ ビュー

このビューは、VNet 接続を示しています。
![詳細なトポロジ](.\media\how-to-npm\17.png)
