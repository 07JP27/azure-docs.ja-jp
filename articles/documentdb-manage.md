<properties title="Manage DocumentDB capacity and performance" pageTitle="Manage DocumentDB capacity and performance | Azure" description="Learn how you can elastically scale DocumentDB to meet the performance and storage needs of your application." metaKeywords="" services="documentdb" solutions="data-management"  authors="bradsev" manager="jhubbard" editor="cgronlun"  videoId="" scriptId="" />

<tags ms.service="documentdb" ms.workload="data-services" ms.tgt_pltfrm="na" ms.devlang="na" ms.topic="article" ms.date="08/20/2014" ms.author="bradsev" />

# DocumentDB の容量とパフォーマンスの管理

DocumentDB は、完全に管理された、きわめて拡張性の高いドキュメント指向の NoSQL データベース サービスです。DocumentDB 内では、仮想マシンのレンタル、ソフトウェアのデプロイ、データベースの監視などを行ったり、障害復旧の心配をしたりする必要はありません。Microsoft のエンジニアによって運用され、継続的な監視が行われる DocumentDB は、卓越した可用性、パフォーマンス、データ保護を提供します。

DocumentDB を使用するには、最初に Microsoft Azure ポータルを通じてデータベース アカウントを作成します。DocumentDB は、SSD ベースのストレージとスループットから構成される、スタック可能な容量単位 (CU) によって提供されます。お客様は、アプリケーションのパフォーマンスとストレージのニーズに合わせて DocumentDB を柔軟に拡張できます。

各容量単位には、ドキュメント データを格納するための柔軟なコレクションのクォータ、プロビジョニング済みドキュメント ストレージ、およびプロビジョニング済みスループット (1 秒あたりの要求単位) が設定されています。アプリケーションの容量要件が変化した場合は、データベース アカウントのプロビジョニング済み容量を拡大または縮小できます。データベース アカウントにプロビジョニングされた容量は、既に存在するかまたはそのアカウントに作成されるすべてのデータベースとコレクションで使用できます。

# データベース アカウントと管理クォータ

Azure の利用者であるお客様は、1 つまたは複数の DocumentDB データベース アカウントをプロビジョニングできます。各データベース アカウントには、100 個のデータベース、500,000 ユーザー、および 2,000,000 のアクセス許可を含む管理リソースのクォータが設定されます。

# ドキュメント ストレージが無制限のデータベース

1 つの DocumentDB データベースには、実質的に容量が無限の、コレクション別に区切られたドキュメント ストレージを格納できます。コレクションは、その中に含まれているドキュメントのトランザクション ドメインを構成します。DocumentDB データベースは、既定で高い柔軟性を持ち、数 GB から数ペタバイトに上る SSD ベースのドキュメント ストレージとプロビジョニング済みスループットが用意されています。従来の RDBMS データベースとは異なり、DocumentDB のデータベースはその範囲が単一のコンピューターに制限されません。

DocumentDB では、アプリケーションの規模を拡大することが必要になった時点で、さらに多くのコレクション、データベース、またはその両方を作成できます。実際、Microsoft 社内のさまざまなファースト パーティ アプリケーションでは、それぞれ数千個のコレクションと数テラバイトのドキュメント ストレージを含むきわめて大規模な DocumentDB データベースを作成することにより、コンシューマー規模で DocumentDB を使用しています。データベースは、アプリケーションの規模要件に合わせてコレクションを追加または削除することにより、拡大または縮小できます。データベース サブジェクト内では、可用性と購入した容量単位の量に合わせて、任意の数のコレクションを作成できます。お客様向けにプロビジョニングされた SSD ベースのストレージおよびスループットは、データベース アカウントのデータベースで複数のコレクションにわたって利用できます。

# 柔軟なコレクション

各 DocumentDB データベースには 1 つまたは複数のコレクションを格納できます。コレクションは、ドキュメント ストレージとクエリ実行のスコープを提供します。コレクションは、そこに含まれるすべてのドキュメントのトランザクション ドメインでもあります。コレクションは柔軟で、ストレージとスループットに関して拡大または縮小できます。アプリケーションの規模要件に合わせて任意の数のコレクションを作成できます。コレクションを作成するには、最初に 1 つまたは複数の容量単位 (CU) を購入する必要があります。各容量単位には、コレクションのクォータが含まれています。アカウントのコレクション クォータに達したら、追加の容量単位を購入できます。

> [AZURE.NOTE] プレビュー リリースでは、0 ～ 10 GB の範囲でコレクションを拡大または縮小できます。

# 容量単位としてのプロビジョニング済みストレージおよびスループット

SSD ベースのドキュメント ストレージとスループットから構成されるスタック可能な単位を容量単位 (CU) としてプロビジョニングできます読み取り規模、ストレージ、およびスループットに関するアプリケーションのニーズに合わせてより多くの容量単位を購入することにより、予測可能なパフォーマンスで DocumentDB を柔軟に拡大できます。

各 CU には、3 つの柔軟なコレクション、10 GB の SSD ベースのプロビジョニング済みドキュメント ストレージ、2,000 要求単位 (RU) のプロビジョニング済みスループットが用意されています。CU に関連付けられたプロビジョニング済みストレージおよびスループット容量は、お客様が作成した DocumentDB コレクション間で配分されます。

# プロビジョニング済みスループット、要求単位、およびデータベース操作

単純な GET 操作と PUT 操作を提供するキー/値の NoSQL ストアとは異なり、DocumentDB では、UDF、ストアド プロシージャ、およびトリガーを使用したリレーショナルおよび階層クエリなど、さまざまなデータベース操作をデータベース コレクション内のドキュメントに対して実行できます。これらの操作のそれぞれに関連付けられたコストは、操作を完了するために必要な CPU、IO、およびメモリに基づいて異なります。ハードウェア リソースの管理について考える代わりに、各種のデータベース操作を実行しアプリケーション要求を処理するのに必要なリソースに関する単一の測定単位として要求単位 (RU) を考えることができます。

要求単位は、お客様が購入した容量単位に基づいて、それぞれのデータベース アカウントにプロビジョニングされます。要求単位の消費は、1 秒あたりのレートとして評価されます。アカウントのプロビジョニング済み要求単位レートを超過するアプリケーションは、レートがそのアカウントに予約されているレベル以下になるまで制限されます。アプリケーションでより高いスループットが必要になった場合は、追加の容量単位を購入できます。

次の表に、各種のデータベース操作と、CU あたり利用可能な要求単位を示します。この表を見ると、特定のデータベース操作によって CU に関連付けられたプロビジョニング済みスループットがどの程度消費されるかがわかります。ここでは、ドキュメント サイズが 1 KB で、10 個の一意のプロパティ値から構成され、既定の一貫性レベルが "Session" に設定され、DocumentDB によってすべてのドキュメントのインデックスが自動的に作成されているものとします。

| データベース操作                                                             | CU あたり 1 秒あたりの操作の数 |
|------------------------------------------------------------------------------|--------------------------------|
| 1 つのドキュメントの読み込み                                                 | 2000                           |
| 1 つのドキュメントの挿入、置換、削除                                         | 500                            |
| 簡単な述語でコレクションに対するクエリを実行し、1 つのドキュメントを返す操作 | 1000                           |
| 50 のドキュメントを挿入するストアド プロシージャ                             | 20                             |

この表から、自動的にインデックスが作成されたドキュメントの挿入、置換、削除操作によって消費される要求単位は、ドキュメントの読み取りの場合の約 4 倍であることがわかります。この表は単なる基準です。実際には、次のことがあてはまります。

-   ドキュメント サイズは異なる (1 KB に対応しない) 可能性があります。
-   ドキュメントが 10 を超えるプロパティを持つ場合があります。
-   既定の一貫性レベルを "Strong"、"Bounded Staleness"、または "Eventual" に設定する可能性があります。
-   ドキュメントの一部のみにインデックスを作成しないよう選択する可能性があります。
-   プロパティの一部のみにインデックスを作成し、DocumentDB が自動的にすべての項目にインデックスを作成しないよう選択する可能性があります。
-   クエリおよびストアド プロシージャがより複雑である可能性があります。

アプリケーションに対する正確な数の要求単位を求めるには、各種の操作で消費される要求単位を計算するための要求単位計算ツールを使用できます。また、特定の要求で消費される要求単位の数を含む x-ms-request-charge 応答ヘッダーを調べることもできます。

[要求単位計算ツール][要求単位計算ツール]

# コレクションとプロビジョニング済みスループット

データベース アカウントのプロビジョニング済みスループットは、単一のコレクションの最大スループット レベル (要求単位) に達するまで、すべてのコレクションにわたって均一に割り当てられます。たとえば、単一の容量単位を購入し、単一のコレクションを作成した場合、その CU のプロビジョニング済みスループットのすべてがそのコレクションで使用されます。コレクションをもう 1 つ作成した場合、プロビジョニング済みスループットはそれぞれのコレクションに均等に割り当てられるため、それぞれに全プロビジョニング済みスループットの半分が割り当てられます。

# 一貫性レベルとスループットの選択

既定の一貫性レベルの選択内容により、スループットと待機時間が影響を受けます。既定の一貫性レベルは、プログラムで設定することも Azure ポータルを通じて設定することもできます。また、要求ベースで一貫性レベルをオーバーライドすることもできます。既定の一貫性レベルは、モノトニックな読み取り/書き込みおよび書き込みの読み取り保証を提供する "Session" 一貫性レベルとなります。"Session" 一貫性レベルは、ユーザー中心のアプリケーションに効果的で、一貫性とパフォーマンスのトレードオフが優れたバランスで実現されます。

-   "Session" および "Eventual" 一貫性レベルは、約 2,000 のドキュメントの読み取り要求と 500 のドキュメントの挿入、置換、削除要求を提供します。
-   "Strong" および "Bounded Staleness" 一貫性レベルは、約 1,200 のドキュメントの読み取り要求と 500 のドキュメントの挿入、置換、削除要求を提供します。"Bounded Staleness" では、"Strong" に比べて挿入、置換、削除操作の待機時間が大幅に短くなります。

[要求単位計算ツール][要求単位計算ツール]

# プロビジョニング済みドキュメント ストレージとインデックス オーバーヘッド

購入した CU ごとに、10 GB の SSD ベースのドキュメント ストレージがアカウントにプロビジョニングされます。10 GB のドキュメント ストレージには、ドキュメントとインデックス用のストレージが含まれます。既定では、DocumentDB コレクションは、セカンダリ インデックスまたはスキーマを明示的に必要とすることなくすべてのドキュメントのインデックスを自動的に作成するように構成されます。DocumentDB を使用するコンシューマー規模のファースト パーティ アプリケーションでの本番運用に基づくと、一般的なインデックス オーバーヘッドは 2 ～ 20% です。DocumentDB で使用しているインデックス作成テクノロジでは、プロパティの値に関係なく、既定の設定でインデックス オーバーヘッドがドキュメント サイズの 80% を超えることはありません。

既定では、DocumentDB によって自動的にすべてのドキュメントのインデックスが作成されます。ただし、インデックス オーバーヘッドを調整する場合は、ドキュメントの挿入時または置換時におけるインデックス作成の対象から特定のドキュメントを除外することができます。コレクション内のすべてのドキュメントをインデックス作成の対象から除外するように DocumentDB コレクションを構成できます。また、JSON ドキュメントのワイルドカードを使用して特定のプロパティまたはパスに関してのみ選択的にインデックスを作成するように DocumentDB コレクションを構成することもできます。プロパティまたはドキュメントを除外すると書き込みスループットが向上し、消費する要求単位が少なくなります。

[要求単位計算ツール][要求単位計算ツール]

  [要求単位計算ツール]: http://go.microsoft.com/fwlink/?LinkID=510088
