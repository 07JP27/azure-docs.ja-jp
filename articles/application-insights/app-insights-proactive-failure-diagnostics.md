<properties 
	pageTitle="Application Insights のほぼリアルタイムのプロアクティブ診断 | Microsoft Azure" 
	description="アプリ内での異常なエラー パターンについて警告し、診断分析を行います。構成は必要ありません。" 
	services="application-insights" 
    documentationCenter=""
	authors="yorac" 
	manager="douge"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="08/31/2016" 
	ms.author="awills"/>
 
# プロアクティブなエラー診断

[Visual Studio Application Insights](app-insights-overview.md) では、Web アプリでエラーの異常な増加が検出されると、ほぼリアルタイムで自動的にユーザーに通知されます。具体的には、失敗として報告された HTTP 要求の割合が異常に上昇すると、それが検出されます。通知には、問題のトリアージと診断に役立つよう、失敗した要求の特性および関連するテレメトリの分析結果が記載されています。また、より詳しい診断を行うために、Application Insights ポータルへのリンクも含まれています。この機能は、機械学習アルゴリズムを使用して通常のエラー率を予測するため、セットアップや構成は不要です。

この機能は、クラウドまたは独自のサーバーでホストされている Java と ASP.NET の Web アプリで利用できます。また、要求の製品利用統計情報を生成するあらゆるアプリで利用できます。たとえば、[TrackRequest()](app-insights-api-custom-events-metrics.md#track-request) を呼び出す worker ロールです。

[プロジェクト用に Application Insights](app-insights-overview.md) を設定し、アプリケーションで特定の最少限のテレメトリを生成する場合、プロアクティブなエラー診断は、オンに切り替わり、アプリケーションの通常の動作を学習するため、アラートを送信できるようになるまでに 24 時間かかります。

アラートの例を次に示します。

![Sample Intelligent Alert showing cluster analysis around failure](./media/app-insights-proactive-failure-diagnostics/010.png)

> [AZURE.NOTE] 既定では、この例よりも短い形式のメールが返されますが、[この詳細な形式に切り替える](#configure-alerts)ことができます。

次の指標が提示されます。

* 通常のアプリケーションの動作と比較したエラー率。
* 影響を受けるユーザーの数。アラートの重要度がわかります。
* エラーに関連付けられている特徴的パターン。この例では、特定の応答コード、要求名 (操作)、およびアプリケーションのバージョンがあります。これにより、コードのどこから探すべきかすぐにわかります。他には特定のブラウザーやクライアント オペレーティング システムなどが想定されます。
* 特徴付けられた要求の失敗に関連するように見える例外、ログ トレース、依存関係エラー (データベースやその他の外部コンポーネント)。
* Application Insights の製品利用統計情報の関連検索に直接リンクします。

## プロアクティブなアラートの利点

通常の[メトリック アラート](app-insights-alerts.md)から、問題がある可能性がわかります。ただし、プロアクティブなエラー診断が自動的に診断作業を開始し、ユーザーの代わりにさまざまな分析を実行します。結果はわかりやすくまとめられるので、問題の原因をすぐに把握できます。

## 動作のしくみ

ほぼリアルタイムのプロアクティブ診断では、アプリから受け取ったテレメトリ (特に要求失敗率) を監視します。このメトリックは、`Successful request` プロパティが false である要求の数をカウントします。既定で、`Successful request== (resultCode < 400)` ([フィルター](app-insights-api-filtering-sampling.md#filtering)にカスタム コードを記述した場合または独自の [TrackRequest](app-insights-api-custom-events-metrics.md#track-request) 呼び出しを生成する場合を除く)。

アプリのパフォーマンスには、一般的な動作パターンがあります。他よりもエラーが発生しやすい要求があります。負荷が増えると、全体的なエラー率が上がります。プロアクティブなエラー診断は Machine Learning を使用し、これらの異常を検出します。

テレメトリが Web アプリから Application Insights に送られます。プロアクティブなエラー診断は現在の動作と過去数日間に見られたパターンを比較します。以前のパフォーマンスと比べて失敗率の異常な上昇が検出された場合に、分析がトリガーされます。

分析がトリガーされると、サービスは失敗した要求のクラスター分析を実行して、失敗を特徴づける値のパターンの特定を試みます。上の例では、分析により、ほとんどの失敗が特定の結果コード、要求名、サーバー URL ホスト、およびロール インスタンスに関係していることが検出されました。これに対し、分析により、クライアント オペレーティング システムのプロパティが複数の値に分散していることが検出されたため、それはリストに表示されていません。

サービスがこれらの製品利用統計情報で計測される場合、アナライザーは特定されたクラスター内の要求に関連する例外と依存関係の失敗に加え、それらの要求に関連するすべてのトレース ログの例も検出します。

分析結果は、アラートとして電子メールで送信されます (送信しないように構成している場合を除きます)。

[手動で設定したアラート](app-insights-alerts.md)と同じように、Application Insights リソースの [アラート] ブレードでアラートの状態を検査し、構成できます。ただし、その他のアラートとは異なり、プロアクティブなエラー診断を設定したり、構成したりする必要はありません。必要に応じて、無効にすることや、送信先の電子メール アドレスを変更することもできます。


## アラートを構成する 

プロアクティブ診断の無効化、電子メール受信者の変更、Webhook の作成、詳細なアラート メッセージの選択を実行できます。

[アラート] ページを開きます。プロアクティブ診断が、手動で設定したすべてのアラートと共に含まれており、現在アラート状態にあるかどうかを確認できます。

![On the Overview page, click Alerts tile.Or on any Metrics page, click Alerts button.](./media/app-insights-proactive-failure-diagnostics/021.png)

アラートをクリックして構成します。

![構成](./media/app-insights-proactive-failure-diagnostics/031.png)


プロアクティブ診断は無効にできますが、削除 (および別の診断を作成) することはできません。

#### 詳細なアラート

[Receive detailed analysis] (詳細な分析を受信する) を選択すると、電子メールに多くの診断情報が記載されます。電子メール内のデータから問題を診断できる場合もあります。

詳細なアラートには例外やトレース メッセージが含まれるため、機密情報が記載されるというリスクがわずかながらあります。ただし、このような状況が生じるのは、コードによってそれらのメッセージに機密情報を含めることが許可されている場合のみです。


## アラートのトリアージと診断

アラートは、要求失敗率の異常な上昇が検出されたことを示します。アプリやその環境に何らかの問題があることが考えられます。

要求の割合と影響を受けるユーザーの数から、問題の緊急度を判断できます。上の例では、22.5% という失敗率が通常の失敗率である 1% と比較され、異常事態が発生していることを示しています。一方、影響を受けたユーザー数は 11 人のみです。それが自分のアプリであれば、その深刻度を評価できます。

多くの場合は、提供された要求名、例外、依存関係の失敗、トレース データからすばやく問題を診断することができます。

その他にもヒントがあります。たとえば、この例では依存関係のエラー率が例外率 (89.3%) と同じです。これが示すところは、例外が依存関係のエラーから直接発生しているということです。それにより、コードのどこから探すべきかわかります。

さらに詳しく調査する場合は、関連する要求、例外、依存関係、トレースで絞り込まれた[検索ページ](app-insights-diagnostic-search.md)に、各セクションのリンクから直接移動できます。また、[Azure ポータル](https://portal.azure.com)を開き、アプリケーションの Application Insights リソースに移動して、[エラー] ブレードを開くという方法もあります。

この例では、’依存関係エラーの詳細を表示する’ リンクをクリックすると、SQL ステートメントについての Application Insights の検索ブレードが開き、根本原因 (必須フィールドに NULL が指定されており、保存操作時に検証に合格しなかった) が表示されます。


![診断検索](./media/app-insights-proactive-failure-diagnostics/051.png)

## 最新のアラートを確認する

ポータルでアラートを確認するには、**[設定] の [監査ログ]** を開きます。

![Alerts summary](./media/app-insights-proactive-failure-diagnostics/041.png)


任意のアラートをクリックすると、その詳細情報がすべて表示されます。

または、**[プロアクティブ検出]** をクリックして、最新のアラートに直接アクセスします。

![Alerts summary](./media/app-insights-proactive-failure-diagnostics/070.png)




## 違い...

プロアクティブなエラー診断は、Application Insights の類似しているが異なるその他の機能を補完します。

* [メトリック アラート](app-insights-alerts.md)は、ユーザーが設定するアラートであり、CPU 占有率、要求率、ページの読み込み時間など、広範なメトリックを監視できます。このアラートを使用すると、リソースを追加する必要がある場合などに自分に警告することができます。これに対し、プロアクティブなエラー診断は、重要な少数のメトリック (現在は要求失敗率のみ) を対象としており、Web アプリの要求失敗率が Web アプリの通常の動作と比較して大幅に増加すると、ほぼリアルタイムでユーザーに通知するよう設計されています。

    プロアクティブなエラー診断は、優勢な状態に合わせてそのしきい値を自動調整します。

    プロアクティブなエラー診断は、ユーザーの代わりに診断作業を開始します。
* また、[プロアクティブな異常診断](app-insights-proactive-anomaly-diagnostics.md)では、マシン インテリジェンスを使用して、メトリックの異常なパターンを検出します。ユーザーが構成する必要はありません。ただし、プロアクティブなエラー診断とは異なり、プロアクティブな異常診断の目的は、(たとえば、特定の種類のブラウザーの特定のページで) 適切に処理されない可能性のあるさまざまな使用量のセグメントを検出することです。分析は毎日実行され、見つかった結果はアラートよりも緊急度が大幅に低い可能性があります。これに対し、プロアクティブなエラー診断の分析は、受け取ったテレメトリに対して継続的に実行され、サーバーのエラー率が予想を超えると数分以内にユーザーに通知します。

## プロアクティブなエラー診断アラートを受け取った場合

*このアラートを受け取った理由*

*	先行する期間の正常な基準値と比較し、要求失敗率の異常な上昇が検出されました。エラーと関連する製品利用統計情報を分析したところ、調査する必要のある問題があると思われます。

*この通知は、明らかに問題があることを意味していますか。*

*	アプリの中断や劣化に対してアラートを出すように試みますが、セマンティックスとアプリまたはユーザーに与える影響を完全に理解できるのは当人だけです。

*私のデータはマイクロソフトからも見られるのですか。*

*	いいえ。サービスは完全に自動化されています。通知を受け取るだけです。ユーザーのデータは[プライベート](app-insights-data-retention-privacy.md)です。

*このアラートをサブスクライブする必要はありますか。*

*	いいえ。要求の製品利用統計情報を送信するすべてのアプリケーションにこのアラート ルールがあります。

*登録を解除できますか。または、代わりに同僚に通知が送信されるように設定できますか。*

*	はい。[アラート ルール] で、プロアクティブ診断ルールをクリックし、設定します。アラートを無効にしたり、アラートの受信者を変更したりできます。

*メールが消えました。どうしたらポータルで通知を見つけられますか。*

*	監査ログで見つかります。[設定]、[監査ログ] をクリックすると、アラートの発生を確認できますが、詳細表示は制限されます。

*一部のアラートは既知の問題であり、受信を停止したいのですが。*

*	バックログでアラートを非表示にできます。


## 次のステップ

これらの診断ツールを使用すると、アプリからテレメトリを調査できます。

* [メトリックス エクスプローラー](app-insights-metrics-explorer.md)
* [Search エクスプローラー](app-insights-diagnostic-search.md)
* [Analytics - 強力なクエリ言語](app-insights-analytics-tour.md)

プロアクティブ検出は、すべて自動化されています。ただし、アラートを追加で設定する機能が用意されています。

* [手動で構成するメトリックのアラート](app-insights-alerts.md)
* [可用性 Web テスト](app-insights-monitor-web-app-availability.md)

<!---HONumber=AcomDC_0907_2016-->