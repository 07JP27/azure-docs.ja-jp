<properties 
	pageTitle="Application Insights のほぼリアルタイムのプロアクティブ診断" 
	description="NRT のプロアクティブ診断では、サーバーの応答時間が異常な動作を示している場合に自動的にユーザーに通知します。構成は必要ありません。" 
	services="application-insights" 
    documentationCenter=""
	authors="yorac" 
	manager="douge"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="03/05/2016" 
	ms.author="awills"/>
 
# ほぼリアルタイムのプロアクティブ診断

[Visual Studio Application Insights](app-insights-overview.md) では、Web アプリの要求失敗率が大幅に増加すると、ほぼリアルタイムで自動的にユーザーに通知します。通知には、問題のトリアージと診断に役立つよう、失敗した要求の特性および関連するテレメトリの分析結果が記載されています。また、より詳しい診断を行うために、Application Insights ポータルへのリンクも含まれています。この機能は、機械学習アルゴリズムを使用してベースラインとなる通常の失敗率を予測するため、セットアップや構成は不要です。これを機能させるには、最小量のトラフィックがある程度必要です。

この機能は、クラウドまたは独自のサーバーでホストされている Java と ASP.NET の Web アプリで利用できます。また、要求の製品利用統計情報を生成するあらゆるアプリで利用できます。たとえば、[TrackRequest()](app-insights-api-custom-events-metrics.md#track-request) を呼び出す worker ロールです。

プロアクティブ診断は、アプリで特定の裁量量の製品利用統計情報が生成される場合、[プロジェクトに Application Insights](app-insights-get-started.md) を設定したときにオンになります。

アラートの例を次に示します。

![Sample Intelligent Alert showing cluster analysis around failure](./media/app-insights-nrt-proactive-diagnostics/010.png)

次の指標が提示されます。

* 影響を受けるユーザーの数。アラートの重要度がわかります。
* エラーに関連付けられている特徴的パターン。この例では、特定の要求名があります (要求された URL)。これにより、コードのどこから探すべきかすぐにわかります。他には特定のブラウザーやクライアント デバイスの種類などが想定されます。
* エラーが発生した要求に関連すると想定される例外、ログ トレース、依存関係 (データベースやその他の外部コンポーネント) のエラー。
* Application Insights の製品利用統計情報の関連検索に直接リンクします。

通常の[メトリック アラート](app-insights-alerts.md)からは、問題のある可能性がわかります。ただし、NRT プロアクティブ診断が自動的に診断作業を開始し、ユーザーの代わりにさまざまな分析を実行します。結果はわかりやすくまとめられるので、問題の原因をすぐに把握できます。

## 動作のしくみ

ほぼリアルタイムのプロアクティブ診断では、アプリから受け取ったテレメトリ (特に要求失敗率) を監視します。このメトリックは、通常、400 番以上の応答コードを返した HTTP 要求の数を示します (ただし、[フィルター処理](app-insights-api-filtering-sampling.md#filtering)するか、独自の [TrackRequest](app-insights-api-custom-events-metrics.md#track-request) 呼び出しを生成するカスタム コードを記述した場合を除きます)。

アプリのパフォーマンスには、一般的な動作パターンがあります。他よりもエラーが発生しやすい要求があります。負荷が増えると、全体的なエラー率が上がります。NRT プロアクティブ診断は Machine Learning を利用し、そのような相関関係を探し出します。

製品利用統計情報が Web アプリから Application Insights に送られます。NRT プロアクティブ診断は現在の動作と過去数日間に見られたパターンを比較します。エラー率が前のパフォーマンスにより設定された予測値を大きく超えて跳ね上がると、アラートが発生します。

アラートが発生すると、要求の複数のディメンションに対してクラスター分析を実行して、失敗の特徴的な値のパターンの検出を試みます。上記の例では、ほとんどが特定の要求名に関する失敗ですが、ホスト インスタンスおよびサーバー インスタンスとは関係ないことが分析によって検出されています。

また、特定されたクラスター内の要求に関連する例外と依存関係のエラーに加え、それらの要求に関連するすべてのトレース ログの例も検出されています。

分析結果は、(送信しないように構成している場合を除き) 電子メールで送信されます。

[手動で設定したアラート](app-insights-alerts.md)と同じように、Application Insights リソースの [アラート] ブレードでアラートの状態を検査し、構成できます。ただし、その他のアラートとは異なり、NRT プロアクティブ診断を設定したり、構成したりする必要はありません。必要に応じて、無効にすることや、送信先の電子メール アドレスを変更することもできます。

## アラートのトリアージと診断

アラートは、要求失敗率の異常が検出されたことを示します。アプリやその環境に何らかの問題があることが考えられます。

要求の割合と影響を受けるユーザーの数から、問題の緊急度を判断できます。上の例では、15% というエラー率が通常のエラー率である 1.3% と比較され、異常事態が発生していることが判明します。22 名のユーザーが影響を受け、何らかの操作に失敗しました。それが自分のアプリであれば、その深刻度を評価できます。

多くの場合は、要求名、例外、依存関係、トレース データからすばやく問題を診断することができます。

その他にもヒントがあります。たとえば、この例では依存関係のエラー率が例外率 (89.3%) と同じです。これが示すところは、例外が依存関係のエラーから直接発生しているということです。それにより、コードのどこから探すべきかわかります。

さらに詳しく調査する場合は、関連する要求、例外、依存関係、トレースに基づいて絞り込んだ[検索ページ](app-insights-diagnostic-search.md)に各セクションのリンクから直接移動できます。また、[Azure ポータル](https://portal.azure.com)を開き、アプリの Application Insights リソースに移動して、[失敗] ブレードを開くという方法もあります。

この例では、検索リンクをクリックすると、SQL ステートメントで Application Insights の検索ブレードが開き、根本原因が表示されます。必須フィールドが NULL で、保存操作時に検証に合格しませんでした。


![診断検索](./media/app-insights-nrt-proactive-diagnostics/050.png)

## 最新のアラートを確認する

ポータルでアラートを確認するには、**[設定] の [監査ログ]** を開きます。

![Alerts summary](./media/app-insights-nrt-proactive-diagnostics/040.png)

任意のアラートをクリックすると、その詳細情報がすべて表示されます。


## アラートを構成する 

[アラート] ページを開きます。アダプティブ失敗アラートは、手動で設定したすべてのアラートと共に含まれており、現在アラート状態にあるかどうかを確認できます。

![On the Overview page, click Alerts tile.Or on any Metrics page, click Alerts button.](./media/app-insights-nrt-proactive-diagnostics/020.png)

アラートをクリックして構成します。

![構成](./media/app-insights-nrt-proactive-diagnostics/030.png)

アダプティブ失敗アラートは無効にできますが、削除 (および作成) することはできません。


## 違い...

NRT のプロアクティブ診断は、Application Insights の類似しているが異なるその他の機能を補完します。

* [メトリック アラート](app-insights-alerts.md)は、ユーザーが設定するアラートであり、CPU の占有率、要求率、ページの読み込み時間など、広範なメトリックを監視できます。このアラートを使用すると、リソースを追加する必要がある場合などに自分に警告することができます。これに対し、NRT のプロアクティブ診断は、重要な少数のメトリック (現在は要求失敗率のみ) を対象としており、Web アプリの要求失敗率が Web アプリの通常の動作と比較して大幅に増加すると、ほぼリアルタイムでユーザーに通知するよう設計されています。

    NRT プロアクティブ診断は、優勢な状態に合わせてそのしきい値を自動調整します。

    NRT プロアクティブ診断は、ユーザーの代わりに診断作業を開始します。 
* また、[プロアクティブな検出](app-insights-proactive-detection.md)では、マシン インテリジェンスを使用して、メトリックの異常なパターンを検出します。ユーザーが構成する必要はありません。ただし、NRT のプロアクティブ診断とは異なり、プロアクティブな検出の目的は、(たとえば、特定の種類のブラウザーの特定のページで) 適切に処理されない可能性のあるさまざまな使用量のセグメントを検出することです。分析は毎日実行され、見つかった結果はアラートよりも緊急度が大幅に低い可能性があります。これに対し、NRT のプロアクティブ診断の分析は、受け取ったテレメトリに対して継続的に実行され、サーバーのエラー率が予想を超えると数分以内にユーザーに通知します。

## NRT プロアクティブ診断アラートを受け取った場合

*このアラートを受け取った理由*

*	先行期間の正常な基準値と比較し、要求エラーの発生率が異常であることが検出されました。エラーと関連する製品利用統計情報を分析したところ、調査する必要のある問題があると思われます。 

*この通知は、明らかに問題があることを意味していますか。*

*	アプリの中断や劣化に対してアラートを出すように試みますが、セマンティックスとアプリまたはユーザーに与える影響を完全に理解できるのは当人だけです。

*私のデータはマイクロソフトからも見られるのですか。*

*	いいえ。サービスは完全に自動化されています。通知を受け取るだけです。ユーザーのデータは[プライベート](app-insights-data-retention-privacy.md)です。

*このアラートをサブスクライブする必要はありますか。*

*	いいえ。要求の製品利用統計情報を送信するすべてのアプリケーションにこのアラート ルールがあります。

*登録を解除できますか。または、代わりに同僚に通知が送信されるように設定できますか。*

*	はい。アラート ルールで、NRT プロアクティブ診断をクリックし、設定します。アラートを無効にしたり、アラートの受信者を変更したりできます。 

*メールが消えました。どうしたらポータルで通知を見つけられますか。*

*	監査ログで見つかります。[設定]、[監査ログ] の順にクリックし、アラートを選択するとその詳細が表示されます。

*一部のアラートは既知の問題であり、受信を停止したいのですが。*

*	バックログでアラートを非表示にできます。


## フィードバックをお寄せください

*この情報に関してご意見がございましたら是非お寄せください。宛先は * [ainrtpd@microsoft.com](mailto:ainrtpd@microsoft.com) です。

<!---HONumber=AcomDC_0309_2016-->