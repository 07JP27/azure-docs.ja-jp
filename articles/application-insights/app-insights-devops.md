<properties
	pageTitle="Application Insights を使用した Web アプリおよびサービスの詳細な診断"
	description="開発運用サイクルへの Application Insights の組み込み"
	services="application-insights"
    documentationCenter=""
	authors="alancameronwills"
	manager="douge"/>

<tags
	ms.service="application-insights"
	ms.workload="tbd"
	ms.tgt_pltfrm="ibiza"
	ms.devlang="multiple"
	ms.topic="article" 
	ms.date="06/09/2016"
	ms.author="awills"/>

# Application Insights を使用した Web アプリおよびサービスの詳細な診断

## Application Insights が必要な理由

Application Insights は、実行中の Web アプリを監視します。これを使用することで、エラーやパフォーマンスの問題を確認し、顧客がアプリを使用する方法を分析できます。多くのプラットフォーム (ASP.NET、J2EE、Node.js など) で実行されるアプリで動作し、クラウドまたはオンプレミスのいずれかで提供されます。

![](./media/app-insights-devops/010.png)

最新のアプリケーションは、実行中に監視する必要があります。最も重要なのは、ほとんどの顧客よりも早くエラーを検出することです。致命的なものでなくても、速度を低下させ、ユーザーに不都合をもたらす可能性のあるパフォーマンスの問題も検出して修正したいと考えることでしょう。また、システムが期待どおりに動作している場合は、ユーザーがシステムを使用して何をしているのか、つまり、最新機能を使用しているか、 うまく使用できているか、などを知りたいと思うでしょう。

最新の Web アプリケーションは、新機能または機能強化をリリースし、それがユーザー環境でどの程度正常に動作しているかを確認して、その知識に基づいて次の開発の強化を計画するという、継続的な提供サイクルの中で開発されます。ここで重要なのは、確認のフェーズです。Application Insights は、Web アプリケーションのパフォーマンスと使用状況を監視するためのツールを提供します。

このツールで最も重要なのは、診断と分析です。アプリケーションがクラッシュすると、ビジネスの損失が発生します。したがって、監視フレームワークの最も重要な役割は、エラーを確実に検出してすぐに通知し、問題を診断するために必要な情報を提供することです。これこそが Application Insights の機能です。

### バグはどこから発生するのか

通常、Web システムでのエラーは、構成の問題や、多くのコンポーネント間の不適切な相互作用に起因します。したがって、ライブ サイトのインシデントに取り組む際の最初のタスクは、問題の場所を特定することになります。原因となっているコンポーネントまたはリレーションシップは何か、ということです。

白髪頭の方々の中には、1 つのコンピューター プログラムが 1 台のコンピューターで実行されるという、より単純だった頃を覚えている方もいるでしょう。開発者は、出荷する前は徹底的にコンピューター プログラムをテストしますが、出荷してしまえば、プログラムを確認したり、それについて考えたりすることはめったにありませんでした。ユーザーは何年もの間、未解決のバグに我慢しなければなりませんでした。

しかし、今はまったく違います。アプリが実行されるデバイスは多種多様で、それぞれのデバイスでまったく同じ動作を保証することは困難である場合があります。クラウドでアプリを提供するということは、すばやくバグを修正できることを意味しますが、絶え間ない競争と頻繁な新機能の提供への期待も伴います。

このような状況で、バグの数を確実に管理する唯一の方法は、自動化された単体テストです。出荷のたびにすべてを手動で再テストすることは不可能でしょう。現在では、単体テストはビルド プロセスの一部として普及しています。複数のブラウザー バージョンでの UI テストの自動化を提供する Xamarin Test Cloud などのツールが役立ちます。このようなテスト方法を活用することで、私たちはアプリで見つかるバグの割合を最小限に抑えることを期待できます。

一般的な Web アプリケーションには多くのライブ コンポーネントがあります。クライアント (ブラウザーまたはデバイスのアプリ) と Web サーバーだけでなく、コンポーネントのパイプライン、連携する構成要素の厳密でない集合体など、相当量のバックエンド処理もあるでしょう。それらの多くは管理できません。なぜなら、依存する外部サービスだからです。

このような構成では、ライブ システム自体以外の、考えられるすべての障害の状態をテスト、あるいは予測することは困難かつ非経済的である場合があります。

### 質問 ...

私たちは Web システムを開発しているとき、次のような質問をします。

* アプリはクラッシュしていますか。 
* 正確には何が起こりましたか。要求に失敗した場合、そうなった経緯を把握したいと考えます。イベントのトレースが必要です。
* アプリの速度は十分ですか。 一般的な要求に応答する時間はどのくらいですか。
* サーバーは負荷を処理できますか。 要求の割合が増加した場合に応答時間は安定していますか。
* 依存するコンポーネント (アプリが呼び出す REST API、データベースなど) の応答速度はどのくらいですか。具体的には、そのシステムが低速の場合、それは自分のコンポーネントですか。または、他のユーザーから低速な応答を受け取っていますか。
* アプリは起動していますか、停止していますか。 世界各地で発生していますか。 アプリが停止するかどうかをお知らせください。
* 根本的な原因は何ですか。 コンポーネントまたは依存関係の障害でしたか。 通信に関する問題ですか。
* 影響を受けるユーザーの数はどのくらいですか。 対処すべき問題が複数ある場合は、最も重要なのはどれですか。



## Application Insights とは何か?


![](./media/app-insights-devops/020.png)


1. Application Insights では、アプリをインストルメント化し、アプリの実行時に、アプリに関するテレメトリを送信します。Application Insights SDK をアプリに組み込むか、実行時にインストルメンテーションを適用することができます。前者の方法は、標準のモジュールに独自のテレメトリを追加するできるため、より柔軟です。
2. テレメトリは、テレメトリが保管および処理される Application Insights ポータルに送信されます(Application Insights が Microsoft Azure で提供されている場合でも、Azure アプリだけでなく、任意の Web アプリを監視することができます)。
3. テレメトリは、イベントのグラフとテーブルの形式で表示されます。

テレメトリには 2 つの主な種類があります。 集計インスタンスと生のインスタンスです。

* インスタンス データには、たとえば Web アプリが受信した要求のレポートが含まれています。Application Insights ポータルの検索ツールを使用して、要求の詳細を検索して検査できます。インスタンスには、アプリが要求に応答するために要した時間、要求された URL、クライアントのおおよその場所などのデータが含まれています。
* 集計データには、要求の割合を応答時間と比較できるように、単位時間あたりのイベントの数が含まれています。要求の応答時間などのメトリックの平均値も含まれています。

データの主なカテゴリは次のとおりです。

* URL、応答時間、成功または失敗に関するデータを含む、アプリへの要求 (通常は HTTP 要求)。
* 依存関係 - URI、応答時間、および成功を含む、アプリケーションによって行われる REST および SQL の呼び出し。
* スタック トレースを含む例外。
* ユーザーのブラウザーから取得するページ ビュー データ。
* パフォーマンス カウンターなどのメトリックおよび自分で作成したメトリック。 
* ビジネス イベントを追跡するために使用できるカスタム イベント。
* デバッグに使用するログ トレース。


## ケース スタディ: レアル・マドリード F.C.

[レアル・マドリード フットボール クラブ](http://www.realmadrid.com/)の Web サービスは、世界各地の約 4 億 5,000 万人のファンにサービスを提供しています。ファンは、Web ブラウザーとクラブのモバイル アプリの両方からここにアクセスします。ファンはチケットを予約できるだけでなく、試合結果、選手、今後の試合に関する情報やビデオ クリップにもアクセスできます。フィルターを使用して、得点したゴールの数などを検索できます。ソーシャル メディアへのリンクもあります。ユーザー エクスペリエンスは高度にパーソナライズされており、ファンとの交流のための双方向コミュニケーションとして設計されています。

このソリューションは、[Microsoft Azure でのサービスとアプリケーションのシステム](https://www.microsoft.com/ja-JP/enterprise/microsoftcloud/realmadrid.aspx)です。スケーラビリティは重要な要件です。これは、トラフィックが非常に変わりやすく、試合の前後と試合中は、トラフィック量が大幅に増える場合があるためです。

レアル・マドリードでは、システムのパフォーマンスを監視することが不可欠です。Visual Studio Application Insights は、システム全体の包括的なビューを提供し、信頼性の高い、高いサービス レベルを確保できます。

クラブは、ファンに関する詳細な情報も取得します。この情報には、ファンの場所 (スペインはたった 3% です)、ファンが関心を持っている選手、過去の試合結果、今後の試合、および試合結果に対する反応が含まれます。

ソリューションを大幅に単純化し、運用上の複雑さを軽減した、このテレメトリ データの大部分は、コードの追加なしで自動的に収集されます。レアル・マドリードの場合、Application Insights は 1 か月あたり 38 億人のテレメトリ ポイントを処理します。

レアル・マドリードは Power BI モジュールを使用してテレメトリを表示します。


![](./media/app-insights-devops/080.png)

## スマート検出

[スマート診断](app-insights-nrt-proactive-diagnostics.md)は最新の機能です。特別な構成なしで、Application Insights はアプリの障害発生率の異常な増加を自動的に検出してアラートを生成します。一時的なエラーの背景と、要求の数に比例しただけの増加の背景を無視できるほどスマートです。そのため、たとえば、依存するサービスのいずれかで障害が発生した場合や、デプロイしたばかりの新しいビルドがうまく動作していない場合、電子メールを確認してすぐにそれを把握できます(他のアプリをトリガーできるように webhook も用意されています)。

テレメトリの詳細な分析を毎日実行し、検出が困難なパフォーマンスの異常なパターンを検出するのが、この機能のもう 1 つの側面です。たとえば、特定の地理的領域または特定のブラウザーのバージョンに関連付けられたパフォーマンスの低下を検出できます。

どちらの場合も、アラートは検出した現象を通知するだけでなく、関連する例外レポートなど、問題の診断に役立てるために必要なデータを提供します。

![](./media/app-insights-devops/030.png)

お客様である Samtec は次のように語っています。「私たちは、先日の機能のカット オーバーの際、リソースの限界に達し、タイムアウトを発生させている小規模なデータベースに気づきました。私たちが問題をトリアージしているとき、広告のとおり、まさにほぼリアルタイムでプロアクティブな検出アラートが生成されました。このアラートと Azure プラットフォームのアラートによって、ほぼ瞬時に問題を修正することができました。ダウンタイムは合計で 10 分未満でした。」

## ライブ メトリック ストリーム

最新のビルドを展開することは、気がかりな体験となる場合があります。何らかの問題がある場合、必要に応じて取り消すことができるように、すぐに問題を把握する必要があります。ライブ メトリック ストリームを使用すると、約 1 秒の待機時間で重要なメトリックが提供されます。

![](./media/app-insights-devops/040.png)

## アプリケーション マップ

アプリケーション マップは、アプリケーション トポロジを自動的に検出して、その上にパフォーマンス情報を配置し、分散環境全体のパフォーマンスのボトルネックと問題のあるフローを簡単に識別できるようにします。Azure サービスのアプリケーションの依存関係を検出できます。問題がコードに関連するか依存関係に関連するかを把握し、関連する診断操作を 1 か所から行うことで、問題をトリアージできます。たとえば、アプリケーションは SQL 層のパフォーマンスの低下が原因で失敗している可能性があります。アプリケーション マップを使用すれば、問題を視覚的に表示し、SQL Index Advisor やクエリの洞察の操作を行うことができます。

![](./media/app-insights-devops/050.png)

## Application Insights Analytics

[Analytics](app-insights-analytics.md) を使用すれば、強力な SQL に似た言語で任意のクエリを記述することができます。さまざまなパースペクティブが接続されるため、アプリ スタック全体を診断するのが簡単で、ビジネス メトリックおよび顧客満足度とサービスのパフォーマンスを関連付ける適切な質問をすることができます。

ポータルに格納されているすべてのテレメトリ インスタンスとメトリックの生データを照会できます。言語には、フィルター、結合、集計などの操作が含まれています。フィールドを計算し、統計的な分析を実行できます。テーブルとグラフ両方の視覚エフェクトがあります。

![](./media/app-insights-devops/025.png)

たとえば、次のことを簡単に行うことができます。

* アプリケーションの要求のパフォーマンス データを顧客層ごとに分割し、顧客満足度を把握します。
* ライブ サイトの調査中に特定のエラー コードまたはカスタム イベント名を検索します。
* 特定の顧客のアプリの使用状況をドリルダウンし、機能がどのように入手および導入されているかを把握します。
* 特定のユーザーのセッションと応答時間を追跡し、サポートおよび運用チームがすぐに顧客サポートを提供できるようにします。
* 頻繁に使用されるアプリ機能を判別し、機能の優先順位付けに関する質問に回答します。

お客様である DNN は次のように語っています。「Application Insights は、必要に応じてデータの結合、並べ替え、クエリ、およびフィルター処理を実現するための均衡の欠落部分を補ってくれました。当社のチームが独自のアイデアと経験を活用し、強力なクエリ言語でデータを検索できることで、当社は洞察を検索して、今まで知りもしなかった問題を解決することができます。*「...だろうか」*で始まる質問からは、多くの興味深い回答が生まれます。」

## 開発ツールの統合 

### Application Insights の構成

Visual Studio および Eclipse には、開発しているプロジェクトの正しい SDK パッケージを構成するためのツールが用意されています。新しいプロジェクトを作成する場合は、Application Insights を追加するオプションが用意されています。

Log4N、NLog、System.Diagnostics.Trace などのトレースを記録するフレームワークを使用している場合は、要求、依存関係の呼び出し、および例外とそのトレースを簡単に関連付けられるよう、他のテレメトリと共にログを Application Insights に送信することができます。

### Visual Studio でのテレメトリの検索

機能を開発およびデバッグしているとき、Web ポータルと同じ検索機能を使用して、Visual Studio で直接テレメトリを表示および検索することができます。

また、Application Insights で例外が記録されると、Visual Studio でそのデータ ポイントを確認し、関連するコードに直接移動できます。

![](./media/app-insights-devops/060.png)

デバッグ中は、開発用コンピューターにテレメトリを保存し、ポータルに送信することなく Visual Studio でそれを表示するオプションが用意されています。これにより、デバッグと運用環境のテレメトリの混合を回避できます。

### 注釈の作成

Visual Studio Team Services を使用してアプリのビルドとデプロイを行う場合、デプロイの注釈がポータルのグラフに表示されます。お使いの最新のリリースがメトリックに影響を与える場合、これは非常に明白になります。

![](./media/app-insights-devops/070.png)

### 作業項目 

Application Insights では、アラートが発生したときに、作業項目追跡システム (現時点では Visual Studio Team Services のみ) に自動的に作業項目を作成できます。

## 作業開始

Application Insights の操作は簡単です。主なオプションは次のとおりです。

* 既に実行中の Web アプリをインストルメント化します。これにより、すべての組み込みのパフォーマンス テレメトリが提供されます。[Java](app-insights-java-live.md)、[IIS サーバー](app-insights-monitor-performance-live-website-now.md)のほか、[Azure Web アプリ](app-insights-azure.md)でも使用できます。
* 開発中のプロジェクトをインストルメント化します。これは、[ASP.NET](app-insights-asp-net.md)、[Java](app-insights-java-get-started.md) アプリだけでなく、[Node.js](app-insights-nodejs.md) や[その他の種類](app-insights-platforms.md)のホストで実行できます。 
* 短いコード スニペットを追加して、[任意の Web ページ](app-insights-javascript.md)をインストルメント化します。


## 詳細について

* [プライバシーと記憶域](app-insights-data-retention-privacy.md) - テレメトリは Azure のセキュリティで保護されたサーバー上に保持されます。
* パフォーマンス - 影響は非常に低いです。テレメトリはバッチ処理されます。
* [サポート](app-insights-get-dev-support.md) - Azure サポート プログラムを活用できます。活気のあるフォーラムでは、当社の開発者から回答を得ることができます。最後の手段として、中でもベータの段階にありながら、個別のサポートを提供できます。
* [価格](app-insights-pricing.md) - 無料で開始することができ、容量が少ない間は無料期間を継続できます。

<!---HONumber=AcomDC_0615_2016-->