<properties 
	pageTitle="Application Insights におけるテレメトリ サンプリング" 
	description="テレメトリのボリュームを抑制する方法。" 
	services="application-insights" 
    documentationCenter="windows"
	authors="vgorbenko" 
	manager="douge"/>

<tags 
	ms.service="application-insights" 
	ms.workload="tbd" 
	ms.tgt_pltfrm="ibiza" 
	ms.devlang="na" 
	ms.topic="article" 
	ms.date="10/20/2015" 
	ms.author="awills"/>

#  Application Insights におけるサンプリング

*Application Insights はプレビュー段階です。*


サンプリングは Application Insights に含まれるオプションであり、これを使用することで、アプリケーション データを統計的に正しく分析し続けながら、削減された一連のテレメトリを収集して保存することができます。通常は、トラフィックを削減して[スロットル](app-insights-pricing.md#data-rate)を防止するために使用します。関連する項目がフィルターを通過できるような方法でデータがフィルター処理されるため、削減されたデータ セットを使用して診断調査を実行できます。クライアント側とサーバー側では、関連する項目をフィルター処理するように自動的に調整が行われます。ポータルでメトリック数が表示されるときは、統計値への影響を最小限に抑えるために、メトリック数を再正規化してサンプリングに配慮します。


サンプリングは現在ベータ版の段階にあり、今後変更される可能性があります。

## アプリケーション用のサンプリング構成

サンプリングは、現在 ASP.NET SDK または[任意の Web ページ](#other-web-pages)で利用できます。

### ASP.NET サーバー

1. プロジェクトの NuGet パッケージを Application Insights の最新の*プレリリース* バージョンに更新します。ソリューション エクスプ ローラーでプロジェクトを右クリックし、[NuGet パッケージの管理] を選択し、**[プレリリースを含める]** をオンにして、Microsoft.ApplicationInsights.Web を検索します。 

2. 次のスニペットを [ApplicationInsights.config](app-insights-configuration-with-applicationinsights-config.md) に追加します。

```XML

    <TelemetryProcessors>
     <Add Type="Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel.SamplingTelemetryProcessor, Microsoft.AI.ServerTelemetryChannel">

     <!-- Set a percentage close to 100/N where N is an integer. -->
     <!-- E.g. 50 (=100/2), 33.33 (=100/3), 25 (=100/4), 20, 1 (=100/100), 0.1 (=100/1000) -->
     <SamplingPercentage>10</SamplingPercentage>
     </Add>
   </TelemetryProcessors>

```

> [AZURE.NOTE]サンプリング率には、N を整数として 100/N に近い割合を選択します。サンプリングでは現在、その他の値はサポートされていません。

<a name="other-web-pages"></a>
### JavaScript を使用した Web ページ

任意のサーバーからのサンプリング用に Web ページを構成できます。ASP.NET サーバーの場合は、クライアント側とサーバー側の両方を構成します。

[Application Insights 用に Web ページを構成する](app-insights-javascript.md)場合は、Application Insights ポータルからスニペットを入手して、それを変更します。(ASP.NET では、\_Layout.cshtml 内にあります)。 `samplingPercentage: 10,` のような行をインストルメンテーション キーの前に挿入します。

    <script>
	var appInsights= ... 
	}({ 

	samplingPercentage: 10, 

	instrumentationKey:...
	}); 
	
	window.appInsights=appInsights; 
	appInsights.trackPageView(); 
	</script> 

JavaScript 内で指定しているサンプリング率が、サーバー側で指定した値と同じであることを確認します。

[API の詳細はこちら](app-insights-api-custom-events-metrics.md)


### 代替手順: サーバー コードでサンプリングを設定します。


.config ファイルにサンプリング パラメーターを設定する代わりに、コードを使用できます。これにより、サンプリングをオンまたはオフにできます。

*C#*

```C#

    using Microsoft.ApplicationInsights.Extensibility;
    using Microsoft.ApplicationInsights.WindowsServer.TelemetryChannel;

    // It's recommended to set SamplingPercentage in the .config file instead.

    // This configures sampling percentage at 10%:
    TelemetryConfiguration.Active.TelemetryChannel = new TelemetryChannelBuilder().UseSampling(10.0).Build();

```


## サンプリングを使用する場合

ほとんどの中小規模アプリケーションには、サンプリングは不要です。最も役立つ診断情報や最も正確な統計値は、すべてのユーザー アクティビティからデータを収集することで入手します。

 
サンプリングを使用する主な理由は次のとおりです。


* アプリが短期間に非常に高いレートのテレメトリを送信すると、Application Insights サービスがデータ ポイントを削減 ("スロットル") する。 
* データ ポイントを、価格レベルの[クォータ](app-insights-pricing.md)以内に抑える必要がある。 
* テレメトリの収集によるネットワーク トラフィックを削減する。 

## サンプリングのしくみ

アプリケーションの観点から見ると、サンプリングとは Application Insights SDK の機能です。ユーザーは、すべてのデータ ポイントの何パーセントが Application Insights サービスに送信されるかを指定します。Application Insights SDK のバージョン 2.0.0 からは、コードによってサンプリング率を制御できます(SDK の今後のバージョンでは、ApplicationInsights.config file からサンプリング率を構成する機能が追加されます)。

SDK では、削除するテレメトリ項目と、維持するテレメトリ項目を決めます。サンプリングはいくつかのルールに基づいて決定されますが、このルールのねらいは、削減されたデータ セットを使用する場合でも、Application Insights の診断機能を実用的で信頼性の高いものに維持しながら、すべての相互に関連するデータ ポイントはそのままの状態で保持することです。たとえば、失敗した要求に対してアプリが追加のテレメトリ項目 (この要求からログに記録された例外やトレースなど) を送信した場合、サンプリングでは、この要求とその他のテレメトリを分割することはありません。すべてをまとめて維持するか、削除するかのどちらかです。そのため、Application Insights で要求の詳細を表示する場合は、その要求に加えて、関連付けられているテレメトリ項目も常に表示されます。

"ユーザー" を定義するアプリケーション (つまり、最も一般的な Web アプリケーション) の場合、サンプリングはユーザー ID のハッシュに基づいて決定されるため、特定のユーザーのすべてのテレメトリが保持されるか、削除されることになります。ユーザーを定義しないタイプのアプリケーション (Web サービスなど) の場合、サンプリングは要求の操作 ID に基づいて決定されます。最後に、ユーザーも操作 ID も設定されていないテレメトリ項目 (http コンテキストのない、非同期スレッドから報告されたテレメトリ項目など) の場合、サンプリングでは各タイプのテレメトリ項目を単純に一定の割合ずつキャプチャします。

テレメトリを表示する場合、Application Insights サービスは、不足しているデータ ポイントを補正するために、収集時に使用したものと同じサンプリング率でメトリックを調整します。そのため、Application Insights でテレメトリを表示する場合、ユーザーは統計的に正しく、実際の数値に非常に近い近似値を見ていることになります。

近似精度は、構成したサンプリング率に大きく左右されます。また、多数のユーザーからの同じような要求を大量に処理するアプリケーションの場合は、近似精度が高くなります。一方で、処理量が膨大ではないアプリケーションの場合、通常はクォータの範囲内ですべてのテレメトリを送信でき、スロットルによるデータの損失もないため、サンプリングは必要ありません。

Application Insights では、精度が問題のあるレベルまで低下する可能性があるため、メトリックおよびセッションのテレメトリ タイプに対するサンプリングは行いません。

## サンプリングと JavaScript SDK

サンプリングでは、クライアント側 (JavaScript) SDK とサーバー側 SDK を組み合わせて使用します。SDK が追加されたページは、サーバー側が "サンプリングに入れる" と判断したユーザーと同じユーザーからのクライアント側テレメトリのみを送信します。これは、クライアント側とサーバー側の間でユーザー セッションの整合性を維持するためのロジックです。その結果、Application Insights 内の特定のテレメトリ項目から、このユーザーまたはセッションに関するその他すべてのテレメトリ項目を見つけることができます。

*クライアント側とサーバー側のテレメトリに、前述されているような調整済みのサンプルが表示されない場合。*

* サーバーとクライアントの両方でサンプリングを有効にしていることを確認してください。
* SDK のバージョンが 2.0 以降であることを確認してください。
* クライアントとサーバーの両方で同じサンプリング率を設定していることを確認してください。


## よく寄せられる質問 

*サンプリングを、"各テレメトリ タイプの X% を収集" という単純な方法にしないのはなぜですか。*

 *  このサンプリング方法の場合、メトリックの近似精度は非常に高くなりますが、一方でユーザーごと、セッションごと、要求ごとに診断データを関連付けるという、診断には欠かせない機能が利用できなくなります。そのため、サンプリングには "アプリ ユーザーの X% に関するすべてのテレメトリ項目を収集"、または "アプリ要求の X% に関するすべてのテレメトリを収集" というロジックが適しています。要求に関連付けられていないテレメトリ項目 (バックグラウンドの非同期処理など) の場合は、代わりに "各テレメトリ タイプに関するすべての項目の X% を収集" とします。 

*サンプリング率は、時間経過に伴い変更できますか。*

 * 現在の実装では、通常、アプリケーションの開始時にサンプリング率を設定した後、それを変更することはありません。実行時にサンプリング率を制御できても、どのサンプリング率が最適で、"ちょうどいい量のデータ ボリューム" を収集できるかということを、スロットル ロジックが開始する前や、データ ボリュームが月間クォータに達する前に判断する方法はありません。今後の Application Insights SDK のバージョンにはアダプティブ サンプリングが含まれる予定ですが、この機能では、現在観測されているテレメトリのボリュームやその他の要素に基づき、即時にサンプリング率を上下に調整します。 

*自分のアプリに最適なサンプリング率は、どのようにして確認できますか。*

* 現状では、推測するしかありません。AI での現在のテレメトリ使用状況を分析し、スロットルに関連したデータの削除を観察して、収集されるテレメトリのボリュームを見積もります。これら 3 つの情報に、選択した価格レベルを合わせて考えると、収集されるテレメトリのボリュームをどれくらい削減する必要があるかがわかります。ただし、テレメトリ ボリュームのパターンが変化することで、最適に構成されたサンプリング率が無効になる場合もあります (たとえばユーザー数の増加など)。アダプティブ サンプリングが実装されると、観測されたテレメトリ ボリュームに基づき、サンプリング率を最適なレベルに自動制御できるようになります。

*サンプリング率を低く構成しすぎると、どうなりますか。*

* Application Insights がデータ ボリュームの減少に関してデータの可視化を補正しようとしている場合、極端に低いサンプリング率 (過度にアグレッシブなサンプリング) は、近似精度の低下につながります。また、低頻度の失敗や遅い要求の一部はサンプリングから除外される場合があるため、診断機能に悪影響を及ぼす可能性もあります。

*サンプリング率を高く構成しすぎると、どうなりますか。*

* サンプリング率を高く構成しすぎた (十分にアグレッシブでない) 場合は、収集されるテレメトリのボリュームが十分に減少しないことになります。スロットルに関連するテレメトリ データが失われる可能性が残り、超過料金によって Application Insights の使用コストが予定額を超える場合もあります。

*サンプリングはどのようなプラットフォームで使用できますか。*

* 現在、サンプリングは、任意の Web ページと、クライアント側およびサーバー側の両方の .NET Web アプリケーションで使用できます。

*デバイス アプリ (Windows Phone、iOS、Android、またはデスクトップ アプリ) でサンプリングを使用できますか。*

* 残念ですが、デバイス アプリケーション向けのサンプリングは、現時点ではサポートされていません。 

>>>>>>> 36f8b905a3f60271ee6dc3a17c3ca431937287dc

<!---HONumber=Nov15_HO2-->