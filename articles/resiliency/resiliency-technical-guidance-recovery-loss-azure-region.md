<properties
   pageTitle="Azure リージョンの損失から復旧するための回復性に関する技術的ガイダンス |Microsoft Azure"
   description="回復力のあるアプリケーション、高可用性のアプリケーション、およびフォールト トレラント アプリケーションの内容および設計方法、ならびに障害復旧の計画策定に関する記事。"
   services=""
   documentationCenter="na"
   authors="adamglick"
   manager="hongfeig"
   editor=""/>

<tags
   ms.service="resiliency"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="05/13/2016"
   ms.author="patw;jroth;aglick"/>

#Azure の回復性に関する技術ガイダンス - Azure リージョン全体のサービス中断からの復旧

Azure はリージョンと呼ばれる物理的および論理的な単位に分割されます。リージョンは、ごく近くにある 1 つ以上のデータセンターで構成されます。この記事の執筆時に、Azure には世界中に 24 のリージョンがありました。まれに、1 つのリージョン全体の施設がネットワーク障害などでアクセスできなくなったり、自然災害などで完全に失われたりする可能性があります。ここでは、リージョンに分散するアプリケーションを作成するための Azure の機能について説明します。リージョンは、1 つのリージョンの障害が他のリージョンに影響を与える可能性を最小限に抑えるように設計されています。

##Cloud Services

###リソース管理
リージョン間でのコンピューティング インスタンスの分散は、各対象リージョンに個別のクラウド サービスを作成し、各クラウド サービスにデプロイ パッケージを発行することで実行されます。ただし、さまざまなリージョンのクラウド サービス間でのトラフィックの分散は、アプリケーション開発者またはトラフィック管理サービスによって行われる必要があることに注意してください。

障害復旧のために事前にデプロイする予備のロール インスタンスの数を決定することは、容量計画の重要な要素です。フルスケールのセカンダリ デプロイを備えると、必要になったときに容量がすぐに使用できるようになりますが、実質的にコストが倍になります。一般的なパターンは、重要なサービスを実行するのに十分な規模の小さなセカンダリ デプロイだけを持つ方法です。容量を確保し、セカンダリ環境の構成をテストするために、少なくとも小規模のセカンダリ デプロイを作成することをお勧めします。

>[AZURE.NOTE]サブスクリプションのクォータは、容量が保証されているわけではありません。クォータは単なる与信限度額です。容量を保証するには、ロールの必要数がサービス モデルで定義され、ロールがデプロイされる必要があります。

###負荷分散
リージョン間でトラフィックの負荷分散を行うためには、トラフィック管理ソリューションを使用する必要があります。Azure では [Azure Traffic Manager](https://azure.microsoft.com/services/traffic-manager/) を用意しています。また、同様のトラフィック管理機能を提供しているサードパーティのサービスを活用することもできます。

###方法
リージョン間での分散コンピューティングを実装するには、多くの代替方法を利用できます。これらは、特定のビジネス要件とアプリケーション環境に合わせる必要があります。大まかに言えば、方法は次の 3 つのカテゴリに分類できます。

  * __災害発生時の再デプロイ__: この方法では、アプリケーションは災害時に一から再デプロイされます。これは、復旧時間が保証されている必要のない、重要性の低いアプリケーションに適しています。

  * __ウォーム スペア (アクティブ/パッシブ)__: セカンダリ ホステッド サービスは別のリージョンで作成され、ロールは最小容量を保証するようにデプロイされます。ただし、このロールは実稼働トラフィックを受信しません。この方法は、リージョン間にトラフィックを分散するように設計されていないアプリケーションに有用です。

  * __ホット スペア (アクティブ/アクティブ)__: アプリケーションは複数のリージョンで実稼働負荷を受信するように設計されています。各リージョンのクラウド サービスは DR のために必要な容量よりも大きく構成されている場合があります。また、クラウド サービスは災害およびフェールオーバー時に必要に応じてスケールアウトする可能性があります。この方法は、アプリケーション設計にかなりの投資を必要としますが、復旧時間が短いことが保証されていること、すべての復旧場所で連続してテストが実行できること、および、容量を有効に使用できることなど、大きな利点があります。

分散設計の詳細については、このドキュメントでは説明しません。詳細については、「[Azure アプリケーションの障害復旧と高可用性](https://aka.ms/drtechguide)」を参照してください。

##Virtual Machines
サービスとしてのインフラストラクチャ (IaaS) 仮想マシン (VM) の復旧は、多くの点でサービスとしてのプラットフォーム (PaaS) コンピューティングの復旧と似ています。ただし、IaaS VM は VM および VM ディスクの両方から構成されているという事実が重要な違いです。

  * __Azure Backup を使用してリージョン バックアップ間で一貫性のあるアプリケーションを作成する__: [Azure Backup](https://azure.microsoft.com/services/backup/) を使用すると、お客様は複数の VM ディスクに一貫性のあるアプリケーション バックアップを作成し、リージョン間でのバックアップのレプリケーションをサポートできます。そのためには、バックアップ コンテナーの作成時に、バックアップ コンテナーを geo レプリケートするように選択します。バックアップ コンテナーのレプリケーションは作成時に構成する必要があります。作成後は設定できません。リージョンが失われた場合、Microsoft はお客様が使用可能なバックアップを作成します。お客様は構成した復元ポイントのいずれかにも復元を行うことができます。

  * __OS ディスクからデータ ディスクを分離__: IaaS VM に関する重要な考慮事項は、OS ディスクを変更するには VM を作成し直さなければならないということです。これは、復旧計画が災害後に再デプロイすることになっている場合には問題ではありません。ただし、容量を確保するためにウォーム スペア アプローチを使用する場合には問題となる可能性があります。これを適切に実行するには、プライマリの場所とセカンダリの場所の両方に正しい OS ディスクをデプロイし、アプリケーション データは別のドライブに保存する必要があります。可能であれば、両方の場所に提供できる標準の OS 構成を使用します。フェールオーバー後、データ ドライブをセカンダリ DC にある既存の IaaS VM にアタッチする必要があります。AzCopy を使用して、データ ディスクのスナップショットをリモート サイトにコピーします。

  * __複数の VM ディスクの geo フェールオーバー後の潜在的な一貫性の問題__: VM ディスクは Azure Storage BLOB として実装され、同じ geo レプリケーションの特性を持ちます (以下を参照してください)。[Azure Backup](https://azure.microsoft.com/services/backup/) を使用しない場合、geo レプリケーションは非同期で個別にレプリケートするため、ディスクが原因でディスク間の一貫性については保証されません。個々の VM ディスクは geo フェールオーバー後に一貫性のある状態になることが保証されています。ただし、ディスク間の一貫性についての保証はありません。これは、場合によっては問題を引き起こす可能性があります (ディスク ストライピングの場合など)。

##Storage

###BLOB、テーブル、キュー、および VM ディスク ストレージの geo 地理冗長ストレージを使用した復旧
Azure BLOB では、テーブル、キュー、および VM ディスクはすべて、既定で geo レプリケートされます。これは geo 冗長ストレージ (GRS) と呼ばれます。GRS は、ストレージ データを特定の地理的リージョン内の数百マイル離れた場所にあるペアのデータセンターにレプリケートします。GRS を使用すると、データ センターで大きな災害が発生したときのデータの持続性が向上します。いつフェールオーバーが発生するかは Microsoft によって制御されており、元のプライマリの場所が一定の時間内に復旧不可能と見なされるような大きな災害が発生した場合にのみフェールオーバーが行われます。シナリオによっては、これには数日かかる場合があります。データは通常数分以内にレプリケートされますが、同期の間隔はまだ SLA によってカバーされていません。

geo フェールオーバーが行われた場合、アカウントへのアクセス方法に変更はありません (URL とアカウント キーは変わりません)。ただし、ストレージ アカウントはフェールオーバー後には別のリージョンに存在し、これはストレージ アカウントと同じリージョンに置かれる必要があるアプリケーションには影響を与える可能性があります。同じデータ センターでストレージ アカウントを必要としないサービスとアプリケーションについても、データセンター間の待機時間と帯域幅の料金がトラフィックをフェールオーバー リージョンに一時的に移動させなければならない理由になる可能性があります。これは障害復旧方法全体に組み入れることができます。

GRS によって提供される自動フェールオーバーに加えて、セカンダリ ストレージ場所にあるデータのコピーを読み取ることができるサービスが Azure には導入されています。これは読み取りアクセス geo 冗長ストレージ (RA-GRS) と呼ばれています。

GRS および RA-GRS ストレージの詳細については、「[Azure Storage のレプリケーション](../storage/storage-redundancy.md)」を参照してください。

###geo レプリケーションのリージョン マッピング:
ストレージと同じリージョンにある必要があるデータの他のインスタンスをデプロイする場所を知るために、データが geo レプリケーションされている場所を知ることが重要です。次の表に、プライマリの場所とセカンダリの場所のペアを示します。

[AZURE.INCLUDE [リージョン ペアの一覧](../../includes/paired-region-list.md)]

###geo レプリケーションの価格:
geo レプリケーションは Azure Storage の現在の価格に含まれます。これは geo 冗長ストレージと呼ばれます。自分のデータに geo レプリケーションを行う必要がない場合は、自分のアカウントの geo レプリケーションを無効にできます。これにはローカル冗長ストレージと呼ばれ、geo レプリケートされたストレージの割引料金で課金されます。

###geo フェールオーバーが発生したかどうかの判断
geo フェールオーバーが発生した場合、これが [Azure サービス正常性ダッシュボード](https://azure.microsoft.com/status/)に報告されます。ただし、アプリケーションは、ストレージ アカウントの geo リージョンを監視することによって自動的にこれを検出できます。これは、ストレージが移動される geo リージョンのコンピューティング リソースのアクティブ化など、他の復旧操作をトリガーするために使用できます。これは [Get Storage Account Properties](https://msdn.microsoft.com/library/ee460802.aspx) を使用してサービス管理 API からクエリを実行できます。関連するプロパティは次のとおりです。

    <GeoPrimaryRegion>primary-region</GeoPrimaryRegion>
    <StatusOfPrimary>[Available|Unavailable]</StatusOfPrimary>
    <LastGeoFailoverTime>DateTime</LastGeoFailoverTime>
    <GeoSecondaryRegion>secondary-region</GeoSecondaryRegion>
    <StatusOfSecondary>[Available|Unavailable]</StatusOfSecondary>

###VM ディスクと geo フェールオーバー
VM ディスクのセクションで説明したように、フェールオーバー後は VM ディスク間でデータに一貫性の保証はありません。バックアップの精度を確認するために、Data Protection Manager などのバックアップ製品を使用してアプリケーション データのバックアップと復元を行う必要があります。

##データベース

###SQL Database
Azure SQL Database には、geo リストアとアクティブ geo レプリケーションという 2 種類の復旧が用意されています。

####地理リストア
[geo リストア](../sql-database/sql-database-geo-restore.md)も、Basic、Standard、Premium のデータベースで利用できます。データベースがホストされているリージョンでのインシデントのためにデータベースが利用できない場合にも既定の復旧オプションを提供します。ポイントインタイム リストアと同様に、geo リストアも Azure の地理冗長ストレージでのデータベースのバックアップに依存します。geo レプリケーション バックアップ コピーからリストアするため、プライマリ リージョンにおけるストレージの障害に対する回復力があります。地理リストアの使用方法の詳細については、[障害からの回復](../sql-database/sql-database-disaster-recovery.md)をご覧ください。

####アクティブ geo レプリケーションを選択するとき
[アクティブ geo レプリケーション](../sql-database/sql-database-geo-replication-overview.md)は、すべてのデータベース レベルで使用できます。アクティブ geo レプリケーションは、geo リストアよりもアグレッシブな復旧要件があるアプリケーション用に設計されています。アクティブ geo レプリケーションを使用して、別のリージョン内のサーバーで最大 4 つの読み取り可能なセカンダリを作成できます。いずれかのセカンダリへのフェールオーバーを開始できます。さらに、アクティブ geo レプリケーションを使用すると、アプリケーションのアップグレードや再配置のシナリオをサポートするだけでなく読み取り専用ワークロードの負荷を分散することができます。[geo レプリケーションの構成](../sql-database/sql-database-geo-replication-portal.md)方法と[セカンダリ データベースにフェールオーバーする](../sql-database/sql-database-geo-replication-failover-portal.md)方法の詳細については、「[ビジネス継続性のための設計](../sql-database/sql-database-business-continuity-design.md)」をご覧ください。ダウンタイムなくアプリケーションのアップグレードを実装する方法の詳細については、「[ダウンタイムのないアプリケーションのアップグレード](../sql-database/sql-database-business-continuity-application-upgrade.md)」をご覧ください。

###Virtual Machines 上の SQL Server
SQL Server 2012 (以降) を Azure Virtual Machines で実行した場合、復旧および高可用性のためのさまざまなオプションを利用できます。詳細については、「[Azure Virtual Machines における SQL Server の高可用性と障害復旧](../virtual-machines/virtual-machines-windows-sql-high-availability-dr.md)」を参照してください。

##その他の Azure Platform サービス
複数の Azure リージョンでクラウド サービスを実行しようとする場合、依存関係ごとに影響について検討する必要があります。以下のセクションにおいて、サービスに固有のガイダンスでは代替の Azure データセンターにおいては同じ Azure サービスを使用する必要があると想定されています。これには、構成タスクとデータ レプリケーション タスクの両方があります。

>[AZURE.NOTE]場合によっては、これらの手順はデータセンター イベント全体ではなく、サービス固有の障害を軽減するために役立つ可能性があります。アプリケーションの観点からは、サービス固有の障害は単に制限的なもので、サービスを代替の Azure リージョンへ一時的に移行する必要があります。

###Service Bus
Azure Service Bus は、Azure リージョンにまたがらない一意の名前空間名を使用します。したがって、最初の要件は代替リージョンで必要なサービス バス名前空間を設定することです。ただし、キューに置かれたメッセージの持続性についても考慮事項があります。Azure リージョン間でメッセージをレプリケートするにはいくつかの方法があります。これらのレプリケーション方法とその他の障害復旧計画の詳細については、「[Service Bus の障害および災害に対するアプリケーションの保護のベスト プラクティス](../service-bus/service-bus-outages-disasters.md)」を参照してください。その他の可用性の考慮事項については、[Service Bus (可用性)](./resiliency-technical-guidance-recovery-local-failures.md#service-bus) に関するページを参照してください。

###Web Apps
Azure の Web アプリをセカンダリ Azure リージョンに移行するには、発行に使用できる Web サイトのバックアップが必要です。障害が Azure データセンター全体を含んでいなければ、FTP を使用してサイト コンテンツの最新のバックアップをダウンロードできる場合があります。次に、容量を確保するために代替リージョンにまだ新しい Web サイトを作成していない場合は、それを作成します。サイトを新しいリージョンに発行し、必要な構成の変更を行います。これらの変更には、データベース接続文字列またはその他のリージョン固有の設定が含まれる場合があります。必要に応じて、サイトの SSL 証明書を追加し、DNS の CNAME レコードを変更して、カスタム ドメイン名が再デプロイされた Azure の Web サイトの URL を参照するようにします。

###Mobile Services
セカンダリ Azure リージョンで、アプリケーションのバックアップ モバイル サービスを作成します。代替リージョンにも Azure SQL Database を復元します。次に、Azure コマンド ライン ツールを使用して、モバイル サービスを代替リージョンへ移動します。次に、復元したデータベースを使用するようにモバイル サービスを構成します。このプロセスの詳細については、「[障害発生時のモバイル サービスの復旧](../mobile-services/mobile-services-disaster-recovery.md)」を参照してください。その他の可用性の考慮事項については、[Mobile Services (可用性)](./resiliency-technical-guidance-recovery-local-failures.md#mobile-services) に関するページを参照してください。

###HDInsight
HDInsight に関連付けられているデータは、既定では Azure BLOB ストレージに保存されます。HDInsight では、MapReduce ジョブを処理する Hadoop クラスターは分析されるデータを保持したストレージ アカウントと同じリージョンに併置する必要があります。Azure Storage で利用可能な geo レプリケーション機能を使用すると、何らかの理由によりプライマリ リージョンが使用できなくなった場合、データがレプリケートされたセカンダリ リージョンのデータにアクセスできます。データがレプリケートされているリージョンに新しい Hadoop クラスターを作成し、データの処理を継続することができます。その他の可用性の考慮事項については、[HDInsight (可用性)](./resiliency-technical-guidance-recovery-local-failures.md#hdinsight) に関するページを参照してください。

###SQL レポート
現時点では、Azure リージョンの損失からの復旧には、異なる Azure リージョンにそれぞれ複数の SQL Reporting インスタンスが必要です。これらの SQL Reporting インスタンスは、同じデータにアクセスする必要があり、そのデータには災害が発生した場合の独自の復旧計画が必要です。また、各レポートに RDL ファイルの外部バックアップ コピーを保持できます。

###Media Services
Azure Media Services には、エンコードとストリーミングのために異なる復旧方法があります。通常、ストリーミングは地域的な障害が発生している場合にはより重要になります。これに備えて、2 つの異なる Azure リージョンに Media Services アカウントを用意する必要があります。エンコードされた内容は、両方のリージョンに配置される必要があります。障害時には、ストリーミング トラフィックを代替リージョンにリダイレクトできます。エンコードは任意の Azure リージョンで実行できます。ライブ イベントの処理中など、エンコードが時間の影響を受ける場合、ジョブを障害中に代替のデータセンターへ送信する準備をしておく必要があります。

###仮想ネットワーク
構成ファイルを使用すると、代替の Azure リージョンで仮想ネットワークを最も速く設定できます。プライマリ Azure リージョンで仮想ネットワークを構成した後、ネットワーク構成ファイルに現在のネットワークの[仮想ネットワーク設定をエクスポート](../virtual-network/virtual-networks-create-vnet-classic-portal.md)します。プライマリ リージョンで障害が発生した場合は、保存された構成ファイルから[仮想ネットワーク構成ファイルを復元](../virtual-network/virtual-networks-create-vnet-classic-portal.md)します。次に、その他のクラウド サービス、仮想マシン、またはクロスプレミス設定を構成して、新しい仮想ネットワークで作業します。

##障害復旧のためのチェックリスト

##Cloud Services のチェックリスト
  1. このドキュメントの「[Cloud Services](#cloud-services)」セクションを確認する
  2. 複数のリージョンにわたる障害復旧方法を作成する。
  3. 代替リージョンの容量の確保においてのトレードオフを理解する。
  4. Azure Traffic Manager などのトラフィック ルーティング ツールを使用する。

##Virtual Machines のチェックリスト
  1. このドキュメントの「[Virtual Machines](#virtual-machines)」セクションを確認する
  2. [Azure Backup](https://azure.microsoft.com/services/backup/) を使用して、リージョン間で整合性のあるアプリケーションのバックアップを作成する

##Storage のチェックリスト
  1. このドキュメントの「[Storage](#storage)」セクションを確認する
  2. ストレージ リソースの geo レプリケーションを無効にしない。
  3. フェールオーバーが発生した場合の geo レプリケーションの代替リージョンを理解する。
  4. ユーザー制御のフェールオーバー方法に有効なカスタム バックアップ方法を作成する。

##SQL Database のチェックリスト
  1. このドキュメントの「[SQL Database](#sql-database)」セクションを確認する
  2. 必要に応じて [geo リストア](../sql-database/sql-database-geo-restore.md)または [geo レプリケーション](../sql-database/sql-database-geo-replication-overview.md)を使用する。

##Virtual Machines での SQL Server のチェックリスト
  1. このドキュメントの「[Virtual Machines 上の SQL Server](#sql-server-on-virtual-machines)」セクションを確認する
  2. 複数のリージョンにわたる AlwaysOn 可用性グループまたはデータベース ミラーリングを使用する。
  3. または、バックアップを使用して、BLOB ストレージに復元する。

##Service Bus のチェックリスト
  1. このドキュメントの「[Service Bus](#service-bus)」セクションを確認する
  2. 代替リージョンで Service Bus 名前空間を構成する。
  3. リージョン間でのメッセージのカスタム レプリケーション方法を検討する。

##Web Apps のチェック リスト
  1. このドキュメントの「[Web Apps](#web-apps)」セクションを確認する
  2. プライマリ リージョンの外で Web サイトのバックアップを維持する。
  3. 障害が部分的な場合は、FTP を使用して現在のサイトの取得を試みる。
  4. 代替リージョンの新規または既存の Web サイトに Web サイトをデプロイする計画を作成する。
  5. アプリケーションおよび DNS の CNAME レコードの両方の構成変更を計画する。

##Mobile Services のチェック リスト
  1. このドキュメントの「[Mobile Services](#mobile-services)」セクションを確認する
  2. 代替リージョンのバックアップ モバイル サービスを作成する。
  3. フェールオーバー中に復元する、関連付けられた Azure SQL Database のバックアップを管理する。
  4. Azure コマンド ライン ツールを使用して、モバイル サービスに移動する。

##HDInsight のチェックリスト
  1. このドキュメントの「[HDInsight](#hdinsight)」セクションを確認する
  2. レプリケートされたデータのあるリージョンで新しい Hadoop クラスターを作成する。

##SQL Reporting のチェックリスト
  1. このドキュメントの「[SQL Reporting](#sql-reporting)」セクションを確認する
  2. SQL Reporting の代替えインスタンスを別のリージョンで保持する。
  3. そのリージョンに対象をレプリケートする別の計画を維持する。

##Media Services のチェックリスト
  1. このドキュメントの「[Media Services](#media-services)」セクションを確認する
  2. 代替リージョンで Media Services アカウントを作成する。
  3. 両方のリージョンで同じ内容をエンコードして、ストリーム フェールオーバーをサポートする。
  4. 障害の場合には、エンコード ジョブを代替リージョンに送信する。

##Virtual Network のチェックリスト
  1. このドキュメントの「[Virtual Network](#virtual-network)」セクションを確認する
  2. エクスポートされた仮想ネットワーク設定を使用して、別のリージョンでテーブルを再作成する。
 
##次のステップ
この記事は、[Azure の回復性技術ガイダンス](./resiliency-technical-guidance.md)について重点的に説明した一連の記事の一部です。このシリーズの次の記事では、[オンプレミスのデータセンターから Azure への復旧](./resiliency-technical-guidance-recovery-on-premises-azure.md)について重点的に説明します。

<!---HONumber=AcomDC_0525_2016-->