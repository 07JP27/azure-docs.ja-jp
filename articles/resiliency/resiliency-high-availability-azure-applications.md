<properties
   pageTitle="Azure アプリケーションの高可用性 | Microsoft Azure"
   description="Microsoft Azure で可用性の高いアプリケーションを設計し、構築するための方法に関する技術的概要と詳細。"
   services=""
   documentationCenter="na"
   authors="adamglick"
   manager="saladki"
   editor=""/>

<tags
   ms.service="resiliency"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="08/18/2016"
   ms.author="aglick"/>


#<a name="high-availability-for-applications-built-on-microsoft-azure"></a>Microsoft Azure 上に構築されたアプリケーションの高可用性

高可用性アプリケーションは、依存型のサービスとハードウェアの可用性の変動、負荷、一時的な障害を緩和します。 アプリケーションは、ユーザーとシステムの応答性に関して、ビジネス要件またはアプリケーションのサービス レベル アグリーメント (SLA) に定義されている許容レベルで動作を続けます。

##<a name="azure-high-availability-features"></a>Azure の高可用性機能

Azure には、可用性の高いアプリケーションをサポートするさまざまなプラットフォーム機能が組み込まれています。 このセクションでは、それらの主要機能の一部について説明します。 プラットフォームのさらに包括的な分析については、「 [Azure の回復性技術ガイダンス](./resiliency-technical-guidance.md)」を参照してください。

###<a name="fabric-controller"></a>ファブリック コントローラー

Azure ファブリック コントローラーは、Azure コンピューティング インスタンスをプロビジョニングし、その状態を監視します。 このファブリック コントローラーは、ホスト コンピューター インスタンスとゲスト コンピューター インスタンスのハードウェアとソフトウェアの状態を確認します。 エラーが検出された場合、VM インスタンスを自動的に再配置し、SLA を強制します。 障害ドメインとアップグレード ドメインのコンセプトがコンピューティング SLA をさらにサポートします。

複数のクラウド サービスのロール インスタンスがデプロイされている場合、Azure はこれらのインスタンスを異なる障害ドメインにデプロイします。 障害ドメインの境界は、基本的に、同じリージョンの異なるハードウェア ラックになります。 障害ドメインは、ローカライズされたハードウェアがアプリケーションのサービスを遮断する可能性を減らします。 worker または web ロールに割り当てられている障害ドメインの数は操作できません。 ファブリック コントローラーは、Azure でホストされるアプリケーションから分離している専用リソースを使用します。 Azure システムの中核としてサービスを提供するため、アップタイムは 100% になります。 障害ドメイン全体でロール インスタンスを監視し、管理します。

次の図は、異なる障害ドメインにまたがってファブリック コントローラーによりデプロイされ、管理される Azure 共有リソースを示したものです。

![Simplified view of fault domain isolation](./media/resiliency-high-availability-azure-applications/fault-domain-isolation.png)

アップグレード ドメインは機能面で障害ドメインに類似していますが、障害ではなく、アップグレードをサポートします。 アップグレード ドメインはインスタンス分離の論理ユニットであり、一定の時点でアップグレードされる特定のサービスのインスタンスを決定します。 既定では、ホストされるサービスのデプロイの場合、5 つのアップグレード ドメインが定義されます。 ただし、サービス定義ファイルでその値を変更できます。 たとえば、web ロールに 8 つのインスタンスがあるとします。 3 つのアップグレード ドメインに 2 つのインスタンスがあり、1 つのアップグレード ドメインに 2 つのインスタンスがあります。 Azure が更新順序を定義しますが、それはアップグレード ドメインの数に基づきます。 アップグレード ドメインの詳細については、 [クラウド サービスの更新](../cloud-services/cloud-services-update-azure-service.md)に関する記事を参照してください。

###<a name="features-in-other-services"></a>その他のサービスの機能

プラットフォーム機能でコンピューティングの高い可用性をサポートするだけでなく、Azure は高可用性機能を他のサービスに組み込みます。 たとえば、Azure Storage では、すべての BLOB、テーブル、およびキューのデータの 3 つのレプリカを保持します。 geo レプリケーションを選択し、BLOB とテーブルのバックアップをセカンダリ リージョンに保管することもできます。 Azure Content Delivery Network は世界中の BLOB をキャッシュし、冗長性と拡張性を実現します。 Azure SQL Database はまた、複数のレプリカを維持します。

[回復性技術ガイダンス](https://aka.ms/bctechguide)に関する一連の記事に加え、[Azure Cloud Services で大規模なサービスを設計するためのベスト プラクティス](https://azure.microsoft.com/blog/best-practices-for-designing-large-scale-services-on-windows-azure/)に関するブログをご覧ください。 Azure プラットフォームの可用性機能について詳しい考察があります。

Azure には高可用性をサポートする複数の機能が用意されていますが、その制約を理解することが重要です。

- コンピューティングに関しては、あなたのロールが利用できて実行されていることを Azure は保証しますが、あなたのアプリケーションが実行されているのか、過負荷になっているのかは認識しません。
- Azure SQL Database の場合、データはリージョン内で同期複製されます。 アクティブ geo レプリケーションを選択できます。アクティブ geo レプリケーションでは、同じリージョン (または異なるリージョン) にデータベース コピーを 4 つまで保持できます。 そのようなデータベース レプリカは、特定の時点のバックアップではありません。 SQL Database では、特定の時点のバックアップ機能が提供されます。 SQL Database のポイントインタイム機能に関する詳細については、「[Azure SQL Database Point in Time Restore (Azure SQL Database のポイントインタイム リストア)](https://azure.microsoft.com/blog/azure-sql-database-point-in-time-restore/)」をご覧ください。
- Azure Storage の場合、テーブルと BLOB のデータは既定で代替リージョンにレプリケートされます。 ただし、代替サイトへのフェールオーバーを Microsoft が選択するまで、レプリカにアクセスできません。 リージョン フェールオーバーは、リージョン全体のサービス中断が長引いた場合にのみ発生します。geo フェールオーバーの時間には SLA はありません。 データの破損はすぐにレプリカに広まることにもご留意ください。

これらの理由から、プラットフォームの可用性機能をアプリケーション固有の可用性機能で補う必要があります。 アプリケーション固有の可用性機能には、BLOB データのバックアップを特定の時点で作成する BLOB スナップショット機能があります。

###<a name="availability-sets-for-azure-virtual-machines"></a>Azure Virtual Machines の可用性セット

この記事の大半は、サービスとしてのプラットフォーム (PaaS) モデルを使用する、クラウド サービスに関する記述で占められています。 しかし、サービスとしてのインフラストラクチャ (IaaS) モデルを使用する、Azure Virtual Machines 固有の可用性機能もあります。 Virtual Machines で高可用性を実現するためには、可用性セットを使用する必要があります。 可用性セットは障害ドメインとアップグレード ドメインに同様に機能を提供します。 可用性セット内では、ローカライズされたハードウェアの障害や保守管理行動に起因してグループ内の全コンピューターが停止する事態が回避されるように、Azure は仮想マシンを配置します。 Virtual Machines の可用性に関する Azure SLA を達成するためには、可用性セットが必要です。

次の図は、Web 仮想マシンと SQL Server 仮想マシンをグループ化する 2 つの可用性セットを表したものです。

![Azure Virtual Machines の可用性セット](./media/resiliency-high-availability-azure-applications/availability-set-for-azure-virtual-machines.png)

>[AZURE.NOTE] 上の図では、SQL Server が仮想マシンにインストールされ、実行されています。 これは前の考察にあった、管理サービスとしてデータベースを提供する、Azure SQL Database とは異なります。

##<a name="application-strategies-for-high-availability"></a>高可用性のアプリケーション戦略

高可用性のアプリケーション戦略の大半は、アプリケーション コンポーネント間の冗長性または強固な依存性の解除に関するものです。 アプリケーションを設計するとき、Azure またはサードパーティ サービスの散発的ダウンタイム時の耐障害性を組み込む必要があります。 次のセクションでは、クラウド サービスの可用性を上げるアプリケーション パターンを紹介します。

###<a name="asynchronous-communication-and-durable-queues"></a>非同期の通信と永続的なキュー

Azure アプリケーションの可用性を高めるために、疎結合のサービス間に非同期の通信を取り入れることを検討してください。 このパターンでは、ストレージ キューと Azure Service Bus キューのいずれかにメッセージが書き込まれ、後で処理されます。 メッセージをキューに書き込むと、直後にメッセージの送信者にコントロールが返されます。 アプリケーションの別の層がメッセージを処理します。通常、worker ロールとして実行されます。 worker ロールが停止した場合、処理サービスが元の状態に戻るまで、メッセージはキューに累積されます。 キューが利用できる限り、フロントエンドの送信者とメッセージの処理者の間に直接的な依存関係はありません。 そのため、分散アプリケーションのスループット問題を引き起こす可能性がある、サービスの同期的呼び出しが必要なくなります。

このバリエーションとしては、故障したデータベースの呼び出しに対するフェールオーバーの場所として Azure Storage (BLOB、テーブル、キュー) または Service Bus のキューを利用する方法があります。 たとえば、あるアプリケーション内で別のサービス (Azure SQL Database など) を同期的に呼び出す行為は繰り返し失敗します。 場合によっては、そのデータをシリアル化し、永続的なストレージに保存できます。 後に、サービスまたはデータベースがオンラインに戻ったときに、アプリケーションはストレージから要求を再送信できます。 このモデルの違いは、仲介となる場所がアプリケーション ワークフローで常に同じではないということです。 障害シナリオでのみ使用されます。

いずれのシナリオでも、非同期通信と中間ストレージの利用により、バックエンド サービスが停止しても、アプリケーション全体が停止する事態が回避されます。 キューは論理的な仲介者として機能します。 正しいキュー サービスの選択方法については、「 [Azure キューと Service Bus キューの比較](../service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted.md)」を参照してください。

###<a name="fault-detection-and-retry-logic"></a>障害検出と再試行ロジック

高可用性アプリケーションの設計で重要なことは、コード内で再試行ロジックを使用し、一時的に停止しているサービスをグレースフルに (劣化を最小限に抑えるように) 処理することです。 開発者向けの参考書として、Microsoft Patterns &amp; Practices チームが作成した「 [The Transient Fault Handling Application Block (一時的なエラー処理アプリケーション ブロック)](https://msdn.microsoft.com/library/hh680934.aspx)」があります。 "一時的な" という言葉は、比較的短い時間だけ継続する一時的な状態を意味します。 この記事の文脈としては、一時的な障害の処理は高可用性アプリケーションの開発に含まれます。 一時的な状態には、たとえば、ネットワークが断続的な停止するエラーやデータベースの接続が失われる現象があります。

Transient Fault Handling Application Block を参考にすれば、簡単な方法で、グレースフルな障害処理をコードに記述できます。 一時的な障害の堅牢な処理を追加することで、アプリケーションの可用性が上がります。 ほとんどの場合、再試行ロジックは短い中断を処理し、数回失敗した後に、送信者と受信者を再接続します。 再試行が成功しても、通常、アプリケーション ユーザーに通知されません。

開発者には、再試行ロジックの管理について 3 つの選択肢があります。増分、固定間隔、指数関数です。 増分の場合、再試行のたびに待ち時間が長くなります。たとえば、1 秒、2 秒、3 秒、4 秒のように増えます。 固定間隔の場合、再試行の間の待ち時間は同じです。たとえば、2 秒待ってから再試行します。 よりランダムな選択肢が指数関数です。指数関数的な後退により、再試行の間の待ち時間が長くなります。 ただし、指数的に増加します (たとえば、2 秒、4 秒、8 秒、16 秒のように増えます)。

高いレベルのコード記述方針は次のようになります。

1. 再試行の方針とポリシーを定義する。
1. 一時的に障害を引き起こす可能性のある操作を試す。
1. 一時的な障害が発生した場合、再試行ポリシーを呼び出す。
1. すべての再試行が失敗した場合、最後の例外をキャッチする。

障害をシミュレーションして再試行ロジックを試し、連続して試しても予想外の長い遅延が発生しないことを確認します。 この作業を行ってから、全体的作業の失敗を判断してください。

###<a name="reference-data-pattern-for-high-availability"></a>高可用性の参照データ パターン

参照データは、アプリケーションの読み取り専用データです。 このデータはビジネス コンテキストを与えます。そのビジネス コンテキストの中で、アプリケーションは業務を通してトランザクション データを生成します。 トランザクション データは、参照データを特定の時点でとらえたものです。 そのため、その整合性は、トランザクションの時点での参照データのスナップショットに依存します。 これは大まかな定義ですが、ここでの目的には足りるでしょう。

アプリケーションが機能するには、アプリケーション コンテキストの参照データが必要です。 個々のアプリケーションが参照データを作成し、維持します。通常、マスター データ管理 (MDM) システムがこの機能を実行します。 そのようなシステムは、参照データのライフサイクルを担当します。 参照データには、たとえば、製品カタログ、社員マスター、部品マスター、設備マスターがあります。 参照データは組織の外部から発生することもあります。郵便番号や税率などです。 参照データの可用性を高めるための戦略は、一般的に、トランザクション データの場合よりも簡単です。 参照データには、ほとんど変化しないという利点があります。

アプリケーションと共に参照データをデプロイすることで、実行時に自立的に参照データを利用する Azure Web ロールまたは worker ロールを作成できます。 ローカル ストレージが十分に大きく、このようなデプロイが可能であれば、それは理想的な状態です。 Azure コンピューティングのスケール ユニットの自立性には、ローカル ファイル システムにデプロイされている組み込みデータベース (SQL、NoSQL) または XML ファイルが役に立ちます。 ただし、再デプロイしなくても各ロールのデータを更新するメカニズムを用意する必要があります。 具体的には、参照データが更新されたら、それをクラウド ストレージ エンドポイント (Azure BLOB ストレージや SQL Database など) に送信します。 ロールの起動時にコンピューティング ノードにデータ更新をダウンロードするコードを各ロールに追加します。 あるいは、ロール インスタンスへの強制ダウンロードを管理者に許可するコードを追加します。

ストレージが停止したときに可用性を上げるために、一連の参照データをロールに追加する必要もあります。 それにより、更新のストレージ リソースが利用できるようになるまで、一連の基本参照データでロールを起動できます。

![自立的コンピューティング ノードによるアプリケーションの高可用性](./media/resiliency-high-availability-azure-applications/application-high-availability-through-autonomous-compute-nodes.png)

このパターンで考慮するべきことは、ロールのデプロイと起動の速度です。 起動時に大量の参照データをデプロイまたはダウンロードする場合、新しいデプロイまたはロールのインスタンスの起動にかかる時間が増える可能性があります。 時間が増えたとしても、外部のストレージ サービスに頼ることなく、各ロールで参照データをすぐに利用できるという自立性が与えられるなら許容範囲内となることもあります。

###<a name="transactional-data-pattern-for-high-availability"></a>高可用性のトランザクション データ パターン

トランザクション データは、ビジネス コンテキストにおいてアプリケーションによって生成されるデータです。 トランザクション データは、アプリケーションに実装する一連のビジネス プロセスとそのようなプロセスをサポートする参照データを組み合わせたものです。 トランザクション データには、たとえば、注文、事前出荷明細、請求書、顧客関係管理 (CRM) 案件などがあります。 生成されたトランザクション データは記録を保存する外部システムに送信され、さらに処理されます。

参照データはそのデータを担当するシステム内で変動する場合があることにご留意ください。 そのような理由から、外部依存性を最小限に抑え、その意味論的な一貫性を維持するために、参照データの特定の時点のコンテキストをトランザクション データで保存する必要があります。 たとえば、注文の完了から数か月後に製品をカタログから削除するとします。 その場合、ベスト プラクティスは、可能な限りたくさんの参照データ コンテキストをトランザクションに組み込むことです。 トランザクションの記録後に参照データが変更された場合でも、トランザクションに関連付けられている意味が失われません。

前述のように、疎結合と非同期通信を使用するアーキテクチャは高いレベルの可用性に貢献します。 それはトランザクション データにも当てはまります。ただし、実装は一層複雑になります。 トランザクションの従来の概念は、一般的に、トランザクションを請け合うデータベースに依存します。 中間層を導入するとき、アプリケーション コードでさまざまな層のデータを正しく処理し、十分な一貫性と耐久性を維持する必要があります。

次のシーケンスは、トランザクション データの記録とその処理を分離するワークフローを表しています。

1. Web コンピューティング ノード: 参照データを提示します。
1. 外部ストレージ: 中間トランザクション データを保存します。
1. Web コンピューティング ノード: エンド ユーザー トランザクションを完了します。
1. Web コンピューティング ノード: 完了したトランザクション データを参照データ コンテキストと共に、応答が予測可能である仮の永続的なストレージに送信します。
1. Web コンピューティング ノード: トランザクションの完了をエンド ユーザーに知らせます。
1. バックグラウンド コンピューティング ノード: トランザクション データを抽出し、必要に応じて後処理し、現在のシステムの最終保存場所に送信します。

次の図は、Azure でホストされるクラウド サービスでこの設計を実装した 1 つの例です。

![疎結合による高可用性](./media/resiliency-disaster-recovery-high-availability-azure-applications/application-high-availability-through-loose-coupling.png)

上の図の破線矢印は非同期処理を示しています。 フロントエンドの web ロールはこの非同期処理を認識しません。 結果的に、現在のシステムを参照し、最終的な目的地にトランザクションを保存します。 この非同期モデルにより導入される待ち時間に起因し、トランザクション データにすぐに照会することはできません。 そのため、単位ごとのトランザクション データをキャッシュまたはユーザー セッションに保存し、目下の UI ニーズを満たす必要があります。

web ロールはインフラストラクチャの残りの部分から自立します。 その可用性は Web ロールと Azure キューの組み合わせであり、インフラストラクチャ全体ではありません。 高い可用性に加え、この手法では、バックエンド ストレージに関係なく、Web ロールを水平方向に拡張できます。 この高可用性モデルは運用の経済性に影響を与える場合があります。 Azure キューや worker ロールなど、その他のコンポーネントは毎月の利用コストに影響を与える場合があります。

前の図はトランザクション データにこの疎結合手法を実装する一例に過ぎないことにご留意ください。 他にもさまざまな方法で実装できます。 次は代替手法の一覧です。

 * worker ロールは、Web ロールとストレージ キューの間に置かれることがあります。
 * Service Bus キューを Azure Storage キューの代わりに使用できます。
 * 最終的な宛先は Azure Storage か別のデータベース プロバイダーになります。
 * Azure キャッシュを Web 層で利用し、トランザクションの直後にキャッシュ要件を与えることができます。

###<a name="scalability-patterns"></a>拡張性パターン

クラウド サービスの拡張性が可用性に直接影響を与えることにご留意ください。 負荷の増加が原因でサービスが応答を停止した場合、アプリケーションが停止したという印象をユーザーに与えます。 アプリケーションに予想される負荷と将来の予想値に基づき、拡張性のベスト プラクティスを実行します。 規模が最大になると、さまざまな事項を考慮する必要があります。ストレージ アカウントの使い方 (1 つまたは複数)、複数のデータベースによる共有、キャッシュ方針などです。 これらのパターンに関する詳細については、[Azure Cloud Services で大規模なサービスを設計するためのベスト プラクティス](https://azure.microsoft.com/blog/best-practices-for-designing-large-scale-services-on-windows-azure/)に関するブログをご覧ください。

##<a name="next-steps"></a>次のステップ

この記事は、 [Microsoft Azure 上に構築されたアプリケーションの障害復旧と高可用性](./resiliency-disaster-recovery-high-availability-azure-applications.md)に関する一連の記事に属しています。 このシリーズの次の記事は、「 [Microsoft Azure 上で構築されたアプリケーションの障害復旧](./resiliency-disaster-recovery-azure-applications.md)」です。



<!--HONumber=Oct16_HO2-->


