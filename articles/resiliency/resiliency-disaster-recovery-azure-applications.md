<properties
   pageTitle="Azure アプリケーションの障害復旧 | Microsoft Azure"
   description="Microsoft Azure での障害復旧に対応したアプリケーションを設計するための方法に関する技術的概要と詳細。"
   services=""
   documentationCenter="na"
   authors="adamglick"
   manager="saladki"
   editor=""/>

<tags
   ms.service="resiliency"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="08/18/2016"
   ms.author="aglick"/>

#Microsoft Azure 上に構築されたアプリケーションの障害復旧

高可用性が一時的な障害の管理に関する機能であるのに対し、障害復旧 (DR) はアプリケーションの機能の致命的な損失に関する機能です。たとえば、リージョンがダウンしたとします。そのような場合に備えて、Azure リージョンの外部でアプリケーションを実行したりデータにアクセスしたりするための計画を用意しておく必要があります。この計画の実行には、システムを機能できるようにするユーザー、プロセス、およびサポート アプリケーションが含まれます。また、システムの障害運用モードを定義するビジネスおよびテクノロジの所有者は、障害中のサービスの機能レベルを決定します。機能レベルには、完全に使用不可能、部分的に使用可能 (機能低下または処理の遅延)、完全に使用可能など、いくつかの形態があります。

##Azure の障害復旧機能

可用性を考慮して、Azure には障害復旧をサポートするために設計された[回復性技術ガイダンス](./resiliency-technical-guidance.md)があります。Azure の可用性機能の中には、障害復旧と関係するものもあります。たとえば、複数の障害ドメインを対象にロールを管理すると、アプリケーションの可用性が向上します。そのような管理を行わないと、ハンドルされないハードウェア障害が "障害" シナリオになります。そのため、可用性機能および可用性戦略を正しく適用することは、アプリケーションの障害対策の重要な側面です。ただし、この記事では、一般的な可用性の問題に留まらず、さらに重大な (かつまれな) 障害イベントについて考えます。

##複数のデータセンター リージョン

Azure のデータセンターは、世界中のさまざまなリージョンにあります。このインフラストラクチャにより、システムによって行われる Azure Storage のセカンダリ リージョンへの geo レプリケーションなど、複数の障害復旧シナリオがサポートされます。また、世界中の複数の場所にクラウド サービスを簡単かつ安価にデプロイすることもできます。複数の地域で独自にデータセンターを運用するコストと難しさと比べてみてください。複数のリージョンにデータとサービスをデプロイすると、1 つのリージョンでの大規模な停止からアプリケーションを保護するのに役立ちます。

##Azure の Traffic Manager

リージョンに固有の障害が発生した場合は、別のリージョンのサービスまたはデプロイにトラフィックをリダイレクトする必要があります。このルーティングは手動で行うこともできますが、自動プロセスを使用する方が効率的です。Azure Traffic Manager はこのタスクのためのものです。Azure Traffic Manager を使用すると、プライマリ リージョンで障害が発生したときの別のリージョンへのユーザー トラフィックのフェールオーバーを自動的に管理できます。トラフィック管理は全体的な戦略の重要な部分であるため、Traffic Manager の基本を理解することが重要です。

次の図では、ユーザーは Traffic Manager に指定されている URL (__http://myATMURL.trafficmanager.net____) に接続します。その URL により、実際のサイトの URL (http://app1URL.cloudapp.net__ と \_http://app2URL.cloudapp.net__) が抽象化されています。ユーザーをルーティングするときの条件の構成方法に基づき、ユーザーはポリシーの指示に従って実際の正しいサイトに送信されます。ポリシーのオプションは、ラウンドロビン、パフォーマンス、またはフェールオーバーです。この記事では、フェールオーバー オプションのみを考慮します。

![Routing via Azure Traffic Manager](./media/resiliency-disaster-recovery-azure-applications/routing-using-azure-traffic-manager.png)

Traffic Manager を構成する際に、新しい Traffic Manager の DNS プレフィックスを指定します。これは、サービスにアクセスできるようにユーザーに提供する URL プレフィックスです。これにより、Traffic Manager はリージョン レベルではなく 1 レベル上で負荷分散を抽象化します。Traffic Manager の DNS は、管理するすべてのデプロイの CNAME レコードに対応します。

Traffic Manager 内では、障害発生時にユーザーがルーティングされるデプロイの優先順位を指定します。Traffic Manager は、デプロイのエンドポイントを監視し、主要なデプロイでの障害発生に注意します。障害が発生すると、Traffic Manager はデプロイの優先順位のリストを分析して、リストで次にあるデプロイにユーザーをルーティングします。

フェールオーバー先は Traffic Manager が決定しますが、ユーザーはフェールオーバー モードではないときにフェールオーバー ドメインを休止状態にするかアクティブにするかを決定できます。この機能は、Azure Traffic Manager とは無関係です。Traffic Manager はプライマリ サイトでの障害を検出し、フェールオーバー サイトへのロールオーバーを実行します。Traffic Manager は、そのサイトが現在ユーザーにサービスを提供しているかどうかに関係なくロールオーバーします。

Azure Traffic Manager の機能の詳細については、次を参照してください。

 * [Traffic Manager の概要](../traffic-manager/traffic-manager-overview.md)
 * [フェールオーバーのルーティング方法の構成](../traffic-manager/traffic-manager-configure-failover-routing-method.md)

##Azure の障害シナリオ

以下のセクションでは、障害シナリオのさまざまな種類について説明します。リージョン全体にわたるサービスの中断が、アプリケーション全体の障害の唯一の原因ではありません。不適切な設計や管理エラーも停止の原因になる可能性があります。復旧計画の設計フェーズとテスト フェーズの両方で、障害が発生する可能性のある原因を検討することが重要です。適切な計画を作成するには、Azure の機能を利用したうえで、アプリケーション固有の戦略に合わせて補強します。どのような対応を選択するかは、アプリケーションの重要性、目標復旧時点 (RPO)、目標復旧時間 (RTO) によって決まります。

###アプリケーションの障害

Azure Traffic Manager は、ホスト仮想マシンの基になるハードウェアまたはオペレーティング システム ソフトウェアに起因する障害を自動的に処理します。Azure は、機能しているサーバーでロールの新しいインスタンスを作成し、ロード バランサーのローテーションに追加します。ロール インスタンスの数が 1 より大きい場合、Azure は、障害が発生したノードを交換している間、実行している他のロール インスタンスに処理を移動します。

ハードウェアやオペレーティング システムの障害とは関係なく発生する重大なアプリケーション エラーがあります。不適切なロジックやデータ整合性の問題が原因の致命的な例外により、アプリケーションで障害が発生する可能性があります。十分なテレメトリをコードに組み込み、監視システムが障害状態を検出して、アプリケーション管理者に通知できるようにする必要があります。障害復旧プロセスに関して豊富な知識を持つ管理者は、フェールオーバー プロセスを呼び出すかどうかを判断できます。または、管理者は可用性の停止を単に受け入れて、重大なエラーを解決することもできます。

###データの破損

Azure は自動的に、Azure SQL Database と Azure Storage のデータを、同じリージョン内の異なる障害ドメインに 3 回冗長的に格納します。geo レプリケーションを使用している場合は、さらに 3 回、異なるリージョンに格納します。ただし、ユーザーまたはアプリケーションがプライマリ コピーでデータを破損した場合は、たちまち他のコピーにレプリケートされます。残念ながら、結果として破損したデータのコピーが 3 つ作成されます。

データが破損する可能性を管理するには、2 つのオプションがあります。第 1 の方法は、カスタム バックアップの管理です。ビジネス要件やガバナンス規定に応じて、Azure またはオンプレミスにバックアップを格納できます。第 2 の方法は、SQL Database を復旧するための新しいポイントインタイム リストア オプションの使用です。詳細については、「[障害復旧のためのデータ戦略](#data-strategies-for-disaster-recovery)」を参照してください。

###ネットワークの停止

Azure ネットワークの一部にアクセスできないと、アプリケーションやデータを利用できなくなる可能性があります。ネットワークの問題のために利用できないロール インスタンスがある場合、Azure はアプリケーションの残りの使用可能なインスタンスを利用します。Azure ネットワークの停止のためにアプリケーションがデータにアクセスできない場合でも、キャッシュされているデータを使用することによって機能低下モードでローカルに実行できる可能性があります。機能低下モードのアプリケーションでも実行できるように、障害復旧戦略を設計する必要があります。ただし、アプリケーションによっては現実的ではないことがあります。

もう 1 つのオプションは、接続が回復するまで別の場所にデータを格納することです。機能低下モードを使用できない場合に残されているオプションは、アプリケーションのダウンタイムまたは代替リージョンへのフェールオーバーです。機能低下モードで実行するアプリケーションの設計は、技術的な決定であると同時にビジネス上の決定でもあります。これについては、「[アプリケーションの機能低下](#degraded-application-functionality)」でさらに詳しく説明します。

###依存サービスの障害

Azure では、定期的にダウンタイムが発生する可能性のある多くのサービスが提供されています。たとえば、[Azure Redis Cache](https://azure.microsoft.com/services/cache/) などです。このマルチ テナント サービスは、アプリケーションにキャッシュ機能を提供します。依存サービスが利用できない場合にアプリケーションがどのようになるかを考慮することが重要です。多くの点で、このシナリオはネットワーク停止シナリオに似ています。ただし、各サービスを個別に考慮することで、計画全体が向上する可能性があります。

Azure Redis Cache は、クラウド サービスのデプロイ内からアプリケーションにキャッシュを提供し、障害復旧のメリットがあります。何よりもまず、サービスはデプロイにローカルなロールで実行しています。そのため、クラウド サービスの全体的な管理プロセスの一部として、キャッシュの状態を監視および管理できるようになります。この種のキャッシュでは、新しい機能も公開されます。新機能の 1 つは、キャッシュされたデータの高可用性です。これは、重複したコピーを他のノードで保持することにより、単一のノードで障害が発生した場合に、キャッシュされたデータを維持するのに役立ちます。

高可用性を使用すると、書き込み時にセカンダリ コピーを更新するため、スループットが低下し、待機時間が長くなることに注意してください。また、アイテムごとに使用されるメモリ量が倍になるので、その点も考慮する必要があります。この例では、各依存サービスが、全体的な可用性と致命的な障害に対する抵抗力を高める可能性があることを示します。

各依存サービスについて、サービス中断の影響を理解する必要があります。キャッシュの例では、キャッシュが復元されるまで、データベースのデータに直接アクセスできる場合があります。パフォーマンス的には低下しますが、データに関しては完全な機能が提供されます。

###リージョン全体にわたるサービスの停止

これまでの障害は主として、同じ Azure リージョン内で管理できる障害でした。ただし、リージョン全体のサービスが中断する可能性に対しても準備する必要があります。リージョン全体のサービス中断が発生した場合、データのローカルな冗長コピーは使用できません。geo レプリケーションを有効にしてある場合は、BLOB とテーブルのコピーがさらに 3 つ、別のリージョン内に存在します。Microsoft によってリージョンの喪失が宣言された場合、Azure は geo レプリケートされたリージョンにすべての DNS エントリを再マッピングします。

>[AZURE.NOTE] ユーザーはこのプロセスを制御できないこと、およびリージョン全体のサービス中断の場合にのみ行われることに注意してください。そのため、最高レベルの可用性を実現するには、アプリケーション固有の他のバックアップ戦略も利用する必要があります。詳細については、「[障害復旧のためのデータ戦略](#data-strategies-for-disaster-recovery)」を参照してください。

###Azure 全体にわたるサービスの中断

障害計画では、可能性のある障害の全範囲を考慮する必要があります。最も重大なサービス中断の 1 つは、すべての Azure リージョンに同時に関係するものです。他のサービス中断と同様に、そのような場合は一時的なダウンタイムのリスクを冒すという決断もあり得ます。複数のリージョンにまたがる広範囲のサービス中断が発生する可能性は、依存サービスや単一のリージョンが関係する部分的なサービス中断よりはるかに低いものです。

ただし、一部のミッション クリティカルなアプリケーションでは、このようなシナリオに対してもバックアップ計画が必要になる場合があります。このような場合の計画には、[代替クラウド](#alternative-cloud)や、[オンプレミスとクラウドのハイブリッド ソリューション](#hybrid-on-premises-and-cloud-solution)のサービスへのフェールオーバーが含まれます。

###アプリケーションの機能低下

適切に設計されたアプリケーションは通常、疎結合された情報交換パターンの実装を介して相互に通信するモジュールのコレクションを使用します。DR に適したアプリケーションには、モジュール レベルでのタスクの分離が必要です。これは、依存サービスの中断によってアプリケーション全体がダウンするのを防ぐためです。たとえば、会社 Y の Web コマース アプリケーションについて考えます。たとえば次のようなモジュールがアプリケーションを構成します。

 * __製品カタログ__: ユーザーが製品を参照できるようにします。
 * __ショッピング カート__: ユーザーはショッピング カートの製品を追加/削除できます。
 * __注文状態__: ユーザーの注文の出荷状態を示します。
 * __注文送信__: 支払いを含む注文を送信して、ショッピング セッションを終了します。
 * __注文処理__: 注文のデータ整合性を確認し、在庫チェックを実行します。

このアプリケーションでモジュールの依存する部分がダウンした場合、その部分が復旧するまでモジュールはどのように機能するでしょうか。 適切に設計されたシステムでは、設計時および実行時の両方でタスクの分離によって分離境界が実装されます。すべての障害は、回復可能または回復不可能として分類できます。回復不可能なエラーはモジュールをダウンさせますが、回復可能なエラーは代替手段によって緩和できます。高可用性のセクションで説明したように、障害を処理し、代替処置を実行することによって、ユーザーから一部の問題を隠蔽できます。さらに重大なサービスの中断中は、アプリケーションが完全に利用できなくなることがあります。ただし、機能低下モードでユーザーへのサービス提供を続けるという 3 番目のオプションがあります。

たとえば、注文をホストするためのデータベースで障害が発生した場合、注文処理モジュールは販売トランザクションを処理できなくなります。アーキテクチャによっては、アプリケーションの注文送信と注文処理の部分の続行が困難または不可能になることがあります。このようなシナリオに対応するようにアプリケーションが設計されていない場合、アプリケーション全体がオフラインになる可能性があります。

ただし、この同じシナリオにおいても、製品データを別の場所に保存することです。そうすれば、製品カタログ モジュールはまだ製品の表示に使用できます。機能低下モードでは、ユーザーは製品カタログ表示などのアプリケーションの一部の機能を引き続き利用できます。ただし、注文や在庫照会などのアプリケーションの他の部分は利用できません。

機能低下モードのもう 1 つのバリエーションは、機能ではなくパフォーマンスに関するものです。たとえば、製品カタログが Azure Redis Cache でキャッシュされていたシナリオを考えます。キャッシュが使用できなくなった場合、アプリケーションはサーバー ストレージに直接アクセスして製品カタログ情報を取得できます。しかし、それではキャッシュにアクセスする場合より遅くなります。このため、キャッシュ サービスが完全に回復するまで、アプリケーションのパフォーマンスは低下します。

機能低下モードで機能を続けるアプリケーションの範囲の決定は、ビジネスと技術の両方にかかわる決定です。一時的な問題をユーザーに通知する方法も決定する必要があります。この例では、製品を表示でき、ショッピング カートに追加することさえ可能かもしれません。ただし、ユーザーが購入しようとすると、アプリケーションはユーザーに販売モジュールが一時的にアクセス不可能であることを通知します。顧客にとって最善ではありませんが、アプリケーション全体のサービス中断は避けられます。

##障害復旧のためのデータ戦略

どのような障害復旧計画でも、データの適切な処理は正しく理解するのが最も困難な部分です。データの復元も、復旧プロセスの中で一般に最も時間のかかる部分です。機能低下モードでのさまざまな選択は、障害からのデータ復旧および障害後の整合性に対する困難な課題になります。

要因の 1 つは、アプリケーションのデータのコピーを復元または保持する必要があることです。このデータは、セカンダリ サイトでの参照とトランザクションの目的に使用されます。オンプレミスの設定では、複数リージョンの障害復旧戦略を実装するためにコストと時間のかかる計画プロセスが必要です。さいわい、Azure を含むほとんどのクラウド プロバイダーでは、複数のリージョンにアプリケーションを簡単にデプロイできます。これらのリージョンは、複数リージョンのサービス中断が非常にまれになるように地理的に分散されています。異なるリージョン間でデータを処理するための戦略は、障害復旧計画を成功に導く要素の 1 つです。

以下のセクションでは、データのバックアップ、参照データ、およびトランザクション データに関連する障害復旧テクニックについて説明します。

###バックアップと復元

アプリケーション データの定期的なバックアップにより、一部の障害復旧シナリオに対応できます。ストレージ リソースが異なると、必要な手法も異なります。

Basic、Standard、および Premium の SQL Database 階層の場合、データベースの復旧にポイントインタイム リストアを利用できます。詳細については、「[概要: SQL Database を使用したクラウド ビジネス継続性とデータベース障害復旧](../sql-database/sql-database-business-continuity.md)」を参照してください。もう 1 つのオプションは、SQL Database にアクティブ geo レプリケーションを使うことです。この機能は、データベースの変更を、同じ Azure リージョンまたは別の Azure リージョンのセカンダリ データベースに、自動的にレプリケートします。これは、この記事で説明されている、より手動的なデータ同期技法の一部に対する代替手段になる可能性があります。詳細については、「[概要: Azure SQL Database のアクティブ geo レプリケーション](../sql-database/sql-database-geo-replication-overview.md)」を参照してください。

もっと手動的なバックアップおよび復元の方法を使用することもできます。データベースのコピーを作成するには、DATABASE COPY コマンドを使用します。トランザクション的に整合性のあるバックアップを取得するには、このコマンドを使用する必要があります。また、Azure SQL Database の Import/Export サービスを利用することもできます。このサービスは、Azure Blob Storage に格納されている BACPAC ファイルへのデータベースのエクスポートをサポートします。

Azure Storage に組み込まれている冗長性により、バックアップ ファイルの 2 個のレプリカが同じリージョンに作成されます。ただし、バックアップ プロセスを実行する頻度により、障害シナリオで失われる可能性があるデータ量を表す RPO が決まります。たとえば、毎正時にバックアップを実行していて、正時の 2 分前に障害が発生したとすると、最後のバックアップが実行されてからの 58 分間に作成されたデータは失われます。また、リージョン全体のサービス中断を防ぐには、BACPAC ファイルを代替リージョンにコピーする必要があります。その場合、代替リージョンのバックアップを復元することができます。詳細については、「[概要: SQL Database を使用したクラウド ビジネス継続性とデータベース障害復旧](../sql-database/sql-database-business-continuity.md)」を参照してください。

Azure Storage の場合、独自のカスタム バックアップ プロセスを開発したり、多くのサード パーティ製バックアップ ツールのいずれかを使用したりすることができます。ストレージ リソース間に相互参照があるほとんどのアプリケーション設計では、複雑さが増すことに注意してください。たとえば、Azure Storage の BLOB にリンクしている列を含む SQL データベースがあるものとします。バックアップが同時に実行されない場合、データベースには、障害発生前にバックアップされなかった BLOB へのポインターが含まれる可能性があります。アプリケーションまたは障害復旧計画では、復旧後のこのような不整合を処理するプロセスを実装する必要があります。

###障害復旧のための参照データ パターン

参照データはアプリケーションの機能をサポートする読み取り専用のデータです。通常、頻繁に変更されることはありません。バックアップと復元はリージョン全体にわたるサービス中断を処理する 1 つの方法ですが、RTO は比較的長くなります。セカンダリ リージョンにアプリケーションをデプロイする場合、参照データの RTO を改善する方法がいくつかあります。

参照データは頻繁に変化しないので、参照データの永続的なコピーをセカンダリ リージョンに保持することで、RTO を改善できます。これにより、障害発生時にバックアップを復元するために必要な時間がなくなります。複数リージョンの障害復旧の要件を満たすには、アプリケーションと参照データを一緒に複数のリージョンにデプロイする必要があります。「[高可用性の参照データ パターン](./resiliency-high-availability-azure-applications.md#reference-data-pattern-for-high-availability)」で説明されているように、ロール自体、外部ストレージ、または両方の組み合わせに、参照データをデプロイできます。

コンピューティング ノード内の参照データ デプロイ モデルは、障害復旧の要件を暗黙的に満たします。SQL Database への参照データのデプロイでは、各リージョンに参照データのコピーをデプロイする必要があります。Azure Storage にも同じ方法が当てはまります。Azure Storage に格納されている参照データのコピーを、プライマリ リージョンとセカンダリ リージョンにデプロイする必要があります。

![プライマリ リージョンとセカンダリ リージョン両方への参照データの発行](./media/resiliency-disaster-recovery-azure-applications/reference-data-publication-to-both-primary-and-secondary-regions.png)

参照データを含むすべてのデータに対して、アプリケーション固有のバックアップ ルーチンを独自に実装する必要があります。リージョン間で geo レプリケートされたコピーは、リージョン全体のサービス中断においてのみ使用されます。長時間のダウンタイムを回避するには、アプリケーションのデータのミッション クリティカルな部分をセカンダリ リージョンにデプロイします。このトポロジの例については、[アクティブ/パッシブ モデル](#active-passive)に関するセクションを参照してください。

###障害復旧のためのトランザクション データ パターン

完全に機能する障害モード戦略の実装では、セカンダリ リージョンにトランザクション データを非同期にレプリケートする必要があります。レプリケーションを実行できる実際の時間枠により、アプリケーションの RPO 特性が決まります。それでも、レプリケーションの時間枠の間にプライマリ リージョンから失われたデータを回復する可能性があります。また、後でセカンダリ リージョンとマージできる場合があります。

次のアーキテクチャの例では、フェールオーバー シナリオでのトランザクション データのさまざまな処理方法についてのアイデアを示します。すべての例を網羅しているわけではないことに注意してください。たとえば、キューなどの中間ストレージの場所は、Azure SQL Database に置き換えられます。キュー自体には、Azure Storage キューまたは Azure Service Bus キューを使用できます (「[Azure キューと Service Bus キューの比較](../service-bus-messaging/service-bus-azure-and-service-bus-queues-compared-contrasted.md)」をご覧ください)。サーバー ストレージ先も変更できます (SQL Database の代わりに Azure テーブルなど)。さらに、さまざまな手順の途中に worker ロールが挿入される場合があります。重要なのは、これらのアーキテクチャを正確に模倣することではなく、トランザクション データおよび関連モジュールの復旧ではさまざまな代替方法を検討することです。

####障害復旧の準備でのトランザクション データのレプリケーション

Azure Storage キューを使用してトランザクション データを保持するアプリケーションを検討してください。これにより、worker ロールは別のアーキテクチャでサーバー データベースへのトランザクション データを処理できます。フロントエンド ロールでデータのクエリをすぐに実行する必要がある場合は、トランザクションで何らかの一時的キャッシュを使用する必要があります。データ損失の許容レベルに応じて、キュー、データベース、またはすべてのストレージ リソースをレプリケートできます。データベース レプリケーションのみでも、プライマリ リージョンがダウンした場合、プライマリ リージョンが復旧した後でキューのデータを回復できます。

次の図では、リージョン間でサーバー データベースが同期されるアーキテクチャを示します。

![Replication of transactional data in preparation for disaster recovery](./media/resiliency-disaster-recovery-azure-applications/replicate-transactional-data-in-preparation-for-disaster-recovery.png)

このアーキテクチャを実装するときの最大の課題は、リージョン間のレプリケーション戦略です。Azure SQL データ同期サービスを使用して、この種のレプリケーションを実行できます。ただし、このサービスはまだプレビュー段階であり、運用環境には推奨されません。詳細については、「[概要: SQL Database を使用したクラウド ビジネス継続性とデータベース障害復旧](../sql-database/sql-database-business-continuity.md)」を参照してください。運用アプリケーションの場合は、サードパーティ製のソリューションを利用するか、独自のレプリケーション ロジックのコードを作成する必要があります。アーキテクチャによっては、レプリケーションが双方向になる可能性があり、複雑さが増します。

可能性のある実装の 1 つは、前の例で中間キューを使用するものです。最終的なストレージ先へのデータを処理する worker ロールは、プライマリ リージョンとセカンダリ リージョンの両方で変更を行うことができます。これらは簡単なタスクではなく、レプリケーション コードの詳細なガイダンスはこの記事の範囲を超えています。重要なのは、セカンダリ リージョンへのデータのレプリケート方法に多くの時間を費やし、十分にテストすることです。さらに、可能性のあるデータの不整合や重複トランザクションがフェールオーバーおよび回復のプロセスで正しく処理されることを確認するために、追加の作業とテストを実行することもできます。

>[AZURE.NOTE] このドキュメントの大部分では、サービスとしてのプラットフォーム (PaaS) について説明します。ただし、ハイブリッド アプリケーションのための追加のレプリケーション オプションおよび可用性オプションでは、Azure Virtual Machines を使用します。これらのハイブリッド アプリケーションは、サービスとしてのインフラストラクチャ (IaaS) を使用して、Azure の仮想マシンで SQL Server をホストします。これにより、AlwaysOn 可用性グループやログ配布などの SQL Server の従来の可用性アプローチを使用できます。AlwaysOn などの一部のテクニックは、オンプレミスの SQL Server インスタンスと Azure Virtual Machines の間でのみ機能します。詳細については、「[Azure 仮想マシンにおける SQL Server の高可用性と障害復旧](../virtual-machines/virtual-machines-windows-sql-high-availability-dr.md)」を参照してください。

####トランザクション キャプチャの機能低下アプリケーション モード

機能低下モードで動作する第 2 のアーキテクチャを検討してください。セカンダリ リージョンのアプリケーションは、レポート、ビジネス インテリジェンス (BI)、キューのドレインなどのすべての機能を無効にします。ビジネス要件によって定義されている、最も重要な種類のトランザクション ワークフローのみを受け付けます。システムはトランザクションをキャプチャし、キューに書き込みます。システムは、サービス中断の初期段階でデータの処理を遅延できます。プライマリ リージョンのシステムが予想される時間枠内に再アクティブ化した場合、プライマリ リージョンの worker ロールはキューをドレインできます。このプロセスにより、データベースをマージする必要がなくなります。プライマリ リージョンのサービス中断が許容時間枠を超えた場合、アプリケーションはキューの処理を開始できます。

このシナリオでは、セカンダリのデータベースには、プライマリが再アクティブ化したらマージする必要がある増分トランザクション データが含まれます。次の図では、プライマリ リージョンが復元されるまで一時的にトランザクション データを格納するためのこの方法を示します。

![トランザクション キャプチャの機能低下アプリケーション モード](./media/resiliency-disaster-recovery-azure-applications/degraded-application-mode-for-transaction-capture.png)

回復力のある Azure アプリケーションのデータ管理手法の詳細については、「[Failsafe: Guidance for Resilient Cloud Architectures (フェールセーフ: 回復力のあるクラウド アーキテクチャに関するガイダンス)](https://channel9.msdn.com/Series/FailSafe)」を参照してください。

##障害復旧のデプロイ トポロジ

リージョン全体のサービス中断の可能性に備えてミッション クリティカルなアプリケーションを準備する必要があります。そのためには、複数リージョン デプロイ戦略を運用計画に組み込みます。

複数リージョン デプロイには、障害発生後にセカンダリ リージョンにアプリケーションと参照データを発行する IT 担当者のプロセスが含まれる場合があります。すばやいフェールオーバーを必要とするアプリケーションの場合、デプロイ プロセスにアクティブ/パッシブ セットアップまたはアクティブ/アクティブ セットアップを含めることができます。この種のデプロイには、代替リージョンで実行しているアプリケーションの既存のインスタンスがあります。Azure Traffic Manager などのルーティング ツールは、DNS レベルで負荷分散サービスを提供します。サービスの中断を検出し、必要に応じてユーザーを異なるリージョンにルーティングできます。

成功する Azure 障害復旧プロセスでは、最初からソリューションにそのような復旧が作り込まれています。クラウドには、従来のホスティング プロバイダーでは使用できない、障害から復旧するための追加オプションがあります。具体的には、リソースを別のリージョンに動的かつ迅速に割り当てることができます。したがって、障害の発生に備えて多くの無駄なリソースを用意する必要はありません。

以下のセクションでは、障害復旧のためのさまざまなデプロイ トポロジについて説明します。通常、可用性の向上には、コストや複雑さの増加というトレードオフがあります。

###単一リージョンのデプロイ

単一リージョンのデプロイは、実際には障害復旧トポロジではありませんが、他のアーキテクチャと比較するために示してあります。単一リージョン デプロイは、Azure でのアプリケーションに共通するトポロジです。ただし、この種のデプロイは障害復旧計画の有力な対立候補ではありません。

次の図は、単一の Azure リージョンで実行するアプリケーションを示しています。Azure Traffic Manager と、障害ドメインおよびアップグレード ドメインの使用により、リージョン内のアプリケーションの可用性が向上します。

![単一リージョンのデプロイ](./media/resiliency-disaster-recovery-azure-applications/single-region-deployment.png)

ここでは、データベースが単一障害点であることが明らかです。Azure は異なる障害ドメインのデータを内部レプリカにレプリケートしますが、これらすべては同じリージョン内で行われます。アプリケーションは壊滅的な障害に対処することはできません。リージョンで障害が発生するとすべての障害ドメインがダウンします。これにはすべてのサービス インスタンスとストレージ リソースが含まれます。

最も重要性の低いアプリケーションを除き、複数のリージョンにアプリケーションをデプロイする計画を検討する必要があります。また、使用するデプロイ トポロジを検討するときは、RTO とコストの制約も考慮する必要があります。

それでは、異なるリージョン間のフェールオーバーをサポートする具体的なパターンを見ていきましょう。以下の例では、2 つのリージョンを使用してプロセスを説明します。

###セカンダリ Azure リージョンへの再デプロイ

セカンダリ リージョンへの再デプロイ パターンでは、プライマリ リージョンでのみアプリケーションとデータベースが実行されます。セカンダリ リージョンは、自動フェールオーバー用に設定されていません。したがって、障害が発生したときは、ユーザーが新しいリージョンでサービスのすべての部分を起動する必要があります。これには、Azure へのクラウド サービスのアップロード、クラウド サービスのデプロイ、データの復元、およびトラフィックを再ルーティングするための DNS の変更が含まれます。

これは最もコストのかからない複数リージョン オプションですが、RTO 特性は最も劣ります。このモデルでは、サービス パッケージとデータベース バックアップは、オンプレミスに、またはセカンダリ リージョンの Azure Blob Storage インスタンスに格納されます。ただし、操作を再開する前に、新しいサービスをデプロイし、データを復元する必要があります。バックアップ ストレージからのデータ転送を完全に自動化した場合でも、新しいデータベース環境の起動には多くの時間を要します。復元プロセスで最も負荷の大きな部分は、バックアップ ディスク ストレージからセカンダリ リージョンの空のデータベースへのデータの移動です。ただし、データがレプリケートされていないので、新しいデータベースを動作状態にするには、これを行う必要があります。

最善のアプローチは、セカンダリ リージョンの Blob Storage にサービス パッケージを格納しておくことです。これにより、Azure にパッケージをアップロードする必要がなくなります。オンプレミスの開発用コンピューターからデプロイする場合は、これが行われます。PowerShell スクリプトを使用することで、Blob Storage から新しいクラウド サービスにサービス パッケージをすばやくデプロイできます。

このオプションは、高い RTO を許容できる重要ではないアプリケーションの場合にのみ実用的です。たとえば、数時間停止していてもかまわないが、24 時間以内には再稼働する必要のあるようなアプリケーションには適しています。

![Redeployment to a secondary Azure region](./media/resiliency-disaster-recovery-azure-applications/redeploy-to-a-secondary-azure-region.png)

###アクティブ/パッシブ

アクティブ/パッシブ パターンは多くの企業で好まれる選択です。このパターンでは、再デプロイ パターンより比較的少ないコスト増加で、RTO が向上します。このシナリオにも、プライマリとセカンダリの Azure リージョンがあります。すべてのトラフィックは、プライマリ リージョンのアクティブなデプロイに送られます。データベースは両方のリージョンで動作しているため、セカンダリ リージョンは障害復旧の準備ができています。さらに、両方のリージョンの間には同期メカニズムがあります。このスタンバイ アプローチには、データベースのみのアプローチと、セカンダリ リージョンへの完全なデプロイの、2 つのバリエーションがあります。

####データベースのみ

アクティブ/パッシブ パターンの第 1 のバリエーションでは、プライマリ リージョンのみにクラウド サービス アプリケーションがデプロイされます。ただし、再デプロイのパターンとは異なり、データベースの内容は両方のリージョン間で同期されています(詳細については、「[障害復旧のためのトランザクション データ パターン](#transactional-data-pattern-for-disaster-recovery)」を参照してください)。 障害が発生したときにアクティブ化する必要のあるものが少なくなります。セカンダリ リージョンでアプリケーションを起動し、接続文字列を新しいデータベースに変更して、トラフィックを再ルーティングするように DNS エントリを変更します。

再デプロイ パターンと同様に、デプロイの時間を短縮するには、セカンダリ リージョンの Azure Blob Storage にサービス パッケージを格納しておく必要があります。再デプロイ パターンとは異なり、データベースの復元操作に必要なオーバーヘッドの大半は発生しません。データベースは準備が済み、動作しています。これにより多くの時間が節約されるため、手頃なコストの DR パターンです。また、最も一般的な DR パターンでもあります。

![Active-passive, database only](./media/resiliency-disaster-recovery-azure-applications/active-passive-database-only.png)

####完全なレプリカ

アクティブ/パッシブ パターンの第 2 のバリエーションでは、プライマリ リージョンとセカンダリ リージョンの両方に完全なデプロイがあります。このデプロイには、クラウド サービスと同期化されたデータベースが含まれます。ただし、プライマリ リージョンのみが、ユーザーからのネットワーク要求をアクティブに処理しています。セカンダリ リージョンは、プライマリ リージョンでサービスの中断が発生した場合にのみアクティブになります。その場合、新しいネットワーク要求はすべて、セカンダリ リージョンにルーティングされます。Azure Traffic Manager は、このフェールオーバーを自動的に管理できます。

サービスが既にデプロイされているため、フェールオーバーはデータベースのみのバリエーションより高速に行われます。このパターンの RTO は非常に低くなります。セカンダリ フェールオーバー リージョンは、プライマリ リージョンで障害が発生した直後に動作可能な状態になる必要があります。

応答時間が短いだけでなく、このパターンには、バックアップ サービスの事前割り当てとデプロイという利点もあります。障害時に新しいインスタンスを割り当てるリージョンがないことを心配する必要はありません。セカンダリ Azure リージョンが容量に近づいている場合、これは重要なことです。任意のリージョンに複数の新しいクラウド サービスを即座にデプロイできるという保証 (サービス レベル アグリーメント) はありません。

このモデルの応答時間を最短にするには、プライマリ リージョンとセカンダリ リージョンを似たスケール (ロール インスタンスの数) にする必要があります。以上のような利点はありますが、使用していないコンピューティング インスタンスの料金を払う必要があり、コスト的に最も妥当な選択肢とは限りません。このため、セカンダリ リージョンではややスケール ダウンしたバージョンのクラウド サービスを使用するのが一般的です。その場合、必要に応じて迅速にセカンダリ デプロイをフェールオーバーおよびスケールアウトできます。プライマリ リージョンにアクセスできなくなったら、負荷に応じて追加のインスタンスがアクティブ化されるよう、フェールオーバー プロセスを自動化する必要があります。これには、[仮想マシン スケール セット](../virtual-machine-scale-sets/virtual-machine-scale-sets-overview.md)のような自動スケール メカニズムの使用が含まれる場合があります。

次の図に示すモデルでは、プライマリ リージョンとセカンダリ リージョンに、アクティブ/パッシブ パターンで完全にデプロイされたクラウド サービスが含まれます。

![Active-passive, full replica](./media/resiliency-disaster-recovery-azure-applications/active-passive-full-replica.png)

###アクティブ/アクティブ

これまで見てきたように、パターンの発展により RTO を小さくすると、コストと複雑さが増します。アクティブ/アクティブ ソリューションはコストに対するこの関係を絶つものです。

アクティブ/アクティブ パターンでは、両方のリージョンにクラウド サービスとデータベースが完全にデプロイされます。アクティブ/パッシブ モデルとは異なりは、両方のリージョンがユーザー トラフィックを受け取ります。このオプションでは、最も短い復旧時間を実現できます。サービスは既に、各リージョンでの負荷の一部を処理できるスケールが設定されています。DNS は既にセカンダリ リージョンを使用できる状態になっています。ユーザーを適切なリージョンにルーティングする方法の決定については複雑さが増します。ラウンドロビン スケジューリングを使用できる場合があります。さらに可能性が高いのは、特定のユーザーが、データのプライマリ コピーが存在する特定のリージョンを使用する方法です。

フェールオーバーの場合は、プライマリ リージョンへの DNS を無効にするだけで、すべてのトラフィックがセカンダリ リージョンにルーティングされます。

このモデルにもいくつかのバリエーションがあります。たとえば、次の図に示すモデルでは、プライマリ リージョンがデータベースのマスター コピーを所有しています。両方のリージョンのクラウド サービスが、そのプライマリ データベースに書き込みます。セカンダリ デプロイは、プライマリ データベースまたはレプリケートされたデータベースから読み取ることができます。この例のレプリケーションは 1 方向に行われます。

![Active-active](./media/resiliency-disaster-recovery-azure-applications/active-active.png)

前の図のアクティブ/アクティブ アーキテクチャには欠点があります。第 1 のリージョンにマスター コピーがあるため、第 2 のリージョンは第 1 のリージョンのデータベースにアクセスする必要があります。リージョン外からデータにアクセスすると、パフォーマンスが大幅に低下します。クロスリージョンのデータベース呼び出しでは、呼び出しのパフォーマンスが向上するように、何らかのバッチ処理方式を検討する必要があります。詳細については、「[バッチ処理を使用して SQL Database アプリケーションのパフォーマンスを強化する方法](../sql-database/sql-database-use-batching-to-improve-performance.md)」を参照してください。

代わりのアーキテクチャとしては、各リージョンが専用のデータベースに直接アクセスする方法があります。このモデルでは、各リージョンのデータベースを同期するため、何らかの種類の双方向レプリケーションが必要です。

アクティブ/アクティブ パターンでは、プライマリ リージョンのインスタンス数がアクティブ/パッシブ パターンほど多くなくて済む場合があります。アクティブ/パッシブ アーキテクチャのプライマリ リージョンに 10 個のインスタンスがある場合、アクティブ/アクティブ アーキテクチャの各リージョンでは 5 個しか必要ないかもしれません。このモデルでは、両方のリージョンが負荷を共有します。パッシブ リージョンでフェールオーバーを待機する 10 個のインスタンスを使用してウォーム スタンバイを維持する場合、アクティブ/パッシブ パターンよりコストが節約されることがあります。

プライマリ リージョンを復元するまで、セカンダリ リージョンで新しいユーザーが急激に増加する可能性があることに注意してください。プライマリ リージョンでサービスが中断したときに各サーバーに 10,000 人のユーザーがいた場合、セカンダリ リージョンは突然 20,000 人のユーザーを処理しなければならなくなります。セカンダリ リージョンの監視ルールは、セカンダリ リージョンでのインスタンスの倍増を検出する必要があります。これに関する詳細については、「[障害の検出](#failure-detection)」を参照してください。

##オンプレミスとクラウドのハイブリッド ソリューション

障害復旧のもう 1 つの戦略は、オンプレミスとクラウドで実行するハイブリッド アプリケーションを設計することです。アプリケーションによっては、プライマリ リージョンがどちらの場所にあってもかまいません。前のアーキテクチャで、プライマリ リージョンまたはセカンダリ リージョンがオンプレミスにある場合を考えてみてください。

このようなハイブリッド アーキテクチャには、いくつかの課題があります。まず、この記事のほとんどでは、PaaS アーキテクチャ パターンについて説明しています。Azure の一般的な PaaS アプリケーションは、ロール、クラウド サービス、Traffic Manager などの Azure 固有の構造に依存します。この種の PaaS アプリケーション用のオンプレミス ソリューションを作成するには、まったく異なるアーキテクチャが必要です。これは、管理やコストの点で実現できない場合があります。

一方、障害復旧用のハイブリッド ソリューションでは、クラウドに単に移動する従来のアーキテクチャに対する課題はあまりありません。これは、IaaS を使用するアーキテクチャにも当てはまります。IaaS アプリケーションは、オンプレミスに同等の機能を直接持つことができるクラウド内の仮想マシンを使用します。仮想ネットワークの使用により、クラウドのマシンをオンプレミスのネットワーク リソースと接続することもできます。これにより、PaaS のみのアプリケーションでは実現できない複数の可能性が生まれます。たとえば、SQL Server は、AlwaysOn 可用性グループやデータベース ミラーリングなどの障害復旧ソリューションを利用できます。詳細については、「[Azure 仮想マシンにおける SQL Server の高可用性と障害復旧](../virtual-machines/virtual-machines-windows-sql-high-availability-dr.md)」を参照してください。

また、IaaS ソリューションは、フェールオーバー オプションとして Azure を使用する簡単なパスをオンプレミスのアプリケーションに提供します。既存のオンプレミス リージョンに完全に機能するアプリケーションがあるかもしれません。しかし、フェールオーバーのために地理的に別のリージョンを維持するためのリソースがなかったらどうでしょう。 仮想マシンと仮想ネットワークを使用して、Azure でアプリケーションを実行できます。その場合は、クラウドにデータを同期するプロセスを定義します。Azure のデプロイはフェールオーバーに使用するセカンダリ リージョンになります。プライマリ リージョンはオンプレミスのアプリケーションのままです。IaaS のアーキテクチャと機能の詳細については、[Virtual Machines のドキュメント](https://azure.microsoft.com/documentation/services/virtual-machines/)を参照してください。

##代替クラウド

Microsoft Cloud の堅牢性であっても、組織で要求される内部のコンプライアンス規則やポリシーを満たさない場合があります。十分に準備し、障害時のバックアップ システムを実装するように設計しても、クラウド サービス プロバイダーのグローバル サービスに中断があった場合は不十分です。

可用性の要件と、可用性を高めることによるコストと複雑さの上昇を比較したくなります。リスク分析を実行し、ソリューションの RTO と RPO を定義します。アプリケーションがダウンタイムを許容できない場合、別のクラウド ソリューションの使用を検討します。インターネット全体がダウンしない限り、Azure がグローバルにアクセスできなくなっても、別のクラウド ソリューションはまだ使用できる可能性があります。

ハイブリッド シナリオと同様に、前の障害復旧アーキテクチャのフェールオーバー デプロイは、別のクラウド ソリューションにも存在できます。代替クラウドの DR サイトは、(あったとしても) 非常に小さいダウンタイムを許す RTO のソリューションに対してのみ使用する必要があります。Azure の外部の DR サイトを使用するソリューションでは、構成、開発、デプロイ、保守の作業が増えることに注意してください。クロスクラウド アーキテクチャにベスト プラクティスを実装することもさらに困難になります。クラウド プラットフォームの上位レベルの概念は似ていますが、API とアーキテクチャは異なります。

DR を異なるプラットフォームに分割する場合は、ソリューションの設計に抽象化レイヤーを組み込む必要があります。そうすれば、障害に備えて異なるクラウド プラットフォーム用に同じアプリケーションの 2 つの異なるバージョンを開発して管理する必要はなくなります。ハイブリッド シナリオと同様に、これらのケースでは、Azure Virtual Machines か Azure コンテナー サービスを使用する方が、クラウド固有の PaaS 設計を使用するより簡単な場合があります。

##Automation

ここで説明したパターンの一部では、オフライン デプロイの迅速なアクティブ化と、システムの特定の部分の復元が必要になります。Automation (スクリプト) を使用すると、必要に応じてリソースをアクティブ化し、ソリューションをすばやくデプロイできます。この記事では、DR 関連の Automation は [Azure PowerShell](https://msdn.microsoft.com/library/azure/jj156055.aspx) のことですが、[Service Management REST API](https://msdn.microsoft.com/library/azure/ee460799.aspx) を使用することもできます。

スクリプトを作成することで、Azure が透過的に処理しない DR の部分を管理できます。これにより、毎回同じ結果を得ることができ、人為的エラーの可能性が最小限になります。事前定義された DR スクリプトを用意すると、障害の間にシステムとその構成要素を再構築するのに要する時間も短縮されます。ダウンして 1 分ごとにお金が失われているのにサイトの復元方法を手動で見つけるようなことはしたくありません。

スクリプトを作成したら、最初から最後まで繰り返しテストします。基本機能を確認した後は、忘れずに[障害のシミュレーション](#disaster-simulation)でテストします。これにより、スクリプトやプロセスの不備が見つかります。

Automation に関するベスト プラクティスとしては、Azure 障害復旧のための PowerShell スクリプトまたはコマンド ライン インターフェイス (CLI) スクリプトのリポジトリを作成します。簡単に検索できるように明確にマークして分類します。スクリプトのリポジトリとバージョンを管理する担当者を 1 人指定します。パラメーターの説明とスクリプトの使用例をドキュメントにします。また、このドキュメントと Azure のデプロイの同期を保ちます。これが、リポジトリのすべての部分を 1 人で担当する目的です。

##障害の検出

可用性と障害復旧に関する問題を正しく処理するには、障害を検出して診断できる必要があります。システムまたはその一部が突然ダウンしたときに迅速に認識できるよう、サーバーとデプロイの高度な監視を行う必要があります。クラウド サービスとその依存関係の全体的な正常性を確認する監視ツールで、この作業の一部を実行できます。Microsoft のツールの 1 つは [System Center 2016](https://www.microsoft.com/ja-JP/server-cloud/products/system-center-2016/) です。サード パーティ製ツールも監視機能を提供できます。ほとんどの監視ソリューションは、主要なパフォーマンス カウンターとサービスの可用性を追跡します。

これらのツールは不可欠ですが、それでもクラウド サービスでの障害検出とレポートの計画が必要であることに変わりはありません。Azure 診断の適切な使用を計画する必要があります。カスタム パフォーマンス カウンターまたはイベント ログ エントリも、全体的な戦略に組み込むことができます。これらは障害の間により多くのデータを提供し、問題をすばやく診断して完全な機能を復元するのに役立ちます。また、監視ツールがアプリケーションの正常性の判断に使用できる追加メトリックも提供します。詳細については、「[Azure Cloud Services での Azure 診断の有効化](../cloud-services/cloud-services-dotnet-diagnostics.md)」を参照してください。総合的な "正常性モデル" を計画する方法の詳細については、「[Failsafe: Guidance for Resilient Cloud Architectures (フェールセーフ: 回復力のあるクラウド アーキテクチャに関するガイダンス)](https://channel9.msdn.com/Series/FailSafe)」を参照してください。

##障害のシミュレーション

シミュレーション テストでは、作業現場で小規模な現実的状況を作成し、チーム メンバーがどのように反応するかを観察します。また、シミュレーションでは、復旧計画で示されているソリューションの有効性もわかります。作成されたシナリオが実際のビジネスを中断することなく、それでいて実際の状況に近いものになるように、シミュレーションを実行します。

手動で可用性の問題をシミュレートできるように、アプリケーションに一種の "スイッチボード" を組み込むことを検討します。たとえば、ソフト スイッチを使用し、誤動作を発生させることにより、注文モジュールのデータベース アクセス例外をトリガーします。ネットワーク インターフェイス レベルで他のモジュールに対しても同様の簡単な方法を実施できます。

シミュレーションでは、不適切に処理されたすべての問題が明確に示されます。シミュレートされるシナリオは、完全に制御できる必要があります。つまり、復旧計画が失敗したと思われる場合でも、重大な損害を発生させずに状況を正常な状態に戻せる必要があります。また、シミュレーション訓練を実施するタイミングと方法を、上級管理者に通知することが重要です。この計画には、シミュレーション テストの実行中に動作不能になる可能性のある時間またはリソースに関する情報を含める必要があります。障害復旧計画をテストするときは、成功の測定方法を定義することも重要です。

障害復旧計画をテストするには、他にもいくつかの手法を使用できます。ただし、そのほとんどは、これらの基本的な手法を単に変更したものです。このテストの背後にある主な目的は、復旧計画の実現可能性と実行可能性を評価することです。障害復旧テストでは、細部に注目して、基本的な復旧計画の問題点を発見します。

##次のステップ

この記事は、[Microsoft Azure 上に構築されたアプリケーションの障害復旧と高可用性](./resiliency-disaster-recovery-high-availability-azure-applications.md)に関する一連の記事に属しています。このシリーズの前の記事は、「[Microsoft Azure 上に構築されたアプリケーションの高可用性](./resiliency-high-availability-azure-applications.md)」です。

<!---HONumber=AcomDC_0928_2016-->