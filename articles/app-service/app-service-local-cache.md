<properties
   pageTitle="Azure App Service のローカル キャッシュの概要"
   description="この記事では、Azure App Service のローカル キャッシュ機能を有効にする方法、サイズを変更する方法、状態をクエリする方法について説明します。"
   services="app-service"
   documentationCenter="app-service"
   authors="SyntaxC4"
   manager="yochayk"
   editor=""
   tags="optional"
   keywords="SEO 専門家専用です。用語間はコンマで区切ってください。この記事のこれらの用語を含むコンテンツを変更する前に、SEO 専門家に相談してください。"/>

<tags
   ms.service="app-service"
   ms.devlang="multiple"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="na"
   ms.date="03/04/2016"
   ms.author="cfowler"/>

# Azure App Service のローカル キャッシュの概要

Azure Web アプリケーションのコンテンツは Azure Storage に保存され、コンテンツ共有として永続的な方法で表示されます。これは多様なアプリケーションが機能するための設計であり、次の特徴があります。

* コンテンツは、Web アプリケーションの複数の VM インスタンス全体で共有されます。 
* コンテンツは永続的であり、Web アプリケーションを実行して変更できます。 
* ログ ファイルと診断データ ファイルは、同じ共有コンテンツ フォルダーで使用できます。 
* 新しいコンテンツを直接発行すると、コンテンツ フォルダーが更新され、SCM Web サイトと実行中の Web アプリにもすぐに同じコンテンツが表示されます (通常、何らかのファイルの変更があった場合、ASP.NET などの一部のテクノロジは Web アプリケーションの再起動を開始し、最新のコンテンツを取得します)。 

多くの Web アプリケーションはこれらの機能の 1 つ以上を使用しますが、高可用で実行できる高パフォーマンスの読み取り専用コンテンツ ストアのみを使用する Web アプリケーションもあります。このようなアプリケーションは、VM インスタンスの特定のコンテンツのコピーを利用できます。このコピーは "ローカル キャッシュ" と呼ばれます。_ローカル キャッシュ_は、コンテンツの Web ロール ビューを提供します。このコンテンツは、サイトの起動時に非同期に作成されるストレージ コンテンツの書き込み/破棄キャッシュです。キャッシュの準備ができると、キャッシュされたコンテンツに対して実行するようにサイトが切り替わります。Web アプリケーションをローカル キャッシュで実行すると、次の利点があります。

* Azure Storage のコンテンツにアクセスするときに発生する遅延の影響を受けません。 
* コンテンツ共有を提供するサーバーで計画的なアップグレードや予期しないダウンタイムが発生した場合など、Azure Storage が停止する問題が発生した場合に影響を受けません。 
* 記憶域の共有の変更によるアプリの再起動回数が少なくなります。 

## ローカル キャッシュによる App Service の動作の変化

* ローカル キャッシュは、 Web アプリケーションの /site フォルダーと /siteextensions フォルダーのコピーです。Web アプリケーションの起動時にローカル VM インスタンス上に作成されます。Web アプリケーションごとのローカル キャッシュのサイズは既定で上限が 300 MB ですが、最大 1 GB まで増やすことができます。 
* ローカル キャッシュは読み取り/書き込み対応ですが、Web アプリケーションが仮想マシンを移動した場合や再起動された場合は破棄されます。コンテンツ ストアに重要なデータを保存するアプリケーションには、ローカル キャッシュを使用しないでください。 
* Web アプリケーションは、ローカル キャッシュを使用しない場合と同様に、ログ ファイルと診断データの書き込みを継続できます。ただし、ログ ファイルとデータはローカルの VM に保存され、共有コンテンツ ストアに定期的にコピーされます。共有コンテンツ ストアへのコピーはベスト ケース エフォートで行われ、VM インスタンスが突然クラッシュした場合、書き戻しが失われる可能性があります。 
* ローカル キャッシュを使用する Web アプリの LogFiles フォルダーと Data フォルダーの構造は変わります。記憶域の "LogFiles" フォルダーと "Data" フォルダー以下に、"一意の識別子" + タイムスタンプという命名パターンに従ってサブフォルダーが作成されます。各サブフォルダーは、実行中か、実行されていた Web アプリケーションの VM インスタンスに対応します。  
* 何らかの発行メカニズムで変更を Web アプリケーションに発行すると、共有コンテンツ ストアに発行されます。これは、発行されたコンテンツに持続性を持たせるための設計です。Web アプリケーションのローカル キャッシュを更新するには、Web アプリケーションを再起動する必要があります。余計な手順のように見えるかもしれませんが、 以下を参照して、ライフサイクルをシームレスにしてください。
* D:\\Home はローカル キャッシュを指します。D:\\local は、一時的な VM 固有の記憶域を引き続き指します。 
* SCM サイトの既定のコンテンツ ビューは、引き続き共有コンテンツ ストアのビューです。ローカル キャッシュ フォルダーの構造を確認するには、https://[site-name].scm.azurewebsites.net/VFS/LocalSiteRoot/LocalCache を参照してください。

## Azure App Service でローカル キャッシュを有効にする方法

ローカル キャッシュは、予約されたアプリケーション設定を組み合わせて構成されます。このアプリケーション設定は、次の方法で構成できます。

* [Azure ポータル](#Configure-Local-Cache-Portal)
* [Azure リソース マネージャー](#Configure-Local-Cache-ARM)

### 方法: Azure ポータルを使用してローカル キャッシュを構成する
<a name="Configure-Local-Cache-Portal"></a>

ローカル キャッシュは、AppSetting を使用して Web アプリケーションごとに有効にします。`WEBSITE_LOCAL_CACHE_OPTION` = `Always`

![Azure ポータルのアプリケーション設定: ローカル キャッシュ](media/app-service-local-cache/app-service-local-cache-configure-portal.png)

### 方法: Azure リソース マネージャーを使用してローカル キャッシュを構成する
<a name="Configure-Local-Cache-ARM"></a>

```
...

{
    "apiVersion": "2015-08-01",
    "type": "config",
    "name": "appsettings",
    "dependsOn": [
        "[resourceId('Microsoft.Web/sites/', variables('siteName'))]"
    ],
    "properties": {
        "WEBSITE_LOCAL_CACHE_OPTION": "Always",
        "WEBSITE_LOCAL_CACHE_SIZEINMB": "300" 
    }
}

...
```

## App Service のローカル キャッシュのサイズを変更する方法

ローカル キャッシュの既定のサイズは **300 MB** です。ローカル キャッシュには、コンテンツ ストアからコピーされる Site フォルダーと SiteExtensions フォルダーだけでなく、ローカルで作成されたログとデータのフォルダーが含まれます。この上限を上げるには、AppSetting `WEBSITE_LOCAL_CACHE_SIZEINMB` を使用します。サイズは、Web アプリケーションごとに最大 **1 GB** (1000 MB) まで増やすことができます。

## App Service のローカル キャッシュを使用する場合のベスト プラクティス

ローカル キャッシュは、[ステージング環境](../app-service-web/web-sites-staged-publishing.md)機能と併用することをお勧めします。

* 値が `Always` の "固定の" Appsetting `WEBSITE_LOCAL_CACHE_OPTION` を**運用スロット**に追加します。`WEBSITE_LOCAL_CACHE_SIZEINMB` を使用している場合は、運用スロットにそれも固定の設定として追加します。 
* ステージング スロットを作成し、ステージング スロットに発行します。通常、ステージング スロットは、ステージングのシームレスなビルド、デプロイ、テストのライフサイクルを有効にするために、ローカル キャッシュを使用しませんが、運用スロットの場合はローカル キャッシュの利点があります。 
*	ステージング スロットに対してサイトをテストします。  
*	準備ができたら、**ステージング** スロットと**運用**スロット間の[スワップ操作](../app-service-web/web-sites-staged-publishing.md#to-swap-deployment-slots)を発行します。  
*	固定の設定は名前別であり、スロットに固定されます。そのため、ステージング スロットが運用スロットにスワップされると、ローカル キャッシュのアプリケーション設定が継承されます。新しくスワップされた運用スロットは、数分後からローカル キャッシュに対して実行され、スワップ後のスロット ウォームアップの一部としてウォーム アップされます。スロットのスワップが完了すると、運用スロットはローカル キャッシュに対して実行されるようになります。

## よく寄せられる質問

### 作成する Web アプリケーションにローカル キャッシュを適用できるかどうかは、どうやって判断できますか? 

高パフォーマンスで、信頼性の高いコンテンツ ストアが必要で、実行時に重要なデータ書き込むためにコンテンツ ストアを使用せず、合計サイズが 1 GB 未満であれば、ローカル キャッシュを適用できます。 "site" フォルダーと "site extensions" フォルダーの合計サイズを確認するには、サイト拡張機能の "Azure Web Apps Disk Usage" を使用します。
 
### ローカル キャッシュを有効にするにはどうすればよいですか? 

前述のローカル キャッシュを使用する際のベスト プラクティスのセクションを参照してください。
 
### サイトがローカル キャッシュの使用に切り替わったかどうかを確認するにはどうすればよいですか? 

ステージング環境でローカル キャッシュ機能を使用している場合、ローカル キャッシュのウォームアップが完了するまでスワップ操作は完了しません。サイトがローカル キャッシュに対して実行されているかどうかは、worker プロセス環境変数の `WEBSITE_LOCALCACHE_READY` で確認できます。このページの手順を使用して、複数インスタンスで worker プロセス環境変数にアクセスしてください。
 
### 新しい変更を発行しても Web アプリケーションに反映されないのはなぜですか? 
Web アプリケーションがローカル キャッシュを使用している場合、最新の変更を反映するには、サイトを再起動する必要があります。運用サイトを再起動したくない場合は、 前述のスロットのオプションを参照してください。
 
### ログはどこにありますか? 

ローカル キャッシュのログ フォルダーとデータ フォルダーの見た目は少し違いますが、サブ フォルダーの構造は、"一意の VM 識別子" + タイムスタンプという形式のサブ フォルダー以下に入れ子になっている点を除くと同じです。
 
### ローカル キャッシュを有効にした後も、Web アプリケーションが再起動されるのはなぜですか? ローカル キャッシュを使用すると、アプリが頻繁に再起動しないと思っていました。 

ローカル キャッシュを使用した場合、記憶域関連の Web アプリケーションの再起動回数が減りますが、VM の計画的なインフラストラクチャのアップグレード時には、Web アプリケーションが再起動する可能性があります。ローカル キャッシュを有効にした場合、アプリケーション全体の再起動回数は減ります。

<!---HONumber=AcomDC_0309_2016-->