---
title: アプリケーションのローリング アップグレード - Azure SQL Database | Microsoft Docs
description: Azure SQL Database で geo レプリケーションを使用してクラウド アプリケーションのオンライン アップグレードをサポートする方法について説明します。
services: sql-database
ms.service: sql-database
ms.subservice: high-availability
ms.custom: ''
ms.devlang: ''
ms.topic: conceptual
author: anosov1960
ms.author: sashan
ms.reviewer: mathoma, carlrab
manager: craigg
ms.date: 01/29/2019
ms.openlocfilehash: 50f6f114a4d90f48218f751e1649e8694e664491
ms.sourcegitcommit: a7331d0cc53805a7d3170c4368862cad0d4f3144
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/30/2019
ms.locfileid: "55295748"
---
# <a name="managing-rolling-upgrades-of-cloud-applications-using-sql-database-active-geo-replication"></a>SQL Database アクティブ geo レプリケーションを使用したクラウド アプリケーションのローリング アップグレードの管理

SQL Database で[アクティブ geo レプリケーション](sql-database-auto-failover-group.md)を使用してクラウド アプリケーションのローリング アップグレードを有効にする方法について説明します。 アップグレードは中断を伴う作業であるため、ビジネス継続性の計画と設計の一部として組み込む必要があります。 この記事では、アップグレード処理を編成する 2 種類の方法を確認し、方法ごとにメリットとトレードオフを説明します。 この記事では、データ層として単一のデータベースに接続されている Web サイトで構成されるアプリケーションを使用します。 ここでの目的は、エンド ユーザー エクスペリエンスに大幅な影響を及ぼさずにアプリケーションをバージョン 1 からバージョン 2 にアップグレードすることです。

アップグレード方法を評価する際に、次の要因を検討する必要があります。

* アップグレード中のアプリケーションの可用性への影響。 アプリケーションの機能が制限されるか低下する期間の長さ。
* アップグレードが失敗した場合にロールバックする機能。
* アップグレード中に関係のない致命的なエラーが発生した場合のアプリケーションの脆弱性。
* 合計コスト。  これには、アップグレード処理で使用される一時的なコンポーネントによる冗長性の補強とコストの増加が含まれます。

## <a name="upgrading-applications-that-rely-on-database-backups-for-disaster-recovery"></a>障害復旧をデータベースのバックアップに依存するアプリケーションのアップグレード

障害復旧をデータベースの自動バックアップに依存し、geo リストアを使用しているアプリケーションは、単一の Azure リージョンにデプロイします。 エンド ユーザーの中断を最小限に抑えるには、アップグレードに関連するすべてのアプリケーション コンポーネントで、そのリージョンにステージング環境を作成します。 次の図は、アップグレード処理の前の運用環境を示しています。 エンドポイント `contoso.azurewebsites.net` は、Web アプリケーションの運用スロットを表します。 アップグレードをロールバックする機能を有効にするには、完全に同期されたデータベースのコピーを使用してステージング スロットを作成する必要があります。 次の手順では、アップグレード用のステージング環境を作成します。

1. 同じ Azure リージョンにセカンダリ データベースを作成します。 セカンダリ データベースを監視して、シード処理が完了したかどうかを確認します (1)。
2. "ステージング" という Web アプリケーションの新しいデプロイ スロットを作成します。 これは URL が `contoso-staging.azurewebsites.net` の DNS に登録されます (2)。

> [!NOTE]
> 準備の手順は運用スロットに影響を与えず、アプリケーションはフル アクセス モードで動作できます。
>  

![SQL Database Go-Replication configuration. クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/option1-1.png)

準備の手順が完了すると、アプリケーションを実際にアップグレードできるようになります。 次の図は、アップグレード処理で必要な手順を示しています。

1. プライマリ データベースを読み取り専用モードに設定します (3)。 このモードでは、アップグレード中はアプリケーション (V1) の運用スロットが必ず読み取り専用のままになります。これにより、V1 と V2 のデータベース インスタンスのデータの不整合を防ぎます。  
2. 計画終了モードを使用して、セカンダリ データベースを切断します (4)。 これにより、完全に同期されたプライマリ データベースの独立したコピーが作成されます。 このデータベースがアップグレードされます。
3. プライマリ データベースで読み取り/書き込みモードを有効にして、アップグレード スクリプトを実行します (5)。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/option1-2.png)

アップグレードが正常に完了すると、エンドユーザーをアプリケーションのアップグレードされたコピーに切り替えられるようになります。 これが運用スロットになります。  この切り替えには、次の図に示すように、いくつかの手順がさらに必要になります。

1. Web アプリケーションの運用スロットとステージング スロットのスワップ操作をアクティブにします (6)。 これにより、2 つのスロットの URL が切り替えられます。 これで、`contoso.azurewebsites.net` が Web サイトとデータベース (運用環境) の V2 バージョンをポイントします。  
2. V1 バージョンがスワップ後にステージング コピーになり、不要になった場合は、ステージング環境の使用を停止できます (7)。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/option1-3.png)

アップグレード スクリプトのエラーなどによりアップグレード処理が失敗した場合は、ステージング スロットが侵害されたと見なされます。 アプリケーションをアップグレード前の状態にロールバックするには、運用スロットのアプリケーションをフル アクセスに戻します。 必要な手順は、次の図に示すとおりです。

1. データベースのコピーを読み取り/書き込みモードに設定します (8)。 これにより、運用環境のコピーの V1 の機能が完全に復元されます。
2. 根本原因分析を実行し、ステージング環境の使用を停止します (9)。

この時点で、アプリケーションが完全に動作可能になり、アップグレードの手順を繰り返すことができます。

> [!NOTE]
> まだスワップ操作を実行していないため、ロールバックに DNS の変更は必要ありません。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/option1-4.png)

この方法の主な**メリット**は、一連の簡単な手順を使用して単一のリージョンでアプリケーションをアップグレードできる点です。 アップグレードのコストは比較的安価になります。 主な**トレードオフ** は、アップグレード中に致命的なエラーが発生した場合、アップグレード前の状態に回復するには、別のリージョンでアプリケーションを再度デプロイし、geo リストアを使用してバックアップからデータベースを復元する必要がある点です。 この処理により、大幅なダウンタイムが生じます。

## <a name="upgrading-applications-that-rely-on-database-geo-replication-for-disaster-recovery"></a>ディザスター リカバリーをデータベースの geo レプリケーションに依存するアプリケーションのアップグレード

アプリケーションがビジネス継続性のためにアクティブ geo レプリケーションまたはフェールオーバー グループを活用する場合は、プライマリ リージョンにアクティブなプライマリ データベースがあり、バックアップ リージョンに読み取り専用のセカンダリ データベースがある、少なくとも 2 つの異なるリージョンにアプリケーションをデプロイします。 前に説明した要因に加えて、アップグレード処理で次の点を徹底する必要があります。

* アップグレード処理中は常に、致命的な障害からアプリケーションを保護する
* アプリケーションの geo 冗長コンポーネントを、アクティブ コンポーネントと同時にアップグレードする

これらの目標を達成するには、Web アプリのデプロイ スロットを使用するだけでなく、1 つのアクティブ エンドポイントと 1 つのバックアップ エンドポイントを備えたフェールオーバー プロファイルを使用して Azure Traffic Manager (ATM) を活用します。  次の図は、アップグレード処理の前の運用環境を示しています。 Web サイトの `contoso-1.azurewebsites.net` と `contoso-dr.azurewebsites.net` は、完全な geo 冗長性を備えたアプリケーションの運用環境を表します。 運用環境に含まれるコンポーネントを次に示します。

1. プライマリ リージョンの Web アプリケーション `contoso-1.azurewebsites.net` の運用スロット (1)
2. プライマリ リージョンのプライマリ データベース (2) 
3. バックアップ リージョンの Web アプリケーションのスタンバイ インスタンス (3)
4. バックアップ リージョンの geo レプリケートされたセカンダリ データベース (4)
5. オンライン エンドポイント `contoso-1.azurewebsites.net` と オフライン エンドポイント `contoso-dr.azurewebsites.net` がある Azure Traffic Manager のパフォーマンス プロファイル

アップグレードをロールバックする機能を有効にするには、完全に同期されたアプリケーションのコピーを使用してステージング環境を作成する必要があります。 アップグレード処理中に致命的な障害が発生した場合、アプリケーションを必ず迅速に回復できる必要があるため、ステージング環境は geo 冗長性も必要とします。 次の手順は、アップグレード用のステージング環境の作成で必要になります。

1. プライマリ リージョンに Web アプリケーションのステージング スロットをデプロイします (6)
2. プライマリ Azure リージョンにセカンダリ データベースを作成します (7)。 Web アプリケーションのステージング スロットを、これに接続するように構成します。 
3. セカンダリ データベースをプライマリ リージョンにレプリケートすることで (これを "geo レプリケーションの連鎖" と呼びます)、バックアップ リージョンにもう 1 つの geo 冗長セカンダリ データベースを作成します (8)。
3. Web アプリケーション インスタンスのステージング スロットをバックアップ リージョンにデプロイし (9)、手順 (9) で作成した geo セカンダリに接続するように構成します。


> [!NOTE]
> 準備の手順は運用スロットのアプリケーションに影響を与えず、アプリケーションは読み取り/書き込みモードでそのまま完全に機能することに注意してください。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/option2-1.png)

準備の手順が完了すると、ステージング環境をアップグレードできるようになります。 次の図は、アップグレードの手順を示します。

1. 運用スロットのプライマリ データベースを読み取り専用モードに設定します (10)。 このモードでは、アップグレード中は運用データベース (V1) が変更されないことが保証されるため、V1 と V2 のデータベース インスタンスのデータの不整合を防ぎます。  
2. 計画された終了モードを使用して、同じリージョンのセカンダリ データベースを切断します (11)。 これにより、独立していても完全に同期された運用データベースのコピーが作成されます。 このデータベースがアップグレードされます。
3. `contoso-1-staging.azurewebsites.net`、`contoso-dr-staging.azurewebsites.net`、およびステージングのプライマリ データベースに対してアップグレード スクリプトを実行します (12)。 データベースの変更は、ステージングのセカンダリに自動的にレプリケートされます 

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/option2-2.png)

アップグレードが正常に完了すると、エンドユーザーを V2 バージョンのアプリケーションに切り替えられるようになります。 次の図に、必要な手順を示します。

1. プライマリ リージョン (13) とバックアップ リージョン (14) の Web アプリケーションの運用スロットとステージング スロットのスワップ操作をアクティブにします。 これで、アプリケーションの V2 が、バックアップ リージョンに冗長コピーのある運用スロットになります。
2. V1 アプリケーションが不要になった場合は、ステージング環境の使用を停止できます (15 および 16)。  

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/option2-3.png)

アップグレード スクリプトのエラーなどによりアップグレード処理が失敗した場合は、ステージング環境が不整合状態であると見なされます。 アプリケーションをアップグレード前の状態にロールバックするには、運用環境で V1 のアプリケーションを使用するように戻します。 必要な手順は、次の図に示すとおりです。

1. 運用スロットのプライマリ データベースのコピーを読み取り/書き込みモードに設定します (17)。 これにより、運用スロットで V1 の機能が完全に復元されます。
2. 根本原因分析を実行し、ステージング環境を修復するか削除します (18 および 19)。

この時点で、アプリケーションが完全に動作可能になり、アップグレードの手順を繰り返すことができます。

> [!NOTE]
> まだスワップ操作を実行していないため、ロールバックに DNS の変更は必要ありません。

![SQL Database の geo レプリケーションの構成。 クラウド ディザスター リカバリー 。](media/sql-database-manage-application-rolling-upgrade/option2-4.png)

この方法の主な **メリット** は、アップグレード中にビジネス継続性を損なうことなく、アプリケーションと geo 冗長性を持つコピーの両方を並行してアップグレードできる点です。 主な **トレードオフ** は、各アプリケーション コンポーネントが 2 倍の冗長性を必要とするため、コストが増加する点です。 また、より複雑なワークフローが必要になります。

## <a name="summary"></a>まとめ

この記事で説明している 2 種類のアップグレード方法の違いは、複雑さとコストです。ただし、両方とも、エンドユーザーの操作が読み取り専用に制限される時間を最小限に抑えることに焦点を合わせています。 この時間は、直接的にはアップグレード スクリプトの時間で決まります。 データベースのサイズ、選択したサービス レベル、Web サイトの構成、制御が容易でないその他の要因には左右されません。 すべての準備の手順は、アップグレードの手順から切り離されていて、運用アプリケーションに影響を与えません。 アップグレード スクリプトの効率性は、アップグレード中のエンド ユーザー エクスペリエンスを決定する重要な要素です。 これを改善できる最適な方法は、アップグレード スクリプトをできる限り効率的にすることに集中して取り組むことです。  

## <a name="next-steps"></a>次の手順

* ビジネス継続性の概要およびシナリオについては、 [ビジネス継続性の概要](sql-database-business-continuity.md)に関する記事を参照してください。
* Azure SQL Database アクティブ geo レプリケーションの詳細については、「[アクティブ geo レプリケーションを使用して、読み取り可能なセカンダリ データベースを作成する](sql-database-active-geo-replication.md)」を参照してください。
* Azure SQL Database フェールオーバー グループの詳細については、「[自動フェールオーバー グループを使用して、複数のデータベースの透過的な調整されたフェールオーバーを有効にする](sql-database-auto-failover-group.md)」を参照してください。
* Azure App Service のデプロイ スロットとステージング環境の詳細については、「[Azure App Service でステージング環境を設定する](../app-service/deploy-staging-slots.md)」を参照してください。  
* Azure Traffic Manager プロファイルの詳細については、「[Traffic Manager プロファイルの作成](../traffic-manager/traffic-manager-manage-profiles.md)」を参照してください。  


