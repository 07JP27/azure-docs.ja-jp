<properties 
   pageTitle="Azure SQL Database のリソース制限"
   description="このページでは、Azure SQL Database に対するいくつかの一般的なリソース制限について説明します。"
   services="sql-database"
   documentationCenter="na"
   authors="rothja"
   manager="jeffreyg"
   editor="monicar" />
<tags 
   ms.service="sql-database"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="data-management"
   ms.date="07/24/2015"
   ms.author="jroth" />

# Azure SQL Database のリソース制限

Azure SQL Database は、トランザクション ログ、I/O、およびその他の多数のリソースなど、共有リソースの使用量を監視します。これにより、Azure SQL Databse は設定されたリソース境界内にデータベースを保持できます。このリソース境界またはしきい値はリソース制限と呼ばれます。クライアントによるリソース使用量がテナントまたは物理ノード レベルのいずれかでこれらの制限を超えると、Azure SQL Database はリソース使用量の管理を開始し、その結果、接続が失われたり、要求が拒否されたりすることがあります。

> [AZURE.NOTE]リソース制限によって、クエリによるデータベース パフォーマンス問題の分析が妨げられると、専用管理者接続 (DAC) が必要になる場合があります。この接続は Azure SQL Database V12 を開始することで使用できるようになります。DAC の使用の詳細については、「[データベース管理者用の診断接続](https://msdn.microsoft.com/library/ms189595.aspx)」をご覧ください。

## リソースの制限の概要表

次の表には、各リソースに対する制限の概要が示されており、これらの制限を超えると、Azure SQL Database によって影響を受けるリソースへの接続が切断されたり、要求が拒否されたりして、エラー コードが返されます。サービス層 (Basic、Standard、Premium) およびパフォーマンス レベルによって正確な制限が決まる場合もあります。そのような場合については、「[Azure SQL Database のサービス階層とパフォーマンス レベル](https://msdn.microsoft.com/library/azure/dn741336.aspx)」をご覧ください。

[AZURE.INCLUDE [azure-sql-database-limits](../../includes/azure-sql-database-limits.md)]

## エラー コードについて

リソースの複数の制限条件に対して、同じエラー コードが返される場合があります。これらの条件は、エラー メッセージで状態として識別されます。たとえば、次の 2 つのエラー メッセージが "トランザクション ログの長さ" リソースに対して表示されるとします。メッセージのテキストは同じですが、基盤となる制限条件が異なるため、State 値は異なります (それぞれ 1 と 2)。

エラー メッセージ 1:

	Msg 40552, Level 17, State 1, Line 1
	The session has been terminated because of excessive transaction log space usage.
	Try modifying fewer rows in a single transaction.

エラー メッセージ 2:

	Msg 40552, Level 17, State 2, Line 1
	The session has been terminated because of excessive transaction log space usage.
	Try modifying fewer rows in a single transaction.

同じ状況が、一部のメッセージに表示されるリソース ID にも適用されます。リソース ID は、制限が生じているシステム リソースに読み換えることができます。

このトピックの残りの部分では、状態の値とリソース ID によってエラーの詳細情報が示される例など、発生する可能性のあるエラー コードについてさらに説明します。

## データベース サイズ

| &nbsp; | 詳細 |
| :--- | :--- |
| **条件** | ユーザー データベースに割り当てられたデータベース領域がいっぱいになると、ユーザーはデータベースがいっぱいになったことを知らせるエラーを受け取ります。 |
| **エラー コード** | **40544**: データベースのサイズ クォータに達しました。データをパーティション分割するか、データを削除するか、インデックスを削除してください。その他の解決方法についてはドキュメントを参照してください。 |
| **制限** | [サービス階層とパフォーマンス レベル](https://msdn.microsoft.com/library/azure/dn741336.aspx)によって異なります。 |
| **拒否される要求の種類** | Select 以外の DML (Insert、Update、挿入または更新を行う Merge)。 |
| **推奨** | DELETE/DROP ステートメントを使用して、データベース サイズが制限を下回るまでデータベースからデータを削除します。 |

## ログイン

| &nbsp; | 詳細 |
| :--- | :--- |
| **条件** | SQL Database は、データベースに確立できる同時ログイン数に対する制限を管理します。データベースに対する同時ログインの制限に達すると、データベースへの新しいログイン要求は拒否され、エラー コード 10928 が返されます。 |
| **エラー コード** | **10928**: Resource ID: 3.データベースの %s 制限の %d に達しました。詳細については、http://go.microsoft.com/fwlink/?LinkId=267637 を参照してください。 |
| **制限** | [サービス階層とパフォーマンス レベル](https://msdn.microsoft.com/library/azure/dn741336.aspx)によって異なります。 |
| **推奨** | dm\_exec\_connections を調べて、現在アクティブなユーザー接続を確認します。<br><br>バックオフして、10 秒後に再度ログインします。 |

> [AZURE.NOTE]エラー メッセージ内のリソース ID 値は、制限に達したリソースを示します。ログインの場合、リソース ID = 3 です。

## メモリ使用量

| &nbsp; | 詳細 |
| :--- | :--- |
| **条件** | 20 秒以上メモリ許可を待機しているセッションがある場合、メモリ許可の 16 MB を超える量を 20 秒を超えて使用しているセッションは、リソースが保持された時間の降順で終了されます。つまり、最も古いセッションが最初に終了されます。セッション終了の処理は、必要なメモリを使用できるようになるとすぐに停止します。 |
| **エラー コード** | **40553**: メモリの使用量が多すぎるため、セッションを終了しました。クエリを変更して、処理する行を減らしてください。 |
| **制限** | 16 MB を超えるメモリ許可が 20 秒を超える場合。 |
| **拒否される要求の種類** | ハッシュ結合および並べ替えを使用するクエリを含み、メモリ許可を使用するクエリ。 |
| **推奨** | 並べ替えやハッシュ結合が必要なクエリに対して、クエリ チューニングを実行します。 |

## セッション

| &nbsp; | 詳細 |
| :--- | :--- |
| **条件** | SQL Database は、データベースに確立できる同時セッション数に対する制限を管理します。データベースに対する同時セッションの制限に達すると、データベースに対する新しい接続が拒否され、ユーザーはエラー コード 10928 を受け取ります。ただし、データベースに対する既存のセッションは終了しません。 |
| **エラー コード** | **10928**: Resource ID: 2.データベースの %s 制限の %d に達しました。詳細については、http://go.microsoft.com/fwlink/?LinkId=267637 を参照してください。 |
| **制限** | [サービス階層とパフォーマンス レベル](https://msdn.microsoft.com/library/azure/dn741336.aspx)によって異なります。 |
| **推奨** | dm\_exec\_requests を調べて、現在実行されているユーザー要求を確認します。 |

> [AZURE.NOTE]エラー メッセージ内のリソース ID 値は、制限に達したリソースを示します。セッションの場合、リソース ID = 2 です。

## Tempdb

| &nbsp; | 詳細 |
| :--- | :--- |
| **条件** | 次の 3 つのいずれかの条件が当てはまる場合、tempdb に対する要求が拒否される可能性があります。<br><br>\*\*状態 1:\*\* セッションで tempdb 領域の 5 GB を超える領域が使用され、セッションが終了される。<br><br>\*\*状態 2:\*\* 2 GB のサイズを超えるログを伴う tempdb のトランザクションが切り捨てられる。tempdb でログ領域を消費する可能性のある操作には、挿入、更新、削除、マージ、作成、インデックス作成などがあります。<br><br>\*\*状態 3:\*\* tempdb でコミットされていないトランザクションにより、ログ ファイルの切り捨てがブロックされる可能性がある。これを回避するには、最も古い、アクティブなトランザクション ログ シーケンス番号 (LSN) から、tempdb 内のログの末尾 (現在の LSN) までの距離が、ログ ファイル サイズの 20% を超過しないようにする必要があります。これに違反すると、tempdb 内で問題が発生したトランザクションは終了し、ログを切り捨てられるようにロール バックされます。 |
| **エラー コード** | **40551**: tempdb の使用領域が多すぎるため、セッションを終了しました。クエリを変更して一時テーブルの使用領域を減らしてください。 |
| **制限** | **状態 1:** tempdb 領域の 5 GB<br><br> **状態 2:** tempdb 内のトランザクションごとに 2 GB <br><br>\*\*状態 3:\*\* tempdb 内の合計ログ領域の 20% |
| **拒否される要求の種類** | tempdb に対するすべての DDL または DML ステートメント。 |
| **推奨** | クエリを変更して一時テーブル領域の使用を減らしたり、不要になった一時オブジェクトを削除したり、テーブルを切り捨てたり、使用されていないテーブルを削除したりします。行の数を減らすか、1 つの操作を複数のトランザクションに分割して、tempdb 内のトランザクションのデータ サイズを小さくします。 |

## トランザクションの実行時間

| &nbsp; | 詳細 |
| :--- | :--- |
| **条件** | トランザクション要求によって、行、ページ、またはテーブルなどのリソースにロックが掛けられます。そのようなリソースにトランザクションは依存しますが、ロックされたリソースに対する依存関係がなくなると、トランザクションによってロックが解除されます。次の 2 つの条件のいずれかが当てはまる場合、要求が拒否される可能性があります。状態 1: トランザクションが 24 時間を超えて実行され続けている場合、そのトランザクションは終了されます。状態 2: 基本システム タスクに必要なリソースがトランザクションによってロックされている時間が 20 秒間を超えると、そのトランザクションは終了されます。 |
| **エラー コード** | **40549**: トランザクションが長時間実行されているため、セッションを終了しました。トランザクションを短くしてください。 |
| **制限** | **状態 1:** 24 時間<br><br>\*\*状態 2:\*\* 基本システム タスクに必要なリソースをトランザクションがロックしている場合、20 秒間 |
| **拒否される要求の種類** | 24 時間を超えて実行されているすべてのトランザクション、またはロックを掛けることでシステム タスクがブロックされる、すべての DDL または DML ステートメント。 |
| **推奨** | SQL Database に対する操作でユーザー入力がブロックされたり、長時間実行されるトランザクションが発生するその他の依存関係が含まれたりしないようにします。 |

## トランザクション ロック数

| &nbsp; | 詳細 |
| :--- | :--- |
| **条件** | 100 万個を超えるロックを使用しているセッションは終了されます。 |
| **エラー コード** | **40550**: 取得したロックの数が多すぎるため、セッションを終了しました。1 つのトランザクションで読み取る行または変更する行の数を減らしてください。 |
| **制限** | トランザクションあたり、100 万のロック |
| **拒否される要求の種類** | DDL または DML ステートメント。 |
| **推奨** | 次の DMV を使用してトランザクションを監視できます。**sys.dm\_tran\_active\_transactions**、**sys.dm\_tran\_database\_transactions**、**sys.dm\_tran\_locks**、および **sys.dm\_tran\_session\_transactions**。アプリケーションの種類によっては、**PAGLOCK** や **TABLOCK** などのより粒度の粗いロック ヒットを使用して、所定のステートメント/トランザクションで掛けられるロック数を減らせる場合があります。この処理によって、アプリケーションの同時実行に悪影響が及ぼされる可能性があります。 |

## トランザクション ログの長さ

| &nbsp; | 詳細 |
| :--- | :--- |
| **条件** | 次の 2 つの条件のいずれかが当てはまる場合、要求が拒否される可能性があります。<br><br>\*\*状態 1:\*\* SQL Database で、最大 2 GB のサイズのログが生成されるトランザクションがサポートされている。この制限を超えるログを持つトランザクションは切り捨てられます。このボリュームのログ領域を消費する可能性のある操作には、挿入、更新、削除、マージ、作成、インデックス付けなどがあります。<br><br>\*\*状態 2:\*\* コミットされていないトランザクションにより、ログ ファイルの切り捨てがブロックされる可能性がある。これを回避するには、最も古い、アクティブなトランザクション ログ シーケンス番号 (LSN) から、ログの末尾 (現在の LSN) までの距離が、ログ ファイル サイズの 20% を超過しないようにする必要があります。これに違反すると、問題が発生したトランザクションは終了し、ログを切り捨てられるようにロール バックされます。 |
| **エラー コード** | **40552**: トランザクション ログの使用領域が多すぎるため、セッションを終了しました。1 回のトランザクションで変更する行を減らしてください。 |
| **制限** | **状態 1:** トランザクションあたり 2 GB<br><br>\*\*状態 2:\*\* 合計ログ領域の 20% |
| **拒否される要求の種類** | DDL または DML ステートメント。 |
| **推奨** | 行操作に関しては、たとえば行数を減らしたり、1 つの操作を複数のトランザクションに分割したりして、トランザクション内のデータ サイズを減らします。単一のトランザクションが必要なテーブル/インデックス操作に関しては、次の公式に準拠していることを確認します。テーブル内で影響を受ける行数 \* (更新されるフィールドのバイト単位の平均サイズ + 80) < 2 GB (インデックスを再作成した場合、更新されるフィールドの平均サイズを平均インデックス サイズによって置き換える必要があります)。 |

## ワーカー スレッド (最大同時要求)

| &nbsp; | 詳細 |
| :--- | :--- |
| **条件** | SQL Database は、データベースに対するワーカー スレッド数 (同時要求) に対する制限を管理します。上限を超える同時要求を持つデータベースはエラー 10928 を受け取り、そのデータベースに対する後続の要求は拒否される可能性があります。 |
| **エラー コード** | **10928**: Resource ID: 1.データベースの %s 制限の %d に達しました。詳細については、http://go.microsoft.com/fwlink/?LinkId=267637 を参照してください。<br><br>\*\*10929\*\*: リソース ID: 1。%S の最低限保証は %d、最大値は %d 、データベースの現在の使用状況は %d です。ただし、サーバーは現在ビジー状態であり、このデータベースの %d を超える要求をサポートできません。詳細については、http://go.microsoft.com/fwlink/?LinkId=267637 を参照してください。それ以外の場合は、後でもう一度やり直してください。 |
| **制限** | Basic、Standard、および Premium 層に関しては、[パフォーマンス レベル](https://msdn.microsoft.com/library/azure/dn741336.aspx)によって異なります。以前の Web/Business Edition データベースの場合、同時要求の上限は 180 ですが、システム アクティビティによってはこれよりも少なくなる場合があります。 |
| **推奨** | dm\_exec\_requests を調べて、現在実行されているユーザー要求を確認します。<br><br>バックオフし、10 秒後に要求を再試行します。 |

> [AZURE.NOTE]エラー メッセージ内のリソース ID 値は、制限に達したリソースを示します。ワーカー スレッドの場合、リソース ID = 1 です。

ワーカー スレッドに対する管理によって生じたエラー (10928/10929) によって、ワーカー スレッドの元のエンジン調整エラー (40501) が置き換えられます。通常の状況では、ユーザーはワーカー スレッドに対するエンジン調整エラーは受け取りません。

フェデレーション データベース機能を使用した場合など、特定の状況では、データベースにサインインするときにワーカー スレッド上限エラー (10928) が発生する可能性があります。これは、この操作によって、Connection.Open 呼び出しの対象となるワーカー スレッドが使用されるためです。これにより、アプリケーションはワーカー スレッドの上限しきい値を超える可能性があります。アプリケーションには、このエラーを適切に処理して、このような事例を処理するための組み込みロジックが必要です。

## 関連項目

[Azure SQL Database のリソース管理](https://msdn.microsoft.com/library/azure/dn338083.aspx)

[SQL Database クライアント プログラムのエラー メッセージ](sql-database-develop-error-messages.md)

[要求拒否または接続終了を防ぐための Azure SQL Database のベスト プラクティス](https://msdn.microsoft.com/library/azure/dn338082.aspx)

<!---HONumber=July15_HO5-->