<properties 
    pageTitle="Elastic Database Split-Merge ツールを使用したスケーリング" 
    description="Elastic Database API を使用して、シャードを操作し、自己ホスト サービス経由でデータを移動する方法について説明します。" 
    services="sql-database" 
    documentationCenter="" 
    manager="jeffreyg" 
    authors="sidneyh"/>

<tags 
    ms.service="sql-database" 
    ms.workload="sql-database" 
    ms.tgt_pltfrm="na" 
    ms.devlang="na" 
    ms.topic="article" 
    ms.date="04/24/2015" 
    ms.author="sidneyh" />

# Elastic Database Split-Merge ツールを使用したスケーリング

Azure SQL Database は、ビジネス·ニーズの変化に応じて、アプリケーションのデータ層を拡張するさまざまな方法を提供します。この場合の例には、急速に広まったアプリケーションや、データベースをその制限にプッシュする特定のテナントの処理が含まれます。スケーリングには、次のオプションがあります。

* エラスティック データベース プールを使用して、プール全体の予測可能な合計金額を維持しながら、必要に応じて、プール内のデータベースで使用するリソースを個別に拡大および縮小できます。新規のテナントや離脱するテナントをサポートするために、データベースをプールに追加したりプールから削除することもできます。詳細については、「[Azure SQL Database エラスティック プール (プレビュー)](sql-database-elastic-pool.md)」をご覧ください。 

* エディションまたはパフォーマンス階層を手動またはポリシーに基づいて変更することで、データベースのリソースを明示的に増減します (「[シャードの弾力性](sql-database-elastic-scale-elasticity.md)」をご覧ください)。

* シャード間のデータの分布を変更します。多くの場合、シャード セット用のデータベースの合計数の増加および減少が伴います。これは、Split-Merge と呼ばれ、複数のエンド カスタマー (テナント) が同じシャード内で管理される場合に必要になることがあります。

この最後のシナリオでは、**Elastic Database Split-Merge ツール**を使用し、簡単な垂直スケーリングの代替手段や、新しいテナントに新しいデータベースを追加するだけでは不十分な場合に重要です。Split-Merge ツールは、スケールインとスケールアウトを管理します。データベースをシャード セットに追加またはシャードセットから削除し、Split-Merge ツールを使用して、それらの間のシャードレットの分散状態を再調整できます (用語の定義については、「[Elastic Scale 用語集](sql-database-elastic-scale-glossary.md)」をご覧ください)。

現在、提供されている Azure SQL Database 階層では、単一 Azure SQL DB データベースの容量を拡大または縮小して容量を管理することもできます。Split/Merge では、柔軟な容量管理のスケールアップ/ダウン ディメンションはサポートされません (「[シャードの弾力性](sql-database-elastic-scale-elasticity.md)」をご覧ください)。

 
## Split/Merge の新機能

Split/Merge ツールの最新リリースでは、次の機能が強化されました。

* .Net API は、Split/Merge のインターフェイスに含まれ、Web ロールはオプションになりました。 
* シャーディング キーの日付と時刻の型がサポートされるようになりました。 
* リスト シャード マップは現在サポートされています。 
* 要求の範囲境界は、より簡単にシャード マップに格納されている範囲と一致できます。
* 可用性を高めるために、複数のワーカー ロール インスタンスがサポートされています。 
* Split/Merge 操作の一部として格納されている資格情報は、REST で暗号化されます。

## アップグレードする方法

Split/Merge の最新バージョンにアップグレードするには、次の手順に従います。

1. 「[Split-Merge パッケージのダウンロード](sql-database-elastic-scale-configure-deploy-split-and-merge.md#download-the-Split-Merge-packages)」の説明に従って、NuGet から Split-Merge パッケージの最新バージョンをダウンロードします。
2. Split/Merge のデプロイ用のクラウド サービス構成ファイルを変更して、新しい構成パラメーターを反映します。新しい必須のパラメーターは、暗号化に使用される証明書に関する情報です。これを簡単に行うには、ダウンロードした新しい構成テンプレート ファイルを既存の構成と比較します。Web ロールとワーカー ロールの「DataEncryptionPrimaryCertificateThumbprint」と「DataEncryptionPrimary」に、必ず設定を追加するようにしてください。
3. Azure に更新を展開する前に、現在実行中のすべての Split/Merge 操作が完了していることを確認します。これは、実行中の要求の Split/Merge メタデータのデータベースで RequestStatus と PendingWorkflows テーブルを照会することで簡単に行えます。
4. 新しいパッケージと更新されたサービス構成ファイルで、Azure サブスクリプションの Split/Merge の既存のクラウド サービスのデプロイを更新します。

アップグレードするために Split/Merge の新しいメタデータ データベースをプロビジョニングする必要はありません。新しいバージョンは、既存のメタデータ データベースを新しいバージョンに自動的にアップグレードします。

## Split/Merge のシナリオ 
アプリケーションは、次のシナリオで示すように、単一の Azure SQL DB データベースの制限を超えて柔軟に拡張できる必要があります。

* **容量の拡張 - 範囲の分割**: データ層の合計容量を拡張できる能力は、容量の拡張ニーズに対応します。このシナリオでは、アプリケーションは、容量ニーズを満たすために、データをシャーディングし、データを分散するデータベースの数を段階的に増やすことによって追加の容量を確保します。このシナリオに対しては、Elastic Scale の Split/Merge サービスの "分割" 機能を使用して対処できます。 

* **容量の縮小 - 範囲のマージ:**: 容量は、ビジネスの季節的な性質によって変動します。このシナリオは、ビジネスの成長が鈍化したときにより少ないスケール単位に簡単に戻すことができる機能に対するニーズを強調しています。Elastic Scale の Split/Merge サービスの "マージ" 機能を使用すると、この要件に対処できます。

* **ホットスポットの管理 - シャードレットの移動**: データベースごとに複数のテナントがある場合、シャードレットをシャードに割り当てることが、一部のシャードの容量ボトルネックにつながります。これには、シャードレットを再び割り当てたり、ビジー状態のシャードレットを新しいシャードや使用率の低いシャードに移動したりする操作が必要になります。

以降では、これらの機能に従うサービスのすべての処理を**分割/マージ/移動**要求と呼びます。


図 1: Split/Merge の概念の概要


![概要][1]


**注**: すべての**容量の拡張**シナリオで Split/Merge サービスが必要になるとは限りません。たとえば、新しいデータを増え続けるシャーディング キー値と共に格納するために環境に新しいシャードを定期的に作成する場合、シャード マップの管理クライアント API を使用して、新しく作成されたシャードを新しいデータ範囲で使用することができます。Split/Merge サービスは、既存のデータも移動する必要がある場合にのみ必要になります。

## 概念と主な機能

**お客様側でホストされるサービス**: Split/Merge は、お客様側でホストされるサービスとして提供されます。このサービスは、Microsoft Azure サブスクリプション内でデプロイし、ホストする必要があります。NuGet からダウンロードするパッケージには構成テンプレートが含まれていて、これに特定のデプロイメントの情報を入力します。詳細については、「[Elastic Scale の分割とマージ サービス チュートリアル](sql-database-elastic-scale-configure-deploy-split-and-merge.md)」をご覧ください。このサービスは Azure サブスクリプション内で実行されるため、サービスのセキュリティに関するほとんどの側面を制御および構成できます。既定のテンプレートには、SSL、証明書ベースのクライアント認証、保存された資格情報の暗号化、DoS 対策、IP 制限を構成するためのオプションが含まれています。セキュリティの側面については、「[Elastic Scale のセキュリティの構成](sql-database-elastic-scale-split-merge-security-configuration.md)」をご覧ください。

既定では、デプロイされたサービスは、1 つのワーカー ロールと 1 つの Web ロールを使用して実行されます。それぞれは、Azure Cloud Services の A1 VM サイズを使用します。これらの設定は、パッケージをデプロイするときに変更することはできませんが、実行中のクラウド サービスへのデプロイが成功した後に (Azure のポータルを通じて) 変更することができます。技術的な理由により、複数のインスタンスにワーカー ロールを構成しないでください。

**シャード マップの統合**: Split/Merge サービスは、アプリケーションのシャード マップと対話します。Split/Merge サービスを使用して範囲を分割またはマージしたり、シャードレットをシャード間で移動したりするとき、サービスによってシャード マップが自動的に最新の状態に保たれます。これを実現するために、サービスは、アプリケーションのシャード マップ マネージャー データベースに接続し、分割/マージ/移動要求の進行に伴って範囲とマッピングを管理します。これにより、Split/Merge 操作が実行されているときにシャード マップが常に最新の状態を示すことが保証されます。分割、マージ、およびシャードレットの移動操作は、シャードレットのバッチをソース シャードからターゲット シャードに移動することによって実装されます。シャードレットの移動操作中、現在のバッチの対象のシャードレットは、シャード マップ内でオフラインとしてマークされ、**OpenConnectionForKey API** を使用したデータ依存ルーティング接続に使用できなくなります。

**一貫性のあるシャードレットの接続**: シャードレットの新しいバッチのデータの移動が開始されると、シャードレットを格納しているシャードへの、シャード マップによって提供されるすべてのデータ依存ルーティング接続が強制終了されます。さらに不整合を回避するために、データの移動操作中は、シャード マップ API からのこれらのシャードレットへの後続の接続がブロックされます。同じシャード上の他のシャードレットへの接続も強制終了されますが、再試行すると成功します。バッチが移動されると、シャードレットがターゲット シャードに対して再びオンラインとしてマークされ、ソース データがソース シャードから削除されます。すべてのシャードレットが移動されるまで、すべてのバッチに対してこの手順が実行されます。これにより、完全な移動/分割/マージ操作の進行中に接続の強制終了操作が複数回実行されることになります。

**シャードレットの可用性の管理**: 前述のように、接続の強制終了をシャードレットの現在のバッチに制限することで、使用不可能となるシャードレットのスコープが一度に 1 つのバッチに限定されます。これは、分割/マージ操作の進行中にすべてのシャードレットに対してシャード全体がオフラインになるような方法よりも好ましいアプローチです。一度に移動する個別のシャードレットの数として定義されるバッチのサイズは、1 つの構成パラメーターです。これは、アプリケーションの可用性とパフォーマンスのニーズに応じて分割/マージ操作ごとに定義できます。シャード マップでロックされている範囲は、指定されたバッチ サイズよりも大きくなる場合があります。これは、サービスによって、データ内のシャーディング キー値の実際の数がバッチ サイズとほぼ一致するように範囲のサイズが選択されるためです。これは、シャーディング キー値の数がスパースな場合に関して特に覚えておく必要があります。

**メタデータのストレージ**: Split/Merge サービスは、データベースを使用して、その状態を管理し、要求処理中のログを保持します。ユーザーは、サブスクリプションにこのデータベースを作成し、このデータベースの接続文字列をサービス デプロイメントの構成ファイルに指定します。ユーザーの組織の管理者も、要求の進行状況を確認したり、潜在的な障害に関する詳細な情報を調べるために、このデータベースに接続できます。

**シャーディング対応**: Split/Merge サービスでは、(1) シャード化テーブル、(2) 参照テーブル、(3) 通常のテーブルが区別されます。移動/分割/マージ操作のセマンティクスは、使用されるテーブルの種類によって異なり、次のように定義されます。

* **シャード化テーブル**: 移動/分割/マージ操作により、ソース シャードからターゲット シャードにシャードレットが移動されます。要求全体が正常に完了した後、これらのシャードレットはソース上に存在しません。ターゲット テーブルは、ターゲット シャード上に存在する必要があり、操作の処理の前にターゲット範囲にデータが含まれていてはいけません。 

* **参照テーブル**: 参照テーブルの場合、分割/マージ/移動操作により、ソース シャードからターゲット シャードにデータがコピーされます。ただし、ターゲット上のテーブルに行が存在する場合、このテーブルのターゲット シャード上で変更はしません。参照テーブルのコピー操作を処理するには、テーブルが空になっている必要があります。

* **その他のテーブル**: その他のテーブルは、分割/マージ操作のソースまたはターゲットのどちらかに存在することができます。Split/Merge サービスでは、すべてのデータの移動またはコピー操作に関してこれらのテーブルは無視されます。ただし、制約がある場合にこれらのテーブルが操作を妨げる可能性があることに注意してください。

参照テーブルとシャード化テーブルに関する情報は、シャード マップの **SchemaInfo API** によって提供されます。次の例では、特定のシャード マップ マネージャー オブジェクト smm でこれらの API を使用しています。

    // Create the schema annotations 
    SchemaInfo schemaInfo = new SchemaInfo(); 

    // Reference tables 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "region")); 
    schemaInfo.Add(new ReferenceTableInfo("dbo", "nation")); 

    // Sharded tables 
    schemaInfo.Add(new ShardedTableInfo("dbo", "customer", "C_CUSTKEY")); 
    schemaInfo.Add(new ShardedTableInfo("dbo", "orders", "O_CUSTKEY")); 

    // Publish 
    smm.GetSchemaInfoCollection().Add(Configuration.ShardMapName, schemaInfo); 

‘region’ テーブルと ‘nation’ テーブルは参照テーブルとして定義されており、分割/マージ/移動の各操作によってコピーされます。一方、‘customer’ と ‘orders’ は共有テーブルとして定義されています。C_CUSTKEY と O_CUSTKEY は、シャーディング キーとして機能します。

**参照整合性**: Split/Merge サービスは、テーブル間の依存関係を分析し、外部キーと主キーのリレーションシップを使用して、参照テーブルとシャードレットを移動する操作をステージングします。一般に、最初に参照テーブルが依存関係の順にコピーされ、次にシャードレットが各バッチ内での依存関係の順にコピーされます。これは、新しいデータが到着するときにターゲット シャード上の外部キーと主キーの制約が適用されるために必要な操作です。

**シャード マップの整合性と最終的な完了**: エラーの場合、Split/Merge サービスは停止後に操作を再開して、進行中の要求を完了しようとします。ただし、ターゲット シャードが失われた場合や、修復できないほど危害を受けている場合など、回復できない状況もあります。このような状況では、移動されたと考えられるシャードレットがソース シャード上に残されたままになる場合があります。このサービスでは、必要なデータがターゲットに正常にコピーされた後でのみシャードレット マッピングが更新されることが保証されます。ソース上のシャードレットは、すべてのデータがターゲットにコピーされ、対応するマッピングが正常に更新された後で削除されます。削除操作は、ターゲット シャード上で範囲が既にオンラインになっているときにバックグラウンドで実行されます。Split/Merge サービスでは、シャード マップに格納されているマッピングの正確性が常に保証されます。

## サービスのバイナリの取得

Split/Merge サービスのバイナリは、[Nuget](http://www.nuget.org/packages/Microsoft.Azure.SqlDatabase.ElasticScale.Service.SplitMerge/) から提供されます。バイナリをダウンロードする方法については、[Split-Merge のチュートリアル](sql-database-elastic-scale-configure-deploy-split-and-merge.md)の手順をご覧ください。

## Split/Merge のユーザー インターフェイス

Split/Merge サービス パッケージには、worker ロールだけでなく Web ロールも含まれ、これを使用して対話的に分割/マージ要求を送信できます。ユーザー インターフェイスの主要なコンポーネントは、次のとおりです。

-    操作の種類: オプション ボタンを使用して、この要求に対してサービスで実行される操作の種類を制御します。「概念と主な機能」で説明した分割シナリオ、マージ シナリオ、および移動シナリオの中から選択できます。また、以前に送信した操作を取り消すこともできます。範囲シャード マップに分割/マージ/移動要求を使用できます。リスト シャード マップは、移動操作のみをサポートしています。

-    シャード マップ: 要求パラメーターの次のセクションでは、シャード マップと、シャード マップをホストするデータベースに関する情報を指定します。具体的には、Azure SQL Database サーバーの名前、シャード マップをホストするデータベース、シャード マップ データベースに接続するための資格情報、および最後にシャード マップの名前を指定する必要があります。現時点では、1 つの資格情報のセットのみを指定できます。これらの資格情報には、シャード上のユーザー データだけでなく、シャード マップに対する変更を実行するための十分な権限が与えられている必要があります。

-    ソースの範囲 (分割/マージ): 分割とマージ操作は、低値キーと高値キーを使用して範囲を処理します。無制限の高値キーで操作を指定するには、「高キーは最大」チェックボックスをオンにして、高値キーフィールドを空のままにしておきます。指定する範囲のキー値はシャード マップ内のマッピングと境界に正確に一致する必要はありません。範囲の境界を全く指定しない場合は、サービスは自動的に最も近い範囲を推論します。GetMappings.ps1 PowerShell スクリプトを使用すると、特定のシャード マップの現在のマッピングを取得できます。

-    ソースの分割動作 (分割):分割操作の場合は、ソースの範囲を分割するポイントも定義する必要があります。そのためには、分割操作を行うシャーディング キーを指定します。後続のオプション ボタンを使用して、範囲の前半 (分割キーを除きます) と後半 (分割キーを含みます) どちらを移動するかを定義します。

-    ソース シャードレット (移動): 移動操作は、ソースを示す範囲を必要としない点で、分割操作またはマージ操作とは異なります。移動対象のソースは、移動しようとしているシャーディング キーの値によって識別されます。

-    ターゲット シャード (分割): 分割操作のソースに関する情報を指定した場合は、ターゲットの Azure SQL DB サーバーとデータベース名を指定してデータのコピー先を定義する必要があります。

-    ターゲットの範囲 (マージ): マージ操作は、シャードレットを既存のシャードに移動します。マージする既存の範囲の範囲境界を指定して既存のシャードを識別します。

-    バッチ サイズ: バッチ サイズは、データの移動中に一度にオフライン化されるシャードレットの数を制御します。バッチ サイズは整数値で指定します。シャードレットの長いダウンタイムを避けるには、小さな値を使用します。大きな値を指定すると、特定のシャードレットがオフラインになる時間が長くなりますが、パフォーマンスが向上する場合があります。

-    操作 ID (キャンセル): 実行中の操作が不要になった場合は、対応するフィールドに操作 ID を指定することにより、操作を取り消すことができます。操作 ID は、要求状態テーブル (セクション 8.1 を参照) または要求を送信した Web ブラウザーの出力から取得できます。


## 要件と制限 

Split/Merge サービスの現在の実装には、次の要件と制限が適用されます。

* 現時点で、シャードに対して分割/マージ操作を実行する前に、シャードが存在し、シャード マップに登録されている必要があります。 

* 現時点で、Split/Merge サービスは、操作の一部としてテーブルやその他のデータベース オブジェクトを自動的に作成しません。これは、分割/マージ/移動操作を開始する前に、ターゲット シャード上にすべてのシャード化テーブルと参照テーブルのスキーマが存在している必要があることを意味します。特に、シャード化テーブルは、移動/分割/マージ操作で新しいシャードレットが追加される範囲内で空になっている必要があります。そうでないと、ターゲット シャードでの初期の整合性チェックで不合格になります。また、参照データは参照テーブルが空の場合にのみコピーされる点と、参照テーブルに対する他の同時書き込み操作に関して一貫性が保証されない点にも注意してください。分割/マージ操作を実行したときに、参照テーブルに変更を加える他の書き込み操作がないことを確認することをお勧めします。

* 現在、サービスでは、大きなシャードレットのパフォーマンスと信頼性を向上させるために、シャーディング キーを含む一意のインデックスまたはキーで設定される行 ID に依存しています。これにより、単なるシャーディング キー値よりも細かな粒度でデータを移動できます。その結果、ログ領域と操作中に必要になるロックの量を削減できます。移動/分割/マージ要求でテーブルを使用する場合は、シャーディング キーを含む一意のインデックスまたは主キーをテーブルに作成することを検討してください。パフォーマンス上の理由により、シャーディング キーは、キーまたはインデックスの先頭の列である必要があります。

* 要求の処理の過程で、一部のシャードレット データがソース シャードとターゲット シャードの両方に存在することがあります。これは、シャードレットの移動時にエラーが発生した場合に備えた、現在必要な動作です。既に説明したように、Split/Merge と Elastic Scale シャード マップの統合により、シャード マップ上で **OpenConnectionForKey** メソッドを使用するデータ依存ルーティング API を介した接続において、中間状態の一貫性が失われることはありません。ただし、**OpenConnectionForKey** メソッドを使用せずにソース シャードまたはターゲット シャードに接続するときは、移動/分割/マージ要求の実行中に一貫性のない中間状態が発生する可能性があります。これらの接続では、タイミングや接続の基になるシャードによって、部分的な結果や重複する結果が生成される可能性があります。現在、この制限には、Elastic Scale マルチシャード クエリによって確立される接続が含まれます。

* Split/Merge サービスのメタデータ データベースは、異なるロール間では共有できません。たとえば、ステージング環境で実行されている分割/マージ サービスのロールは、実稼働環境ロールとは異なるメタデータ データベースを指し示す必要があります。
 

## 課金 

Split/Merge サービスは、Microsoft Azure サブスクリプションのクラウド サービスとして実行されます。そのため、クラウド サービスの料金がサービスのインスタンスに適用されます。移動/分割/マージ操作を頻繁に実行する場合を除き、Split/Merge クラウド サービスを削除することをお勧めします。こうすることで、実行中のまたはデプロイされたクラウド サービス インスタンスに対して発生するコストを削減できます。Split/Merge の操作を実行する必要があるときはいつでも簡単に実行可能な構成を再デプロイして開始することができます。
 
## Monitoring 
### 状態テーブル 

Split/Merge サービスでは、完了した要求と実行中の要求を監視するための **RequestStatus** テーブルがメタデータ ストア データベースに用意されています。このテーブルには、この Split/Merge サービスのインスタンスに送信されたそれぞれの Split/Merge 要求データが行として含まれます。それぞれの要求に対して、次の情報が含まれます。

* **タイムスタンプ**: 要求が開始されたときの日付と時刻。

* **OperationId**: 要求を一意に識別する GUID。この要求を使用して、まだ実行中の操作を取り消すこともできます。

* **ステータス**: 要求の現在の状態。実行中の要求に対しては、要求の現在のフェーズも表示されます。

* **CancelRequest**: 要求が取り消されたかどうかを示すフラグ。

* **進行状況**: 推定される操作の進捗状況。値 50 は、操作が約 50% 完了していることを示します。

* **詳細**: 詳細な進捗状況レポートを提供する XML 値。行のセットがソースからターゲットにコピーされるときに、進捗状況レポートが定期的に更新されます。エラーまたは例外が発生した場合、この列にはエラーに関するより詳細な情報も含まれます。


### Azure 診断

Split/Merge サービスは、監視と診断を行うために Azure SDK 2.5 に基づく Azure 診断を使用します。「[Azure のクラウド サービスおよび仮想マシンの診断機能](../cloud-services-dotnet-diagnostics.md)」で説明したように、診断構成を制御します。ダウンロード パッケージには、Web ロール用と worker ロール用の 2 つの診断構成が含まれています。サービスのこれらの診断構成は、「[Microsoft Azure のクラウド サービスの基礎](https://code.msdn.microsoft.com/windowsazure/Cloud-Service-Fundamentals-4ca72649)」のガイダンスに従っています。これには、パフォーマンス カウンター、IIS ログ、Windows イベント ログ、および Split/Merge アプリケーション イベント ログを記録するための定義が含まれます。

## 診断のデプロイ 

NuGet パッケージで提供される Web ロール用とワーカー ロール用の診断構成を使用して、監視と診断を有効にするには、Azure PowerShell を使用して次のコマンドを実行します。

    $storage_name = "<YourAzureStorageAccount>" 
    
    $key = "<YourAzureStorageAccountKey" 
    
    $storageContext = New-AzureStorageContext -StorageAccountName $storage_name -StorageAccountKey $key  
    
    
    $config_path = "<YourFilePath>\SplitMergeWebContent.diagnostics.xml" 
    
    $service_name = "<YourCloudServiceName>" 
    
    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name -Slot Production -Role "SplitMergeWeb" 
    
    
    $config_path = "<YourFilePath>\SplitMergeWorkerContent.diagnostics.xml" 
    
    $service_name = "<YourCloudServiceName>" 
    
    Set-AzureServiceDiagnosticsExtension -StorageContext $storageContext -DiagnosticsConfigurationPath $config_path -ServiceName $service_name -Slot Production -Role "SplitMergeWorker" 

診断設定を構成してデプロイする方法の詳細については、「[Azure のクラウド サービスおよび仮想マシンの診断機能](../cloud-services-dotnet-diagnostics.md)」をご覧ください。

## 診断の取得 

診断には、Visual Studio サーバー エクスプローラーのサーバー エクスプローラー ツリーの Azure の部分から簡単にアクセスできます。Visual Studio インスタンスを開き、メニュー バーで [ビュー]、[サーバー エクスプローラー] の順にクリックします。Azure のアイコンをクリックして Azure サブスクリプションに接続します。次に、Azure、[ストレージ]、[<your storage account>]、[テーブル]、[WADLogsTable] の順に移動します。詳細については、「[サーバー エクスプローラーを使用したストレージ リソースの参照](http://msdn.microsoft.com/library/azure/ff683677.aspx)」をご覧ください。

![WADLogsTable][2]

上の図で強調表示されている WADLogsTable には、Split/Merge サービスのアプリケーション ログからの詳細なイベントが含まれています。ダウンロードしたパッケージの既定の構成は、運用環境のデプロイを対象にしていることに注意してください。そのため、サービス インスタンスからログおよびカウンターが取得される間隔が長くなっています (5 分)。テストと開発用には、Web ロールまたは worker ロールの診断設定をニーズに合わせて調整して、間隔を短くすることができます。Visual Studio サーバー エクスプローラー (上図参照) でロールを右クリックし、[診断構成] ダイアログ ボックスで、[転送間隔] の値を調整します。

![構成][3]


## パフォーマンス

一般に、Azure SQL Database の上位のより高パフォーマンスのサービス階層ほど、より高いパフォーマンスを期待できます。上位のサービス階層で提供されるより優れた IO、CPU、およびメモリ割り当ては、Split/Merge サービスが使用する一括コピーおよび削除操作に役立ちます。そのため、定義された一定期間のデータベースに対してのみサービス階層を増やします。

サービスでは、検証クエリが通常の操作の一部としても実行されます。検証クエリは、ターゲット範囲に想定外のデータが存在していないことを確認して、すべての分割/マージ/移動操作が一貫性のある状態で開始されることを保証します。これらのクエリは、操作のスコープと要求の定義の一部として提供されたバッチ サイズによって定義されたシャーディング キー範囲に作用します。これらのクエリは、先頭の列にシャーディング キーを含むインデックスがあるときに最高のパフォーマンスを発揮します。

さらに、先頭の列にシャーディング キーを含む一意性プロパティにより、サービスは、ログ領域とメモリに関してリソースの消費を制限する最適化されたアプローチを使用できます。(一般的に 1 GB 以上の) 大きなサイズのデータを移動するには、この一意性プロパティが必要です。

## ベスト プラクティスとトラブルシューティング 
-    テスト テナントを定義し、複数のシャードにまたがるテスト テナントで最も重要な分割/マージ/移動操作を実行します。すべてのメタデータが適切にシャード マップ内に定義され、操作が制約または外部キーに違反しないことを確認できます。
-    データ サイズに関連する問題が発生するのを防ぐには、テスト テナントのデータのサイズを、最大のテナントの最大データ サイズよりも大きく保ちます。これは、1 つのテナントの移動にかかる時間の上限を評価する場合にも役立ちます。 
-    スキーマで削除が許可されることを確認します。Split/Merge サービスを使用するには、データがターゲットに正常にコピーされた後でソース シャードからデータを削除できる必要があります。たとえば、**トリガーを削除する**と、サービスがソースのデータを削除できなくなり、操作が失敗することがあります。
-    シャーディング キーが主キーまたは一意のインデックスの定義の先頭の列であることを確認します。これにより、分割/マージ検証クエリと、シャーディング キー範囲に常に作用する実際のデータの移動と削除操作の最善のパフォーマンスが保証されます。
-    データベースが配置されているリージョンとデータ センターに分割/マージ サービスを併置します。 

[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

## 参照 

* [Split-Merge のチュートリアル](sql-database-elastic-scale-configure-deploy-split-and-merge.md)

* [Elastic Scale のセキュリティの構成](sql-database-elastic-scale-split-merge-security-configuration.md)


<!--Anchors-->
<!--Image references-->
[1]: ./media/sql-database-elastic-scale-overview-split-and-merge/split-merge-overview.png
[2]: ./media/sql-database-elastic-scale-overview-split-and-merge/diagnostics.png
[3]: ./media/sql-database-elastic-scale-overview-split-and-merge/diagnostics-config.png
 

<!---HONumber=July15_HO4-->