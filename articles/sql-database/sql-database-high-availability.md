---
title: 高可用性 - Azure SQL Database サービス | Microsoft Docs
description: Microsoft Azure SQL Database サービスの高可用性機能および特色について説明します。
services: sql-database
author: anosov1960
manager: craigg
ms.service: sql-database
ms.topic: conceptual
ms.date: 04/24/2018
ms.author: sashan
ms.reviewer: carlrab
ms.openlocfilehash: 27f0c49913b424a6bd77b7cb6f7d6e97598c2157
ms.sourcegitcommit: 944d16bc74de29fb2643b0576a20cbd7e437cef2
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 06/07/2018
ms.locfileid: "34839811"
---
# <a name="high-availability-and-azure-sql-database"></a>高可用性と Microsoft Azure SQL Database
マイクロソフトは、Azure SQL Database PaaS サービスの開発当初から、お客様が操作したり、特別なロジックを追加したり、高可用性に関する意思決定をしなくても実現できる高可用性 (HA) をサービスに組み込むことをお約束してきました。 マイクロソフトは、お客様に SLA を提供し、HA システム構成および運用を完全に制御します。 HA SLA は、領域内の SQL データベースに適用され、マイクロソフトの妥当な制御の及ばない事象 (自然災害、戦争、テロ行為、暴動、政府の行為、または、お客様の施設、またはお客様の施設とマイクロソフトのデータ センターの間を含む、マイクロソフトのデータ センター外のネットワークまたはデバイスの障害など) に起因する、領域全体の障害の場合の保護は提供できません。

HA の問題領域を簡略化するため、マイクロソフトは、次の事項を前提条件とします。
1.  ハードウェアおよびソフトウェアの障害は不可避である
2.  障害につながるミスを運用スタッフが犯すことがある
3.  計画的な保守作業によって障害が発生する 

このような事象は頻繁に起こるものではありませんが、クラウド規模では、毎日ではないにしても、週に 1 回は発生する可能性があります。 

## <a name="fault-tolerant-sql-databases"></a>フォールト トレラントの SQL データベース
お客様にとって重要なのは、お客様が使用するデータベースの回復性であり、SQL Database サービス全体の回復性ではありません。 たとえサービスのアップタイムが 99.99% であろうと、0.01% のダウンしているデータベースにお客様のデータベースが含まれていたら、何の意味もありません。 データベース 1 つ 1 つがそれぞれフォールト トレラントである必要があり、フォールト対策によって、コミットされたトランザクションが失われることがあってはなりません。 

Microsoft Azure SQL Database では、直結されたディスク/VHD を使用するローカル ストレージ (LS) と、Azure Premium Storage ページ blob を使用するリモート ストレージ (RS) の両方を使用します。 
- ローカル ストレージは、IOPS の要件の高いミッション クリティカル OLTP アプリケーション用に設計された Premium または Business Critical (プレビュー) データベースとエラスティック プールで使用されます。 
- リモート ストレージは、ストレージとコンピューティング能力が独立して拡張できる必要がある、予算重視のビジネス ワークロード向けに設計された、Basic、Standard、および General Purpose サービス レベルで使用されます。 データベースおよびログ ファイル用の単一のページ blob と、組込みストレージ レプリケーションおよびフェイルオーバー メカニズムが使用されます。

いずれの場合も、Microsoft Azure SQL Database のレプリケーション、障害検知、およびフェイルオーバー メカニズムは完全に自動化されており、ユーザーが介入しなくても運用できます。 このアーキテクチャの目的は、コミットされたデータを絶対に損失しないことと、データの持続性を最優先することです。

主な利点:
- お客様は、複雑なハードウェア、ソフトウェア、オペレーティング システムまたは仮想化環境を設定したり管理することなく、レプリケートされたデータベースを最大限に活用できます。
- リレーショナル データベースの ACID プロパティは、すべてシステムが管理します。
- フェールオーバーは完全に自動化されており、コミットされたデータの損失は発生しません。
- プライマリ レプリカへの接続のルーティングは、サービスによって動的に管理されるため、アプリケーション ロジックは必要ありません。
- 追加料金なしで、自動化された高度の冗長性が提供されます。

> [!NOTE]
> 説明されている高可用性アーキテクチャは、予告なしに変更される場合があります。 

## <a name="data-redundancy"></a>データの冗長性

SQL Database の高可用性ソリューションは、SQL Server の [Always ON 可用性グループ](/sql/database-engine/availability-groups/windows/overview-of-always-on-availability-groups-sql-server) テクノロジを使用し、LS データベースと RS データベースの違いが最小限に抑えられているため、いずれのデータベースでも動作します。 Always ON 可用性グループ テクノロジは、LS 構成では永続化のために使用され、RS では可用性 (アクティブ geo レプリケーションによる低 RTO) のために使用されます。 

## <a name="local-storage-configuration"></a>ローカル ストレージの構成

この構成では、各データベースは、制御リング内の管理サービス (MS) によってオンラインになります。 1 つのプライマリ レプリカと 2 つ以上のセカンダリ レプリカ (クォーラム セット) は、同じデータ センター内の 3 つの独立した物理サブシステムにまたがるテナント リング内に存在します。 すべて読み取りおよび書き込み操作は、プライマリ レプリカへのゲートウェイ (GW) によって送信され、書き込み操作はセカンダリ レプリカに非同期的にレプリケートされます。 Microsoft Azure SQL Database は、トランザクションがコミットされる前に、データがプライマリ レプリカと 1 つ以上のセカンダリ レプリカに書き込まれる、クォーラム ベースのコミット スキームを使用します。

ノードで障害が発生すると、[Service Fabric](../service-fabric/service-fabric-overview.md) フェールオーバー システムは自動的にレプリカを再構築し、ノードが離れシステムに加わる間、クォーラム セットのメンバーシップを保持します。 計画的なメンテナンスは、クォーラム セットがレプリカ最小数 (通常、2) を下回らないよう慎重に調整されます。 このモデルは Premium および Business Critical (プレビュー) データベースに適していますが、コンピューティングとストレージの両方のコンポーネントで冗長性を必要とするため、コストが高くなります。

## <a name="remote-storage-configuration"></a>リモート ストレージの構成

リモート ストレージの構成 (Basic、Standard、または General Purpose レベル) の場合、リモート blob ストレージにコピーが 1 つのみ保持され、ストレージ システムが提供する、持続性、冗長性、およびビット崩壊検出機能を活用できます。 

高可用性アーキテクチャを、次の図に示します。
 
![高可用性アーキテクチャ](./media/sql-database-high-availability/high-availability-architecture.png)

## <a name="failure-detection-and-recovery"></a>障害の検出と回復 
大規模な分散システムでは、障害を確実にすばやく、そしてお客様にできるだけ近い箇所で検出できる、高信頼性の障害検出システムが必要です。 Microsoft Azure SQL Database の場合、このシステムは Azure Service Fabric を使用します。 

プライマリ レプリカを使用すると、すべての読み取りよび書き込み操作がまずプライマリ レプリカ上で行われるため、プライマリ レプリカで障害が発生し、作業が継続できない場合は、障害が起こったことと、いつ発生したかが、すぐに明らかになります。 セカンダリ レプリカをプライマリ ステータスに昇格させるこのプロセスには、目標復旧時間 (RTO) = 30 秒と目標復旧時点 (RPO) = 0 を使用します。 30 秒 RTO の影響を軽減するベスト プラクティスは、待機時間を短くして再接続の試行を続けることです。

セカンダリ レプリカで障害が発生した場合、データベースのクォーラム セットは最低限まで下がり、スペアがなくなります。 サービス ファブリックは、プライマリ レプリカで障害が発生した場合と類似した再構成プロセスを開始し、障害が恒久的なものかどうか判断するために待機した後、セカンダリ レプリカを作成します。 オペレーティング システムの障害やアップグレードなどの一時的なサービス停止の場合、新しいレプリカはすぐには構築されず、停止したノードが再起動されます。 

リモート ストレージ構成の場合は、Microsoft Azure SQL Database は、アップグレード中にフェールオーバー データベースに対し AlwaysON 機能を使用します。 このために、計画的なアップグレード イベントの一部として新しい SQL インスタンスが事前に派生され、リモート ストレージからデータベース ファイルを回復し添付します。 プロセスがクラッシュまたは計画外のその他のイベントが発生した場合、Windows Fabric は、回復の最後の手順としてインスタンスの可用性を管理し、リモート データベース ファイルを添付します。

## <a name="zone-redundant-configuration-preview"></a>ゾーン冗長の構成 (プレビュー)

既定では、ローカル ストレージ構成のクォーラムセット レプリカが同じデータセンターに作成されます。 [Azure 可用性ゾーン](../availability-zones/az-overview.md)の導入により、同じリージョンのさまざまな可用性ゾーンに対するさまざまなレプリカをクォーラムセットに配置することができます。 単一障害点をなくすため、制御リングも複数のゾーンで 3 つのゲートウェイ リング (GW) として複製できます。 特定のゲートウェイ リングへのルーティングは [Azure Traffic Manager](../traffic-manager/traffic-manager-overview.md) (ATM) によって制御されます。 ゾーン冗長構成ではデータベースの冗長性は追加されないため、Premium または Business Critical (プレビュー) サービス レベルの可用性ゾーンを追加費用なしで利用できます。 ゾーン冗長データベースを選択することで、アプリケーション ロジックをまったく変更せずに、データセンターの壊滅的な障害を含む大規模な障害から Premium または Business Critical (プレビュー) データベースが回復できるようになります。 また、既存の Premium または Business Critical (プレビュー) データベース、あるいはプール (プレビュー) をゾーン冗長構成に変換することもできます。

ゾーン冗長クォーラムセットは、離れた距離に位置するさまざまなデータセンターにレプリカがあるため、ネットワーク待機時間が長くなるとコミット時間が延長され、一部の OLTP ワークロードのパフォーマンスに影響する可能性があります。 いつでもゾーン冗長設定を無効にして単一ゾーン構成に戻ることができます。 このプロセスはデータ操作のサイズであり、通常のサービス レベル目標 (SLO) 更新プログラムと似ています。 プロセスの最後に、データベースまたはプールがゾーン冗長リングから単一ゾーン リングに (または逆方向に) 移行されます。

> [!IMPORTANT]
> ゾーン冗長データベースとエラスティック プールは、現時点では Premium サービス レベルでのみサポートされています。 パブリック プレビューでは、バックアップおよび監査レコードは RA-GRS ストレージに格納され、ゾーン全体の障害時に自動的に利用できない可能性があります。 

ゾーン冗長による高可用性アーキテクチャを、次の図に示します。
 
![高可用性アーキテクチャのゾーン冗長](./media/sql-database-high-availability/high-availability-architecture-zone-redundant.png)

## <a name="read-scale-out"></a>読み取りスケールアウト
これまで説明してきたように、Premium および Business Critical (プレビュー) サービス レベルでは、単一ゾーンおよびゾーン冗長の両方の構成でクォーラムセットおよび高可用性のための AlwaysON テクノロジを活用します。 AlwasyON の利点の 1 つは、レプリカが常に、トランザクション一貫性の保たれた状態になることです。 レプリカがプライマリと同じパフォーマンス レベルを備えているため、アプリケーションでは、追加料金なしで読み取り専用ワークロードを提供する追加容量 (読み取りスケールアウト) を利用できます。 これにより、読み取り専用クエリは、メインの読み取り/書き込みワークロードから分離され、パフォーマンスに影響を及ぼすことはありません。 読み取りスケールアウト機能は、分析などの論理的に分離された読み取り専用ワークロードを含むアプリケーションを対象としています。そのため、プライマリに接続することなくこの追加容量を活用できます。 

特定のデータベースで読み取りスケールアウト機能を使用するには、データベースを作成するときに明示的に有効にするか、PowerShell を使用して [Set-AzureRmSqlDatabase](/powershell/module/azurerm.sql/set-azurermsqldatabase) または [New-AzureRmSqlDatabase](/powershell/module/azurerm.sql/new-azurermsqldatabase) コマンドレットを呼び出すか、Azure Resource Manager REST API から[データベース - 作成または更新](/rest/api/sql/databases/createorupdate)メソッドを使用して構成を変更し、後から明示的に有効にする必要があります。

データベースの読み取りスケールアウトが有効になると、そのデータベースに接続するアプリケーションが、アプリケーションの接続文字列で構成されている `ApplicationIntent` プロパティに応じて、データベースの読み取り/書き込みレプリカまたは読み取り専用レプリカにリダイレクトされます。 `ApplicationIntent` プロパティの詳細については、「[アプリケーションの目的を指定する](https://docs.microsoft.com/sql/relational-databases/native-client/features/sql-server-native-client-support-for-high-availability-disaster-recovery#specifying-application-intent)」を参照してください。 

読み取りスケールアウトが無効の場合またはサポートされていないサービス レベルで ReadScale プロパティを設定した場合、`ApplicationIntent` プロパティとは関係なく、すべての接続が読み取り/書き込みレプリカにリダイレクトされます。  

> [!NOTE]
> 読み取り専用のセッションを別のレプリカにルーティングしない場合でも、Standard または General Purpose データベースで読み取りスケールアウトを有効にすることができます。 この処理の目的は、Standard/General Purpose および Premium/Business Critical レベル間でスケールアップおよびスケールダウンする既存のアプリケーションをサポートするためです。  

読み取りスケールアウト機能は、セッション レベルの一貫性をサポートしています。 レプリカが使用できないことが原因で接続エラーが発生した後に読み取り専用セッションが再接続された場合、別のレプリカにリダイレクトされる可能性があります。 まれに、古いデータ セットを処理してしまう場合があります。 また、アプリケーションが読み取り/書き込みセッションを使用してデータを書き込み、読み取り専用セッションを使用してすぐに読み取る場合、最新データがすぐに表示されない可能性があります。

## <a name="conclusion"></a>まとめ
Azure SQL Database は、Azure プラットフォームと緊密に統合されており、障害の検出と復旧に Service Fabric を、データ保護に Azure Storage Blob を、フォールト トレランスを高めるために可用性ゾーンを活用します。 同時に、Azure SQL データベースは、レプリケーションとフェールオーバーのための SQL Server 既成製品からの AlwaysOn テクノロジを全面的に使用します。 これらのテクノロジを組み合わせることにより、アプリケーションは混合ストレージ モデルを最大限に活用して、高要件の SLA にも対応できます。 

## <a name="next-steps"></a>次の手順

- [Azure 可用性ゾーン](../availability-zones/az-overview.md)の詳細
- [Service Fabric](../service-fabric/service-fabric-overview.md) の詳細
- [Azure Traffic Manager](../traffic-manager/traffic-manager-overview.md) の詳細 
