<properties
   pageTitle="Azure SQL Database のクエリ ストアの動作"
   description="Azure SQL Database でクエリ ストアがどのように動作するかについて説明します"
   keywords=""
   services="sql-database"
   documentationCenter=""
   authors="carlrabeler"
   manager="jhubbard"
   editor=""/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="performance"
   ms.workload="data-management"
   ms.date="05/25/2016"
   ms.author="carlrab"/>

# Azure SQL Database のクエリ ストアの動作 

Azure のクエリ ストアは、すべてのクエリに関する詳細な履歴情報を継続的に収集して提示する、完全に管理されたデータベース機能です。クエリ ストアは、航空機のフライト データ レコーダーに似ていると考えることができます。この機能によって、クラウドとオンプレミスのユーザーの両方が、クエリ パフォーマンスのトラブルシューティングを大幅に簡素化できます。この記事では、Azure でのクエリ ストアの動作の特定の側面について説明します。ユーザーは、この事前収集されたクエリ データを使用してパフォーマンスの問題をすばやく診断して解決することで、業務に向ける時間を増やすことができます。

クエリ ストアは、2015 年 11 月以降、Azure SQL Database で[グローバルに使用できる](https://azure.microsoft.com/updates/general-availability-azure-sql-database-query-store/)ようになっています。クエリ ストアは、[SQL Database Advisor やパフォーマンス ダッシュボード](https://azure.microsoft.com/updates/sqldatabaseadvisorga/)などのパフォーマンス分析とチューニング機能の基盤です。この記事の発行時点で、クエリ ストアは、Azure の 200,000 台を超えるユーザー データベースで実行され、クエリに関連する情報を、数か月にわたって中断することなく収集し続けています。

> [AZURE.IMPORTANT] マイクロソフトでは、すべての Azure SQL Database (既存と新規) でクエリ ストアをアクティブ化するプロセスを続けています。現在、このアクティブ化プロセスにはシングルトン データベースのみが含まれていますが、近い将来、エラスティック プール データベースも対象となる予定です。エラスティック プールを使用している場合、クエリ ストアは、データベースの小さなサブセットに対してのみ有効にしてください。エラスティック プール内のすべてのデータベースでクエリ ストアを有効にすると、リソースが過剰に使用され、システムが応答しなくなる可能性があります。

## Azure SQL Database 内の管理された機能としてのクエリ ストア

Azure SQL Database 内のクエリ ストアは、次の 2 つの基本原則に基づいて動作しています。

- ユーザーのワークロードに目に見える影響を与えない
- ユーザーのワークロードが影響を受けない限り、クエリを継続的に監視する

ユーザーのワークロードに与える影響には、次の 2 つの側面があります。

- ***可用性***: クエリ ストアが実行されているときに SQL Database の SLA が低下することはありません。
- ***パフォーマンス***: クエリ ストアによって発生する平均オーバーヘッドは、通常は 1 ～ 2% の範囲です。

Azure のクエリ ストアは、制限されたリソース (CPU、メモリ、ディスク I/O、ディスク サイズなど) を使用して動作します。通常のワークロードに与える影響を最小限に抑えるために、さまざまなシステムの制限に従います。一般に、クエリ ストアは、次の 2 つのリソース制限に従います。

- ***静的な制限***。特定のサービス層 (Basic、Standard、Premium、エラスティック プール) のリソース容量による制限。
- ***動的な制限:*** 現在のワークロードの消費による制限 (使用可能なリソースの制限)。

継続的な信頼できる動作を保証するため、Azure SQL Database は、クエリ ストアを中心とする永続的な監視インフラストラクチャを構築して、すべてのデータベースから重要な運用データを収集します。その結果、信頼性を確保するために、さまざまな技術的 KPI が常に監視されます。

- 例外と自動移行の数
- READ\_ONLY 状態にあるデータベースの数と READ\_ONLY 状態の持続時間
- 自動クリーンアップの頻度と持続時間による上位データベース
- データをメモリに読み込むためにかかる時間 (初期化時) による上位データベース
- データをディスクにフラッシュするためにかかる時間による上位データベース

Azure SQL Database は、収集されたデータを使用して、次の操作を行います。

- ***クエリ ストアによって発生している問題を解決するか軽減する:*** Azure SQL Database は、ユーザーのワークロードに大きな影響を与えている問題を、短時間 (1 時間未満) で検出して軽減できます。ほとんどの場合、問題は、クエリ ストアを一時的に ***OFF*** にすることで処理されます。
- ***多数のデータベースの使用パターンを学習して、機能の信頼性と品質を向上させる:*** クエリ ストアは、Azure SQL Database の毎回の更新によってその機能が向上します。 

クエリ ストアの更新によって、内部構成に適用される既定値が変更される場合があります (ユーザー向けの外部構成でも同じことが起こることがありますが、それはめったに発生しません)。その結果、クエリ ストア プラットフォームで実行される自動操作によって、Azure SQL Database でのクエリ ストアのカスタマー エクスペリエンスがオンプレミス環境とは違ってくる可能性があります。

- クエリ ストアの状態は、問題を軽減するために ***OFF*** に変更され、問題が解決されたときに再び ***ON*** に戻される可能性があります。
- クエリ ストアの構成は、信頼できる動作が保証されるように変更される可能性があります。これは、次のように実行される可能性があります。
    - 不安定または信頼性の問題に対処するための個々のデータベースの変更。
    - クエリ ストアを使用するすべてのデータベースにメリットを提供する、最適構成の変更のグローバルなロールアウト。

クエリ ストアの状態を ***OFF*** に変更する操作は、個々のデータベースを対象とする自動的な操作です。これは、検出メカニズムによってアラートが発行される、ユーザー データベースに悪影響がある製品の動作が存在する場合に発生します。その特定のデータベースに対して、クエリ ストアは、改善されたクエリ ストアの実装が使用可能になるまで、***OFF*** 状態を維持します。***OFF*** 状態への切り替えが発生すると、電子メールでユーザーに通知が行われ、新しいバージョンがロールアウトされるまでクエリ ストアを再び有効にしないようにアドバイスされます。新しいバージョンがロールアウトされた後、Azure SQL Database インフラストラクチャは、データベースの ***OFF*** に設定されていたクエリ ストアを自動的にアクティブにします。

まれに、Azure SQL Database は、信頼できる動作と継続的なデータ収集を実現するように最適化された新しい構成の既定値をすべてのユーザー データベースに強制的に適用することがあります。

## クエリ ストアの最適構成

このセクションでは、クエリ ストアと、[SQL Database Advisor やパフォーマンス ダッシュボード](https://azure.microsoft.com/updates/sqldatabaseadvisorga/)などの依存機能の信頼できる動作を保証するように設計された、最適構成の既定値について説明します。既定の構成は、データ収集が継続的に実施される (OFF/READ\_ONLY 状態の時間が最小限になる) ように最適化されています。

| 構成 | 説明 | 既定値 | コメント |
| ------------- | ----------- | ------- | ------- |
| MAX\_STORAGE\_SIZE\_MB | クエリ ストアがユーザーのデータベース内で使用するデータ領域の制限を指定します。 | 100 | 新しいデータベースに適用 |
| INTERVAL\_LENGTH\_MINUTES | クエリ プランで収集されたランタイム統計が集計されて保存される間隔を定義します。すべてのアクティブなクエリ プランには、この構成で定義された期間の行が最大で 1 行含まれます。 | 60 | 新しいデータベースに適用 |
| STALE\_QUERY\_THRESHOLD\_DAYS | 保存されたランタイム統計と非アクティブなクエリのリテンション期間を制御する、時間に基づくクリーンアップ ポリシー | 30 | 新しいデータベースと前の既定値 (367) を持つデータベースに適用 |
| SIZE\_BASED\_CLEANUP\_MODE | クエリ ストアのデータ サイズが制限値に近づいたときに、データの自動クリーンアップが発生するかどうかを指定します | AUTO | すべてのデータベースに適用 |
| QUERY\_CAPTURE\_MODE | すべてのクエリを追跡するか、クエリのサブセットのみを追跡するかを指定します | AUTO | すべてのデータベースに適用 |
| FLUSH\_INTERVAL\_SECONDS | キャプチャされたランタイム統計がディスクにフラッシュされる前に、メモリ内に保持される最大期間を指定します | 900 | 新しいデータベースに適用 |
||||||

上記の既定値は、すべての Azure SQL Database でのクエリ ストアのアクティブ化の最終段階で自動的に適用されます。アクティブ化された後、ユーザーによって設定された構成値は、主要なワークロードまたはクエリ ストアの信頼できる動作に悪影響を与えない限り、Azure SQL Database によって変更されることはありません。

カスタム設定を維持する場合は、[ALTER DATABASE とクエリ ストア オプション](https://msdn.microsoft.com/library/bb522682.aspx)を使用して、構成を前の状態に戻します。「[Best Practices with the Query Store](https://msdn.microsoft.com/library/mt604821.aspx)」(クエリ ストアのベスト プラクティス) で、よく選ばれている最適構成のパラメーターを確認してください。

## 次のステップ

[SQL Database Performance Insight](sql-database-performance.md)

## 詳細情報

詳細については、次の記事を参照してください。

- [データベースのためのフライト データ レコーダー](https://azure.microsoft.com/blog/query-store-a-flight-data-recorder-for-your-database) 

- [クエリ ストアの使用シナリオ](https://msdn.microsoft.com/library/mt614796.aspx)

- [クエリ ストアを使用したパフォーマンスの監視](https://msdn.microsoft.com/library/dn817826.aspx)

<!---HONumber=AcomDC_0525_2016-->