<properties
   pageTitle="Azure SQL Database を使用するマルチテナント SaaS アプリケーションの設計パターン | Microsoft Azure" 
   description="この記事では、クラウド環境で実行されるマルチテナント SaaS (サービスとしてのソフトウェア) のデータベース アプリケーションで考慮する必要がある要件、一般的なデータ アーキテクチャ パターン、およびこれらのパターンに関連するさまざまなトレードオフについて説明します。さらに、エラスティック データベース プールとエラスティック ツールを備えた Azure SQL Database サービスを使用して、妥協のない方法でこれらの要件に対応する方法についても説明します。"
   keywords=""
   services="sql-database"
   documentationCenter=""
   authors="carlrabeler"
   manager="jhubbard"
   editor=""/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="sqldb-design"
   ms.date="06/07/2016"
   ms.author="carlrab"/>

# Azure SQL Database を使用するマルチテナント SaaS アプリケーションの設計パターン

この記事では、クラウド環境で実行されるマルチテナント SaaS (サービスとしてのソフトウェア) のデータベース アプリケーションで考慮する必要がある要件、一般的なデータ アーキテクチャ パターン、これらのパターンに関連するさまざまなトレードオフについて説明します。さらに、エラスティック データベース プールとエラスティック ツールを備えた Azure SQL Database サービスを使用して、妥協のない方法でこれらの要件に対応する方法についても説明します。

## はじめに

過去数年間の SaaS アプリケーション プロバイダーとの経験から私たちが気付いたことは、開発者は、テナント アプリケーションのデータ層のテナント モデルを設計するときに、最善の長期的な利益に反する選択を行うことがしばしばあるということです。少なくとも初期の段階では、開発の容易さとクラウド プロバイダーにかかるコストの低さのほうが、テナントの分離やアプリケーションの拡張性よりも重要と考えられています。これは、多くの場合、顧客満足度の問題を引き起こし、後の時点で軌道修正するためのコストの発生に至ります。

この記事の文脈では、マルチテナント アプリケーションとは、クラウド環境でホストされるアプリケーションであり、データの共有や相互のデータ認識を行わない複数の (数百または数千の) テナントに同じサービスを提供するアプリケーションのことです。このようなサービスの典型的なカテゴリは、クラウド ホスト環境でテナントにサービスを提供する SaaS アプリケーションです。

## マルチテナント アプリケーション

マルチテナント アプリケーションは、データとワークロードを簡単に分割することができる種類のアプリケーションの顕著な例です。たとえば、マルチテナント アプリケーションでは、ほとんどの要求はテナントの境界内で行われるため、データとワークロードは、通常はテナント境界に沿ってパーティション分割できます。このプロパティはデータとワークロードに固有であり、この記事の残りの部分で説明するアプリケーション パターンでは、このプロパティを優先的に考慮しています。

このようなアプリケーションは、クラウド ベースのアプリケーションの全領域に広がっており、その中には、
- SaaS アプリケーションとしてクラウドに移行される ISV データベース アプリケーション、
- 初めからクラウド用に構築された SaaS アプリケーション、
- コンシューマー/エンドユーザーが直接使用するアプリケーション、 
- 従業員が使用するエンタープライズ アプリケーションが含まれていることがわかっています。

クラウド生まれの SaaS アプリケーションと ISV をルーツとする SaaS アプリケーションは、どちらも、通常はマルチテナント アプリケーションになります。これらの SaaS アプリケーションは、特化されたソフトウェア アプリケーションをサービスとしてテナントに提供します。テナントは、このアプリケーション サービスへのアクセス権と、アプリケーションの一部として保存される関連データの完全な所有権を所有します。ただし、SaaS のメリットを活用するためには、テナントは、SaaS ベンダーがデータのセキュリティによる保護と他のテナントのデータからの分離を行うことを信頼して、各自のデータに対する一定レベルの制御を SaaS ベンダーに委ねる必要があります。典型的な例として、MyOB、SnelStart、Salesforce などがあります。これらのアプリケーションは、どれもテナント境界に沿ってパーティション分割が可能であるため、この記事の以降のセクションで説明するアプリケーション パターンをサポートします。

顧客または組織内の従業員 (多くの場合、テナントではなくユーザーと呼ばれます) に直接サービスを提供するアプリケーションは、マルチテナント アプリケーションの別のカテゴリを形成します。顧客は、サービスをサブスクライブし、サービス プロバイダーが収集して保存しているデータを所有しません。サービス プロバイダーが顧客のデータを相互に分離された状態を維持するための要件は、プライバシー保護が必須である政府以外は、それほど厳しくありません。典型的な例として、Netflix、Spotify、Xbox live などのメディア コンテンツ プロバイダーがあります。簡単にパーティション分割できるアプリケーションのその他の例は、顧客が直接使用するインターネット規模のアプリケーションや IoT (モノのインターネット) アプリケーションで見つかります。これらのアプリケーションでは、各顧客またはデバイスがパーティション分割の対象となり、異なるユーザーまたはデバイスの間にパーティション境界を設定できます。

ただし、私たちは、すべてのアプリケーションがテナント、顧客、ユーザー、デバイスなどの単一のプロパティに沿って簡単にパーティション分割できるわけではないことも認識しています。たとえば、製品、注文、顧客を管理する複雑な ERP (エンタープライズ リソース プランニング) アプリケーションを考えてみます。通常、そのようなアプリケーションには、高度に相互接続された数千のテーブルを持つ複雑なスキーマがあります。すべてのテーブルとワークロード全体に関係する作業に単一のパーティション分割戦略が適用されることはありません。そのため、この記事の残りの部分では、そのようなアプリケーションは説明の対象から明確に除外しています。

以下のセクションで検討するマルチテナント設計パターンは、前述したデータとワークロードを簡単にパーティション分割できるすべてのアプリケーションに適用されます。ただし、説明を簡単にするために、そのようなアプリケーションを単にマルチテナント SaaS アプリケーションと呼びます。

## マルチテナント アプリケーションの設計上のトレードオフ

クラウドでマルチテナント アプリケーションを構築する開発者には、次の包括的な特質があります。

-	***テナントの分離***: 開発者は、テナントが他のテナントのデータに不要なアクセスを行わないことを保証する必要があります。この分離要件は、ノイジー ネイバー対策、特定のテナントのデータを復元する能力、テナント固有のカスタマイズなどの他のプロパティまで拡張されます。 
-	***クラウドのリソース コスト***: SaaS アプリケーションは、コスト面での競争力を持つ必要があります。これに基づき、SaaS アプリケーションの開発者は、マルチテナント アプリケーションを設計するときに、クラウド リソースの使用 (Compute、Storage など) によるコストを下げるための最適化を行います。
-	***開発運用の容易さ***: マルチテナント アプリケーション プロバイダーは、分離保護の構築、アプリケーションとデータベース スキーマの管理、状態の監視、およびテナントで発生した問題のトラブルシューティングを行う必要があります。アプリケーションの開発と運用の複雑さは、コストの追加とテナントの満足度の低下に直結します。
-	***スケーラビリティ***: テナントを徐々に増やしていくことは、多くのリソースが必要な個々のテナントに容量を追加することと同じように、SaaS の運用を成功させるための最重要事項です。

これらの特質の間にはトレードオフがあります。コストが最も低いクラウド製品が最も開発しやすいとは限りません。私たちは、開発者が、上記の 4 つの特質によって識別された領域に関して、情報が不十分なままで選択を行っていることをしばしば見ています。

他の企業に提供される SaaS マルチテナント アプリケーションにとって、テナントの分離は、多くの場合、基本要件です。開発者が、テナントの分離とスケーラビリティの単純さとコスト面でのメリットに反応する傾向があることがしばしば見受けられます。このトレードオフは、サービスが成長してテナント分離要件の重要性が増加してアプリケーション層での処理が必要になったときに、複雑かつ高価であることが証明される可能性があります。

エンド ユーザーに直接サービスを提供するマルチテナント アプリケーションでは、テナントの分離は、クラウド リソースのコストを最適化することよりも優先順位が低くなる可能性があります。

一般的な開発パターンは、複数のテナントを 1 つまたは少数のデータベースにまとめることです。このアプローチのメリット (と思われるもの) は、少数のデータベースのみの料金を支払うことによる低いコストと、対象が少数のデータベースのみであることによる作業の単純化です。SaaS マルチテナント アプリケーションでは、このような意思決定には、時間の経過と共に、テナントの分離とスケーラビリティの点で大きな不都合が出現します。テナントの分離が必要になった場合、共有記憶域内のテナント データを不正アクセスやノイジー ネイバーから保護するために労力を費やす必要が生じ、アプリケーションの開発にかかる労力と分離を管理するためにかかるコストを大幅に増加させる可能性があります。同様に、新しいテナントを追加する場合、アプリケーションのデータ層を適切にスケーリングするには、通常は、テナント データをデータベース間に再分配するための開発に関する専門知識が必要です。

## マルチテナント データ モデル 

テナントのデータを配置するための一般的な設計のベスト プラクティスは、次の 3 つの異なるモデルに従います。


  ![マルチテナント データ モデル](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-multi-tenant-data-models.png)図 1: マルチテナント データ モデルの一般的な設計プラクティス
  
1.	***テナント単位のデータベース***: このアプローチでは、各テナントをそれぞれの専用データベースに配置します。テナント固有のデータは、すべてが専用データベース内に配置され、他のテナントとデータから分離されます。
2.	***共有データベース (シャーディング)***: このアプローチでは、複数のデータベースを使用し、1 つのデータベースを複数のテナントが共有します。つまり、テナントの個別のセットが、ハッシュ、範囲、リストなどのパーティション分割戦略を使用して、各データベースに割り当てられます。このデータ配分戦略は、しばしばシャーディングと呼ばれます。
3.	***共有データベース (単一)***: このアプローチでは、大規模になる可能性がある単一のデータベースを使用して、すべてのテナントのデータを格納し、テナント ID 列によってテナントを区別します。 
  
> [AZURE.NOTE] 場合によっては、複数のテナントが複数のデータベース スキーマで配置され、各テナントはスキーマ名を使用して区別されます。このアプローチでは、通常は、動的 SQL を使用する必要があり、プランのキャッシュを効果的に利用できないため、推奨される方法ではありません。このため、この記事の残りの部分では、このカテゴリの共有テーブルを使用するアプローチを中心に説明します。
 
## 一般的なマルチテナント データ モデルの特徴

ここで説明するマルチテナント データ モデルの使用を評価するとき、重要なのは、前のセクションで説明したアプリケーションの設計上のトレードオフの観点を考慮することです。

-	***分離***: データ モデルが達成するテナントの分離の程度を示すメジャーとしてのテナント間の分離の度合い。
-	***クラウド リソースのコスト***: クラウド リソースのコストを最適化するためにテナント間で発生する操作を共有するリソースの量。リソースは、コンピューティングと記憶域のコストと定義できます。 
-	***開発運用コスト***: アプリケーションの開発、デプロイ、および管理の容易さは、全体的な SaaS の運用コストを削減します。  

これらの特質を使用して、既に説明したマルチテナント データ モデルとそれぞれのデータベースの使い方は、図 2 のように特徴付けることができます。図では、テナントの分離の度合いとリソースの共有の量が、それぞれ Y 軸と X 軸として使用されています。中央の斜めの大きな矢印は、運用管理コストを示しています。

![一般的なパターン](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-popular-application-patterns.png) 図 2: 一般的なマルチテナント データ モデルの特徴

上の図 2 の右下の一角は、アプリケーションのパターンの 1 つとして、大規模になる可能性がある単一の共有データベースと共有テーブル (または異なるスキーマ) を使用するアプローチを示しています。すべてのテナントは、単一のデータベースで同じデータベース リソース (CPU、メモリ、IO など) を使用するため、共有されるリソースは非常に多くなります。ただし、テナントの分離は限られています。テナントを相互に保護するための追加手順をアプリケーション層で実行する必要があり、それによって、アプリケーションの開発と管理にかかる開発運用コストが大幅に増加する可能性があります。さらに、スケーラビリティは、データベースをホストするために使用されるハードウェアのスケールによって制限されます。

中央部分は、複数のテナントが複数の異なるデータベース間にシャーディングされ (通常、ハードウェア スケール ユニットは異なります)、各データベースがテナントのサブセットをホストするアプローチを示しています。このアプローチは、前のパターンの問題であるスケーラビリティに対処します。より多くのテナントに対応するために新しい容量が必要になった場合は、新しいハードウェア スケール ユニットに割り当てられた新しいデータベースに簡単に配置できます。ただし、同じスケール ユニットに配置されたテナントだけがリソースを共有するため、共有されるリソースの量は減少します。さらに、このアプローチでは、依然として多数のテナントが同じ場所に配置され、相互の操作に対する自動的な保護は行われないため、テナントの分離レベルはほとんど向上しません。アプリケーションの複雑性が高いままです。この方法は、しばしば「シャーディング」と呼ばれます。

上の図 2 の左上の一角は､3 番目のアプローチを示しています。このアプローチでは、各テナントは、それぞれの専用データベースに配置されます。このアプローチでのテナント分離属性は非常に優れていますが、各データベースに専用リソースを提供した場合、リソースはほとんど共有できません。これは、すべてのテナントのワークロードを予測できる場合は、優れたアプローチです。ただし、テナントのワークロードを予測できなくなると (SaaS ではよくあることです)、リソースの共有を最適化できなくなり、それが原因で、プロバイダーは、需要を満たしたり少ないリソースに対処したりために過剰なプロビジョニングを行うことになり、その結果、コストが上昇するかテナントの満足度が低下します。結果的に、ソリューションのコスト効率を高めるには、テナント間のリソース共有の度合いを高めることが望ましくなります。データベースの数の増加も、アプリケーションの開発と保守にかかる開発運用コストを増加させます。これらの問題については、次のセクションで再度取り上げますが、このアプローチでのテナント分離は、他のアプローチと比べた場合、最善かつ最も容易であることを覚えておくことが重要です。

設計パターンの選択では、次のその他の要素の影響も存在します。

-	***テナント データの所有権***: テナントが各自のデータの所有権を保持する場合は、テナントごとに 1 つのデータベースを使用するパターンが有利です。
-	***スケール***: アプリケーションが数十万または何百万のテナントを対象とする場合は、シャーディングなどのデータベースを共有するアプローチが有利ですが、分離要件が引き続き課題となる可能性があります。
-	***価値およびビジネス モデル***: テナントごとの収益が非常に小さい (ドル未満) の場合、分離要件の重要度は低くなり、データベースを共有することは理にかなっています。収益が数ドル以上の場合は、テナント単位のデータベースが実現可能になり、アプリケーションの開発運用コストを削減できます。

図 2 に示したトレードオフを考慮すると、理想的なマルチテナント モデルには、優れたテナント分離属性とテナント間での最適なリソース共有を組み込む必要があり、これは、図の右上の一角に適合するモデルになります。

## Azure SQL Database によるマルチテナント機能のサポート

Azure SQL Database は、図 2 で概要を説明したマルチテナント アプリケーション パターンのすべてをサポートします。さらに、新しいアプリケーション パターン (次の図 3 の緑色で示されている右上の一角) もサポートするようになりました。このパターンは、エラスティック データベース プールを、テナント単位のデータベース アプローチのメリットである優れたリソースの共有と分離と組み合わせたものです。エラスティック データベース ツールと Azure SQL Database の機能は、多数のデータベースを使用するアプリケーションの開発と運用における開発運用コスト(下の図 3 に網かけで示されている領域) にとって有用です。これらのツールは、複数のデータベースを使用するパターンを採用するアプリケーションの構築と管理を支援します。以下のセクションでは、SQL Database の機能と、SQL Database がマルチテナント モデルをどのように支援するかの詳細について、詳しく説明します。

![SQL DB のパターン](./media/sql-database-design-patterns-multi-tenancy-saas-applications/sql-database-patterns-sqldb.png) 図 3: Azure SQL Database を使用するマルチテナント アプリケーション パターン

## エラスティック プールとツールを使用するテナント単位のデータベース モデル

Azure SQL Database では、テナントの分離とテナントのデータベース間でのリソースの共有を組み合わせることで "テナント単位のデータベース" アプローチのサポートを強化する "エラスティック データベース プール" を提供しています。それは、SaaS プロバイダーがマルチテナント アプリケーションを構築するためのデータ層のソリューションとして設計されています。エラスティック データベース ツールと組み合わせると、マルチテナント機能は組み込み済みの機能となり、テナント間のリソース共有の負担は、アプリケーションからデータベース サービス層に移動されます。データベース間の大規模な管理/クエリの複雑さは、エラスティック ジョブ、クエリ、トランザクション、およびエラスティック データベース クライアント ライブラリによって単純化されます。

| アプリケーションの要件 | SQL Database の機能 |
| ------------------------ | ------------------------- |
| テナントの分離とリソースの共有 | [エラスティック データベース プール:](sql-database-elastic-pool.md) この機能は、SQLDB リソースのプールを割り当てて、これらのリソースを複数のデータベース間で共有できるようにします。また、個々のデータベースは、テナントのワークロードの変化による需要の急上昇に対応するために、必要に応じてプールのリソースを必要なだけ使用でき、エラスティック プール自体が、必要に応じてスケール アップとスケール ダウンを実行できます。エラスティック プールは、プール レベルでの管理、監視、およびトラブルシューティングの容易さも提供します。 |
| データベース間での開発運用の容易さ | [エラスティック データベース プール:](sql-database-elastic-pool.md) 上記のとおりです。|
||[エラスティック クエリ:](sql-database-elastic-query-horizontal-partitioning.md) レポートまたはクロステナント分析を行うために複数のデータベースをクエリできます。|
||[エラスティック ジョブ:](sql-database-elastic-jobs-overview.md) 多数のデータベースに対するデータベースのメンテナンス操作やデータベース スキーマの変更をパッケージ化して確実にデプロイできます。|
||[エラスティック トランザクション:](sql-database-elastic-scale.md) 複数のデータベースに対する変更を、アトミックな分離された方法で処理できます。これは、アプリケーションがいくつかのデータベース操作を "全部かゼロか" で保証する必要がある場合に必要です。 |
||[エラスティック クライアント ライブラリ:](sql-database-elastic-database-client-library.md) この機能は、データの分散とテナントのデータベースへのマッピングの管理を可能にします。 |
||||

## 共有モデル

前述のように、ほとんどの SaaS プロバイダーの '共有モデル' アプローチでは、テナント分離問題とアプリケーションの開発とメンテナンスの複雑さが発生する可能性があります。ただし、エンド ユーザーに直接サービスを提供するマルチテナント アプリケーションでは、テナント分離要件は、コストの最適化要求ほど優先度が高くない場合があります。この場合、テナントを 1 つまたは複数のデータベースに非常に高密度でパックすることで、コストを削減できる可能性があります。単一のデータベースまたは複数のシャード データベースを使用する共有データベース モデルは、リソースの共有をさらに効率化し、全体的なコストを削減する可能性があります。Azure SQL Database には、そのようなお客様がセキュリティ用の分離と管理を大きな規模でデータ層で構築することを支援するいくつかの機能があります。

| アプリケーションの要件 | SQL Database の機能 |
| ------------------------ | ------------------------- |
| セキュリティ用の分離機能 | [行レベルのセキュリティ](https://msdn.microsoft.com/library/dn765131.aspx) |
|| [データベース スキーマ](https://msdn.microsoft.com/library/dd207005.aspx) |
| データベース間での開発運用の容易さ | [エラスティック クエリ](sql-database-elastic-query-horizontal-partitioning.md) |
|| [エラスティック ジョブ](sql-database-elastic-jobs-overview.md) |
|| [エラスティック トランザクション](sql-database-elastic-transactions-overview.md) |
|| [エラスティック データベース クライアント ライブラリ](sql-database-elastic-database-client-library.md) |
|| [エラスティック データベース分割/マージ](sql-database-elastic-scale-overview-split-and-merge.md) |
||||

## まとめ

テナント分離要件は、ほとんどの SaaS マルチテナント アプリケーションにとって非常に重要です。分離を提供するための最適なオプションは、ほぼ "テナント単位のデータベース" アプローチと言えます。他の 2 つのアプローチでは、分離を提供するために熟練した開発スタッフを必要とするアプリケーション層への投資が必要です。これは、コストとリスクを大幅に増やす可能性があります。サービス開発の早い段階で分離要件に対応しなかった場合、最初の 2 つのモデルでは、さらに改良コストがかかる可能性があります。"テナント単位のデータベース" モデルの主な欠点は、共有の少なさと大量のデータベースの管理によるクラウド リソースのコストの増加に関係します。SaaS アプリケーションの開発者は、多くの場合、これらのトレードオフの間で苦慮しています。

これらのトレードオフは、ほとんどのクラウド データベース サービス プロバイダーにとって大きな障壁になる可能性がありますが、Azure SQL Database サービスは、"エラスティック データベース プール" と "エラスティック データベース機能" によってこれらの障壁を排除します。SaaS 開発者は、リソースの共有を最適化し、大量のデータベースを適切に管理したまま、テナント単位のデータベース モデルの分離特性をエラスティック プールや関連ツールと組み合わせることができます。

テナント分離要件がなく、コストを削減するためにテナントを非常に高密度でデータベース内のパックできるマルチテナント アプリケーション プロバイダーは、"共有" データ モデルによって、リソースの共有をさらに効率化し、全体的なコストを削減できる可能性があります。Azure SQL Database のエラスティック データベース ツール、シャーディング ライブラリ、およびセキュリティ機能は、SaaS プロバイダーがこのようなマルチテナント アプリケーションを構築して管理することを支援します。

## 次のステップ

クライアント ライブラリの使い方を示すサンプル アプリについては、「[Elastic Database ツールの概要](sql-database-elastic-scale-get-started.md)」を参照してください。

ツールを使用するように既存のデータベースを変換する方法については、「[既存のデータベースを移行してスケールアウト](sql-database-elastic-convert-to-use-elastic-tools.md)」を参照してください。

新しいプールの作成については、[エラスティック プールの作成チュートリアル](sql-database-elastic-pool-create-portal.md)に関するページをご覧ください。

エラスティック データベース プールの監視と管理については、[エラスティック データベース プールの監視と管理](sql-database-elastic-pool-manage-portal.md)に関するページをご覧ください。

## その他のリソース

- [Azure エラスティック データベース プールの概要](sql-database-elastic-pool.md)
- [Azure SQL Database によるスケールアウト](sql-database-elastic-scale-introduction.md)
- [弾力性データベース ツールと行レベルのセキュリティを使用したマルチテナント アプリケーション](sql-database-elastic-tools-multi-tenant-row-level-security.md)
- [Azure AD および OpenID Connect を使用したマルチテナント アプリでの認証](../guidance/guidance-multitenant-identity-authenticate.md)
- [Tailspin Surveys アプリケーション](../guidance/guidance-multitenant-identity-tailspin.md)

## 質問と機能に関する要望

質問がある場合は、[SQL Database のフォーラム](http://social.msdn.microsoft.com/forums/azure/home?forum=ssdsgetstarted)に投稿してください。機能に関するご要望は、[SQL Database に関するフィードバック フォーラム](https://feedback.azure.com/forums/217321-sql-database/)にお寄せください。









	

<!---HONumber=AcomDC_0615_2016-->