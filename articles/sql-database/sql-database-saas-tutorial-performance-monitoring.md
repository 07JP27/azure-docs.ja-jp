---
title: "SQL Database SaaS アプリのパフォーマンスの監視 | Microsoft Docs"
description: "Azure SQL Database のサンプル Wingtip Tickets (WTP) アプリのパフォーマンスを監視および管理します"
keywords: "SQL データベース チュートリアル"
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: tutorial
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: hero-article
ms.date: 05/10/2017
ms.author: billgib; sstein
ms.translationtype: Human Translation
ms.sourcegitcommit: fc4172b27b93a49c613eb915252895e845b96892
ms.openlocfilehash: af9511978718af10c97bee6af3a2835c9d2c1ff4
ms.contentlocale: ja-jp
ms.lasthandoff: 05/12/2017


---
# <a name="monitor-performance-of-the-wtp-sample-saas-application"></a>WTP SaaS サンプル アプリケーションのパフォーマンスの監視

このチュートリアルでは、SQL Database とエラスティック プールの組み込みの監視およびアラート機能を紹介した後に、SaaS アプリケーションで使用される主要なパフォーマンス管理シナリオをいくつか取り上げて説明します。

Wingtip Tickets アプリでは、会場 (テナント) ごとに独自のデータベースを持つシングル テナント データ モデルが採用されています。 多くの SaaS アプリケーションと同様、テナントのワークロード パターンは予測不能で、かつ散発的であることが予想されます。 つまり、チケット販売は常に発生する可能性があります。 この一般的なデータベース使用パターンを利用するには、テナント データベースをエラスティック データベース プールにデプロイします。 エラスティック プールでは、多くのデータベース間でリソースを共有することで、ソリューションのコストが最適化されます。 このタイプのパターンでは、データベースとプールのリソース使用を監視して、プール全体で負荷を適切かつ確実に分散させることが重要です。 また、各データベースに十分なリソースがあることと、プールが [eDTU](sql-database-what-is-a-dtu.md) 制限に達していないことを確認する必要もあります。 このチュートリアルでは、データベースとプールを監視および管理し、ワークロードの変化に応じて是正措置を講じる方法について説明します。

このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]

> * 指定されたロード ジェネレーターを実行して、テナント データベースの使用をシミュレートする
> * テナント データベースによる負荷の増加への対応を監視する
> * データベースの負荷の増加に応じてエラスティック プールをスケールアップする
> * データベース アクティビティの負荷を分散するために、2 つ目のエラスティック プールをプロビジョニングする


このチュートリアルを完了するには、次の前提条件を満たしておく必要があります。

* WTP アプリがデプロイされている。 5 分以内にデプロイを完了する方法については、[WTP SaaS アプリケーションのデプロイと確認に関するページ](sql-database-saas-tutorial.md)をご覧ください。
* Azure PowerShell がインストールされている。 詳細については、「[Azure PowerShell を使ってみる](https://docs.microsoft.com/powershell/azure/get-started-azureps)」を参照してください

## <a name="introduction-to-saas-performance-management-patterns"></a>SaaS パフォーマンス管理パターンの概要

データベース パフォーマンスを管理するには、まずパフォーマンス データをコンパイルして分析し、その後、このデータに基づいて、アプリケーションの許容応答時間を維持できるようパラメーターを調整します。 複数のテナントをホストしている場合、エラスティック データベース プールを使用すると、ワークロードが予測できないデータベース グループのリソースを、コスト効率に優れた方法で提供し、管理できます。 特定のワークロード パターンでは、S3 データベースが 2 つだけでも、プールで管理するというメリットを利用できます。 プールではリソース コストを共有でき、個々のデータベースを常に監視して追跡する必要もありません。

![メディア](./media/sql-database-saas-tutorial-performance-monitoring/app-diagram.png)

プール、およびプール内のデータベースは、パフォーマンスが許容範囲内で維持されるよう引き続き監視する必要があります。 プール構成は、集計ワークロードのニーズを満たすように調整し、ワークロード全体に適したプールの eDTU を確保します。 データベースあたりの eDTU の最小値と最大値を、特定のアプリケーション要件に応じて適切な値に調整してください。

### <a name="performance-management-strategies"></a>パフォーマンス管理戦略

* 手動でのパフォーマンス監視を避けるため、**データベースまたはプールが正常範囲から外れたときにアラートが生成されるように設定**すると最も効果的です。
* プールの集計パフォーマンス レベルで発生する短期的変動に対応するために、**プールの eDTU レベルをスケールアップまたはスケールダウンできます**。 こうした変動が定期的に発生する場合、または変動を予測できる場合は、**プールが自動的にスケールされるようにスケジュール設定します**。 たとえば、ワークロードが少なくなることがわかっている夜間や週末は、スケールダウンします。
* 長期的変動や複数のデータベースの変更に対応するには、**データベースを個別に他のプールに移動します**。
* "*個別*" のデータベース負荷の短期的な増加に対応するには、その期間だけ**データベースを個別にプールから取得し、それぞれにパフォーマンス レベルを割り当てます**。 負荷が減少すると、データベースはプールに戻すことができます。 これが事前にわかっている場合は、データベースを先に移動することで、そのデータベースに必要なリソースを必ず確保し、プール内の他のデータベースに影響が出るのを避けます。 たとえば、ある会場における人気イベントのにチケット販売にアクセスが殺到する、といった予測可能な要件に対しては、この管理動作をアプリケーションに組み込むことができます。

[Azure Portal](https://portal.azure.com) には、ほとんどのリソースに監視とアラートが組み込まれています。 SQL Database については、データベースとプールで監視とアラートを利用できます。 この組み込みの監視とアラートはリソース固有であるため、リソースが少数の場合は便利ですが、リソースの数が多くなると、それほど便利とは言えません。

大規模なシナリオでは、Log Analytics (OMS とも呼ばれます) を使用できます。 これは、出力された診断ログと、ログ分析ワークスペースで収集されたテレメトリに分析を提供する個別の Azure サービスで、多くのサービスからテレメトリを収集できます。また、このサービスを使用して、クエリを実行し、アラートを設定することもできます。

## <a name="get-the-wingtip-application-scripts"></a>Wingtip アプリケーションのスクリプトの取得

Wingtip Tickets のスクリプトとアプリケーションのソース コードは、[WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) Github リポジトリから入手できます。 スクリプト ファイルは、[Learning Modules フォルダー](https://github.com/Microsoft/WingtipSaaS/tree/master/Learning%20Modules)にあります。 **Learning Modules** フォルダーを、構造を保ったままローカル コンピューターにダウンロードします。

## <a name="provision-additional-tenants"></a>その他のテナントのプロビジョニング

S3 データベースが 2 つだけでもプールはコスト効率よく動作しますが、プール内のデータベースが多くなると、平均的な効果のコスト効率はさらに向上します。 大規模環境でのパフォーマンスの監視と管理のしくみを十分に理解するために、このチュートリアルでは、少なくとも 20 のデータベースをデプロイする必要があります。

前のチュートリアルで既にテナントのバッチをプロビジョニングした場合は、「[すべてのテナント データベースの使用をシミュレート](#simulate-usage-on-all-tenant-databases)」に進むことができます。

1. **PowerShell ISE** で …\\Learning Modules\\Provision and Catalog\\*Demo-PerformanceMonitoringAndManagement.ps1* を開きます。 このスクリプトを開いたまま、このチュートリアルのシナリオをいくつか実行します。
1. **$DemoScenario** = **1** ("**テナントのバッチのプロビジョニング**") を設定します
1. **F5** キーを押して、スクリプトを実行します。

スクリプトによって、17 のテナントが 5 分以内でデプロイされます。

*New-TenantBatch* スクリプトでは、入れ子になった、またはリンクされている [Resource Manager](../azure-resource-manager/index.md) テンプレート セットを使用して、テナントのバッチが作成されます。これにより、既定では、**baseTenantDb** データベースがカタログ サーバーにコピーされ、新しいテナント データベースが作成されます。その後、そのデータベースがカタログに登録され、最後にテナント名と会場の種類で初期化されます。 これは、WTP アプリが新しいテナントをプロビジョニングする方法と一致します。 *baseTenantDB* に対するすべての変更が、その後プロビジョニングされた新しいテナントすべてに適用されます。 "*既存*" のテナント データベース ("*ゴールデン*" データベースを含む) に対してスキーマの変更を行う方法については、[スキーマ管理のチュートリアル](sql-database-saas-tutorial-schema-management.md)をご覧ください。

## <a name="simulate-different-usage-patterns-by-generating-different-load-types"></a>さまざまな負荷の種類を生成してさまざまな使用パターンをシミュレート

*Demo-PerformanceMonitoringAndManagement.ps1* スクリプトは、使用可能な "*負荷の種類*" のいずれかを使用して、ロード ジェネレーターを開始します。

| デモ | シナリオ |
|:--|:--|
| 2 | 標準強度の負荷 (約 40 DTU) を生成 |
| 3 | 各データベースにバーストが長く、かつ頻繁に発生する負荷を生成|
| 4 | 各データベースに高 DTU バースト (約 80 DTU) の負荷を生成|
| 5 | 通常の負荷のほか、シングル テナントに高負荷 (約 95 DTU) を生成|
| 6 | 複数のプールに不均衡な負荷を生成|

## <a name="simulate-usage-on-all-tenant-databases"></a>すべてのテナント データベースの使用をシミュレート

ロード ジェネレーターは、"*合成*" CPU のみの負荷を、すべてのテナント データベースに適用します。 ジェネレーターはテナント データベースごとにジョブを開始し、これにより負荷を生成するストアド プロシージャが定期的に呼び出されます。 負荷レベル (eDTU 単位)、期間、および間隔はすべてのデータベースで異なり、予測不可能なテナントのアクティビティをシミュレートします。

1. **$DemoScenario** = **2** ("*標準強度の負荷を生成*") を設定します。
1. **F5** キーを押して、負荷をすべてのテナント データベースに適用します。

負荷には散発的な性質があるため、アクティビティが安定し、目的のパターンで落ち着くように、ジェネレーターを 10 ～ 20 分間実行したままにします。

> [!IMPORTANT]
> ロード ジェネレーターは、ローカル PowerShell セッションで一連のジョブとして実行されています。 *[Demo-PerformanceMonitoringAndManagement.ps1]* タブは開いたままにしておいてください。 タブを閉じるか、コンピューターを中断すると、ロード ジェネレーターは停止します。

## <a name="monitor-resource-usage-using-the-portal"></a>ポータルを使用したリソース使用の監視

負荷を適用した結果、リソースがどのように使用されているかを監視するには、テナント データベースを含むプールに対してポータルを開きます。

1. [Azure Portal](https://portal.azure.com) を開いて、tenants1-&lt;USER&gt; を参照します。
1. 新しいデータベースのバッチを含む、テナント データベースの一覧が表示されます。
1. 下にスクロールし、エラスティック プールを検索して、**[Pool1]** をクリックします。 このプールには、これまでに作成されたすべてのテナント データベースが含まれています。
1. プール ブレードを開きます。このブレードで、プール使用グラフと使用率の高いデータベース グラフを開いて、確認できます。

プール使用は、事実上、プール内のすべてのデータベースのデータベース使用の集計を示しています。 データベース使用グラフには、使用率が高い 5 つのデータベースが示されています。

![](./media/sql-database-saas-tutorial-performance-monitoring/pool1.png)

使用率の高い 5 つのデータベース以外にもプールにはデータベースは存在するため、プール使用は、使用率の高い 5 つのデータベース グラフに反映されていないアクティビティを示しています。 詳細を確認するには、**[データベース リソースの使用率]** をクリックします。

![](./media/sql-database-saas-tutorial-performance-monitoring/database-utilization.png)


## <a name="set-performance-alerts-on-the-pool"></a>プールでのパフォーマンス アラートの設定

\>75% の使用率が 5 分間続いたときに、プールでアラートがトリガーされるように設定する手順を次に示します。

1. [Azure Portal](https://portal.azure.com) で、(*tenants1-\<user\>* サーバーにある) *Pool1* を開きます。
1. **[アラート ルール]**、**[+ アラートの追加]** の順にクリックします。

   ![アラートの追加](media/sql-database-saas-tutorial-performance-monitoring/add-alert.png)

1. 名前 (**高 DTU** など) を付けます。 
1. 次の値を設定します。
   * **メトリック = eDTU の割合**
   * **条件 = より大きい**。
   * **しきい値 = 75**。
   * **期間 = 過去 30 分間**。

   ![set alert](media/sql-database-saas-tutorial-performance-monitoring/alert-rule.png)

Azure アカウントの電子メールに通知が届くように設定できます。オプションで他の電子メールを通知先として設定することもできますが、使用中のサブスクリプションを所有していない限り、これはお勧めしません。

> [!NOTE]
> アラートは過去 30 分以内にしきい値を超えた場合にのみ生成されるため、アラートをテストする場合は、ロード ジェネレーターを 30 分にわたって実行する必要があります。


## <a name="scale-up-a-busy-pool"></a>ビジー状態のプールのスケールアップ

プールの集計負荷レベルが、プールを使い切り、eDTU 使用率が 100% に達すると、各データベースのパフォーマンスが影響を受け、プール内のすべてのデータベースのクエリ応答時間が遅くなる可能性があります。

短期的には、プールをスケールアップしてリソースを追加するか、プールからデータベースを削除すること、たとえばデータベースを他のプールに移動したり、プールからスタンドアロン サービス レベルに移動したりすることを検討してください。

長期的には、クエリやインデックスの使用を最適化して、データベース パフォーマンスを向上させることを検討します。 パフォーマンスの問題がアプリケーションにどの程度影響するかによっては、eDTU 使用率が 100% に達する前に、プールをスケールアップすることをお勧めします。 アラートを使用して、事前に警告するよう設定できます。

ビジー状態のプールをシミュレートするには、ジェネレーターによって生成される負荷を増やします。 データベースのバーストの頻度を上げ、時間を長くすることで、プールの集計負荷が増加します。その際、個別のデータベースの要件を変更する必要はありません。 プールのスケールアップは、ポータルまたは PowerShell で簡単に行うことができます。 ここでは、ポータルを使用します。

1. *$DemoScenario* = **3** ("_各データベースにバーストが長く、かつ頻繁に発生する負荷を生成_") を設定し、各データベースに必要なピーク負荷を変えずにプールの集計負荷の強度を上げます。
1. **F5** キーを押して、負荷をすべてのテナント データベースに適用します。


1. **tenants1/Pool1 の****プール ブレードを開きます**。


1. 上部のグラフでプールの DTU 使用の増加を監視します。 高負荷が反映されるまで数分かかりますが、プールの使用率はすぐに 100% に達します。そして、負荷が新しいパターンで安定すると、迅速にプールをオーバーロードします。


1. プールをスケールアップするには、**[プールの構成]** をクリックします
1. **[プールの eDTU]** スライダーを 100 に調整します (コストを制限するため、それ以上にはしないことをお勧めします)。 プール内のすべてのデータベースに対して使用でき、**プール GB** によって示されている集計ストレージが、どのように eDTU 設定にリンクされ、増えていくかを確認します。 プール の eDTU を変更しても、データベースごとの設定は変わりません (データベースあたり最大 50 eDTU)。 データベースごとの設定は、**[プールの構成]** ブレードの右側で確認できます。
1. **[保存]** をクリックして、要求を送信します。 Standard プールの場合、通常、変更には約 3 ～ 5 分かかります。

**[Pool1]**  >  **[概要]** に戻って、監視グラフを表示します。 プールのリソースを増やした効果を監視してください (ただし、少しのデータベースと、ランダムな負荷を追加しただけでは、その効果を確認するのは必ずしも容易ではありません)。 グラフを見るときは、上部のグラフの 100% は 100 eDTU を表していますが、下部のグラフの 100% は 50 eDTU を表すことに注意してください。これはデータベースあたりの最大値がまだ 50 eDTU であるためです。

データベースはオンラインのままで、プロセス全体で完全に使用できます。 新しいプールの eDTU で各データベースが有効になる間際に、アクティブなすべての接続が切断されます。 切断された接続を再試行するためのアプリケーション コードが常に記述されており、これによりスケールアップ プール内のデータベースに再接続されます。

## <a name="create-a-second-pool-and-load-balance-databases-to-handle-increased-aggregate-load"></a>2 つ目のプール作成とデータベース負荷分散により集計負荷の増加に対応

プールをスケールアップするもう 1 つの方法として、2 つ目のプールを作成してデータベースを移動し、2 つのプール間で負荷を分散させます。 これを行うには、1 つ目のプールと同じサーバーに新しいプールを作成する必要があります。

1. **customers1-&lt;USER&gt; サーバーのサーバー ブレード**を開きます。 データベースまたはプール ブレードが表示されている場合は、ショートカットとして essentials control を押しながらサーバーの名前を選択できます。
1. **[+ 新しいプール]** をクリックして、現在のサーバーにプールを作成します
1. 新しいエラスティック データベース プール テンプレートで次の操作を行います。

    1. **名前 = Pool2** を設定します。
    1. 価格レベルは **Standard プール**のままにします。
    1. **[プールの構成]** をクリックします。
    1. 表示された [プールの構成] ブレードで、**プールの eDTU = 50 DTU** と設定します。
    1. **[データベースの追加]** をクリックすると、このサーバー上にあるデータベースで、現在のプールにないものが一覧表示されます。
    1. この一覧で、新しいプールに移動するデータベースとして半数 (20 のうち 10) を**オンにして**、**[選択]** をクリックします。
    1. **[選択]** を再度クリックして、構成の変更を確定します。 選択したオプションで 1 か月使用した場合の推定コストを確認してください。
    1. **[OK]** を選択して、新しい構成で新しいプールを作成し、データベースを移動します。

プールを作成して、データベースを移動するには数分かかります。 移動中のデータベースはそれぞれオンライン状態が維持され、オープンな接続すべてが閉じる最後の時点まで完全にアクセスできます。 クライアントが接続を再試行した時点で、そのクライアントは新しいプールのデータベースの接続されます。

作成されたプールは、customers1 サーバー ブレードに表示されます。 プール名をクリックしてプール ブレードを開いて、そのパフォーマンスを監視します。

Pool1 のリソース使用が削除され、Pool2 が同じように読み込まれていることがわかります。

## <a name="manage-an-increased-load-on-a-single-database"></a>1 つのデータベースでの負荷増加の管理

プール内の 1 つのデータベースの負荷が継続して高い場合、プールの構成によっては、プール内のリソースを使用し、他のデータベースに影響を与えている可能性があります。 このようなアクティビティがしばらく続く可能性が高い場合は、そのデータベースをプールから一時的に移動できます。 これにより、負荷が高くなっているデータベースに、プール内の他のデータベースよりも多くのリソースが割り当てられるほか、そのデータベースが他のデータベースから切り離されます。 ここでは、人気の高いコンサートのチケット発売時に高負荷が発生する Contoso コンサート ホールの状況をシミュレートします。

1. \\**Demo-PerformanceManagementAndMonitoring**.ps1 スクリプトを実行します
1. **$DemoScenario = 5 (通常の負荷のほか、1 つのテナントに高負荷 (約 95 DTU) を生成)** を設定します。
1. **$SingleTenantDatabaseName = contosoconcerthall** を設定します
1. **F5** を使用して、スクリプトを実行します。
1. **Customers1/Pool1 の****プール ブレードを開きます**。
1. ブレード上部の **[エラスティック プールの監視]** で、プールの DTU 使用の増加を確認します。 数分後にさらに高い負荷が発生し、プール使用率がすぐに 100% に達します。
1. また、**[エラスティック データベースの監視]** も監視します。これは、過去 1 時間で最も使用率が高いデータベースを示しています。 すぐに contosoconcerthall データベースが、使用率が高い 5 つのデータベースの 1 つとして表示されます。
1. **[エラスティック データベースの監視]** **グラフ**をクリックすると、**[データベース リソースの使用率]** ブレードが開きます。このブレードでは、データベースを選択して監視することができます。 これにより、contosoconcerthall データベースの表示を切り離すことができます。
1. データベースの一覧で **contosoconcerthall** をクリックして、そのデータベースのブレードを開きます。
1. コンテキスト メニューで **[価格レベル (DTU のスケール)]** をクリックして、**[パフォーマンスの構成]** ブレードを開きます。このブレードでは、そのデータベースのパフォーマンス レベルを個別に設定できます。
1. **[Standard]** タブをクリックして、Standard レベルのスケール オプションを開きます。
1. **DTU スライダー**を右に移動して、100 DTU を選択します。 これは、DTU とストレージ サイズ メーターの間に表示されている、かっこで囲まれたサービス目標 **S3** に対応していることを確認してください。
1. **[適用]** をクリックして、プールからデータベースを移動し、Standard S3 データベースに設定します。
1. デプロイが完了したら、contosoconcert hall データベースに対する効果と、エラスティック プールとデータベース ブレード上の、データベースが削除されたプールに対する効果を監視します。

contosoconcerthall データベースの通常よりも負荷が高い状態が落ち着いたら、コストを削減するためにすぐにプールに戻す必要があります。 プールに戻すタイミングがはっきりしない場合は、プールで DTU の使用率がデータベースあたりの最大値を下回ったときに、データベースでアラートが発生するように設定できます。 プールへのデータベースの移動については、演習 5 で説明しています。

## <a name="other-performance-management-patterns"></a>その他のパフォーマンス管理パターン

**プリエンプティブなスケーリング**: 演習 6 では、目的のデータベースがわかっている場合に、データベースを切り離してスケールする方法を説明しました。 Contoso コンサート ホールの管理によって、間もなくチケットが発売されることが WTP に知らされていれば、データベースを事前にプールから移動することもできるでしょう。 しかし、そうでない場合は、プールまたはデータベースでアラートを設定して、何が起こっているかを把握しなければならない可能性があります。 プール内の他のテナントからのパフォーマンス低下に関する苦情によって、このことを知りたくはありません。 また、追加リソースが必要となる期間をテナントが予測できれば、Azure Automation Runbook を設定することで、プールからデータベースを移動する作業、そしてプールに戻す作業を決められたスケジュールで行うことができます。

**テナント セルフサービス スケーリング**: スケーリング タスクは管理 API 経由で簡単に呼び出されます。このため、テナント接続アプリケーションにテナント データベースをスケールする機能は簡単に作成できます。作成した機能は、SaaS サービスの機能として提供できます。 たとえば、テナントによるスケールアップ/スケールダウンの自己管理が可能で、場合によっては、これが請求に直接リンクされます。

### <a name="scaling-a-pool-up-and-down-on-a-schedule-to-match-usage-patterns"></a>使用パターンに合わせてプールのスケールアップ/スケールダウンをスケジュール設定

予測可能な使用パターンに従って集計テナントが使用されている場合は、Azure Automation を使用して、スケジュールに従ってプールをスケールアップ/スケールダウンできます。 たとえば、平日午後 6 時以降に必要なリソースが減ることがわかっている場合、その時間帯はプールをスケールダウンし、午前 6 時前に再度スケールアップします。



## <a name="next-steps"></a>次のステップ

このチュートリアルで学習する内容は次のとおりです。

> [!div class="checklist"]
> * 指定されたロード ジェネレーターを実行して、テナント データベースの使用をシミュレートする
> * テナント データベースによる負荷の増加への対応を監視する
> * データベースの負荷の増加に応じてエラスティック プールをスケールアップする
> * データベース アクティビティの負荷を分散するために、2 つ目のエラスティック プールをプロビジョニングする

[シングル テナント データベースの復元](sql-database-saas-tutorial-restore-single-tenant.md)


## <a name="additional-resources"></a>その他のリソース

* [Wingtip Tickets Platform (WTP) アプリケーションの初期のデプロイに基づく作業のための追加のチュートリアル](sql-database-wtp-overview.md#sql-database-wtp-saas-tutorials)
* [SQL エラスティック プール](sql-database-elastic-pool.md)
* [Azure Automation](../automation/automation-intro.md)
* [Log Analytics](sql-database-saas-tutorial-log-analytics.md) - Log Analytics の設定および使用チュートリアル
