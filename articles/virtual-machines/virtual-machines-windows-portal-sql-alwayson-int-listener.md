<properties
   pageTitle="Azure 仮想マシンに SQL Server の AlwaysOn 可用性グループのリスナーを作成する"
   description="Azure 仮想マシンに SQL Server の AlwaysOn 可用性グループのリスナーを作成する手順を説明します。"
   services="virtual-machines"
   documentationCenter="na"
   authors="MikeRayMSFT"
   manager="jhubbard"
   editor="monicar"/>

<tags
   ms.service="virtual-machines"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="vm-windows-sql-server"
   ms.workload="infrastructure-services"
   ms.date="04/17/2016"
   ms.author="MikeRayMSFT"/>

# Azure の AlwaysOn 可用性グループに使用する内部ロード バランサーの構成

このトピックでは、Resource Manager モデルで動作する Azure 仮想マシンに、SQL Server AlwaysOn 可用性グループの内部ロード バランサーを作成する方法について説明します。SQL Server インスタンスが Azure 仮想マシン上で実行されている場合、AlwaysOn 可用性グループにロード バランサーが必要となります。ロード バランサーには、可用性グループ リスナーの IP アドレスが格納されます。可用性グループが複数のリージョンにまたがっている場合は、各リージョンにロード バランサーが必要です。

この作業を行うには、SQL Server AlwaysOn 可用性グループが Resource Manager モデルの Azure 仮想マシンにデプロイされている必要があります。両方の SQL Server 仮想マシンが同じ可用性セットに属している必要があります。Azure Resource Manager では、[Microsoft のテンプレート](virtual-machines-windows-portal-sql-alwayson-availability-groups.md)を使用して自動的に AlwaysOn 可用性グループを作成することができます。内部ロード バランサーは、このテンプレートによって自動的に作成されます。

必要に応じて [AlwaysOn 可用性グループを手動で構成](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md)することもできます。

このトピックは、可用性グループの構成が既に済んでいることを前提としています。

関連トピック:

 - [Azure VM での AlwaysOn 可用性グループの構成 (GUI)](virtual-machines-windows-portal-sql-alwayson-availability-groups-manual.md)   
 
 - [Azure リソース マネージャーと PowerShell を使用した VNet 間の接続の構成](../vpn-gateway/vpn-gateway-vnet-vnet-rm-ps.md)

## 手順

このドキュメントでは、Azure ポータルでロード バランサーを作成し、必要な構成を行います。その作業が済んだら、AlwaysOn 可用性グループ リスナーのロード バランサーの IP アドレスを使用するようにクラスターを構成します。

## Azure ポータルでのロード バランサーの作成と構成

この作業の一環として Azure ポータルで次の手順を実行します。

1. ロード バランサーを作成して IP アドレスを構成する

1. バックエンド プールを構成する

1. プローブを作成する

1. 負荷分散規則を設定する

>[AZURE.NOTE] SQL Server が異なるリソース グループやリージョンに存在する場合、このすべての手順を 2 回 (リソース グループごとに 1 回) 行う必要があります。

## 1\.ロード バランサーを作成して IP アドレスを構成する

最初に行う作業は、ロード バランサーの作成です。Azure ポータルで、SQL Server の仮想マシンを含んだリソース グループを開きます。リソース グループで **[追加]** をクリックします。

- "**ロード バランサー**" を検索します。検索結果から **[ロード バランサー]** (**Microsoft** が公開) を選択します。

- **[ロード バランサー]** ブレードで **[作成]** をクリックします。

- **[Create load balancer (ロード バランサーの作成)]** で、次のようにロード バランサーを構成します。

| 設定 | 値 |
| ----- | ----- |
| **名前** | ロード バランサーを表すテキスト名 (例: **sqlLB**)。 |
| **スキーマ** | **内部** |
| **Virtual Network** | SQL Server が存在する仮想ネットワークを選択します。 |
| **サブネット** | SQL Server が存在するサブネットを選択します。 |
| **サブスクリプション** | 複数のサブスクリプションを所有している場合、このフィールドが表示されます。このリソースに関連付けられているサブスクリプションを選択します。通常は、可用性グループのすべてのリソースについて同じサブスクリプションを選択してください。 |
| **[リソース グループ]** | SQL Server が存在するリソース グループを選択します。 | 
| **場所** | SQL Server が存在する Azure の場所を選択します。 |

- **[作成]** をクリックします。 

以上の構成を適用したロード バランサーが Azure によって作成されます。このロード バランサーは、特定のネットワーク、サブネット、リソース グループ、場所に従属します。Azure の処理が完了したら、ロード バランサーの設定を Azure で確認してください。

次に、ロード バランサーの IP アドレスを構成します。

- ロード バランサーの **[設定]** ブレードで **[IP アドレス]** をクリックします。SQL Server と同じ仮想ネットワーク上のプライベート ロード バランサーであることが、**[IP アドレス]** ブレードに表示されます。 

- 次の設定を適用します。

| 設定 | 値 |
| ----- | ----- |
| **サブネット** | SQL Server が存在するサブネットを選択します。 |
| **割り当て** | **静的** |
| **IP アドレス** | サブネットから未使用の仮想 IP アドレスを入力します。 |

- 設定を保存します。

これでロード バランサーに IP アドレスが設定されました。この IP アドレスをメモしておいてください。この IP アドレスは、クラスターにリスナーを作成するときに使用します。この記事で後ほど示す PowerShell スクリプトの `$ILBIP` 変数には、このアドレスを使用してください。



## 2\.バックエンド プールを構成する

次の手順は、バックエンド アドレス プールの作成です。Azure では、バックエンド アドレス プールを "*バックエンド プール*" と呼んでいます。この例では、可用性グループに含まれる 2 つの SQL Server のアドレスがバックエンド プールとなります。

- リソース グループで、作成したロード バランサーをクリックします。 

- **[設定]** の **[バックエンド プール]** をクリックします。

- **[バックエンド アドレス プール]** の **[追加]** をクリックしてバックエンド アドレス プールを作成します。

- **[バックエンド プールの追加]** の **[名前]** に、バックエンド プールの名前を入力します。

- **[仮想マシン]** の **[+ 仮想マシンの追加]** をクリックします。

- **[仮想マシンの選択]** の **[可用性セットの選択]** をクリックし、SQL Server 仮想マシンの追加先となる可用性セットを指定します。

- 可用性セットを選択したら、**[仮想マシンの選択]** をクリックします。可用性グループ内の SQL Server インスタンスのホストとなる 2 つの仮想マシンをクリックします。**[選択]** をクリックします。

- **[OK]** をクリックして、**[仮想マシンの選択]** のブレードと、**[バックエンド プールの追加]** を閉じます。

バックエンド アドレス プールの設定が Azure で更新されます。これで 2 つの SQL Server から成るプールが可用性セットに作成されました。

## 3\.プローブを作成する

次の手順はプローブの作成です。このプローブで定義された方法で、現在どの SQL Server が可用性グループ リスナーを所有しているかが Azure によって確認されます。Azure は、プローブの作成時に定義されたポートで、IP アドレスに基づいてサービスをプローブします。

- ロード バランサーの **[設定]** ブレードで **[プローブ]** をクリックします。 

- **[プローブ]** ブレードで **[追加]** をクリックします。

- **[プローブの追加]** ブレードでプローブを構成します。次の値を使用してプローブを構成します。

| 設定 | 値 |
| ----- | ----- |
| **名前** | プローブを表すテキスト名 (例: **SQLAlwaysOnEndPointProbe**)。 |
| **プロトコル** | **TCP** |
| **ポート** | 空いている任意のポートを使用できます (例: *59999*)。 |
| **間隔** | *5* | 
| **異常のしきい値** | *2* | 

- **[OK]** をクリックします。 

>[AZURE.NOTE] 指定したポートは、両方の SQL Server のファイアウォールで必ず開放してください。使用する TCP ポートに対する入力方向の規則が両方のサーバーに必要となります。詳細については、「[ファイアウォール規則を追加または編集する](http://technet.microsoft.com/library/cc753558.aspx)」を参照してください。

指定したプローブが Azure によって作成されます。Azure はこのプローブを使用して、どの SQL Server が可用性グループのリスナーを所有しているかを判定します。

## 4\.負荷分散規則を設定する

負荷分散規則を設定します。SQL Server へのトラフィックをロード バランサーでどのようにルーティングするかは、負荷分散規則で設定します。2 つの SQL Server のうち可用性グループ リスナー リソースを所有できるのは一度に 1 つだけであるため、このロード バランサーでは Direct Server Return を有効にします。

- ロード バランサーの **[設定]** ブレードで、**[負荷分散規則]** をクリックします。 

- **[負荷分散規則]** ブレードで、**[追加]** をクリックします。

- **[負荷分散規則の追加]** ブレードを使用して負荷分散規則を構成します。次の設定を使用します。

| 設定 | 値 |
| ----- | ----- |
| **名前** | 負荷分散規則を表すテキスト名 (例: **SQLAlwaysOnEndPointListener**)。 |
| **プロトコル** | **TCP** |
| **ポート** | *1433* |
| **バックエンド ポート** | *1433*。ただし、この規則には **[フローティング IP (ダイレクト サーバー リターン)]** が使用されるため、これは無効になります。 |
| **プローブ** | このロード バランサーに対して作成したプローブの名前を使用します。 |
| **セッション永続化** | **なし** | 
| **アイドル タイムアウト (分)** | *4* | 
| **フローティング IP (ダイレクト サーバー リターン)** | **有効** | 

 >[AZURE.NOTE] ブレード上で一部の設定が隠れて見えないときは下へスクロールしてください。

- **[OK]** をクリックします。 

- 負荷分散規則が Azure によって構成されます。以上、可用性グループのリスナーのホストとなっている SQL Server にトラフィックをルーティングするようにロード バランサーを構成しました。

この時点で、リソース グループのロード バランサーが両方の SQL Server マシンに接続されています。またロード バランサーには、可用性グループへの要求にいずれかのマシンが応答できるよう、SQL Server AlwaysOn 可用性グループ リスナーの IP アドレスが格納されます。

>[AZURE.NOTE] SQL Server が 2 つの異なるリージョンに存在する場合、もう一方のリージョンについても以上の手順を繰り返す必要があります。ロード バランサーはリージョンごとに必要です。

## ロード バランサーの IP アドレスを使用するようにクラスターを構成する 

次に、クラスター上のリスナーを構成し、リスナーをオンラインに切り替えます。そのために必要な作業は次のとおりです。

1. 可用性グループ リスナーをフェールオーバー クラスターに作成する 

1. リスナーをオンラインにする

## 1\.可用性グループ リスナーをフェールオーバー クラスターに作成する

この手順では、フェールオーバー クラスター マネージャーおよび SQL Server Management Studio (SSMS) で可用性グループ リスナーを手動で作成します。

- プライマリ レプリカのホストとなっている Azure 仮想マシンに RDP で接続します。 

- フェールオーバー クラスター マネージャーを開きます。

- **Networks** ノードを選択し、クラスター ネットワーク名をメモします。この名前は、PowerShell スクリプトの `$ClusterNetworkName` 変数に使用します。

- クラスター名を展開して、**[ロール]** をクリックします。

- **[ロール]** ウィンドウで、可用性グループ名を右クリックし、**[リソースの追加]** > **[クライアント アクセス ポイント]** の順に選択します。

- **[名前]** ボックスで、この新しいリスナーの名前を作成し、**[次へ]** を 2 回クリックし、**[完了]** をクリックします。この時点では、リスナーまたはリソースをオンラインにしないでください。

 >[AZURE.NOTE] この新しいリスナーの名前は、アプリケーションが SQL Server 可用性グループ内のデータベースに接続するために使用するネットワーク名になります。

- **[リソース]** タブをクリックして、作成したクライアント アクセス ポイントを展開します。IP リソースを右クリックし、[プロパティ] をクリックします。IP アドレスの名前をメモします。この名前は、PowerShell スクリプトの `$IPResourceName` 変数に使用します。

- **[IP アドレス]** で **[静的 IP アドレス]** をクリックし、静的 IP アドレスを設定します。Azure ポータルでロード バランサーの IP アドレスを設定するときに使用したものと同じアドレスを指定してください。このアドレスに対して NetBIOS を有効にし、**[OK]** をクリックします。ソリューションが複数の Azure VNet にまたがる場合は、IP リソースごとにこの手順を繰り返します。

- 現在プライマリ レプリカのホストとなっているクラスター ノードから、管理者特権で PowerShell ISE を開き、新しいスクリプトに次のコマンドを貼り付けます。

        $ClusterNetworkName = "<MyClusterNetworkName>" # the cluster network name (Use Get-ClusterNetwork on Windows Server 2012 of higher to find the name)
        $IPResourceName = "<IPResourceName>" # the IP Address resource name
        $ILBIP = “<X.X.X.X>” # the IP Address of the Internal Load Balancer (ILB). This is the static IP address for the load balancer you configured in the Azure portal.
    
        Import-Module FailoverClusters
    
        Get-ClusterResource $IPResourceName | Set-ClusterParameter -Multiple @{"Address"="$ILBIP";"ProbePort"="59999";"SubnetMask"="255.255.255.255";"Network"="$ClusterNetworkName";"EnableDhcp"=0}

- 変数を修正して PowerShell スクリプトを実行し、新しいリスナーの IP アドレスとポートを構成します。

 >[AZURE.NOTE] SQL Server が別個のリージョンに存在する場合は、PowerShell スクリプトを 2 回実行する必要があります。1 回目は、クラスターのネットワーク名、クラスターの IP リソース名、ロード バランサーの IP アドレスを 1 つ目のリソース グループに基づいて指定します。2 回目は、クラスターのネットワーク名、クラスターの IP リソース名、ロード バランサーの IP アドレスを 2 つ目のリソース グループに基づいて指定します。

これでクラスターに可用性グループ リスナー リソースが割り当てられました。

## 2\.リスナーをオンラインにする

可用性グループ リスナー リソースを構成したら、アプリケーションがリスナーを使って可用性グループ内のデータベースに接続できるように、リスナーをオンラインに切り替えます。

- フェールオーバー クラスター マネージャーに戻ります。**[ロール]** を展開し、[可用性グループ] を強調表示します。**[リソース]** タブで、リスナー名を右クリックし、**[プロパティ]** をクリックします。

- **[依存関係]** タブをクリックします。複数のリソースが一覧表示される場合は、IP アドレスに OR (AND ではなく) 依存関係があることを確認します。**[OK]** をクリックします。

- リスナー名を右クリックし、**[オンラインにする]** をクリックします。


- リスナーがオンラインになったら、**[リソース]** タブで可用性グループを右クリックし、**[プロパティ]** をクリックします。

- リスナー名のリソース (IP アドレス リソース名ではなく) への依存関係を作成します。**[OK]** をクリックします。


- SQL Server Management Studio を起動し、プライマリ レプリカに接続します。


- **[AlwaysOn 高可用性]**、**[可用性グループ]**、**[可用性グループ リスナー]** の順に移動します。


- フェールオーバー クラスター マネージャーで作成したリスナー名が表示されます。リスナー名を右クリックし、**[プロパティ]** をクリックします。


- **[ポート]** ボックスで、以前に使用した $EndpointPort (既定値は 1433) を使用し、可用性グループ リスナーのポート番号を指定して、**[OK]** をクリックします。

これで、SQL Server AlwaysOn 可用性グループが Resource Manager モデルの Azure 仮想マシンにデプロイされました。

## リスナーへの接続をテストする

接続をテストするには、次の手順に従います。

1. 同じ仮想ネットワークに存在する、レプリカを所有していない SQL Server に RDP で接続します。クラスター内の別の SQL Server がそれに該当します。

1. **sqlcmd** ユーティリティを使用して接続をテストします。たとえば、次のスクリプトはリスナー経由で Windows 認証を使用し、プライマリ レプリカとの **sqlcmd** 接続を確立しています。

        sqlmd -S <listenerName> -E

SQLCMD 接続は、プライマリ レプリカをホストしている SQL Server インスタンスに対して自動的に接続します。

## ガイドラインと制限

内部ロード バランサーを使用した Azure の可用性グループ リスナーに関する次のガイドラインを確認してください。

- サポートされる内部可用性グループ リスナーは、クラウド サービスごとに 1 つだけです。リスナーはロード バランサーに対して構成されており、内部ロード バランサーは 1 つしか存在しないためです。ただし外部リスナーは、複数作成することもできます。 

- 内部ロード バランサーでは、同じ仮想ネットワーク内からしかリスナーにアクセスできません。
 

<!---HONumber=AcomDC_0601_2016-->