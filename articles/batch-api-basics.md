<properties 
	pageTitle="Azure Batch の API の基本" 
	description="開発者に Azure Batch API と Batch サービスについて知ってもらうための概念" 
	services="batch" 
	documentationCenter=".net" 
	authors="yidingzhou" 
	manager="timlt" 
	editor=""/>

<tags 
	ms.service="batch" 
	ms.devlang="multiple" 
	ms.topic="article" 
	ms.tgt_pltfrm="na" 
	ms.workload="big-compute" 
	ms.date="02/02/2015" 
	ms.author="yidingz, kabatta"/>


<!--The next line, with one pound sign at the beginning, is the page title--> 
# Azure Batch の API の基本

Azure Batch サービスは、スケーラブルな分散計算を実現するジョブ スケジューリング フレームワークを提供します。Batch サービスは、異なるクラスターやデータ センターに配置されている仮想マシンのセットを Azure に保持します。Batch サービスは、これらの VM の指定されたコレクションで 1 つまたは複数のプログラムを実行して分散計算を実行します。これらのプログラムは、オンデマンドで実行することも、特定の時刻に実行するようにスケジュールすることもできます。Batch サービスは、これらの VM を管理して、お客様から指定されたリソース要件、仕様、および制約に従って計算タスクを実行します。

Batch サービスを使用すると、コンピューティング リソースをキューイング、スケジュール設定、割り当て、および管理するためのコードを記述する必要がなくなります。これにより、お客様は特定のアプリケーションに注力でき、基になるプラットフォームのジョブのスケジュールやリソース管理の複雑さについて心配する必要がなくなります。さらに、処理する必要があるデータへのアクセスに加えて、これらのジョブの場所を最適化できるようになります。

Batch サービスを使用して実現できるシナリオのいくつかを次に示します。

- 計算負荷の高い並列処理

- ファイルの毎日のクリーンアップ

- バッチ処理

ここでは、Batch サービスの詳細について次の各セクションで詳しく説明していきます。

- [Batch サービスのリソース](#resource)

- [Batch サービスのワークフロー](#workflow)

- [ファイルとディレクトリ](#file)

- [アプリケーションのスケーリング](#scaling)

- [アプリケーションの証明書](#cert)

- [スケジューリング優先順位](#scheduling)

- [タスクの環境設定](#environment)

## <a name="resource"></a> Batch サービスのリソース

Batch サービスを使用する際は次のリソースを使用します。

- [アカウント](#account)

- [タスク仮想マシン](#taskvm)

- [プール](#pool)

- [作業項目](#workitem)

- [Job](#job)

- [タスク](#task)

### <a name="account"></a>アカウント

Batch アカウントは、Batch サービス内で一意に識別されるエンティティです。すべての処理は、Batch アカウントを介して行われます。Batch サービスで処理を実行するには、アカウントの名前とキーが必要になります。現時点では、新しいアカウントを作成するには、Azure Batch チームにお問い合わせいただく必要があります。アカウントが作成されると、キーが支給されます。

### <a name="taskvm"></a>タスク仮想マシン

タスク仮想マシン (TVM) は、アプリケーションの特定のワークロード専用の Azure VM です。TVM のサイズによって、CPU コアの数、メモリ容量、および TVM に割り当てられるローカル ファイル システムのサイズが決まります。TVM には、「[Virtual Machine and Cloud Service Sizes for Azure (Azure の仮想マシンとクラウド サービスのサイズ)](http://msdn.microsoft.com/library/dn197896.aspx)」に説明されているように、サイズが "小"、"大"、または "特大" の仮想マシンを使用できます。

TVM で実行できるプログラムの種類には、実行可能ファイル (.exe)、コマンド ファイル (.cmd)、バッチ ファイル (.bat)、およびスクリプト ファイルが含まれます。また、TVM は、次の属性を持ちます。

- ファイル システム フォルダー。タスクに固有のフォルダーと共有のフォルダーがあります。

- Stdout.txt ファイルと Stderr.txt ファイル。これらのファイルは、タスクに固有のフォルダーに書き込まれます。

- 処理のための環境変数。

- アクセスを制御するために構成されるファイアウォール設定。

### <a name="pool"></a>プール

プールは、アプリケーションが実行される TVM のコレクションです。プールはお客様が作成できるほか、お客様が実行する操作を指定するときに Batch サービスによって自動的にプールが作成されるように設定することもできます。お客様は、アプリケーションのニーズを満たすプールを作成して管理できます。プールは、そのプールを作成した Batch アカウントのみが使用できます。1 つの Batch アカウントで複数のプールを持つことができます。

プールに追加されたすべての TVM に対し、一意の名前と関連 IP アドレスが割り当てられます。TVM をプールから削除すると、オペレーティング システム、すべてのローカル ファイル、その名前、およびその IP アドレスに加えられた変更は失われます。TVM をプールから削除すると、その有効期間が終了します。

プール内の TVM 間の通信を許可するようにプールを構成できます。プールに対してプール内通信が要求された場合、Batch サービスは、プール内の各 TVM で 1100 を超えるポートを有効にします。プール内の各 TVM は、このポート範囲への着信接続およびプール内の他の TVM からの着信接続のみを許可および制限するように構成されます。アプリケーションが TVM 間の通信を必要としない場合、Batch サービスは、異なるクラスターまたはデータ センターにまたがる大量の TVM をプールに割り当てることにより、より大規模な並列処理を実現できます。

プールを作成するときに次の属性を指定できます。

- プール内の TVM のサイズ。

- TVM 上で実行するオペレーティング システム ファミリおよびバージョン。

- プールで使用できるようにする TVM の数。

- プールのスケーリング ポリシー。

- プール内の TVM の通信状態。

- プール内の TVM の開始タスク。

プールを作成するときに、プールを関連付けるストレージ アカウントを指定できます。Batch サービスにより、ネットワーク接続および帯域幅容量がより優れているデータ センターの TVM が指定されたストレージ アカウントに割り当てられます。これにより、ワークロードがより効率的にデータにアクセスできるようになります。

### <a name="workitem"></a>作業項目

作業項目は、プール内の TVM 上での計算の実行方法を指定します。作業項目には、次の構成項目が含まれます。

1.TVM 上で処理を実行するプログラム。

2.プログラムのコマンドライン パラメーター。

3.計算の優先順位。

4.計算のスケジュール (計算を再実行するかどうかの定義を含みます)。

作業項目は常にプールに割り当てられます。対象のプールには既に存在しているプールを使用できるほか、作業項目を作成するときにプールを自動的に作成することもできます。

### <a name="job"></a>Job

ジョブは、作業項目の実行中のインスタンスです。ジョブは、タスクのコレクションで構成されます。Batch サービスは、作業項目の構成に基づいてジョブをインスタンス化します。ジョブは、作業項目に関連付けられているプールの TVM を使用します。

### <a name="task"></a>タスク

タスクは、TVM 上で実行される、ジョブに関連付けられた計算の単位です。タスクは、次のリソースを使用します。

- 作業項目で指定されたプログラム。

- 処理するデータを含むリソース ファイル。これらのファイルは BLOB ストレージから TVM に自動的にコピーされます。詳細については、「ファイルとディレクトリ」を参照してください。

- プログラムで必要とされる環境設定。詳細については、「タスクの環境設定」を参照してください。

- 計算に適用される制約。たとえば、タスクの実行が許可される最大時間、タスクの実行が失敗した場合に再試行する最大回数、作業ディレクトリにファイルを保持する最大時間などです。

TVM で計算を実行するために定義できるタスクに加えて、Batch サービスによって提供される次の特殊なタスクを使用できます。

- [開始タスク](#starttask)

- [ジョブ マネージャー タスク](#jobmanagertask)

#### <a name="starttask"></a>開始タスク

開始タスクをプールに関連付けることによって、プール内の TVM のオペレーティング システムを構成できます。開始タスクで実行できる操作の例として、ソフトウェアのインストールやバックグラウンド プロセスの起動があります。開始タスクは、プール内に保持されている限り、TVM が起動されるたびに実行されます。

開始タスクは、プールの追加操作の要求本文に XML セクションを追加することによって定義します。次の例は、開始タスクの基本的な定義を示しています。

	{
		"commandLine":"mypoolsetup.exe",
		"resourceFiles":
		[
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"mypoolsetup.exe"
			},
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"myapp2.exe"
			}
		],
		"maxTaskRetryCount":0
	}


#### <a name="jobmanagertask"></a>ジョブ マネージャー タスク

ジョブ マネージャー タスクは、他のすべてのタスクの前に開始されます。ジョブ マネージャー タスクには、次の利点があります。

- ジョブの作成時に Batch サービスによって自動的に作成されます。

- ジョブ内の他のタスクの前にスケジュールされます。

- ジョブ マネージャー タスクに関連付けられた TVM は、プールが縮小されるときに最後にプールから削除されます。

- 再起動する必要がある場合に最も高い優先順位が割り当てられます。アイドル状態の TVM を使用できない場合、Batch サービスは、この TVM が実行する余地を確保するためにプール内のいずれかの実行中のタスクを終了する場合があります。

- ジョブ マネージャー タスクの終了を、ジョブ内のすべてのタスクの終了に関連付けることができます。

ジョブ内のジョブ マネージャー タスクは、他のジョブ内のタスクよりも優先されません。ジョブ間では、ジョブ レベルの優先順位のみが適用されます。ジョブ マネージャー タスクは、作業項目の追加操作の要求本文に XML セクションを追加することによって定義します。次の例は、ジョブ マネージャー タスクの基本的な定義を示しています。

	{
		"name":"jmTask",
		"commandLine":"myapp1.exe",
		"resourceFiles":
		[
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp1.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"myapp1.exe"
			},
			{
				"blobSource":"http://account.blob.core.windows.net/container/myapp2.exe?st=2013-08-09T08%3a49%3a37.0000000Z&se=2013-08-10T08%3a49%3a37.0000000Z&sr=c&sp=d&si=YWJjZGTVMZw%3d%3d&sig= %2bSzBm0wi8xECuGkKw97wnkSZ%2f62sxU%2b6Hq6a7qojIVE%3d",
				"filePath":"myapp2.exe"
			}
		],
		"taskConstraints":
		{
			"maxWallClockTime":"PT1H",
			"maxTaskRetryCount":0,
			"retentionTime":"PT1H"
		},
		"killJobOnCompletion":true,
		"runElevated":false,
		"runExclusive":true
	}




## <a name="workflow"></a>Batch サービスのワークフロー

Batch サービスを使用するには、Batch アカウントが必要です。計算をスケジュールするには、サービスの複数のリソースを使用します。Batch サービスによる分散計算シナリオを作成する場合は、次の基本的なワークフローを使います。

1.Azure ストレージ アカウントに分散計算シナリオで使用するファイルをアップロードします。これらのファイルは、Batch サービスがアクセスできるように、ストレージ アカウントに配置する必要があります。これらのファイルは、Batch サービスによってタスクの実行時に TVM に読み込まれます。

2.依存バイナリ ファイルをストレージ アカウントにアップロードします。バイナリ ファイルとは、タスクによって実行されるプログラムと依存アセンブリを表します。これらのファイルはストレージからもアクセスできる必要があります。これらのファイルは、TVM に読み込まれます。

3.TVM のプールを作成します。プールの作成時に、使用するタスク仮想マシンのサイズを割り当てることができます。タスクを実行すると、このプールから TVM が割り当てられます。

4.作業項目を作成します。作業項目を作成すると、ジョブが自動的に作成されます。作業項目を使って、タスクのジョブを管理できます。

5.作業項目にタスクを追加します。各タスクは、アップロードされたプログラムを使用して、アップロードされたファイルの情報を処理します。

6.出力の結果を監視します。

## <a name="files"></a>ファイルとディレクトリ

各タスクは作業ディレクトリを持ちます。この作業ディレクトリ内に、タスクによって実行されるプログラム、タスクによって処理されるデータ、およびタスクによって実行された処理の出力を格納するためのディレクトリおよびファイルが 0 個以上作成されます。これらのディレクトリとファイルは、ジョブの実行中に他のタスクから使用できます。TVM 上のすべてのタスク、ファイル、およびディレクトリは、単一のユーザー アカウントによって所有されます。

Batch サービスは、TVM 上のファイル システムの一部をルート ディレクトリとして公開します。TVM のルート ディレクトリは、WATASK\_TVM\_ROOT\_DIR 環境変数を介してタスクで利用できます。環境変数の使用に関する詳細については、「タスクの環境設定」を参照してください。

ルート ディレクトリには、次のサブディレクトリが含まれます。

- **タスク** - TVM 上で実行されるタスクに属しているすべてのファイルが格納されます。Batch サービスにより、それぞれのタスクに対して、%WATASK\_TVM\_ROOT\_DIR%/tasks/workitemName/jobName/taskName/ 形式の一意のパスを持つ作業ディレクトリが作成されます。このディレクトリでは、タスクへの読み取り/書き込みアクセスが可能です。タスクは、このディレクトリの下で、ファイルを作成、読み取り、更新、および削除できます。このディレクトリは、タスクに対して指定された RetentionTime 制約に基づいて保持されます。

- **共有** - アカウントのすべてのタスクの共有ディレクトリです。TVM 上で、共有ディレクトリは %WATASK\_TVM\_ROOT\_DIR%/shared です。このディレクトリでは、タスクへの読み取り/書き込みアクセスが可能です。タスクは、このディレクトリの下で、ファイルを作成、読み取り、更新、および削除できます。

- **開始** - この場所は、開始タスクによって作業ディレクトリとして使用されます。開始タスクを起動するために Batch サービスによってダウンロードされるファイルもすべてこのディレクトリに格納されます。TVM 上で、開始ディレクトリは %WATASK\_TVM\_ROOT\_DIR%/start です。タスクは、このディレクトリの下で、ファイルを作成、読み取り、更新、および削除できます。開始タスクは、このディレクトリを使用して、オペレーティング システムを構成できます。

TVM をプールから削除すると、TVM に格納されているすべてのファイルが削除されます。

## <a name="scaling"></a>アプリケーションのスケーリング

アプリケーションのスケールを簡単かつ自動的に拡大または縮小して、必要な計算ニーズに対応できます。現在のワークロードとリソース使用状況統計に従って、プール内の TVM の数を動的に調整できます。また、自動的にスケーリングを行うように構成することにより、アプリケーションの全体的な実行コストを最適化することもできます。プールの作成時にスケーリング設定を指定できます。また、いつでも構成を更新することができます。

アプリケーションの自動スケーリングを指定するには、一式のスケーリング式を使用します。式を使用して、次のスケーリング間隔のプールに含まれる TVM の数を決定できます。たとえば、プールでのスケジュール対象として大量のタスクを送信する必要があるとします。この場合、現在の保留中のタスクの数とタスクの完了率に基づいてプールのサイズを指定するスケーリング式をプールに割り当てることができます。Batch サービスは、定期的に式を評価し、ワークロードに基づいてプールのサイズを変更します。

式には次のメトリックを使用できます。

- **時間メトリック** - 指定した時間数内で 5 分おきに収集された統計情報に基づきます。

- **リソース メトリック** - CPU 使用量、帯域幅使用量、メモリ使用量、および TVM の数に基づきます。

- **タスク メトリック** - タスクの状態 (保留中、アクティブ、完了) に基づきます。

アプリケーションの自動スケーリングの詳細については、「Configure Autoscaling of Task Virtual Machines (タスク仮想マシンの自動スケーリングの構成)」を参照してください。

## <a name="cert"></a>アプリケーションの証明書

通常、機密情報を暗号化するときは証明書を使用する必要があります。証明書は TVM にインストールすることができます。暗号化された機密情報は、コマンドライン パラメーターでタスクに渡されるか、またはリソースの 1 つに埋め込まれ、インストールされた証明書を使用して復号化できます。機密情報の一例としてストレージ アカウントのキーがあります。

Batch アカウントに証明書を追加するには、証明書の追加操作を使用します。次に、新規または既存のプールに証明書を関連付けることができます。証明書がプールに関連付けられると、Batch サービスは、プール内の各 TVM に証明書をインストールします。Batch サービスは、TVM の起動時に、いずれかのタスク (開始タスク、ジョブ マネージャー タスクも含まれます) を起動する前に、適切な証明書をインストールします。

## <a name="scheduling"></a>スケジューリング優先順位

作業項目を作成するときに優先順位を割り当てることができます。作業項目の下の各ジョブは、この優先順位で作成されます。Batch サービスは、ジョブの優先順位値を使用して、アカウント内のジョブ スケジューリングの順序を決定します。優先順位として、-1000 ～ 1000 の値を使用します。-1000 は最も低い優先順位を示し、1000 は最も高い優先順位を示します。ジョブの優先順位を更新するには、ジョブの更新操作を使用します。

同じアカウント内で、優先順位の高いジョブは優先順位の低いジョブよりも優先的にスケジュールされます。あるアカウントの優先順位値が高いジョブが、異なるアカウントの優先順位値が低い別のジョブよりも優先的にスケジュールされることはありません。

異なるプールのジョブ スケジューリングは独立しています。異なるプール間では、関連するそのプールでアイドル状態の TVM が不足している場合、優先順位の高い方のジョブが最初にスケジュールされるとは限りません。同じプール内のジョブの場合、優先順位が同じであれば、スケジュールされる可能性は等しくなります。

## <a name="environment"></a>タスクの環境設定

タスクのコンテキストで使用可能な環境設定を指定できます。開始タスクおよびジョブで実行されるタスクの環境設定は、タスクの追加操作またはタスクの更新操作の要求本文に XML セクションを追加することによって定義します。

次の例は、環境設定の定義を示しています。

ジョブでスケジュールされるすべてのタスクに対し、特定の環境変数のセットが Batch サービスによって設定されます。次の表に、すべてのタスクに対して Batch サービスによって設定される環境変数を示します。

<table>
  <tr>
   <th>環境変数の名前
   </th>
   <th>
   説明
   </th>
  </tr>
 <tr>
  <td>
  WATASK_ ACCOUNT_NAME
  </td>
  <td>
  タスクが所属するアカウントの名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_WORKITEM_NAME
  </td>
  <td >タスクが所属する作業項目の名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_JOB_NAME
  </td>
  <td >タスクが所属するジョブの名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TASK_NAME
  </td>
  <td >現在のタスクの名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_POOL_NAME
  </td>
  <td >タスクが実行されているプールの名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_NAME
  </td>
  <td >タスクが実行されている TVM の名前。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_TVM_ROOT_DIR
  </td>
  <td >TVM 上のルート ディレクトリの完全パス。
  </td>
 </tr>
 <tr>
  <td>
  WATASK_PORTRANGE_LOW
  WATASK_PORTRANGE_HIGH
</td>
<td>
  プール間通信が有効な場合にタスクが通信用に使用できるポートの範囲 (両端でその値を含みます)。
</td>
</table>


**注** 

これらのシステム定義の変数を上書きすることはできません。

環境設定の値を取得するには、タスクの取得操作を使用します。

<!--HONumber=46--> 
