<properties 
	pageTitle="Live Connect によるアプリケーションの認証 (JavaScript)" 
	description="Windows ストア アプリケーションから、Azure Mobile Services で Live Connect シングル サインオンを使用する方法を示します。" 
	services="mobile-services" 
	documentationCenter="windows" 
	authors="ggailey777" 
	manager="dwrede" 
	editor=""/>

<tags 
	ms.service="mobile-services" 
	ms.workload="mobile" 
	ms.tgt_pltfrm="mobile-windows-store" 
	ms.devlang="javascript" 
	ms.topic="article" 
	ms.date="04/08/2015" 
	ms.author="glenga"/>

# Microsoft アカウントを使用して、クライアントによって管理される認証で Windows ストア アプリを認証します。

[AZURE.INCLUDE [mobile-services-selector-single-signon](../includes/mobile-services-selector-single-signon.md)] 

##概要
このトピックでは、Windows ストア アプリケーションから Azure モバイル サービスのユーザーを認証する方法を示します。このチュートリアルでは、Live Connect を使用して、クイック スタート プロジェクトに認証を追加します。Live Connect によって正常に認証されると、ログインしたユーザーの名前が認識され、ユーザー ID 値が表示されます。

>[AZURE.NOTE]このチュートリアルでは、クライアントによって管理される認証および Live SDK を使用した場合の利点について説明します。これにより、モバイル サービスに既にログオンしているユーザーの認証が容易になります。OneDrive のようなリソースにもアプリがアクセスできるようにするために、追加のスコープを要求することもできます。サービスによって管理される認証では、より汎用的なエクスペリエンスを提供し、複数の認証プロバイダーをサポートします。サービスによって管理される認証の詳細については、トピック「[アプリへの認証の追加](mobile-services-windows-store-javascript-get-started-users.md)」を参照してください。

このチュートリアルには、次のものが必要です。

+ [Windows 向け Live SDK]
+ Microsoft Visual Studio 2012 Express for Windows 8 RC 以降のバージョン
+ また、最初にチュートリアル「[既存のアプリケーションへの Mobile Services の追加]」を完了しておく必要があります。

##認証で Microsoft アカウントを使用するためのアプリケーションの登録

ユーザーを認証できるようにするには、Microsoft アカウント デベロッパー センターでアプリケーションを登録する必要があります。この登録をモバイル サービスと接続する必要があります。Microsoft アカウントの登録を作成し、モバイル サービスに接続するには、次のトピックの手順を完了してください。

+ [Microsoft アカウント ログインを使用するためのアプリケーションの登録](mobile-services-how-to-register-microsoft-authentication.md)

##<a name="permissions"></a>アクセス許可を、認証されたユーザーだけに制限する

次に、サインインしたユーザーのみがリソース (この場合は *TodoItems* テーブル) にアクセスできるようにリソースへのアクセスを制限する必要があります。

[AZURE.INCLUDE [mobile-services-restrict-permissions-windows](../includes/mobile-services-restrict-permissions-windows.md)] 

##<a name="add-authentication"></a>アプリケーションに認証を追加する

最後に、Live SDK を追加し、これを使用してアプリケーションでユーザーを認証します。

1. **ソリューション エクスプローラー**でソリューションを右クリックし、[**NuGet パッケージの管理**] を選択します。

2. 左側のウィンドウで、[**オンライン**] カテゴリを選択し、**LiveSDK** を探します。**LiveSDK** パッケージで [**インストール**] をクリックし、すべてのプロジェクトを選択して、使用許諾契約に同意します。

  	Live SDK がソリューションに追加されます。

3. default.html プロジェクト ファイルを開き、次の `<script>` 要素を `<head>` 要素に追加します。

        <script src="/js/wl.js"></script>

5. **app.OnActivated** メソッド オーバーロードで、**refreshTodoItems** メソッドの呼び出しを次のコードに置き換えます。
	
        // Set the mobileClient variable to client variable generated by the tooling.
        var mobileClient = <yourClient>;

        var session = null;
        var login = function () {
            return new WinJS.Promise(function (complete) {
                WL.login({ scope: "wl.basic" }).then(function (result) {
                    session = result.session;

                    WinJS.Promise.join([
                        WL.api({ path: "me", method: "GET" }),
                        mobileClient.login(result.session.authentication_token)
                    ]).done(function (results) {
                        // Build the welcome message from the Microsoft account info.
                        var profile = results[0];                            
                        var title = "Welcome " + profile.first_name + "!";
                        var message = "You are now logged in as: "
                            + mobileClient.currentUser.userId;
                        var dialog = new Windows.UI.Popups.MessageDialog(message, title);
                        dialog.showAsync().then(function () {
                            // Reload items from the mobile service.
                            refreshTodoItems();
                        }).done(complete);
                        
                    }, function (error) {

                    });
                }, function (error) {
                    session = null;
                    var dialog = new Windows.UI.Popups.MessageDialog("You must log in.", "Login Required");
                    dialog.showAsync().done(complete);
                });
            });
        }

        var authenticate = function () {
            // Block until sign-in is successful.
            login().then(function () {
                if (session === null) {
                    // Authentication failed, try again.
                    authenticate();
                }
            });
        }

		// Initialize the Live client.
        WL.init({
            redirect_uri: mobileClient.applicationUrl
        });

		// Start the sign-in process.
        authenticate();

    これにより、Live Connect クライアントが初期化され、新しいログイン要求が Microsoft アカウントに送信され、返された認証トークンが Mobile Services に送信され、サインイン済みのユーザーに関する情報が表示されます。

	>[AZURE.NOTE]可能であれば、アプリケーションを実行するたびに Live Connection 認証トークンまたは Mobile Services 認証トークンをリクエストしないようにします。これは非効率であるだけなく、多くの顧客が同時にアプリケーションを開始すると、使用率に関連した問題が発生する場合があります。よって、トークンをキャッシュし、キャッシュされたモバイル サービス トークンをまず試してから、**LoginWithMicrosoftAccountAsync**を呼び出す方が効果的です。このトークンのキャッシュ方法の詳細については、「[モバイル サービスでの認証の使用](mobile-services-windows-store-javascript-get-started-users.md#tokens)」を参照してください。
	
7. 上記コードの先頭行にある値 `<yourClient>` を、プロジェクトをモバイル サービスに接続したときに追加された .js ファイル内に定義されている変数と交換します。
		
8. F5 キーを押してアプリケーションを実行し、Microsoft アカウントを使用してサインインします。

   	サインインに成功すると、アプリケーションはエラーなしで実行されます。また、Mobile Services を照会してデータを更新できるようになります。

## <a name="next-steps"> </a>次のステップ

[スクリプトを使用したユーザーの認証]に関する次のチュートリアルでは、認証されたユーザーに基づいてモバイル サービスによって提供されるユーザー ID 値を受け取り、それを使用して、モバイル サービスから返されたデータをフィルター処理します。他の ID プロバイダーを認証に使用する方法については、「[モバイル サービスでの認証の使用]」を参照してください。

<!-- Anchors. -->
[Register your app for authentication and configure Mobile Services]: #register
[Restrict table permissions to authenticated users]: #permissions
[Add authentication to the app]: #add-authentication
[Next Steps]: #next-steps

<!-- Images. -->

<!-- URLs. -->
[Submit an app page]: http://go.microsoft.com/fwlink/p/?LinkID=266582
[My Applications]: http://go.microsoft.com/fwlink/p/?LinkId=262039
[Windows 向け Live SDK]: http://go.microsoft.com/fwlink/p/?LinkId=262253
[既存のアプリケーションへの Mobile Services の追加]: mobile-services-windows-store-javascript-get-started-data.md
[モバイル サービスでの認証の使用]: mobile-services-windows-store-javascript-get-started-users.md
[スクリプトを使用したユーザーの認証]: mobile-services-windows-store-javascript-authorize-users-in-scripts.md

[Azure Management Portal]: https://manage.windowsazure.com/

<!--HONumber=54-->