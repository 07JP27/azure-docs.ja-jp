Azure エンドポイントに対するアプローチは、クラシック デプロイメント モデルと Resource Manager デプロイメント モデルとで若干異なります。現在のモデルでは、ネットワーク フィルターを作成して VM との間のトラフィック フローを柔軟に制御できるようになっており、クラシック デプロイメント モデルの場合のようなシンプルなエンドポイントだけでなく、複雑なネットワーク環境を作成することもできます。この記事では、ネットワーク セキュリティ グループの概要、クラシック エンドポイントを使用する場合との違い、このようなフィルタリング規則の作成について説明し、デプロイメント シナリオの例を示します。


## Resource Manager デプロイメントの概要
クラシック デプロイメント モデルのエンドポイントは、ネットワーク セキュリティ グループとアクセス制御リスト (ACL) 規則に置き換えられました。ネットワーク セキュリティ グループの ACL 規則は、次の手順によって簡単に実装できます。

- ネットワーク セキュリティ グループの作成
- トラフィックを許可または拒否するように、ネットワーク セキュリティ グループの ACL 規則を定義する
- ネットワーク セキュリティ グループをネットワーク インターフェイスまたは仮想ネットワーク サブネットに割り当てる

ポート フォワーディングも実行する場合は、VM の前にロード バランサーを配置し、NAT 規則を使用する必要があります。ロード バランサーと NAT 規則は、次の手順によって簡単に実装できます。

- ロード バランサーの作成
- バックエンド プールを作成し、そのプールに VM を追加する
- 必要なポート フォワーディング用に NAT 規則を定義する
- その NAT 規則を VM に割り当てる


## ネットワーク セキュリティ グループの概要
ネットワーク セキュリティ グループは新しい機能の 1 つで、特定のポートやサブネットに VM へのアクセスを許可するセキュリティ層を提供します。通常は、この層が VM と外部との間に常に配置されるようにネットワーク セキュリティ グループを作成します。ネットワーク セキュリティ グループは、仮想ネットワーク サブネットまたは VM の特定のネットワーク インターフェイスに適用できます。ACL 規則は、エンドポイントに対してではなく、ネットワーク セキュリティ グループに対して作成します。この ACL 規則により、特定のポートを転送するエンドポイントを作成する場合よりも、きめ細かく制御できます。ネットワーク セキュリティ グループの詳細については、[こちら](../articles/virtual-network/virtual-networks-nsg.md)を参照してください。

> [AZURE.TIP] 複数のサブネットまたはネットワーク インターフェイスにネットワーク セキュリティ グループを割り当てることができます。1 対 1 で対応しているわけではないため、共通の ACL 規則セットを備えたネットワーク セキュリティ グループを 1 つ作成し、複数のサブネットまたはネットワーク インターフェイスに適用できます。また、サブスクリプション内のすべてのリソースに ([ロール ベースのアクセス制御](../articles/active-directory/role-based-access-control-what-is.md)に基づいて) ネットワーク セキュリティ グループを適用できます。


## Load Balancer の概要
クラシック デプロイメント モデルの場合、すべてのネットワーク アドレス変換 (NAT) とポート フォワーディングが Azure のクラウド サービスで実行されます。エンドポイントを作成する際は、公開する外部ポートと、トラフィックの転送先である内部ポートを指定します。ネットワーク セキュリティ グループでは、この同じ NAT とポート フォワーディングを自身では実行しません。

このようなポート フォワーディング用の NAT 規則を作成できるようにするには、Azure Load Balancer をリソース グループに作成します。この場合も、Load Balancer では、必要に応じて特定の VM のみに適用するといった、きめ細かい制御が可能です。Azure Load Balancer の NAT 規則はネットワーク セキュリティ グループの ACL 規則と連動し、クラウド サービスのエンドポイントを使用して達成できる場合よりも、はるかに柔軟に、きめ細かく制御できます。Load Balancer の詳細については、「[Azure Load Balancer の概要](../articles/load-balancer/load-balancer-overview.md)」を参照してください。


## ネットワーク セキュリティ グループの ACL 規則
ACL 規則を使用すると、どのトラフィックに VM との間のフローを許可するかを、特定のポート、ポート範囲、またはプロトコルに基づいて定義できます。規則は、個々の VM またはサブネットに割り当てられます。次のスクリーンショットは、一般的な Web サーバーの ACL 規則の例を示しています。

![List of Network Security Group ACL rules](./media/virtual-machines-common-endpoints-in-resource-manager/example-acl-rules.png)

ACL 規則は、指定した優先度メトリックに基づいて適用されます。値が大きいほど、優先度は低くなります。各ネットワーク セキュリティ グループには、Azure ネットワーク トラフィックのフローを処理するように設計された 3 つの既定の規則があります。明示的な `DenyAllInbound` が最後の規則として指定されています。既定の ACL 規則は、ユーザーが作成した規則に干渉しないように優先度が低く設定されています。


## ネットワーク セキュリティ グループの割り当て
ネットワーク セキュリティ グループは、サブネットまたはネットワーク インターフェイスに割り当てます。この方法により、必要な細かさで ACL 規則を特定の VM のみに適用することも、共通の ACL 規則セットをサブネットに含まれるすべての VM に適用することもできます。

![Apply NSGs to network interfaces or subnets](./media/virtual-machines-common-endpoints-in-resource-manager/apply-nsg-to-resources.png)

ネットワーク セキュリティ グループの動作は、サブネットとネットワーク インターフェイスのどちらに割り当てられていても変わりません。一般的なデプロイメント シナリオでは、サブネットに接続しているすべての VM が確実に準拠するように、ネットワーク セキュリティ グループはサブネットに割り当てられます。リソースへのネットワーク セキュリティ グループの適用方法の詳細については、[こちら](../virtual-nework/virtual-networks-nsg.md#associating-nsgs)を参照してください。


## ネットワーク セキュリティ グループの既定の動作
ネットワーク セキュリティ グループを作成する方法と状況によっては、既定の規則が TCP ポート 3389 への RDP アクセスを許可するように作成される場合があります。Linux VM の場合は、TCP ポート 22 での SSH アクセスが許可されます。この自動 ACL 規則は、次の状況に該当する場合に作成されます。

- ポータルで Windows VM を作成し、ネットワーク セキュリティ グループを作成する際に既定のアクションをそのまま使用すると、TCP ポート 3389 (RDP) を許可する ACL 規則が作成されます。
- ポータルで Linux VM を作成し、ネットワーク セキュリティ グループを作成する際に既定のアクションをそのまま使用すると、TCP ポート 22 (SSH) を許可する ACL 規則が作成されます。

上記以外の状況では、このような既定の ACL 規則は作成されません。適切な ACL 規則を作成しないと、VM に接続することはできません。作成する際は、一般的に、次のようなアクションを行います。

- ポータルを使用して、VM の作成とは別のアクションとして、ネットワーク セキュリティ グループを作成する。
- PowerShell、Azure CLI、Rest API などを使用して、プログラム的にネットワーク セキュリティ グループを作成する。
- VM を作成し、適切な ACL 規則がまだ定義されていない既存のネットワーク セキュリティ グループに割り当てる。

上記のすべてのケースで、適切なリモート管理接続を許可する ACL 規則を VM 用に作成する必要があります。


## ネットワーク セキュリティ グループが設定されていない VM の既定の動作
ネットワーク セキュリティ グループを作成しなくても、VM は作成できます。このような場合は、ACL 規則を作成せずに、RDP または SSH を使用して VM に接続することができます。同様に、ポート 80 で Web サービスをインストールした場合は、自動的にそのサービスにリモートからアクセスできます。VM のポートはすべて開かれます。

> [AZURE.NOTE] この場合でも、リモート接続ができるように、パブリック IP アドレスを VM に割り当てる必要があります。サブネットまたはネットワーク インターフェイスにネットワーク セキュリティ グループを設定していない場合、VM は外部トラフィックに対して公開されません。ポータルで VM を作成する場合の既定のアクションでは、パブリック IP が新規作成されます。PowerShell、Azure CLI、Resource Manager テンプレートなど、他の方法で VM を作成する場合は、明示的に要求しない限り、パブリック IP は自動的には作成されません。ポータルでの既定のアクションではネットワーク セキュリティ グループも作成されるため、ネットワーク フィルター処理が設定されずに VM が公開されることがないようにしてください。


## Load Balancer と NAT 規則について
クラシック デプロイメント モデルの場合、ポート フォワーディングも実行するエンドポイントを作成できます。クラシック デプロイメント モデルで VM を作成すると、RDP または SSH 用の ACL 規則が自動的に作成されますが、TCP ポート 3389 または TCP ポート 22 は外部に公開されません。代わりに、適切な内部ポートにマッピングされた値の大きい TCP ポートが公開されます。また、TCP ポート 4280 で Web サーバーを外部に公開するなど、独自の ACL 規則を同様の方法で作成することもできます。クラシック ポータルでは、これらの ACL 規則とポート マッピングが、次のスクリーンショットのように表示されます。

![Port-forwarding with Classic endpoints](./media/virtual-machines-common-endpoints-in-resource-manager/classic-endpoints-port-forwarding.png)

ネットワーク セキュリティ グループでは、このポート フォワーディング機能がロード バランサーによって対処されます。Azure のロード バランサーの詳細については、「[Azure Load Balancer の概要](../articles/load-balancer/load-balancer-overview.md)」を参照してください。ポータルから取得した次のスクリーンショットは、VM の内部 TCP ポート 22 に対して TCP ポート 4222 のポート フォワーディングを実行する NAT 規則がロード バランサーに設定されている例を示しています。

![Load balancer NAT rules for port-forwarding](./media/virtual-machines-common-endpoints-in-resource-manager/load-balancer-nat-rules.png)

> [AZURE.NOTE] ロード バランサーを実装する際、通常、VM 自体にパブリック IP アドレスを割り当てることはしません。代わりに、ロード バランサーにパブリック IP アドレスを割り当てます。この場合も、VM との間のトラフィック フローを定義するネットワーク セキュリティ グループと ACL 規則を作成する必要があります。ロード バランサーの NAT 規則では、ロード バランサーで許可されるポートと、バックエンド VM に分散する方法しか定義されません。そのため、トラフィックがロード バランサーを通過するための NAT 規則を作成した後、トラフィックが実際に VM に到達することを許可するネットワーク セキュリティ グループの ACL 規則を作成する必要があります。

<!---HONumber=AcomDC_0810_2016-->