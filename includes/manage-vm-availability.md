<properties writer="kathydav" editor="tysonn" manager="jeffreyg" /> 

#仮想マシンの可用性管理#

アプリケーションの可用性を確保するために、冗長性を実現する複数の仮想マシンの使用を強くお勧めします。冗長性を実現するには、同じ機能やロールを実行するように複数の仮想マシンを構成します。このような冗長性は、保証されたレベルのサービスを受けるために必要になります。また、依存関係を必ず考慮してください。たとえば、仮想マシン "IIS1" が仮想マシン "SQL1" によって提供されるサービスに依存する場合、サービスの中断を回避するために、仮想マシン "SQL1" の冗長性が "SQL2" によって実現されます。サービス レベル アグリーメントの詳細については、「[Service Level Agreements (サービス レベル アグリーメント)](http://www.windowsazure.com/ja-jp/support/legal/sla/)」の「Cloud Services, Virtual Machines and Virtual Network (クラウド サービス、仮想マシン、仮想ネットワーク)」のセクションを参照してください。

複数の仮想マシンを使用する方法によって、ローカル ネットワークの障害時やローカル ハード ディスクの障害時、予定されたプラットフォーム停止時にもアプリケーションを確実に使用できるようになります。

複数の仮想マシンが使用されているアプリケーションの可用性を管理するには、その仮想マシンを可用性セットに追加します。可用性セットは、障害ドメインと更新ドメインに直接関連します。Azure の障害ドメインは、サーバー ラックのネットワーク スイッチ、電源装置などの単一障害点を避けることで定義されます。実際、障害ドメインは物理サーバーのラックに相当します。複数の仮想マシンがクラウド サービスで接続されている場合は、可用性セットを使用して、さまざまな障害ドメインに仮想マシンを配置することができます。次の図に、2 つの可用性セットを示します。この各セットには 2 台の仮想マシンが含まれます。

![更新ドメイン](./media/manage-vm-availability/UpdateDomains.png)

Azure では、アプリケーションのインスタンスをホストするオペレーティング システムが定期的に更新されます。更新が適用されると、仮想マシンがシャットダウンします。更新ドメインを使用すると、すべての仮想マシン インスタンスが同時に更新されることがなくなります。複数の仮想マシンを可用性セットに割り当てると、その仮想マシンはさまざまな更新ドメインに確実に割り当てられます。前の図は、インターネット インフォメーション サービス (IIS) が実行されている 2 台の仮想マシンがそれぞれ個別の更新ドメインに含まれることを示しています。また、SQL Server が実行されている 2 台の仮想マシンも個別の更新ドメインに含まれます。

アプリケーションが常に利用できるように、また効率的に実行されるように、可用性セットと負荷分散エンドポイントを組み合わせて使用することをお勧めします。負荷分散されたエンドポイントの使用方法の詳細については、「[Load Balancing Virtual Machines (仮想マシンの負荷分散)][]」を参照してください。

このタスクの手順は次のとおりです。

- [ステップ 1. 仮想マシンと可用性セットを作成する] []
- [ステップ 2. 仮想マシンの作成プロセス中にそのマシンをクラウド サービスに追加し、可用性セットに割り当てる] []
- [ステップ 3. (省略可能) 前に作成された仮想マシンに対して可用性セットを作成する] []
- [ステップ 4. (省略可能) 前に作成された仮想マシンを可用性セットに追加する] []

## <a id="createset"> </a>ステップ 1. 仮想マシンと可用性セットを作成する##

仮想マシンが含まれる可用性セットを作成するには、最初の仮想マシンと可用性セットを同時に作成し、追加の仮想マシンを作成するときに、そのマシンを可用性セットに追加します。また、仮想マシンを作成してから、可用性セットを作成し、すべてのマシンをセットに追加することもできます。

**仮想マシンと可用性セットを作成するには**

1. まだサインインしていない場合は、Azure の管理ポータルにサインインします。

2. コマンド バーで、**[新規]** をクリックします。

	![仮想マシンの作成](./media/manage-vm-availability/Create.png)

3. **[仮想マシン]**、**[ギャラリーから]** の順にクリックします。


	**[仮想マシンのオペレーティング システムの選択]** ダイアログ ボックスが表示されます。
	
4. **[プラットフォーム イメージ]** からイメージを選択し、矢印をクリックして続行します。

	**[仮想マシンの構成]** ダイアログ ボックスが表示されます。

5. **[仮想マシン名]** ボックスに、仮想マシンに使用する名前を入力します。

6. **[新しいユーザー名]** に、サーバーの管理に使用する管理アカウントの名前を入力します。

7. **[新しいパスワード]** に、管理アカウントの強力なパスワードを入力します。**[パスワードの確認]** ボックスに、入力したパスワードをもう一度入力します。

8. **[サイズ]** で、仮想マシンに使用するサイズを選択します。選択するサイズは、アプリケーションが必要とするコア数に応じて変わります。

9. 矢印をクリックして続行します。

	**[仮想マシン モード]** ダイアログ ボックスが表示されます。
	
10. **[スタンドアロンの仮想マシン]** を選択します。

11.	**[DNS 名]** ボックスに、マシン用に作成されるクラウド サービスの名前を入力します。名前は 3 ～ 24 文字で、アルファベット小文字と数字を使用できます。

12.	**[ストレージ アカウント]** ボックスで、.vhd ファイルを保存するストレージ アカウントを選択します。ストレージ アカウントが自動的に作成されるように指定することもできます。自動的に作成されるストレージ アカウントはリージョンあたり 1 つだけです。この設定で作成する他のすべての仮想マシンがこのストレージ アカウントに配置されます。ストレージ アカウントは 20 個に制限されています。

13.	**[リージョン/アフィニティ グループ/仮想ネットワーク]** で、仮想マシンを含めるリージョン、アフィニティ グループ、または仮想ネットワークを選択します。アフィニティ グループの詳細については、「[About Affinity Groups for Virtual Network」(仮想ネットワークのアフィニティ グループについて)][]」を参照してください。

14. 矢印をクリックして続行します。

	**[仮想マシンのオプション]** ダイアログ ボックスが表示されます。

15. **[可用性セット]** ボックスで、**[可用性セットの作成]** を選択します。
 
16. **[可用性セット名]** ボックスに、可用性セットの名前を入力します。

17.	矢印をクリックして、仮想マシンと可用性セットを作成します。

	新しい仮想マシンのダッシュボードで **[構成]** をクリックすると、仮想マシンが新しい可用性セットのメンバーであることを確認できます。

## <a id="addmachine"> </a>ステップ 2. 仮想マシンの作成プロセス中にそのマシンをクラウド サービスに追加し、可用性セットに割り当てる##

前の手順では、仮想マシンと可用性セットを同時に作成する方法を紹介しました。ここでは、新しい仮想マシンを作成し、その仮想マシンを最初の仮想マシンのクラウド サービスに接続してから、前に作成した可用性セットに追加します。

**新しい仮想マシンを接続し、そのマシンを可用性セットに追加するには**

1. まだサインインしていない場合は、Azure の管理ポータルにサインインします。

2. コマンド バーで、**[新規]** をクリックします。

	![仮想マシンの作成](./media/manage-vm-availability/Create.png)

3. **[仮想マシン]**、**[ギャラリーから]** の順にクリックします。

	![ギャラリーから作成](./media/manage-vm-availability/CreateNew.png)

	**[仮想マシンのオペレーティング システムの選択]** ダイアログ ボックスが表示されます。これでイメージ ギャラリーからイメージを選択できます。

	
4. **[プラットフォーム イメージ]** をクリックし、使用するプラットフォーム イメージを選択し、矢印をクリックして続行します。

	**[仮想マシンの構成]** ダイアログ ボックスが表示されます。

5. **[仮想マシン名]** ボックスに、仮想マシンに使用する名前を入力します。

6. **[新しいユーザー名]** に、サーバーの管理に使用する管理アカウントの名前を入力します。

7. **[新しいパスワード]** ボックスに、仮想マシンの管理アカウントの強力なパスワードを入力します。**[パスワードの確認]** ボックスに、パスワードを再度入力します。

8. **[サイズ]** で、仮想マシンに使用するサイズを選択します。選択するサイズは、アプリケーションが必要とするコア数に応じて変わります。

9. Linux オペレーティング システムが実行されている仮想マシンについては、SSH キーでマシンを保護するように選択できます。

10.	矢印をクリックして続行します。

	**[仮想マシン モード]** ダイアログ ボックスが表示されます。

	
11. **[既存の仮想マシンに接続します]** を選択し、可用性セットの最初の仮想マシンに接続する新しい仮想マシンを作成します。可用性セットの仮想マシンを含めるクラウド サービスを選択します。

12. **[ストレージ アカウント]** ボックスで、VHD ファイルを保存するストレージ アカウントを選択します。

13. **[リージョン/アフィニティ グループ/仮想ネットワーク]** で、仮想マシンを含めるリージョンを選択します。

14. 矢印をクリックして続行します。

	**[仮想マシンのオプション]** ダイアログ ボックスが表示されます。

15. 最初の仮想マシンを作成したときに作成された可用性セットを選択します。

16. チェック マークをクリックして接続された仮想マシンを作成し、そのマシンを可用性セットに追加します。

	新しい仮想マシンのダッシュボードで **[構成]** をクリックすると、仮想マシンが新しい可用性セットのメンバーであることを確認できます。

## <a id="previousmachine"> </a>ステップ 3. (省略可能) 前に作成された仮想マシンに対して可用性セットを作成する##

仮想マシンを作成した後に可用性セットを作成し、そのマシンを追加できます。マシンのサイズと、そのマシンが可用性セットのメンバーかどうかは、仮想マシンの作成後に構成できます。

**新しい可用性セットを作成するには**

1. まだサインインしていない場合は、Azure の管理ポータルにサインインします。

2. **[仮想マシン]** をクリックし、構成する仮想マシンを選択します。

3. **[構成]** をクリックします。

4. **[可用性セット]** セクションで **[可用性セットの作成]** を選択し、セットの名前を入力します。


5. **[保存]** をクリックします。

	**注:** 可用性セットのメンバーシップの最終処理のために、仮想マシンが再起動される場合があります。

## <a id="existingset"> </a>ステップ 4. (省略可能) 前に作成された仮想マシンを可用性セットに追加する##

前に作成された可用性セットへの既存の仮想マシンの追加は簡単に行うことができます。仮想マシンを可用性セットに追加するには、その仮想マシンをセット内の他の仮想マシンと同じクラウド サービスに接続する必要があります。接続された仮想マシンの詳細については、「[How to Connect Virtual Machines in a Cloud Service (クラウド サービス内の仮想マシンを接続する方法)][]」を参照してください。

**既存の仮想マシンを可用性セットに追加するには**

1. まだサインインしていない場合は、Azure の管理ポータルにサインインします。

2. **[仮想マシン]** をクリックし、可用性セットに追加する仮想マシンを選択します。

3. **[構成]** をクリックします。

4. **[可用性セット]** セクションで、前に作成した可用性セットを選択します。

5. **[保存]** をクリックします。

	**注:** 可用性セットのメンバーシップの最終処理のために、仮想マシンが再起動される場合があります。


[ステップ 1. 仮想マシンと可用性セットを作成する]: #createset
[ステップ 2. 仮想マシンの作成プロセス中にそのマシンをクラウド サービスに追加し、可用性セットに割り当てる]: #addmachine
[ステップ 3. (省略可能) 前に作成された仮想マシンに対して可用性セットを作成する]: #previousmachine
[ステップ 4. (省略可能) 前に作成された仮想マシンを可用性セットに追加する]: #existingset


<!-- LINKS -->
[Load Balancing Virtual Machines (仮想マシンの負荷分散)]: ../load-balance-virtual-machines
[About Affinity Groups for Virtual Network」(仮想ネットワークのアフィニティ グループについて)]: http://msdn.microsoft.com/library/windowsazure/jj156085.aspx
[How to connect virtual machines in a cloud service (クラウド サービス内の仮想マシンを接続する方法)]: ../virtual-machines-connect-cloud-service

