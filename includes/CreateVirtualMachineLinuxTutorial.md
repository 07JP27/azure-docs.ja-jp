# Linux を実行する仮想マシンの作成

Azure の管理ポータルのイメージ ギャラリーを使用すると、Linux オペレーティング システムを実行する仮想マシンの作成は簡単です。このガイドは、Azure を初めて使用するユーザーを対象としています。Linux オペレーティング システムを実行する仮想マシンをクラウドに作成し、その仮想マシンにアクセスしてカスタマイズできます。

> [WACOM.NOTE] このチュートリアルは、Azure VM の使用経験がなくても完了できます。ただし、Azure アカウントが必要です。数分で無料の試用アカウントを作成することができます。詳細については、[Azure アカウントの作成に関するページ][]を参照してください。

学習内容:

-   [Azure での仮想マシンについて][]
-   [仮想マシンの作成方法][]
-   [仮想マシンを作成後、ログオンする方法][]
-   [新しい仮想マシンにデータ ディスクを接続する方法][]

**メモ**:このチュートリアルでは、仮想ネットワークに接続されていない仮想マシンを作成します。仮想マシンが仮想ネットワークを使用する場合、仮想マシンの作成時に仮想ネットワークを指定する必要があります。仮想ネットワークの詳細については、「[仮想ネットワークの概要][]」を参照してください。

## <span id="virtualmachine"></span> </a>Azure での仮想マシンについて

Azure の仮想マシンは、制御と管理が可能なクラウド上のサーバーです。Azure 上に仮想マシンを作成した後、仮想マシンは必要に応じていつでも削除と再作成が可能で、社内のサーバーとまったく同様にアクセスできます。仮想マシンの作成には、仮想ハード ディスク (VHD) ファイルが使用されます。仮想マシンには、次の種類の VHD が使用されます。

-   **イメージ** - 新しい仮想マシンを作成するテンプレートとして使用される VHD。イメージがテンプレートなのは、実行中の仮想マシンとは違って、コンピューター名やユーザー アカウント設定のような具体的な設定がなされていないためです。イメージを使って仮想マシンを作成した場合、新しい仮想マシン用のオペレーティング システム ディスクが自動的に作成されます。
-   **ディスク** - ディスクは、起動してオペレーティング システムの実行中バージョンとしてマウントできる VHD です。イメージは、プロビジョニングするとディスクになります。イメージを使って仮想マシンを作成すると、ディスクが常に作成されます。仮想ハードウェアに接続され、サービスの一部として実行されている VHD はディスクです。

イメージを使用して仮想マシンを作成するためには、次の選択肢があります。

-   Azure の管理ポータルのイメージ ギャラリーに用意されているイメージを使って仮想マシンを作成します。
-   イメージを格納した .vhd ファイルを作成し、それを Azure にアップロードして、そのイメージを使って仮想マシンを作成します。カスタム イメージの作成とアップロードの詳細については、「[Linux オペレーティング システムを格納した仮想ハード ディスクの作成とアップロード][]」を参照してください。

各仮想マシンは、その仮想マシンだけがクラウド サービス内に配置されているか、他の仮想マシンと共にグループ化されクラウド サービス内に配置されています。同じクラウド サービス内に複数の仮想マシンを配置すると、仮想マシン間の相互通信、仮想マシン間でのネットワーク トラフィックの負荷分散、仮想マシンの高可用性を有効にできます。クラウド サービスと仮想マシンの詳細については、[Azure 入門][]に関するページの「実行モデル」のセクションを参照してください。

## <span id="custommachine"></span> </a>仮想マシンの作成方法

**[ギャラリーから]** の方法を使って管理ポータルでカスタム仮想マシンを作成します。この方法には、仮想マシンを作成するときに必要に応じて仮想マシンのサイズ、接続リソース、DNS 名、ネットワーク接続を定義できる、より多くのオプションが用意されています。

1.  [Azure 管理ポータル][]にサインインします。
    コマンド バーで、**[新規]** をクリックします。

2.  **[仮想マシン]**、**[ギャラリーから]** の順にクリックします。

3.  **[イメージの選択]** から、一覧にあるいずれかのイメージを選択します (利用できるイメージは使用しているサブスクリプションによって異なる場合があります)。矢印をクリックして続行します。

4.  複数のバージョンのイメージが利用できる場合、**[バージョンのリリース日]** で、使用するバージョンを選択します。

5.  **[仮想マシン名]** に、使用する名前を入力します。この仮想マシンの場合は、「**MyTestVM1**」と入力します。

6.  **[サイズ]** で、仮想マシンに使用するサイズを選択します。選択するサイズは、アプリケーションが必要とするコア数に応じて変わります。この仮想マシンの場合は、利用可能な最小サイズを選択します。

7.  **[新しいユーザー名]** に、仮想マシンの管理に使用するアカウントの名前を入力します。ユーザー名に root を使用することはできません。この仮想マシンの場合は、「**NewUser1**」と入力します。

8.  [認証] で、**[パスワードの指定]** をオンにします。次に、必要な情報を入力し、矢印をクリックして続行します。

9.  クラウド サービスに複数の仮想マシンをまとめて配置することもできますが、このチュートリアルでは仮想マシンを 1 台だけ作成します。そのためには、**[新しいクラウド サービスの作成]** を選択します。

10. **[クラウド サービス DNS 名]** に DNS 名を入力します。DNS 名の長さは 3 ～ 24 文字で、小文字と数字を使用できます。この名前は、クラウド サービスを介して仮想マシンにアクセスするときに使用する URI の一部になります。この仮想マシンの場合は、「**MyService1**」と入力します。

11. **[リージョン]/[アフィニティ グループ]/[仮想ネットワーク]** で、仮想マシンを含める場所を選択します。

12. VHD ファイルが保存されているストレージ アカウントを選択できます。このチュートリアルでは、既定の **[自動的に生成されたストレージ アカウントを使用]** をそのまま使用します。

13. **[可用性セット]** では、このチュートリアルの目的に合わせて、既定の設定である **[なし]** を使用します。チェック マークをクリックして仮想マシンを作成し、矢印をクリックして続行します。

14. **[VM エージェント]** では、VM エージェントをインストールするかどうかを決定します。このエージェントには、仮想マシンの操作に役立つ拡張機能をインストールするための環境が用意されています。詳細については、「[拡張機能の管理][]」を参照してください。

15. **[エンドポイント]** で、仮想マシンへの Secure Shell (SSH) 接続を許可する目的で自動的に作成される新しいエンドポイントを確認します (エンドポイントを使用すると、インターネットや他の仮想ネットワークにあるリソースは仮想マシンと通信することができます)。ここでエンドポイントを追加したり、後でエンドポイントを作成することもできます。後でエンドポイントを作成する手順については、「[仮想マシンに対してエンドポイントを設定する方法][]」を参照してください。

仮想マシンとクラウド サービスが作成されると、管理ポータルでは、**[Virtual Machines]** の下に新しい仮想マシンが表示され、**[Cloud Services]** の下にクラウド サービスが表示されます。仮想マシンとクラウド サービスはどちらも自動的に開始されます。

## <span id="logon"></span> </a>仮想マシンを作成後、ログオンする方法

仮想マシンとそのマシン上で実行されるアプリケーションの設定を管理するには、SSH クライアントを使用できます。そのためには、仮想マシンへのアクセスに使用するコンピューターに SSH クライアントをインストールする必要があります。SSH クライアント プログラムの選択肢は多数あります。たとえば、次のプログラムを選択できます。

-   Windows オペレーティング システムが実行されているコンピューターを使用している場合は、PuTTY などの SSH クライアントを使用できます。詳細については、[PuTTY のダウンロード ページ][]を参照してください。
-   Linux オペレーティング システムが実行されているコンピューターを使用している場合は、OpenSSH などの SSH クライアントを使用できます。詳細については、「[OpenSSH (英語)][]」を参照してください。

このチュートリアルでは、PuTTY プログラムを使用して仮想マシンにアクセスする手順を示します。

1.  管理ポータルで**ホスト名**と**ポート情報**を検索します。仮想マシンのダッシュボードから必要な情報を見つけることができます。仮想マシン名をクリックし、ダッシュボードの **[概要]** セクションで **[SSH の詳細]** を探します。

    ![Find SSH details][]

2.  PuTTY プログラムを開きます。

3.  ダッシュボードから収集した**ホスト名**と**ポート情報**を入力し、**[開く]** をクリックします。

    ![Enter the host name and port information][]

4.  マシンの作成時に指定した NewUser1 アカウントを使用して仮想マシンにログオンします。

    ![Log on to the new virtual machine][]

    これで、仮想マシンを他のサーバーとまったく同様に扱うことができます。

## <span id="attachdisk"></span> </a>新しい仮想マシンにデータ ディスクを接続する方法

アプリケーションによってはデータの保存が必要になる場合があります。そのためには、前の手順で作成した仮想マシンにデータ ディスクを接続します。最も簡単な方法は、仮想マシンに空のデータ ディスクを接続することです。

**注: データ ディスクとリソース ディスク**
データ ディスクは Azure のストレージ内に存在し、ファイルとアプリケーション データの永続的なストレージとして使用できます。

作成した各仮想マシンには、一時的なローカル *リソース ディスク*も接続されています。リソース ディスク上のデータには、再起動を行った場合の持続性がないため、多くの場合は仮想マシン上で実行されているアプリケーションとプロセスが、このディスクを過渡的および一時的なストレージとして使用します。また、オペレーティング システムのページ ファイルやスワップ ファイルを格納する目的でも使用されます。

Linux では通常、リソース ディスクは Azure Linux エージェントによって管理され、**/mnt/resource** (または Ubuntu イメージでは **/mnt**) に自動的にマウントされます。リソース ディスクは*一時*ディスクであるため、仮想マシンのプロビジョニングが解除されると空になることに注意してください。一方、Linux では、データ ディスクはカーネルによって、`/dev/sdc` という名前が付けられる場合があります。その場合、ユーザーはこのリソースをパーティション分割し、フォーマットした上で、マウントする必要があります。詳細については、[Azure Linux エージェント ユーザー ガイド)][]を参照してください。

1.  まだサインインしていない場合は、Azure の管理ポータルにサインインします。

2.  **[仮想マシン]** をクリックし、前の手順で作成した **MyTestVM1** 仮想マシンを選択します。

3.  コマンド バーで、**[ディスクの接続]**、**[空のディスクの接続]** の順にクリックします。

    **[空のディスクの接続]** ダイアログ ボックスが表示されます。

    ![Define disk details][]

4.  **[仮想マシン名]**、**[ストレージの場所]**、**[ファイル名]** の値は既に定義されています。必要なのは、ディスクのサイズを入力することだけです。**[サイズ]** ボックスに「**5**」と入力します。

    **注:** ディスクはすべて、VHD ファイルから Azure ストレージに作成されます。ストレージに追加する VHD ファイルの名前は指定できますが、ディスクの名前は自動的に生成されます。

5.  チェック マークをクリックして、仮想マシンにデータ ディスクを接続します。

6.  ダッシュボードを表示すると、データ ディスクが仮想マシンに正しく接続されたかを確認できます仮想マシンの名前をクリックすると、ダッシュボードが表示されます。

    仮想マシンに接続されているディスクの数が現在 "2" であることがわかります。**[ディスク]** ボックスの一覧には、接続されているディスクが表示されています。

    ![Attach disk success][]

仮想マシンに接続したばかりのデータ ディスクはオフラインで、追加後も初期化されません。データ ディスクを使用してデータを保存するには、仮想マシンにログオンし、ディスクを初期化する必要があります。

1.  上にリストされた「**仮想マシンを作成後、ログオンする方法**」の手順を使用して仮想マシンに接続します。

2.  SSH のウィンドウで次のコマンドを入力し、アカウントのパスワードを入力します。

    `sudo grep SCSI /var/log/messages`

    表示されたメッセージで、最後に追加されたデータ ディスクの識別子を確認できます。

    ![Identify disk][]

3.  SSH のウィンドウで、次のコマンドを入力して新しいデバイスを作成し、アカウントのパスワードを入力します。

    `sudo fdisk /dev/sdc`

    > [WACOM.NOTE] この例で、ディストリビューションによっては `sudo -i` を使用しなければならない場合があります (sbin または /usr/sbin が `$PATH` にない場合)。

4.  「**n**」を入力すると、新しいパーティションが作成されます。

    ![Create new device][]

5.  パーティションをプライマリ パーティションにするには「**p**」を、最初のパーティションにするには「**1**」を、シリンダーの既定値をそのまま使用するには Enter キーを押します。

    ![Create partition][]

6.  「**p**」を入力すると、パーティション分割されたディスクに関する詳細情報が表示されます。

    ![ディスク情報の表示][]

7.  「**w**」と入力すると、ディスクの設定が書き込まれます。

    ![Write the disk changes][]

8.  新しいパーティションにファイル システムを作成する必要があります。たとえば、次のコマンドを入力してファイル システムを作成し、アカウントのパスワードを入力します。

    `sudo mkfs -t ext4 /dev/sdc1`

    ![Create file system][]

    > [WACOM.NOTE] SUSE Linux Enterprise 11 では、システムは ext4 ファイル システムに読み取り専用でアクセスすることに注意してください。これらのシステムには ext4 ではなく ext3 として新しいファイル システムの書式設定することをお勧めします。

9.  次に、新しいファイル システムをマウントするために利用可能なディレクトリが必要です。たとえば、次のコマンドを入力してドライブをマウントする新しいディレクトリを作成し、アカウントのパスワードを入力します。

    `sudo mkdir /datadrive`

10. 次のコマンドを入力してドライブをマウントします。

    `sudo mount /dev/sdc1 /datadrive`

    これで、データ ディスクを **/datadrive** として使用する準備ができました。

11. 新しいドライブを /etc/fstab に追加します。

    再起動後にドライブを自動的に再マウントするために、そのドライブを /etc/fstab ファイルに追加する必要があります。また、ドライブを参照する際に、デバイス名 (つまり /dev/sdc1) だけではなく、UUID (汎用一意識別子) を /etc/fstab で使用することもお勧めします。新しいドライブの UUID を確認するには、**blkid** ユーティリティを次のように使用します。

        `sudo -i blkid`

    次のような出力が表示されます。

        `/dev/sda1: UUID="11111111-1b1b-1c1c-1d1d-1e1e1e1e1e1e" TYPE="ext4"`
        `/dev/sdb1: UUID="22222222-2b2b-2c2c-2d2d-2e2e2e2e2e2e" TYPE="ext4"`
        `/dev/sdc1: UUID="33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e" TYPE="ext4"`

    > [WACOM.NOTE] blkid では、すべての場合に sudo アクセスが必要なわけではありませんが、ディストリビューションによっては `sudo -i` を使用した方が簡単に実行できる可能性があります (sbin または /usr/sbin が `$PATH` にない場合)。

    **注意事項:** /etc/fstab ファイルを不適切に編集すると、システムが起動できなくなる可能性があります。編集方法がはっきりわからない場合は、このファイルを適切に編集する方法について、ディストリビューションのドキュメントを参照してください。編集する前に、/etc/fstab ファイルのバックアップを作成することもお勧めします。

    テキスト エディターを使用して、/etc/fstab ファイルの最後の部分に新しいファイル システムに関する情報を入力します。この例では、前の手順で作成した新しい **/dev/sdc1** デバイスに対して UUID 値を使用し、マウント ポイントとして **/datadrive** を使用します。

        `UUID=33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /datadrive   ext4   defaults   1   2`

    または、SUSE Linux に基づいたシステムでは、わずかに異なる形式を使用する必要がある場合があります。

        `/dev/disk/by-uuid/33333333-3b3b-3c3c-3d3d-3e3e3e3e3e3e   /   ext3   defaults   1   2`

    追加のデータ ドライブやパーティションを作成する場合、それらも /etc/fstab に個別に入力する必要があります。

    これで、ファイル システムが正しくマウントされるかどうかをテストできます。そのためには、ファイル システムをマウント解除してから、再度マウントします。つまり、前の手順で作成したサンプルのマウント ポイント `/datadrive` を使用します。

        `sudo umount /datadrive`
        `sudo mount /datadrive`

    2 番目のコマンドでエラーが発生した場合、/etc/fstab ファイルの構文が正しいかどうかを確認してください。

    > [WACOM.NOTE] この後、fstab を編集せずにデータ ディスクを削除すると VM は起動できません。これが頻繁に発生する場合、大部分のディストリビューションでは `nofail` または `nobootwait` fstab オプションが提供されます。これによって、ディスクがなくてもシステムを起動することができます。これらのパラメーターの詳細については、使用しているディストリビューションのドキュメントを参照してください。

## 次のステップ

Azure 上の Linux の詳細については、次の記事を参照してください。

-   [Azure での Linux 入門][]

-   [Mac および Linux 用 Azure コマンド ライン ツールの使用方法][]

  [Azure アカウントの作成に関するページ]: http://www.windowsazure.com/en-us/develop/php/tutorials/create-a-windows-azure-account/
  [Azure での仮想マシンについて]: #virtualmachine
  [仮想マシンの作成方法]: #custommachine
  [仮想マシンを作成後、ログオンする方法]: #logon
  [新しい仮想マシンにデータ ディスクを接続する方法]: #attachdisk
  [仮想ネットワークの概要]: http://go.microsoft.com/fwlink/p/?LinkID=294063
  [Linux オペレーティング システムを格納した仮想ハード ディスクの作成とアップロード]: /en-us/manage/linux/common-tasks/upload-a-vhd/
  [Azure 入門]: http://go.microsoft.com/fwlink/p/?LinkId=311926
  [Azure 管理ポータル]: http://manage.windowsazure.com
  [拡張機能の管理]: http://go.microsoft.com/FWLink/p/?LinkID=390493
  [仮想マシンに対してエンドポイントを設定する方法]: http://azure.microsoft.com/en-us/documentation/articles/virtual-machines-set-up-endpoints/
  [PuTTY のダウンロード ページ]: http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html
  [OpenSSH (英語)]: http://www.openssh.org/
  [Find SSH details]: ./media/CreateVirtualMachineLinuxTutorial/SSHdetails.png
  [Enter the host name and port information]: ./media/CreateVirtualMachineLinuxTutorial/putty.png
  [Log on to the new virtual machine]: ./media/CreateVirtualMachineLinuxTutorial/sshlogin.png
  [Azure Linux エージェント ユーザー ガイド)]: http://www.windowsazure.com/en-us/manage/linux/how-to-guides/linux-agent-guide/
  [Define disk details]: ./media/CreateVirtualMachineLinuxTutorial/attachnewdisklinux.png
  [Attach disk success]: ./media/CreateVirtualMachineLinuxTutorial/attachemptysuccess.png
  [Identify disk]: ./media/CreateVirtualMachineLinuxTutorial/diskmessages.png
  [Create new device]: ./media/CreateVirtualMachineLinuxTutorial/diskpartition.png
  [Create partition]: ./media/CreateVirtualMachineLinuxTutorial/diskcylinder.png
  [ディスク情報の表示]: ./media/CreateVirtualMachineLinuxTutorial/diskinfo.png
  [Write the disk changes]: ./media/CreateVirtualMachineLinuxTutorial/diskwrite.png
  [Create file system]: ./media/CreateVirtualMachineLinuxTutorial/diskfilesystem.png
  [Azure での Linux 入門]: http://www.windowsazure.com/en-us/documentation/articles/introduction-linux/
  [Mac および Linux 用 Azure コマンド ライン ツールの使用方法]: http://www.windowsazure.com/en-us/documentation/articles/xplat-cli/
