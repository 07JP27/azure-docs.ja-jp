<properties writer="josephd" editor="tysonn" manager="dongill" />

#仮想マシンの負荷分散#

同じクラウド サービスまたは仮想ネットワーク内であれば、Azure で作成したすべての仮想マシンが、プライベート ネットワーク チャネルを使用して他の仮想マシンと自動的に通信できます。インターネット ホストや他のクラウド サービスまたは仮想ネットワークの仮想マシンからのトラフィックなど、他のすべての受信通信にはエンドポイントが必要です。

エンドポイントは、さまざまな目的で使用できます。Azure の管理ポータルを使用して作成した仮想マシンのエンドポイントは、既定で、リモート デスクトップ プロトコル (RDP) とリモート Windows PowerShell セッションのトラフィック用に使用および構成されます。これらのエンドポイントを使用して、インターネット上で仮想マシンをリモートで管理することができます。

エンドポイントのもう 1 つの使用方法は、Azure ロード バランサーを構成して、複数の仮想マシンまたはサービス間で特定の種類のトラフィックを分散することです。たとえば、複数の Web サーバーまたは Web ロール間で Web 要求のトラフィックの負荷を分散できます。

仮想マシンに定義された各エンドポイントには、パブリック ポートとプライベート ポート (TCP または UDP) が割り当てられています。インターネット ホストは、着信トラフィックをクラウド サービスまたはパブリック ポートのパブリック IP アドレスに送信します。クラウド サービス内の仮想マシンとサービスは、プライベート IP アドレスとプライベート ポートでリッスンします。ロード バランサーは、着信トラフィックのパブリック IP アドレスとポート番号を仮想マシンのプライベート IP アドレスとポート番号にマップし、仮想マシンからの応答トラフィックはその逆にマップします。

複数の仮想マシンまたはサービス間のトラフィックの負荷分散を構成すると、Azure は着信トラフィックをランダムに配分します。

クラウド サービスに Web ロールまたは Worker ロールのインスタンスが含まれる場合、サービス定義でパブリック エンドポイントを定義できます。クラウド サービスに仮想マシンが含まれる場合、仮想マシンを作成するときにエンドポイントを追加するか、またはエンドポイントを後で追加できます。

次の図は、標準の (暗号化されていない) Web トラフィック用の負荷分散されたエンドポイントを示しています。このエンドポイントは、パブリックとプライベートの TCP ポートが 80 である 3 台の仮想マシン間で共有されています。この 3 台の仮想マシンは、1 つの負荷分散セット内にあります。

![loadbalancing](./media/load-balancing-vms/LoadBalancing.png)

複数のインターネット クライアントがクラウド サービスのパブリック IP アドレスと TCP ポート 80 に Web ページ要求を送信すると、ロード バランサーはこの負荷分散セット内の 3 台の仮想マシン間でこれらの要求をランダムに負荷分散します。

Azure の仮想マシンの負荷分散セットを作成するには、次のステップを実行します。


- [ステップ 1: 最初の仮想マシンを作成する] []
- [ステップ 2: 同じクラウド サービスに配置される追加の仮想マシンを作成する] []
- [ステップ 3: 最初の仮想マシンを使用して負荷分散セットを作成する] []
- [ステップ 4: 負荷分散セットに仮想マシンを追加する] []

## <a id="firstmachine"> </a>ステップ 1: 最初の仮想マシンを作成する##

まだサインインしていない場合は、[Azure の管理ポータル](http://manage.windowsazure.com)にサインインします。最初の仮想マシンは、[ギャラリーから] または [簡易作成] の方法で作成できます。

- **[ギャラリーから]** - **[ギャラリーから]** の方法を使用すると、仮想マシンを作成するときにエンドポイントを作成できます。また、仮想マシンの作成時に作成されるクラウド サービスの名前を指定することもできます。手順については、「[Create a Virtual Machine Running Linux (Linux を実行する仮想マシンの作成)]」または「[Create a Virtual Machine Running Windows Server (Windows Server を実行する仮想マシンの作成)]」を参照してください。

- **[簡易作成]** - イメージ ギャラリーからイメージを選択し、基本情報を指定して、仮想マシンを作成します。この方法を使用するときは、仮想マシンを作成した後でエンドポイントを追加する必要があります。この方法では、既定の名前を使用してクラウド サービスも作成されます。詳細については、「[How to quickly create a virtual machine (仮想マシンをすばやく作成する方法)] []」を参照してください。

**注**: 簡易作成を使用して仮想マシンが作成されると、管理ポータルの [クラウド サービス] ページに新しいクラウド サービスの名前とサービスに関するその他の情報が表示されます。

## <a id="addmachines"> </a>ステップ 2: 同じクラウド サービスに配置される追加の仮想マシンを作成する##

[ギャラリーから] の方法を使用して、最初の仮想マシンと同じクラウド サービスに追加の仮想マシンを作成します。

## <a id="loadbalance"> </a>ステップ 3: 最初の仮想マシンを使用して負荷分散セットを作成する##

1. Azure の管理ポータルで、**[仮想マシン]** をクリックし、最初の仮想マシンの名前をクリックします。
	
2. **[エンドポイント]** をクリックし、**[追加]** をクリックします。

3. [仮想マシンにエンドポイントを追加します] ページで、右矢印をクリックします。
	
4. [エンドポイントの詳細を指定します] ページで、次のように指定します。

	- **[名前]** にエンドポイントの名前を入力するか、一般的なプロトコル用にあらかじめ定義されているエンドポイントの一覧から選択します。
	- **[プロトコル]** で、エンドポイントの種類に応じて必要となるプロトコル (TCP または UDP) を選択します (必要な場合)。
	- **[パブリック ポート]** と **[プライベート ポート]** に、仮想マシンが使用するポート番号を入力します (必要な場合)。仮想マシンのプライベート ポートとファイアウォール ルールを使って、アプリケーションに適した方法でトラフィックをリダイレクトすることができます。プライベート ポートはパブリック ポートと同じにできます。たとえば、Web (HTTP) トラフィック用のエンドポイントの場合、パブリック ポートとプライベート ポートの両方にポート 80 を割り当てることができます。

5. **[負荷分散セットの作成]** を選択し、右矢印をクリックします。

6. [負荷分散セットの構成] ページで、負荷分散セットの名前を入力し、Azure ロード バランサーのプローブ動作の値を割り当てます。ロード バランサーはプローブを使用して、負荷分散セット内の仮想マシンが着信トラフィックを受信できるかどうかを判断します。

7. チェック マークをクリックして、負荷分散されたエンドポイントを作成します。仮想マシンの **[エンドポイント]** ページの **[負荷分散セット名]** 列に **[はい]** が表示されます。


## <a id="addtoset"> </a>ステップ 4: 負荷分散セットに仮想マシンを追加する##
負荷分散セットを作成したら、そのセットに他の仮想マシンを追加します。同じクラウド サービス内の各仮想マシンで、次のステップを実行します。

1. 管理ポータルで、**[仮想マシン]**、仮想マシンの名前、**[エンドポイント]**、**[追加]** の順にクリックします。
	
2. [仮想マシンにエンドポイントを追加します] ページで、**[既存の負荷分散セットにエンドポイントを追加する]** をクリックし、負荷分散セットの名前を選択して、右矢印をクリックします。
	
3. [エンドポイントの詳細を指定します] ページで、エンドポイントの名前を入力し、チェック マークをクリックします。

[ステップ 1: 最初の仮想マシンを作成する]: #firstmachine
[ステップ 2: 同じクラウド サービスに配置される追加の仮想マシンを作成する]: #addmachines
[ステップ 3: 最初の仮想マシンを使用して負荷分散セットを作成する]: #loadbalance
[ステップ 4: 負荷分散セットに仮想マシンを追加する]: #addtoset


<!-- LINKS -->

[Create a Virtual Machine Running Linux (Linux を実行する仮想マシンの作成)]: ../virtual-machines-linux-tutorial

[Create a Virtual Machine Running Windows Server (Windows Server を実行する仮想マシンの作成)]: ../virtual-machines-windows-tutorial

[How to quickly create a virtual machine (仮想マシンをすばやく作成する方法)]: ../virtual-machines-quick-create

[クラウド サービス内の仮想マシンを接続する方法]: ../virtual-machines-connect-cloud-service

[Azure PowerShell]:http://msdn.microsoft.com/ja-jp/library/jj156055.aspx

[Azure の仮想ネットワークの概要]: http://go.microsoft.com/fwlink/p/?LinkID=294063

