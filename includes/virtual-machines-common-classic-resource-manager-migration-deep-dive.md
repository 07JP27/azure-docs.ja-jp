## <a name="meaning-of-migration-of-iaas-resources-from-classic-to-resource-manager"></a>クラシックから Resource Manager への IaaS リソース移行の意味
詳しく説明する前に、IaaS リソースでのデータ プレーンと管理プレーンの操作の違いについて簡単に説明したいと思います。

* "*管理/コントロール プレーン*" は、リソースを変更するための管理/コントロール プレーンまたは API を指します。 たとえば、VM の作成、VM の再起動、新しいサブネットでの仮想ネットワークの更新などの操作は、実行中のリソースを管理しますが、 インスタンスへの接続には直接影響しません。
* *データ プレーン* (アプリケーション) はアプリケーション自体のランタイムを指します。Azure API を経由しないインスタンスとの対話が含まれます。 Web サイトへのアクセスまたは実行中の SQL Server インスタンスや MongoDB サーバーからのデータのプルは、データ プレーンまたはアプリケーション対話と見なされます。 ストレージ アカウントから BLOB をコピーすることや、パブリック IP アドレスにアクセスして RDP または SSH で仮想マシンに接続することもデータ プレーンです。 これらの操作の場合、計算、ネットワーク、およびストレージでアプリケーションは実行されたままになります。

![管理/コントロール プレーンとデータ プレーンの違いを示すスクリーンショット](../articles/virtual-machines/media/virtual-machines-windows-migration-classic-resource-manager/data-control-plane.png)

> [!NOTE]
> 一部の移行シナリオでは、Azure Platform が仮想マシンを停止および割り当て解除してから再起動します。 これにより、短時間のデータ プレーン ダウンタイムが発生します。
>
>

## <a name="the-migration-experience"></a>移行エクスペリエンス
移行エクスペリエンスを開始する前に、以下をお勧めします。

* 移行するリソースで、サポートされていない機能や構成が使用されていないことを確認します。 通常プラットフォームでは、これらの問題が検出され、エラーが生成されます。
* 仮想ネットワークにない VM は、準備操作の一環として停止され、割り当てが解除されます。 パブリック IP アドレスが失われないようにする場合は、準備操作をトリガーする前に IP アドレスの予約を検討してください。 ただし、仮想ネットワーク内にある VM は停止されず、割り当ては解除されません。
* 移行中に発生する可能性のある予期しないエラーに備え、営業時間外での移行を計画します。
* 準備手順の完了後に検証しやすいように、PowerShell、コマンド ライン インターフェイス (CLI) コマンド、または REST API を使用して、VM の現在の構成をダウンロードします。
* 移行を開始する前に、Resource Manager デプロイメント モデルを処理する自動/運用スクリプトを更新します。 必要に応じて、リソースの準備ができた状態で GET 操作を実行できます。
* クラシック IaaS リソースで構成されている RBAC ポリシーを評価し、移行が完了したら計画します。

移行のワークフローを次に示します

![移行のワークフローを示すスクリーンショット](../articles/virtual-machines/windows/media/migration-classic-resource-manager/migration-workflow.png)

> [!NOTE]
> 次のセクションのすべての操作がべき等です。 サポートされていない機能や構成エラー以外の問題が発生した場合は、準備、中止、またはコミット操作を再試行することをお勧めします。 Azure Platform では、操作が再試行されます。
>
>

### <a name="validate"></a>検証
検証操作は、移行プロセスの最初の手順です。 この手順の目標は、移行対象のリソースのデータをバックグラウンドで分析し、リソースを移行できるかどうかを示すコード (成功/失敗) を返すことです。

移行を検証する仮想ネットワークまたはホストされるサービス (仮想ネットワークでない場合) を選択します。

* リソースを移行できない場合は、移行がサポートされていない理由がすべて Azure Platform でリストされます。

ストレージ サービスを検証するときは、ストレージ アカウントの名前に "-Migrated" が付加された名前のリソース グループで、移行されたアカウントを探します。  たとえば、ストレージ アカウントの名前が "mystorage" である場合は、"mystorage-Migrated" という名前のリソース グループで Azure Resource Manager が有効なリソースを探します。それには、"mystorage" という名前のストレージ アカウントが含まれています。

### <a name="prepare"></a>準備
準備操作は、移行プロセスの 2 番目の手順です。 この手順の目的は、クラシックから Resource Manager リソースへの IaaS リソースの変換をシミュレートし、これを並行して示し、視覚化することです。

移行を準備する仮想ネットワークまたはホストされるサービス (仮想ネットワークでない場合) を選択します。

* リソースを移行できない場合は、移行プロセスが停止され、準備操作が失敗した理由がリストされます。
* リソースを移行できる場合は、最初に、移行対象のリソースに対する管理プレーン操作がロックされます。 たとえば、移行中、VM にデータ ディスクを追加することはできません。

次に、リソースを移行するために、クラシックから Resource Manager へのメタデータの移行が Azure Platform で開始されます。

準備操作が完了すると、クラシックと Resource Manager の両方でリソースを視覚化するためのオプションが表示されます。 クラシック デプロイメント モデルのすべてのクラウド サービスに対して、 `cloud-service-name>-Migrated`というパターンのリソース グループ名が Azure Platform で作成されます。

> [!NOTE]
> 移行されるリソースのために作成されたリソース グループの名前 ("-Migrated" など) を選択することはできません。ただし、移行の完了後には、Azure Resource Manager の移動機能を使用して、リソースを任意のリソース グループに移動できます。 詳しくは、「[新しいリソース グループまたはサブスクリプションへのリソースの移動](../articles/resource-group-move-resources.md)」を参照してください。

準備操作が正常に終了した結果が表示されている 2 つの画面を次に示します。 最初の画面には、元のクラウド サービスを含むリソース グループが表示されます。 2 番目の画面には、移行された新しいリソース グループが表示されます。含まれている Azure Resource Manager リソースは同じです。

![ポータル クラシック クラウド サービスを示す画面](../articles/virtual-machines/windows/media/migration-classic-resource-manager/portal-classic.png)

![準備中のポータル Azure Resource Manager リソースを示すスクリーンショット](../articles/virtual-machines/windows/media/migration-classic-resource-manager/portal-arm.png)

> [!NOTE]
> 従来の仮想ネットワークにない仮想マシンは、この移行フェーズで "停止済みかつ割り当て解除済み" になります。
>
>

### <a name="check-manual-or-scripted"></a>チェック (手動またはスクリプト)
このチェック手順では、必要に応じて、移行が正しく行われていることを検証するために、前の手順でダウンロードした構成を使用できます。 また、ポータルにサインインし、プロパティとリソースをスポット チェックして、メタデータが正しく移行されていることを検証することもできます。

仮想ネットワークを移行する場合、仮想マシンの構成のほとんどが再開されません。 これらの VM のアプリケーションの場合、アプリケーションがまだ稼働していることを検証できます。

監視/オートメーションおよび操作スクリプトをテストすることで、VM が期待どおりに機能しているか、および更新したスクリプトが正しく機能するかを確認できます。 リソースが準備されている状態の場合は、GET 操作のみがサポートされます。

移行をコミットしなければならない期間は設定されません。 この状態で必要なだけ時間をかけることができます。 ただし、中止またはコミットするまで、これらのリソースに対して管理プレーンがロックされることに注意してください。

問題がある場合は、いつでも移行を中止し、クラシック デプロイメント モデルに戻ることができます。 戻ると、Azure Platform でリソースに対する管理プレーン操作が開始されるため、クラシック デプロイメント モデルでその VM に対する通常の操作を再開することができます。

### <a name="abort"></a>中止
中止は省略可能な手順です。この手順により、クラシック デプロイメント モデルへの変更を元に戻し、移行を中止できます。

> [!NOTE]
> コミット操作をトリガーしたら、この操作は実行できません。     
>
>

### <a name="commit"></a>コミット
検証が完了したら、移行をコミットできます。 リソースは Resource Manager デプロイメント モデルでのみ使用できるようになります。クラシックには表示されません。 つまり、移行されたリソースは新しいポータルでのみ管理できます。

> [!NOTE]
> これはべき等操作です。 失敗した場合は、操作を再試行することをお勧めします。 失敗が続く場合は、サポート チケットを作成するか、 [VM フォーラム](https://social.msdn.microsoft.com/Forums/azure/home?forum=WAVirtualMachinesforWindows)でフォーラム投稿を作成し、ClassicIaaSMigration タグを付けてください。
>
>
<br>
移行プロセスの手順のフローチャートを次に示します。

![移行手順を示すスクリーンショット](../articles/virtual-machines/windows/media/migration-classic-resource-manager/migration-flow.png)

## <a name="translation-of-classic-to-azure-resource-manager-resources"></a>クラシック リソースから Azure Resource Manager リソースへの変換
次の表では、リソースはクラシックと Resource Manager で呼称が異なる場合があります。 その他の機能とリソースは現在サポートされていません。

| クラシック表示 | Resource Manager の表示 | 注記 |
| --- | --- | --- |
| クラウド サービス名 |DNS name |移行中、 `<cloudservicename>-migrated`の命名パターンで、すべてのクラウド サービスに新しいリソース グループが作成されます。 このリソース グループには、すべてのリソースが含まれています。 クラウド サービス名は、パブリック IP アドレスが関連付けられた DNS 名になります。 |
| 仮想マシン |仮想マシン |VM 固有のプロパティはそのまま移行されます。 コンピューター名など、一部の osProfile 情報はクラシック デプロイメント モデルに保存されておらず、移行後も空のままです。 |
| VM に接続されているディスク リソース |VM に接続されている暗黙的なディスク |ディスクは、Resource Manager デプロイメント モデルの最上位リソースとしてモデル化されません。 VM の下で暗黙的なディスクとして移行されます。 VM に接続されているディスクのみがサポートされています。 Resource Manager VM では従来のストレージ アカウントを使用できるため、更新がなくてもディスクを簡単に移行できます。 |
| VM 拡張機能 |VM 拡張機能 |XML 拡張機能を除くすべてのリソース拡張機能が、クラシック デプロイメント モデルから移行されます。 |
| 仮想マシン証明書 |Azure Key Vault の証明書 |クラウド サービスにサービス証明書が含まれている場合は、クラウド サービスごとに新しい Azure Key Vault が作成され、証明書はそこに移動されます。 VM は、Key Vault の証明書を参照するように更新されます。 <br><br> **メモ:** Key Vault を削除すると、VM で障害が発生する可能性があります。そのため、Key Vault を削除しないでください。 Microsoft では、Key Vault を安全に削除したり、VM と共に新しいサブスクリプションに移動したりできるように、バックエンドでの処理の改善に取り組んでいます。 |
| WinRM 構成 |osProfile の WinRM 構成 |Windows リモート管理の構成は、移行の一環として、そのまま移動されます。 |
| 可用性セットのプロパティ |可用性セットのリソース | クラシック デプロイメント モデルでは、可用性セット仕様は VM のプロパティでした。 可用性セットは、移行の一環として、上位のリソースになります。 1 つのクラウド サービスに対して複数の可用性セット、または 1 つ以上の可用性セットとクラウド サービスの可用性セットにない VM という構成はサポートされていません。 |
| VM のネットワーク構成 |プライマリ ネットワーク インターフェイス |移行後、VM のネットワーク構成がプライマリ ネットワーク インターフェイス リソースとして表示されます。 仮想ネットワークにない VM の場合は、内部 IP アドレスが移行中に変わります。 |
| VM の複数のネットワーク インターフェイス |ネットワーク インターフェイス |VM に複数のネットワーク インターフェイスが関連付けられている場合は、Resource Manager デプロイメント モデルの移行の一環として、各ネットワーク インターフェイスが、すべてのプロパティとともに上位のリソースになります。 |
| 負荷分散エンドポイント セット |Load Balancer |クラシック デプロイメント モデルでは、クラウド サービスごとに暗黙的なロード バランサーが割り当てられました。 移行中に、新しいロード バランサー リソースが作成され、そのロード バランサー エンドポイント セットはロード バランサー ルールになります。 |
| 受信 NAT のルール |受信 NAT のルール |VM に定義されている入力エンドポイントは、移行中、ロード バランサーで受信ネットワーク アクセス変換ルールに変換されます。 |
| VIP アドレス |DNS 名のあるパブリック IP アドレス |仮想 IP アドレスがパブリック IP アドレスになり、ロード バランサーに関連付けられます。 |
| Virtual Network |Virtual Network |仮想ネットワークとそのすべてのプロパティが Resource Manager デプロイメント モデルに移行されます。 `-migrated`という名前で新しいリソース グループが作成されます。 |
| 予約済み IP |静的割り当て方法のあるパブリック IP アドレス |ロード バランサーに関連付けられている予約済み IP が、クラウド サービスまたは仮想マシンの移行に伴って移行されます。 現時点では、関連付けられていない予約済み IP 移行はサポートされていません。 |
| VM ごとのパブリック IP アドレス |動的割り当て方法のあるパブリック IP アドレス |VM に関連付けられているパブリック IP アドレスは、割り当て方法が静的に設定されているパブリック IP アドレス リソースとして変換されます。 |
| NSG |NSG |サブネットに関連付けられているネットワーク セキュリティ グループは、Resource Manager デプロイメント モデルへの移行の一環として複製されます。 移行中、クラシック デプロイメント モデルの NSG は削除されません。 ただし、NSG の管理プレーン操作は、移行中はブロックされます。 |
| DNS サーバー |DNS サーバー |仮想ネットワークまたは VM に関連付けられている DNS サーバーは、該当するリソース移行の一環として、すべてのプロパティと共に移行されます。 |
| UDR |UDR |サブネットに関連付けられているユーザー定義のルートは、Resource Manager デプロイメント モデルへの移行の一環として複製されます。 移行中、クラシック デプロイメント モデルの UDR は削除されません。 UDR の管理プレーン操作は、移行中はブロックされます。 |
| VM のネットワーク構成の IP 転送プロパティ |NIC の IP 転送プロパティ |VM上 の IP 転送プロパティは、移行中、ネットワーク インターフェイスでプロパティに変換されます。 |
| 複数の IP のあるロード バランサー |複数のパブリック IP リソースのあるロード バランサー |移行後、ロード バランサーが関連付けられているすべてのパブリック IP がパブリック IP リソースに変換され、ロード バランサーに関連付けられます。 |
| VM の内部 DNS 名 |NIC の内部 DNS 名 |移行中、VM の内部 DNS サフィックスは、NIC の "InternalDomainNameSuffix" という名前の読み取り専用プロパティに移行されます。 サフィックス名は移行後もそのままで、VM 解決は前と同じように動作し続けます。 |
| Virtual Network ゲートウェイ |Virtual Network ゲートウェイ |Virtual Network ゲートウェイのプロパティはそのまま移行されます。 ゲートウェイに関連付けられている VIP も変更されません。 |
| ローカル ネットワーク サイト |ローカル ネットワーク ゲートウェイ |ローカル ネットワーク サイトのプロパティは、ローカル ネットワーク ゲートウェイと呼ばれる新しいリソースにそのまま移行されます。 これは、オンプレミス アドレス プレフィックスおよびリモート ゲートウェイ IP を表します。 |
| 接続の参照 |接続 |移行後の Resource Manager では、ネットワーク構成におけるゲートウェイとローカル ネットワーク サイト間の接続の参照は、"接続" と呼ばれる新しく作成されたリソースによって表されます。 ネットワーク構成ファイル内の接続の参照のすべてのプロパティは、新しく作成された "接続" リソースにそのままコピーされます。 クラシックにおける VNet 間の接続は、VNet を表すローカル ネットワーク サイトへの 2 つの IPsec トンネルを作成することで実現されます。 Resource Manager モデルでは、これが Vnet2Vnet 接続に変更され、ローカル ネットワーク ゲートウェイは不要になります。 |

## <a name="changes-to-your-automation-and-tooling-after-migration"></a>移行後のオートメーションおよびツールの変更
クラシック デプロイメント モデルから Resource Manager デプロイメント モデルへのリソース移行の一環として、既存のオートメーションまたはツールを、リソース移行後も確実に機能し続けるように更新する必要があります。
